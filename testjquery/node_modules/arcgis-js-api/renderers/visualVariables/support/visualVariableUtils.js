/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../Graphic","../../../core/compilerUtils","../../../core/Logger","../../support/lengthUtils","./sizeVariableUtils"],(function(e,a,i,n,r,t,s){"use strict";const l=r.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),o=new i,c=Math.PI,u=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function f(e,i,n){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"color"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.ColorVariable"!==r.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const t="number"==typeof i,s=t?null:i,o=s?.attributes;let c=t?i:null;const u=r.field,{ipData:f,hasExpression:p}=r.cache;let d=r.cache.compiledFunc;if(!u&&!p){const e=r.stops;return e&&e[0]&&e[0].color}if("number"!=typeof c)if(p){if(null==n?.arcade)return void l.error("Use of arcade expressions requires an arcade context");const e={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},a=n.arcade.arcadeUtils,i=a.getViewInfo(e),t=a.createExecContext(s,i,n.timeZone);if(!d){const e=a.createSyntaxTree(r.valueExpression);d=a.createFunction(e),r.cache.compiledFunc=d}c=a.executeFunction(d,t)}else o&&(c=o[u]);const b=r.normalizationField,v=null!=o&&null!=b?parseFloat(o[b]):void 0;if(null!=c&&(!b||t||!isNaN(v)&&0!==v)){isNaN(v)||t||(c/=v);const e=R(c,f);if(e){const i=e[0],t=e[1],s=i===t?r.stops[i].color:a.blendColors(r.stops[i].color,r.stops[t].color,e[2],null!=n?n.color:void 0);return new a(s)}}}function p(e,a,i){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!n)return;if("esri.renderers.visualVariables.OpacityVariable"!==n.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const r="number"==typeof a,t=r?null:a,s=t?.attributes;let o=r?a:null;const c=n.field,{ipData:u,hasExpression:f}=n.cache;let p=n.cache.compiledFunc;if(!c&&!f){const e=n.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof o)if(f){if(null==i?.arcade)return void l.error("Use of arcade expressions requires an arcade context");const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},a=i.arcade.arcadeUtils,r=a.getViewInfo(e),s=a.createExecContext(t,r,i.timeZone);if(!p){const e=a.createSyntaxTree(n.valueExpression);p=a.createFunction(e),n.cache.compiledFunc=p}o=a.executeFunction(p,s)}else s&&(o=s[c]);const d=n.normalizationField,b=null!=s&&null!=d?parseFloat(s[d]):void 0;if(null!=o&&(!d||r||!isNaN(b)&&0!==b)){isNaN(b)||r||(o/=b);const e=R(o,u);if(e){const a=e[0],i=e[1];if(a===i)return n.stops[a].opacity;{const r=n.stops[a].opacity;return r+(n.stops[i].opacity-r)*e[2]}}}}function d(e,a,i){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!n)return;if("esri.renderers.visualVariables.RotationVariable"!==n.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const r=n.axis||"heading",t="heading"===r&&"arithmetic"===n.rotationType?90:0,s="heading"===r&&"arithmetic"===n.rotationType?-1:1,o="number"==typeof a?null:a,c=o?.attributes,u=n.field,{hasExpression:f}=n.cache;let p=n.cache.compiledFunc,d=0;if(!u&&!f)return d;if(f){if(null==i?.arcade)return void l.error("Use of arcade expressions requires an arcade context");const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},a=i.arcade.arcadeUtils,r=a.getViewInfo(e),t=a.createExecContext(o,r,i.timeZone);if(!p){const e=a.createSyntaxTree(n.valueExpression);p=a.createFunction(e),n.cache.compiledFunc=p}d=a.executeFunction(p,t)}else c&&(d=c[u]||0);return d="number"!=typeof d||isNaN(d)?null:t+s*d,d}function b(e,a,i){const n="number"==typeof a,r=n?null:a,t=r?.attributes;let o=n?a:null;const{isScaleDriven:c}=e.cache;let u=e.cache.compiledFunc;if(c){const a=null!=i?i.scale:void 0,n=null!=i?i.view:void 0;o=null==a||"3d"===n?v(e):a}else if(!n)switch(e.inputValueType){case s.InputValueType.Expression:{if(null==i?.arcade)return void l.error("Use of arcade expressions requires an arcade context");const a={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},n=i.arcade.arcadeUtils,t=n.getViewInfo(a),s=n.createExecContext(r,t,i.timeZone);if(!u){const a=n.createSyntaxTree(e.valueExpression);u=n.createFunction(a),e.cache.compiledFunc=u}o=n.executeFunction(u,s);break}case s.InputValueType.Field:t&&(o=t[e.field]);break;case s.InputValueType.Unknown:o=null}if(!s.isValidNumber(o))return null;if(n||!e.normalizationField)return o;const f=t?parseFloat(t[e.normalizationField]):null;return s.isValidNumber(f)&&0!==f?o/f:null}function v(e){let a=null,i=null;const n=e.stops;return n?(a=n[0].value,i=n[n.length-1].value):(a=e.minDataValue||0,i=e.maxDataValue||0),(a+i)/2}function m(e,a,i){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!n)return;if("esri.renderers.visualVariables.SizeVariable"!==n.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const r=F(b(n,a,i),n,a,i,n.cache.ipData);return null==r||isNaN(r)?0:r}function h(e,a,i){return null==e?null:s.isSizeVariable(e)?m(e,a,i):s.isValidNumber(e)?e:null}function V(e,a,i){return s.isValidNumber(i)&&e>i?i:s.isValidNumber(a)&&e<a?a:e}function y(e,a,i,n){return e+((h(a.minSize,i,n)||a.minDataValue)??0)}function x(e,a,i){const n=e.stops;let r=n?.length&&n[0].size;return null==r&&(r=e.minSize),h(r,a,i)}function g(e,a,i,n){const r=(e-a.minDataValue)/(a.maxDataValue-a.minDataValue),t=h(a.minSize,i,n),s=h(a.maxSize,i,n),l=null!=n?n.shape:void 0;if(e<=a.minDataValue)return t;if(e>=a.maxDataValue)return s;if(null==t||null==s)return null;if("area"===a.scaleBy&&l){const e="circle"===l,a=e?c*(t/2)**2:t*t,i=a+r*((e?c*(s/2)**2:s*s)-a);return e?2*Math.sqrt(i/c):Math.sqrt(i)}return t+r*(s-t)}function S(e,a,i,n){const r=null!=n?n.shape:void 0,t=e/a.minDataValue,s=h(a.minSize,i,n),l=h(a.maxSize,i,n);let o=null;return o="circle"===r?2*Math.sqrt(t*(s/2)**2):"square"===r||"diamond"===r||"image"===r?Math.sqrt(t*s**2):t*s,V(o,s,l)}function z(e,a,i,n,r){const[t,s,l]=R(e,r);if(t===s)return h(a.stops?.[t].size,i,n);{const e=h(a.stops?.[t].size,i,n);return e+(h(a.stops?.[s].size,i,n)-e)*l}}function T(e,a,i,n){const r=(n?.resolution??1)*t.meterIn[a.valueUnit],s=h(a.minSize,i,n),l=h(a.maxSize,i,n),{valueRepresentation:o}=a;let u=null;return u="area"===o?2*Math.sqrt(e/c)/r:"radius"===o||"distance"===o?2*e/r:e/r,V(u,s,l)}function w(e){return e}function F(e,a,i,n,r){switch(a.transformationType){case s.TransformationType.Additive:return y(e,a,i,n);case s.TransformationType.Constant:return x(a,i,n);case s.TransformationType.ClampedLinear:return g(e,a,i,n);case s.TransformationType.Proportional:return S(e,a,i,n);case s.TransformationType.Stops:return z(e,a,i,n,r);case s.TransformationType.RealWorldSize:return T(e,a,i,n);case s.TransformationType.Identity:return w(e);case s.TransformationType.Unknown:return null}}function N(e,a,i){const{isScaleDriven:n}=e.cache;if(!(n&&"3d"===i||a))return null;const r={scale:a,view:i};let t=h(e.minSize,o,r),s=h(e.maxSize,o,r);if(null!=t||null!=s){if(t>s){const e=s;s=t,t=e}return{minSize:t,maxSize:s}}}function E(e,a,i){if(!e.visualVariables)return;const n=[],r=[],t=[],s=[],l=[];for(const o of e.visualVariables)switch(o.type){case"color":r.push(o);break;case"opacity":t.push(o);break;case"rotation":l.push(o);break;case"size":s.push(o)}return r.forEach((e=>{const r=f(e,a,i);n.push({variable:e,value:r})})),t.forEach((e=>{const r=p(e,a,i);n.push({variable:e,value:r})})),l.forEach((e=>{const r=d(e,a,i);n.push({variable:e,value:r})})),s.forEach((e=>{const r=m(e,a,i);n.push({variable:e,value:r})})),n.filter((e=>null!=e.value))}function R(e,a){if(!a)return;let i=0,n=a.length-1;return a.some(((a,r)=>e<a?(n=r,!0):(i=r,!1))),[i,n,(e-a[i])/(a[n]-a[i])]}function C(e,a,i){const r=["proportional","proportional","proportional"];for(const t of e){const e=t.useSymbolValue?"symbol-value":m(t,a,i);switch(t.axis){case"width":r[0]=e;break;case"depth":r[1]=e;break;case"height":r[2]=e;break;case"width-and-depth":r[0]=e,r[1]=e;break;case"all":case void 0:case null:r[0]=e,r[1]=e,r[2]=e;break;default:n.neverReached(t.axis)}}return r}e.getAllSizes=C,e.getColor=f,e.getOpacity=p,e.getRotationAngle=d,e.getSize=m,e.getSizeForValue=F,e.getSizeFromNumberOrVariable=h,e.getSizeRangeAtScale=N,e.getVisualVariableValues=E,e.viewScaleRE=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
