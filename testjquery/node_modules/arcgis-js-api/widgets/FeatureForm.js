/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../intl","../core/arrayUtils","../core/deprecate","../core/Logger","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/has","../core/accessorSupport/decorators/subclass","../layers/support/fieldUtils","./Widget","./FeatureForm/css","./FeatureForm/featureFormUtils","./FeatureForm/FeatureFormViewModel","./support/componentsUtils","./support/dataUtils","./support/dateUtils","./support/globalCss","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","../intl/substitute"],(function(e,t,i,n,a,s,o,r,l,d,u,p,c,m,h,_,v,g,b,C,y,f,F,w,R,x){"use strict";const I="data-field-name",k="esri.widgets.FeatureForm",O=s.getLogger(k);let D=class extends c{constructor(e,t){super(e,t),this._attemptFocusOnNextRender=!1,this._dateComponentMap=new Map,this._inputsWithChanges=new Set,this._focusedFieldName=null,this._listObserverNode=null,this._listObserver=new IntersectionObserver((e=>{e.length&&e[0].isIntersecting&&this._incrementRelatedRecordPage()}),{root:window.document}),this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesFeature=null,this.messagesTemplates=null,this.viewModel=new _,this._onShowAllRelatedRecordsClick=e=>{const{feature:t,relatedRecordCallbacks:i}=this;t&&i?.showAllRelatedRecords&&i.showAllRelatedRecords({parentFeature:t,relationshipId:e})},this._onAddRelatedRecordsClick=(e,t)=>{const{feature:i,relatedRecordCallbacks:n}=this;i&&n?.addRelatedRecord&&n.addRelatedRecord({parentFeature:i,relatedLayer:t,relationshipId:e})},this._onFormKeyDown=this._onFormKeyDown.bind(this),this._onFormSubmit=this._onFormSubmit.bind(this),this._onGroupToggle=this._onGroupToggle.bind(this),this._onComponentBlur=this._onComponentBlur.bind(this),this._onComponentFocus=this._onComponentFocus.bind(this),this._onComponentKeyDown=this._onComponentKeyDown.bind(this),this._afterComponentCreate=this._afterComponentCreate.bind(this),this._afterComponentCreateOrUpdate=this._afterComponentCreateOrUpdate.bind(this),this._afterDateComponentCreate=this._afterDateComponentCreate.bind(this),this._afterDateComponentCreateOrUpdate=this._afterDateComponentCreateOrUpdate.bind(this),this._afterRadioGroupCreateOrUpdate=this._afterRadioGroupCreateOrUpdate.bind(this)}initialize(){this.addHandles([o.watch((()=>this.feature),(()=>{o.whenOnce((()=>!this.viewModel.updating)).then((()=>{const e=this._getFocusableInput("forward");this._inputsWithChanges.clear(),this._dateComponentMap.clear(),this._syncGroupInputStates(),this._focusedFieldName=e?.name||null,this._attemptFocusOnNextRender=!0}))})),o.watch((()=>this.groupDisplay),(()=>this._syncGroupInputStates())),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._inputsWithChanges.add(e))),this._focusedFieldName=t,this._attemptFocusOnNextRender=!0,this.scheduleRender()}})),o.watch((()=>[this.viewModel.activeRelationshipInput,this._listObserverNode]),(()=>this._onObserverChange()))])}loadDependencies(){return v.loadCalciteComponents({block:()=>new Promise(((t,i)=>e(["../chunks/calcite-block"],t,i))),button:()=>new Promise(((t,i)=>e(["../chunks/calcite-button"],t,i))),combobox:()=>new Promise(((t,i)=>e(["../chunks/calcite-combobox"],t,i))),"combobox-item":()=>new Promise(((t,i)=>e(["../chunks/calcite-combobox-item"],t,i))),"combobox-item-group":()=>new Promise(((t,i)=>e(["../chunks/calcite-combobox-item-group"],t,i))),icon:()=>new Promise(((t,i)=>e(["../chunks/calcite-icon"],t,i))),input:()=>new Promise(((t,i)=>e(["../chunks/calcite-input"],t,i))),"input-date-picker":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-date-picker"],t,i))),"input-message":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-message"],t,i))),"input-number":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-number"],t,i))),"input-time-picker":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-time-picker"],t,i))),"input-time-zone":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-time-zone"],t,i))),label:()=>new Promise(((t,i)=>e(["../chunks/calcite-label"],t,i))),list:()=>new Promise(((t,i)=>e(["../chunks/calcite-list"],t,i))),"list-item":()=>new Promise(((t,i)=>e(["../chunks/calcite-list-item"],t,i))),loader:()=>new Promise(((t,i)=>e(["../chunks/calcite-loader"],t,i))),notice:()=>new Promise(((t,i)=>e(["../chunks/calcite-notice"],t,i))),"radio-button":()=>new Promise(((t,i)=>e(["../chunks/calcite-radio-button"],t,i))),"radio-button-group":()=>new Promise(((t,i)=>e(["../chunks/calcite-radio-button-group"],t,i))),switch:()=>new Promise(((t,i)=>e(["../chunks/calcite-switch"],t,i))),"text-area":()=>new Promise(((t,i)=>e(["../chunks/calcite-text-area"],t,i)))})}destroy(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)}get _relatedRecordsEnabled(){const e=this.relatedRecordCallbacks;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get relatedRecordCallbacks(){return this.viewModel.relatedRecordCallbacks}set relatedRecordCallbacks(e){this.viewModel.relatedRecordCallbacks=e}get relationshipId(){return this.viewModel.relationshipId}set relationshipId(e){this.viewModel.relationshipId=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get view(){return a.deprecatedProperty(O,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view}set view(e){a.deprecatedProperty(O,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view=e}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return R.tsx("div",{class:this.classes(m.css.base,C.globalCss.widget,C.globalCss.panel)},"ready"===e?this._renderForm():null)}_renderForm(){return R.tsx("form",{class:m.css.form,novalidate:!0,onkeydown:this._onFormKeyDown,onsubmit:this._onFormSubmit},this._renderHeader(),this._renderContent())}_renderHeader(){const e=this.viewModel;if(!e.formHeaderVisible)return;const t=null!=e.formTitle&&R.tsx(y.Heading,{key:"title",level:this.headingLevel},e.formTitle),i=null!=e.formDescription&&R.tsx("p",{class:m.css.description,key:"description"},e.formDescription);return R.tsx("div",{class:m.css.formHeader},t,i)}_renderContent(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderActiveRelationshipInput(e.activeRelationshipInput):e.inputs.filter(n.isSome).filter((e=>e.visible)).map(((e,t)=>h.isGroupInput(e)?this._renderGroup(e,t):h.isFieldInput(e)?this._renderLabeledField(e):h.isRelationshipInput(e)?this._renderRelationshipInput(e):void 0))}_renderActiveRelationshipInput(e){return this._renderRelationshipInput(e)}_renderDescriptionOrEmpty(e,t){return null==e?null:R.tsx("div",{class:this.classes(m.css.description),id:t},e)}_renderGroup(e,t){const{disabled:i,formTemplate:n,headingLevel:a}=this,{description:s,inputs:o,label:r,open:l}=e,d=o.filter((e=>e.visible)),u=this.viewModel.findField(this._focusedFieldName),p=u?.group===e,c=`${this.id}_group_${t}`,_="sequential"===this.groupDisplay;return R.tsx("calcite-block",{class:this.classes(m.css.group,_?m.css.groupSequential:null,p?m.css.groupActive:null,i?m.css.inputDisabled:null),collapsible:!0,"data-group":e,description:s||void 0,disabled:i,heading:`${r}`,headingLevel:n?.title?y.incrementHeadingLevel(a):a,id:c,key:c,open:l,onCalciteBlockToggle:({target:t})=>this._onGroupToggle(t,e)},d.map((e=>h.isFieldInput(e)?this._renderLabeledField(e):h.isRelationshipInput(e)?this._renderRelationshipInput(e):void 0)))}_getFocusableInput(e,t){const i=this.viewModel.allFieldInputs,n="forward"===e?i:i.slice().reverse();let a;if(!t||h.isRelationshipInput(t))a=0;else if(h.isGroupInput(t)){const e=t.inputs.find(h.isFieldInput);a=e?n.indexOf(e):0}else{let i;if(h.isInputInGroupInput(t)&&!t.group.open){const n=t.group.inputs.filter(h.isFieldInput);i="forward"===e?n[n.length-1]:n[0]}else i=t;a=n.indexOf(i)+1}for(let s=a;s<n.length;s++){const e=n[s];if(e.visible&&h.isFieldInput(e))return e}return null}_renderLabeledField(e){const{dataType:t,feature:i,label:n,layer:a,required:s}=e,o={"aria-label":s?x.substitute(this.messages.requiredFieldLabel,{name:n}):n,class:m.css.label,key:`${a.id}-${i.uid}-${e.name}`},r=[R.tsx("div",{class:m.css.labelTextContent,key:"labelTextContainer"},n,s?R.tsx("span",{"aria-hidden":"true",title:this.messagesCommon.required},"*"):void 0),"unsupported"!==t?this._renderFieldInput(e):this._renderReadOnlyComponent(e),this._renderAuxiliaryText(e)];return"date"===t&&"coded-value"!==e.domain?.type?R.tsx("label",{...o},r):R.tsx("calcite-label",{...o},r)}_renderFieldInput(e){const{dataType:t,domain:i,inputType:n,name:a}=e,s=this.getCommonInputProps(e);if("coded-value"===i?.type){const t=this.viewModel.getFieldValueOptionsForField(a,this.messages.empty);return"switch"!==n||e.hasInvalidSwitchValue?"radio-buttons"===n?this._renderRadioButtonComponents(e,t.flat(),s):this._renderComboBoxComponent(e,t,s):this._renderSwitchComponent(e,s)}return"datetime-picker"===n||"date"===t?this._renderDateComponents(e,s):"number"===t?this._renderNumberComponent(e,s):this._renderStringComponent(e,s)}_renderStringComponent(e,t){return"text-area"===e.inputType?t.readOnly?R.tsx("calcite-input",{...t,loading:e.updating,type:"textarea",onCalciteInputInput:e=>this._saveValueFromComponent(e.target)}):R.tsx("calcite-text-area",{...t,resize:"vertical",onCalciteTextAreaInput:e=>this._saveValueFromComponent(e.target)}):R.tsx("calcite-input",{...t,loading:e.updating,type:"text",onCalciteInputInput:e=>this._saveValueFromComponent(e.target)})}_renderNumberComponent(e,t){return R.tsx("calcite-input-number",{...t,integer:p.isIntegerField(e.field),loading:e.updating,type:"number",onCalciteInputNumberInput:e=>this._saveValueFromComponent(e.target)})}_renderDateComponents(e,t){const{field:i}=e;switch(i.type){case"date":return this._renderDateFieldComponents(e,t);case"date-only":return this._renderDateOnlyFieldComponent(e,t);case"time-only":return this._renderTimeOnlyFieldComponent(e,t);case"timestamp-offset":return this._renderTimestampOffsetFieldComponents(e,t);default:return this._renderReadOnlyComponent(e,b.getLabelForDateFieldValue(i,t.value,{timeZone:this.timeZone,...b.getIntlOptionsForField(i)}))}}_renderDateOnlyFieldComponent(e,t){const{range:i,valid:n,value:a}=e,{class:s,key:o,readOnly:r}=t,{rawMax:l,rawMin:d}=i;return R.tsx("calcite-input-date-picker",{afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!n,class:s,"data-date-part":"date","data-field-name":t[I],key:`${o}-date-input`,max:g.isString(l)?l:void 0,min:g.isString(d)?d:void 0,numberingSystem:b.numberingSystem,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},onfocus:this._onComponentFocus,overlayPositioning:"fixed",readOnly:r,value:null!=a?`${a}`:void 0,onCalciteInputDatePickerChange:e=>this._saveValueFromDateComponent(e.target)})}_renderTimeOnlyFieldComponent(e,t){const{valid:i,value:n}=e,{class:a,key:s,readOnly:o}=t;return R.tsx("calcite-input-time-picker",{afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!i,class:a,"data-date-part":"time","data-field-name":t[I],key:`${s}-time-input`,numberingSystem:b.numberingSystem,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},onfocus:this._onComponentFocus,overlayPositioning:"fixed",readOnly:o,step:e.timeStep,value:null!=n?`${n}`:void 0,onCalciteInputTimePickerChange:e=>this._saveValueFromDateComponent(e.target)})}_renderTimestampOffsetFieldComponents(e,t){const{name:i,range:n,valid:a,value:s}=e,{class:o,key:r,readOnly:l}=t,{rawMax:d,rawMin:u}=n,p={afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!a,numberingSystem:b.numberingSystem,overlayPositioning:"fixed",readOnly:l,[I]:i,onfocus:this._onComponentFocus},c=b.prepareISOFieldValueForDateComponents(d),h=b.prepareISOFieldValueForDateComponents(u),_=b.prepareISOFieldValueForDateComponents(s);return R.tsx("div",{class:m.css.dateInputContainer,key:`${r}-date-time-container`},R.tsx("calcite-input-date-picker",{...p,class:o,"data-date-part":"date",key:`${r}-date-input`,max:c?.date??void 0,min:h?.date??void 0,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},value:_.date??void 0,onCalciteInputDatePickerChange:e=>this._saveValueFromDateComponent(e.target)}),R.tsx("calcite-input-time-picker",{...p,class:o,"data-date-part":"time",key:`${r}-time-input`,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},step:e.timeStep,value:_.time??void 0,onCalciteInputTimePickerChange:e=>this._saveValueFromDateComponent(e.target)}),e.includeTimeOffset?R.tsx("calcite-input-time-zone",{...p,class:o,"data-date-part":"timeZone",disabled:l,key:`${r}-timezone-input`,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},value:_.timeZoneOffset??"0",onCalciteInputTimeZoneChange:e=>this._saveValueFromDateComponent(e.target)}):null)}_renderDateFieldComponents(e,t){const{includeTime:i,name:n,valid:a,value:s}=e,{class:o,key:r,max:l,min:d,readOnly:u}=t,{timeZone:p}=this,c={afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!a,numberingSystem:b.numberingSystem,overlayPositioning:"fixed",readOnly:u,[I]:n,onfocus:this._onComponentFocus},h=b.prepareUnixFieldValueForDateComponents(s,p),_=b.prepareUnixFieldValueForDateComponents(l,p),v=b.prepareUnixFieldValueForDateComponents(d,p);return R.tsx("div",{class:m.css.dateInputContainer,key:`${r}-date-time-container`},R.tsx("calcite-input-date-picker",{...c,class:o,"data-date-part":"date",key:`${r}-date-input`,max:_?.date??void 0,min:v?.date??void 0,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},value:h.date??void 0,onCalciteInputDatePickerChange:e=>this._saveValueFromDateComponent(e.target)}),i?R.tsx("calcite-input-time-picker",{...c,class:o,"data-date-part":"time",key:`${r}-time-input`,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},step:1,value:h.time??void 0,onCalciteInputTimePickerChange:e=>this._saveValueFromDateComponent(e.target)}):null)}_renderReadOnlyComponent(e,t){const i=this.getCommonInputProps(e);return R.tsx("calcite-input",{...i,class:this.classes(m.css.fieldInput,m.css.inputDisabled),readOnly:!0,type:"text",value:null!=t?`${t}`:i.value})}_renderComboBoxComponent(e,t,i){const{value:n,name:a}=e,{messages:s,messagesTemplates:o,viewModel:r,_inputsWithChanges:l}=this,d=t.map((e=>e.map((({name:e,value:t})=>R.tsx("calcite-combobox-item",{key:`#${t}`,selected:n===t,textLabel:e,value:`${t}`}))))),[u,p]=d;this.viewModel.fieldsWithInvalidCodedValue.has(e)&&p.unshift(R.tsx("calcite-combobox-item",{key:"incompatible-option",readOnly:!0,textLabel:`${e.value}`,value:`${e.value}`}));const c=p.length>0?[R.tsx("calcite-combobox-item-group",{key:"recommended",label:s.recommended},u),R.tsx("calcite-combobox-item-group",{key:"other",label:o.other},p)]:u,m="INSERT"===r.arcadeEditType,h=l.has(a),_=null==n&&(!m||h);if(e.showNoValueOptionEnabled){const t="",i=e.showNoValueLabel||s.empty;c.unshift(R.tsx("calcite-combobox-item",{key:"empty-option",selected:_,textLabel:s.empty,value:t},i))}const v=m&&e.showNoValueOptionEnabled&&!h?()=>{}:i.onblur;return R.tsx("calcite-combobox",{...i,allowCustomValues:!1,clearDisabled:!0,disabled:i.readOnly,onblur:v,overlayPositioning:"fixed",selectionMode:"single",onCalciteComboboxChange:({target:e})=>{_&&0===e.selectedItems.length?this._ignoreDeselectionOfNoValueOption(e):this._saveValueFromComponent(e)}},c)}_renderRadioButtonComponents(e,t,i){const{name:n,value:a}=e,s=t.map((({name:e,value:t})=>this._renderRadioButtonComponent({key:e,label:e,name:n,value:t,selected:t===a,props:i})));if(e.showNoValueOptionEnabled){const t="",o=e.showNoValueLabel||this.messages.empty,r=a===t||null===a;s.unshift(this._renderRadioButtonComponent({key:"empty-option",label:o,name:n,value:t,selected:r,props:i}))}return R.tsx("calcite-radio-button-group",{afterCreate:this._afterRadioGroupCreateOrUpdate,afterUpdate:this._afterRadioGroupCreateOrUpdate,class:m.css.inputRadioGroup,"data-field-name":i[I],key:`${i.key}-radio-group`,layout:"vertical",name:i.key,required:i.required},s)}_renderSwitchComponent(e,t){const{value:i}=e,n=!!h.isFieldElementWithInputType(e.element,"switch")&&i===e.element.input.onValue;return R.tsx("calcite-switch",{...t,checked:n,class:m.css.inputSwitch,disabled:t.readOnly,onblur:()=>{this._focusedFieldName=null},onCalciteSwitchChange:e=>this._saveValueFromComponent(e.target)})}_renderRadioButtonComponent({key:e,name:t,value:i,selected:n,label:a,props:s}){return R.tsx("calcite-label",{class:m.css.inputRadioLabel,key:e,layout:"inline"},R.tsx("calcite-radio-button",{...s,afterCreate:void 0,afterUpdate:void 0,checked:n,class:m.css.inputRadio,disabled:s.readOnly,name:t,onblur:()=>{this._focusedFieldName=null},value:i,onCalciteRadioButtonChange:({target:e})=>{e.checked&&this._saveValueFromComponent(e)}}),a)}_renderAuxiliaryText(e){const t=e.name,i=this._inputsWithChanges.has(t)&&!e.valid?h.getErrorMessageForFieldInput(e,this.messages,this.timeZone):null!=this.viewModel.contingencyConstraintViolations.get(t)?this.messages.validationErrors.valuesIncompatible:null!=e.valueExpressionExecutor&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return null!=i?R.tsx("calcite-input-message",{icon:!0,status:"invalid"},i):this._renderDescriptionOrEmpty(e.description)}_renderShowAllRelatedRecordsListItem(e){const{featureCount:t,relationshipId:i,showAllActionVisible:n}=e,{relatedRecordCallbacks:a}=this;if(!n||!a?.showAllRelatedRecords)return;const s=this.messages;return R.tsx("calcite-list-item",{description:x.substitute(s.totalCount,{count:t}),label:s.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(i)},R.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"}))}_renderAddRelatedRecordButton(e){const{canAddRelatedFeature:t,relationshipId:i,relatedLayer:n}=e,{messages:a,relatedRecordCallbacks:s}=this;if(t&&s?.addRelatedRecord&&n)return R.tsx("calcite-button",{alignment:"center",appearance:"outline-fill",class:m.css.centeredButton,disabled:e.updating||!e.originHasValidKey,iconStart:"plus",key:`${i}-add-button`,onclick:()=>this._onAddRelatedRecordsClick(i,n),round:!0,scale:"s",width:"half"},e.relatedLayerIsTable?a.addRecord:a.addFeature)}_renderRelatedRecordListItem(e,t){const{feature:i,description:n,title:a}=e,{feature:s,relatedRecordCallbacks:o}=this,{highlightHelper:r}=this.viewModel,l=()=>{r?.removeAll(),o?.editRelatedRecord&&s&&o.editRelatedRecord({parentFeature:s,relationshipId:t,relatedFeature:i})},d=r?()=>r.add(i):void 0,u=r?()=>r.remove(i):void 0;return R.tsx("calcite-list-item",{bind:this,description:n,key:`${t}-${i.uid}`,label:a,onclick:l,onmouseenter:d,onmouseleave:u,value:a},R.tsx("calcite-icon",{icon:h.getIconForFeature(i),scale:"m",slot:"content-start"}),R.tsx("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderRelationshipInput(e){if(!this._relatedRecordsEnabled||!e.editable)return;const{featureCount:t,relationshipId:i,showAllEnabled:n}=e,a=n?null:this._renderDescriptionOrEmpty(e.description),s=t>0?this._renderRelatedRecordsList(e):e.loaded?e.originHasValidKey?this._renderNoRelatedRecordsNotice():this._renderNoValidOriginKeyNotice(e):void 0;return R.tsx("calcite-label",{class:this.classes(m.css.label,m.css.relatedRecordsLabel),key:`relationship-${i}-container`},R.tsx("div",null,this._renderRelatedRecordsHeaderContainer(e),a,s),this._renderAddRelatedRecordButton(e))}_renderRelatedRecordsHeaderContainer(e){const t=e.updating||!e.loaded;return R.tsx("div",{class:m.css.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},R.tsx("span",null,e.label),t?R.tsx("calcite-loader",{inline:!0,key:"loader",label:this.messagesCommon?.loading,scale:"s",type:"indeterminate"}):void 0)}_renderRelatedRecordsList(e){const{relationshipId:t}=e;return R.tsx("calcite-list",{class:m.css.relatedRecordsList},e.relatedFeatureInfos.map((e=>this._renderRelatedRecordListItem(e,t))),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())}_renderNoValidOriginKeyNotice(e){const{messages:t}=this,i=e.relatedLayerIsTable?t.noOriginKeyRecord:t.noOriginKeyFeature,n=e.relationship?.keyField,a=this.viewModel.findField(n),s=e.layer?.fieldsIndex.get(n),o=a?.label||s?.alias||n,r=x.substitute(i,{relatedLayerName:e.relatedLayer?.title,originKeyField:o});return R.tsx("calcite-notice",{icon:"information",kind:"brand",open:!0,scale:"s",width:"full"},R.tsx("div",{slot:"message"},r))}_renderNoRelatedRecordsNotice(){return R.tsx("calcite-notice",{icon:"information",kind:"brand",open:!0,scale:"s",width:"full"},R.tsx("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))}_renderObserverNode(){if(this.viewModel.activeRelationshipInput?.showAllEnabled)return R.tsx("div",{afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved,bind:this,class:m.css.listObserver,key:"feature-observer"})}getCommonInputProps(e){const{disabled:t}=this,{editable:i,hint:n,label:a,maxLength:s,minLength:o,name:r,range:{max:l,min:d},required:u,valid:p,value:c}=e,h=this._inputsWithChanges.has(r),_=!i||t;return{afterCreate:this._afterComponentCreate,afterUpdate:this._afterComponentCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(m.css.fieldInput,_?m.css.inputDisabled:null,h&&!p?m.css.inputInvalid:null),key:r,label:a,max:null!=l?l:void 0,min:null!=d?d:void 0,maxLength:s>-1?s:void 0,minLength:o>-1?o:void 0,placeholder:n??void 0,readOnly:_,required:u,value:null==c?"":`${c}`,onblur:this._onComponentBlur,onfocus:this._onComponentFocus,onkeydown:this._onComponentKeyDown,[I]:r}}_getFieldInputFromHTMLElement(e){return this.viewModel.findField(e.getAttribute(I))}_afterDateComponentCreate(e){const t=this._getFieldInputFromHTMLElement(e),i=e.dataset.datePart,n=this._dateComponentMap.get(t.name);if("valueAsDate"in e&&null!=e.value){const t=e.value,i=new ResizeObserver((()=>{e.value=void 0,e.value=t,i.unobserve(e)}));i.observe(e)}if(null!=n)switch(i){case"date":n.date=e;break;case"time":n.time=e;break;case"timeZone":n.timeZone=e}else this._dateComponentMap.set(t.name,{[i]:e});this._afterDateComponentCreateOrUpdate(e)}_afterDateComponentCreateOrUpdate(e){this._afterComponentCreateOrUpdate(e)}_afterComponentCreate(e){const t=this._getFieldInputFromHTMLElement(e);h.isNumberFieldInput(t)&&null!=e.value&&"setNumberValue"in e&&e.setNumberValue({committing:!1,value:e.value,origin:"direct"}),this._afterComponentCreateOrUpdate(e)}_afterRadioGroupCreateOrUpdate(e){const t=e.selectedItem,i=e.querySelector("calcite-radio-button"),n=t||i;n&&this._afterComponentCreateOrUpdate(n)}_afterComponentCreateOrUpdate(e){const{viewModel:t}=this,i=this._getFieldInputFromHTMLElement(e),n=t.findField(this._focusedFieldName);this._attemptFocusOnNextRender&&n===i&&(this._attemptFocusOnNextRender=!1,h.isInputInGroupInput(i)&&(i.group.open=!0),e.setFocus())}_onComponentFocus(e){const t=e.target,i=this._getFieldInputFromHTMLElement(t);this._focusedFieldName=i.name}_onComponentBlur(e){const t=e.target;this._focusedFieldName=null,this._saveValueFromComponent(t)}_saveValueFromDateComponent(e){const t=this._getFieldInputFromHTMLElement(e),i=t.field.type,{name:n,range:a}=t,s=this._dateComponentMap.get(n);if(!s)return;let o=this.viewModel.getValue(n),r=null;"date-only"===i?r=e.value:"time-only"===i?(o=b.normalizeTimeOnlyString(o),r=b.normalizeTimeOnlyString(e.value)):r="timestamp-offset"===i?null!=e.value?b.getISOFieldValueFromDateComponents({dateComponent:s.date,timeComponent:s.time,timeZoneComponent:s.timeZone,oldValue:o}):null:null!=e.value?b.getUnixFieldValueFromDateComponents({oldValue:o,dateComponent:s.date,timeComponent:s.time,timeZone:this.timeZone,max:a.max,min:a.min}):null,null!==r&&e.value?o!==r&&this._updateFieldValue(n,r):this._updateFieldValue(n,null)}_saveValueFromComponent(e){const t=this._getFieldInputFromHTMLElement(e);this._updateFieldValue(t.name,this._parseValue(e))}_onComponentKeyDown({key:e,target:t}){const i=this._getFieldInputFromHTMLElement(t);"Enter"===e&&h.isInputInGroupInput(i)&&!i.group.open&&(i.group.open=!0)}_updateFieldValue(e,t){if(this.viewModel.setValue(e,t),this._inputsWithChanges.add(e),this.viewModel.fieldsWithContingentValues.has(e)){const e=Object.fromEntries(Object.entries(this.getValues()).filter((([e,t])=>null!=t)));this.viewModel.validateContingencyConstraints(e)}}_parseValue(e){const t=this._getFieldInputFromHTMLElement(e),i=e.value;return h.isFieldElementWithInputType(t.element,"switch")?e.checked?t.element.input.onValue:t.element.input.offValue:null==i||""===i?null:"number"===t.dataType?"-0"===i||"-0."===i||"-0,"===i?i:parseFloat(i):"date"===t.field.type?parseFloat(i):i}_ignoreDeselectionOfNoValueOption(e){const{firstChild:t,selectedItems:i}=e;0===i.length&&t&&"selected"in t?t.selected=!0:O.warnOnce("Failed to override user attempt to deselect 'No value' option.")}_onGroupToggle(e,t){e.open?(t.open=!0,this._focusedFieldName=this._getFocusableInput("forward",t)?.name||null,this._attemptFocusOnNextRender=!0,"sequential"===this.groupDisplay&&this.viewModel.allGroupInputs.forEach((e=>{e!==t&&(e.open=!1)}))):t.open=!1,this.scheduleRender()}_onFormSubmit(e){e.preventDefault()}_onFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_afterListObserverCreated(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)}_afterListObserverRemoved(){this._listObserverNode=null}_onObserverChange(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;e&&this._listObserverNode&&e.showAllEnabled&&this._listObserver.observe(this._listObserverNode)}_incrementRelatedRecordPage(){const e=this.viewModel.activeRelationshipInput;e?.incrementPage()}_syncGroupInputStates(){if("sequential"!==this.groupDisplay)return;const e=this.viewModel.allGroupInputs;if(!e.length)return;const t=e.filter((e=>e.open));0===t.length?e[0].open=!0:t.length>1&&t.slice(1).forEach((e=>e.open=!1))}};t.__decorate([r.property()],D.prototype,"_listObserverNode",void 0),t.__decorate([r.property()],D.prototype,"_relatedRecordsEnabled",null),t.__decorate([r.property()],D.prototype,"disabled",null),t.__decorate([r.property()],D.prototype,"feature",null),t.__decorate([r.property()],D.prototype,"formTemplate",null),t.__decorate([r.property()],D.prototype,"groupDisplay",void 0),t.__decorate([r.property()],D.prototype,"headingLevel",void 0),t.__decorate([r.property()],D.prototype,"label",null),t.__decorate([r.property()],D.prototype,"layer",null),t.__decorate([r.property()],D.prototype,"map",null),t.__decorate([r.property(),F.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],D.prototype,"messages",void 0),t.__decorate([r.property(),F.messageBundle("esri/t9n/common")],D.prototype,"messagesCommon",void 0),t.__decorate([r.property(),F.messageBundle("esri/widgets/Feature/t9n/Feature")],D.prototype,"messagesFeature",void 0),t.__decorate([r.property(),F.messageBundle("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],D.prototype,"messagesTemplates",void 0),t.__decorate([r.property()],D.prototype,"relatedRecordCallbacks",null),t.__decorate([r.property()],D.prototype,"relationshipId",null),t.__decorate([r.property()],D.prototype,"spatialReference",null),t.__decorate([r.property()],D.prototype,"strict",null),t.__decorate([r.property()],D.prototype,"timeZone",null),t.__decorate([r.property()],D.prototype,"view",null),t.__decorate([r.property(),w.vmEvent(["value-change","submit"])],D.prototype,"viewModel",void 0),D=t.__decorate([u.subclass(k)],D);return D}));
