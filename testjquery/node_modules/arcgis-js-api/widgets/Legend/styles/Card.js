/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../intl","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../symbols/support/svgUtils","../../../symbols/support/utils","../../Widget","./CardCSS","./support/relationshipUtils","./support/univariateUtils","../support/styleUtils","../../support/Heading","../../support/decorators/accessibleHandler","../../support/decorators/messageBundle","../../support/jsxFactory","../../support/widgetUtils","../../../intl/substitute"],(function(e,t,s,i,a,r,o,n,l,c,d,p,h,m,y,g,v,u,f,b,x,_){"use strict";const w=25,L=25,S=768,C=100;var R;!function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"}(R||(R={}));const z="#ddd",N=window.devicePixelRatio;function $(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers?.length;if(!t)return;const s=e.symbolLayers.at(t-1),i=s.resource?.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function k(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers?.length;if(!t)return;const s=e.symbolLayers.at(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let I=class extends p{constructor(e,t){super(e,t),this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=R.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.addHandles(s.watch((()=>this.activeLayerInfos),(e=>{this.removeAllHandles(),this._watchForSectionChanges(e)})))}render(){const{view:e}=this;this._hasIndicators=this.layout===R.Auto&&e&&e.container.clientWidth<=S||this.layout===R.Stack;const t=this.activeLayerInfos,s=t&&t.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const i=this._sectionNames.length,a=this._sectionNames.map(((e,t)=>{const s=_.substitute(this.messagesCommon.pagination.pageText,{index:t+1,total:i});return b.tsx("div",{"aria-controls":`${e}-panel`,"aria-label":s,"aria-selected":(this._selectedSectionName===e).toString(),bind:this,class:this.classes(h.css.indicator,{[h.css.activated]:this._selectedSectionName===e}),"data-section-name":e,id:e,key:e,onclick:this._selectSection,onkeydown:this._focusSection,role:"tab",tabIndex:this._selectedSectionName===e?0:-1,title:s})})),r=this._hasIndicators&&i>1?b.tsx("div",{class:h.css.indicatorContainer,key:"carousel-navigation",role:"tablist"},a):null,o=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):s&&s.length?s:null,n={[h.css.stacked]:this._hasIndicators};return b.tsx("div",{class:this.classes(h.css.base,n)},o||b.tsx("div",{class:h.css.message},this.messages.noLegend),r)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),a=this._sectionNames.indexOf(i),r=this._sectionNames;let o=null;-1!==a&&(r[a+s]?o=document.getElementById(r[a+s]):"ArrowLeft"===t?o=document.getElementById(r[r.length-1]):"ArrowRight"===t&&(o=document.getElementById(r[0])),o?.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach((e=>{const t=`activeLayerInfo-${e.layer.uid}-version-change`;this.removeHandles(t),this._watchForSectionChanges(e.children),this.addHandles(s.watch((()=>e.version),(()=>this._generateSectionNames())),t)}));const t="activeLayerInfos-collection-change";this.removeHandles(t),this.addHandles(e.on("change",(()=>this._watchForSectionChanges(e))),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return b.tsx("div",{class:this.classes(h.css.service,h.css.groupLayer),key:e.layer.uid},b.tsx("div",{class:h.css.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const a={[h.css.groupLayerChild]:!!e.parent};return b.tsx("div",{class:this.classes(h.css.service,a),key:e.layer.uid},b.tsx("div",{class:h.css.serviceCaptionContainer},b.tsx("div",{class:h.css.serviceCaptionText},e.title)),b.tsx("div",{class:h.css.serviceContent},i))}}_renderLegendForElement(e,t,s,i=!1,a=!1){const r="color-ramp"===e.type,o="opacity-ramp"===e.type,n=t.layer;let l=null;if("string"==typeof e.title)l=e.title;else if(e.title){const t=e.title,s=g.getTitle(this.messages,t,r||o);l=t.title?`${t.title} (${s})`:s}const c=this._getSectionName(n,e,s),d=this._hasIndicators&&!a?b.tsx("div",null,b.tsx(v.Heading,{class:h.css.carouselTitle,level:this.headingLevel},t.title),b.tsx(v.Heading,{class:h.css.layerCaption,level:v.incrementHeadingLevel(this.headingLevel)},l)):l?b.tsx(v.Heading,{class:h.css.layerCaption,level:this.headingLevel},l):null,p=t.effectList;let y=null;switch(e.type){case"symbol-table":{const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes?.[h.css.symbolRow],t={[h.css.labelContainer]:!e&&!i,[h.css.relationshipLabelContainer]:i};y=b.tsx("div",{class:this.classes(t)},s)}break}case"color-ramp":case"opacity-ramp":case"heatmap-ramp":case"stretch-ramp":y=this._renderLegendForRamp(e,n.opacity,p);break;case"size-ramp":y=this._renderSizeRamp(e,n.opacity);break;case"pie-chart-ramp":y=this._renderPieChartRamp(e);break;case"relationship-ramp":y=m.renderRelationshipRamp(e,this.id,{opacity:n.opacity,effectList:p,ariaLabel:this.messages.previewRelationshipRampAriaLabel});break;case"univariate-above-and-below-ramp":y=this._renderUnivariateAboveAndBelowRamp(e,n.opacity,p);break;case"univariate-color-size-ramp":y=this._renderUnivariateColorSizeRamp(e,n.opacity,p)}if(!y)return null;const u=b.tsx("div",{"aria-labelledby":c,class:h.css.section,id:`${c}-panel`,key:c,role:"tabpanel",tabIndex:0},[d,y]);return a||this._sectionMap.set(c,u),u}_renderPieChartRamp(e){return b.tsx("div",{afterCreate:g.attachToNode,bind:e.preview,class:h.css.pieChartRampPreview})}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:a}=y.getUnivariateAboveAndBelowRampElements(e,t,"horizontal");if(!i)return null;const r=y.getUnivariateSizeRampSize(i,"full",!0,"horizontal"),o=y.getUnivariateColorRampSize(i,"above",!0,"horizontal"),n=y.getUnivariateColorRampSize(i,"below",!0,"horizontal"),l=12,c=this.messages?.previewColorRampAriaLabel,d=y.getUnivariateColorRampPreview(a,{width:o,height:l,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s,ariaLabel:c}),p=y.getUnivariateColorRampPreview(a,{width:n,height:l,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s,ariaLabel:c}),m=y.getUnivariateColorRampMargin(i,"card"),v=i.infos.map((e=>e.label)),u=v.length-1,f=v.map(((e,t)=>0===t||t===u?b.tsx("div",{key:t},e):null)),_={display:"flex",flexDirection:"column"},w={display:"flex",flexDirection:"row"},L={marginTop:"3px",display:"flex"};x.isRTL(this.container)?L.marginRight=`${m}px`:L.marginLeft=`${m}px`;const S={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return b.tsx("div",{class:h.css.layerRow,key:"size-ramp-preview",styles:_},b.tsx("div",{class:this.classes(h.css.symbolContainer,h.css.sizeRampHorizontal),styles:w},i.infos.map(((e,t)=>b.tsx("div",{afterCreate:g.attachToNode,bind:e.preview,class:h.css.symbol,key:t})))),d?b.tsx("div",{class:h.css.univariateAboveAndBelowColorRamp,key:"color-ramp-preview",styles:L},b.tsx("div",{afterCreate:g.attachToNode,bind:d}),b.tsx("div",{afterCreate:g.attachToNode,bind:p})):null,b.tsx("div",{class:h.css.layerInfo},b.tsx("div",{class:h.css.rampLabelsContainer,styles:S},f)))}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:a}=y.getUnivariateColorSizeRampElements(e,"horizontal");if(!i)return null;const r=y.getUnivariateSizeRampSize(i,"full",!1,"horizontal"),o=y.getUnivariateColorRampSize(i,"full",!1,"horizontal"),n=12,l=y.getUnivariateColorRampPreview(a,{width:o,height:n,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s,ariaLabel:this.messages?.previewColorRampAriaLabel}),c=y.getUnivariateColorRampMargin(i,"card"),d=i.infos.length-1,p=i.infos.map(((e,t)=>0===t||t===d?b.tsx("div",{key:t},e.label):null)),m={display:"flex",flexDirection:"column"},v={display:"flex",flexDirection:"row"},u={marginTop:"3px",display:"flex"};x.isRTL(this.container)?u.marginRight=`${c}px`:u.marginLeft=`${c}px`;const f={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return b.tsx("div",{class:h.css.layerRow,key:"size-ramp-preview",styles:m},b.tsx("div",{class:this.classes(h.css.symbolContainer,h.css.sizeRampHorizontal),styles:v},i.infos.map(((e,t)=>b.tsx("div",{afterCreate:g.attachToNode,bind:e.preview,class:h.css.symbol,key:t})))),b.tsx("div",{class:h.css.univariateAboveAndBelowColorRamp,key:"color-ramp-preview",styles:u},b.tsx("div",{afterCreate:g.attachToNode,bind:l})),b.tsx("div",{class:h.css.layerInfo},b.tsx("div",{class:h.css.rampLabelsContainer,styles:f},p)))}_renderLegendForElementInfo(e,t,s,i){const a=t.layer;if(e.type)return this._renderLegendForElement(e,t,i,!1,!0);const r=g.isImageryStretchedLegend(a,s),o=g.getTitle(this.messages,e.label,!1)??"";if(e.preview){if(!e.symbol?.type.includes("simple-fill")){if(!e.label)return b.tsx("div",{afterCreate:g.attachToNode,bind:e.preview,key:i});const t={[h.css.symbolCell]:this._hasIndicators};return b.tsx("div",{class:this.classes(h.css.layerRow,{[h.css.symbolRow]:this._hasIndicators}),key:i},b.tsx("div",{afterCreate:g.attachToNode,bind:e.preview,class:this.classes(t)}),b.tsx("div",{class:this.classes(h.css.imageLabel,{[h.css.labelCell]:this._hasIndicators})},o))}let s=255,r=255,n=255,l=0,c=255,p=255,m=255,y=0;const v=e.symbol.color?.a,u=e.symbol.outline?.color?.a;v&&(s=e.symbol.color.r,r=e.symbol.color.g,n=e.symbol.color.b,l=e.symbol.color.a*a.opacity),u&&(c=e.symbol.outline.color.r,p=e.symbol.outline.color.g,m=e.symbol.outline.color.b,y=e.symbol.outline.color.a*a.opacity);const f=e.symbol.color?.isBright??!0,x=f?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",_={background:v?`rgba(${s}, ${r}, ${n}, ${l})`:"none",color:f?"black":"white",textShadow:`-1px -1px 0 ${x},\n                                              1px -1px 0 ${x},\n                                              -1px 1px 0 ${x},\n                                              1px 1px 0 ${x}`,border:u?`1px solid rgba(${c}, ${p}, ${m}, ${y})`:"none",filter:d.getCSSFilterFromEffectList(t.effectList)??void 0};return b.tsx("div",{class:h.css.layerRow,key:i},b.tsx("div",{class:h.css.labelElement,styles:_},o))}if(e.src){const t=this._renderImage(e,a,r);return b.tsx("div",{class:h.css.layerRow,key:i},t,b.tsx("div",{class:h.css.imageLabel},o))}}_renderImage(e,t,s){const{label:i,src:a,opacity:r}=e,o={[h.css.imageryLayerStretchedImage]:s,[h.css.symbol]:!s},n={opacity:`${null!=r?r:t.opacity}`};return b.tsx("img",{alt:g.getTitle(this.messages,i,!1),"aria-label":g.getTitle(this.messages,i,!1),border:0,class:this.classes(o),height:e.height,src:a,styles:n,width:e.width})}_renderSizeRampLines(e){const t=e.infos,s=t[0],a=t[t.length-1],r=s.symbol,o=this._hasIndicators,n=i.pt2px(s.size+s.outlineSize)*N,l=i.pt2px(a.size+a.outlineSize)*N,c=o?n:n+50*N,d=o?n/2+50*N:n,p=k(r),h=$(r),m=document.createElement("canvas");m.width=c,m.height=d,m.style.width=m.width/N+"px",m.style.height=m.height/N+"px";const y=m.getContext("2d");if(o){y.beginPath();const e=0,t=0,s=c/2-l/2,i=d;y.moveTo(e,t),y.lineTo(s,i);const a=c,r=0,o=c/2+l/2,n=d;y.moveTo(a,r),y.lineTo(o,n)}else{y.beginPath();const e=0,t=d/2-l/2,s=c,i=0;y.moveTo(e,t),y.lineTo(s,i);const a=0,r=d/2+l/2,o=c,n=d;y.moveTo(a,r),y.lineTo(o,n)}return y.strokeStyle=z,y.stroke(),b.tsx("div",{afterCreate:g.attachToNode,bind:m,styles:o?{display:"flex",marginTop:`-${p?0:h?n/2:0}px`,marginBottom:`-${p?l:h?l/2:0}px`}:{display:"flex",marginRight:`-${p?0:h?n/2:0}px`,marginLeft:`-${p?0:h?l/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,i=s[0].label,a=s[s.length-1].label;let r=s[0].preview,o=s[s.length-1].preview;const n=this._hasIndicators,l={"flex-direction":n?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),o&&(o=o.cloneNode(!0),o.style.display="flex");const c={opacity:null!=t?`${t}`:""};return b.tsx("div",{class:this.classes(h.css.layerRow,{[h.css.sizeRampRow]:n})},b.tsx("div",{class:h.css.rampLabel},n?i:a),b.tsx("div",{class:h.css.sizeRampContainer,styles:l},b.tsx("div",{afterCreate:g.attachToNode,bind:r,class:h.css.sizeRampPreview,styles:c}),this._renderSizeRampLines(e),b.tsx("div",{afterCreate:g.attachToNode,bind:o,class:h.css.sizeRampContainer,styles:c})),b.tsx("div",{class:h.css.rampLabel},n?a:i))}_getRampStopLabel(e,t){switch(t){case"heatmap-ramp":return this.messages[e.label];case"stretch-ramp":return g.getStretchStopLabel(e,this.messages);default:return e.label}}_renderLegendForRamp(e,t,s){const i=e.infos,a=e.type,r="heatmap-ramp"===a,o=i.length-1,n=L,l=o>2&&!r?w*o:C,p=l+20,m=10,y=i.slice(0).reverse(),g=y.length-1,v=y.length%2!=0?y[y.length/2|0]:null,u=v&&b.tsx("div",{class:h.css.intervalSeparatorsContainer},b.tsx("div",{class:h.css.intervalSeparator},"|"),b.tsx("div",{class:h.css.rampLabel},this._getRampStopLabel(v,a))),f=[[{shape:{type:"path",path:`M0 ${n/2} L${m} 0 L${m} ${n} Z`},fill:y[0].color,stroke:{width:0}},{shape:{type:"rect",x:m,y:0,width:l,height:n},fill:{type:"linear",x1:m,y1:0,x2:l+m,y2:0,colors:y.map(((e,t)=>({color:e.color,offset:r&&"ratio"in e?e.ratio:t/o})))},stroke:{width:0}},{shape:{type:"path",path:`M${l+m} 0 L${p} ${n/2} L${l+m} ${n} Z`},fill:y[g].color,stroke:{width:0}}]],x=c.renderSVG(f,p,n),_={filter:d.getCSSFilterFromEffectList(s)??void 0,opacity:null==t?void 0:`${t}`},S={justifyContent:"center"};return b.tsx("div",{class:h.css.layerRow,styles:S},b.tsx("div",{class:h.css.rampLabel},this._getRampStopLabel(y[0],a)),b.tsx("div",{class:h.css.symbolContainer},b.tsx("div",{styles:_},x),u),b.tsx("div",{class:h.css.rampLabel},this._getRampStopLabel(y[g],a)))}};e.__decorate([a.property()],I.prototype,"activeLayerInfos",void 0),e.__decorate([a.property()],I.prototype,"headingLevel",void 0),e.__decorate([a.property()],I.prototype,"layout",void 0),e.__decorate([a.property(),f.messageBundle("esri/widgets/Legend/t9n/Legend")],I.prototype,"messages",void 0),e.__decorate([a.property(),f.messageBundle("esri/t9n/common")],I.prototype,"messagesCommon",void 0),e.__decorate([a.property({readOnly:!0})],I.prototype,"type",void 0),e.__decorate([a.property()],I.prototype,"view",void 0),e.__decorate([u.accessibleHandler()],I.prototype,"_selectSection",null),I=e.__decorate([l.subclass("esri.widgets.Legend.styles.Card")],I);return I}));
