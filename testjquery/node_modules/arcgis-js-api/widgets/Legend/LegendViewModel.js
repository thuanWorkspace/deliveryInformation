/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/Collection","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/get","./support/ActiveLayerInfo","../../intl/locale"],(function(e,r,t,i,s,a,n,o,l,y,d,c,h){"use strict";const L={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},u=i.ofType(c),_=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer"]),p="view.basemapView.baseLayerViews",f="view.groundView.layerViews",v="view.basemapView.referenceLayerViews",w=[p,f,"view.layerViews",v];let I=class extends t{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new i,this.activeLayerInfos=new u,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(s.watch((()=>this.view),(()=>this._viewHandles()),s.initial),L.view),this.addHandles(h.onLocaleChange((()=>this._refresh())))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(L.state),this.view&&this.addHandles(s.watch((()=>this.state),(()=>this._stateHandles()),s.initial),L.state)}_stateHandles(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([L.allLayerViews,L.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);const r=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],r?.parent&&r.parent.children.remove(r)}_watchPropertiesAndAllLayerViews(){const{view:e}=this;if(!e)return;const{allLayerViews:r}=e;r.length&&this._refresh(),this.addHandles(r.on("change",(e=>this._allLayerViewsChangeHandle(e))),L.allLayerViews),this.addHandles(s.watch((()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible]),(()=>this._propertiesChangeHandle())),L.legendProperties)}_allLayerViewsChangeHandle(e){e.removed.forEach((e=>this._destroyViewActiveLayerInfo(e.uid))),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){const r=this.view;if(e.length<2||!r)return;const t=[];e.forEach((r=>{if(!r.parent){const i=r.layer.parent,s=i&&"uid"in i&&this._layerViewByLayerId[i.uid],a=s&&this._activeLayerInfosByLayerViewId[s.uid];a&&e.includes(a)&&(t.push(r),r.parent=a,a.children.add(r),this._sortActiveLayerInfos(a.children))}})),e.removeMany(t);const i={};r.allLayerViews.forEach(((e,r)=>i[e.layer.uid]=r)),e.sort(((e,r)=>{const t=i[e.layer.uid]||0;return(i[r.layer.uid]||0)-t}))}_generateLayerViews(){const e=[];return w.filter(this._filterLayerViews,this).map((e=>d.get(this,e))).filter((e=>null!=e)).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const r=!this.basemapLegendVisible&&(e===p||e===v),t=!this.groundLegendVisible&&e===f;return!r&&!t}_collectLayerViews(e,r){const t=i=>(i&&i.forEach((i=>{r.push(i),t(i[e])})),r);return t}_filterLayerViewsByLayerInfos(e){const r=this.layerInfos;return!r||!r.length||r.some((r=>this._hasLayerInfo(r,e)))}_hasLayerInfo(e,r){const t=this._isLayerUIDMatching(e.layer,r.layer.uid);return t&&(this._layerInfosByLayerViewId[r.uid]=e),t}_isLayerUIDMatching(e,r){return e&&(e.uid===r||this._hasLayerUID(e.layers,r))}_hasLayerUID(e,r){return e&&e.some((e=>this._isLayerUIDMatching(e,r)))}_isLayerViewSupported(e){return!!_.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(s.watch((()=>[e.legendEnabled,e.layer?.legendEnabled]),(()=>this._layerActiveHandle(e))),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}_buildActiveLayerInfo(e){const r=e.layer,t=e.uid,i=this._layerInfosByLayerViewId[t];let a=this._activeLayerInfosByLayerViewId[t];if(!a){const s=void 0!==i?.title&&i.layer.uid===r.uid;a=new c({layer:r,layerView:e,title:s?i.title:r.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:i?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[t]=a}const n=r.parent&&"uid"in r.parent?this._layerViewByLayerId[r.parent?.uid]:null;if(a.parent=this._activeLayerInfosByLayerViewId[n?.uid],!this.hasHandles(t)){const i=[s.watch((()=>r.title),(e=>this._titleHandle(e,a))),s.watch((()=>[r.opacity,"renderer"in r&&r.renderer,"pointSymbol"in r&&r.pointSymbol,"lineSymbol"in r&&r.lineSymbol,"polygonSymbol"in r&&r.polygonSymbol]),(()=>this._constructLegendElements(a))),s.when((()=>!0===this.view?.stationary),(()=>this._scaleHandle(a)),s.initial),s.watch((()=>e._effectiveRenderer),(()=>this._constructLegendElements(a))),s.watch((()=>"effect"in r&&r.effect),(()=>this._constructLegendElements(a))),s.when((()=>this.view?.timeZone),(()=>this._constructLegendElements(a)),s.initial)];if(this.respectLayerVisibility){const t=s.watch((()=>e.legendEnabled),(e=>this._legendEnabledHandle(e,a))),n=s.watch((()=>r.legendEnabled),(e=>this._legendEnabledHandle(e,a)));i.push(t,n)}this.addHandles(i,t)}a.isScaleDriven||this._constructLegendElements(a),this._addActiveLayerInfo(a)}_titleHandle(e,r){r.title=e,this._constructLegendElements(r)}_legendEnabledHandle(e,r){e?this._addActiveLayerInfo(r):this._removeActiveLayerInfo(r)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:r,layer:t}=e;if(this._isLayerActive(r)&&!this.activeLayerInfos.includes(e)){const r=e.parent;if(r)r.children.includes(e)||r.children.push(e),this._sortActiveLayerInfos(r.children);else{const r=this.layerInfos?.some((e=>e.layer.uid===t.uid));t.parent&&"uid"in t.parent&&!r?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const e=[];this._activeLayerInfosWithNoParent.forEach((r=>{const t=r.layer.parent,i=t&&"uid"in t?this._layerViewByLayerId[t?.uid]:null,s=this._activeLayerInfosByLayerViewId[i?.uid];s&&(e.push(r),r.parent=s)})),e.length&&(this._activeLayerInfosWithNoParent.removeMany(e),e.forEach((e=>this._addActiveLayerInfo(e))))}}}_removeActiveLayerInfo(e){const r=e.parent;r?r.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const r=e.layer;"featureCollections"in r&&r.featureCollections?e.buildLegendElementsForFeatureCollections(r.featureCollections):"featureReduction"in r&&r.featureReduction&&"renderer"in r.featureReduction&&("binning"===r.featureReduction.type||"cluster"===r.featureReduction.type)?e.buildLegendElementsForFeatureReduction(r.featureReduction):"renderer"in r&&r.renderer&&!("sublayers"in r)?e.buildLegendElementsForRenderer(r.renderer):"url"in r&&r.url?e.buildLegendElementsForTools():e.children.forEach((e=>this._constructLegendElements(e)))}};e.__decorate([a.property({type:u})],I.prototype,"activeLayerInfos",void 0),e.__decorate([a.property()],I.prototype,"basemapLegendVisible",void 0),e.__decorate([a.property()],I.prototype,"groundLegendVisible",void 0),e.__decorate([a.property()],I.prototype,"hideLayersNotInCurrentView",void 0),e.__decorate([a.property()],I.prototype,"keepCacheOnDestroy",void 0),e.__decorate([a.property()],I.prototype,"respectLayerVisibility",void 0),e.__decorate([a.property()],I.prototype,"layerInfos",void 0),e.__decorate([a.property({readOnly:!0})],I.prototype,"state",null),e.__decorate([a.property()],I.prototype,"view",void 0),I=e.__decorate([y.subclass("esri.widgets.Legend.LegendViewModel")],I);return I}));
