/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../Color","../../../symbols","../../../renderers/support/numberUtils","../../../symbols/support/cimSymbolUtils","../../../symbols/support/utils","./utils","../../support/widgetUtils","../../../support/themeUtils","../../../symbols/SimpleMarkerSymbol","../../../symbols/SimpleLineSymbol"],(function(e,l,t,n,i,o,r,s,a,u,c,m){"use strict";const y=30,p=12,f=[255,255,255],b=[200,200,200],h=[128,128,128],d=20,S=5;function g(e){return"esri.symbols.SimpleMarkerSymbol"===e.declaredClass}function w(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}function v(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}function z(e){return"esri.symbols.TextSymbol"===e.declaredClass}function V(e,l){const t=e.length-1;return e.map(((e,n)=>s.createStopLabel(e,n,t,l)))}async function k(e,l,t,n,o,s,a){const u=l.legendOptions,c=u?.customValues,m=a||await D(e,t),y=l.stops,p=!!m,f=!!c,b=null!=l.minSize&&null!=l.maxSize,h=y&&y.length>1,d=!!l.target;if(!p||!f&&!(b||h&&!d))return;const S=r.isVolumetricSymbol(m);let g=!1,w=null,v=null;w=S&&!h?i.round([l.minDataValue,l.maxDataValue]):c??await U(l,m,n,o?.type);const z=e?.authoringInfo,k="univariate-color-size"===z?.type,M=k&&"above-and-below"===z?.univariateTheme;if(!w&&h&&(w=y.map((e=>e.value)),g=y.some((e=>!!e.label)),"flow"===e.type&&(w=i.round(w)),g&&(v=y.map((e=>e.label)))),S&&null!=w&&w?.length>2&&!M&&(w=[w[0],w[w.length-1]]),!w)return null;k&&5!==w?.length&&(w=P({minSize:w[0],maxSize:w[w.length-1]}));const L=S?x(e,w):null,I=r.getSymbolOutlineSize(m),T=g?null:V(w,s);return(await Promise.all(w.map((async(t,i)=>{const r=S?L[i]:await E(l,m,t,n,o?.type);return{value:t,symbol:O(M&&"class-breaks"===e.type?C(e,i):m,r),label:g?v[i]:T[i],size:r,outlineSize:I}})))).reverse()}function x(e,l){const t=e?.authoringInfo,n="univariate-color-size"===t?.type;let i=[p,y];if(n){const e=l[0],t=l[l.length-1],n=p,o=y;i=l.map((l=>n+(l-e)/(t-e)*(o-n)))}return n&&"below"===t?.univariateTheme&&i.reverse(),i}function C(e,l){const t=e.classBreakInfos,n=t.length,i=n<2||!(l>=2)?t[0].symbol.clone():t[n-1].symbol.clone();return e.visualVariables.some((e=>"color"===e.type))&&(i.type.includes("3d")?L(i):I(i)),i}async function D(e,l){if("flow"===e.type)return s.getSymbolForFlowRenderer(e,l);if("pie-chart"===e.type)return new c({color:null,outline:e.outline?.width?e.outline:new m});let t=null,n=null;if("simple"===e.type)t=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;t=l&&l[0]&&l[0].symbol,n=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;t=l?.[0]?.symbol,n=null!=l&&l.length>1}return!t||M(t)?null:(t=t.clone(),(l||n)&&(t.type.includes("3d")?L(t):I(t)),t)}function M(e){if(e){if(n.isSymbol3D(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return e.type.includes("fill")}return!1}function L(e){"line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:h}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource?.href?e.material={color:b}:(e.material={color:f},e.outline={color:h,size:1.5})}))}function I(e){const l=u.isDarkTheme();if("cim"===e.type)o.applyCIMSymbolColor(e,new t(b));else if(e.type.includes("line"))e.color=h;else if(e.color=l?h:f,"simple-marker"===e.type)if(e.outline){const l=e.outline?.color?.toHex();"#ffffff"===l&&(e.outline.color=h)}else e.outline={color:h,width:1.5}}async function U(l,t,n,o){const r=(await new Promise(((l,t)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,t)))).getSizeRangeAtScale(l,n,o),s=r&&P(r);if(!r||!s)return;let a=s.map((e=>T(e,l,r)));a=i.round(a);for(let e=1;e<a.length-1;e++){const i=await q(l,t,a[e],a[e-1],n,o);i&&(a[e]=i[0],s[e]=i[1])}return a}function P(e){const l=e.minSize,t=e.maxSize,n=S,i=(t-l)/(n-1),o=[];for(let r=0;r<n;r++)o.push(l+i*r);return o}function T(e,l,t){const n=t.minSize,i=t.maxSize,o=l.minDataValue,r=l.maxDataValue;let s;if(e<=n)s=o;else if(e>=i)s=r;else{s=(e-n)/(i-n)*(r-o)+o}return s}async function q(e,l,t,n,o,r){const s=await E(e,l,t,o,r),a=await E(e,l,n,o,r),u=i.numDigits(t),c=u.fractional,m=d;let y=u.integer,p=null,f=null;t>0&&t<1&&(p=10**c,t*=p,y=i.numDigits(t).integer);for(let b=y-1;b>=0;b--){const n=10**b;let u=Math.floor(t/n)*n,c=Math.ceil(t/n)*n;null!=p&&(u/=p,c/=p);let y=(u+c)/2;[,y]=i.round([u,y,c],{indexes:[1]});const h=await E(e,l,u,o,r),d=await E(e,l,c,o,r),S=await E(e,l,y,o,r),g=i.percentChange(s,h,a,null),w=i.percentChange(s,d,a,null),v=i.percentChange(s,S,a,null);let z=g.previous<=m,V=w.previous<=m;if(z&&V&&(g.previous<=w.previous?(z=!0,V=!1):(V=!0,z=!1)),z?f=[u,h]:V?f=[c,d]:v.previous<=m&&(f=[y,S]),f)break}return f}async function E(l,t,n,i,o){const{getSize:r}=await new Promise(((l,t)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,t)));return r(l,n,{scale:i,view:o,shape:"simple-marker"===t.type?t.style:null})}function O(e,l){const t=e.clone();if(n.isSymbol3D(t))r.isVolumetricSymbol(t)||t.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=l)}));else if(g(t))t.size=l;else if(w(t)){const e=t.width,n=t.height;t.height=l,t.width=l*(e/n)}else v(t)?t.width=l:z(t)&&t.font&&(t.font.size=l);return t}l.getRampStops=k,l.realWorldMaxSize=y,l.realWorldMinSize=p,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})}));
