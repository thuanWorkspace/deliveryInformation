/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../../../chunks/tslib.es6","../../../Color","../../../intl","../../../kernel","../../../request","../../../symbols","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/jsonMap","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/timeUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/PropertyOrigin","../../../layers/effects/EffectView","../../../layers/effects/jsonUtils","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../layers/support/rasterFormats/pixelRangeUtils","../../../renderers/support/jsonUtils","../../../renderers/support/rendererConversion","../../../renderers/visualVariables/support/SizeVariableLegendOptions","../../../smartMapping/support/utils","../../../symbols/support/cimSymbolUtils","../../../symbols/support/previewUtils","../../../symbols/support/renderUtils","../../../symbols/support/symbolUtils","../../../symbols/support/utils","./clusterUtils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","../../smartMapping/support/utils","../../../symbols/SimpleMarkerSymbol","../../../symbols/SimpleFillSymbol","../../../intl/messages","../../../intl/substitute"],(function(e,t,l,s,i,r,n,a,o,u,c,d,y,h,p,m,f,g,b,S,_,w,v,L,C,E,I,R,F,V,T,z,D,x,P,O,M,A,U,k,B,H,N,q,$,W,G,j){"use strict";const J="https://utility.arcgis.com/sharing/tools/legend",Q="esri.layers.ImageryLayer",Z="esri.layers.ImageryTileLayer",K="esri.layers.WCSLayer",X=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Y=new c.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ee=new $({size:6,outline:{color:[128,128,128,.5],width:.5}}),te=new W({style:"solid"});function le(e){return"flow"===e.type}function se(e){return"vector-field"===e.type}function ie(e){return"raster-colormap"===e.type}function re(e){return"raster-stretch"===e.type}function ne(e){return"raster-shaded-relief"===e.type}function ae(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function oe(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function ue(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function ce(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function de(e){return he(e)||pe(e)||me(e)||ye(e)}function ye(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}function he(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function pe(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function me(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function fe(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function ge(e){return"esri.renderers.PieChartRenderer"===e.declaredClass}function be(e,t){return ae(e)||oe(e)||ue(e)||ce(e)||fe(e)||ge(e)?"2d"===t.type||V.isSupportedRenderer3D(e):re(e)||ie(e)||ne(e)||he(e)||pe(e)||me(e)||se(e)||le(e)}function Se(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}function _e(e){return"esri.layers.SubtypeGroupLayer"===e.declaredClass}function we(e){return"esri.layers.VoxelLayer"===e.declaredClass}function ve(e){return"esri.layers.WMSLayer"===e.declaredClass}function Le(e){return"esri.layers.WMTSLayer"===e.declaredClass}function Ce(e){return"esri.layers.MapImageLayer"===e.declaredClass}function Ee(e){return"esri.layers.TileLayer"===e.declaredClass}function Ie(e){return e.declaredClass===Q}function Re(e){return e.declaredClass===Z}function Fe(e){return e.declaredClass===K}function Ve(e){return"stretch-ramp"===e.type}function Te(e){const t="authoringInfo"in e?e?.authoringInfo:null;return"univariate-color-size"===t?.type}function ze(e){const t="authoringInfo"in e?e?.authoringInfo:null;return"univariate-color-size"===t?.type&&"above-and-below"===t?.univariateTheme}function De(e){return"sublayers"in e}async function xe(e,t){const l=await G.fetchMessageBundle("esri/widgets/Legend/t9n/Legend");return"previewTemplateAriaLabel"!==e||t||(e="previewAriaLabel"),j.substitute(l[e],{label:t})}const Pe=new $({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Oe={},Me=class extends a{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new u,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this.addHandles([h.on((()=>this.children),"change",(t=>{const{added:l,removed:s}=t;l.forEach((t=>{const l=`activeLayerInfo-ready-watcher-${t.layer.uid}`;this.addHandles(h.watch((()=>t.ready),e,h.initial),l)})),s.forEach((e=>this.removeHandles(e.layer.uid))),e()}))]),this.keepCacheOnDestroy||(Oe={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Oe=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new v.EffectView,t.effect=e.effect,t.endTransitions(),t.scale=this.scale),t}get opacity(){const e=this.layer.opacity,t=this.parent?.opacity,l=this.layer.parent,s=l&&"uid"in l?this._getParentLayerOpacity(l):null;return null!=t?t*e:null!=s?s*e:e}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){const e=this.layer;if(null===e)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if("cluster"===e.featureReduction.type)return!0;if("binning"===e.featureReduction.type&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,(e=>{if(I.isFeatureLayer(e))return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet?.features.length){const t=e.layerDefinition,l=t?.drawingInfo,s=l&&F.fromJSON(l.renderer),i=Y.read(t.geometryType);return s?this._getRendererLegendElements(s,{title:e.name,geometryType:i}):(d.getLogger(this).warn("drawingInfo not available!"),null)}return null}));try{const e=[],l=await Promise.allSettled(t);for(const t of l)if("fulfilled"===t.status)for(const l of t.value??[])e.push(l);this.legendElements=e,this.notifyChange("ready")}catch(l){d.getLogger(this).warn("error while building legend for layer!",l)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){d.getLogger(this).warn("error while building legend for layer!",t)}}async buildLegendElementsForFeatureReduction(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(t){d.getLogger(this).warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){const e=this.layer;if(we(e))this._constructLegendElementsForVoxellayer();else if(Le(e))this._constructLegendElementsForWMTSlayer();else if(ve(e))await this._constructLegendElementsForWMSSublayers();else if(Se(e))await this._constructLegendElementsForBuildingSceneLayer();else if(Ce(e)||Ee(e)||_e(e))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let t="default";if(Ie(e)){const l=e;t=(l?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")}await this._getLegendLayers(`${e.uid}-${t}`).then((async t=>{this.legendElements=[],this.notifyChange("ready");const l=t.map((async t=>{if(Ie(e)||Re(e)){const t=h.watch((()=>["renderingRule"in e&&e.rasterFunction,e.bandIds]),(()=>y.debounce((async()=>{Oe.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()}))()));this.addHandles(t,"imageryLayers-watcher")}const l=this._generateSymbolTableElementForLegendLayer(t);l&&l.infos.length&&(Ie(e)&&(l.title=e.title),this.legendElements.push(l)),this.notifyChange("ready")}));await Promise.allSettled(l)})).catch((e=>{d.getLogger(this).warn("Request to server for legend has failed!",e)}))}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,l=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!l&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await h.whenOnce((()=>!t.updating));const s=l?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();if(!s)return!0;s.geometry=this.view.extent;return 0!==(l?"queryFeatureCount"in t&&await t.queryFeatureCount(s):"queryFeatureCount"in e&&await e.queryFeatureCount(s))}_getParentLayerOpacity(e){let t=1;const l=e.parent;return l&&"uid"in l&&(t=this._getParentLayerOpacity(l)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some((e=>e.ready))}_isRendererScaleDriven(e){if("dot-density"===e.type)return!0;const t="valueExpression"in e?e.valueExpression:null;if(X.test(t))return!0;const l="visualVariables"in e?e.visualVariables:null;return!!l?.some((e=>this._isScaleDrivenSizeVariable(e)))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case"simple":return this._isScaleDrivenSymbol(e.symbol);case"class-breaks":return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some((e=>this._isScaleDrivenSymbol(e.symbol)));case"unique-value":return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some((e=>this._isScaleDrivenSymbol(e.symbol)))}return!1}_isScaleDrivenSymbol(e){if("cim"===e?.type){const{primitiveOverrides:t,minScale:l,maxScale:s}=e.data,i=t?.some((e=>/\$view\.scale/.test(e.valueExpressionInfo?.expression||"")))??!1;return null!=l||null!=s||i}return!1}_isScaleDrivenSizeVariable(e){if(e&&"size"!==e.type)return!1;const t=e,l=t.minSize,s=t.maxSize;return!("object"!=typeof l||!l||!this._isScaleDrivenSizeVariable(l))||(!("object"!=typeof s||!s||!this._isScaleDrivenSizeVariable(s))||(!!t.expression||X.test(t.valueExpression)))}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((e=>this._isLayerScaleDriven(e)));const t=e.parent;if(!1===e.loaded&&t&&Ce(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const l of t.sourceJSON.layers??[])if(l.id===e.source.mapLayerId&&(l.minScale>0||l.maxScale>0))return!0;return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");const e=this.layer;this.addHandles(h.watch((()=>e.currentVariableId),(()=>this._constructLegendElementsForVoxellayer())),"voxel-current-variable"),this.addHandles(h.watch((()=>e.getVariableStyles()),(()=>this._constructLegendElementsForVoxellayer())),"voxel-style-watcher");const t=e.getVariableStyle(null),l=[];if(t)if(t.uniqueValues?.length){const e=[];t.uniqueValues.forEach((t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new W({color:t.color,outline:null})})})),e.length&&l.push({type:"symbol-table",title:t.label,infos:e})}else if(t.transferFunction){const{colorStops:e,stretchRange:s}=t.transferFunction,i=e.toArray().reverse(),r=s.map(((e,t)=>`${0===t?N.specialCharsLessThan:N.specialCharsGreaterThan} ${q.formatNumberLabel(e)}`)).reverse(),n=i.map((e=>({color:e.color,value:null,label:null})));n[0].label=r[0],n[n.length-1].label=r[1],l.push({type:"color-ramp",title:t.label,infos:n,preview:O.renderColorRampPreviewHTML(i.map((e=>e.color)),{ariaLabel:await xe("previewColorRampAriaLabel")})})}const s=e.opacity,i=l.reduce(((e,t)=>[...e,...this._getAllInfos(t)]),[]).filter((e=>!!e?.symbol)).map((e=>this._getSymbolPreview(e,s)));await Promise.allSettled(i),this.legendElements=l,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this.addHandles(h.watch((()=>{const{layer:e}=this;return e&&"activeLayer"in e&&e.activeLayer}),(()=>this._constructLegendElementsForWMTSlayer())),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some((l=>e.styleId===l.id&&(t=l.legendUrl,!0))),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this.removeHandles("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this.addHandles(h.watch((()=>{const{layer:e}=this;return e&&"sublayers"in e&&e.sublayers}),(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const l=[];this.addHandles(e.on("change",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher");const s=e.toArray();for(const i of s){const e=h.watch((()=>[i.title,i.visible,i.legendEnabled]),(()=>this._constructLegendElementsForWMSSublayers()));if(this.addHandles(e,"wms-sublayers-watcher"),!this.respectLayerVisibility||i.visible&&i.legendEnabled){const e=await this._generateSymbolTableElementForWMSSublayer(i,t);e?.infos.length&&l.unshift(e)}}return l}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const l=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter((e=>e));return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let l=e.legendUrl;if(!l)return;const s={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};t&&(l=f.addQueryParameters(l,t));let i=null;const n=e.layer?.opacity;try{i=(await r(l,{responseType:"image"})).data,i&&(i.style.opacity=n)}catch{}return s.infos.push({src:l,preview:i,opacity:n}),s}_getLegendLayers(e,t){const l=Oe&&Oe[e];return l?Promise.resolve(l):this._legendRequest(t).then((t=>{const l=t.layers;return Oe[e]=l,l}))}_legendRequest(e){const t=this.layer;let l={f:"json",dynamicLayers:e};if(Ie(t)){const e=t.exportImageServiceParameters.rasterFunction;if(e&&(l.renderingRule=JSON.stringify(e.functionDefinition?.toJSON()||e.toJSON())),t.bandIds&&(l.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:e,viewId:s,customParameters:i}=t;l={raster:e,viewId:s,...l,...i}}}let s=t.url.replace(/(\/)+$/,"");if("version"in t&&+t.version>=10.01){const e=s.indexOf("?");e>-1?s=s.substring(0,e)+"/legend"+s.substring(e):s+="/legend"}else{const e=s.toLowerCase().indexOf("/rest/"),t=s.substring(0,e)+s.substring(e+5,s.length);s=J+"?soapUrl="+encodeURI(t)+"&returnbytes=true"}return r(s,{query:l}).then((e=>e.data))}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;this.addHandles(h.watch((()=>e.sublayers),(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){d.getLogger(this).warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let l=[];this.addHandles(e.on("change",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");const s=e.toArray();for(const i of s){const e=h.watch((()=>["renderer"in i&&i.renderer,i.opacity,i.title,i.visible]),(()=>this._constructLegendElementsForBuildingSceneLayer()));if(this.addHandles(e,"sublayers-watcher"),!this.respectLayerVisibility||i.visible){const e=null!=i?.opacity?i.opacity:null,s=null!=e?e*t:t;if("building-group"===i.type){const e={type:"symbol-table",title:i.title,infos:[]},t=await this._generateLegendElementsForBuildingSublayers(i.sublayers,s);e.infos.push(...t),l=[e,...l]}else if(i.renderer){l=[...await this._getRendererLegendElements(i.renderer,{title:i.title,opacity:s,sublayer:i}),...l]}}}return l.filter((e=>!!e&&(!("infos"in e)||!e.infos||e.infos.length>0)))}async _constructLegendElementsForSublayers(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;if(Ce(e)||Ee(e)||_e(e)){this.addHandles(h.watch((()=>e.sublayers),(()=>this._constructLegendElementsForSublayers)),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){d.getLogger(this).warn("Request to server for legend has failed!",t)}}}async _generateLegendElementsForSublayers(e,t,l){const s=this.layer;let i=[];this.addHandles(e.on("change",(()=>this._constructLegendElementsForSublayers())),"sublayers-watcher");let r=e.toArray();!l&&this.sublayerIds&&this.sublayerIds.length&&(r=_e(s)?this.sublayerIds.map((e=>s.findSublayerForSubtypeCode(e))).filter(o.isSome):this.sublayerIds.map((e=>s.findSublayerById(e))).filter(o.isSome));for(const n of r){const e=h.watch((()=>[n.renderer,n.opacity,n.title,n.visible,n.legendEnabled]),(()=>this._constructLegendElementsForSublayers()));if(this.addHandles(e,"sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled&&this._isSublayerInScale(n)){const e=null!=n?.opacity?n.opacity:null,s=null!=e?e*t:t,r=!De(n)||n.originIdOf("renderer")>w.OriginId.SERVICE&&!n.sublayers;if(n.renderer&&r){await n.load();i=[...await this._getRendererLegendElements(n.renderer,{title:n.title,opacity:s,sublayer:n}),...i]}else if(De(n)){const e=await this._generateSymbolTableElementForSublayer(n,s,l);e&&i.unshift(e)}}}return i.filter((e=>!!e&&(!("infos"in e)||!e.infos||e.infos.length>0)))}async _generateSymbolTableElementForSublayer(e,t,l){if(!l){l=new Map;const t=this.layer,s=e.source;let i=null;if(!(!s||"map-layer"===s.type&&s.mapLayerId===e.id&&(!s.gdbVersion||s.gdbVersion===("gdbVersion"in t&&t.gdbVersion)))||e.originIdOf("renderer")>w.OriginId.SERVICE||e.originIdOf("labelingInfo")>w.OriginId.SERVICE||e.originIdOf("labelsVisible")>w.OriginId.SERVICE){const e=new C.ExportImageParameters({layer:this.layer});i=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}const r=i||`${t.uid}-default`;(await this._getLegendLayers(r,i)).forEach((e=>l.set(e.layerId,e)))}const s=l.get(e.id);if((!s||s?.subLayerIds&&s.defaultVisibility)&&e.sublayers){const s=await this._generateLegendElementsForSublayers(e.sublayers,t,l);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendLayer(s,e,t)}_generateSymbolTableElementForLegendLayer(e,t,l){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const s=t?.renderer;let i=t?.title||e.layerName;if(s&&(!t||t?.originIdOf("renderer")>w.OriginId.SERVICE)){const e=t?.title||this._getRendererTitle(s,t);e&&(i&&"string"!=typeof e&&"title"in e&&(e.title=i),i=e)}const r={type:"symbol-table",title:i,legendType:e.legendType||null,infos:[]},n=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach((t=>{const s={type:"symbol-table",title:t.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(n.filter((e=>e.groupId===t.id)),e.layerId,l)};s.infos?.length>0&&r.infos.push(s)})):r.infos=this._generateSymbolTableElementInfosForLegendLayer(n,e.layerId,l),r.infos.length>0?r:null}_generateSymbolTableElementInfosForLegendLayer(e,t,l){return e.map((e=>{let s=e.url;if(e.imageData&&e.imageData.length>0)s=`data:image/png;base64,${e.imageData}`;else{if(0===s.indexOf("http"))return null;s=i.addTokenParameter(`${this.layer.url}/${t}/images/${s}`)}return{label:e.label,src:s,opacity:l??this.opacity,width:e.width,height:e.height}})).filter(o.isSome)}_isSublayerInScale(e){const t=e.minScale||0,l=e.maxScale||0;return!(t>0&&t<this.scale||l>this.scale)}_isLegendLayerInScale(e,t){const l=t||this.layer;let s=null,i=null,r=!0;return!l.minScale&&0!==l.minScale||!l.maxScale&&0!==l.maxScale?(0===e.minScale&&l.tileInfo&&(s=l.tileInfo.lods[0].scale),0===e.maxScale&&l.tileInfo&&(i=l.tileInfo.lods[l.tileInfo.lods.length-1].scale)):(s=Math.min(l.minScale,e.minScale)||l.minScale||e.minScale,i=Math.max(l.maxScale,e.maxScale)),(s>0&&s<this.scale||i>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&+this.layer.version<10.1||0===e.length)return e;const l=t.renderer,s=e.some((e=>e.values));let i=0,r=null;return s&&e.some(((e,t)=>(e.values||(i=t,r=e,r.label||(r.label="others")),null!=r))),l?"unique-value"===l.type?r&&(e.splice(i,1),e.push(r)):"class-breaks"===l.type&&(r&&e.splice(i,1),e.reverse(),r&&e.push(r)):r&&(e.splice(i,1),e.push(r)),e}async _getRendererLegendElements(e,t={}){if(!be(e,this.view))return d.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(de(e))return this._constructPointCloudRendererLegendElements(e,t);if(fe(e))return this._constructDotDensityRendererLegendElements(e);const l=await this._loadRenderer(e);return ge(l)?this._constructPieChartRendererLegendElements(l):this._constructRendererLegendElements(l,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return"binning"===e.type?t=e.renderer:"cluster"===e.type&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}async _constructPointCloudRendererLegendElements(e,t={}){const l=t.title,s=[];let i=null,r=null;if(he(e))i={type:"symbol-table",title:l||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((e=>{i.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(ee,e.color)})}));else if(pe(e)){const t=e.stops;let s=null;if(t?.length&&(1===t.length&&(s=t[0].color),!s)){const e=t[0].value,l=t[t.length-1].value;if(null!=e&&null!=l){const i=e+(l-e)/2;s=U.getColorFromPointCloudStops(i,t)}}i={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(ee,s||ee.color)}]};const n=U.getRampStopsForPointCloud(e.stops??[])??[];r={type:"color-ramp",title:l||this._getPointCloudRendererTitle(e),infos:n,preview:O.renderColorRampPreviewHTML(n.map((e=>e.color)),{ariaLabel:await xe("previewColorRampAriaLabel")})}}else me(e)&&(i={type:"symbol-table",title:l||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach((e=>{i.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(ee,e.color)})})));i&&i.infos.length&&s.push(i),r&&r.infos.length&&s.push(r);const n=s.reduce(((e,t)=>[...e,...t.infos??[]]),[]).filter((e=>!!e.symbol)).map((t=>this._getSymbolPreview(t,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}})));return await Promise.allSettled(n),s}async _getElementInfoForDotDensity(e,t){const{color:l,label:s,valueExpressionTitle:i}=t,{backgroundColor:r,outline:n,dotSize:a}=e,o=this.effectList,u=o?.effects.map((e=>e.toJSON())),c=L.effectFunctionsFromJSON(u),d=await xe("previewTemplateAriaLabel",s||i),y=a+"-"+l+"-"+r+"-"+(n&&JSON.stringify(n.toJSON()))+"-"+c,h=this._dotDensityUrlCache,p=h.has(y)?h.get(y):O.renderDotDensityPreviewHTML(e,l,{ariaLabel:d});h.set(y,p);const m={shape:{type:"image",x:0,y:0,width:p.width,height:p.height,src:p.src},fill:null,stroke:null,offset:[0,0]},f=P.renderSymbol([[m]],[p.width,p.height],{effectView:this.effectList,ariaLabel:d});return{opacity:1,src:p.src,preview:f,width:p.width,height:p.height}}async _constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),l=e.legendOptions?.unit,s={type:"symbol-table",title:{value:t&&Math.round(t),unit:l||""},infos:[]};for(const i of e.attributes){const t=await this._getElementInfoForDotDensity(e,i);t.label=i.label||i.valueExpressionTitle||i.field,s.infos.push(t)}return[s]}async _constructPieChartRendererLegendElements(e){const t=this.layer.opacity,l=[];let s=null;const i=e.outline;e.attributes.forEach((e=>{const t=new $({color:e.color,outline:i}),s=e.label||e.valueExpressionTitle||e.field;l.push({label:s,symbol:t})}));const r=l.length?[...l]:[];if(e.othersCategory?.color&&0!==e.othersCategory?.threshold){const t=new $({color:e.othersCategory.color,outline:i});s=e.othersCategory.label||"Other",l.push({label:s,symbol:t})}if(e.defaultColor?.a){const t=new $({color:e.defaultColor,outline:i});l.push({label:e.defaultLabel,symbol:t})}const n=await this._getVisualVariableLegendElements(e,this.layer)||[];if(l.length){n.unshift({type:"symbol-table",title:null,infos:l});const t=r.filter((e=>e.label!==s)).map((e=>e.symbol.color)).filter(Boolean),a=O.renderPieChartPreviewHTML(t,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:i,ariaLabel:await xe("previewPieChartAriaLabel")});n.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:l,preview:a})}const a=n.reduce(((e,t)=>[...e,...this._getAllInfos(t)]),[]).filter((e=>!!e?.symbol&&!e?.preview)).map((e=>this._getSymbolPreview(e,t,{effectList:this.effectList})));return await Promise.allSettled(a),n}async _constructRendererLegendElements(e,t={}){const{title:l,sublayer:s}=t,i=s||this.layer;this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const r=await this._getVisualVariableLegendElements(e,i)||[],n={type:"symbol-table",title:l||this._getRendererTitle(e,i),infos:[]};let a=null,o=!1;const u=new Set;if(le(e)&&!this._hasSizeRamp){const t=await N.getSymbolForFlowRenderer(e);n.infos.push({label:null,symbol:t})}else if(Te(e)){let t=l;const s=ze(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",i=r.findIndex((e=>"color-ramp"===e.type)),n=-1!==i?r.splice(i,1)[0]:null,a=r.findIndex((e=>"size-ramp"===e.type)),o=-1!==a?r.splice(a,1)[0]:null,u=[];n&&(t=n.title,u.push(n)),o&&(t=o.title,u.push(o)),u.length>0&&r.push({type:s,title:t,infos:u})}else if(ce(e)){const t=k.getHeatmapRampStops(e);r.push({type:"heatmap-ramp",title:l||this._getRendererTitle(e,i),infos:t,preview:O.renderColorRampPreviewHTML(t.map((e=>e.color)),{effectList:this.effectList,ariaLabel:await xe("previewColorRampAriaLabel")})})}else if(ue(e)){const t=e&&e.authoringInfo;if(t&&"relationship"===t.type){const{numClasses:l,field1:s,field2:a}=t,o=t.focus;if(l&&s&&a){const t=[s,a];let c=B.getRotationAngleForFocus(o)||0;for(const e of t){const{field:t,normalizationField:l,label:s}=e,r=s||{field:this._getFieldAlias(t,i),normField:l&&this._getFieldAlias(l,i)},a=Pe.clone();a.angle=c,n.infos.push({label:r,symbol:a}),u.add(a),c+=90}const d=B.getRelationshipRampElement({focus:o,numClasses:l,infos:e.uniqueValueInfos??[]});r.unshift(d)}}else if(Ie(this.layer)||Re(this.layer))e.uniqueValueInfos?.forEach((e=>{e.symbol&&n.infos.push({label:e.label||e.value,value:e.value,symbol:e.symbol})}));else{const{field:t,field2:s,field3:r,fieldDelimiter:a,valueExpression:u,defaultSymbol:c}=e,d=!(!t&&!u||!s&&!r),y=[];if(e.uniqueValueGroups?.forEach((e=>{const l={type:"symbol-table",title:e.heading,infos:[]};e.classes?.forEach((e=>{const{symbol:n,values:o}=e;if(n){const c=[],y=[];for(const e of o??[]){const{value:l,value2:n,value3:o}=e,h=[],p=[];(t||u)&&(h.push(l),p.push(this._getDomainName(t,l,i))),s&&(h.push(n),p.push(this._getDomainName(s,n,i))),r&&(h.push(o),p.push(this._getDomainName(r,o,i))),c.push(d?h.join(a||""):h[0]),y.push(p.join(" - "))}const h=c.join(", ");let p=e.label;if(!p){const e=y.filter(Boolean);p=e.length?e.join(", "):h}l.infos.push({label:p,value:h,symbol:n})}})),l.infos.length&&y.push(l)})),y.length){const t=y[0];1===y.length&&"title"in t&&!t.title?n.infos.push(...t.infos??[]):(c&&(y.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:c}]}),o=!0),n.infos.push(...y)),l||e.legendOptions?.title||e.valueExpressionTitle||(n.title=null)}}e.defaultSymbol&&!o&&(n.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),o=!0)}else if(oe(e)){a=this._isUnclassedRenderer(e);(!a||!this._hasSizeRamp)&&(e.classBreakInfos.forEach((e=>{e.symbol&&n.infos.unshift({label:e.label||(a?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),a&&(n.title=null),this._updateInfosforClassedSizeRenderer(e,n.infos)),e.defaultSymbol&&!a&&(n.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),o=!0)}else if(re(e))if(Re(this.layer)||Fe(this.layer)){const t=await this._constructTileImageryStretchRendererElements(e);Ve(t)?r.push(t):n.infos=t}else{const t=this.layer;let l,s;if(e.statistics?.length){const t=e.statistics[0];N.isRasterBandStatistics(t)?(l=t.min,s=t.max):[l,s]=t}let i=[],a=t.serviceRasterInfo;if(t.rasterFunction)try{a=await t.generateRasterInfo(t.rasterFunction)}catch{}const o=R.getPixelValueRange(a.pixelType);if(1===a.bandCount){const i=t.bandIds?.[0]||0;l=null!=l?l:a.statistics?a.statistics[i].min:o[0],s=null!=s?s:a.statistics?a.statistics[i].max:o[1],l||s?r.push(await this._getStretchLegendElements(e,{min:l,max:s})):this._getServerSideLegend()}else if(t.bandIds&&1===t.bandIds.length)l=null!=l?l:a.statistics?a.statistics[t.bandIds[0]].min:o[0],s=null!=s?s:a.statistics?a.statistics[t.bandIds[0]].max:o[1],l||s?r.push(await this._getStretchLegendElements(e,{min:l,max:s})):this._getServerSideLegend();else if(a.bandCount>=3){const{bandInfos:e}=a,{bandIds:l}=t;e.length>=a.bandCount?3===l?.length?(i=l.map((t=>e[t].name)),n.infos=this._createSymbolTableElementMultiBand(i)):"lerc"===t.format?(i=[0,1,2].map((t=>e[t].name)),n.infos=this._createSymbolTableElementMultiBand(i)):this._getServerSideLegend():"lerc"===t.format?(i=["band1","band2","band3"],n.infos=this._createSymbolTableElementMultiBand(i)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(ie(e))e.colormapInfos.forEach((e=>{n.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(te,e.color)})}));else if(ae(e)){let l=e.symbol;switch(t.geometryType){case"point":l="pointSymbol"in i?i.pointSymbol:null;break;case"polyline":l="lineSymbol"in i?i.lineSymbol:null;break;case"polygon":l="polygonSymbol"in i?i.polygonSymbol:null}const s=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&s&&n.infos.push({label:e.label,symbol:l})}else if(se(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),n.title=e.attributeField;const t=e.getClassBreakInfos();t?.length?t.forEach((e=>{n.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):n.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else ne(e)&&r.push(await this._getStretchLegendElements(e,{min:0,max:255}));const c=e.defaultSymbol;!c||o||ae(e)||a&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||r.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:c}]}),n.infos.length&&r.unshift(n);const d=null==t.opacity?this.opacity:t.opacity,y=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),h=Ie(this.layer)||Re(this.layer),p=r.reduce(((e,t)=>[...e,...this._getAllInfos(t)]),[]).filter((e=>!!e?.symbol)).filter((e=>{if("cim"===e.symbol.type){const{minScale:t,maxScale:l}=e.symbol.data;if(t&&t<this.scale||l&&l>this.scale)return!1}return!0})).map((e=>this._getSymbolPreview(e,d,{isDefault:e.symbol===c,applyScaleDrivenSize:!u.has(e.symbol),symbolConfig:{isTall:y,isSquareFill:h},effectList:u.has(e.symbol)?null:this.effectList})));return e=null,await Promise.allSettled(p),r}_getServerSideLegend(){setTimeout((()=>this.buildLegendElementsForTools()),0)}_getAllInfos(e){const t=e?.infos;return t?t.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]):[e]}async _constructTileImageryStretchRendererElements(e){const t=this.layer,l=t.symbolizer.rasterInfo??t.raster.rasterInfo;let s,i;const r=e?.statistics?.length?e.statistics:l?.statistics;if(r){const e=r[0];N.isRasterBandStatistics(e)?(s=e.min,i=e.max):[s,i]=e}else{const e=R.getPixelValueRange(l.pixelType);s=e[0],i=e[1]}if(t.hasStandardTime()&&(s=t.getStandardTimeValue(s),i=t.getStandardTimeValue(i)),1===l.bandCount||1===t.bandIds?.length)return this._getStretchLegendElements(e,{min:s,max:i});const n=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(l.bandCount,3)).keys())).map((e=>l.bandInfos[e].name));return n.length<3?n.push(n[1]):n.length>3&&n.splice(3),this._createSymbolTableElementMultiBand(n)}async _getStretchLegendElements(e,t){const l=e.colorRamp,s=U.getStrectchRampStops(l,t);return{type:"stretch-ramp",title:"",infos:s,preview:O.renderColorRampPreviewHTML(s.map((e=>e.color)),{ariaLabel:await xe("previewColorRampAriaLabel")})}}_getClusterSymbol(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,l=t&&"symbol"in t&&t.renderer;return l&&!0!==l?.authoringInfo?.isAutoGenerated?null:t&&"symbol"in t?t.symbol:null}async _getSizeLegendElement(e,t,l,s){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await H.getRampStops(l,t,await N.getMedianColor(l),this.scale,this.view,s,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){const t=[],l=["red","green","blue"];return e.forEach(((e,s)=>{t.push({label:{colorName:l[s],bandName:e},src:N.rgbImgSource[s],opacity:this.opacity??1})})),t}_updateInfosforClassedSizeRenderer(e,t){const l=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,s=e.classBreakInfos.some((e=>M.isVolumetricSymbol(e.symbol)));if(l&&s){const l=H.realWorldMaxSize,s=H.realWorldMinSize,i=e.classBreakInfos.length,r=(l-s)/(i>1?i-1:i);t.forEach(((e,t)=>{e.size=l-r*t}))}}_isTallSymbol(e){let t=!1,l=!1;if(e)for(let s=0;s<e.length&&(!t||!l);s++){const i=e[s];"size"===i.type&&("height"===i.axis&&(t=!0),"width-and-depth"===i.axis&&(l=!0))}return t&&l}async _getSymbolPreview(t,l,s){let i=!s?.isDefault&&null==t.size&&this._hasSizeRamp?p.px2pt(x.SymbolSizeDefaults.size):t.size;if(this._scaleDrivenSizeVariable&&s?.applyScaleDrivenSize){const{getSize:l}=await new Promise(((t,l)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,l)));i=l(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null})}const r=!s?.isDefault&&this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!s?.applyScaleDrivenSize);return O.renderPreviewHTML(t.symbol,{size:i,opacity:l,scale:!1,symbolConfig:s?.symbolConfig,effectView:s?.effectList,style:"legend",cimOptions:{allowScalingUp:r,viewParams:this.isScaleDriven?{viewingMode:"2d"===this.view?.type?"map":this.view?.viewingMode,scale:this.view?.scale}:null},ariaLabel:t.label&&"string"!=typeof t.label?null:await xe("previewTemplateAriaLabel",t.label)}).then((e=>(t.preview=e,t))).catch((()=>(t.preview=null,t)))}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;const t="renderer"in this.layer?this.layer.renderer:null,l=e.renderer?.clone()||t?.clone(),s=A.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view);if(s&&null!=l&&"visualVariables"in l){const t=l.visualVariables?.some((e=>"size"===e.type&&"outline"!==e.target&&!X.test(e.valueExpression)));if(!t){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:t,clusterMaxSize:l}=e;s.legendOptions=new T({showLegend:t!==l})}const t=l.visualVariables||[];l.visualVariables=t.concat([s]),this._hasClusterSizeVariable=!0}}return l}async _loadRenderer(e){const t=[],l=e.clone(),s=await N.getMedianColor(l);if(oe(l)||ue(l)){const e=(l.classBreakInfos||l.uniqueValueInfos).map((e=>this._fetchSymbol(e.symbol,s).then((t=>{e.symbol=t})).catch((()=>{e.symbol=null}))));Array.prototype.push.apply(t,e)}return t.push(this._fetchSymbol(l.symbol||l.defaultSymbol,l.defaultSymbol?null:s).then((e=>{this._applySymbolToRenderer(l,e,ae(l))})).catch((()=>{this._applySymbolToRenderer(l,null,ae(l))}))),await Promise.allSettled(t),l}_applySymbolToRenderer(e,t,l){l?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if("web-style"===e.type){const l=this._webStyleSymbolCache;try{const s=await("2d"===this.view.type?e.fetchCIMSymbol({cache:l}):e.fetchSymbol({cache:l}));return this._getAppliedCloneSymbol(s,t)}catch{throw d.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const s=e.clone(),i=t&&t.toRgba();return s.type.includes("3d")?this._applyColorTo3dSymbol(s,i):"cim"===s.type?D.applyCIMSymbolColor(s,t):s.color&&(s.color=new l(i||s.color)),s}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach((e=>{e&&(e.material||(e.material={}),e.material.color=new l(t))}))}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||"vector-field"===e.type)return null;const l=e.visualVariables,s=[],i=[],r=[];for(const o of l)"color"===o.type?s.push(o):"size"===o.type?i.push(o):"opacity"===o.type&&r.push(o);const n=[...s,...i,...r];let a,u;if(0===s.length&&oe(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];a=t&&t.symbol}if(0===s.length&&ae(e)&&(a=e.symbol),a)if(a.type.includes("3d")){const e=a.symbolLayers.at(0);"water"===e.type?null!=e.color&&(u=e.color):null!=e.material?.color&&(u=e.material.color)}else a.url||(u=a.color);const c=this.effectList;return(await Promise.all(n.map((async l=>{if(!l.legendOptions||!1!==l.legendOptions.showLegend){const s=le(e)?l.field:this._getRampTitle(l,t);let i=null;const r=this._getDateFormatOptions(t,l);if("color"===l.type){const e=await U.getRampStops(l,null,r)??[];i={type:"color-ramp",title:s,infos:e,preview:O.renderColorRampPreviewHTML(e.map((e=>e.color)),{effectList:c,ariaLabel:await xe("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=e.length>0)}else if("size"===l.type&&"outline"!==l.target)X.test(l.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=l):(i=await this._getSizeLegendElement(s,l,e,r),this._hasSizeRamp||(this._hasSizeRamp=!(null==i.infos||!i.infos.length)));else if("opacity"===l.type){const e=await U.getRampStops(l,u,r)??[];i={type:"opacity-ramp",title:s,infos:e,preview:O.renderColorRampPreviewHTML(e.map((e=>e.color)),{effectList:c,ariaLabel:await xe("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=e.length>0)}return i&&i.infos?i:null}})))).filter(o.isSome)}_getFieldInfo(e,t){if(!t.field)return null;if("featureReduction"in e)switch(e.featureReduction?.type){case"cluster":case"binning":{const l=e.featureReduction.fields.find((({name:e})=>e.toLowerCase()===t.field.toLowerCase()));return l&&"getField"in e?e.getField(l.onStatisticField):null}}return"getField"in e?e.getField?.(t.field):null}_getDateFormat(e,t){const l="popupTemplate"in e?e.popupTemplate?.fieldInfos:null;if(l?.length&&t)return l.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))?.format?.dateFormat}_getDateFormatOptions(e,t){const l=this._getFieldInfo(e,t);if(!l||!z.isAnyDateField(l)&&!E.isTimeOnlyField(l))return null;let s=this._getDateFormat(e,l.name);if(!s&&"date"===l.type){let e=0,l=0;t.stops?(e=t.stops?.at(0)?.value??e,l=t.stops?.at(-1)?.value??l):"minDataValue"in t&&"maxDataValue"in t&&(e=t.minDataValue??e,l=t.maxDataValue??l),s=l-e>2*m.millisecondsPerTimeUnit.days?"short-date":"short-date-short-time"}return{fieldType:l.type,format:s,timeZoneOptions:{layerTimeZone:"preferredTimeZone"in e?e.preferredTimeZone:null,viewTimeZone:this.view.timeZone,datesInUnknownTimezone:"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone}}}_getDomainName(e,t,l){if(e&&"function"!=typeof e){const s="getField"in l&&l.getField?.(e),i=s&&"getFieldDomain"in l&&l.getFieldDomain?l.getFieldDomain(s.name):null;return"coded-value"===i?.type?i.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,l=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,s="popupTemplate"in e&&e.popupTemplate,i=s&&s.fieldInfos;if(i)for(const t of i)if(t.fieldName===l)return"cluster_count"===l?t.label||{showCount:!0}:t.label}return{showCount:!0}}_getRampTitle(e,t){let l=e.field,s=e.normalizationField,i=!1,r=!1,n=!1,a=null;l="function"==typeof l?null:l,s="function"==typeof s?null:s;const o=e.legendOptions?.title;if(null!=o)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo?.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const l=e[t];if("color"===l.type){if("ratio"===l.style){i=!0;break}if("percent"===l.style){r=!0;break}if("percent-of-total"===l.style){n=!0;break}}}}a={field:l&&this._getFieldAlias(l,t),normField:s&&this._getFieldAlias(s,t),ratio:i,ratioPercent:r,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const l=e;if(l.legendOptions?.title)return l.legendOptions.title;if(l.valueExpressionTitle)return l.valueExpressionTitle;let s=l.field,i=null,r=null;if(oe(l)&&(i=l.normalizationField,r="percent-of-total"===l.normalizationType),s="function"==typeof s?null:s,i="function"==typeof i?null:i,ue(l)){const{field2:e,field3:i,fieldDelimiter:r}=l;let n=s&&this._getFieldAlias(s,t);return e&&(n=`<${n}>${r}<${this._getFieldAlias(e,t)}>`,i&&(n=`${n}${r}<${this._getFieldAlias(i,t)}>`)),n}let n=null;return(s||i)&&(n={field:s&&this._getFieldAlias(s,t),normField:i&&this._getFieldAlias(i,t),normByPct:r}),n}_getFieldAlias(e,t){const l="popupTemplate"in t?t.popupTemplate:null,s=l?.fieldInfos;let i;s&&s.some((t=>e===t.fieldName&&(i=t,!0)));let r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));let n=null;const a="featureReduction"in t&&t.featureReduction;a&&(!i&&"popupTemplate"in a&&a.popupTemplate?.fieldInfos&&a.popupTemplate.fieldInfos.some((t=>e?.toLowerCase()===t.fieldName?.toLowerCase()&&(i=t,!0))),"fields"in a&&a.fields&&(n=a.fields.find((t=>t.name?.toLowerCase()===e?.toLowerCase()))));const o=i||r||n;let u=null;return o&&(u=i?.label||r?.alias||n?.alias||"name"in o&&o.name||"fieldName"in o&&o.fieldName||null),u}_isUnclassedRenderer(e){const t=e.visualVariables;let l=!1;return oe(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(l=e.field?t.some((t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField))):!!t.length),l}};t.__decorate([g.property()],Me.prototype,"children",void 0),t.__decorate([g.property({readOnly:!0})],Me.prototype,"effectList",null),t.__decorate([g.property()],Me.prototype,"layerView",void 0),t.__decorate([g.property()],Me.prototype,"layer",void 0),t.__decorate([g.property()],Me.prototype,"legendElements",void 0),t.__decorate([g.property({readOnly:!0})],Me.prototype,"opacity",null),t.__decorate([g.property()],Me.prototype,"parent",void 0),t.__decorate([g.property({readOnly:!0,dependsOn:[]})],Me.prototype,"ready",null),t.__decorate([g.property()],Me.prototype,"hideLayersNotInCurrentView",void 0),t.__decorate([g.property()],Me.prototype,"keepCacheOnDestroy",void 0),t.__decorate([g.property()],Me.prototype,"respectLayerVisibility",void 0),t.__decorate([g.property({readOnly:!0})],Me.prototype,"scale",null),t.__decorate([g.property()],Me.prototype,"sublayerIds",void 0),t.__decorate([g.property({readOnly:!0})],Me.prototype,"isScaleDriven",null),t.__decorate([g.property()],Me.prototype,"title",void 0),t.__decorate([g.property({readOnly:!0,dependsOn:["ready"],value:0})],Me.prototype,"version",null),t.__decorate([g.property()],Me.prototype,"view",void 0),Me=t.__decorate([_.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],Me);return Me}));
