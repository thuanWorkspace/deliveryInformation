/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../core/a11yUtils","../core/deprecate","../core/Logger","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../layers/support/rasterDatasets/RasterFactory","./Widget","./OrientedImageryViewer/arcUtils","./OrientedImageryViewer/constants","./OrientedImageryViewer/OrientedImageryViewerViewModel","./support/componentsUtils","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,i,s,a,o,r,n,l,c,d,h,g,m,p,v,u,y,b,_){"use strict";let C=class extends g{constructor(e,t){super(e,t),this.dockEnabled=!1,this.galleryOpened=!1,this.imageEnhancementToolActive=!1,this.navigationToolActive=!1,this.viewModel=new v,this.messagesCommon=null,this.visibleElements={...p.defaultVisibleElements},this._navigationTool=null,this._actionItems=new Map,this._galleryController=new AbortController,this._galleryObserver=new IntersectionObserver(this._lazyLoadImage.bind(this)),this._loadImageFromGallery=this._loadImageFromGallery.bind(this),this._registerGalleryItem=this._registerGalleryItem.bind(this),this._unregisterGalleryItem=this._unregisterGalleryItem.bind(this),this._renderViewerContainer=this._renderViewerContainer.bind(this),this._renderViewer=this._renderViewer.bind(this)}initialize(){this.addHandles([o.watch((()=>[this.viewModel?.selectedFeatureAngle,this._navigationTool]),(([e,t])=>{!this.viewModel.updating&&t&&this._updateNavigationTool(t)}),o.initial),o.watch((()=>this.currentCoverageVisible),(e=>this._onCurrentCoverageVisibilityChange(e))),o.watch((()=>this.isAdditionalCoverageVisible),(e=>this._onAdditionalCoverageVisibilityChange(e))),o.watch((()=>this.isAdditionalPointSourcesVisible),(e=>this._onAdditionalCameraLocationsVisibility(e)))])}loadDependencies(){return u.loadCalciteComponents({tooltip:()=>new Promise(((t,i)=>e(["../chunks/calcite-tooltip"],t,i))),action:()=>new Promise(((t,i)=>e(["../chunks/calcite-action"],t,i))),"action-group":()=>new Promise(((t,i)=>e(["../chunks/calcite-action-group"],t,i))),"action-bar":()=>new Promise(((t,i)=>e(["../chunks/calcite-action-bar"],t,i))),label:()=>new Promise(((t,i)=>e(["../chunks/calcite-label"],t,i))),panel:()=>new Promise(((t,i)=>e(["../chunks/calcite-panel"],t,i))),slider:()=>new Promise(((t,i)=>e(["../chunks/calcite-slider"],t,i)))})}destroy(){this._galleryController.abort(),this._galleryObserver.disconnect()}get activeLayer(){return s.deprecatedProperty(a.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer}set activeLayer(e){s.deprecatedProperty(a.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer=e}get currentCoverageVisible(){return this.viewModel.currentCoverageVisible}set currentCoverageVisible(e){this.viewModel.currentCoverageVisible=e}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get isDocked(){return s.deprecatedProperty(a.getLogger(this),"isDocked",{replacement:"dockEnabled"}),this.dockEnabled}set isDocked(e){s.deprecatedProperty(a.getLogger(this),"isDocked",{replacement:"dockEnabled"}),this.dockEnabled=e}get imageGalleryEnabled(){return this.viewModel.imageGalleryEnabled}get isAdditionalCoverageVisible(){return this.viewModel.isAdditionalCoverageVisible}set isAdditionalCoverageVisible(e){this.viewModel.isAdditionalCoverageVisible=e}get isAdditionalPointSourcesVisible(){return this.viewModel.isAdditionalPointSourcesVisible}set isAdditionalPointSourcesVisible(e){this.viewModel.isAdditionalPointSourcesVisible=e}get mapImageConversionToolState(){return this.viewModel.mapImageConversionToolState}set mapImageConversionToolState(e){this.viewModel.mapImageConversionToolState=e}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get referencePoint(){return this.viewModel.referencePoint??null}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...p.defaultVisibleElements,...e}}async _getThumbnailPixelBlockInternal(e,t){const{level:i,offset:s,size:o}=this._getMaxLevelRasterParameters(e);try{const{pixelBlock:a}=await e.fetchRawPixels(i,s,o,t);return a}catch(r){a.getLogger(this).warn("failed to create canvas with pixeldata",r)}return null}_getMaxLevelRasterParameters(e){const{storageInfo:t,width:i,height:s}=e.rasterInfo,{maximumPyramidLevel:a,pyramidScalingFactor:o}=t,r=o??2;return{level:a,offset:{x:0,y:0},size:{width:Math.ceil(i/r**a),height:Math.ceil(s/r**a)}}}async _getThumbnailPixelBlock(e){const{signal:t}=this._galleryController;try{const i=await h.open({url:e,signal:t});return i?await this._getThumbnailPixelBlockInternal(i,{signal:t}):null}catch(i){a.getLogger(this).error("failed to create thumbnail",i)}return null}_handleBrightnessChange(e){this.viewModel.brightness=e.target.value??0}_handleContrastChange(e){this.viewModel.contrast=e.target.value??0}_handleSharpnessChange(e){this.viewModel.sharpness=e.target.value??0}_lazyLoadImage(e,t){e.forEach((async e=>{if(e.isIntersecting){const i=e.target,s=i.getAttribute("data-src");if(!s)return;const a=await this._getThumbnailPixelBlock(s);if(!a)return;i.width=a.width,i.height=a.height;const o=i.getContext("2d");if(!o)return;const r=o.createImageData(i.width,i.height);r.data.set(a.getAsRGBA()),o.putImageData(r,0,0),t.unobserve(i)}}))}_loadImageFromGallery(e){const{target:t}=e;if(!t)return;const i=t.getAttribute("data-objectid");i&&this.viewModel.selectedFeature?.attributes.objectId!==Number(i)&&(this.viewModel.selectedFeature=this.viewModel.features?.find((({attributes:e})=>e.objectId===Number(i))))}_onAdditionalCoverageVisibilityChange(e){this.viewModel.setAdditionalCoverageVisibility(e)}_onAdditionalCameraLocationsVisibility(e){this.viewModel.setAdditionalCameraLocationsVisibility(e)}_onCurrentCoverageVisibilityChange(e){this.viewModel.setCurrentCoverageVisibility(e)}_registerGalleryItem(e){this._galleryObserver.observe(e)}_resetImageTools(){this.viewModel.sharpness=this.viewModel.brightness=this.viewModel.contrast=0}_resizeNavigationTool(){this._navigationTool?.parentElement?.classList.toggle(p.css.navigationZoomed)}_storeActionElement(e){this._actionItems.set(e.text,e)}_storeNavigationToolReference(e){this._navigationTool=e}_toggleAdditionalCameraLocations(){this.isAdditionalPointSourcesVisible=!this.isAdditionalPointSourcesVisible}_toggleAdditionalCoverage(){this.isAdditionalCoverageVisible=!this.isAdditionalCoverageVisible}_toggleCurrentCoverage(){this.currentCoverageVisible=!this.currentCoverageVisible}_toggleImageEnhancementToolState(e){e.stopPropagation(),this.imageEnhancementToolActive=!this.imageEnhancementToolActive,this.imageEnhancementToolActive&&(this.galleryOpened&&(this.galleryOpened=!1),this.navigationToolActive&&(this.navigationToolActive=!1))}_toggleImageGallery(e){e.stopPropagation(),this.galleryOpened=!!this.imageGalleryEnabled&&!this.galleryOpened,this.galleryOpened&&(this.imageEnhancementToolActive&&(this.imageEnhancementToolActive=!1),this.navigationToolActive&&(this.navigationToolActive=!1))}_toggleNavigationTool(){this.navigationToolActive=!this.navigationToolActive,this.navigationToolActive&&(this.galleryOpened&&(this.galleryOpened=!1),this.imageEnhancementToolActive&&(this.imageEnhancementToolActive=!1))}_toggleMapImageConversionToolState(){this.mapImageConversionToolState=!this.mapImageConversionToolState}_unregisterGalleryItem(e){this._galleryObserver.unobserve(e)}_updateNavigationTool(e){const{previousFeatureAngle:t,selectedFeatureAngle:i}=this.viewModel,s=(i-t+540)%360-180;e.style.setProperty(p.navigationToolRotationFrom,`${t}deg`),e.style.setProperty(p.navigationToolRotationTo,`${t+s}deg`)}loadBestImage(e){this.viewModel.loadBestImage(e)}async plotMapPoint(e){return this.viewModel.plotMapPoint(e)}resetImage(){this.viewModel.resetImage()}render(){const{dockEnabled:e,viewModel:{updating:t}}=this;return _.tsx("div",{class:this.classes(p.base,p.root)},_.tsx("calcite-panel",{bind:this,class:e?p.css.dock:p.css.float,heading:this.visibleElements.title?this.messages.title:void 0,loading:t},this.visibleElements.coverageMenu?this._renderMenuBarContainer():null,this._renderBody()))}_renderActionTooltips(){return[...this._actionItems].map((([e,t])=>_.tsx("calcite-tooltip",{key:e,referenceElement:t},_.tsx("span",null,e))))}_renderBody(){return _.tsx("div",{class:p.css.body},this._renderViewerContainer(),this._renderImageGallery(),this._renderImageEnhancementTools(),this._renderNavigation())}_renderImageEnhancementTools(){const{imageEnhancementToolActive:e,viewModel:{brightness:t,contrast:i,sharpness:s}}=this;return e&&_.tsx("calcite-panel",{bind:this,class:p.css.imageEnhancementWrapper,closable:!0,closed:!e,heading:this.messages.imageEnhancement,key:this.messages.imageEnhancement,onCalcitePanelClose:this._toggleImageEnhancementToolState},_.tsx("div",{class:p.css.imageEnhancementTools},_.tsx("div",{class:p.css.imageEnhancementToolContainer},_.tsx("calcite-label",null,this.messages.brightness,_.tsx("calcite-slider",{bind:this,labelTicks:!0,max:10,min:-10,ticks:5,value:t,onCalciteSliderInput:this._handleBrightnessChange}))),_.tsx("div",{class:p.css.imageEnhancementToolContainer},_.tsx("calcite-label",null,this.messages.contrast,_.tsx("calcite-slider",{bind:this,labelTicks:!0,max:10,min:-10,ticks:5,value:i,onCalciteSliderInput:this._handleContrastChange}))),_.tsx("div",{class:p.css.imageEnhancementToolContainer},_.tsx("calcite-label",null,this.messages.sharpness,_.tsx("calcite-slider",{bind:this,labelTicks:!0,max:1,min:0,step:.1,ticks:.5,value:s,onCalciteSliderInput:this._handleSharpnessChange})))),_.tsx("calcite-action",{bind:this,icon:"reset",onclick:this._resetImageTools,slot:"header-actions-end",text:this.messagesCommon.reset}))}_renderImageGallery(){const{container:e,galleryOpened:t,imageGalleryEnabled:i,viewModel:{thumbnails:s}}=this;return i&&t&&(e&&s)?_.tsx("calcite-panel",{bind:this,class:p.css.carousel,closable:!0,closed:!t,heading:this.messages.imageGallery,key:this.messages.imageGallery,onCalcitePanelClose:this._toggleImageGallery},_.tsx("div",{class:p.css.carouselContainer},this._renderThumbnails(s))):null}_renderMapImageConversionTool(){const{mapImageConversionToolState:e,viewModel:{imageLoaded:t}}=this;return _.tsx("calcite-action",{active:e,afterCreate:this._storeActionElement,bind:this,disabled:!t,icon:"image-pin",onclick:this._toggleMapImageConversionToolState,text:this.messages.mapImageConversionTool})}_renderNavigation(){const{viewModel:{sectorData:e,features:t,selectedFeature:s,updating:a,navigatorSelectedFeature:o}}=this;if(!t.length||!this.container||!s)return null;let r,n,l,c,d;if(o){const{x:e,y:t,direction:i}=o,[s,a,h,g]=p.segmentArcs[i];r=`M ${e} ${t} L ${s} ${a} A ${p.sectorsRadii[2]} ${p.sectorsRadii[2]} 0 0 1 ${h} ${g} Z`,n=e,c=t,l=p.segmentArcs[i][4],d=p.segmentArcs[i][5]}const h=e=>{const t=e.target.dataset?.sector;t&&this.viewModel.handleSectorClick(+t)},g=e=>{const t=e.target.dataset;if(!t)return;const{featureIndexInSector:i,sector:s}=t;i&&s&&this.viewModel.handleFeatureClick({sector:s,featureIndexInSector:+i})},v=e=>{e.removeEventListener("click",g)},u=e?.map((e=>e?.items)).filter(Boolean).flatMap((e=>e?.map((({x:e,y:t,objectID:i,featureIndexInSector:a,sector:o})=>_.tsx("circle",{afterRemoved:v,class:this.classes(p.css.feature,{selected:s.attributes.objectId===i}),cx:e,cy:t,"data-featureIndexInSector":a,"data-sector":o,key:`${p.css.feature}-${i}`,onclick:g,r:p.featureCircleRadius}))))),y=e=>{e.removeEventListener("click",h)};return this.navigationToolActive&&!a?_.tsx("div",{bind:this,class:p.css.navigationWrapper,key:this.messages.navigationTool},_.tsx("svg",{afterCreate:this._storeNavigationToolReference.bind(this),class:i.prefersReducedMotion()?p.navigation:p.css.rotateWithAnimation,focusable:"false",height:p.navigationToolDimensionLength,role:"img",width:p.navigationToolDimensionLength,xmlns:"http://www.w3.org/2000/svg"},_.tsx("defs",null,_.tsx("linearGradient",{gradientUnits:"userSpaceOnUse",id:`${this.id}-coverage-fill`,x1:n,x2:l,y1:c,y2:d},_.tsx("stop",{class:p.css.navigationPathOffset0,offset:0}),_.tsx("stop",{class:p.css.navigationPathOffset1,offset:1}))),_.tsx("g",null,_.tsx("circle",{class:this.classes(p.css.sector,p.css.outerSector),cx:p.sectorsRadii[3],cy:p.sectorsRadii[3],onclick:this._resizeNavigationTool.bind(this),r:p.sectorsRadii[3]}),_.tsx("circle",{class:p.css.sector,cx:p.sectorsRadii[3],cy:p.sectorsRadii[3],r:p.sectorsRadii[2]}),_.tsx("circle",{class:p.css.sector,cx:p.sectorsRadii[3],cy:p.sectorsRadii[3],r:p.sectorsRadii[1]}),_.tsx("circle",{class:p.css.sector,cx:p.sectorsRadii[3],cy:p.sectorsRadii[3],r:p.sectorsRadii[0]}),_.tsx("path",{class:p.css.pointer,d:"M 56.5 6.06217782649107 L 60 0 L 63.5 6.06217782649107 Z",key:`${p.css.pointer}-west`}),_.tsx("path",{class:this.classes(p.css.pointer,p.css.north),d:"M 113.93782217350893 56.5 L 120 60 L 113.93782217350893 63.5 Z",key:`${p.css.pointer}-north`}),_.tsx("path",{class:p.css.pointer,d:"M 56.5 113.93782217350893 L 60 120 L 63.5 113.93782217350893 Z",key:`${p.css.pointer}-east`}),_.tsx("path",{class:p.css.pointer,d:"M 6.06217782649107 56.5 L 0 60 L 6.06217782649107 63.5 Z",key:`${p.css.pointer}-south`}),_.tsx("path",{class:this.classes(p.css.sector,p.css.sectorSeparator),d:"M 23.937554159486076 23.937554159486076 L 96.06244584051393 96.06244584051393 M 23.937554159486076 96.06244584051393 L 96.06244584051393 23.937554159486076",key:p.css.sectorSeparator}),m.getAllArcPath([p.sectorsRadii[2],p.sectorsRadii[1],p.sectorsRadii[0]],p.sectorsRadii[3],p.sectorsRadii[3]).map(((t,i)=>_.tsx("path",{afterRemoved:y,class:this.classes(p.css.sector,e?.[i]?.length?p.css.sectorEnabled:p.css.sectorDisabled),d:t,"data-sector":`${i}`,key:`${p.css.sector}-${i}`,onclick:h}))),_.tsx("path",{class:this.classes(p.css.sector,p.css.sectorCross),d:"M 56.4 56.4 L 63.53 63.53 M 63.53 56.4 L 56.4 63.53",key:p.css.sectorCross}),u,s.attributes.cameraPitch>=5&&r?_.tsx("path",{class:p.css.selectedFeaturePath,d:r,fill:`url(#${this.id}-coverage-fill)`,key:p.css.selectedFeaturePath}):null))):null}_renderNavigationTool(){const{imageLoaded:e}=this.viewModel;return _.tsx("calcite-action",{active:this.navigationToolActive,afterCreate:this._storeActionElement,bind:this,disabled:!e,icon:"explore",onclick:this._toggleNavigationTool,text:this.messages.navigationTool})}_renderImageEnhancementTool(){const{imageLoaded:e}=this.viewModel;return _.tsx("calcite-action",{active:this.imageEnhancementToolActive,afterCreate:this._storeActionElement,bind:this,disabled:!e,icon:"sliders-horizontal",onclick:this._toggleImageEnhancementToolState,text:this.messages.imageEnhancement})}_renderMenuBarContainer(){const{currentCoverageVisible:e,isAdditionalCoverageVisible:t,isAdditionalPointSourcesVisible:i,imageGalleryEnabled:s}=this;return _.tsx("calcite-action-bar",{expandDisabled:!0,layout:"horizontal",slot:"action-bar"},_.tsx("calcite-action-group",{expanded:!0},_.tsx("calcite-action",{active:e,afterCreate:this._storeActionElement,bind:this,class:p.css.currentCoverage,icon:"trapezoid-area",onclick:this._toggleCurrentCoverage,text:this.messages.currentFootprint}),_.tsx("calcite-action",{active:t,afterCreate:this._storeActionElement,bind:this,class:p.css.addCoverage,icon:"trapezoid-area",onclick:this._toggleAdditionalCoverage,text:this.messages.additionalFootprints}),_.tsx("calcite-action",{active:i,afterCreate:this._storeActionElement,bind:this,class:p.css.addExpPoints,icon:"circle-area",onclick:this._toggleAdditionalCameraLocations,text:this.messages.additionalCameraLocations})),_.tsx("calcite-action-group",{layout:"horizontal"},this.visibleElements.mapImageConversionTool?this._renderMapImageConversionTool():null,this.visibleElements.navigationTool?this._renderNavigationTool():null,this.visibleElements.imageEnhancement?this._renderImageEnhancementTool():null),_.tsx("calcite-action-group",null,_.tsx("calcite-action",{active:this.galleryOpened,afterCreate:this._storeActionElement,bind:this,disabled:!s,icon:"images",onclick:this._toggleImageGallery,text:this.messages.imageGallery,textEnabled:!0})),this._renderActionTooltips())}_renderMessageBox(){const{displayMessage:e}=this.viewModel;return e?_.tsx("span",{class:p.css.messageBox},this.messages[e.key],e?.data):null}_renderThumbnails(e){const{selectedFeature:t}=this.viewModel;return t?_.tsx("div",{class:p.css.carouselContent},e.items.map((({url:e,objectId:i},s)=>_.tsx("div",{class:`${p.css.carouselItemWrapper}${t.attributes.objectId===i?"--selected":""}`,key:`${p.css.carouselItemWrapper}-${s}`},_.tsx("canvas",{afterCreate:this._registerGalleryItem,afterRemoved:this._unregisterGalleryItem,alt:`thumbnail-${i}`,class:p.css.carouselItem,"data-objectid":`${i}`,"data-src":e,onclick:this._loadImageFromGallery}))))):null}_renderViewerContainer(){return _.tsx("div",{class:p.css.viewerContainer},this._renderViewer(),this._renderMessageBox())}_renderViewer(){const{displayMessage:e}=this.viewModel;return _.tsx("div",{afterCreate:this.viewModel.loadViewer,bind:this,class:`${p.css.viewer}${e?"--hide":""}`})}};t.__decorate([r.property()],C.prototype,"activeLayer",null),t.__decorate([r.property()],C.prototype,"currentCoverageVisible",null),t.__decorate([r.property()],C.prototype,"disabled",null),t.__decorate([r.property()],C.prototype,"dockEnabled",void 0),t.__decorate([r.property()],C.prototype,"isDocked",null),t.__decorate([r.property()],C.prototype,"galleryOpened",void 0),t.__decorate([r.property()],C.prototype,"imageEnhancementToolActive",void 0),t.__decorate([r.property({readOnly:!0})],C.prototype,"imageGalleryEnabled",null),t.__decorate([r.property()],C.prototype,"isAdditionalCoverageVisible",null),t.__decorate([r.property()],C.prototype,"isAdditionalPointSourcesVisible",null),t.__decorate([r.property()],C.prototype,"mapImageConversionToolState",null),t.__decorate([r.property()],C.prototype,"layer",null),t.__decorate([r.property()],C.prototype,"navigationToolActive",void 0),t.__decorate([r.property({type:v})],C.prototype,"viewModel",void 0),t.__decorate([r.property(),b.messageBundle("esri/widgets/OrientedImageryViewer/t9n/OrientedImageryViewer")],C.prototype,"messages",void 0),t.__decorate([r.property(),b.messageBundle("esri/t9n/common")],C.prototype,"messagesCommon",void 0),t.__decorate([r.property()],C.prototype,"referencePoint",null),t.__decorate([r.property()],C.prototype,"view",null),t.__decorate([r.property()],C.prototype,"visibleElements",void 0),t.__decorate([n.cast("visibleElements")],C.prototype,"castVisibleElements",null),t.__decorate([r.property()],C.prototype,"_navigationTool",void 0),C=t.__decorate([d.subclass("esri.widgets.OrientedImageryViewer")],C);return C}));
