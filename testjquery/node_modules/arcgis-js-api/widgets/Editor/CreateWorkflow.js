/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","./CreateWorkflowData","./Edits","./Workflow","./workflowUtils"],(function(e,t,a,i,r,o,s,n,d,l,c,w,u){"use strict";var p;let f=p=class extends w{constructor(e){super(e),this.type="create"}get shouldShowAttachments(){return!(!this.data?.creationInfo||!this.data.viewModel)&&u.shouldShowAttachmentsForCreateWorkflow(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get hasPendingEdits(){return!0}get helpMessage(){if("editing-new-feature"!==this.stepId)return;const{creationInfo:e,viewModel:t}=this.data,a=e.layer.geometryType,i=t.sketchViewModel.createGraphic?.geometry;return"mesh"!==a?d.getDrawHelpMessage(a,i):void 0}get reliesOnOwnerAdminPrivileges(){const{layer:e}=this.data.creationInfo,t=e.capabilities?.operations.supportsAdd,a=n.getEffectiveLayerCapabilities(e)?.operations.supportsAdd;return n.getEffectiveEditingEnabled(e)&&!e.editingEnabled||!!a&&!t}static create(e,t,a){const i=new p({data:new l({edits:new c.Edits,viewModel:e}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})}});return i._set("steps",this._createWorkflowSteps(i,t)),i}static _createWorkflowSteps(e,a="awaiting-feature-creation-info"){const{data:i}=e,r=new Map,o={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){i.creationInfo=null,i.edits.feature=null,i.viewModel.featureTemplatesViewModel.select(null),e.addHandles(i.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(i.creationInfo=e,i.viewModel.activeWorkflow?.next())})),this.id)},async tearDown(){e.removeHandles(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){e.addHandles(await u.setUpFeatureAdd(i.viewModel.sketchViewModel,i.creationInfo,(e=>{i.edits.feature=e,i.viewModel.activeWorkflow?.next()}),r),this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const a=i.edits.feature,o=a.sourceLayer,s=i.viewModel,n=s.sketchViewModel,d=u.findLayerInfo(s.layerInfos,o),l=d?.formTemplate,{spatialReference:c}=s.view;s.featureFormViewModel.set({arcadeEditType:"INSERT",feature:a,formTemplate:l,spatialReference:c}),n.allowDeleteKey=!1,u.prepareAttachmentsForCreateWorkflow(s.attachmentsViewModel);const w=u.getVisualVariableAttributes(a);await u.startUpdatingFeature({graphic:a,sketchViewModel:n,sourceLayer:o,visualVariables:w,webStyleCache:r});const p=n.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return u.startUpdatingFeature({graphic:t,sketchViewModel:n,sourceLayer:o,visualVariables:w,webStyleCache:r});await u.visualVariableInteractiveUpdate(n.view,t,e,w,r);const a=t.attributes;if(null!=w.rotation){const{field:e}=w.rotation;s.featureFormViewModel.setValue(e,a[e])}if(null!=w.size){const{field:e}=w.size;s.featureFormViewModel.setValue(e,a[e])}}));e.addHandles([i.viewModel.featureFormViewModel.on("value-change",(async()=>{i.edits.updateAttributes(i.viewModel.featureFormViewModel.getValues()),a.attributes=i.edits.feature.attributes,"3d"===n.view.type&&await u.updateGraphicSymbolWhenRequired(a,r)})),p,t.watch((()=>i.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&i.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&i.viewModel.activeWorkflow.go("editing-attachment")}))],this.id)},async tearDown(t){t.canceled&&i.viewModel.sketchViewModel.layer.removeAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})},s=u.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],a,o);return u.avoidFeatureTemplateSelectionWithOnlyOneItem(i,s)}};e.__decorate([a.property()],f.prototype,"shouldShowAttachments",null),e.__decorate([a.property()],f.prototype,"shouldAllowAttachmentEditing",null),e.__decorate([a.property()],f.prototype,"hasPendingEdits",null),e.__decorate([a.property()],f.prototype,"helpMessage",null),e.__decorate([a.property()],f.prototype,"reliesOnOwnerAdminPrivileges",null),f=p=e.__decorate([s.subclass("esri.widgets.Editor.CreateWorkflow")],f);return f}));
