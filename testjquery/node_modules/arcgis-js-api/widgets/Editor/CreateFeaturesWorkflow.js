/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../../chunks/tslib.es6","../../Graphic","../../core/arrayUtils","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/uuid","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","../../views/interactive/snapping/FeatureSnappingLayerSource","./CreateFeaturesWorkflowData","./modelUploadUtils","./Workflow","./workflowUtils"],(function(e,t,a,i,r,n,s,o,l,c,d,u,p,h,f,g,m,w,y,v){"use strict";var _;const b=Symbol(),M=Symbol(),F=Symbol(),I=Symbol();let k=_=class extends y{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=s.debounce(((e,t,a)=>v.updateGraphicSymbolWhenRequired(e,t,a)))}initialize(){this.isNested&&(this._isActive=!1)}get hasPendingEdits(){if(this.numPendingFeatures>0)return!0;const{data:e}=this,{sketchViewModel:t}=e.viewModel,{activeComponent:a}=t,i=t.createGraphic?.geometry;if(("polyline"===i?.type||"polygon"===i?.type||"multipoint"===i?.type)&&("draw-2d"===a?.type||"draw-3d"===a?.type)&&a.drawOperation.committedVertices.length>0)return!0;const{upload:r}=e;return!(!r||"pending"!==r.state&&"success"!==r.state)||!!e.creationInfo?.geometryToPlace}get helpMessage(){const{creationInfo:t,viewModel:a}=this.data;if("creating-features"!==this.stepId||!t)return;const i=t.layer.geometryType,r=a.sketchViewModel.createGraphic;if("mesh"===i){this._getDrawMeshHelpMessage||new Promise(((t,a)=>e(["../../views/draw/support/helpMessageUtils3d"],t,a))).then((e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage}));const{view:t}=a;return"3d"===t?.type?this._getDrawMeshHelpMessage?.(r,t):void 0}return f.getDrawHelpMessage(i,r?.geometry)}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){const{creationInfo:e}=this.data;if(!e)return!1;const{layer:t}=e,a=t.capabilities?.operations.supportsAdd,i=h.getEffectiveLayerCapabilities(t)?.operations.supportsAdd;return h.getEffectiveEditingEnabled(t)&&!t.editingEnabled||!!i&&!a}get shouldShowAttachments(){return!(!this.data.creationInfo||!this.data.viewModel)&&v.shouldShowAttachmentsForCreateWorkflow(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get test(){return{addAttachment:(e,t)=>{this._attachmentFileInfos.set(e,t)}}}async enter(){this._isActive=!0;const{featureFormViewModel:e}=this.data.viewModel,t=e.relatedRecordCallbacks;e.relatedRecordCallbacks=null,this.addHandles(r.makeHandle((()=>{e.relatedRecordCallbacks=t})),M),"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([M,I])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),i.remove(this._lastActiveGraphics,e),this._startUpdating(e,t)}async start(){return await super.start(),h.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{}}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,isNested:i,creationInfo:r,parent:n,startAt:s,viewModel:o}=e,l=new _({data:new m.CreateFeaturesWorkflowData({creationInfo:r,parent:n,viewModel:o}),isNested:i,onCommit:async e=>{const{creationInfo:i}=e;if(!i)return;const r=e.pendingFeatures.toArray(),{layer:n}=i,s=n.capabilities?.editing.supportsGlobalId&&"globalIdField"in n,o=l._attachmentFileInfos;if(s){const e=C(r,n,o);return void await a(n,e,{globalIdUsed:!0})}const c=await a(n,{addFeatures:r});if(o.size>0){const e=c?.addFeatureResults??[];await t(n,H(r,e,n,o))}}});return l._set("steps",this._createWorkflowSteps(l,s)),l}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r.makeHandle((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,r.makeHandle((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){n.removeMaybe(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(F);const{data:t}=this,{creationInfo:a}=t;if(!a)return;this.createFeatureState="create-new";const i=await v.startCreatingNewFeature(t.viewModel.sketchViewModel,a,e);this.addHandles(i,F)}async _startUpdating(e,t){const{pendingFeatures:a}=this;a.includes(e)||a.add(e);const{creationInfo:i,viewModel:s}=this.data,{attachmentsViewModel:l,editableItems:c,featureFormViewModel:d,layerInfos:u,sketchViewModel:p,view:f}=s;if(!f||!i)return;const g=i.layer,m=v.findLayerInfo(u,g),w=m?.formTemplate,y=f.spatialReference;this.data.editableItem=c.find((e=>e.layer===g)),d.set({arcadeEditType:"INSERT",feature:e,formTemplate:w,spatialReference:y,map:f.map}),"add"!==l.mode&&"edit"!==l.mode||s.activeWorkflow?.previous(),l.graphic=e,l.fileInfos.removeAll(),l.mode="view";if((this._attachmentFileInfos.get(e)||[]).forEach((({file:e,form:t})=>l.addFile(e,t))),this._removeHighlight(e),await v.updateGraphicSymbolWhenRequired(e,t,"2d"===f.type?f.scale:null),this.removeHandles(F),n.removeMaybe(this._featureFormHandle),"2d"===f.type){const a=o.watch((()=>f.scale),(a=>this._updateGraphicDebounced(e,t,a)));this.addHandles(a,F)}return this._featureFormHandle=r.handlesGroup([d.on("value-change",(async()=>{e.attributes=d.getValues(),await v.updateGraphicSymbolWhenRequired(e,t,"2d"===f.type?f.scale:null)})),p.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&v.isTerminalUpdateEventType(e.toolEventInfo.type))&&d.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=v.getVisualVariableAttributes(e),h.isTable(g)?void 0:v.startUpdatingFeature({graphic:e,sketchViewModel:p,sourceLayer:g,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a}=e,i={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:t,viewModel:i}=a,{view:r}=i;r&&(w.isModelUpload(t)?e.addHandles(await w.handleModelUpload({view:r,data:a,next:()=>e.next(),cancel:()=>i.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(a.parent&&t&&(e.addHandles(i.lockFeatureTemplatesViewModel(),this.id),i.featureTemplatesViewModel.layers=[t.layer]),e.addHandles(i.featureTemplatesViewModel.on("select",(({item:t})=>{t&&(a.creationInfo={...a.creationInfo,layer:t.layer,template:t.template},e.next())})),this.id)))},async tearDown(){e.removeHandles([this.id,F])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:i}=a;t.canceled&&(e.removeHandles([I,b,F]),i.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}})},r=v.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,i);return v.avoidFeatureTemplateSelectionWithOnlyOneItem(a,r)}static _configureSketchViewModel(e,t){const{data:a}=e,{viewModel:n}=a,{view:s}=n,l=n.sketchViewModel;let c=null;const d=[];if(!s)return{beforeCommit:r.makeHandle(),afterCommit:r.makeHandle()};const u=l.updateOnGraphicClick;return l.updateOnGraphicClick=!1,"2d"===s.type&&a.creationInfo&&d.push(e._fadeExistingFeatures(a.creationInfo.layer)),d.push(l.on("create",(async a=>{if("cancel"===a.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("complete"===a.state&&a.graphic)return e._startUpdating(a.graphic,t)})),l.on("update",(async i=>{const{viewModel:r}=a,{attachmentsViewModel:n,featureFormViewModel:l}=r,d=i.graphics[0];if("complete"===i.state){if(d!==c&&(e._lastActiveGraphics.push(d),e._highlight(d)),c=null,e.numPendingFeatures===a.creationInfo?.maxFeatures){const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("add"!==n.mode&&"edit"!==n.mode||r.activeWorkflow?.previous(),i.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);e.addHandles([v.showProgressCursor(s),s.on("click",(e=>e.preventDefault()))],b),await o.whenOnce((()=>!l.updating)),e.removeHandles(b),e._startCreating(t)}"start"===i.state&&e._removeHighlight(d);const u=e._visualVariableAttributes;await v.visualVariableInteractiveUpdate(s,d,i,u,t);const p=d.attributes,{rotation:h,size:f}=u;if(null!=h){const{field:e}=h;l.setValue(e,p[e])}if(null!=f){const{field:e}=f;l.setValue(e,p[e])}})),l.on("delete",(async t=>{const a=t.graphics[0];e.pendingFeatures.remove(a),i.remove(e._lastActiveGraphics,a),c=a})),s.on("immediate-click",(async i=>{if(w.isModelUpload(a.creationInfo))return;const{results:r}=await s.hitTest(i,{include:l.layer}),n=r.find((e=>"graphic"===e.type&&e.graphic.sourceLayer===a.creationInfo?.layer));if(!n)return;const o=n.graphic;if("transform"===l.activeTool||"reshape"===l.activeTool){if(l.updateGraphics.at(0)===o)return;await e.updatePendingFeature(o,t)}})),r.makeHandle((()=>{e._preventDefaultActionOnCancel=!0,l.cancel()})),A(l,a)),{beforeCommit:r.handlesGroup(d),afterCommit:r.makeHandle((()=>{l.updateOnGraphicClick=u}))}}async _setUpCreatingFeaturesStep(){if(this.hasHandles(I))return;const{creationInfo:e,viewModel:t}=this.data,{attachmentsViewModel:s,view:l}=t;if(!l)return;const c=new Map,d=[],u=[];this._lastActiveGraphics=[],this._featureFormHandle=n.removeMaybe(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},v.prepareAttachmentsForCreateWorkflow(s),d.push(o.watch((()=>s.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})));const p=v.showProgressCursor(l);d.push(p);const f=h.isTable(e?.layer);try{if(w.isModelUpload(e)&&u.push(r.makeHandle((()=>t.cancelWorkflow({warnIfNoWorkflow:!1})))),f){const t=e?.initialFeature??new a({attributes:{...e?.template?.prototype.attributes,...e?.attributeOverrides},sourceLayer:e?.layer});await this._startUpdating(t,c)}else{const a=_._configureSketchViewModel(this,c);d.push(a.beforeCommit),u.push(a.afterCommit),e?.initialFeature?(t.sketchViewModel.layer.add(e.initialFeature),await this._startUpdating(e.initialFeature,c)):await this._startCreating(c)}}finally{p.remove()}const g=r.makeHandle((()=>this.pendingFeatures.drain((e=>t.sketchViewModel.layer.remove(e)))));d.push(this._featureFormHandle),this.addHandles(d.filter(i.isSome),this._handleKeys.beforeCommit),this.addHandles([r.makeHandle((()=>s.fileInfos.removeAll())),...d,...u,g].filter(i.isSome),I)}};function A(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,s=()=>(a=new g({layer:e.layer}),i().add(a),a),l=()=>{null!=a&&(i().remove(a),a=n.destroyMaybe(a))};return r.handlesGroup([o.watch((()=>{const e=t.creationInfo?.layer,a=i().find((t=>t.layer===e));return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{if(!e)return l();a??(a=s()),a.enabled=t}),o.syncAndInitial),r.makeHandle(l)])}function H(e,t,a,i){const r=[];return t.forEach(((t,n)=>{if(!t.error){const s=e[n],o=i.get(s)||[];s.attributes[a.objectIdField]=t.objectId,o.forEach((({form:e})=>r.push({feature:s,attachment:e})))}})),r}function C(e,t,a){const i=[],r=t.globalIdField;return e.forEach(((t,n)=>{var s;(s=e[n].attributes)[r]??(s[r]=l.generateBracedUUID()),(a?.get(t)||[]).forEach((({file:e})=>i.push({feature:t,attachment:{globalId:l.generateBracedUUID(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}t.__decorate([c.property({constructOnly:!0})],k.prototype,"isNested",void 0),t.__decorate([c.property()],k.prototype,"hasPendingEdits",null),t.__decorate([c.property()],k.prototype,"_getDrawMeshHelpMessage",void 0),t.__decorate([c.property()],k.prototype,"helpMessage",null),t.__decorate([c.property()],k.prototype,"parent",null),t.__decorate([c.property()],k.prototype,"keyboardCancellationEnabled",null),t.__decorate([c.property()],k.prototype,"reliesOnOwnerAdminPrivileges",null),t.__decorate([c.property()],k.prototype,"shouldShowAttachments",null),t.__decorate([c.property()],k.prototype,"shouldAllowAttachmentEditing",null),k=_=t.__decorate([p.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],k);return k}));
