/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Error","../../core/handleUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../views/support/layerViewUtils","./UpdateFeatureWorkflowData","./UpdateRecordWorkflow","./workflowUtils"],(function(e,t,i,a,o,s,r,l,d,c,n,h,u){"use strict";var p;const w={...h.handleKeys,highlights:Symbol(),sketch:Symbol()};e.UpdateFeatureWorkflow=p=class extends h.UpdateRecordWorkflow{constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._webStyleCache=new Map}initialize(){const{edits:{feature:e},layerView:t}=this.data;u.canCreateInteractiveEditSession(t)&&(this._layerViewEditSession=t.createInteractiveEditSession(e))}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(w.sketch);try{const e=this.data.edits.stagedForDelete;await super.commit();const t=this._layerViewEditSession;e?t?.rollback():t?.commit()}catch(e){throw await this._configureSketchViewModel(),new i("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}}async start(){return await super.start(),this._initializeSketchViewModel()}_configureFeatureFormViewModel(){super._configureFeatureFormViewModel();const{_layerViewEditSession:e}=this,{viewModel:t}=this.data;this.addHandles(t.featureFormViewModel.on("value-change",(t=>{e?.setAttribute(t.fieldName,t.value)})),w.exit)}_configureHighlight(){const{edits:e,layerView:t}=this.data;c.highlightsSupported(t)&&this.addHandles(t.highlight(e.feature),w.highlights)}async _configureSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,{edits:i,viewModel:a}=e,o=i.feature,{featureFormViewModel:s,sketchViewModel:r,view:l}=a;r.allowDeleteKey=!1;const d=u.getVisualVariableAttributes(o),c=await u.setUpGeometryUpdate({feature:o,featureClone:t,visualVariableAttributes:d,sketchViewModel:r,view:l,onUpdate:({geometry:e,attributes:t},a)=>{if(i.updateAttributes(t),i.updateGeometry(e),s.feature.geometry=e,null!=d.rotation){const{field:e}=d.rotation;s.setValue(e,t[e])}if(null!=d.size){const{field:e}=d.size;s.setValue(e,t[e])}("undo"===a.type||"redo"===a.type||"update"===a.type&&null!=a.toolEventInfo&&u.isTerminalUpdateEventType(a.toolEventInfo.type))&&s.notifyFeatureGeometryChanged()},webStyleCache:this._webStyleCache});this.addHandles(c,w.sketch)}async _initializeSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,i=e.edits.feature,{sketchViewModel:o}=e.viewModel,{geometryUpdatesEnabled:s}=e.editableItem,r=o.updateOnGraphicClick;o.updateOnGraphicClick=!1,this.addHandles([a.makeHandle((()=>{o.updateOnGraphicClick=r}))]),s&&this.addHandles([await u.swapForEditingSession(o,i,t)]);const{highlights:l,sketch:d}=w;return{enter:async()=>{!this.hasHandles(d)&&s?await this._configureSketchViewModel():this.hasHandles(l)||this._configureHighlight()},exit:()=>this.removeHandles([d,l])}}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e),this._sketchGraphicClone=u.cloneGraphicExceptMesh(e);const{edits:t}=this.data;t.updateGeometry(e.geometry),t.trackChanges()}static async create(e){const t=new p({data:await n.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}},t.__decorate([o.property()],e.UpdateFeatureWorkflow.prototype,"_layerViewEditSession",void 0),t.__decorate([o.property()],e.UpdateFeatureWorkflow.prototype,"_sketchGraphicClone",void 0),e.UpdateFeatureWorkflow=p=t.__decorate([d.subclass("esri.widgets.Editor.UpdateFeatureWorkflow")],e.UpdateFeatureWorkflow),e.handleKeys=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
