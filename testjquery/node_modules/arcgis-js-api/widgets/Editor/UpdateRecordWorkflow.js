/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Error","../../core/handleUtils","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../support/featureFlags","../../views/draw/support/HighlightHelper","./UpdateRecordWorkflowData","./Workflow","./workflowUtils"],(function(e,t,a,r,i,o,s,l,d,n,c,p,u,h,f,g,m){"use strict";var w;const y={exit:Symbol()},b="esri.widgets.Editor.UpdateRecordWorkflow";e.UpdateRecordWorkflow=w=class extends g{constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:e}=this,{edits:t}=e,{view:o}=e.viewModel,s=t.feature,l=new AbortController;this.addHandles(r.abortHandle(l)),this._updatingHandles.addPromise(m.fetchFullFeature(s,e.viewModel.view.spatialReference,l.signal).then((e=>{i.isAborted(l)||this._onFullFeatureLoaded(e)}),(e=>this.cancel({force:!0,error:new a("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:e}})})))),o&&(this._highlightHelper=new h({view:o}),this.addHandles(r.makeHandle((()=>this._highlightHelper?.removeAll()))))}get editableItem(){return this.data.editableItem}get hasPendingEdits(){return this.data.edits.modified}get parent(){return this.data.parent}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get reliesOnOwnerAdminPrivileges(){const{layer:e}=this.editableItem,t=e.capabilities?.operations.supportsUpdate,a=p.getEffectiveLayerCapabilities(e)?.operations.supportsUpdate;return p.getEffectiveEditingEnabled(e)&&!e.editingEnabled||!!a&&!t}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel(),this._configureFeatureFormViewModel()}exit(e){this.removeHandles(y.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:e,fullFeature:t}=this,{attachmentsCapabilities:a,viewModel:i}=e,{attachmentsViewModel:s}=i;s.set({capabilities:a,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([r.makeHandle((()=>s.fileInfos.removeAll())),o.watch((()=>s.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}))],y.exit)}_configureFeatureFormViewModel(){const{edits:e,formTemplate:t,viewModel:{featureFormViewModel:a,view:r}}=this.data;a.set({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:t,highlightHelper:this._highlightHelper,map:r?.map,spatialReference:r.spatialReference});const{initialFeature:i}=e;i&&a.overrideInitialFeature(i),this.addHandles(a.on("value-change",(()=>{e.updateAttributes(a.getValues()),this.fullFeature.attributes=e.feature.attributes})),y.exit)}_onFullFeatureLoaded(e){this.fullFeature=e;const{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static async create(e){const t=new w({data:await f.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){const{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){t.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){t.mode="view"}}]}},e.UpdateRecordWorkflow._onCommitFactory=e=>async t=>{const{edits:a}=t,{feature:r}=a;if(!r)return;const i=r.sourceLayer,o=r.clone();if(!a.attributesModified||a.stagedForDelete){const e=i.objectIdField;if(o.attributes={[e]:r.getAttribute(e)},u.sceneLayerEditingEnabled()&&u.i3sPatchingEnabled()&&"scene"===i.type&&null!=i.infoFor3D){const e=i.associatedLayer?.globalIdField;null!=e&&o.setAttribute(e,r.getAttribute(e))}}a.geometryModified&&!a.stagedForDelete||(o.geometry=null);const s=a.stagedForDelete?"deleteFeatures":"updateFeatures";await e(i,{[s]:[o]})},t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"editableItem",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"fullFeature",void 0),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"hasPendingEdits",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"parent",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"shouldShowAttachments",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"reliesOnOwnerAdminPrivileges",null),e.UpdateRecordWorkflow=w=t.__decorate([c.subclass(b)],e.UpdateRecordWorkflow),e.handleKeys=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
