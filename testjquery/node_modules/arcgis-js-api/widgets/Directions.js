/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../intl","../core/events","../core/handleUtils","../core/maybe","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../properties/defaultUnit","../rest/support/Stop","../symbols/SimpleMarkerSymbol","./Search","./Widget","./Directions/DirectionsViewModel","./Directions/components/SaveLayer","./Directions/support/directionsUtils","./Directions/support/resources","./Search/support/locatorUtils","./support/componentsUtils","./support/DatePicker","./support/globalCss","./support/Heading","./support/legacyIcon","./support/TimePicker","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils","../chunks/sortable.esm","../intl/number","../intl/date"],(function(e,t,s,i,r,o,n,a,l,c,d,u,h,p,v,m,_,g,y,S,w,b,M,T,f,C,x,D,k,I,P,R,H,L,B){"use strict";const O={departureTime:!0,layerDetails:!0,printButton:!1,saveAsButton:!0,saveButton:!0,stops:!0,traveMode:!0};function A(e){const t=e.getTimezoneOffset(),s=t>0?"-":"+",i=60,r=Math.abs(Math.floor(t/i)),o=Math.abs(Math.floor(t)%i),n={minimumIntegerDigits:2};return`GMT${s}${L.formatNumber(r,n)}${L.formatNumber(o,n)}`}function E(e){return!!e.composedPath?.().find((e=>e.classList?.contains("esri-search__suggestions-list")))}const U="search-term",z="date-time-picker",$=100,N=500;let F=class extends _{constructor(e,t){super(e,t),this._activeStop=null,this._activeManeuver=null,this._autoStopRemovalDelay=$,this._autoStopRemovalTimeoutId=void 0,this._departureTimeOption=w.DepartureTimeOption.NOW,this._datePicker=new T,this._focusedManeuver=null,this._newPlaceholderStop=null,this._pointerDownUpHandle=null,this._pointerPressedSearchSuggestionStop=null,this._renderSavePopoverFunction=null,this._saveAsButtonNode=null,this._saveLayer=new y.SaveLayer,this._sections=null,this._sortable=null,this._stopsToSearches=new Map,this._timePicker=new D,this._viewClickHandle=null,this.headingLevel=2,this.iconClass=w.css.widgetIcon,this.icon=null,this.messages=null,this.messagesCommon=null,this.messagesUnits=null,this.searchProperties=null,this.viewModel=new g,this.visibleElements={...O},this._setUpDragAndDropStops=e=>{this._sortable=H.Sortable.create(e,{draggable:`.${w.css.validStopRow}`,ghostClass:w.css.stopRowGhost,handle:`.${w.css.stopHandle}`,onEnd:this._handleStopInputDragEnd})},this._handleDragHandlePointerDown=()=>this.viewModel.layer?.stops.forEach((e=>this.acquireSearch(e).activeMenu="none")),this._handleStopInputDragEnd=({oldIndex:e,newIndex:t,target:s})=>{if(e===t||null==t||null==e)return;const{children:i}=s,r=i[t],o=i[e],n=t-e<0;s.insertBefore(r,n?o.nextElementSibling:o);const{stops:a}=this.viewModel.layer;a.reorder(a.at(e),t);for(const l of a)l.sequence=null;this._getDirections()}}initialize(){this.addHandles([n.watch((()=>this.viewModel.layer?.routeInfo),(()=>{this._activeManeuver=null,this._focusedManeuver=null,this._sections=this._getSections(),this.scheduleRender()}),n.initial),n.when((()=>this.view),((e,t)=>{if(t&&(this._viewClickHandle=null,null!=t&&this.removeHandles(t)),e){const t=this._prepPointerDownUpClick(),s=this._prepViewClick();t.pause(),s.pause();const r=e.surface;this.addHandles([i.on(r,"mousedown",(()=>this._autoStopRemovalDelay=N)),i.on(r,"mouseup",(()=>this._autoStopRemovalDelay=$)),t,s],e),this._pointerDownUpHandle=t,this._viewClickHandle=s}}),n.initial),n.when((()=>null==this.viewModel.serviceDescription),(()=>{try{this.viewModel.load()}catch{}}),n.initial),n.watch((()=>this._saveLayer.state),(()=>{this.scheduleRender()}))]),this.when((()=>{this.destroyed||this.visibleElements.saveAsButton&&(this._renderSavePopoverFunction=this._renderSavePopover.bind(this),this._projector.append(document.body,this._renderSavePopoverFunction))}))}loadDependencies(){return M.loadCalciteComponents({button:()=>new Promise(((t,s)=>e(["../chunks/calcite-button"],t,s))),icon:()=>new Promise(((t,s)=>e(["../chunks/calcite-icon"],t,s))),link:()=>new Promise(((t,s)=>e(["../chunks/calcite-link"],t,s))),popover:()=>new Promise(((t,s)=>e(["../chunks/calcite-popover"],t,s)))})}destroy(){this._datePicker.destroy(),this._timePicker.destroy();for(const e of this._stopsToSearches.values())e.destroy();this._sortable?.destroy(),null!=this._renderSavePopoverFunction&&this._projector.detach(this._renderSavePopoverFunction)}get apiKey(){return this.viewModel.apiKey}set apiKey(e){this.viewModel.apiKey=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get lastRoute(){return this.viewModel.lastRoute}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get maxStops(){return this.viewModel.maxStops}set maxStops(e){this.viewModel.maxStops=e}get unit(){return this.defaultUnit}set unit(e){this._overrideIfSome("unit",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...O,...e}}acquireSearch(e){const{view:t}=this.viewModel;if(this._stopsToSearches.has(e)){const s=this._stopsToSearches.get(e);return s.view=t,this._overrideDefaultSources(s),s}const s=new m({view:t,resultGraphicEnabled:!1,popupEnabled:!1,...this.searchProperties});return this._normalizeSearchSources(s),this.addHandles([n.on((()=>s.allSources),"change",(()=>this._normalizeSearchSources(s))),s.on("select-result",(()=>{e.geometry=s.selectedResult?.feature.geometry,e.name=s.selectedResult?.name,this._getDirections()})),s.on("search-focus",(()=>this._handleStopInputFocus(s,e))),s.on("search-blur",(()=>this._handleStopInputBlur(s,e))),s.on("search-clear",(()=>{e.geometry=null,e.name=null,this._activeStop=e,this.viewModel.layer?.removeResult()})),n.watch((()=>s.searchTerm),(t=>{e.name=t}))],s),this._stopsToSearches.set(e,s),s}getDirections(){return this.viewModel.getDirections()}render(){return P.tsx("div",{class:this.classes(w.css.base,f.globalCss.widget,f.globalCss.panel,w.css.scroller)},this._renderPanelContent())}save(){return this.viewModel.save()}saveAs(e,t={}){return this.viewModel.saveAs(e,t)}zoomToRoute(){return this.viewModel.zoomToRoute()}_renderPanelContent(){const{layer:e,serviceDescription:t,state:s}=this.viewModel,i="initializing"===s,r="error"===s&&!t,o="unauthenticated"===s,n={[w.css.panelContentLoading]:i,[w.css.panelContentError]:r||!e,[w.css.panelContentSignIn]:o},a=i?"presentation":"group",l=e?o?this._renderSignIn():r?this._renderMessage(this._getErrorMessage()):i?this._renderLoader():this._renderReadyContent():this._renderMessage(this.messages.missingLayer);return P.tsx("div",{class:this.classes(w.css.panelContent,n),role:a},l)}_renderReadyContent(){return[this._renderStopsContainer(),this._renderTravelModeOptions(),this._renderDepartureTimeControls(),this._renderSaveContainer(),this._renderSectionSplitter(),this._renderDirectionsContainer()]}_renderSignIn(){return P.tsx("div",{class:w.css.signInContent,key:"sign-in"},P.tsx(C.Heading,{class:w.css.contentTitle,level:this.headingLevel},this.messages.widgetLabel),this._renderPlaceholder(),P.tsx(C.Heading,{level:C.incrementHeadingLevel(this.headingLevel)},this.messages.signInRequired),P.tsx("button",{bind:this,class:this.classes(f.globalCss.button,f.globalCss.buttonSecondary,w.css.signInButton),onclick:this._handleSignInClick,tabIndex:0,type:"button"},this.messagesCommon.auth.signIn))}_handleSignInClick(){this.viewModel.load().catch((()=>{}))}_renderTravelModeOptions(){if(!this.visibleElements.traveMode)return null;const{selectedTravelMode:e,travelModes:t}=this.viewModel;if(0===t.length)return null;const s=null!=e?e.name:this.messages.travelMode;return P.tsx("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(w.css.travelMode,this._saveLayer.opened&&f.globalCss.buttonDisabled),key:"esri-directions__travel-mode-controls",role:"group"},P.tsx("select",{"aria-label":s,bind:this,class:this.classes(w.css.travelModeSelect,f.globalCss.select),key:"esri-directions__travel-mode-options",onchange:this._handleTravelModeChange,title:s},t.map(((t,s)=>{const i=e===t;return P.tsx("option",{"data-mode":t,key:`esri-directions__travel-mode-${s}`,selected:i,value:`${s}`},t.name)}))))}_handleTravelModeChange(e){const t=e.currentTarget;this.viewModel.selectedTravelMode=V(t.item(t.selectedIndex)),this._getDirections()}_renderStopsContainer(){return this.visibleElements.stops?P.tsx("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(w.css.section,this._saveLayer.opened&&f.globalCss.buttonDisabled),key:"esri-directions__stops-container",role:"group"},this._renderStops()):null}_renderDepartureTimeControls(){if(!this.visibleElements.departureTime)return null;const{messages:{departAt:e,departureTime:t,leaveNow:s,timeUnspecified:i}}=this;return P.tsx("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(w.css.departureTime,this._saveLayer.opened&&f.globalCss.buttonDisabled),key:"esri-directions__departure-time-controls",role:"group"},P.tsx("select",{"aria-label":t,bind:this,class:this.classes(w.css.departureTimeSelect,f.globalCss.select),onchange:this._handleDepartureOptionChange,title:t},P.tsx("option",{selected:this._departureTimeOption===w.DepartureTimeOption.NOW,value:w.DepartureTimeOption.NOW},s),P.tsx("option",{selected:this._departureTimeOption===w.DepartureTimeOption.DEPART_AT,value:w.DepartureTimeOption.DEPART_AT},e),P.tsx("option",{selected:this._departureTimeOption===w.DepartureTimeOption.UNSPECIFIED,value:w.DepartureTimeOption.UNSPECIFIED},i)),this._departureTimeOption===w.DepartureTimeOption.DEPART_AT?this._renderTimeControls():null)}_renderStops(){const{stops:e}=this.viewModel.layer;let t=0;for(const r of this._stopsToSearches.keys())e.includes(r)||this._disposeSearch(r);for(const r of e){const e=this.acquireSearch(r);"none"!==e.activeMenu&&(t+=1),null!=r.name&&(e.searchTerm=r.name)}const s=e.toArray().map(((s,i)=>{const r=e.length,o=i>1&&null==s.geometry,n={[x.legacyIcon.radioUnchecked]:i>=0&&i<r-1,[x.legacyIcon.radioChecked]:i===r-1},a={[w.css.lastStopIconContainer]:i===r-1},l={[w.css.validStopRow]:!o},c=e.at(i+1),d=i===r-1,u=i===r-2,h=2===r&&0===i||r>2&&!d&&!u||r>2&&u&&null!=c?.geometry||r>2&&d&&null==s.geometry,p=r<3,v=this.acquireSearch(s),{messages:m}=this,{removeStop:_,reverseStops:g,unlocated:y}=m,S=null!=s.geometry&&null!=s.name?s.name:y,b=L.formatNumber(i+1),M=`${m.stopLabel} ${b} (${S})`,T=`${this.id}__stop--${i}`,f=!!v.searchTerm&&!!v.selectedResult&&null!=s.geometry&&v.selectedResult.name===s.name,C={zIndex:"none"!==v.activeMenu?""+t--:""};return P.tsx("li",{afterCreate:this._handleStopFieldCreation,"aria-label":M,bind:this,class:this.classes(w.css.stopRow,l),"data-stop-index":i,id:T,key:i,styles:C},P.tsx("div",{class:w.css.stopHandle},P.tsx("span",{"aria-hidden":"true",class:this.classes(w.css.stopIcon,x.legacyIcon.handleVertical,w.css.stopHandleIcon,w.css.interactiveStopIcon),onpointerdown:this._handleDragHandlePointerDown}),P.tsx("div",{"aria-labelledby":T,bind:this,class:this.classes(w.css.stopIconContainer,a),"data-stop-index":i,onclick:this._handleStopIconClick,onkeydown:this._handleStopIconClick,role:"button"},P.tsx("span",{class:this.classes(w.css.stopIcon,n),tabIndex:f?0:void 0}))),P.tsx("div",{class:w.css.stopInput},v.render()),P.tsx("div",{class:w.css.stopOptions,role:"group"},P.tsx("div",{"aria-label":_,bind:this,class:w.css.removeStopButton,"data-stop-index":i,hidden:p,onclick:this._handleRemoveStop,onkeydown:this._handleRemoveStop,role:"button",tabIndex:0,title:_},P.tsx("span",{"aria-hidden":"true",class:this.classes(w.css.stopIcon,w.css.removeStop,x.legacyIcon.trash,w.css.interactiveStopIcon)}),P.tsx("span",{class:x.legacyIcon.fontFallbackText},"removeStopTitle")),P.tsx("div",{"aria-label":g,bind:this,class:w.css.reverseStops,hidden:h,onclick:this._handleReverseStops,onkeydown:this._handleReverseStops,role:"button",tabIndex:0,title:g},P.tsx("span",{"aria-hidden":"true",class:this.classes(w.css.stopIcon,x.legacyIcon.upDownArrows,w.css.interactiveStopIcon)}),P.tsx("span",{class:x.legacyIcon.fontFallbackText},"removeStopTitle"))))})),i=this._renderAddStop();return P.tsx("div",null,P.tsx("ol",{afterCreate:this._setUpDragAndDropStops,class:w.css.stops,role:"group"},s),i)}_renderAddStop(){const e=this.viewModel.layer?.stops;if(!e)return null;const t=e.filter((({geometry:e})=>null!=e)),s=e.at(-1);return t.length>1&&t.length<this.maxStops&&null!=s?.geometry?P.tsx("div",{class:w.css.toolbarSection},P.tsx("div",{class:w.css.toolbarButtons},P.tsx("calcite-button",{appearance:"outline",class:w.css.addStopButton,iconStart:"plus",key:w.css.addStopButton,kind:"neutral",label:this.messages.addStop,onclick:()=>{this._addNewPlaceholder()},round:!0,scale:"s",width:"full"},this.messages.addStop))):null}_handleStopIconClick(e){const t=W(e.currentTarget),s=null!=t?this.viewModel.layer?.stops.at(t):void 0;s?.geometry&&this._centerAtStop(s)}_handleClearRouteClick(){this.viewModel.reset()}_centerAtStop(e){this.viewModel.centerAt(e)}_handleStopFieldCreation(e){const t=this._newPlaceholderStop;if(!t)return;const s=W(e),i=null!=s?this.viewModel.layer?.stops.at(s):void 0;if(t===i){const e=this.acquireSearch(i);e.when((()=>{this.renderNow(),e.focus()}))}this._newPlaceholderStop=null}_handleStopInputBlur(e,t){if(this._saveLayer.opened)return;this.removeHandles(U);if(!!e.selectedResult&&null!=t.geometry&&null!=e.selectedResult?.feature.geometry&&t.geometry===e.selectedResult?.feature.geometry)return void this._pointerDownUpHandle?.pause();const s=null==t.geometry&&null==e.selectedResult?.feature.geometry,i=null!=t.geometry&&null!=e.selectedResult?.feature.geometry&&t.geometry!==e.selectedResult?.feature.geometry;if((s||i)&&"none"===e.activeMenu&&e.searchTerm)return e.search(),void this._pointerDownUpHandle?.pause();e.searchTerm||(this._viewClickHandle?.resume(),clearTimeout(this._autoStopRemovalTimeoutId),this._autoStopRemovalTimeoutId=setTimeout((()=>{this.destroyed||(this._viewClickHandle?.pause(),"searching"!==e.viewModel.state?this._pointerPressedSearchSuggestionStop||(null!=t.geometry&&(t.geometry=null,this._getDirections()),this.scheduleRender()):this._pointerDownUpHandle?.pause())}),this._autoStopRemovalDelay))}_handleStopInputFocus(e,t){this._pointerDownUpHandle?.resume();const{view:s}=this;if(this.hasHandles(U)||!s)return;const i=s.cursor;this.addHandles([r.makeHandle((()=>{s.cursor=i})),n.watch((()=>e.searchTerm),(t=>{e.destroyed||(s.cursor=t.length?i:"copy")}),n.initial)],U),this._activeStop=t}_prepViewClick(){const{view:e}=this.viewModel;o.assertIsSome(e),o.assertIsSome(e.surface);const t=i.pausable(e,"click",this._handleViewClick.bind(this)),s=i.pausable(e.surface,"click",(()=>{clearTimeout(this._autoStopRemovalTimeoutId),s.pause()}));return{remove(){s.remove(),t.remove()},pause(){s.pause(),t.pause()},resume(){s.resume(),t.resume()}}}_prepPointerDownUpClick(){const e=i.pausable(document,"pointerdown",(e=>{this._pointerPressedSearchSuggestionStop=E(e)?this._activeStop:null})),t=i.pausable(document,"pointerup",(e=>{this._pointerDownUpHandle?.pause();const t=E(e),s=this._activeStop;t||s!==this._pointerPressedSearchSuggestionStop||this._removeStop(s),this.scheduleRender(),this._pointerPressedSearchSuggestionStop=t?s:null}));return{remove(){t.remove(),e.remove()},pause(){t.pause(),e.pause()},resume(){e.resume()}}}_handleViewClick(e){e.stopPropagation();const t=this._activeStop,s=t?this._stopsToSearches.get(t):null;t&&s&&!s.searchTerm&&(s.search(e.mapPoint).then((e=>{const i=e?.results[0].results;if(!i)return;const{feature:r,name:o}=i[0];t.geometry=r.geometry,t.name=o,s.searchTerm=o})),this.scheduleRender()),this._viewClickHandle?.pause(),clearTimeout(this._autoStopRemovalTimeoutId)}_addNewPlaceholder(){if(this._pointerDownUpHandle?.pause(),this._newPlaceholderStop)return;const e=new p({symbol:new v});this.viewModel.layer?.stops.add(e),this._newPlaceholderStop=e}_handleReverseStops(){this._reverseStops()}_reverseStops(){const e=this.viewModel.layer?.stops??[];e.reverse();for(const t of e)t.sequence=null;this._getDirections()}_handleRemoveStop(e){const{layer:t}=this.viewModel;if(!t)return;const s=W(e.currentTarget);if(null==s)return;const{stops:i,routeInfo:r}=t,o=i.at(s);this._removeStop(o),null==o.geometry&&null!=r||this._getDirections()}_removeStop(e){const{stops:t}=this.viewModel.layer;!e||t.length<=2||(this._disposeSearch(e),t.remove(e))}_handleDepartureOptionChange(e){const t=e.currentTarget,s=t.item(t.selectedIndex);s.value===w.DepartureTimeOption.NOW?(this._departureTimeOption=w.DepartureTimeOption.NOW,this.viewModel.departureTime=w.DepartureTimeOption.NOW,this.removeHandles(z),this._getDirections()):s.value===w.DepartureTimeOption.DEPART_AT?(this._departureTimeOption=w.DepartureTimeOption.DEPART_AT,this.addHandles(n.watch((()=>[this._datePicker.value,this._timePicker.value]),(()=>{this._updateDepartureTime(),this._getDirections()}),n.initial),z)):(this._departureTimeOption=w.DepartureTimeOption.UNSPECIFIED,this.viewModel.departureTime=null,this._getDirections())}_updateDepartureTime(){const e=this._datePicker.value,t=this._timePicker.value;e&&t&&(this.viewModel.departureTime=new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes()))}_renderTimeControls(){return P.tsx("div",{class:w.css.departureTimeControls,key:"esri-directions__time-controls",role:"group"},this._datePicker.render(),this._timePicker.render())}_renderSectionSplitter(){return P.tsx("div",{class:w.css.sectionSplitter})}_renderSaveContainer(){const{saveButton:e,saveAsButton:t,printButton:s,layerDetails:i}=this.visibleElements;return e||t||s||i?P.tsx("div",{class:w.css.saveSection,key:w.css.saveSection},this._renderSaveButtons(),this._renderRouteLayerDetailsLink()):null}_renderSaveButtons(){const{saveButton:e,saveAsButton:t,printButton:s}=this.visibleElements;return e||t||s?P.tsx("div",{class:w.css.saveButtons,key:w.css.saveButtons},this._renderSaveButton(),this._renderSaveAsButton(),this._renderPrintButton()):null}_renderSaveButton(){if(!this.visibleElements.saveButton)return null;const{portalItem:e,routeInfo:t}=this.viewModel.layer,s=e?.itemControl,i=null!=t&&("admin"===s||"update"===s);return P.tsx("calcite-button",{appearance:"outline",class:w.css.saveButton,disabled:!i,iconStart:"save",key:w.css.saveButton,label:this.messagesCommon.save,onclick:()=>{this._handleSaveButtonClick()},width:"full"},this.messagesCommon.save)}_renderSaveAsButton(){if(!this.visibleElements.saveAsButton)return null;const e=null==this.viewModel.layer.routeInfo;return P.tsx("div",{class:w.css.saveAsButtonPopover,key:w.css.saveAsButtonPopover},P.tsx("calcite-button",{afterCreate:e=>{this._saveAsButtonNode=e},appearance:"outline",class:w.css.saveAsButton,disabled:e,iconStart:"duplicate",key:w.css.saveAsButton,label:this.messagesCommon.saveAs,onclick:()=>this._handleSaveAsButtonClick(),width:"full"},this.messagesCommon.saveAs))}_renderSavePopover(){return P.tsx("calcite-popover",{label:this._saveLayer.label,open:this._saveLayer.opened,overlayPositioning:"fixed",referenceElement:this._saveAsButtonNode},this._saveLayer.render())}_handleSaveAsButtonClick(){this._saveLayer.opened?this._saveLayer.close():this._saveLayer.open(this.viewModel.layer)}_renderPrintButton(){return this.visibleElements.printButton?P.tsx("calcite-button",{appearance:"outline",class:w.css.printButton,iconStart:"print",key:w.css.printButton,label:this.messagesCommon.print}):null}_renderRouteLayerDetailsLink(){if(!this.visibleElements.layerDetails)return null;const{portalItem:e}=this.viewModel.layer;if(!e)return null;const{id:t,portal:{url:s}}=e,i=`${s}/home/item.html?id=${t}`;return P.tsx("calcite-link",{class:w.css.layerDetailsLink,href:i,key:w.css.layerDetailsLink,target:"_blank"},this.messages.viewLayerDetails)}_handleSaveButtonClick(){this.viewModel.layer.save()}_renderDirectionsContainer(){return P.tsx("div",{class:this.classes(w.css.directionsSection,w.css.section),key:"esri-directions__container"},this._renderDirectionsContainerContent())}_renderLoader(){return P.tsx("div",{class:w.css.loader,key:"loader"})}_renderWarningCard(){return P.tsx("div",{class:w.css.warningCard,role:"alert"},P.tsx("div",{class:w.css.warningHeader},P.tsx("span",{"aria-hidden":"true",class:x.legacyIcon.noticeTriangle}),P.tsx(C.Heading,{class:w.css.warningHeading,level:this.headingLevel},this.messagesCommon.warning)),P.tsx("div",{class:w.css.warningMessage},this._getErrorMessage()))}_renderDirectionsContainerContent(){const{layer:e,state:t}=this.viewModel,s="routing"===t;return"error"===t?this._renderWarningCard():s?this._renderLoader():null!=e.directionLines?P.tsx("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(w.css.summary,this._saveLayer.opened&&f.globalCss.buttonDisabled),key:"esri-directions__summary",role:"group"},this._renderCosts(),this._renderRouteActions(),this._renderManeuverSections()):P.tsx("div",{class:f.globalCss.empty,key:"esri-directions__placeholder"},this._renderPlaceholder(),P.tsx(C.Heading,{class:w.css.message,level:this.headingLevel},this.messages.directionsPlaceholder))}_renderPlaceholder(){return P.tsx("svg",{class:f.globalCss.emptyIllustration,viewBox:"0 0 256 256",xmlns:"http://www.w3.org/2000/svg"},P.tsx("path",{d:"M192 36c-15.477 0-24 6.034-24 16.99v45.822l24 24 24-24v-45.82C216 42.033 207.477 36 192 36zm20 61.155l-20 20-20-20V52.99c0-8.62 6.73-12.99 20-12.99s20 4.37 20 12.99zM192 52a12 12 0 1 0 12 12 12.013 12.013 0 0 0-12-12zm0 20a8 8 0 1 1 8-8 8.008 8.008 0 0 1-8 8zM92 140.99C92 130.035 83.477 124 68 124s-24 6.034-24 16.99v45.822l24 24 24-24zm-4 44.165l-20 20-20-20V140.99c0-8.62 6.73-12.99 20-12.99s20 4.37 20 12.99zM68 140a12 12 0 1 0 12 12 12.013 12.013 0 0 0-12-12zm0 20a8 8 0 1 1 8-8 8.008 8.008 0 0 1-8 8zm84-44h16v4h-16zm-24 80h4v12h-12v-4h8zm0-28h4v16h-4zm0-52h12v4h-8v8h-4zm0 24h4v16h-4zm-36 64h16v4H92z",fill:"currentcolor"}))}_renderMessage(e){return P.tsx(C.Heading,{class:w.css.messageHeading,level:this.headingLevel},e)}_renderRouteActions(){return P.tsx("div",{class:w.css.routeActions},P.tsx("button",{"aria-label":this.messages.clearRoute,bind:this,class:this.classes(w.css.clearRouteButton,f.globalCss.button,f.globalCss.buttonTertiary),onclick:this._handleClearRouteClick,tabIndex:0,type:"button"},this.messages.clearRoute))}_getSections(){const{layer:e}=this.viewModel;if(!e)return null;const{directionPoints:t,directionLines:s,stops:i}=e;if(null==t||null==s)return null;const r=[];let o=null;for(const n of t){const{objectId:e,stopId:t}=n;if(null!=t){const e=i.find((({objectId:e})=>e===t)),s=0===r.length;null!=o&&o.stop===e||(o={stop:e,directions:[],open:s},r.push(o));continue}if(null==o)continue;const a=s.find((({directionPointId:t})=>t===e));null!=a&&o.directions.push({directionPoint:n,directionLine:a})}return r}_renderManeuverSections(){return null==this._sections?null:P.tsx("div",{class:w.css.maneuvers,role:"group"},this._sections.map(((e,t)=>{const{open:s}=e;let i;e.directions.length>0&&s&&(i=P.tsx("ol",{class:w.css.maneuverList},e.directions.map((e=>this._renderManeuver(e)))));const r=this._sections.length>2,o=t===this._sections.length-1,n={[w.css.collapsibleSection]:r},a={[x.legacyIcon.down]:!s,[x.legacyIcon.up]:s};let l;if(r&&!o){const t=s?this.messagesCommon.close:this.messagesCommon.open;l=P.tsx("header",{class:this.classes(w.css.maneuverSectionHeader,w.css.maneuverSectionToggle),key:w.css.maneuverSectionHeader},P.tsx("div",{"aria-expanded":s.toString(),"aria-label":t,bind:this,class:w.css.maneuverSectionHeaderButton,"data-maneuver-section":e,onclick:this._handleSectionToggle,onkeydown:this._handleSectionToggle,role:"button",tabIndex:0,title:t},P.tsx(C.Heading,{class:w.css.maneuverSectionTitle,level:this.headingLevel},e.stop.name),P.tsx("span",{"aria-hidden":"true",class:this.classes(a)})))}else l=P.tsx("header",{class:w.css.maneuverSectionHeader,key:w.css.maneuverSectionHeader},P.tsx(C.Heading,{class:w.css.maneuverSectionTitle,level:this.headingLevel},e.stop.name));return P.tsx("section",{class:this.classes(w.css.maneuverSection,n),key:t},l,i)})))}_handleSectionToggle(e){const t=q(e.currentTarget);t&&(t.open=!t.open)}_renderCosts(){const e=this._getCostSummary(),{directionPoints:t}=this.viewModel.layer;if(null==t||null==e)return null;const{distance:s,duration:i}=e,{primaryCosts:r,secondaryCosts:o,zoomToRoute:n}=this.messages,a=this._renderEta();return P.tsx("div",{"aria-label":n,bind:this,class:w.css.directionCosts,onclick:this._handleSummaryInteraction,onkeydown:this._handleSummaryInteraction,role:"button",tabIndex:0,title:n},P.tsx("div",{class:w.css.costsDetails,role:"group"},P.tsx("div",{class:w.css.primaryCosts,title:r},i),P.tsx("div",{class:w.css.verticalSplitter}),P.tsx("div",{class:w.css.secondaryCosts,title:o},s)),a)}_renderEta(){const{directionPoints:e}=this.viewModel.layer,{eta:t}=this.messages;if(null==e)return null;const s=e.at(-1).arrivalTime,i=B.convertDateFormatToIntlOptions("short-time");return s&&this._departureTimeOption!==w.DepartureTimeOption.UNSPECIFIED?P.tsx("div",{class:w.css.arrivalTimeContainer,title:t},P.tsx("span",{class:w.css.arrivalTime},B.formatDate(s,i))," ",A(s)):null}_handleSummaryInteraction(){this._activeManeuver=null,this._focusedManeuver=null,this.viewModel.clearHighlights(),this.zoomToRoute()}_getErrorMessage(){switch(this.viewModel.lastError?.name){case"directions-view-model:unable-to-route":return this.messages.errors.unableToRoute;case"directions-view-model:service-metadata-unavailable":return this.messages.errors.unableToLoadServiceMetadata;default:return this.messages.errors.unknownError}}_normalizeSearchSources(e){this._overrideDefaultSources(e),this._applyLocatorSourceOverrides(e)}_overrideDefaultSources(e){e.viewModel.defaultSources.forEach((e=>{e.autoNavigate=!1}))}_applyLocatorSourceOverrides({allSources:e}){for(const t of e)"url"in t&&t.url&&(t.locationType??(t.locationType="street"),b.isArcGISWorldGeocoder(t.url)&&this.apiKey&&null==t.apiKey&&(t.apiKey=this.apiKey,t.url=b.meteredArcGISLocatorUrl))}_disposeSearch(e){if(!e||!this._stopsToSearches.has(e))return;const t=this._stopsToSearches.get(e);this.removeHandles(t),t.destroy(),this._stopsToSearches.delete(e)}_renderManeuver(e){const{directionPoint:t,directionLine:s}=e,{distance:i,duration:r}=s,{messages:o,messagesUnits:n,unit:a}=this,l=S.formatDistance(n,i??0,a),c=S.formatDuration(r??0),d=l&&c?`${l}&nbsp;&middot;&nbsp;${c}`:`${l}${c}`,u=this._getFormattedManeuverText(t),{objectId:h,directionPointType:p}=t,v=w.getIconName(p),m=`esri-directions__maneuver-${h}`,_=`esri-directions__intermediate-costs-${h}`,g={[w.css.maneuverActive]:this._activeManeuver===s};return P.tsx("li",{"aria-labelledby":`${m} ${_}`,bind:this,class:this.classes(w.css.maneuver,g),"data-maneuver":s,key:s,onblur:this._handleManeuverBlur,onclick:this._handleManeuverClick,onfocus:this._handleManeuverFocus,onkeydown:this._handleManeuverClick,onmouseout:this._handleManeuverMouseOut,onmouseover:this._handleManeuverMouseOver,tabIndex:0},v?P.tsx("calcite-icon",{alt:"",class:w.css.maneuverIcon,icon:v}):null,P.tsx("div",{class:w.css.maneuverCostsContainer},P.tsx("span",{id:m,innerHTML:u??""}),P.tsx("div",{class:w.css.maneuverCosts},P.tsx("div",{class:w.css.horizontalSplitter}),P.tsx("div",{"aria-hidden":"true",class:w.css.intermediateCost,id:_,innerHTML:d,title:o.intermediateCosts}))))}_handleManeuverClick(e){const t=K(e.currentTarget);if(!t)return;if(this._activeManeuver===t)return this._activeManeuver=null,void this.zoomToRoute();this._activeManeuver=t;const{geometry:s}=t;this.viewModel.centerAt(s),this.viewModel.highlight(t)}_handleManeuverMouseOver(e){if(this._activeManeuver||this._focusedManeuver)return;const t=K(e.currentTarget);t&&this.viewModel.highlight(t)}_handleManeuverMouseOut(){this._activeManeuver||this._focusedManeuver||this.viewModel.clearHighlights()}_handleManeuverBlur(){this._activeManeuver||(this._focusedManeuver=null,this.viewModel.clearHighlights())}_handleManeuverFocus(e){if(this._activeManeuver)return;const t=K(e.currentTarget);t&&(this._focusedManeuver=t,this.viewModel.highlight(t))}_getFormattedManeuverText(e){const{displayText:t,name:s,intersectingName:i}=e;if(null==t)return"";let r=t;return null!=s&&r.includes(s)&&(r=r.replace(s,`<strong>${s}</strong>`)),null!=i&&r.includes(i)&&(r=r.replace(i,`<strong>${i}</strong>`)),r}_getCostSummary(){const{messagesUnits:e,unit:t,viewModel:s}=this,{routeInfo:i}=s.layer;if(null==i)return null;const r=i.totalDistance??0,o=i.totalDuration??0;return{distance:S.formatDistance(e,r,t),duration:S.formatDuration(o)}}async _getDirections(){const e=this.viewModel.layer?.stops.filter((({geometry:e})=>null!=e));if(e&&!(e.length<2))try{await this.viewModel.getDirections()}catch{}}};t.__decorate([a.property()],F.prototype,"apiKey",null),t.__decorate([a.property(h.defaultUnitPropertyMetadata)],F.prototype,"defaultUnit",void 0),t.__decorate([a.property()],F.prototype,"goToOverride",null),t.__decorate([a.property()],F.prototype,"headingLevel",void 0),t.__decorate([a.property()],F.prototype,"iconClass",void 0),t.__decorate([a.property()],F.prototype,"icon",void 0),t.__decorate([a.property()],F.prototype,"label",null),t.__decorate([a.property({readOnly:!0})],F.prototype,"lastRoute",null),t.__decorate([a.property()],F.prototype,"layer",null),t.__decorate([a.property()],F.prototype,"maxStops",null),t.__decorate([a.property(),I.messageBundle("esri/widgets/Directions/t9n/Directions")],F.prototype,"messages",void 0),t.__decorate([a.property(),I.messageBundle("esri/t9n/common")],F.prototype,"messagesCommon",void 0),t.__decorate([a.property(),I.messageBundle("esri/core/t9n/Units")],F.prototype,"messagesUnits",void 0),t.__decorate([a.property()],F.prototype,"searchProperties",void 0),t.__decorate([a.property()],F.prototype,"unit",null),t.__decorate([a.property()],F.prototype,"view",null),t.__decorate([a.property({type:g})],F.prototype,"viewModel",void 0),t.__decorate([a.property()],F.prototype,"visibleElements",void 0),t.__decorate([l.cast("visibleElements")],F.prototype,"castVisibleElements",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleStopIconClick",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleClearRouteClick",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleReverseStops",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleRemoveStop",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleSectionToggle",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleSummaryInteraction",null),t.__decorate([k.accessibleHandler()],F.prototype,"_handleManeuverClick",null),F=t.__decorate([u.subclass("esri.widgets.Directions")],F);function V(e){return e?.["data-mode"]}function W(e){return e?.["data-stop-index"]}function q(e){return e?.["data-maneuver-section"]}function K(e){return e?.["data-maneuver"]}return F}));
