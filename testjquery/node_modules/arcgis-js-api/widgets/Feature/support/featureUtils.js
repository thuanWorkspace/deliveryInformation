/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/string","../../../intl/date","../../../intl/number","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../smartMapping/support/utils","../../../support/arcadeOnDemand","../../../time/timeZoneUtils"],(function(e,t,n,r,i,o,a,l,u,s){"use strict";const f="esri.widgets.Feature.support.featureUtils",c=t.getLogger(f),d=/href=(""|'')/gi,p=/(\{([^\{\r\n]+)\})/g,m=/\'/g,y=/^\s*expression\//i,g=/(\n)/gi,b=/[\u00A0-\u9999<>\&]/gim,I=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,F=/^(?:mailto:|tel:)/,h="relationships/",T=r.convertDateFormatToIntlOptions("short-date-short-time");function N(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0}async function w(e,t){return"function"==typeof e?e(t):e}function L(e=""){if(e)return!F.test(e.trim().toLowerCase())}function A(e){return!!e&&y.test(e)}function Z(e,t){if(!A(t)||!e)return null;const n=t.replace(y,"").toLowerCase();let r=null;return e.some((e=>e.name.toLowerCase()===n&&(r=e,!0))),r}function x(e,t){const n=Z(t,e?.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function E(e,t){const n=t.get(e.toLowerCase());return`{${n?.fieldName||e}}`}function R(e){return e.replaceAll(d,"")}function v(e,t){const n=M(t,e);return n?n.name:e}function C(e,t){return e&&e.map((e=>v(e,t)))}function M(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function q(e){return`${e}`.trim()}function U({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:i,fieldInfoMap:o}){return r?j({formattedAttributes:t,template:S(r,{...t,...i,...e},n),fieldInfoMap:o}):""}function j({formattedAttributes:e,template:t,fieldInfoMap:r}){return q(R(n.replace(n.replace(t,(e=>E(e,r))),e)))}function D(e,t,n=!1){const r=t[e];if("string"==typeof r){const i="%27",o=(n?encodeURIComponent(r):r).replaceAll(m,i);t[e]=o}}function O(e,t=!1){const n={...e};return Object.keys(n).forEach((e=>D(e,n,t))),n}function k(e,t,r){const i=(t=q(t))&&"{"!==t[0];return n.replace(e,O(r,i||!1))}function $(e,t){return e.replaceAll(p,((e,n,r)=>{const i=M(t,r);return i?`{${i.name}}`:n}))}function S(e,t,n){const r=$(e,n);return r?r.replaceAll(I,((e,n,r)=>k(e,n||r,t))):r}function z(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}function G(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type)&&"when"in e}function P(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function H(e){return G(e)&&P(e)}function Q(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&H(e.sourceLayer)}function V(e,t){const{fieldInfos:n,fieldName:r,preventPlacesFormatting:a,layer:u,timeZone:s}=t,f=B(n,r),c=M(u,r);if(f&&!o.isRasterPixelValueField(r)){const t=c?.type,n=f.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||n)return l.formatAnyDate(e,{format:n,fieldType:t,timeZoneOptions:{layerTimeZone:u&&"preferredTimeZone"in u?u.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!u||!("datesInUnknownTimezone"in u))&&!!u.datesInUnknownTimezone}})}const d=f?.format;return"string"==typeof e&&o.isRasterPixelValueField(r)&&d?_(e,d):"string"==typeof(e=z(e,d))||null==e||null==d?ne(e):a?i.formatNumber(e,{...i.convertNumberFormatToIntlOptions(d),minimumFractionDigits:0,maximumFractionDigits:20}):i.formatNumber(e,i.convertNumberFormatToIntlOptions(d))}function _(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?K(e,",",", ",t):e.includes(";")?K(e,";","; ",t):e.includes(" ")?K(e," "," ",t):i.formatNumber(Number(e),i.convertNumberFormatToIntlOptions(t))}function K(e,t,n,r){return e.trim().split(t).map((e=>i.formatNumber(Number(e),i.convertNumberFormatToIntlOptions(r)))).join(n)}function B(e,t){if(e?.length&&t)return e.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))}function J({fieldName:e,graphic:t,layer:n}){if(ue(e))return null;if(!n||"function"!=typeof n.getFeatureType)return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const i=n.getFeatureType(t);return i?i.name:null}function W({fieldName:e,value:t,graphic:n,layer:r}){if(ue(e))return null;if(!r||"function"!=typeof r.getFieldDomain)return null;const i=n&&r.getFieldDomain(e,{feature:n});return i&&"coded-value"===i.type?i.getName(t):null}function X(e,t,n,i){const{creatorField:o,creationDateField:a,editorField:l,editDateField:u}=e;if(!t)return;const f=s.getTimeZoneFormattingOptions(i&&"preferredTimeZone"in i?i.preferredTimeZone:null,!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone,n,T,"date"),c={...T,...f},d=t[u];if("number"==typeof d){const e=t[l];return{type:"edit",date:r.formatDate(d,c),user:e}}const p=t[a];if("number"==typeof p){const e=t[o];return{type:"create",date:r.formatDate(p,c),user:e}}return null}function Y(e,t){const n=new Map;return e?(e.forEach((e=>{const r=v(e.fieldName,t);e.fieldName=r,n.set(r.toLowerCase(),e)})),n):n}function ee(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)?(r.forEach((e=>{if("fields"===e.type){const n=e?.fieldInfos;n&&t.push(...n)}})),t):t}function te(e){return e.replaceAll(b,(e=>`&#${e.charCodeAt(0)};`))}function ne(e){return"string"==typeof e?e.replaceAll(g,'<br class="esri-text-new-line" />'):e}function re(e){const{value:t,fieldName:n,fieldInfos:r,fieldInfoMap:i,layer:a,graphic:u,timeZone:s}=e;if(null==t)return"";const f=W({fieldName:n,value:t,graphic:u,layer:a});if(f)return f;const c=J({fieldName:n,graphic:u,layer:a});if(c)return c;if(i.get(n.toLowerCase()))return V(t,{fieldInfos:r||Array.from(i.values()),fieldName:n,layer:a,timeZone:s});const d=a?.fieldsIndex?.get(n);return d&&(l.isAnyDateField(d)||o.isTimeOnlyField(d))?l.formatAnyDate(t,{fieldType:d.type,timeZoneOptions:{layerTimeZone:a&&"preferredTimeZone"in a?a.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!a||!("datesInUnknownTimezone"in a))&&!!a.datesInUnknownTimezone}}):ne(t)}function ie({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:i,relatedInfos:o,timeZone:a}){const l={};return o?.forEach((t=>ce({attributes:l,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:n,timeZone:a}))),t&&Object.keys(t).forEach((o=>{const u=t[o];l[o]=re({fieldName:o,fieldInfos:e,fieldInfoMap:i,layer:n,value:u,graphic:r,timeZone:a})})),l}async function oe(e,t){const{layer:n,graphic:r,outFields:i,objectIds:o,returnGeometry:l,spatialReference:u}=e,s=o[0];if("number"!=typeof s&&"string"!=typeof s){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:n,graphic:r,objectId:s,requiredFields:i};return c.warn(e,t),null}if(!a.getEffectiveLayerCapabilities(n)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:n,graphic:r,requiredFields:i,returnGeometry:l};return c.warn(e,t),null}const f=n.createQuery();f.objectIds=o,f.outFields=i?.length?i:[n.objectIdField],f.returnGeometry=!!l,f.returnZ=!!l,f.returnM=!!l,f.outSpatialReference=u;return(await n.queryFeatures(f,t)).features[0]}async function ae(e){if(!e.expressionInfos?.length)return!1;const t=await u.loadArcade(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}async function le({graphic:e,popupTemplate:t,layer:n,spatialReference:r},i){if(!n||!t)return;if("function"==typeof n.load&&await n.load(i),!e.attributes)return;const a=e.attributes[n.objectIdField];if(null==a)return;const l=[a],u=await t.getRequiredFields(n.fieldsIndex),s=o.featureHasFields(u,e),f=s?[]:u,c=t.returnGeometry||await ae(t);if(s&&!c)return;const d=await oe({layer:n,graphic:e,outFields:f,objectIds:l,returnGeometry:c,spatialReference:r},i);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function ue(e=""){return!!e&&e.includes(h)}function se(e){return e?`${h}${e.layerId}/${e.fieldName}`:""}function fe({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:i,layer:o,timeZone:a}){e&&t&&n&&Object.keys(t.attributes).forEach((l=>{const u=se({layerId:n.relation.id.toString(),fieldName:l}),s=t.attributes[l];e[u]=re({fieldName:u,fieldInfos:r,fieldInfoMap:i,layer:o,value:s,graphic:t,timeZone:a})}))}function ce({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}){e&&t&&(t.relatedFeatures?.forEach((a=>fe({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}))),t.relatedStatsFeatures?.forEach((a=>fe({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}))))}const de=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},pe=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=n.where?n.where:null,o=null!=n.geometry?n.geometry:null;de(r)||de(i)||"extent"===o?.type||"tile"===n.resultType||(n.cacheHint=!0)},me=({query:e,layer:t,method:n})=>{pe({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},ye=({queryPayload:e,layer:t,method:n})=>{pe({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})};function ge(e,t,n){return e&&t&&n?be(e.allLayers,t,n)||be(e.allTables,t,n):null}function be(e,t,n){const r="scene"===t.type&&t.associatedLayer?t.associatedLayer.url:t.url;return e.filter(H).find((e=>e!==t&&e.url===r&&e.layerId===n.relatedTableId))}function Ie(e){const t=e.getObjectId();return null!=t?`oid:${t}`:`uid:${e.uid}`}e.applyTextFormattingHTML=ne,e.createfieldInfoMap=Y,e.findRelatedLayer=ge,e.fixTokens=$,e.formatAttributes=ie,e.formatEditInfo=X,e.formatValueToFieldInfo=V,e.getAllFieldInfos=ee,e.getFieldInfo=B,e.getFieldInfoLabel=x,e.getFixedFieldName=v,e.getFixedFieldNames=C,e.getHighlightKeyForFeature=Ie,e.getSourceLayer=N,e.graphicCallback=w,e.htmlEntities=te,e.isExpressionField=A,e.isFeatureSupportedLayer=G,e.isGraphicForRelatableFeatureSupportedLayer=Q,e.isRelatableFeatureSupportedLayer=H,e.isRelatableLayer=P,e.isRelatedField=ue,e.preLayerQueryCallback=me,e.preRequestCallback=ye,e.querySourceLayer=oe,e.queryUpdatedFeature=le,e.shouldOpenInNewTab=L,e.substituteAttributes=j,e.substituteFieldsInLinksAndAttributes=U,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
