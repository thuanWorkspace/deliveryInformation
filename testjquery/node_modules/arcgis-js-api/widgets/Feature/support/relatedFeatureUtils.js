/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../request","../../../core/arrayUtils","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../core/has","../../../layers/support/source/DataLayerSource","../../../rest/query/executeQueryJSON","../../../config","../../../kernel","../../../core/urlUtils","../../../core/unitUtils","../../../geometry/ellipsoidUtils","../../../geometry/support/spatialReferenceUtils","../../../layers/graphics/featureConversionUtils","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../geometry/support/normalizeUtils","../../../core/pbf","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../rest/query/support/AttachmentInfo","../../../rest/support/AttachmentQuery","../../../geometry","../../../rest/support/RelationshipQuery","../../../rest/support/TopFeaturesQuery","../../../rest/support/StatisticDefinition","./featureUtils"],(function(e,t,r,i,s,o,n,a,l,u,c,d,f,p,y,g,h,F,I,S,m,w,b,R,q,N,O,U,$,v,T,A,j,J){"use strict";const L="esri.widgets.Feature.support.relatedFeatureUtils",Q=s.getLogger(L),x=new Map;function P(e){if(!J.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}function C(e,t){if(!t.relationships)return null;let r=null;const{relationships:i}=t;return i.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function k({originRelationship:e,relationships:t,layerId:r}){let i=null;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e?.id&&(i=t),!!i))),i}function D(e,t){const r=t.toLowerCase();for(const i in e)if(i.toLowerCase()===r)return e[i];return null}function E(e,t){const r=C(e,t);if(!r)return;return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function M(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:i}=e,s=r?.value;t.relatedFeatures=s?s.features:[];const o=i?.value;t.relatedStatsFeatures=o?o.features:[]}function z(e,t,r,i){const s=new T;return s.outFields=["*"],s.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),s.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures?.(s,i)??Promise.resolve({})}function G(e,t,r){let i=0;const s=[];for(;i<t.length;)s.push(`${e} IN (${t.slice(i,r+i)})`),i+=r;return s.join(" OR ")}function B(e){return e?r.unique(e):void 0}function H(e){return e?r.unique(e,((e,t)=>JSON.stringify(e.toJSON())===JSON.stringify(t.toJSON()))):void 0}async function K(e,t,r,i){const s=r.layerId.toString(),{layerInfo:a,relation:l,relatedFields:c,outStatistics:d,url:f,sourceSpatialReference:p}=t,y=B(c),g=H(d);if(!a||!l)return null;const h=k({originRelationship:l,relationships:a.relationships,layerId:s});if(h?.relationshipTableId&&h.keyFieldInRelationshipTable){const t=(await z(e,h,r,i))[e.attributes[r.objectIdField]];if(!t)return null;const s=t.features.map((e=>e.attributes[a.objectIdField]));if(g?.length&&a.supportsStatistics){const e=new O;e.where=G(a.objectIdField,s,1e3),e.outFields=y,e.outStatistics=g,e.sourceSpatialReference=p;const r={features:Promise.resolve(t),statsFeatures:u.executeQueryJSON(f,e)};return o.eachAlways(r)}}const F=h?.keyField;if(F){const t=n.isNumericField(Z(a.fields,F)),r=D(e.attributes,l.keyField),s=t?`${F}=${r}`:`${F}='${r}'`,c=u.executeQueryJSON(f,new O({where:s,outFields:y,sourceSpatialReference:p}),i),d=!!g?.length&&a.supportsStatistics?u.executeQueryJSON(f,new O({where:s,outFields:y,outStatistics:g,sourceSpatialReference:p}),i):null,h={features:c};return d&&(h.statsFeatures=d),o.eachAlways(h)}return null}function V(e,r){return t(e,{query:{f:"json"},signal:r?.signal})}function W({relatedInfos:e,layer:t},r){const s={};return e.forEach(((e,r)=>{const{relation:o}=e;if(!o){const e=new i("relation-required","A relation is required on a layer to retrieve related records.");throw Q.error(e),e}const{relatedTableId:n}=o;if("number"!=typeof n){const e=new i("A related table ID is required on a layer to retrieve related records.");throw Q.error(e),e}const a=`${t.url}/${n}`,l=x.get(a),u=l??V(a);l||x.set(a,u),s[r]=u})),o.whenOrAbort(o.eachAlways(s),r)}function X({graphic:e,relatedInfos:t,layer:r},i){const s={};return t.forEach(((t,o)=>{t.layerInfo&&(s[o]=K(e,t,r,i))})),o.eachAlways(s)}function Y({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const i=new j({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(i)}}function Z(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}e.createRelatedInfo=E,e.getDestinationRelation=k,e.getRelatedFieldInfo=P,e.getUniqueOutFields=B,e.getUniqueOutStatistics=H,e.queryLayerInfos=W,e.queryRelatedFeatures=X,e.setRelatedFeatures=M,e.updateRelatedInfo=Y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
