/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/LineSeries","../../../chunks/Theme","../../../chunks/tslib.es6","../../../chunks/Button"],(function(t,e,i,s,a){"use strict";class n extends e.XYSeries{constructor(){super(...arguments),Object.defineProperty(this,"_ph",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_pw",{enumerable:!0,configurable:!0,writable:!0,value:0})}_makeGraphics(t,e){return this.makeColumn(e,t)}_makeFieldNames(){super._makeFieldNames();const t=this.get("xAxis"),e=this.get("yAxis"),i="CategoryAxis",s="ValueAxis";t.isType(i)&&(this.get("openCategoryXField")||(this._xOpenField=this._xField)),t.isType(s)&&(this.get("openValueXField")||(this._xOpenField=this._xField)),e.isType(i)&&(this.get("openCategoryYField")||(this._yOpenField=this._yField)),e.isType(s)&&(this.get("openValueYField")||(this._yOpenField=this._yField))}_prepareChildren(){super._prepareChildren();const t=this.get("xAxis"),e=this.get("yAxis"),i=this.dataItems.length,s=Math.max(0,this.startIndex()-2),a=Math.min(this.endIndex()+2,i-1);if(t.inited&&e.inited)for(let n=s;n<=a;n++){let t=this.dataItems[n];this._createGraphics(t)}}_updateChildren(){const t=this.chart;t&&(this._ph=t.plotContainer.height(),this._pw=t.plotContainer.width());const e=this.get("xAxis"),s=this.get("yAxis"),a=this.get("baseAxis"),o=this.columns.template;this.isDirty("fill")&&null==o.get("fill")&&o.set("fill",this.get("fill")),this.isDirty("stroke")&&null==o.get("stroke")&&o.set("stroke",this.get("stroke"));let r=0,h=0,l=0;i.each(a.series,(t=>{if(t instanceof n){const e=t.get("stacked");e&&0==l&&h++,!e&&t.get("clustered")&&h++}t===this&&(r=h-1),l++})),this.get("clustered")||(r=0,h=1),0===h&&(h=1,r=0);const g=e.get("renderer"),d=s.get("renderer"),c="cellStartLocation",m="cellEndLocation",u=g.get(c,0),p=g.get(m,1),x=d.get(c,0),_=d.get(m,1);if(this._aLocationX0=u+r/h*(p-u),this._aLocationX1=u+(r+1)/h*(p-u),this._aLocationY0=x+r/h*(_-x),this._aLocationY1=x+(r+1)/h*(_-x),e.inited&&s.inited){if(this._axesDirty||this._valuesDirty||this._stackDirty||this.isDirty("vcx")||this.isDirty("vcy")||this._sizeDirty){const t=this.dataItems.length;let e=Math.max(0,this.startIndex()-2),i=Math.min(this.endIndex()+2,t-1);for(let a=0;a<e;a++)this._toggleColumn(this.dataItems[a],!1);let s=this.dataItems[e];for(let a=e;a<=i;a++){let t=this.dataItems[a];if(null!=t.get("valueX")&&null!=t.get("valueY")){if(s=t,a>0&&e>0)for(let t=a-1;t>=0;t--){let e=this.dataItems[t];if(null!=e.get("valueX")&&null!=e.get("valueY")){s=e;break}}break}this._toggleColumn(t,!1)}for(let a=e;a<=i;a++){let t=this.dataItems[a];this._updateGraphics(t,s),null!=t.get("valueX")&&null!=t.get("valueY")&&(s=t)}for(let a=i+1;a<t;a++)this._toggleColumn(this.dataItems[a],!1)}}else this._skipped=!0;this.updateLegendMarker(this.get("tooltipDataItem")),super._updateChildren()}_createGraphics(t){let e=t.get("graphics");if(!e){e=this._makeGraphics(this.columns,t),t.set("graphics",e),e._setDataItem(t);const i=t.get("legendDataItem");if(i){const t=i.get("markerRectangle");t&&t.setAll({fill:e.get("fill"),stroke:e.get("stroke")})}this.axisRanges.each((e=>{const i=e.container,s=t.get("rangeGraphics",[]);t.set("rangeGraphics",s);const a=this._makeGraphics(e.columns,t);s.push(a),a.setPrivate("list",e.columns),i.children.push(a)}))}}_updateGraphics(t,e){let s=t.get("graphics");const a=this._xField,n=this._yField,o=t.get(a),r=t.get(n);if(null!=o&&null!=r){const o=this._xOpenField,r=this._yOpenField,h=this.get("locationX",t.get("locationX",.5)),l=this.get("locationY",t.get("locationY",.5)),g=this.get("openLocationX",t.get("openLocationX",h)),d=this.get("openLocationY",t.get("openLocationY",l)),c=s.get("width"),m=s.get("height"),u=this.get("stacked"),p=this.get("xAxis"),x=this.get("yAxis"),_=this.get("baseAxis"),I=p.get("start"),y=p.get("end"),f=x.get("start"),b=x.get("end");let P,T,v,D,A=this.get("vcy",1),C=this.get("vcx",1),w=!1,k=!1;if(x.isType("CategoryAxis")&&p.isType("CategoryAxis")){let e=this._aLocationX0+g-.5,s=this._aLocationX1+h-.5;if(c instanceof i.Percent){let t=(s-e)*(1-c.value)/2;e+=t,s-=t}if(P=p.getDataItemPositionX(t,o,e,C),T=p.getDataItemPositionX(t,a,s,C),e=this._aLocationY0+d-.5,s=this._aLocationY1+l-.5,m instanceof i.Percent){let t=(s-e)*(1-m.value)/2;e+=t,s-=t}v=x.getDataItemPositionY(t,r,e,A),D=x.getDataItemPositionY(t,n,s,A),t.setRaw("point",{x:P+(T-P)/2,y:v+(D-v)/2})}else if(p===_){let e=this._aLocationX0+g-.5,s=this._aLocationX1+h-.5;if(c instanceof i.Percent){let t=(s-e)*(1-c.value)/2;e+=t,s-=t}if(P=p.getDataItemPositionX(t,o,e,C),T=p.getDataItemPositionX(t,a,s,C),v=x.getDataItemPositionY(t,n,l,A),this._yOpenField!==this._yField)D=x.getDataItemPositionY(t,r,d,A);else if(u){let e=t.get("stackToItemY");D=e?x.getDataItemPositionY(e,n,d,e.component.get("vcy")):x.basePosition()}else D=x.basePosition();t.setRaw("point",{x:P+(T-P)/2,y:v}),k=!0}else if(x===_){let e=this._aLocationY0+d-.5,s=this._aLocationY1+l-.5;if(m instanceof i.Percent){let t=(s-e)*(1-m.value)/2;e+=t,s-=t}if(v=x.getDataItemPositionY(t,r,e,A),D=x.getDataItemPositionY(t,n,s,A),T=p.getDataItemPositionX(t,a,h,C),this._xOpenField!==this._xField)P=p.getDataItemPositionX(t,o,g,C);else if(u){let e=t.get("stackToItemX");P=e?p.getDataItemPositionX(e,a,g,e.component.get("vcx")):p.basePosition()}else P=p.basePosition();w=!0,t.setRaw("point",{x:T,y:v+(D-v)/2})}this._updateSeriesGraphics(t,s,P,T,v,D,w,k),P<I&&T<I||P>y&&T>y||v<f&&D<=f||v>=b&&D>b||i.isNaN(P)||i.isNaN(v)?this._toggleColumn(t,!1):this._toggleColumn(t,!0);let F=t.get("rangeGraphics");F&&i.each(F,(e=>{this._updateSeriesGraphics(t,e,P,T,v,D,w,k)})),this._applyGraphicsStates(t,e)}}_updateSeriesGraphics(t,e,s,a,n,o,r,h){const l=e.get("width"),g=e.get("height"),d=e.get("maxWidth"),c=e.get("maxHeight"),m=this.getPoint(s,n),u=this.getPoint(a,o),p=t.get("point");if(p){const t=this.getPoint(p.x,p.y);p.x=t.x+this._x,p.y=t.y+this._y}if(s=m.x,a=u.x,n=m.y,o=u.y,i.isNumber(l)){const t=(a-s-l)/2;s+=t,a-=t}if(i.isNumber(d)&&d<Math.abs(a-s)){const t=(a-s-d)/2;s+=t,a-=t}if(i.isNumber(g)){const t=(o-n-g)/2;n+=t,o-=t}if(i.isNumber(c)&&c<Math.abs(o-n)){const t=(o-n-c)/2;n+=t,o-=t}this.get("adjustBulletPosition")&&(r&&(a=Math.min(Math.max(0,a),this._pw),s=Math.min(Math.max(0,s),this._pw)),h&&(n=Math.min(Math.max(0,n),this._ph),o=Math.min(Math.max(0,o),this._ph))),t.setRaw("left",s),t.setRaw("right",a),t.setRaw("top",n),t.setRaw("bottom",o),e.setPrivate("width",a-s),e.setPrivate("height",o-n),e.set("x",s),e.set("y",o-(o-n))}_handleDataSetChange(){super._handleDataSetChange(),i.each(this._dataItems,(t=>{this._toggleColumn(t,!1)}))}_applyGraphicsStates(t,e){const s=t.get("graphics"),a=s.states.lookup("dropFromOpen"),n=s.states.lookup("riseFromOpen"),o=s.states.lookup("dropFromPrevious"),r=s.states.lookup("riseFromPrevious");if(a||o||n||r){const s=this.get("xAxis"),h=this.get("yAxis"),l=this.get("baseAxis");let g,d,c;l===s&&h.isType("ValueAxis")?(g=t.get(this._yOpenField),d=t.get(this._yField),c=e.get(this._yField)):l===h&&s.isType("ValueAxis")&&(g=t.get(this._xOpenField),d=t.get(this._xField),c=e.get(this._xField)),i.isNumber(g)&&i.isNumber(d)&&(d<g?a&&a.apply():n&&n.apply(),i.isNumber(c)&&(d<c?o&&o.apply():r&&r.apply()))}}disposeDataItem(t){super.disposeDataItem(t);const e=t.get("graphics");e&&(this.columns.removeValue(e),e.dispose());const s=t.get("rangeGraphics");s&&i.each(s,(t=>{const e=t.getPrivate("list");e&&e.removeValue(t),t.dispose()}))}hideDataItem(t,e){const a=Object.create(null,{hideDataItem:{get:()=>super.hideDataItem}});return s.__awaiter(this,void 0,void 0,(function*(){const s=[a.hideDataItem.call(this,t,e)],n=t.get("graphics");n&&s.push(n.hide(e));const o=t.get("rangeGraphics");o&&i.each(o,(t=>{s.push(t.hide(e))})),yield Promise.all(s)}))}_toggleColumn(t,e){const s=t.get("graphics");s&&s.setPrivate("visible",e);const a=t.get("rangeGraphics");a&&i.each(a,(t=>{t.setPrivate("visible",e)}));const n=t.bullets;n&&i.each(n,(t=>{t.setPrivate("hidden",!e)}))}showDataItem(t,e){const a=Object.create(null,{showDataItem:{get:()=>super.showDataItem}});return s.__awaiter(this,void 0,void 0,(function*(){const s=[a.showDataItem.call(this,t,e)],n=t.get("graphics");n&&s.push(n.show(e));const o=t.get("rangeGraphics");o&&i.each(o,(t=>{s.push(t.show(e))})),yield Promise.all(s)}))}updateLegendMarker(t){let e=this.get("legendDataItem");if(this.get("useLastColorForLegendMarker")&&!t){const e=this.dataItems[this.endIndex()-1];e&&(t=e)}if(e){let s=this.columns.template;if(t){let e=t.get("graphics");e&&(s=e)}const a=e.get("markerRectangle");a&&(e.get("itemContainer").get("disabled")||i.each(i.visualSettings,(t=>{a.set(t,s.get(t,this.get(t)))})))}}_getTooltipTarget(t){if("bullet"==this.get("seriesTooltipTarget"))return super._getTooltipTarget(t);let e=t.get("graphics");return e||this}}Object.defineProperty(n,"className",{enumerable:!0,configurable:!0,writable:!0,value:"BaseColumnSeries"}),Object.defineProperty(n,"classNames",{enumerable:!0,configurable:!0,writable:!0,value:e.XYSeries.classNames.concat([n.className])});class o extends e.Axis{constructor(){super(...arguments),Object.defineProperty(this,"_frequency",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"_itemMap",{enumerable:!0,configurable:!0,writable:!0,value:{}})}_afterNew(){this._settings.themeTags=i.mergeTags(this._settings.themeTags,["axis"]),this.fields.push("category"),this.setPrivateRaw("name","category"),this.addTag("category"),super._afterNew()}_prepareChildren(){super._prepareChildren();const t=this.dataItems.length;let e=0;this._valuesDirty&&(this._itemMap={},i.each(this.dataItems,(t=>{t.setRaw("index",e),this._itemMap[t.get("category")]=t,e++})),this.setPrivateRaw("maxZoomFactor",t)),this.setPrivateRaw("startIndex",Math.max(Math.round(this.get("start",0)*t),0)),this.setPrivateRaw("endIndex",Math.min(Math.round(this.get("end",1)*t),t)),(this._sizeDirty||this._valuesDirty||this.isDirty("start")||this.isDirty("end")||this.isPrivateDirty("endIndex")||this.isPrivateDirty("startIndex")||this.isPrivateDirty("width")||this.isPrivateDirty("height"))&&this.dataItems.length>0&&(this._handleRangeChange(),this._prepareAxisItems(),this._updateAxisRanges())}_handleRangeChange(){i.each(this.series,(t=>{let e=this.dataItems[this.startIndex()].get("category"),s=this.dataItems[this.endIndex()-1].get("category"),a=t.get("baseAxis"),n=t.get("xAxis"),r=t.get("yAxis");if(n instanceof o&&r instanceof o)t._markDirtyAxes();else if(a===this){let o,h,l=r;if(n===a?(t.get("categoryXField")&&(o="categoryX"),t.get("openCategoryXField")&&(h="openCategoryX")):r===a&&(t.get("categoryYField")&&(o="categoryY"),t.get("openCategoryYField")&&(h="openCategoryY"),l=n),"ValueAxis"==l.className&&(o||h)){let a,n;for(let i=0,s=t.dataItems.length;i<s;i++){let s=t.dataItems[i];if(o&&s.get(o)===e){a=s;break}if(h&&s.get(h)===e){a=s;break}}for(let e=t.dataItems.length-1;e>=0;e--){let i=t.dataItems[e];if(o&&i.get(o)===s){n=i;break}if(h&&i.get(h)===s){n=i;break}}let r=0,l=t.dataItems.length;a&&(r=t.dataItems.indexOf(a)),n&&(l=t.dataItems.indexOf(n)+1),t.setPrivate("startIndex",r),t.setPrivate("endIndex",l);let g=!1;for(let e=r;e<l;e++){const s=t.dataItems[e];if(i.each(t.__valueXShowFields,(t=>{null!=s.get(t)&&(g=!0)})),i.each(t.__valueYShowFields,(t=>{null!=s.get(t)&&(g=!0)})),g)break}t.setPrivate("outOfSelection",!g)}t._markDirtyAxes()}}))}_prepareAxisItems(){const t=this.get("renderer"),e=this.dataItems.length;let i=this.startIndex();i>0&&i--;let s=this.endIndex();s<e&&s++;let a=t.axisLength()/Math.max(t.get("minGridDistance"),1/Number.MAX_SAFE_INTEGER),n=Math.max(1,Math.min(e,Math.ceil((s-i)/a)));i=Math.floor(i/n)*n,this._frequency=n;for(let r=0;r<e;r++)this.dataItems[r].hide();let o=this.dataItems[i].get("index",0);for(let r=i;r<s;r+=n){let t=this.dataItems[r];this._createAssets(t,[]),t.isHidden()&&t.show(),this._prepareDataItem(t,o,n),o++}this._updateGhost()}_prepareDataItem(t,e,s){let a=this.get("renderer"),n=t.get("categoryLocation",0),o=t.get("endCategoryLocation",1),r=t.get("index");i.isNumber(r)||(r=this.categoryToIndex(t.get("category")));let h,l=this.indexToPosition(r,n),g=t.get("endCategory");g?(h=this.categoryToIndex(g),i.isNumber(h)||(h=r)):h=r;let d,c,m=this.indexToPosition(h,o);d=t.get("isRange")?h:r+this._frequency-1,c=this.indexToPosition(d,o),a.updateLabel(t.get("label"),l,m,s),a.updateGrid(t.get("grid"),l,m),a.updateTick(t.get("tick"),l,m,s),a.updateFill(t.get("axisFill"),l,c),this._processBullet(t),a.updateBullet(t.get("bullet"),l,m);const u=this.get("fillRule");u&&u(t,e)}startIndex(){let t=this.dataItems.length;return Math.min(Math.max(this.getPrivate("startIndex",0),0),t-1)}endIndex(){let t=this.dataItems.length;return Math.max(1,Math.min(this.getPrivate("endIndex",t),t))}baseValue(){}basePosition(){return 0}getX(t){let e=this._itemMap[t];return e?this._settings.renderer.positionToCoordinate(this.indexToPosition(e.get("index",0))):NaN}getY(t){let e=this._itemMap[t];return e?this._settings.renderer.positionToCoordinate(this.indexToPosition(e.get("index",0))):NaN}getDataItemPositionX(t,e,i,s){const a=t.get(e),n=this._itemMap[a];return n?this.indexToPosition(n.get("index",0),i):NaN}getDataItemCoordinateX(t,e,i,s){return this._settings.renderer.positionToCoordinate(this.getDataItemPositionX(t,e,i,s))}getDataItemPositionY(t,e,i,s){const a=t.get(e),n=this._itemMap[a];return n?this.indexToPosition(n.get("index",0),i):NaN}getDataItemCoordinateY(t,e,i,s){return this._settings.renderer.positionToCoordinate(this.getDataItemPositionY(t,e,i,s))}indexToPosition(t,e){i.isNumber(e)||(e=.5);let s=this.dataItems.length,a=this.get("startLocation",0);s-=a,s-=1-this.get("endLocation",1);let n=(t+e-a)/s,o=this.dataItems[t];return o&&(n+=o.get("deltaPosition",0)),n}categoryToIndex(t){let e=this._itemMap[t];return e?e.get("index"):NaN}dataItemToPosition(t){return this.indexToPosition(t.get("index"))}roundAxisPosition(t,e){return t+=(.5-e)/this.dataItems.length,this.indexToPosition(this.axisPositionToIndex(t),e)}axisPositionToIndex(t){let e=this.dataItems.length;return i.fitToRange(Math.floor(t*e),0,e-1)}getTooltipText(t,e){const s=this.dataItems[this.axisPositionToIndex(t)];if(s){const t=s.get("label");if(t)return i.populateString(t,this.get("tooltipText",""))}}_updateTooltipText(t,e){t._setDataItem(this.dataItems[this.axisPositionToIndex(e)]),t.label.text.markDirtyText()}getSeriesItem(t,e){if(this.dataItems.length>0){let i=this.getPrivate("name")+this.get("renderer").getPrivate("letter"),s=this.axisPositionToIndex(e),a=t.dataItems[s],n=this.dataItems[s],o=n.get("category");if(a&&n&&a.get(i)===o)return a;for(let e=0,r=t.dataItems.length;e<r;e++){let s=t.dataItems[e];if(s.get(i)===o)return s}}}zoomToIndexes(t,e,i){let s=this.dataItems.length;this.zoom(t/s,e/s,i)}zoomToCategories(t,e,i){this.zoomToIndexes(this.categoryToIndex(t),this.categoryToIndex(e)+1,i)}getCellWidthPosition(){return this._frequency/this.dataItems.length/(this.get("end",1)-this.get("start",0))}}Object.defineProperty(o,"className",{enumerable:!0,configurable:!0,writable:!0,value:"CategoryAxis"}),Object.defineProperty(o,"classNames",{enumerable:!0,configurable:!0,writable:!0,value:e.Axis.classNames.concat([o.className])});class r extends n{constructor(){super(...arguments),Object.defineProperty(this,"columns",{enumerable:!0,configurable:!0,writable:!0,value:new i.ListTemplate(i.Template.new({}),(()=>a.RoundedRectangle._new(this._root,{position:"absolute",themeTags:i.mergeTags(this.columns.template.get("themeTags",[]),["series","column"])},[this.columns.template])))})}makeColumn(t,e){const i=this.mainContainer.children.push(e.make());return i._setDataItem(t),e.push(i),i}_processAxisRange(t){super._processAxisRange(t),t.columns=new i.ListTemplate(i.Template.new({}),(()=>a.RoundedRectangle._new(this._root,{position:"absolute",themeTags:i.mergeTags(t.columns.template.get("themeTags",[]),["series","column"])},[this.columns.template,t.columns.template])))}}Object.defineProperty(r,"className",{enumerable:!0,configurable:!0,writable:!0,value:"ColumnSeries"}),Object.defineProperty(r,"classNames",{enumerable:!0,configurable:!0,writable:!0,value:n.classNames.concat([r.className])}),t.AxisRendererXAm5=e.AxisRendererX,t.AxisRendererYAm5=e.AxisRendererY,t.LineSeriesAm5=e.LineSeries,t.ValueAxisAm5=e.ValueAxis,t.XYChartAm5=e.XYChart,t.XYCursorAm5=e.XYCursor,t.CategoryAxisAm5=o,t.ColumnSeriesAm5=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
