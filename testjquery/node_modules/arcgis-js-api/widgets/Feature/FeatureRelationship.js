/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../../chunks/tslib.es6","../../intl","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../Widget","./FeatureRelationship/FeatureRelationshipViewModel","./support/FeatureElementInfo","../support/componentsUtils","../support/globalCss","../support/legacyIcon","../support/widgetUtils","../support/decorators/messageBundle","../support/jsxFactory","../../intl/substitute"],(function(e,t,s,r,i,n,o,a,l,d,c,u,h,p,_,v,m,g,y,w,b){"use strict";const F="esri-feature",I=`${F}-relationship`,f={base:I,listContainer:`${I}__list`,listItem:`${I}__list-item`,listItemHidden:`${I}__list-item--hidden`,listContainerQuerying:`${I}__list--querying`,featureObserver:`${F}__feature-observer`,stickySpinnerContainer:`${F}__sticky-loading-container`,loadingSpinnerContainer:`${F}__loading-container`,spinner:`${F}__loading-spinner`},M={title:!0,description:!0};let C=class extends u{constructor(e,t){super(e,t),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver((([e])=>{e?.isIntersecting&&this._increaseFeaturePage()}),{root:window.document}),this.headingLevel=2,this.viewModel=new h,this.messages=null,this.messagesCommon=null,this.visibleElements={...M},this._increaseFeaturePage=()=>{const{state:e,showAllEnabled:t,relatedFeatures:s,featuresPerPage:r,featurePage:i}=this.viewModel;"ready"===e&&t&&s.length>=r*i&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new p,this.addHandles([n.watch((()=>[this.viewModel.description,this.viewModel.title,this.headingLevel]),(()=>this._setupFeatureElementInfo()),n.initial),n.watch((()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode]),(()=>this._handleRelatedFeatureObserverChange())),n.on((()=>this.viewModel.relatedFeatureViewModels),"change",(()=>this._setupRelatedFeatureViewModels()))])}loadDependencies(){return _.loadCalciteComponents({icon:()=>new Promise(((t,s)=>e(["../../chunks/calcite-icon"],t,s))),list:()=>new Promise(((t,s)=>e(["../../chunks/calcite-list"],t,s))),"list-item":()=>new Promise(((t,s)=>e(["../../chunks/calcite-list-item"],t,s))),notice:()=>new Promise(((t,s)=>e(["../../chunks/calcite-notice"],t,s)))})}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=r.destroyMaybe(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:e,featureCount:t,displayCount:s,state:r}=this.viewModel;return!e&&!!t&&"ready"===r&&(t>s||0===s)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get featureCountDescription(){const{messages:e}=this,{featureCount:t}=this.viewModel;return b.substitute(e?.numberRecords,{number:t})}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}castVisibleElements(e){return{...M,...e}}render(){const{state:e}=this.viewModel;return w.tsx("div",{class:this.classes(f.base,v.globalCss.widget)},this._featureElementInfo?.render(),"loading"===e?this._renderLoading():"disabled"===e?this._renderRelationshipNotFound():this._renderRelatedFeatures())}_renderStickyLoading(){return"querying"===this.viewModel.state?w.tsx("div",{class:f.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return w.tsx("span",{class:this.classes(m.legacyIcon.loadingIndicator,v.globalCss.rotating,f.spinner)})}_renderLoading(){return w.tsx("div",{class:f.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderShowAllIconNode(){return w.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})}_renderChevronIconNode(){const e=g.isRTL(this.container)?"chevron-left":"chevron-right";return w.tsx("calcite-icon",{icon:e,scale:"s",slot:"content-end"})}_renderRelatedFeature(e){const{itemDescriptionFieldName:t}=this.viewModel,s=e.title;e.description=t&&e.formattedAttributes?.global[t];const r="loading"===e.state;return w.tsx("calcite-list-item",{class:this.classes(f.listItem,{[f.listItemHidden]:r}),description:e.description??"",key:e.uid,label:s,onCalciteListItemSelect:()=>this.emit("select-record",{featureViewModel:e})},this._renderChevronIconNode())}_renderShowAllListItem(){return this.displayShowAllButton?w.tsx("calcite-list-item",{description:this.featureCountDescription,key:"show-all-item",label:this.messages?.showAll,onCalciteListItemSelect:()=>this.emit("show-all-records")},this._renderShowAllIconNode()):null}_renderNoRelatedFeaturesMessage(){return w.tsx("calcite-notice",{icon:"information",key:"no-related-features-message",kind:"brand",open:!0,scale:"s",width:"full"},w.tsx("div",{slot:"message"},this.messages?.noRelatedFeatures))}_renderFeatureObserver(){return w.tsx("div",{afterCreate:this._relatedFeatureIntersectionObserverCreated,bind:this,class:f.featureObserver,key:"feature-observer"})}_renderList(){const{relatedFeatureViewModels:e}=this.viewModel;return w.tsx("calcite-list",null,e.toArray().map((e=>this._renderRelatedFeature(e))),this._renderShowAllListItem())}_renderRelatedFeatures(){const{displayListItems:e}=this,{state:t}=this.viewModel;return w.tsx("div",{class:this.classes(f.listContainer,{[f.listContainerQuerying]:"querying"===t}),key:"list-container"},e?this._renderList():"ready"===t?this._renderNoRelatedFeaturesMessage():null,this._renderStickyLoading(),this._renderFeatureObserver())}_renderRelationshipNotFound(){return w.tsx("calcite-notice",{icon:"exclamation-mark-triangle",key:"relationship-not-found",kind:"danger",open:!0,scale:"s",width:"full"},w.tsx("div",{slot:"message"},this.messages?.relationshipNotFound))}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:e}=this.viewModel,t="related-feature-viewmodels";this.removeHandles(t),e?.forEach((e=>{this.addHandles(n.watch((()=>[e.title,e.state]),(()=>this.scheduleRender()),n.initial),t)})),this.scheduleRender()}_setupFeatureElementInfo(){const{headingLevel:e,visibleElements:t}=this,s=t.description&&this.description,r=t.title&&this.title;this._featureElementInfo?.set({description:s,title:r,headingLevel:e})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:e,showAllEnabled:t}=this.viewModel;await i.after(0),this._relatedFeatureIntersectionObserverNode&&"ready"===e&&t&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(e){this._relatedFeatureIntersectionObserverNode=e}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};t.__decorate([o.property()],C.prototype,"_relatedFeatureIntersectionObserverNode",void 0),t.__decorate([o.property({readOnly:!0})],C.prototype,"displayShowAllButton",null),t.__decorate([o.property({readOnly:!0})],C.prototype,"displayListItems",null),t.__decorate([o.property()],C.prototype,"description",null),t.__decorate([o.property({readOnly:!0})],C.prototype,"featureCountDescription",null),t.__decorate([o.property()],C.prototype,"headingLevel",void 0),t.__decorate([o.property()],C.prototype,"title",null),t.__decorate([o.property({type:h})],C.prototype,"viewModel",void 0),t.__decorate([o.property(),y.messageBundle("esri/widgets/Feature/t9n/Feature")],C.prototype,"messages",void 0),t.__decorate([o.property(),y.messageBundle("esri/t9n/common")],C.prototype,"messagesCommon",void 0),t.__decorate([o.property()],C.prototype,"visibleElements",void 0),t.__decorate([a.cast("visibleElements")],C.prototype,"castVisibleElements",null),C=t.__decorate([c.subclass("esri.widgets.Feature.FeatureRelationship")],C);return C}));
