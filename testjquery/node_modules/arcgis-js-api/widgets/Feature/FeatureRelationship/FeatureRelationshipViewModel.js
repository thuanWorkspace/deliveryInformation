/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/Clonable","../../../core/Collection","../../../core/Identifiable","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../rest/support/RelationshipQuery","../support/featureUtils","../../FeatureForm/featureFormUtils"],(function(e,t,r,o,a,l,s,i,n,u,d,y,p,c,h,_){"use strict";const b=100;let C=class extends(a.ClonableMixin(s.IdentifiableMixin(r))){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await i.ignoreAbortErrors(this._query()),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await i.ignoreAbortErrors(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await i.ignoreAbortErrors(this._queryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=i.debounce(this._queryController,b),this._queryFeatureCountDebounced=i.debounce(this._queryFeatureCountController,b),this._queryPageDebounced=i.debounce(this._queryPageController,b),this._query=async()=>{const{_queryAbortController:e,relatedFeatures:t}=this;this.featureCount&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,t.removeAll(),this.destroyed||t.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:e?.signal}))))},this.addHandles([n.watch((()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount]),(()=>this._queryDebounced()),n.initial),n.watch((()=>[this.featurePage,this.showAllEnabled]),(()=>this._queryPageDebounced())),n.watch((()=>[this.layer,this.relationshipId,this.objectId,this.canQuery]),(()=>this._queryFeatureCountDebounced()))])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:t,featureCount:r}=this,o=1,a=Math.ceil(r/t)||1;this._set("featurePage",Math.min(Math.max(e,o),a))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map((e=>{const r=e.clone();return r.field=h.getFixedFieldName(e.field,t),r})):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId}get canQuery(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId&&e?.supportsCount&&e?.supportsPagination)}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}set displayCount(e){const t=0,r=10;this._set("displayCount",Math.min(Math.max(e,t),r))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new l}get relatedLayer(){const{layer:e,map:t,relationship:r}=this;return e?.loaded&&t&&r?h.findRelatedLayer(t,e,r)??null:null}get relationship(){const{relationshipId:e,layer:t}=this;return"number"==typeof e?t?.relationships?.find((({id:t})=>t===e))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new l}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:r,canQuery:o,_loaded:a,canLoad:l}=this;return t||l&&!a?"loading":e||r?"querying":o?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find((t=>t.getObjectId()===e))}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.forEach((e=>!e.destroyed&&e.destroy())),this.relatedFeatureViewModels.removeAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:t,relationshipId:r,objectId:o,_queryFeatureCountAbortController:a,canQuery:l,supportsCacheHint:s}=this;if(await(e?.load()),await(t?.load()),!l||!e||!t)return void this._set("featureCount",0);const i=t.createQuery(),n=new c({cacheHint:s,relationshipId:r,returnGeometry:!1,objectIds:[o],where:i.where??void 0}),u=await e.queryRelatedFeaturesCount(n,{signal:a?.signal});this._set("featureCount",u[o]||0)}_sliceFeatures(e){const{showAllEnabled:t,displayCount:r}=this;return t?e:r?e.slice(0,r):[]}async _queryPage(){const{relatedFeatures:e,featurePage:t,showAllEnabled:r,_queryPageAbortController:o,featureCount:a}=this;!r||t<2||!a||e.addMany(await this._queryRelatedFeatures({signal:o?.signal}))}async _queryRelatedFeatures(e){const{orderByFieldsFixedCasing:t,showAllEnabled:r,featuresPerPage:a,displayCount:l,layer:s,relationshipId:i,featurePage:n,featureCount:u,relatedLayer:d,supportsCacheHint:y}=this,{canQuery:p,objectId:h}=this;if(!p||!s||!d)return[];const b=r?((n-1)*a+u)%u:0,C=r?a:l,g=d.objectIdField,F=[...t.map((e=>e.field)),..._.getFieldsInTitleAndDesc(d),g].filter(o.isSome),q=t.map((e=>`${e.field} ${e.order}`)),f=d.createQuery(),A=new c({orderByFields:q,start:b,num:C,outFields:F,cacheHint:y,relationshipId:i,returnGeometry:!1,objectIds:[h],where:f.where??void 0}),w=await s.queryRelatedFeatures(A,{signal:e?.signal}),P=w[h]?.features||[];return P.forEach((e=>{e.sourceLayer=d,e.layer=d})),P}};e.__decorate([u.property()],C.prototype,"_loaded",void 0),e.__decorate([u.property()],C.prototype,"_queryAbortController",void 0),e.__decorate([u.property()],C.prototype,"_queryPageAbortController",void 0),e.__decorate([u.property()],C.prototype,"_queryFeatureCountAbortController",void 0),e.__decorate([u.property({value:1})],C.prototype,"featurePage",null),e.__decorate([u.property()],C.prototype,"featuresPerPage",void 0),e.__decorate([u.property({readOnly:!0})],C.prototype,"orderByFieldsFixedCasing",null),e.__decorate([u.property({readOnly:!0})],C.prototype,"supportsCacheHint",null),e.__decorate([u.property({readOnly:!0})],C.prototype,"canLoad",null),e.__decorate([u.property({readOnly:!0})],C.prototype,"canQuery",null),e.__decorate([u.property()],C.prototype,"description",void 0),e.__decorate([u.property({readOnly:!0})],C.prototype,"itemDescriptionFieldName",null),e.__decorate([u.property({value:3})],C.prototype,"displayCount",null),e.__decorate([u.property({type:t})],C.prototype,"graphic",void 0),e.__decorate([u.property()],C.prototype,"layer",void 0),e.__decorate([u.property()],C.prototype,"map",void 0),e.__decorate([u.property({readOnly:!0})],C.prototype,"objectId",null),e.__decorate([u.property({readOnly:!0})],C.prototype,"objectIdField",null),e.__decorate([u.property()],C.prototype,"orderByFields",void 0),e.__decorate([u.property({readOnly:!0})],C.prototype,"relatedFeatures",null),e.__decorate([u.property({readOnly:!0})],C.prototype,"relatedLayer",null),e.__decorate([u.property({readOnly:!0})],C.prototype,"relationship",null),e.__decorate([u.property()],C.prototype,"featureCount",void 0),e.__decorate([u.property({readOnly:!0})],C.prototype,"relatedFeatureViewModels",null),e.__decorate([u.property()],C.prototype,"relationshipId",void 0),e.__decorate([u.property()],C.prototype,"showAllEnabled",void 0),e.__decorate([u.property()],C.prototype,"state",null),e.__decorate([u.property()],C.prototype,"title",void 0),e.__decorate([u.property()],C.prototype,"getRelatedFeatureByObjectId",null),C=e.__decorate([p.subclass("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],C);return C}));
