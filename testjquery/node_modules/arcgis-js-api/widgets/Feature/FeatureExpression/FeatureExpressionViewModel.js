/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/reactiveUtils","../../../core/throttle","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../popup/content/AttachmentsContent","../../../popup/content/Content","../../../popup/content/CustomContent","../../../popup/content/ExpressionContent","../../../popup/content/FieldsContent","../../../popup/content/MediaContent","../../../popup/content/RelationshipContent","../../../popup/content/TextContent","../../../popup/ElementExpressionInfo","../FeatureContent/FeatureContentViewModel","../FeatureFields/FeatureFieldsViewModel","../FeatureMedia/FeatureMediaViewModel","../support/arcadeFeatureUtils"],(function(e,t,o,r,n,i,s,l,p,a,c,d,h,u,_,y,m,w,f,C,E,v,b){"use strict";const x=1;let M=class extends o{constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:e}=this;e&&e.abort(),this._abortController=null},this._createVM=()=>{const e=this.contentElement?.type;this.contentElementViewModel?.destroy();const t="fields"===e?new E:"media"===e?new v:"text"===e?new C:null;this._set("contentElementViewModel",t)},this._compile=async()=>{this._cancelQuery();const e=new AbortController;this._abortController=e,await this._compileExpression(),this._abortController===e&&(this._abortController=null)},this._compileThrottled=n.throttle(this._compile,x,this),this._compileExpression=async()=>{const{expressionInfo:e,graphic:t,interceptor:o,spatialReference:r,map:n,view:i,_abortController:s}=this;if(!(e&&t&&r&&n))return void this._set("contentElement",null);const l=await b.loadArcadeUtils();if(s!==this._abortController)return;const p=await b.createCompiledExpression({arcadeUtils:l,expressionInfo:e,graphic:t,interceptor:o,map:n,spatialReference:r,view:i});if(!p||"esri.arcade.Dictionary"!==p.declaredClass)return void this._set("contentElement",null);const a=await p.castAsJsonAsync(s?.signal),c=a?.type,d="media"===c?y.fromJSON(a):"text"===c?w.fromJSON(a):"fields"===c?_.fromJSON(a):null;this._set("contentElement",d)},this.addHandles([r.watch((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),r.initial),r.watch((()=>[this.contentElement]),(()=>this._createVM()),r.initial)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:o}=this;return e?"loading":t||o?"ready":"disabled"}get map(){return this.view?.map??null}set map(e){this._override("map",e)}};e.__decorate([i.property()],M.prototype,"_abortController",void 0),e.__decorate([i.property({type:f})],M.prototype,"expressionInfo",void 0),e.__decorate([i.property({type:t})],M.prototype,"graphic",void 0),e.__decorate([i.property({readOnly:!0})],M.prototype,"contentElement",void 0),e.__decorate([i.property({readOnly:!0})],M.prototype,"contentElementViewModel",void 0),e.__decorate([i.property()],M.prototype,"interceptor",void 0),e.__decorate([i.property()],M.prototype,"spatialReference",null),e.__decorate([i.property({readOnly:!0})],M.prototype,"state",null),e.__decorate([i.property()],M.prototype,"map",null),e.__decorate([i.property()],M.prototype,"view",void 0),M=e.__decorate([a.subclass("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],M);return M}));
