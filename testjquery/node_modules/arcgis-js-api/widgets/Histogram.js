/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../intl","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./Histogram/HistogramViewModel","./support/globalCss","./support/legacyIcon","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/substitute"],(function(e,t,r,a,i,s,n,o,l,d,u,c,h,p,_){"use strict";var g;const b="esri-histogram",m={base:b,widgetIcon:u.legacyIcon.edit,horizontalLayout:`${b}--horizontal`,verticalLayout:`${b}--vertical`,content:`${b}__content`,svg:`${b}__svg`,bar:`${b}__bar`,bars:`${b}__bars`,label:`${b}__label`,dataLines:`${b}__data-lines`,dataLinesSubgroup:`${b}__data-lines-subgroup`,dataLine:`${b}__data-line`,averageLabel:`${b}__average-label`,averageDataLine:`${b}__average-data-line`,averageSymbol:`${b}__average-symbol`};let v=g=class extends o{constructor(e,t){super(e,t),this._bgFillId=`${this.id}-bg-fill`,this._containerNode=null,this._containerDimensions={width:0,height:0},this._defaultBarColor="#d8d8d8",this.barCreatedFunction=null,this.dataLines=null,this.dataLineCreatedFunction=null,this.dataLineUpdatedFunction=null,this.messages=null,this.viewModel=new l}get average(){return this.viewModel.average}set average(e){this.viewModel.average=e}get bins(){return this.viewModel.bins}set bins(e){this.viewModel.bins=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get labelFormatFunction(){return this.viewModel.labelFormatFunction}set labelFormatFunction(e){this.viewModel.labelFormatFunction=e}set layout(e){"vertical"!==e&&(e="horizontal"),this._set("layout",e)}get max(){return this.viewModel.max}set max(e){this.viewModel.max=e}get min(){return this.viewModel.min}set min(e){this.viewModel.min=e}get state(){return this.viewModel.state}static fromHistogramResult(e){const{bins:t,maxValue:r,minValue:a}=e;return new g({bins:t,max:r,min:a})}render(){const{label:e,layout:t,state:r}=this,a=this.classes(m.base,d.globalCss.widget,"horizontal"===t?m.horizontalLayout:m.verticalLayout,"disabled"===r?d.globalCss.disabled:null);return p.tsx("div",{afterCreate:this._afterContainerNodeCreate,"aria-label":e,bind:this,class:a},"ready"===r?this._renderContent():null)}_renderContent(){if(!this._containerNode)return;const e=this._bgFillId,t=`clip-path: url(#${e})`;return p.tsx("div",{class:m.content},p.tsx("svg",{class:m.svg,xmlns:"http://www.w3.org/2000/svg"},p.tsx("defs",null,this._renderFillDefinition(e)),p.tsx("g",{style:t},this._renderBarsGroup()),this._renderLinesGroup()))}_renderBarsGroup(){return p.tsx("g",{class:this.classes(m.bars)},this._renderBars())}_renderBars(){const{layout:e,viewModel:{binRange:t,range:r}}=this;if(!t||!r)return;const a=t/r,{width:i,height:s}=this._containerDimensions;if(0===s&&0===i)return;if(0===s&&0!==i)return void this.scheduleRender();const[n,o]="vertical"===e?[s*a,i]:[s,i*a];return this._getBarDimensions(n,o).map((([e,t],r)=>this._renderBar(r,e,t)))}_renderBar(e,t,r){const{bins:a,layout:i,max:s,messages:n,viewModel:{range:o}}=this;if(!a||null==s)return;const{width:l,height:d}=this._containerDimensions,u=a.slice()[e],{count:c,maxValue:h,minValue:g}=u,b=s-h,[v,y]="vertical"===i?[0,b*(d/o)]:[l-r-b*(l/o),d-t],L=_.substitute(n.barLabel,{count:c,maxValue:h,minValue:g});return p.tsx("rect",{afterCreate:this._afterBarCreate,"aria-label":L,bind:this,class:m.bar,"data-index":e,fill:this._defaultBarColor,height:t,role:"img","shape-rendering":"crispEdges","stroke-width":"0",width:r,x:v,y})}_renderLinesGroup(){return p.tsx("g",{class:this.classes(m.dataLines)},this._renderAverageLine(),this._renderCustomLines())}_renderAverageLine(){const{average:e}=this;if(null==e)return;const t=[p.tsx("tspan",{class:this.classes(m.averageSymbol)},"xÌ„ "),p.tsx("tspan",{class:this.classes(m.averageLabel)},this.labelFormatFunction?this.labelFormatFunction(e,"average"):e)];return p.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,afterUpdate:this._afterLinesSubgroupUpdate,bind:this,class:this.classes(m.dataLinesSubgroup)},p.tsx("title",{key:"title"},e),this._renderLine(e,this.classes(m.averageDataLine)),this._renderLabel({label:t,value:e}))}_renderCustomLines(){if(this.dataLines?.length)return this.dataLines.map(((e,t)=>this._renderLineSubgroup(e,t)))}_renderLineSubgroup(e,t){const{value:r}=e;return p.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,afterUpdate:this._afterLinesSubgroupUpdate,bind:this,class:this.classes(m.dataLinesSubgroup),"data-index":t},p.tsx("title",{key:"title"},r),this._renderLine(r),this._renderLabel(e))}_renderLine(e,t){const[r,a,i,s]=this._getLinePosition(e);return p.tsx("line",{class:this.classes(m.dataLine,t),"shape-rendering":"crispEdges",x1:r,x2:a,y1:i,y2:s})}_renderLabel(e,t){const{label:r,value:a}=e,[i,s]=this._getLabelPosition(a),n=2;return p.tsx("text",{class:this.classes(m.label,t),"text-anchor":"end",transform:"horizontal"===this.layout?"rotate(270)":null,x:i,y:s-n},r??"")}_renderFillDefinition(e){const{width:t,height:r}=this._containerDimensions;return p.tsx("clipPath",{id:e},p.tsx("rect",{height:r,width:t,x:"0",y:"0"}))}_afterContainerNodeCreate(e){this._containerNode=e,this.addHandles(c.onResize(e,(e=>{const{width:t,height:r}=e.contentRect;this._containerDimensions={width:t,height:r}})))}_getIndexFromElement(e){const t=e.dataset?.index,r=e.getAttribute("data-index");return null!=t?parseInt(t,10):null!=r?parseInt(r,10):null}_afterBarCreate(e){if(this.barCreatedFunction){const t=this._getIndexFromElement(e)??-1;this.barCreatedFunction(t,e)}}_afterLinesSubgroupCreate(e){if(this.dataLineCreatedFunction){const t=this._getIndexFromElement(e),r=e.childNodes[1],a=e.childNodes[2]?e.childNodes[2]:null;this.dataLineCreatedFunction(r,a,t)}}_afterLinesSubgroupUpdate(e){if(this.dataLineUpdatedFunction){const t=this._getIndexFromElement(e),r=e.childNodes[1],a=e.childNodes[2]?e.childNodes[2]:null;this.dataLineUpdatedFunction(r,a,t)}}_getBarDimensions(e,t){const{bins:r,layout:a}=this,i=r?r.map((e=>e.count)):[],s=Math.max.apply(Math,i);return i.map((r=>"vertical"===a?[e/i.length,0!==s?r/s*t:0]:[0!==s?r/s*e:0,t/i.length]))}_getLinePosition(e){const{layout:t,min:r,viewModel:{range:a}}=this;if(null==r)return[0,0,0,0];const i=Math.round((e-r)/a*100)/100,{width:s,height:n}=this._containerDimensions,[o,l]=[i*s||1,n-i*n||1];return"vertical"===t?[0,"100%",l,l]:[o,o,"100%",0]}_getLabelPosition(e){const{layout:t,min:r,viewModel:{range:a}}=this;if(null==r)return[0,0];const i=Math.round((e-r)/a*100)/100,{width:s,height:n}=this._containerDimensions;return"vertical"===t?[s,n-i*n]:[0,i*s]}};e.__decorate([r.property()],v.prototype,"_bgFillId",void 0),e.__decorate([r.property()],v.prototype,"_containerNode",void 0),e.__decorate([r.property()],v.prototype,"_containerDimensions",void 0),e.__decorate([r.property()],v.prototype,"_defaultBarColor",void 0),e.__decorate([r.property()],v.prototype,"average",null),e.__decorate([r.property()],v.prototype,"barCreatedFunction",void 0),e.__decorate([r.property()],v.prototype,"dataLines",void 0),e.__decorate([r.property()],v.prototype,"dataLineCreatedFunction",void 0),e.__decorate([r.property()],v.prototype,"dataLineUpdatedFunction",void 0),e.__decorate([r.property()],v.prototype,"label",null),e.__decorate([r.property()],v.prototype,"labelFormatFunction",null),e.__decorate([r.property({value:"horizontal"})],v.prototype,"layout",null),e.__decorate([r.property()],v.prototype,"max",null),e.__decorate([r.property(),h.messageBundle("esri/widgets/Histogram/t9n/Histogram")],v.prototype,"messages",void 0),e.__decorate([r.property()],v.prototype,"min",null),e.__decorate([r.property({readOnly:!0})],v.prototype,"state",null),e.__decorate([r.property()],v.prototype,"viewModel",void 0),v=g=e.__decorate([n.subclass("esri.widgets.Histogram")],v);return v}));
