/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Accessor","../../core/MapUtils","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,s,o,a,n,i,l,c){"use strict";const p="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",u="esri.widgets.FeatureForm.FormExpressionsManager";e.FormExpressionsManager=class extends r{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this.preserveFieldValuesWhenHidden=!0,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}destroy(){this.resetExecutors()}get _baseContext(){const{editType:e,layer:t,map:r,originalFeature:s,spatialReference:o,timeZone:a}=this.arcadeContextInfo,n="feature"===t?.type?t:"scene"===t?.type&&null!=t.associatedLayer?t.associatedLayer:void 0;return[{$originalfeature:s,$editcontext:{editType:e},$layer:n,$featureset:n,$datastore:t?.url,$map:r},{rawOutput:!0,spatialReference:o??void 0,timeZone:a}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:r,feature:s}=this,o=new Set;for(const a of e)if(r[a]=s.getAttribute(a),t.has(a))for(const e of t.get(a))o.add(e);return this._evaluate([...o])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(p))return this._evaluate([...this._fieldReferencesLookup.get(p)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:r,preserveFieldValuesWhenHidden:o}=this,a=new Map(this.fieldInputs.map((e=>[e.name,e]))),n=!1===o,i=new Map(r.map((e=>[e,new Array])));for(const l of r){for(const r of l.fieldsUsed){s.getOrCreateMapValue(e,r,(()=>new Set)).add(l);const o=a.get(r);[o?.valueExpressionExecutor,o?.editableExpressionExecutor,n?o?.group?.visibilityExpressionExecutor:null,n?o?.visibilityExpressionExecutor:null].filter((e=>null!=e&&e!==l)).forEach((e=>{i.get(e).push(l);s.getOrCreateMapValue(t,e,(()=>new Set)).add(o)}))}if(l.geometryUsed){s.getOrCreateMapValue(e,p,(()=>new Set)).add(l)}}return i}async _evaluate(e){const t=new Map,{_dependencyGraph:r,_fieldsAffectedLookup:s,_latestFieldValues:a}=this;for(const o of e)d(o,t,r);for(const[i,{resolver:l,dependencyPromises:c}]of t){Promise.all(c).then((async()=>{const[e,t]=this._makeContext(a);return i.executeAsync(e,t)})).then((()=>{if(s.has(i))for(const e of s.get(i))this._latestFieldValues[e.name]=e.value;l.resolve()}),(e=>{!e||o.isAbortError(e)||f(e)||i.markStale(),l.reject(e)}))}const n=(await Promise.allSettled(Array.from(t.values(),(({resolver:e})=>e.promise)))).filter((e=>"rejected"===e.status&&!(o.isAbortError(e.reason)||f(e.reason))));if(n.length>0)throw new AggregateError(n,"One or more expression executions failed")}_makeContext(e){const[t,r]=this._baseContext,s=this.feature.clone();return s.attributes=e,[{...t,$feature:s},r]}},t.__decorate([a.property()],e.FormExpressionsManager.prototype,"_baseContext",null),t.__decorate([a.property()],e.FormExpressionsManager.prototype,"feature",null),t.__decorate([a.property({constructOnly:!0})],e.FormExpressionsManager.prototype,"preserveFieldValuesWhenHidden",void 0),t.__decorate([a.property()],e.FormExpressionsManager.prototype,"executors",void 0),t.__decorate([a.property()],e.FormExpressionsManager.prototype,"fieldInputs",void 0),t.__decorate([a.property()],e.FormExpressionsManager.prototype,"arcadeContextInfo",void 0),e.FormExpressionsManager=t.__decorate([c.subclass(u)],e.FormExpressionsManager);const d=(e,t,r)=>{if(t.has(e))return;const s=o.createResolver();t.set(e,{resolver:s,dependencyPromises:[]}),e.abort();const a=r.get(e);for(const o of a)d(o,t,r),t.get(o).dependencyPromises.push(s.promise)},f=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
