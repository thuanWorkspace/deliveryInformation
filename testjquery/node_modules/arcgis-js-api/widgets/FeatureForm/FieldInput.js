/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Error","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/CodedValue","../../layers/support/CodedValueDomain","../../layers/support/Domain","../../layers/support/InheritedDomain","../../layers/support/RangeDomain","../../layers/support/domainUtils","../../layers/support/fieldUtils","../../smartMapping/support/utils","../Feature/support/featureUtils","./EditableInput","./featureFormUtils","../support/dataUtils","../support/dateUtils"],(function(e,t,i,r,l,n,a,o,s,u,p,d,y,m,c,h,_,f,g,b,x){"use strict";var v;!function(e){e.Text="text",e.Number="number",e.Date="date",e.Unsupported="unsupported"}(v||(v={}));const E="__internal-type-based-coded-value-domain__";let V=class extends f{constructor(e){super(e),this._storedValue=null,this.error=null,this.preservesValueWhenHidden=!0,this.field=null,this.group=null,this.requiredExpressionExecutor=null,this.type="field",this._fieldInputWasVisibleDuringLifetime=!1,this.valueExpressionExecutor=null}initialize(){this.addHandles(i.watch((()=>this.feature),(()=>this._fieldInputWasVisibleDuringLifetime=!1),i.sync))}get _dateFormRange(){const{element:e,field:t}=this;if("date"!==this.dataType)return{};const i=e?.domain?m.getDomainRange(t,e.domain):null;if(!e?.input)return i??{};const r=e.input,{type:l}=r;let n={};if("date-picker"!==l&&"time-picker"!==l&&"datetimeoffset-picker"!==l||(n=m.dateTimeFieldValuesToNumericRange(t,r.max,r.min)),"datetime-picker"===l){const{max:e,min:t}=r;n={max:null!=e&&F(e)?e.getTime():null,min:null!=t&&F(t)?t.getTime():null}}const{max:a,min:o}=n;if(i){const{max:e,min:t}=i,r=b.isNumber(e)&&(null==a||null!=a&&e<a),l=b.isNumber(t)&&(null==o||null!=o&&t>o);return{max:r?e:a??null,min:l?t:o??null,rawMax:r?i.rawMax:n?.rawMax??null,rawMin:l?i.rawMin:n?.rawMin??null}}return{min:o,max:a,rawMax:n?.rawMax??null,rawMin:n?.rawMin??null}}get _dateRange(){const{_dateFormRange:e,field:t}=this;if("date"!==this.dataType)return{};const i=m.getDomainRange(t);if(!i)return e;const{max:r,min:l,rawMax:n,rawMin:a}=e;if("date"===t.type){const{max:e,min:t}=i;return{max:b.isNumber(r)&&(null===e||null!=e&&r<e)?r:e??null,min:b.isNumber(l)&&(null===t||null!=t&&l>t)?l:t??null}}if("date-only"===t.type||"time-only"===t.type||"timestamp-offset"===t.type){const{max:e,min:t,rawMax:o,rawMin:s}=i,u=b.isNumber(r)&&n&&(null==e||r<e);return{max:u?r:e,min:b.isNumber(l)&&a&&(null==t||l>t)?l:t,rawMax:u?n:o,rawMin:u?a:s}}return{max:null,min:null}}get _configAllowsEdits(){const{element:e,layer:t,name:i}=this;if(null!=e)return e.editableExpression?!!this.evaluatedEditableExpression:!1!==e.editable;if(t?.userHasUpdateItemPrivileges)return!0;const r=t&&"popupTemplate"in t?t?.popupTemplate?.fieldInfos?.find((({fieldName:e})=>e===i)):null;return r?.isEditable??!0}get _layerAndFieldAllowEdits(){return this.layerAllowsEdits&&this.field?.editable}get _isVisibleByDefault(){const{field:e,layer:t}=this;return!!e?.visible&&c.isFieldVisibleByDefault(e,t)}get _isEditTrackingField(){return c.getLowerCaseEditTrackingFields(this.layer).includes(this.name?.toLowerCase())}get _shouldUseValueExpression(){return this._layerAndFieldAllowEdits&&!this._configAllowsEdits&&null!=this.valueExpressionExecutor}get _isSubtypeField(){const{layer:e}=this;if(e&&"subtypeField"in e){const{subtypeField:t,fieldsIndex:i}=e;return(i.get(t)?.name??t)===this.name}return!1}get test(){return{_isSubtypeField:this._isSubtypeField}}get dataType(){const{field:e}=this;return c.isNumericField(e)?v.Number:c.isStringField(e)?v.Text:h.isAnyDateField(e)||c.isTimeOnlyField(e)?v.Date:v.Unsupported}get dateDataType(){if(this.dataType===v.Date)return"date"!==this.field.type?"string":"number"}get description(){const{element:e,feature:t,layer:i,timeZone:r}=this,l=e?.description;return null!=i&&null!=l?g.parseFormTemplateString({label:l,attributes:t.attributes,fieldsIndex:i.fieldsIndex,timeZone:r}):l}get domain(){const{layer:e}=this,{typeFieldName:t,types:i}=g.getNormalizedFeatureTypeInfo(e);if(this._isSubtypeField&&"subtypes"in e&&e.subtypes)return new u({name:E,codedValues:e.subtypes.map((({code:e,name:t})=>new s.CodedValue({code:e,name:t})))});if(t===this.name&&null==this.field.domain)return new u({name:E,codedValues:i.map((({code:e,name:t})=>new s.CodedValue({code:e,name:t})))});const{feature:r}=this,l=e?.getFieldDomain(this.name,{feature:r}),n=this.element?.domain;return null!=n&&this._isDomainCompatible(n)?n:l}get editable(){return!!this._layerAndFieldAllowEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}get evaluatedRequiredExpression(){const{requiredExpressionExecutor:e}=this;return null!=e?!!e.lastEvaluatedValue:null}get evaluatedValueExpression(){const{valueExpressionExecutor:e}=this;return null!=e?e.lastEvaluatedValue:null}get hint(){return this.element?.hint}get includeDate(){return!(this.dataType!==v.Date||"time-only"===this.field.type)}get includeTime(){const{element:e,field:t}=this;if(this.dataType!==v.Date)return!1;if("time-only"===t.type)return!0;if("date-only"===t.type)return!1;const i="datetime-picker"===e?.input?.type?e.input.includeTime:void 0;return void 0===i||i}get includeTimeOffset(){if("timestamp-offset"!==this.field.type)return!1;const e=this.element?.input;return!e||"datetimeoffset-picker"===e.type&&e.includeTimeOffset}set initialFeature(e){this._set("initialFeature",e),this.notifyChange("valid")}get inputType(){return this.element?.input?.type}get hasInvalidSwitchValue(){const{element:e}=this,t=g.isFieldElementWithInputType(e,"switch")?e.input:null;return!t||g.valueIsInvalidSwitchValue(this.value,t)}get isRelationshipKeyField(){const{field:e,layer:t}=this;return _.isRelatableFeatureSupportedLayer(t)&&!!t.relationships?.some((t=>t.keyField===e.name))}get label(){const{element:e,feature:t,field:i,layer:r,timeZone:l}=this;return null!=r&&null!=e?.label?g.parseFormTemplateString({label:e.label,attributes:t.attributes,fieldsIndex:r.fieldsIndex,timeZone:l}):e?.label||i.alias||i.name}get maxLength(){const e=-1;if(this.dataType===v.Date)return e;const{field:t,element:i}=this,r=t?.length??-1,l=g.isFieldElementWithTextInput(i)?i.input.maxLength:NaN;return null!=l&&!isNaN(l)&&l>=e&&(r===e||l<=r)?l:r}get minLength(){const e=-1;if(this.dataType===v.Date)return e;const{field:t,element:i}=this,r=t?.length??-1,l=g.isFieldElementWithTextInput(i)?i.input.minLength:NaN;return null!=l&&!isNaN(l)&&l>=e&&(r===e||l<=r)?l:e}get name(){return this.field?.name}get range(){const{domain:e,element:t,field:i}=this;if("date"===this.dataType)return this._dateRange;const r=m.getDomainRange(i,e)||c.getFieldRange(i,e),l=r?.max===Number.MAX_VALUE?null:r?.max??null,n=r?.min===-Number.MAX_VALUE?null:r?.min??null;if(!t?.domain||"range"!==t.domain.type)return{max:l,min:n};const{max:a,min:o}=m.getDomainRange(i)||{};return{max:null!=a&&(null===l||null!=l&&a<l)?a:l,min:null!=o&&(null===n||null!=n&&o>n)?o:n}}get required(){const{editable:e,evaluatedRequiredExpression:t,field:i,visible:r,_isSubtypeField:l}=this;return!!e&&(!1===i?.nullable||(!!l||!(!r||null==t)&&t))}set required(e){this._overrideIfSome("required",e)}get showNoValueOptionEnabled(){const{element:e}=this;return!this.required&&(!g.isFieldElementWithShowNoValueOptionInput(e)||e.input.showNoValueOption)}get showNoValueLabel(){const{element:e}=this;return g.isFieldElementWithShowNoValueOptionInput(e)?e.input.noValueOptionLabel:null}get submittable(){const{field:e,required:t,valid:i,value:r}=this;return(!t||null!=r)&&(!!i||this.initialFeature.getAttribute(e.name)===r)}get timeResolution(){const e=this.element?.input;if(e&&("datetimeoffset-picker"===e.type||"time-picker"===e.type))return e.timeResolution??"minutes"}get timeStep(){return null!=this.timeResolution?x.timeResolutionToStepMap.get(this.timeResolution):void 0}get updating(){const{editableExpressionExecutor:e,valueExpressionExecutor:t,visibilityExpressionExecutor:i,preservesValueWhenHidden:r}=this;return null!=t&&t.updating||null!=e&&e.updating||!1===r&&null!=i&&i.updating}get valid(){const e=this.editable?this._validate():null;return this._set("error",e),null===e}get value(){if(this._fieldInputWasVisibleDuringLifetime=this._fieldInputWasVisibleDuringLifetime||this.visible&&!1!==this.group?.visible,!1===this.preservesValueWhenHidden&&this._fieldInputWasVisibleDuringLifetime&&(!1===this.visibilityExpressionExecutor?.lastEvaluatedValue||!1===this.group?.visibilityExpressionExecutor?.lastEvaluatedValue))return null!==this._storedValue&&this.set("_storedValue",null),null;if(this._shouldUseValueExpression){const e=this.evaluatedValueExpression;return this.dataType===v.Date?this._arcadeOutputToDateFieldValue(e):null!=e&&"object"==typeof e?e.toString():e}return this._storedValue}set value(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e)}get visible(){return!this._isEditTrackingField&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element||this._isVisibleByDefault)}_arcadeOutputToDateFieldValue(e){const i=this.field.type;try{if("object"==typeof e){if(null===e)throw new t("feature-form:invalid-date-value");if(x.isArcadeDate(e))return x.arcadeDateToFieldValue(e,i);if("getTime"in e&&"function"==typeof e.getTime&&"date"===i)return parseInt(e.getTime(),10);if("date-only"===i||"time-only"===i||"timestamp-offset"===i)return e.toString()}else{if("string"==typeof e)return"date"===i?parseInt(e,10):e;if("number"==typeof e&&"date"===i)return e}throw new t("feature-form:invalid-date-value")}catch{return"date"===i?NaN:""}}_isDomainCompatible(e){const{field:t}=this;if("coded-value"===e?.type){const i=typeof e.codedValues[0].code;if("string"===i&&c.isStringField(t)||"number"===i&&c.isNumericField(t))return!0}return!!("range"===e?.type&&c.isNumericField(t)||h.isAnyDateField(t)||c.isTimeOnlyField(t))}_validate(){const{dataType:e,domain:t,field:i,initialFeature:r,minLength:l,range:n,required:a,valid:o,value:s}=this,u=a&&null==s,p=void 0!==o;return!u&&r.getAttribute(i.name)===s&&p?null:u?c.TypeValidationError.INVALID_TYPE:"text"===e&&l>-1&&"string"==typeof s&&s.length<l?g.LengthValidationError.TOO_SHORT:"date"!==e||null==s||x.dateTimeIsInRange({type:i.type,range:n,value:s})?t?null!==s||a?m.validateDomainValue(i,s):null:c.validateFieldValue(i,s):c.NumericRangeValidationError.OUT_OF_RANGE}};e.__decorate([r.property()],V.prototype,"_dateFormRange",null),e.__decorate([r.property()],V.prototype,"_dateRange",null),e.__decorate([r.property()],V.prototype,"_storedValue",void 0),e.__decorate([r.property()],V.prototype,"_configAllowsEdits",null),e.__decorate([r.property()],V.prototype,"_layerAndFieldAllowEdits",null),e.__decorate([r.property()],V.prototype,"_isVisibleByDefault",null),e.__decorate([r.property()],V.prototype,"_isEditTrackingField",null),e.__decorate([r.property()],V.prototype,"_shouldUseValueExpression",null),e.__decorate([r.property()],V.prototype,"_isSubtypeField",null),e.__decorate([r.property()],V.prototype,"dataType",null),e.__decorate([r.property()],V.prototype,"dateDataType",null),e.__decorate([r.property()],V.prototype,"description",null),e.__decorate([r.property()],V.prototype,"domain",null),e.__decorate([r.property()],V.prototype,"editable",null),e.__decorate([r.property({readOnly:!0})],V.prototype,"error",void 0),e.__decorate([r.property({constructOnly:!0})],V.prototype,"preservesValueWhenHidden",void 0),e.__decorate([r.property()],V.prototype,"evaluatedRequiredExpression",null),e.__decorate([r.property()],V.prototype,"evaluatedValueExpression",null),e.__decorate([r.property()],V.prototype,"field",void 0),e.__decorate([r.property()],V.prototype,"group",void 0),e.__decorate([r.property({readOnly:!0})],V.prototype,"hint",null),e.__decorate([r.property()],V.prototype,"includeDate",null),e.__decorate([r.property()],V.prototype,"includeTime",null),e.__decorate([r.property()],V.prototype,"includeTimeOffset",null),e.__decorate([r.property()],V.prototype,"initialFeature",null),e.__decorate([r.property({readOnly:!0})],V.prototype,"inputType",null),e.__decorate([r.property()],V.prototype,"hasInvalidSwitchValue",null),e.__decorate([r.property()],V.prototype,"isRelationshipKeyField",null),e.__decorate([r.property()],V.prototype,"label",null),e.__decorate([r.property()],V.prototype,"maxLength",null),e.__decorate([r.property()],V.prototype,"minLength",null),e.__decorate([r.property({readOnly:!0})],V.prototype,"name",null),e.__decorate([r.property()],V.prototype,"range",null),e.__decorate([r.property()],V.prototype,"required",null),e.__decorate([r.property()],V.prototype,"requiredExpressionExecutor",void 0),e.__decorate([r.property()],V.prototype,"showNoValueOptionEnabled",null),e.__decorate([r.property()],V.prototype,"submittable",null),e.__decorate([r.property()],V.prototype,"timeResolution",null),e.__decorate([r.property()],V.prototype,"timeStep",null),e.__decorate([r.property({readOnly:!0})],V.prototype,"type",void 0),e.__decorate([r.property()],V.prototype,"updating",null),e.__decorate([r.property()],V.prototype,"valid",null),e.__decorate([r.property({value:null})],V.prototype,"value",null),e.__decorate([r.property()],V.prototype,"valueExpressionExecutor",void 0),e.__decorate([r.property()],V.prototype,"visible",null),V=e.__decorate([o.subclass("esri.widgets.FeatureForm.FieldInput")],V);const F=e=>e&&!Number.isNaN(e.valueOf());return V}));
