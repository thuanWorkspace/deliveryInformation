/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../Feature/FeatureRelationship/FeatureRelationshipViewModel","../Feature/support/featureUtils","./EditableInput","./featureFormUtils"],(function(e,t,r,o,i,a,l,s,p,n,d,u){"use strict";const y=3;let h=class extends d{constructor(e){super(e),this._relationshipVM=null,this.group=null,this.type="relationship",this.addHandles([t.watch((()=>({feature:this.feature,element:this.element,layer:this.layer})),(e=>this._createRelationshipVM(e)),t.initial)])}destroy(){this._relationshipVM?.destroy()}get canAddRelatedFeature(){const{editable:e,featureCount:t,relationship:r}=this;if(!r||!this.loaded||!this.relatedLayerAllowsAdds)return!1;const{cardinality:o,role:i}=r;return!("one-to-one"===o&&t>0)&&("many-to-many"!==o&&(!("one-to-many"===o&&"destination"===i&&t>0)&&e))}get displayCount(){return this.element.displayCount??y}get displayType(){return this.element.displayType}get editable(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!0)}get featureCount(){return this._relationshipVM?.featureCount??0}get loaded(){return"loading"!==this._relationshipVM?.state}get map(){return this._get("map")}set map(e){e&&this._relationshipVM?.set("map",e),this._set("map",e)}get orderByFields(){return this.element.orderByFields}get originHasValidKey(){return!(!this.relationship||!this.feature.getAttribute(this.relationship.keyField))}get relationship(){return this._relationshipVM?.relationship}get relationshipId(){return this.element.relationshipId}get relatedFeatureInfos(){const{_relationshipVM:e,timeZone:t}=this;if(!e?.relatedFeatures?.length||!e?.relatedLayer)return[];const{itemDescriptionFieldName:r,relatedFeatures:o,relatedLayer:i}=e,a=i&&"formTemplate"in i&&i.formTemplate?i.formTemplate.title:void 0;return o.map((e=>{let o;if(r){const a=e.getAttribute(r),l=i.fieldsIndex.get(r);if(l){const e=u.getComputedAttributes({values:[a],fields:[l],timeZone:t??void 0})[r];null!=e&&(o=e.toString())}}return{feature:e,description:o,title:a?u.parseFormTemplateString({label:a,attributes:e.attributes,fieldsIndex:i.fieldsIndex,timeZone:t}):void 0}})).toArray()}get relatedLayer(){return this._relationshipVM?.relatedLayer}get relatedLayerIsTable(){return!!this.relatedLayer?.isTable}get relatedLayerAllowsAdds(){const{relatedLayer:e}=this;if(!e||!this.relatedLayerAllowsEdits)return!1;const t=s.getEffectiveLayerCapabilities(e);return!!t?.operations?.supportsAdd}get relatedLayerAllowsEdits(){const{relatedLayer:e}=this;if(!e)return!1;const t=s.getEffectiveLayerCapabilities(e);return!!t?.operations?.supportsEditing}get showAllEnabled(){return this._get("showAllEnabled")}set showAllEnabled(e){this._relationshipVM?.set("showAllEnabled",e),this._set("showAllEnabled",e)}get showAllActionVisible(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}get visible(){const{relationship:e}=this;if(!e)return!1;const{cardinality:t}=e;return"many-to-many"!==t&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element)}get updating(){return"loading"===this._relationshipVM?.state||"querying"===this._relationshipVM?.state}incrementPage(){this._relationshipVM&&this._relationshipVM.featurePage++}getRelatedFeatureByObjectId(e){return this._relationshipVM?.getRelatedFeatureByObjectId(e)}_createRelationshipVM(e){const{feature:t,element:r,layer:o}=e;if(this._relationshipVM?.destroy(),!t||!r||!o)return;const{displayCount:i,map:a,orderByFields:l,relationshipId:s,showAllEnabled:d}=this;n.isRelatableFeatureSupportedLayer(o)&&(this._relationshipVM=new p({graphic:t,displayCount:i,layer:o,map:a,orderByFields:l,relationshipId:s,showAllEnabled:d}))}};e.__decorate([r.property()],h.prototype,"_relationshipVM",void 0),e.__decorate([r.property()],h.prototype,"canAddRelatedFeature",null),e.__decorate([r.property()],h.prototype,"displayCount",null),e.__decorate([r.property()],h.prototype,"displayType",null),e.__decorate([r.property()],h.prototype,"editable",null),e.__decorate([r.property()],h.prototype,"featureCount",null),e.__decorate([r.property()],h.prototype,"group",void 0),e.__decorate([r.property()],h.prototype,"loaded",null),e.__decorate([r.property()],h.prototype,"map",null),e.__decorate([r.property()],h.prototype,"orderByFields",null),e.__decorate([r.property()],h.prototype,"originHasValidKey",null),e.__decorate([r.property()],h.prototype,"relationship",null),e.__decorate([r.property()],h.prototype,"relationshipId",null),e.__decorate([r.property()],h.prototype,"relatedFeatureInfos",null),e.__decorate([r.property()],h.prototype,"relatedLayer",null),e.__decorate([r.property()],h.prototype,"relatedLayerIsTable",null),e.__decorate([r.property()],h.prototype,"relatedLayerAllowsAdds",null),e.__decorate([r.property()],h.prototype,"relatedLayerAllowsEdits",null),e.__decorate([r.property()],h.prototype,"showAllEnabled",null),e.__decorate([r.property()],h.prototype,"showAllActionVisible",null),e.__decorate([r.property({readOnly:!0})],h.prototype,"type",void 0),e.__decorate([r.property()],h.prototype,"visible",null),e.__decorate([r.property()],h.prototype,"updating",null),h=e.__decorate([l.subclass("esri.widgets.FeatureForm.RelationshipInput")],h);return h}));
