/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/promiseUtils","../../../geometry/Multipoint","../../../geometry/support/coordsUtils","../../../geometry/support/spatialReferenceUtils","../../../views/support/QueueProcessor","../../../views/support/Scheduler","./constants","./geometryUtils","./ProfileGenerationError","./statisticsUtils","../../support/traversalUtils"],(function(e,t,r,o,n,s,i,l,a,u,c,p,f,d){"use strict";async function*h(e,t){const{view:r,geometry:n,elevationInfo:s,providers:i,options:l}=e,a=r.spatialReference;if(!a||null==n||!c.isValidInputPath(n))throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.InvalidGeometry);const f=i.length;if(0===f)return null;const d=Math.round(l.maxTotalSamples/f);if(c.countPoints(n)>d)throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.TooComplex);const h=await c.densifyPath(n,s,r,a,l,d,t);let y=0;const g=new Array(f),w=new Array(f);for(let o=0;o<f;o++){const r=E(h);g[o]=r,y+=r.samples.length;const n={...e,provider:i[o],result:r,densificationResult:h};w[o]=m(n,t)[Symbol.iterator]()}if(y>l.maxTotalSamples)throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.TooComplex);const P=await Promise.all(w.map((e=>{const t=e.next();return!0===t.done?Promise.resolve(null):t.value})));o.throwIfAborted(t);for(let o=0;o<f;o++)g[o]=P[o];yield g,await o.after(e.delayAfterPreview??u.getConfig().delayAfterPreviewMillis,null,t.signal);const v=[];try{let e;do{e=!1;for(let t=0;t<f;t++){const r=w[t].next();!1===r.done&&(v.push({resultPromise:r.value,index:t}),e=!0)}}while(e)}finally{w.forEach((e=>e.return?.()))}for(const{resultPromise:u,index:c}of v)g[c]=await u,o.throwIfAborted(t),yield g;for(const o of g)null!=o&&(o.progress=1);yield g}function*m(e,r){const{densificationResult:o}=e,n={...e,abortOptions:r,densificationResult:o},s=d.breadthFirstBinaryPartitioning(0,n.result.samples.length),i=s.slice(0,n.provider.numSamplesForPreview);yield y(n,i,!0);const l=t.splitIntoChunks(s,n.provider.numSamplesPerChunk);for(const t of l)yield y(n,t,!1)}async function y({densificationResult:e,result:t,provider:r,queue:s,abortOptions:i,cache:l},a,c){const{densifiedPath:p,pathLength:f}=e,d=t.spatialReference,{samples:h}=t,m=[];for(let o=0;o<a.length;o++){const e=h[a[o]];m[o]=e.coordinate}try{return await s.push({geometry:new n({spatialReference:d,points:m,hasZ:p.hasZ}),provider:r,indices:a,preview:c,result:t,queryOptions:{...u.getConfig().defaultQueryOptions(),minDemResolution:c?Math.round(f/r.numSamplesForPreview):Math.round(f/h.length),cache:l}},i),{...t}}catch(y){return o.isAbortError(y)?null:u.errorResult}}function g(e){return new l.QueueProcessor({priority:a.TaskPriority.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:async e=>{o.throwIfAborted(e.queryOptions);try{await w(e)}catch(t){o.throwIfNotAbortError(t)}}})}async function w({geometry:e,provider:t,indices:r,preview:o,result:n,queryOptions:s}){if(0===r.length)return;const i=(await C(t,e,s)).geometry,{hasZ:l,points:a}=i,u=s.noDataValue,{samples:c}=n;for(let p=0;p<r.length;p++){const e=c[r[p]];if(e.isHole)continue;const t=l?a[p][2]:null;null===t||t===u?e.sampledZ=null:(n.hasZ=!0,e.sampledZ=t),e.sampled=!0}P(c),n.progress=o?0:n.progress+r.length/c.length,n.statistics=f.getStatistics(n.samples,n.spatialReference)}function P(e){const t=e.length-1;let r=0;for(let o=1;o<=t;o++){(e[o].sampled||o===t)&&(v(e,r,o),r=o)}}function v(e,t,o){if(o-t==1)return;const n=e[t],s=n.sampledZ,i=e[o],l=i.sampledZ;if(null==s||null==l){for(let r=t+1;r<o;r++)e[r].sampledZ=null;return}const a=n.distance,u=i.distance-a;for(let c=t+1;c<o;c++){const t=e[c],o=(t.distance-a)/u;t.sampledZ=r.lerp(s,l,o)}}function E({densifiedPath:e,distances:t}){const r=e.spatialReference,o=i.getInfo(r),n=e.paths,l=n.length,a=[];let u=null,c=0;for(let i=0;i<l;i++){const e=n[i],r=e.length,l=t[i];for(let t=0;t<r;t++){const r=e[t],n=l[t];o&&(r[0]=s.unnormalizedCoordinate(r[0],o.valid[0],o.valid[1])),u&&0===t&&R(a,u,r,c,n),a.push(Z(r,n)),u=r,c=n}}return{progress:0,samples:a,hasZ:!1,statistics:null,spatialReference:r}}function R(e,t,r,o,n){e.push(b(t,o)),e.push(b(r,n))}function Z(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!1,isHole:!1}}function b(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!0,isHole:!0}}async function C(e,t,r){try{return await e.queryElevation(t,r)}catch(o){throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.ElevationQueryError)}}e.createProfileQueue=g,e.generateProfile=m,e.generateProfiles=h,e.interpolateElevations=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
