/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../core/Collection","../core/events","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./support/globalCss","./support/legacyIcon","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./support/widgetUtils","./TableList/ListItem","./TableList/TableListViewModel","./TableList/support/tableListUtils","../chunks/sortable.esm"],(function(e,t,s,i,o,n,r,a,l,c,d,u,m,h,_,g,p,b,y,I,v){"use strict";function f(e,t,s){e.splice(s,0,e.splice(t,1)[0])}const A=t.ofType(b),S="root-tables",w="data-layer-uid",C="layerUid",T="esri-table-list",$={base:T,widgetIcon:u.legacyIcon.table,noItems:`${T}__no-items`,list:`${T}__list`,listRoot:`${T}__list--root`,item:`${T}__item`,itemChosen:`${T}__item--chosen`,itemMessage:`${T}__item--has-message`,itemSelectable:`${T}__item--selectable`,itemContainer:`${T}__item-container`,actionsMenu:`${T}__item-actions-menu`,actionsMenuItem:`${T}__item-actions-menu-item`,actionsMenuItemActive:`${T}__item-actions-menu-item--active`,actions:`${T}__item-actions`,actionsList:`${T}__item-actions-list`,action:`${T}__item-action`,actionIcon:`${T}__item-action-icon`,actionImage:`${T}__item-action-image`,actionTitle:`${T}__item-action-title`,actionToggle:`${T}__action-toggle`,actionToggleOn:`${T}__action-toggle--on`,message:`${T}__item-message`,title:`${T}__item-title`,publishing:`${T}__publishing`},x={actions:"actions",actionSection:"action-section",items:"items"};function M(e){const{actionsOpen:t}=e;t&&(e.actionsOpen=!1)}const k={statusIndicators:!0,errors:!1};let E=class extends c{constructor(e,t){super(e,t),this._sortable=null,this._sortableNode=null,this._focusSortUid=null,this.visibleItems=null,this.iconClass=$.widgetIcon,this.icon=null,this.messages=null,this.messagesCommon=null,this.multipleSelectionEnabled=!1,this.selectionEnabled=!1,this.selectedItems=new A,this.viewModel=new y,this.visibleElements={...k}}initialize(){this._setVisibleItems(this.tableItems),this.addHandles([i.watch((()=>this.visibleElements),(()=>this._itemsChanged())),i.on((()=>this.viewModel.tableItems),"change",(()=>this._itemsChanged())),i.watch((()=>this.selectionEnabled),(()=>this._toggleSorting()),i.initial)])}destroy(){this._destroySortable()}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get listItemCreatedFunction(){return this.viewModel.listItemCreatedFunction}set listItemCreatedFunction(e){this.viewModel.listItemCreatedFunction=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get tableItems(){return this.viewModel.tableItems}castVisibleElements(e){return{...k,...e}}triggerAction(e,t){return this.viewModel.triggerAction(e,t)}render(){const{visibleItems:e}=this,t=this.viewModel?.state,s={[d.globalCss.hidden]:"loading"===t,[d.globalCss.disabled]:"disabled"===t};return g.tsx("div",{class:this.classes($.base,d.globalCss.widget,d.globalCss.panel,s)},e?.length?this._renderList():this._renderNoItems())}_renderNoItems(){return g.tsx("div",{class:$.noItems},this.messages.noItemsToDisplay)}_renderList(){const{visibleItems:e,messages:t,selectionEnabled:s}=this;return g.tsx("ul",{afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"aria-label":t.widgetLabel,bind:this,class:this.classes($.list,$.listRoot),"data-node-ref":"_sortableNode",role:s?"listbox":void 0},e?.map((e=>this._renderItem(e))).toArray())}_renderItem(e){const{id:t,selectionEnabled:s,selectedItems:i}=this,o=`${`${t}_${e.uid}`}__title`,n=this._hasMessage(e),r={[$.itemMessage]:!!n,[$.itemSelectable]:s};if(s){const t={[w]:e.layer?.uid};return g.tsx("li",{afterCreate:this._focusListItem,afterUpdate:this._focusListItem,"aria-labelledby":o,"aria-selected":I.findSelectedItem(e,i)?"true":"false",bind:this,class:this.classes($.item,r),"data-item":e,key:`item-with-selection-${e.uid}`,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,role:"option",tabIndex:0,...t},this._renderItemContent(e,o))}return g.tsx("li",{afterCreate:this._focusListItem,afterUpdate:this._focusListItem,"aria-labelledby":o,bind:this,class:this.classes($.item,r),key:`item-no-selection-${e.uid}`},this._renderItemContent(e,o))}_renderActionsMenuIcon(e,t){const{messagesCommon:s}=this,i={[$.actionsMenuItemActive]:e.actionsOpen};return g.tsx("div",{"aria-controls":t,"aria-label":s.options,bind:this,class:this.classes($.actionsMenuItem,i),"data-item":e,key:"actions-menu-toggle",onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,role:"button",tabIndex:0,title:s.options},g.tsx("span",{"aria-hidden":"true",class:u.legacyIcon.handleHorizontal}))}_renderActionsMenu(e,t,s,i){const o=1===s&&this._getSingleActionButton(t),n=o?this._renderAction({item:e,action:o,singleAction:!0}):null,r=!o&&s?this._renderActionsMenuIcon(e,i):null;return r||o?g.tsx("div",{class:$.actionsMenu,key:"actions-menu"},n,r):null}_renderItemMessage(e){return e.error?g.tsx("div",{class:$.message,key:"esri-table-list__error",role:"alert"},g.tsx("span",{"aria-hidden":"true",class:u.legacyIcon.noticeTriangle}),this.messages.tableError):null}_renderItemStatus(e){const{visibleElements:t}=this;if(!t.statusIndicators)return null;const{publishing:s}=e;return g.tsx("span",{class:this.classes({[$.publishing]:s}),key:"layer-item-status"})}_renderItemContent(e,t){const{id:s}=this,i=`${`${s}_${e.uid}`}_actions`,o=this._filterActions(e.actionsSections),n=this._countActions(o);return[g.tsx("div",{class:$.itemContainer,key:"list-item-container"},this._renderTitle(e,t),this._renderItemStatus(e),this._renderActionsMenu(e,o,n,i)),this._renderItemMessage(e),n?this._renderActionsSections(e,o,i):null]}_renderTitle(e,t){const{messages:s}=this,i=e.title||s.untitledTable;return g.tsx("span",{class:$.title,id:t,key:"layer-title-container"},i)}_renderActionsSections(e,t,s){const i=t.toArray().map(((t,s)=>g.tsx("ul",{class:$.actionsList,key:`${e}-action-section-${s}`},this._renderActionSection(e,t))));return g.tsx("div",{"aria-expanded":e.actionsOpen?"true":"false",class:$.actions,hidden:!e.actionsOpen||null,id:s,key:"actions-section",role:"group"},i)}_renderActionSection(e,t){return(t&&t.toArray()).map((t=>this._renderAction({item:e,action:t})))}_renderActionIcon(e){const{active:t,className:s}=e,i=this._getIconImageStyles(e),o="button"!==e.type||e.image||s?s:u.legacyIcon.defaultAction,n={[$.actionImage]:!t&&!!i["background-image"],[u.legacyIcon.loadingIndicator]:t,[d.globalCss.rotating]:t};return o&&!t&&(n[o]=!0),g.tsx("span",{"aria-hidden":"true",class:this.classes($.actionIcon,n),key:"action-icon",styles:i})}_renderActionTitle(e,t){return t?null:g.tsx("span",{class:$.actionTitle,key:"action-title"},e)}_renderAction(e){const{item:t,action:s,singleAction:i}=e,{active:o,disabled:n,title:r}=s,a={[$.actionsMenuItem]:i&&"button"===s.type,[$.action]:o||!i&&"toggle"!==s.type,[$.actionToggle]:!o&&"toggle"===s.type,[$.actionToggleOn]:!o&&"toggle"===s.type&&s.value,[d.globalCss.disabledElement]:n},l=[this._renderActionIcon(s),this._renderActionTitle(r,i)];return i?g.tsx("div",{"aria-label":r,bind:this,classes:a,"data-action":s,"data-item":t,key:`single-action-${s.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:0,title:r??void 0},l):g.tsx("li",{"aria-label":r,bind:this,classes:a,"data-action":s,"data-item":t,key:`action-${s.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:0,title:r??void 0},l)}_hasMessage(e){return!!e.error}_filterActions(e){return e.map((e=>e.filter((e=>e.visible))))}_setVisibleItems(e){this.visibleItems=e?.filter((e=>!e.hidden&&(this.visibleElements.errors||!e.error)))}_destroySortable(){const{_sortable:e}=this;e&&e.destroy(),this._sortable=null}_toggleSorting(){const{_sortable:e,_sortableNode:t,selectionEnabled:s}=this;if(t)if(e)e.option("disabled",!s);else{const e=v.Sortable.create(t,{dataIdAttr:w,group:S,fallbackTolerance:4,disabled:!s,onSort:()=>this._sortTablesToItems(e.toArray()),chosenClass:$.itemChosen});this._sortable=e}}_sortNodeCreated(e){this._sortableNode=e,this._toggleSorting()}_sortTablesToItems(e){const t=this.map?.tables;t&&t.sort(((t,s)=>{const i=e.indexOf(t.uid),o=e.indexOf(s.uid);return i>o?-1:i<o?1:0}))}_getSingleActionButton(e){return e.reduce((e=>e)).filter((e=>e&&"button"===e.type)).at(0)}_focusListItem(e){const{_focusSortUid:t}=this;if(!e||!t)return;const s=L(e);s.layer?.uid===t&&(e.focus(),this._focusSortUid=null)}_watchActionSectionChanges(e){const t=()=>this.scheduleRender();this.addHandles(e.on("change",t),x.actionSection),e.forEach((e=>this._renderOnActionChanges(e)))}_renderOnActionChanges(e){const t=()=>this.scheduleRender();"toggle"!==e.type?"slider"!==e.type?this.addHandles(i.watch((()=>[e.className,e.image,e.id,e.title,e.visible]),t,i.initial),x.actions):this.addHandles(i.watch((()=>[e.className,e.id,e.title,e.visible,e.value,e.displayValueEnabled,e.max,e.min,e.step]),t,i.initial),x.actions):this.addHandles(i.watch((()=>[e.className,e.image,e.id,e.title,e.visible,e.value]),t,i.initial),x.actions)}_renderOnItemChanges(e){const t=()=>this.scheduleRender();this.addHandles([i.watch((()=>[e.actionsOpen,e.title,e.error,e.publishing]),t,i.initial),i.watch((()=>[e.hidden,e.error]),(()=>this._setVisibleItems(this.tableItems))),e.actionsSections.on("change",t)],x.items),e.actionsSections.forEach((e=>this._watchActionSectionChanges(e)))}_itemsChanged(){const{tableItems:e}=this.viewModel;this._setVisibleItems(e),this.removeHandles(x.actionSection),this.removeHandles(x.actions),this.removeHandles(x.items),e.forEach((e=>this._renderOnItemChanges(e))),this.scheduleRender()}_countActions(e){return e.reduce(((e,t)=>e+t.length),0)}_getIconImageStyles(e){const t="esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?`url("${t}")`:void 0}}_selectionKeydown(e){const t=["ArrowDown","ArrowUp"],i=s.eventKey(e);if(!t.includes(i))return void this._toggleSelection(e);e.stopPropagation();const o=e.currentTarget["data-item"],{_sortable:n,selectedItems:r}=this;if(!n)return;const a=I.findSelectedItem(o,r),l=n.toArray(),c=e.target,d=l.indexOf(c.dataset[C]);if(-1!==d){if("ArrowDown"===i){const e=d+1;if(e>=l.length)return;a?(f(l,d,e),n.sort(l),this._sortTablesToItems(n.toArray()),this._focusSortUid=o.layer?.uid):(this._focusSortUid=o.layer?.uid,this.scheduleRender())}if("ArrowUp"===i){const e=d-1;if(e<=-1)return;a?(f(l,d,e),n.sort(l),this._sortTablesToItems(n.toArray()),this._focusSortUid=o.layer?.uid):(this._focusSortUid=o.layer?.uid,this.scheduleRender())}}}_toggleActionsOpen(e){const t=L(e.currentTarget),{actionsOpen:s}=t,i=!s;i&&this.tableItems.forEach((e=>M(e))),t.actionsOpen=i,e.stopPropagation()}_triggerAction(e){const t=e.currentTarget,s=O(t),i=L(t);"toggle"===s.type&&(s.value=!s.value),this.triggerAction(s,i),e.stopPropagation()}_toggleSelection(e){e.stopPropagation();const{multipleSelectionEnabled:t,selectedItems:s}=this,i=t&&(e.metaKey||e.ctrlKey),o=L(e.currentTarget),n=I.findSelectedItem(o,s),{length:r}=s;if(!i)return r&&!(n&&1===r)?(s.removeAll(),void s.add(o)):void(n?s.remove(n):s.add(o));n?s.remove(n):s.add(o)}get test(){return{visibleItems:this.visibleItems}}};function O(e){return e["data-action"]}function L(e){return e["data-item"]}e.__decorate([o.property()],E.prototype,"visibleItems",void 0),e.__decorate([o.property()],E.prototype,"iconClass",void 0),e.__decorate([o.property()],E.prototype,"icon",void 0),e.__decorate([o.property()],E.prototype,"label",null),e.__decorate([o.property()],E.prototype,"listItemCreatedFunction",null),e.__decorate([o.property()],E.prototype,"map",null),e.__decorate([o.property(),h.messageBundle("esri/widgets/TableList/t9n/TableList")],E.prototype,"messages",void 0),e.__decorate([o.property(),h.messageBundle("esri/t9n/common")],E.prototype,"messagesCommon",void 0),e.__decorate([o.property()],E.prototype,"multipleSelectionEnabled",void 0),e.__decorate([o.property()],E.prototype,"selectionEnabled",void 0),e.__decorate([o.property()],E.prototype,"selectedItems",void 0),e.__decorate([o.property({readOnly:!0})],E.prototype,"tableItems",null),e.__decorate([_.vmEvent("trigger-action"),o.property({type:y})],E.prototype,"viewModel",void 0),e.__decorate([o.property()],E.prototype,"visibleElements",void 0),e.__decorate([n.cast("visibleElements")],E.prototype,"castVisibleElements",null),e.__decorate([m.accessibleHandler()],E.prototype,"_toggleActionsOpen",null),e.__decorate([m.accessibleHandler()],E.prototype,"_triggerAction",null),e.__decorate([m.accessibleHandler()],E.prototype,"_toggleSelection",null),E=e.__decorate([l.subclass("esri.widgets.TableList")],E);return E}));
