/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../support/GeolocationPositioning"],(function(t,i,r,o,e,s,a,n){"use strict";const c=15e3,h="esri.widgets.Track.TrackViewModel";let l=class extends n{constructor(t){super(t),this._watchId=void 0,this._trackStartingTimeoutId=void 0,this._settingPosition=null,this._trackController=null,this.positionFilterFunction=null}destroy(){this._stopTracking()}get state(){return this._geolocationUsable?this.view&&!this.view.ready?"disabled":this._settingPosition||void 0!==this._trackStartingTimeoutId?"waiting":this.tracking?"tracking":"ready":"feature-unsupported"}get tracking(){return void 0!==this._watchId}start(){"disabled"!==this.state&&"feature-unsupported"!==this.state&&this._startTracking()}stop(){"disabled"!==this.state&&"feature-unsupported"!==this.state&&this._stopTracking()}_stopWatchingPosition(){void 0!==this._watchId&&(navigator.geolocation.clearWatch(this._watchId),this._watchId=void 0)}_stopTracking(){this._abortTrack(),this._clearWaitingTimer(),this._stopWatchingPosition(),this._clearGraphic()}_startTracking(){this._stopTracking();const t=i.debounce((async t=>{this._abortTrack();const r=new AbortController;this._trackController=r;const{timestamp:o,coords:e}=t,s={timestamp:o,coords:{...e}};try{if("function"==typeof this.positionFilterFunction&&!this.positionFilterFunction.call(null,{position:s}))return;if(await this.updatePosition(t,r),this._trackController!==r)return;this._clearWaitingTimer(),this._addGraphic(),this.emit("track",{position:t}),this._trackController=null}catch(a){if(i.isAbortError(a))return;throw this._trackController=null,this._emitError(a),this._clearWaitingTimer(),a}}),0);this._watchId=navigator.geolocation.watchPosition((r=>{this._settingPosition=t(r).catch(i.ignoreAbortErrors)}),this._handleWatchPositionError.bind(this),this.geolocationOptions??void 0),this._trackStartingTimeoutId=setTimeout((()=>{this._trackStartingTimeoutId=void 0}),c)}_handleWatchPositionError(t){t.code===t.PERMISSION_DENIED&&this._stopTracking(),this._emitError(t)}_abortTrack(){this._trackController?.abort(),this._trackController=null}_clearWaitingTimer(){clearTimeout(this._trackStartingTimeoutId),this._trackStartingTimeoutId=void 0,this._settingPosition=null}_emitError(t){this.emit("track-error",{error:t})}};t.__decorate([r.property()],l.prototype,"_watchId",void 0),t.__decorate([r.property()],l.prototype,"_trackStartingTimeoutId",void 0),t.__decorate([r.property()],l.prototype,"_settingPosition",void 0),t.__decorate([r.property()],l.prototype,"positionFilterFunction",void 0),t.__decorate([r.property({readOnly:!0})],l.prototype,"state",null),t.__decorate([r.property({readOnly:!0})],l.prototype,"tracking",null),t.__decorate([r.property()],l.prototype,"start",null),t.__decorate([r.property()],l.prototype,"stop",null),l=t.__decorate([a.subclass(h)],l);return l}));
