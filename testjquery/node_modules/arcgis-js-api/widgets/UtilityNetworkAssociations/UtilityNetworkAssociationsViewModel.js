/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Accessor","../../core/Collection","../../core/Error","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../geometry/Extent","../../geometry/Point","../../geometry/projection","../../layers/GraphicsLayer","../../symbols/LineSymbolMarker","../../symbols/SimpleLineSymbol","../../views/draw/support/layerUtils","../../intl/locale","../../intl/messages"],(function(t,i,e,s,o,r,n,a,c,l,h,y,u,p,m,d,A,w,v,_,L,S,b){"use strict";let g=class extends s{constructor(t){super(t),this._internalGraphicsLayerConnectivity=this._createInternalGraphicsLayer("Connectivity Associations (Internal)"),this._internalGraphicsLayerStructuralAttachment=this._createInternalGraphicsLayer("Structural Attachment Associations (Internal)"),this._initialValidationsFinished=!1,this._updatingHandles=new p.UpdatingHandles,this.autoRefreshAssociations=!1,this.connectivityAssociationsLineSymbol=new _({style:"short-dash",width:2,color:[190,159,159,1]}),this.executionError="",this.loadErrors=new o,this.maxAllowableAssociations=250,this.showAssociationsEnabled=!1,this.showArrowsConnectivity=!1,this.showArrowsStructuralAttachment=!1,this.structuralAttachmentAssociationsLineSymbol=new _({style:"short-dash",width:2,color:[159,190,159,1]})}initialize(){const t=async()=>{this.messages||(this.messages=await b.fetchMessageBundle("esri/widgets/UtilityNetworkAssociations/t9n/UtilityNetworkAssociations"))};t().then((()=>{this.view||(this.view=null),this.utilityNetwork||(this.utilityNetwork=null),this.addHandles([a.watch((()=>[this.view,this.utilityNetwork]),(async()=>{const{loadErrors:t,messages:{info:{noUtilityNetwork:i,noView:e}}}=this;this._initialValidationsFinished=!1,t.removeAll();let s=!1,o=!1;this.removeAssociations(),"utility"!==this.utilityNetwork?.type?(this.loadErrors.push(i),n.getLogger(this).error(new r("utilityNetworkAssociations:missing-property",i))):(this.utilityNetwork.loaded||await this.utilityNetwork.load(),s=!0),"2d"!==this.view?.type?(this.loadErrors.push(e),n.getLogger(this).error(new r("utilityNetworkAssociations:missing-property",e))):(L.addUniqueLayer(this.view,this._internalGraphicsLayerConnectivity),L.addUniqueLayer(this.view,this._internalGraphicsLayerStructuralAttachment),o=!0),s&&o&&this.showAssociationsEnabled&&await this.showAssociations(),this._internalGraphicsLayerConnectivity.visible=this.includeConnectivityAssociations,this._internalGraphicsLayerStructuralAttachment.visible=this.includeStructuralAttachmentAssociations,this._initialValidationsFinished=!0}),{initial:!0}),a.watch((()=>[this.view?.stationary,this.showAssociationsEnabled,this.maxAllowableAssociations]),(async()=>{this.view?.stationary&&this.showAssociationsEnabled&&(this.includeConnectivityAssociations||this.includeStructuralAttachmentAssociations)&&await this.showAssociations()})),a.watch((()=>[this.showArrowsConnectivity]),(()=>{const t=this.connectivityAssociationsLineSymbol.clone();t.marker=null,this.showArrowsConnectivity&&(t.marker=new v({color:this.connectivityAssociationsLineSymbol.color,placement:"end",style:"arrow"}));for(const i of this._internalGraphicsLayerConnectivity.graphics)i.symbol=t})),a.watch((()=>[this.showArrowsStructuralAttachment]),(()=>{const t=this.structuralAttachmentAssociationsLineSymbol.clone();t.marker=null,this.showArrowsStructuralAttachment&&(t.marker=new v({color:this.structuralAttachmentAssociationsLineSymbol.color,placement:"end",style:"arrow"}));for(const i of this._internalGraphicsLayerStructuralAttachment.graphics)i.symbol=t})),a.watch((()=>{const{cap:t,color:i,style:e,width:s,marker:o}=this.connectivityAssociationsLineSymbol;return[t,i,e,s,o]}),(()=>{const t=this.connectivityAssociationsLineSymbol.clone();for(const i of this._internalGraphicsLayerConnectivity.graphics)i.symbol=t;this.showArrowsConnectivity=!1,t.marker=null,this.connectivityAssociationsLineSymbol.marker&&(this.showArrowsConnectivity=!0,t.marker=new v({color:this.connectivityAssociationsLineSymbol.color,placement:"end",style:"arrow"}))})),a.watch((()=>{const{cap:t,color:i,style:e,width:s,marker:o}=this.structuralAttachmentAssociationsLineSymbol;return[t,i,e,s,o]}),(()=>{const t=this.structuralAttachmentAssociationsLineSymbol.clone();for(const i of this._internalGraphicsLayerStructuralAttachment.graphics)i.symbol=t;this.showArrowsStructuralAttachment=!1,t.marker=null,this.structuralAttachmentAssociationsLineSymbol.marker&&(this.showArrowsStructuralAttachment=!0,t.marker=new v({color:this.structuralAttachmentAssociationsLineSymbol.color,placement:"end",style:"arrow"}))})),S.onLocaleChange(t)])}))}destroy(){this._updatingHandles.destroy(),this.view=null,this._removeInternalGraphicsLayers()}set includeConnectivityAssociations(t){this._set("includeConnectivityAssociations",t),this._internalGraphicsLayerConnectivity.visible=t}set includeStructuralAttachmentAssociations(t){this._set("includeStructuralAttachmentAssociations",t),this._internalGraphicsLayerStructuralAttachment.visible=t}get state(){return this.loadErrors.length?"disabled":this._updatingHandles.updating?"executing":""!==this.executionError?"warning":this._initialValidationsFinished?"ready":"loading"}set utilityNetwork(t){this._get("utilityNetwork")!==t&&this._set("utilityNetwork",t)}set view(t){this._get("view")!==t&&this._set("view",t)}removeAssociations(){this._internalGraphicsLayerConnectivity.removeAll(),this._internalGraphicsLayerStructuralAttachment.removeAll()}async showAssociations(){const{messages:{info:{maxAllowableAssociationsExceeded:t,noAssociationsFound:e}},utilityNetwork:s}=this,{spatialReference:o,extent:{xmin:r,ymin:n,xmax:a,ymax:c}}=this.view,l=s?.spatialReference;A.isLoaded()||await A.load();const h=A.project(new d({x:r,y:n,spatialReference:o}),l),y=A.project(new d({x:a,y:c,spatialReference:o}),l),u=new m({xmin:h.x,ymin:h.y,xmax:y.x,ymax:y.y,spatialReference:l});this._set("executionError",""),this.removeAssociations(),this._updatingHandles.addPromise(s?.synthesizeAssociationGeometries({returnConnectivityAssociations:this.includeConnectivityAssociations,returnAttachmentAssociations:this.includeStructuralAttachmentAssociations,extent:u,outSpatialReference:l,maxGeometryCount:this.maxAllowableAssociations}).then((s=>{let o=[],r=[];s?.maxGeometryCountExceeded?this._set("executionError",t):0!==s?.associations.length?s&&(o=s?.associations.filter((({associationType:t})=>"connectivity"===t)).map((t=>(this.connectivityAssociationsLineSymbol.marker=null,this.showArrowsConnectivity&&(this.connectivityAssociationsLineSymbol.marker=new v({color:this.connectivityAssociationsLineSymbol.color,placement:"end",style:"arrow"})),new i({geometry:t.geometry.clone(),symbol:this.connectivityAssociationsLineSymbol})))),r=s.associations.filter((({associationType:t})=>"attachment"===t)).map((t=>(this.structuralAttachmentAssociationsLineSymbol.marker=null,this.showArrowsStructuralAttachment&&(this.structuralAttachmentAssociationsLineSymbol.marker=new v({color:this.structuralAttachmentAssociationsLineSymbol.color,placement:"end",style:"arrow"})),new i({geometry:t.geometry.clone(),symbol:this.structuralAttachmentAssociationsLineSymbol})))),o.length>0&&this._internalGraphicsLayerConnectivity.addMany(o),r.length>0&&this._internalGraphicsLayerStructuralAttachment.addMany(r)):this._set("executionError",e)}),(({message:t})=>{this._set("executionError",t)})))}_createInternalGraphicsLayer(t){return new w({listMode:"hide",internal:!0,title:t})}_removeInternalGraphicsLayers(){this._internalGraphicsLayerConnectivity&&this._internalGraphicsLayerStructuralAttachment&&this.view?.map&&(this.view.map.remove(this._internalGraphicsLayerConnectivity),this.view.map.remove(this._internalGraphicsLayerStructuralAttachment))}};t.__decorate([c.property()],g.prototype,"_initialValidationsFinished",void 0),t.__decorate([c.property()],g.prototype,"autoRefreshAssociations",void 0),t.__decorate([c.property({type:_,nonNullable:!0})],g.prototype,"connectivityAssociationsLineSymbol",void 0),t.__decorate([c.property({readOnly:!0})],g.prototype,"executionError",void 0),t.__decorate([c.property({type:Boolean,value:!0})],g.prototype,"includeConnectivityAssociations",null),t.__decorate([c.property({type:Boolean,value:!0})],g.prototype,"includeStructuralAttachmentAssociations",null),t.__decorate([c.property()],g.prototype,"loadErrors",void 0),t.__decorate([c.property()],g.prototype,"maxAllowableAssociations",void 0),t.__decorate([c.property()],g.prototype,"messages",void 0),t.__decorate([c.property()],g.prototype,"showAssociationsEnabled",void 0),t.__decorate([c.property()],g.prototype,"showArrowsConnectivity",void 0),t.__decorate([c.property()],g.prototype,"showArrowsStructuralAttachment",void 0),t.__decorate([c.property({readOnly:!0})],g.prototype,"state",null),t.__decorate([c.property({type:_,nonNullable:!0})],g.prototype,"structuralAttachmentAssociationsLineSymbol",void 0),t.__decorate([c.property()],g.prototype,"utilityNetwork",null),t.__decorate([c.property()],g.prototype,"view",null),g=t.__decorate([u.subclass("esri.widgets.UtilityNetworkAssociations.UtilityNetworkAssociationsViewModel")],g);return g}));
