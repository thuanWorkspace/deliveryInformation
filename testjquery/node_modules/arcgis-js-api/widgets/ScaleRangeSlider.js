/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../intl","../core/events","../core/maybe","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Slider","./Widget","./ScaleRangeSlider/css","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/number","../intl/substitute"],(function(e,t,i,a,l,s,r,n,c,o,d,u,p,m,v,h,S,_,b,M,w,g,y,x){"use strict";const f={preview:!0,scaleMenus:{maxScaleMenu:!0,minScaleMenu:!0}},I={maximumFractionDigits:0},C="1:",T=16;let R=class extends p{constructor(e,t){super(e,t),this._activeMenu=null,this._activeThumb=null,this._customInput=null,this._maxThumbNode=null,this._minThumbNode=null,this._previewAutoCloseTimeoutId=void 0,this._previewPopover=null,this._slider=new u({thumbCreatedFunction:(e,t,i)=>{0===e?this._minThumbNode=i:1===e&&(this._maxThumbNode=i),this.addHandles([a.on(i,"mouseenter",(()=>{this._activeThumb=e,this.scheduleRender()})),a.on(i,"mouseleave",(()=>{this._previewAutoCloseTimeoutId||(this._activeThumb=null,this.scheduleRender())}))])}}),this.disabled=!1,this.messages=null,this.region="US",this.viewModel=new S,this.visibleElements=f,this._afterInputNumberCreate=e=>{"value"in e&&null!=e.value&&"setNumberValue"in e&&e.setNumberValue({committing:!1,value:e.value,origin:"direct"}),this._customInput=e},this._handleCustomScaleInputChange=(e,t)=>{const{viewModel:{scaleRanges:i}}=this,a=Number.parseFloat(t.value);Number.isNaN(a)?t.value=e:this._setScale(i.clampScale(a))}}loadDependencies(){return _.loadCalciteComponents({button:()=>new Promise(((t,i)=>e(["../chunks/calcite-button"],t,i))),dropdown:()=>new Promise(((t,i)=>e(["../chunks/calcite-dropdown"],t,i))),"dropdown-group":()=>new Promise(((t,i)=>e(["../chunks/calcite-dropdown-group"],t,i))),"dropdown-item":()=>new Promise(((t,i)=>e(["../chunks/calcite-dropdown-item"],t,i))),icon:()=>new Promise(((t,i)=>e(["../chunks/calcite-icon"],t,i))),"input-number":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-number"],t,i))),label:()=>new Promise(((t,i)=>e(["../chunks/calcite-label"],t,i))),popover:()=>new Promise(((t,i)=>e(["../chunks/calcite-popover"],t,i)))})}initialize(){this.addHandles([s.watch((()=>this.viewModel),(e=>this._slider.viewModel=e?.sliderViewModel??null),s.initial),s.watch((()=>this._interactive),(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)}),s.initial),this._slider.on("thumb-drag",(({index:e})=>{this._activeThumb=e,clearTimeout(this._previewAutoCloseTimeoutId);const t=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=void 0,this._activeThumb=null}),t)})),s.when((()=>!0===this.view?.stationary),(()=>this.scheduleRender()))])}destroy(){this._slider=l.destroyMaybe(this._slider)}get _maxScaleMenuEnabled(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.maxScaleMenu}get _minScaleMenuEnabled(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.minScaleMenu}get _interactive(){return"disabled"!==this.viewModel?.state&&!this.disabled}get effectiveMaxScale(){return this.viewModel.effectiveMaxScale}get effectiveMinScale(){return this.viewModel.effectiveMinScale}get effectiveMaxScaleLimit(){return this.viewModel.effectiveMaxScaleLimit}get effectiveMinScaleLimit(){return this.viewModel.effectiveMinScaleLimit}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get maxScale(){return this.viewModel.maxScale}set maxScale(e){this.viewModel.maxScale=e}get maxScaleLimit(){return this.viewModel.maxScaleLimit}set maxScaleLimit(e){this.viewModel.maxScaleLimit=e}get minScale(){return this.viewModel.minScale}set minScale(e){this.viewModel.minScale=e}get minScaleLimit(){return this.viewModel.minScaleLimit}set minScaleLimit(e){this.viewModel.minScaleLimit=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...f,...e,scaleMenus:"boolean"==typeof e?.scaleMenus?e.scaleMenus:{...f.scaleMenus,...e?.scaleMenus}}}formatScale(e){return`${C}${y.formatNumber(e,I)}`}render(){const{_interactive:e,_slider:t,label:i,messages:a,view:l,viewModel:{scaleRanges:s,state:r}}=this,n=a.scaleRangeLabels,c=n[s.findScaleRangeByIndex(t.values[0]).id],o=n[s.findScaleRangeByIndex(t.values[1]).id];return g.tsx("div",{"aria-label":i,class:this.classes(m.css.base,b.globalCss.widget,e?null:b.globalCss.disabled)},g.tsx("div",{class:m.css.scaleIndicatorWrapper,dir:"ltr"},"ready"===r&&l?this._renderCurrentScaleIndicator():null,t.render(),this._renderPreviewPopover()),g.tsx("div",{class:m.css.scaleMenuContainer},this._minScaleMenuEnabled?this._renderScaleMenuToggle("min",c):null,g.tsx("div",{class:m.css.scaleMenuSeparator}),this._maxScaleMenuEnabled?this._renderScaleMenuToggle("max",o):null))}_renderPreviewPopover(){const{_activeThumb:e}=this,t=null!=e&&this.visibleElements.preview,i=t?0===e?this._minThumbNode:this._maxThumbNode:"";return g.tsx("calcite-popover",{afterCreate:M.storeNode,afterUpdate:()=>this._previewPopover?.reposition(),bind:this,"data-node-ref":"_previewPopover",label:this.messages.preview,offsetDistance:T,open:t,overlayPositioning:"fixed",placement:"top",referenceElement:i,triggerDisabled:!0},this._renderScalePreview())}_renderScalePreview(){const{_activeThumb:e,_slider:t,region:i,viewModel:{scaleRanges:a}}=this,l=0===e?t.values[0]:t.values[1],s=Object.keys(h.RecommendedScales).indexOf(a.findScaleRangeByIndex(l).id),r={backgroundImage:v.getScalePreviewSource(i),backgroundPosition:v.getScalePreviewSpriteBackgroundPosition(s)};return g.tsx("div",{class:m.css.scalePreview},g.tsx("div",{class:m.css.scalePreviewThumbnail,styles:r}))}_renderScaleMenuToggle(e,t){const{_activeMenu:i,_interactive:a}=this,l=i===e;return[g.tsx("calcite-dropdown",{closeOnSelectDisabled:!0,open:l,overlayPositioning:"fixed",placement:"max"===e?"bottom-end":"bottom-start",scale:"s",onCalciteDropdownClose:({target:t})=>{this._activeMenu===e&&this._setActiveMenu(null),t.setFocus()},onCalciteDropdownOpen:()=>this._setActiveMenu(e)},g.tsx("calcite-button",{appearance:l?"outline":"transparent","aria-pressed":l.toString(),class:m.css.scaleMenuToggle,"data-type":e,disabled:!a,iconEnd:"chevron-down",scale:"s",slot:"trigger"},t),l&&"max"===e?this._renderMaxScaleMenu():null,l&&"min"===e?this._renderMinScaleMenu():null)]}_renderMinScaleMenu(){const{effectiveMaxScale:e,effectiveMinScaleLimit:t,view:i,viewModel:{scaleRanges:a}}=this,l=i?i.scale:void 0;return this._renderScaleMenu({type:"min",min:t,max:a.findScaleRange(e).minScale,viewScale:l})}_renderMaxScaleMenu(){const{effectiveMinScale:e,effectiveMaxScaleLimit:t,view:i,viewModel:{scaleRanges:a}}=this,l=i?i.scale:void 0;return this._renderScaleMenu({type:"max",min:a.findScaleRange(e).maxScale,max:t,viewScale:l})}_renderScaleMenu({viewScale:e,min:t,max:i,type:a}){const{effectiveMaxScale:l,effectiveMinScale:s,messages:r}=this,n="max"===a?l:s,c=h.fromScaleRange({minScale:t,maxScale:i}),o=this.messages.featuredScaleLabels,d=h.RecommendedScales,u=Object.keys(d).filter((e=>c.contains(d[e]))).map((e=>this._renderScaleMenuItem({scaleLabel:o[e],scaleValue:d[e],isSelected:n===d[e],valueVisible:"world"!==e})));return g.tsx("calcite-dropdown-group",{key:`${this.id}__scale-menu--${a}`},this._renderCustomScaleValue({currentScale:n}),null!=e?this._renderScaleMenuItem({scaleValue:e,scaleLabel:r.featuredScaleLabels.current,isSelected:n===e,valueVisible:!0}):null,u)}_renderCustomScaleValue({currentScale:e}){const{messages:t}=this,i=Math.round(e).toString();return g.tsx("calcite-dropdown-item",{afterCreate:e=>{e.setFocus()},key:"custom-scale",label:t.featuredScaleLabels.custom,onCalciteDropdownItemSelect:()=>{this._customInput?.setFocus()}},g.tsx("calcite-label",{scale:"s"},g.tsx("span",null,t.featuredScaleLabels.custom),g.tsx("calcite-input-number",{afterCreate:this._afterInputNumberCreate,groupSeparator:!0,inputMode:"numeric",max:h.RecommendedScales.world,min:0,numberButtonType:"none",placeholder:t.customScaleInputTooltip,prefixText:C,scale:"s",step:1,value:i,onCalciteInputNumberChange:({target:e})=>this._handleCustomScaleInputChange(i,e)})))}_renderScaleMenuItem(e){const{scaleValue:t,scaleLabel:i,valueVisible:a,isSelected:l}=e;return g.tsx("calcite-dropdown-item",{key:i,label:i,selected:l,onCalciteDropdownItemSelect:this._setScale.bind(this,t)},i,a?g.tsx("div",{class:m.css.scaleMenuSublabel},this.formatScale(t)):void 0)}_renderCurrentScaleIndicator(){const{_slider:e,messages:t,view:i,viewModel:{scaleRanges:a}}=this,l=a.clampScale(i.scale),s=this.viewModel.mapScaleToSlider(l),r=s/e.max,n=t.scaleRangeLabels[a.findScaleRangeByIndex(s).id],c=x.substitute(t.currentScaleTooltip,{scaleLabel:n});return g.tsx("div",{class:m.css.scaleIndicatorContainer,key:"scale-indicator"},g.tsx("div",{"aria-label":c,class:m.css.scaleIndicator,styles:{left:100*r+"%"},title:c},this.renderCurrentScaleIndicatorIcon()))}renderCurrentScaleIndicatorIcon(){return g.tsx("calcite-icon",{class:m.css.scaleIndicatorIcon,icon:"caret-up",scale:"s"})}_setScale(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this.effectiveMinScale-1):this.minScale=Math.max(e,this.effectiveMaxScale+1),this._setActiveMenu(null)}_setActiveMenu(e){this._activeMenu=e}};t.__decorate([r.property()],R.prototype,"_activeMenu",void 0),t.__decorate([r.property()],R.prototype,"_activeThumb",void 0),t.__decorate([r.property()],R.prototype,"_customInput",void 0),t.__decorate([r.property()],R.prototype,"_maxScaleMenuEnabled",null),t.__decorate([r.property()],R.prototype,"_minScaleMenuEnabled",null),t.__decorate([r.property()],R.prototype,"_slider",void 0),t.__decorate([r.property({readOnly:!0})],R.prototype,"_interactive",null),t.__decorate([r.property()],R.prototype,"disabled",void 0),t.__decorate([r.property()],R.prototype,"effectiveMaxScale",null),t.__decorate([r.property()],R.prototype,"effectiveMinScale",null),t.__decorate([r.property()],R.prototype,"effectiveMaxScaleLimit",null),t.__decorate([r.property()],R.prototype,"effectiveMinScaleLimit",null),t.__decorate([r.property()],R.prototype,"label",null),t.__decorate([r.property()],R.prototype,"layer",null),t.__decorate([r.property()],R.prototype,"maxScale",null),t.__decorate([r.property()],R.prototype,"maxScaleLimit",null),t.__decorate([r.property(),w.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],R.prototype,"messages",void 0),t.__decorate([r.property()],R.prototype,"minScale",null),t.__decorate([r.property()],R.prototype,"minScaleLimit",null),t.__decorate([r.property()],R.prototype,"region",void 0),t.__decorate([r.property()],R.prototype,"view",null),t.__decorate([r.property()],R.prototype,"viewModel",void 0),t.__decorate([r.property()],R.prototype,"visibleElements",void 0),t.__decorate([n.cast("visibleElements")],R.prototype,"castVisibleElements",null),R=t.__decorate([d.subclass("esri.widgets.ScaleRangeSlider")],R);return R}));
