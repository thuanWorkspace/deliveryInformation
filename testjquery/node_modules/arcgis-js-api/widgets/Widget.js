/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../intl","../core/deprecate","../core/domUtils","../core/Evented","../core/events","../core/has","../core/lang","../core/Logger","../core/maybe","../core/Promise","../core/promiseUtils","../core/reactiveUtils","../core/uuid","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","../core/accessorSupport/tracking","../core/accessorSupport/tracking/SimpleTrackingTarget","../libs/maquette-advanced-projector/projector","./support/componentsUtils","./support/jsxWidgetSupport","./support/legacyIcon","./support/symbols","./support/tests","./support/vnodeCache","./support/widgetUtils","../intl/locale","../intl/messages"],(function(e,t,r,o,s,i,n,a,d,c,l,p,h,u,y,_,g,v,m,b,f,w,C,S,k,I,N,R,j){"use strict";var P;const T="esri.widgets.Widget";let E=0;const L={widgetIcon:C.legacyIcon.checkboxUnchecked};function F(e,t){for(const r in t)null!=e[r]&&("object"==typeof e[r]&&"object"==typeof t[r]?F(e[r],t?.[r]):e[r]=t[r]);return e}const U=b.createAdvancedProjector({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,r=/capture$/i;e.eventHandlerInterceptor=(e,o,s,i)=>{const n=t?.(e,o,s,i),a=r.test(e);if(!((e=e.replace(r,"")).toLowerCase()in s)||a){const t=e[2].toLowerCase()+e.slice(3),r=e=>n?.call(s,e);s.addEventListener(t,r,a);const o=()=>s.removeEventListener(t,r,a),d=i.afterRemoved;i.afterRemoved=e=>{d?.(e),o()}}return n}},handleInterceptedEvent(e,t,r,o){const{eventPhase:s,type:i}=o,n=s===Event.CAPTURING_PHASE;let a=`on${i}${n?"capture":""}`;const d=t.properties;(d&&a in d||(a=`on${i[0].toUpperCase()}${i.slice(1)}${n?"Capture":""}`,d&&a in d))&&(I.clearVNodeCache(),e.scheduleRender(),d[a].call(d.bind||r,o))}});let H=!1,A=class extends(l.EsriPromiseMixin(s.EventedAccessor)){constructor(e,t){super(e,t),this._attached=!1,this._projector=U,this._readyForTrueRender=!1,this.iconClass=L.widgetIcon,this.icon=null,this.key=this,this._loadLocale=p.debounce((async()=>{if(this._messageBundleProps?.length){const e=await Promise.allSettled(this._messageBundleProps.map((async({bundlePath:e,propertyName:t})=>{if(this.destroyed)return;let r=await j.fetchMessageBundle(e);this.uiStrings&&Object.keys(this.uiStrings)&&(r=F(a.clone(r),this.uiStrings)),this[t]=r})));if(this.destroyed)return;for(const t of e)"rejected"===t.status&&d.getLogger(this).error("widget-intl:locale-error",this.declaredClass,t.reason)}await this.loadLocale()})),f.commitAssetPath();const r="esri-widget-uid-"+u.generateUUID(),o=this.render.bind(this);this._trackingTarget=new m.SimpleTrackingTarget((()=>this.scheduleRender()));const s=()=>{if(!this._readyForTrueRender||this.destroyed)return null;const e=o();let{properties:t}=e;t||(e.properties=t={});const{key:s}=t;if(s||(t.key=r),w.isWidgetConstructor(e.vnodeSelector)){if(!this.visible)return{vnodeSelector:"div",properties:{key:`${r}-hidden`,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0}}else this.visible?t.styles||(t.styles={}):(t.class="",t.styles={display:"none"}),t.styles.display||(t.styles.display="");let i=0;return e.children?.forEach((e=>{if(w.isWidgetConstructor(e.vnodeSelector))return;let{properties:t}=e;t||(e.properties=t={}),t.key||(t.key=`${this.id}--${i++}`)})),w.processWidgets(this,e)};this.render=()=>{if(H)return s();let e=I.getVNodeCache(this)??null;if(e)return e;this._trackingTarget.clear(),H=!0;try{e=v.runTracked(this._trackingTarget,s)}catch(t){throw console.error(t),t}finally{H=!1}return e&&I.setVNodeCache(this,e),e};const i=this.beforeFirstRender();i?this._resourcesFetch=i.then((()=>{this._readyForTrueRender=!0,this._postInitialize()})):(this._resourcesFetch=Promise.resolve().then((()=>{this._postInitialize()})),this._readyForTrueRender=!0),this.addResolvingPromise(this._resourcesFetch),k.registerLoading(this._resourcesFetch)}normalizeCtorArgs(e,t){const r={...e};return t&&(r.container=t),r}postInitialize(){}beforeFirstRender(){const e=this.loadDependencies();return this._messageBundleProps?.length||e?Promise.all([e,this._loadLocale()]).then((()=>{})).catch(p.throwIfNotAbortError):null}loadDependencies(){return null}loadLocale(){return null}destroy(){this.destroyed||(c.destroyMaybe(this._trackingTarget),c.destroyMaybe(this.viewModel),this._detach(this.container),this._set("container",null),this._emitter.clear(),this.render=()=>null,this._projector=null,I.deleteVNodeCache(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return o.byId(e)}get domNode(){return this.container}set domNode(e){this.container=e}get id(){return this._get("id")||this.container?.id||Date.now().toString(16)+"-widget-"+E++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(P=S.widgetSymbol,S.widgetTestDataSymbol)](){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(I.deleteVNodeCache(this),this._projector.scheduleRender())}own(e){r.deprecatedFunction(d.getLogger(this.declaredClass),"`Widget.own()` is deprecated in favor of Widget.addHandles()'",{replacement:"Widget.addHandles()",version:"4.28"}),this.addHandles(e)}classes(...e){return N.classes.apply(this,e)}renderNow(){I.deleteVNodeCache(this),this._projector.renderNow()}_postInitialize(){if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this.addHandles(h.watch((()=>this.viewModel),((e,t)=>{t&&this.removeHandles("delegated-events"),e&&i.isEventTarget(e)&&this.addHandles(this._delegatedEventNames.map((t=>i.on(e,t,(e=>{this.emit(t,e)})))),"delegated-events")}),h.syncAndInitial)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(p.throwIfNotAbortError),this.scheduleRender()};this.addHandles([R.onLocaleChange(e),h.watch((()=>this.uiStrings),e),h.when((()=>this.container),(e=>{this.destroyed||this._attach(e)}),{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)}};A[P]=!0,e.__decorate([y.property()],A.prototype,"_readyForTrueRender",void 0),e.__decorate([y.property({value:null})],A.prototype,"container",null),e.__decorate([_.cast("container")],A.prototype,"castContainer",null),e.__decorate([y.property()],A.prototype,"iconClass",void 0),e.__decorate([y.property()],A.prototype,"icon",void 0),e.__decorate([y.property()],A.prototype,"id",null),e.__decorate([y.property()],A.prototype,"label",null),e.__decorate([y.property()],A.prototype,"renderable",null),e.__decorate([y.property()],A.prototype,"uiStrings",void 0),e.__decorate([y.property()],A.prototype,"viewModel",void 0),e.__decorate([y.property({value:!0})],A.prototype,"visible",null),e.__decorate([y.property()],A.prototype,"key",void 0),e.__decorate([y.property()],A.prototype,"children",void 0),e.__decorate([y.property()],A.prototype,"afterCreate",void 0),e.__decorate([y.property()],A.prototype,"afterUpdate",void 0),e.__decorate([y.property()],A.prototype,"afterRemoved",void 0),A=e.__decorate([g.subclass(T)],A);return A}));
