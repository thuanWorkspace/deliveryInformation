/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../core/deprecate","../core/Logger","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../support/actions/ActionButton","./Features","./Widget","./Popup/css","./Popup/PopupViewModel","./Popup/PopupVisibleElements","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory"],(function(e,t,o,i,n,s,r,l,a,c,d,p,h,u,g,_,w,v,b,f){"use strict";const m={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};let y=class extends p{constructor(e,t){super(e,t),this._dockAction=new c({id:"popup-dock-action"}),this._featuresWidget=new d({responsiveActionsEnabled:!0}),this._containerNode=null,this._mainContainerNode=null,this._pointerOffsetInPx=16,this.alignment="auto",this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.headingLevel=2,this.maxInlineActions=3,this.messages=null,this.spinnerEnabled=!0,this.viewModel=new u,this.visibleElements=new g}initialize(){this.addHandles([i.watch((()=>[this.viewModel?.view?.widthBreakpoint,this.dockEnabled]),(()=>this._handleDockIcon()),{initial:!0}),i.watch((()=>[this.dockEnabled,this.messages?.undock,this.messages?.dock]),(()=>this._handleDockEnabled()),{initial:!0}),i.watch((()=>this.dockOptions),(e=>{const{_dockAction:t}=this,o=this._featuresWidget.headerActions;o.remove(t),e.buttonEnabled&&o.add(t)}),{initial:!0}),i.watch((()=>this.viewModel?.screenLocation),(()=>this._positionContainer())),i.watch((()=>[this.viewModel?.active,this.dockEnabled]),(()=>this._toggleScreenLocationEnabled())),i.watch((()=>[this.viewModel?.screenLocation,this.viewModel?.view?.padding,this.viewModel?.view?.size,this.viewModel?.active,this.viewModel?.location,this.alignment]),(()=>this.reposition())),i.watch((()=>this.viewModel?.view?.size),((e,t)=>this._updateDockEnabledForViewSize(e,t))),i.watch((()=>this.viewModel?.view),((e,t)=>this._viewChange(e,t))),i.watch((()=>this.viewModel?.view?.ready),((e,t)=>this._viewReadyChange(e??!1,t??!1))),i.watch((()=>this.viewModel),(()=>this._featuresWidget.viewModel=this.viewModel),{initial:!0}),i.watch((()=>this._featureNavigationTop),(e=>this._featuresWidget.featureNavigationTop=e),{initial:!0}),i.watch((()=>this.headingLevel),(e=>this._featuresWidget.headingLevel=e),{initial:!0}),i.watch((()=>this.collapseEnabled),(e=>this._featuresWidget.visibleElements.collapseButton=e),{initial:!0}),i.watch((()=>this.collapsed),(e=>this._featuresWidget.collapsed=e),{initial:!0}),i.watch((()=>this.visibleElements.closeButton),(e=>this._featuresWidget.visibleElements.closeButton=!!e),{initial:!0}),i.watch((()=>this.spinnerEnabled),(e=>this._featuresWidget.visibleElements.spinner=e),{initial:!0}),i.watch((()=>this.visibleElements.featureNavigation),(e=>this._featuresWidget.visibleElements.featureNavigation=!!e),{initial:!0}),i.on((()=>this._featuresWidget),"trigger-header-action",(e=>{e.action===this._dockAction&&(this.dockEnabled=!this.dockEnabled)}))])}destroy(){this._dockAction.destroy(),this._featuresWidget?.destroy()}get _featureNavigationTop(){const{currentAlignment:e,currentDockPosition:t}=this;return"bottom-left"===e||"bottom-center"===e||"bottom-right"===e||"top-left"===t||"top-center"===t||"top-right"===t}get actions(){return this.viewModel.actions}set actions(e){this.viewModel.actions=e}get autoCloseEnabled(){return this.viewModel.autoCloseEnabled}set autoCloseEnabled(e){this.viewModel.autoCloseEnabled=e}get autoOpenEnabled(){return t.deprecatedProperty(o.getLogger(this),"autoOpenEnabled",{replacement:"MapView/SceneView.popupEnabled",version:"4.27"}),this.viewModel.autoOpenEnabled}set autoOpenEnabled(e){t.deprecatedProperty(o.getLogger(this),"autoOpenEnabled",{replacement:"MapView/SceneView.popupEnabled",version:"4.27"}),this.viewModel.autoOpenEnabled=e}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(e){this.viewModel.defaultPopupTemplateEnabled=e}get content(){return this.viewModel.content}set content(e){this.viewModel.content=e}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||m}set dockOptions(e){const t={...m},o=this.viewModel?.view?.breakpoints,i={};o&&(i.width=o.xsmall,i.height=o.xsmall);const n={...t,...e},s={...t.breakpoint,...i},{breakpoint:r}=n;"object"==typeof r?n.breakpoint={...s,...r}:r&&(n.breakpoint=s),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}get featureCount(){return this.viewModel.featureCount}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(e){this.viewModel.featureMenuOpen=e}get features(){return this.viewModel.features}set features(e){this.viewModel.features=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(e){this.viewModel.highlightEnabled=e}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get promises(){return this.viewModel.promises}set promises(e){this.viewModel.promises=e}get selectedFeature(){return this.viewModel.selectedFeature}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(e){this.viewModel.selectedFeatureIndex=e}get selectedFeatureWidget(){return this._featuresWidget.selectedFeatureWidget}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(e){this.viewModel.updateLocationEnabled=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}blur(){const{active:e}=this.viewModel;e||o.getLogger(this).warn("Popup can only be blurred when currently active."),this._featuresWidget.blur()}clear(){return this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,t){return this.viewModel.fetchFeatures(e,t)}focus(){const{active:e}=this.viewModel;e||o.getLogger(this).warn("Popup can only be focused when currently active."),this.renderNow(),this._featuresWidget.focus()}next(){return this.viewModel.next()}open(e){const t=!!e&&!!e.featureMenuOpen,o={collapsed:!!e&&!!e.collapsed,featureMenuOpen:t};this.set(o),this.viewModel.open(e),this._shouldFocus(e)}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){return this.viewModel.triggerAction(e)}render(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:o}=this,{active:i}=this.viewModel,n=i&&e,s=i&&!e,r=this.selectedFeature?.layer?.title,l=this.selectedFeature?.layer?.id,a={[h.css.alignTopCenter]:"top-center"===t,[h.css.alignBottomCenter]:"bottom-center"===t,[h.css.alignTopLeft]:"top-left"===t,[h.css.alignBottomLeft]:"bottom-left"===t,[h.css.alignTopRight]:"top-right"===t,[h.css.alignBottomRight]:"bottom-right"===t,[h.css.isDocked]:n,[h.css.shadow]:s,[h.css.isDockedTopLeft]:"top-left"===o,[h.css.isDockedTopCenter]:"top-center"===o,[h.css.isDockedTopRight]:"top-right"===o,[h.css.isDockedBottomLeft]:"bottom-left"===o,[h.css.isDockedBottomCenter]:"bottom-center"===o,[h.css.isDockedBottomRight]:"bottom-right"===o};return f.tsx("div",{afterCreate:this._positionContainer,afterUpdate:this._positionContainer,bind:this,class:this.classes(h.css.base,a),"data-layer-id":l,"data-layer-title":r,role:"presentation"},i?[this._renderMainContainer(),this._renderPointer()]:null)}_renderPointer(){return this.dockEnabled?null:f.tsx("div",{class:h.css.pointer,key:"popup-pointer",role:"presentation"},f.tsx("div",{class:this.classes(h.css.pointerDirection,h.css.shadow)}))}_renderMainContainer(){const{dockEnabled:e}=this,t={[h.css.shadow]:e};return f.tsx("div",{afterCreate:this._setMainContainerNode,afterUpdate:this._setMainContainerNode,bind:this,class:this.classes(h.css.main,_.globalCss.widget,t)},this._featuresWidget.render())}async _shouldFocus(e){e?.shouldFocus&&(await i.whenOnce((()=>!0===this.viewModel?.active)),this.focus())}_isOutsideView(e){const{popupHeight:t,popupWidth:o,screenLocation:i,side:n,view:s}=e;if(isNaN(o)||isNaN(t)||!s||!i)return!1;const r=s.padding;return"right"===n&&i.x+o/2>s.width-r.right||("left"===n&&i.x-o/2<r.left||("top"===n&&i.y-t<r.top||"bottom"===n&&i.y+t>s.height-r.bottom))}_calculateAutoAlignment(e){if("auto"!==e)return e;const{_pointerOffsetInPx:t,_containerNode:o,_mainContainerNode:i,viewModel:n}=this,{screenLocation:s,view:r}=n;if(null==s||!r||!o)return"top-center";function l(e){return parseInt(e.replaceAll(/[^-\d\.]/g,""),10)}const a=i?window.getComputedStyle(i,null):null,c=a?l(a.getPropertyValue("max-height")):0,d=a?l(a.getPropertyValue("height")):0,{height:p,width:h}=o.getBoundingClientRect(),u=h+t,g=Math.max(p,c,d)+t,_=this._isOutsideView({popupHeight:g,popupWidth:u,screenLocation:s,side:"right",view:r}),w=this._isOutsideView({popupHeight:g,popupWidth:u,screenLocation:s,side:"left",view:r}),v=this._isOutsideView({popupHeight:g,popupWidth:u,screenLocation:s,side:"top",view:r}),b=this._isOutsideView({popupHeight:g,popupWidth:u,screenLocation:s,side:"bottom",view:r});return w?v?"bottom-right":"top-right":_?v?"bottom-left":"top-left":v?b?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return"function"==typeof e?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const t=["left","right"];return w.isRTL(this.container)&&t.reverse(),e?.replace(/leading/gi,t[0]).replaceAll(/trailing/gi,t[1])}_callDockPosition(e){return"function"==typeof e?e.call(this):e}_getDockPosition(){return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(this.dockOptions?.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_calculateAutoDockPosition(e){if("auto"!==e)return e;const t=this.viewModel?.view,o=w.isRTL(this.container)?"top-left":"top-right";if(!t)return o;const i=t.padding||{left:0,right:0,top:0,bottom:0},n=t.width-i.left-i.right,{breakpoints:s}=t;return s&&n<=s.xsmall?"bottom-center":o}_getDockIcon(){const e=this._getDockPosition();if(this.dockEnabled)return"minimize";switch(e){case"top-left":case"bottom-left":return"dock-left";case"top-center":return"maximize";case"bottom-center":return"dock-bottom";default:return"dock-right"}}_handleDockIcon(){this._dockAction.icon=this._getDockIcon()}_handleDockEnabled(){this._dockAction.title=this.dockEnabled?this.messages?.undock:this.messages?.dock}_setMainContainerNode(e){this._mainContainerNode=e}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!this._containerNode)return;const{screenLocation:t}=this.viewModel,{width:o}=this._containerNode.getBoundingClientRect(),i=this._calculatePositionStyle(t,o);i&&Object.assign(this._containerNode.style,i)}_calculateFullWidth(e){const{currentAlignment:t,_pointerOffsetInPx:o}=this;return"top-left"===t||"bottom-left"===t||"top-right"===t||"bottom-right"===t?e+o:e}_calculateAlignmentPosition(e,t,o,i){const{currentAlignment:n,_pointerOffsetInPx:s}=this;if(!o)return;const{padding:r}=o,l=i/2,a=o.height-t,c=o.width-e;return"bottom-center"===n?{top:t+s-r.top,left:e-l-r.left}:"top-left"===n?{bottom:a+s-r.bottom,right:c+s-r.right}:"bottom-left"===n?{top:t+s-r.top,right:c+s-r.right}:"top-right"===n?{bottom:a+s-r.bottom,left:e+s-r.left}:"bottom-right"===n?{top:t+s-r.top,left:e+s-r.left}:"top-center"===n?{bottom:a+s-r.bottom,left:e-l-r.left}:void 0}_calculatePositionStyle(e,t){const{dockEnabled:o,view:i}=this;if(!i)return;if(o)return{left:"",top:"",right:"",bottom:""};if(null==e||!t)return;const n=this._calculateFullWidth(t),s=this._calculateAlignmentPosition(e.x,e.y,i,n);return s?{top:void 0!==s.top?`${s.top}px`:"auto",left:void 0!==s.left?`${s.left}px`:"auto",bottom:void 0!==s.bottom?`${s.bottom}px`:"auto",right:void 0!==s.right?`${s.right}px`:"auto"}:void 0}_viewChange(e,t){e&&t&&(this.close(),this.clear())}_viewReadyChange(e,t){e?this._wireUpView():t&&(this.close(),this.clear())}_wireUpView(){this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,t,o){const[i,n]=e,[s,r]=t,{width:l=0,height:a=0}=o??{};return i<=l&&s>l||i>l&&s<=l||n<=a&&r>a||n>a&&r<=a}_updateDockEnabledForViewSize(e,t){if(!e||!t)return;const o=this.viewModel?.view?.padding||{left:0,right:0,top:0,bottom:0},i=o.left+o.right,n=o.top+o.bottom,s=[],r=[];s[0]=e[0]-i,s[1]=e[1]-n,r[0]=t[0]-i,r[1]=t[1]-n;const{dockOptions:l}=this,a=l.breakpoint;this._dockingThresholdCrossed(s,r,a)&&this._setDockEnabledForViewSize(l),this._setCurrentDockPosition()}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:t}=this;if(!t)return;const o=t.active&&!e;t.screenLocationEnabled=o}_shouldDockAtCurrentViewSize(e){const t=e.breakpoint,o=this.viewModel?.view?.ui;if(!o)return!1;const{width:i,height:n}=o;if(isNaN(i)||isNaN(n))return!1;if(!t)return!1;const s=t.hasOwnProperty("width")&&i<=(t.width??0),r=t.hasOwnProperty("height")&&n<=(t.height??0);return s||r}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}};e.__decorate([n.property({readOnly:!0})],y.prototype,"_featureNavigationTop",null),e.__decorate([n.property()],y.prototype,"actions",null),e.__decorate([n.property()],y.prototype,"alignment",void 0),e.__decorate([n.property()],y.prototype,"autoCloseEnabled",null),e.__decorate([n.property()],y.prototype,"autoOpenEnabled",null),e.__decorate([n.property()],y.prototype,"defaultPopupTemplateEnabled",null),e.__decorate([n.property()],y.prototype,"content",null),e.__decorate([n.property()],y.prototype,"collapsed",void 0),e.__decorate([n.property()],y.prototype,"collapseEnabled",void 0),e.__decorate([n.property({readOnly:!0})],y.prototype,"currentAlignment",null),e.__decorate([n.property({readOnly:!0})],y.prototype,"currentDockPosition",null),e.__decorate([n.property()],y.prototype,"dockOptions",null),e.__decorate([n.property()],y.prototype,"dockEnabled",void 0),e.__decorate([n.property({readOnly:!0})],y.prototype,"featureCount",null),e.__decorate([n.property()],y.prototype,"featureMenuOpen",null),e.__decorate([n.property()],y.prototype,"features",null),e.__decorate([n.property()],y.prototype,"goToOverride",null),e.__decorate([n.property()],y.prototype,"headingLevel",void 0),e.__decorate([n.property()],y.prototype,"highlightEnabled",null),e.__decorate([n.property()],y.prototype,"location",null),e.__decorate([n.property()],y.prototype,"label",null),e.__decorate([n.property()],y.prototype,"maxInlineActions",void 0),e.__decorate([n.property(),v.messageBundle("esri/widgets/Popup/t9n/Popup")],y.prototype,"messages",void 0),e.__decorate([n.property()],y.prototype,"promises",null),e.__decorate([n.property({readOnly:!0})],y.prototype,"selectedFeature",null),e.__decorate([n.property()],y.prototype,"selectedFeatureIndex",null),e.__decorate([n.property({readOnly:!0})],y.prototype,"selectedFeatureWidget",null),e.__decorate([n.property()],y.prototype,"spinnerEnabled",void 0),e.__decorate([n.property()],y.prototype,"title",null),e.__decorate([n.property()],y.prototype,"updateLocationEnabled",null),e.__decorate([n.property()],y.prototype,"view",null),e.__decorate([n.property({type:u}),b.vmEvent(["triggerAction","trigger-action"])],y.prototype,"viewModel",void 0),e.__decorate([n.property()],y.prototype,"visible",null),e.__decorate([n.property({type:g,nonNullable:!0})],y.prototype,"visibleElements",void 0),y=e.__decorate([a.subclass("esri.widgets.Popup")],y);return y}));
