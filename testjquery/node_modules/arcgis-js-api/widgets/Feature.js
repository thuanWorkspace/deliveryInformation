/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../intl","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./Feature/FeatureAttachments","./Feature/FeatureContent","./Feature/FeatureExpression","./Feature/FeatureFields","./Feature/FeatureMedia","./Feature/FeatureRelationship","./Feature/FeatureViewModel","./Feature/resources","./Feature/support/FeatureContentMixin","./support/componentsUtils","./support/globalCss","./support/Heading","./support/legacyIcon","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/substitute"],(function(e,t,s,n,i,r,o,l,d,a,c,p,u,h,_,y,m,v,g,w,M,b,E,f,x,C,F){"use strict";var W;const k={title:!0,content:!0,lastEditedInfo:!0},I="relationship-handles";let T=W=class extends(g.FeatureContentMixin(a)){constructor(e,t){super(e,t),this._contentWidgets=[],this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.visibleElements={...k},this.viewModel=new m}initialize(){this.addHandles(n.watch((()=>this.viewModel?.contentViewModels),(()=>this._setupContentWidgets()),n.initial))}loadDependencies(){return w.loadCalciteComponents({notice:()=>new Promise(((t,s)=>e(["../chunks/calcite-notice"],t,s)))})}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(e){this.viewModel.defaultPopupTemplateEnabled=e}get isTable(){return this.viewModel.isTable}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get title(){return this.viewModel.title}castVisibleElements(e){return{...k,...e}}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}setActiveMedia(e,t){return this.viewModel.setActiveMedia(e,t)}nextMedia(e){return this.viewModel.nextMedia(e)}previousMedia(e){return this.viewModel.previousMedia(e)}render(){const{state:e}=this.viewModel,t=C.tsx("div",{class:v.css.container,key:"container"},this._renderTitle(),"error"===e?this._renderError():"loading"===e?this._renderLoading():this._renderContentContainer());return C.tsx("div",{class:this.classes(v.css.base,M.globalCss.widget)},t)}_renderError(){const{messagesCommon:e,messages:t,visibleElements:s}=this;return C.tsx("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,scale:"s"},s.title?C.tsx("div",{key:"error-title",slot:"title"},e.errorMessage):null,C.tsx("div",{key:"error-message",slot:"message"},t.loadingError))}_renderLoading(){return C.tsx("div",{class:v.css.loadingSpinnerContainer,key:"loading-container"},C.tsx("span",{class:this.classes(E.legacyIcon.loadingIndicator,M.globalCss.rotating,v.css.spinner)}))}_renderContentContainer(){const{visibleElements:e}=this;return e.content?C.tsx("div",{class:v.css.main},[this._renderContent(),this._renderLastEditInfo()]):null}_renderTitle(){const{visibleElements:e,title:t}=this;return e.title?C.tsx(b.Heading,{class:v.css.title,innerHTML:t,level:this.headingLevel}):null}_renderContent(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?C.tsx("div",{class:v.css.contentNode,key:`${t}-content-elements`},e.map(this._renderContentElement,this)):null;if("string"==typeof e){const e=this._contentWidgets[0];return!e||e.destroyed?null:C.tsx("div",{class:this.classes(v.css.contentNode,v.css.contentNodeText),key:`${t}-content`},e.render())}return this.renderNodeContent(e)}_renderContentElement(e,t){const{visibleElements:s}=this;if("boolean"!=typeof s.content&&!s.content?.[e.type])return null;switch(e.type){case"attachments":return this._renderAttachments(t);case"custom":return this._renderCustom(e,t);case"fields":return this._renderFields(t);case"media":return this._renderMedia(t);case"text":return this._renderText(e,t);case"expression":return this._renderExpression(t);case"relationship":return this._renderRelationship(t);default:return null}}_renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:s,attachmentInfos:n}=t.viewModel;return"loading"===s||n.length>0?C.tsx("div",{class:this.classes(v.css.contentElement),key:this._buildKey("attachments-element",e)},t.render()):null}_renderRelationship(e){const t=this._contentWidgets[e];return t&&!t.destroyed&&this.flowItems?C.tsx("div",{class:v.css.contentElement,key:this._buildKey("relationship-element",e)},t.render()):null}_renderExpression(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:C.tsx("div",{class:v.css.contentElement,key:this._buildKey("expression-element",e)},t.render())}_renderCustom(e,t){const{creator:s}=e,n=this._contentWidgets[t];return!n||n.destroyed?null:s?C.tsx("div",{class:v.css.contentElement,key:this._buildKey("custom-element",t)},n.render()):null}_renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:C.tsx("div",{class:v.css.contentElement,key:this._buildKey("fields-element",e)},t.render())}_renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:C.tsx("div",{class:v.css.contentElement,key:this._buildKey("media-element",e)},t.render())}_renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:s}=this.viewModel;if(!s||!e.lastEditedInfo)return null;const{date:n,user:i}=s,r="edit"===s.type?i?t.lastEditedByUser:t.lastEdited:i?t.lastCreatedByUser:t.lastCreated,o=F.substitute(r,{date:n,user:i});return C.tsx("div",{class:this.classes(v.css.lastEditedInfo,v.css.contentElement),key:"edit-info-element"},o)}_renderText(e,t){const s=e.text,n=this._contentWidgets[t];return!n||n.destroyed?null:s?C.tsx("div",{class:this.classes(v.css.contentElement,v.css.text),key:this._buildKey("text-element",t)},n.render()):null}_buildKey(e,...t){return`${e}__${this.viewModel?.graphic?.uid||"0"}-${t.join("-")}`}_destroyContentWidget(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())}_destroyContentWidgets(){this.removeHandles(I),this._contentWidgets.forEach((e=>this._destroyContentWidget(e))),this._contentWidgets=[]}_addFeatureRelationshipHandles(e){const{flowItems:t,visibleElements:s}=this;this.addHandles([n.on((()=>e),"select-record",(({featureViewModel:e})=>{t&&(e.abilities={relationshipContent:!0},t.push(new W({flowItems:t,viewModel:e,visibleElements:s})))})),n.on((()=>e),"show-all-records",(()=>{if(!t)return;const{viewModel:s}=e;s.showAllEnabled=!0;const n=new y({visibleElements:{title:!1,description:!1},viewModel:s});this._addFeatureRelationshipHandles(n),t.push(n)}))],I)}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t}=this,s=this.viewModel?.content,{contentViewModels:n}=this.viewModel;if(Array.isArray(s))s.forEach(((s,i)=>{if("attachments"===s.type&&(this._contentWidgets[i]=new c({displayType:s.displayType,headingLevel:t.title?e+1:e,viewModel:n[i]})),"fields"===s.type&&(this._contentWidgets[i]=new h({viewModel:n[i]})),"media"===s.type&&(this._contentWidgets[i]=new _({viewModel:n[i]})),"text"===s.type&&(this._contentWidgets[i]=new p({viewModel:n[i]})),"custom"===s.type&&(this._contentWidgets[i]=new p({viewModel:n[i]})),"expression"===s.type&&(this._contentWidgets[i]=new u({viewModel:n[i]})),"relationship"===s.type){const e=new y({viewModel:n[i]});this._addFeatureRelationshipHandles(e),this._contentWidgets[i]=e}}),this);else{const e=n[0];e&&!e.destroyed&&(this._contentWidgets[0]=new p({viewModel:e}))}this.scheduleRender()}};t.__decorate([i.property()],T.prototype,"graphic",null),t.__decorate([i.property()],T.prototype,"defaultPopupTemplateEnabled",null),t.__decorate([i.property()],T.prototype,"flowItems",void 0),t.__decorate([i.property()],T.prototype,"headingLevel",void 0),t.__decorate([i.property({readOnly:!0})],T.prototype,"isTable",null),t.__decorate([i.property()],T.prototype,"label",null),t.__decorate([i.property(),x.messageBundle("esri/widgets/Feature/t9n/Feature")],T.prototype,"messages",void 0),t.__decorate([i.property(),x.messageBundle("esri/t9n/common")],T.prototype,"messagesCommon",void 0),t.__decorate([i.property(),x.messageBundle("esri/widgets/support/t9n/uriUtils")],T.prototype,"messagesURIUtils",void 0),t.__decorate([i.property()],T.prototype,"spatialReference",null),t.__decorate([i.property({readOnly:!0})],T.prototype,"title",null),t.__decorate([i.property()],T.prototype,"visibleElements",void 0),t.__decorate([r.cast("visibleElements")],T.prototype,"castVisibleElements",null),t.__decorate([i.property()],T.prototype,"map",null),t.__decorate([i.property()],T.prototype,"view",null),t.__decorate([i.property({type:m})],T.prototype,"viewModel",void 0),T=W=t.__decorate([d.subclass("esri.widgets.Feature")],T);return T}));
