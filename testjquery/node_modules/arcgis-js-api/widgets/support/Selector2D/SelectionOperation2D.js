/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../symbols","../../../core/Collection","../../../core/Evented","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/GraphicsLayer","../../Sketch/SketchViewModel","./selectorUtils","../../../symbols/SimpleFillSymbol","../../../symbols/SimpleLineSymbol","../../../symbols/SimpleMarkerSymbol"],(function(e,t,o,s,r,i,c,l,n,a,p,h,d,y,_,m){"use strict";const u=100;let b=class extends s.EventedAccessor{constructor({options:e,view:t}){super(),this._abortController=null,this._activeOptions=null,this._completed=!1,this._dashedFillSymbol=new y({color:[0,0,0,0],outline:{style:"dash",color:[12,207,255],width:2}}),this._dashedLineSymbol=new _({style:"dash",color:[12,207,255],width:2}),this._defaultOptions={createTool:"rectangle",selectionOptions:{overlaps:!0,intersects:!0,contains:!1}},this._processSelectionGeometry=async({canceled:e,completed:t,selector:o})=>{const{_activeOptions:s,sources:r,selection:i,view:c}=this;if(this._abortController&&this._abortController.abort(),(t||e)&&(this._completed=!0),e)return void this._onComplete([],!0);if(!o||!r?.length||!c)return void i.removeAll();const l=new AbortController;this._abortController=l;const{added:n,removed:a}=await d.getSelectionFromGeometry({currentSelection:i,sources:r,options:s.selectionOptions,selector:o,signal:l.signal,view:c});this._abortController===l&&(this._abortController=null),l.signal.aborted||(t?this._onComplete(this.selection.toArray(),!1):(n.length||a.length)&&this.emit("selection-change",{added:n,removed:a,type:"selection-change"}))},this._processDebounced=r.debounce(this._processSelectionGeometry,u),this._sketchViewModel=new h,this._sketchGraphicsLayer=new p({listMode:"hide",internal:!0}),this._transparentPointSymbol=new m({color:[0,0,0,0],outline:{style:"none",width:0}}),this.options=null,this.selection=new o,this.sources=null,this.options=e,this.view=t;const{_dashedFillSymbol:s,_dashedLineSymbol:i,_sketchViewModel:c,_sketchGraphicsLayer:l,_transparentPointSymbol:n}=this;c.set({layer:l,activePointSymbol:n,activeLineSymbol:i,activeVertexSymbol:n,activeFillSymbol:s,pointSymbol:n,polygonSymbol:s,polylineSymbol:i,vertexSymbol:n,view:t}),this.addHandles([c.on("create",(e=>this._onSketchEvent(e))),c.on(["undo","redo"],(e=>this._onSketchEvent(e))),c.watch("activeComponent.forceUniformSize",(()=>this._onSketchGeometryChange()))])}initialize(){this._load()}set cursor(e){const t=this._sketchViewModel?.activeComponent;"draw-2d"!==t?.type&&"draw-3d"!==t?.type||(t.cursor=e),this._set("cursor",e)}get state(){const{_completed:e,_sketchViewModel:{state:t}}=this;return e?"complete":"active"===t?"active":"disabled"}set view(e){this._sketchViewModel.view=e,this._set("view",e)}cancel(){return this._sketchViewModel.cancel()}async _load(){await(this.view?.whenReady());const{_defaultOptions:e,options:t}=this,o=t?.createOptions?.cursor||this.cursor||e.createOptions?.cursor,{createTool:s,createOptions:r}=this._activeOptions={...e,...t,createOptions:{...e.createOptions,cursor:o,...t?.createOptions},selectionOptions:{...e.selectionOptions,...t?.selectionOptions}};this._sketchViewModel.create(s,r)}_onSketchEvent(e){const t="create"===e.type?e.graphic:e.graphics[0],o=t?.geometry,s="create"===e.type&&"cancel"===e.state,i="create"===e.type&&"complete"===e.state;r.ignoreAbortErrors(this._processDebounced({canceled:s,completed:i,selector:o}))}_onSketchGeometryChange(){const e=this._sketchViewModel.createGraphic,t=e?.geometry;t&&r.ignoreAbortErrors(this._processDebounced({canceled:!1,completed:!1,selector:t}))}_onComplete(e,t){this.removeAllHandles(),this.notifyChange("state"),this.emit("complete",{aborted:t,selection:e,type:"complete"})}};e.__decorate([i.property()],b.prototype,"_abortController",void 0),e.__decorate([i.property()],b.prototype,"_completed",void 0),e.__decorate([i.property()],b.prototype,"cursor",null),e.__decorate([i.property()],b.prototype,"options",void 0),e.__decorate([i.property({readOnly:!0})],b.prototype,"selection",void 0),e.__decorate([i.property()],b.prototype,"sources",void 0),e.__decorate([i.property({readOnly:!0})],b.prototype,"state",null),e.__decorate([i.property()],b.prototype,"view",null),b=e.__decorate([a.subclass("esri.widgets.support.Selector2D.SelectionOperation2D")],b);return b}));
