/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../renderers/support/clickToleranceUtils","../../../views/support/drapedUtils","../../../views/support/layerViewUtils"],(function(e,r,t,s,n,a,i,o){"use strict";async function l(){return new Promise(((r,t)=>e(["../../../geometry/geometryEngineJSON"],r,t)))}async function c(){return l().then((({contains:e,intersects:r,overlaps:t,simplify:s})=>({contains:e,intersects:r,overlaps:t,simplify:s})))}async function u(e){const{currentSelection:r,options:s,selector:n,signal:a,sources:i,view:o}=e;if(!i?.length)return{added:[],removed:[]};const{layers:l,layerViews:c,graphicsLayers:u}=f(i),m=(await t.whenOrAbort(Promise.all([d(n,l,o,a),p(n,c,o,a),y(n,u,s,o)]),a)).flat();if(!r)return{added:m,removed:[]};const w=m.filter((e=>g(r.toArray(),e))),h=r.filter((e=>g(m,e))).toArray();return r.removeMany(h),r.addMany(w),{added:w,removed:h}}const y=async(e,r,t,s)=>F({candidates:r.flatMap((e=>e.graphics.toArray()))??[],selector:e,options:t,view:s}),d=async(e,r,s,n)=>{const a=await t.ignoreAbortErrors(w({selector:e,signal:n,layers:r,view:s}));return a?a.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)):[]},p=async(e,r,s,n)=>{const a=await t.ignoreAbortErrors(m({selector:e,signal:n,layerViews:r,view:s}));return a?a.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)):[]};function f(e){const r=[],t=[],s=[];return e.forEach((e=>{n.isFeatureLayer(e)?r.push(e):n.isKnowledgeGraphLayer(e)&&e.layers?.length?r.push(...e.layers.toArray()):n.isMapNotesLayer(e)&&e.sublayers?.length?s.push(...e.sublayers.toArray()):n.isGraphicsLayer(e)?s.push(e):o.isSelectableLayerView2D(e)&&t.push(e)})),{layers:r,layerViews:t,graphicsLayers:s}}function g(e,r){const t=e.includes(r),s=r.getObjectId(),n=null!=s,a=e.some((e=>{const t=r.layer===e.layer,a=n&&e.getObjectId()===s,i=r.uid===e.uid;return t&&(a||i)}));return!t&&!a}async function m(e){const{layerViews:r,selector:s,signal:n,view:a}=e;return t.whenOrAbort(Promise.allSettled(r.map((async e=>{const r=e.createQuery(),{outFields:t,geometry:i}=h(s,e.layer,a);return r.outFields=t,r.geometry=i,r.returnGeometry=!0,r.outSpatialReference=a.spatialReference,e.queryFeatures(r,{signal:n}).then((({features:e})=>e))}))),n)}async function w(e){const{layers:r,selector:s,signal:n,view:a}=e;return t.whenOrAbort(Promise.allSettled(r.map((async e=>e.queryFeatures(v(e.createQuery(),s,e,a),{signal:n}).then((({features:e})=>e))))),n)}function h(e,r,t){const n="displayField"in r?r.displayField:null,o=s.getDisplayFieldName({displayField:n,fields:r.fields}),l=[r.objectIdField];null!=o&&r.fieldsIndex.has(o)&&l.push(o);const c="renderer"in r?a.calculateTolerance({renderer:r.renderer}):0;return{geometry:"point"===e.type?i.createQueryGeometry(e,c,t):e,outFields:l}}function v(e,r,t,s){const{outFields:n,geometry:a}=h(r,t,s);return e.outFields=n,e.geometry=a,e.returnGeometry=!0,e.outSpatialReference=s.spatialReference,e}async function F(e){const{selector:r,candidates:t,options:s,view:n}=e;if(!t?.length||!r||!s)return[];const{overlaps:a,intersects:i,contains:o}=s,{spatialReference:l}=n,u=r,y=await c();return t.filter((e=>{const r=e.geometry,t=a&&y.overlaps(l,u,r),s=i&&y.intersects(l,u,r),n=o&&y.contains(l,u,r);return t||s||n}))}r.getGeometryEngineOperations=c,r.getQueryOptionsFromLayer=h,r.getSelectionFromFeatureLayerViews=m,r.getSelectionFromFeatureLayers=w,r.getSelectionFromGeometry=u,r.getSelectionFromGeometryEngine=F,r.importGeometryEngine=l,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
