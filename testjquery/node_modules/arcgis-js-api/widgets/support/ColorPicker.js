/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/tslib.es6","../../Color","../../core/asyncUtils","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../Widget","./componentsUtils","./Popover","./widgetUtils","./decorators/messageBundle","./jsxFactory"],(function(e,o,t,r,s,i,n,a,c,l,p,u,d,_,h,v,C,P,m,y){"use strict";const k="esri-color-picker",b={base:k,backgroundPattern:`${k}__bg-pattern`,toggleButton:`${k}__toggle-button`,popover:`${k}__popover`,opacitySliderContainer:`${k}__opacity-slider-container`,opacitySlider:`${k}__opacity-slider`,calciteColorPicker:`${k}__calcite-color-picker`};var g;function f(e,o){const t=setTimeout(e,o);return i.makeHandle((()=>clearTimeout(t)))}!function(e){e.ColorPickerFocus="hex-input-poll-timeout",e.ButtonFocusTimeout="button-focus-timeout"}(g||(g={})),o.ColorPicker=class extends h{constructor(e,o){super(e,o),this.value=new r,this.alphaEnabled=!0,this._containerElement=null,this._popover=null,this._popoverElement=null,this._buttonElement=null,this._colorPickerCreated=!1}initialize(){this.addHandles(c.watch((()=>({container:this._containerElement,value:this.value})),(({container:e,value:o})=>{e?.style.setProperty("--esri-color-picker-value",o.toCss(!0))}),c.syncAndInitial))}loadDependencies(){return v.loadCalciteComponents({button:()=>new Promise(((o,t)=>e(["../../chunks/calcite-button"],o,t))),"color-picker":()=>new Promise(((o,t)=>e(["../../chunks/calcite-color-picker"],o,t))),label:()=>new Promise(((o,t)=>e(["../../chunks/calcite-label"],o,t))),slider:()=>new Promise(((o,t)=>e(["../../chunks/calcite-slider"],o,t)))})}destroy(){this._destroyPopover(),this._buttonElement=null}render(){const e=this._messages,o=null!=this._popover&&this._popover.open?e.close:e.open;return y.tsx("div",{afterCreate:this._onContainerAfterCreate,bind:this,class:this.classes(b.base,this.class)},y.tsx("div",{class:b.backgroundPattern}),y.tsx("calcite-button",{afterCreate:this._onButtonAfterCreate,appearance:"transparent",bind:this,class:b.toggleButton,id:this.id,kind:"neutral",label:o,onclick:this._togglePopover,scale:"s",tabIndex:-1,title:o}))}_onContainerAfterCreate(e){this._containerElement=e}_onButtonAfterCreate(e){this._destroyPopover(),this._buttonElement=e,this._popover=new C({owner:this,anchorElement:e,placement:"bottom-start",renderContentFunction:this._renderPopoverContent})}_destroyPopover(){this.removeHandles(g.ColorPickerFocus),this._popover=n.destroyMaybe(this._popover),this._popoverElement=null}_renderPopoverContent(){const e=this.value,o=this._messages;return y.tsx("div",{afterCreate:this._onPopoverAfterCreate,bind:this,class:b.popover,onfocusout:this._onPopoverFocusOut,onkeydown:this._onPopoverKeyDown,tabIndex:-1},y.tsx("calcite-color-picker",{afterCreate:this._onColorPickerAfterCreate,afterRemoved:()=>this._colorPickerCreated=!1,bind:this,class:b.calciteColorPicker,hideChannels:!0,hideSaved:!0,scale:"m",value:this._colorPickerCreated?e.toCss():null,onCalciteColorPickerInput:this._onColorInput}),this.alphaEnabled?y.tsx("section",{class:b.opacitySliderContainer},y.tsx("calcite-label",{scale:"s"},o.opacity,y.tsx("calcite-slider",{bind:this,class:b.opacitySlider,labelHandles:!0,max:1,min:0,step:.01,value:e.a,onCalciteSliderInput:this._onOpacityChange}))):null)}_onColorInput(e){const o=e.target.value,t="string"==typeof o?new r(o):new r;t.a=this.value.a,this._onChange(t)}_onOpacityChange(e){const o=this.value.clone();o.a=e.target.value,this._onChange(o)}_onChange(e){this.value=e,null!=this.onChange&&this.onChange(e)}_onColorPickerAfterCreate(e){this.removeHandles(g.ColorPickerFocus);const o=s.createTask((async o=>{e.componentOnReady&&await e.componentOnReady(),a.throwIfAborted(o),this._colorPickerCreated=!0,await new Promise((e=>requestAnimationFrame(e))),a.throwIfAborted(o),e.setFocus()}));this.addHandles(i.makeHandle((()=>{o.abort(),this._colorPickerCreated=!1})),g.ColorPickerFocus)}_togglePopover(e){null!=this._popover&&this._popover.open?this._closePopover():this._openPopover()}_openPopover(){const e=this._popover;e&&(e.open=!0)}_closePopover(){this.removeHandles(g.ColorPickerFocus);const e=this._popover;e&&(e.open=!1),this._setFocusOnButton()}_setFocusOnButton(){this.removeHandles(g.ButtonFocusTimeout),this.addHandles(f((()=>this._buttonElement?.setFocus())),g.ButtonFocusTimeout)}_onPopoverAfterCreate(e){this._popoverElement=e}_onPopoverFocusOut(e){const o=this._popoverElement;if(null==o)return;const t=e.relatedTarget;if(t&&t instanceof Node){if(o.contains(t))return;if(t===this._buttonElement||this._isAssociatedLabel(t))return}this._closePopover()}_isAssociatedLabel(e){const o=this.id,t=e.tagName?.toLowerCase();return"calcite-label"===t&&e.for===o||"label"===t&&e.htmlFor===o}_onPopoverKeyDown(e){"Escape"!==e.key&&"Enter"!==e.key||(e.stopPropagation(),this._closePopover())}},t.__decorate([l.property()],o.ColorPicker.prototype,"class",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"value",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"alphaEnabled",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"onChange",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"_containerElement",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"_popover",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"_popoverElement",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"_buttonElement",void 0),t.__decorate([l.property(),m.messageBundle("esri/widgets/support/t9n/ColorPicker")],o.ColorPicker.prototype,"_messages",void 0),t.__decorate([l.property()],o.ColorPicker.prototype,"_colorPickerCreated",void 0),o.ColorPicker=t.__decorate([_.subclass("esri.widgets.support.ColorPicker")],o.ColorPicker),Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
