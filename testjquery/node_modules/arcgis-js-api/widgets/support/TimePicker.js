/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../intl","../../core/events","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../Widget","./globalCss","./TimePickerViewModel","./widgetUtils","./decorators/messageBundle","./jsxFactory","../../chunks/datetime","../../intl/locale","../../intl/date"],(function(e,t,i,s,a,r,n,o,l,u,h,c,m,d,p,_,v){"use strict";const f="esri-time-picker",T={base:f,timePicker:`${f}__date-picker`,timePickerInput:`${f}__input`},P="t",g=new Set(["ArrowDown","ArrowLeft","ArrowRight","ArrowUp","Tab"]);function w(e,t){return null!=e&&v.formatDate(e.valueOf(),t).includes(" ")}let y=class extends l{constructor(e,t){super(e,t),this._activePart=null,this._activeTime=null,this.messages=null,this.timeZone=null,this.timeZoneName=null,this.viewModel=new h}get _dateTimeFormatOptions(){return{hour:"numeric",minute:"numeric",timeZone:this.timeZone??void 0,timeZoneName:this.timeZoneName??void 0}}get _dateTimeOptions(){return{locale:_.getLocale(),numberingSystem:"latn",zone:this.timeZone||void 0}}get value(){return this.viewModel.value}set value(e){this.viewModel.value=e}render(){const e=this._activeTime||this.viewModel.value;return d.tsx("div",{class:this.classes(T.base,u.globalCss.widget)},d.tsx("input",{afterUpdate:this._handleInputUpdate,"aria-label":this.messages.inputTitle,bind:this,class:this.classes(T.timePickerInput,u.globalCss.input),onblur:this._handleInputBlur,onclick:this._handleInputClick,onfocus:this._handleInputFocus,oninput:this._handleInputKeydown,onkeydown:this._handleInputKeydown,onpaste:this._handleInputPaste,onwheel:this._handleInputWheel,value:v.formatDate(e.valueOf(),this._dateTimeFormatOptions)}))}_handleInputBlur(){this._activeTime?.isValid&&(this.viewModel.value=this._activeTime.toJSDate()),this._activeTime=null,this._activePart=null}_handleInputUpdate(e){this._selectPart(e,this._activePart)}_selectPart(e,t){const i=this._activeTime;if(!i||!e)return;const s=v.formatDate(i.valueOf(),this._dateTimeFormatOptions),a=0,r=s.indexOf(":");if("hours"===t)return void e.setSelectionRange(a,r);const n=r+1,o=n+2;if("minutes"===t)return void e.setSelectionRange(n,o);const l=o+1,u=s.length;"meridiem"!==t||e.setSelectionRange(l,u)}_handleInputFocus(e){this._activePart="hours",this._activeTime=p.DateTime.fromJSDate(this.viewModel.value,{zone:this.timeZone||void 0}).startOf("minute"),this._selectPart(e.target,"hours")}_caretIndexToPartName(e){const t=this._activeTime?.toFormat(P,{locale:_.getLocale(),numberingSystem:"latn"});if(!t)return null;const i=t.indexOf(":"),s=t.indexOf(" ");return e<=i?"hours":e>i&&e<=s?"minutes":"meridiem"}_handleInputKeydown(e){const{ctrlKey:t,metaKey:s,shiftKey:a}=e,r=i.eventKey(e),n=this._activeTime,o=this._activePart,l=/\d/.test(r),u=/^a|p$/i.test(r),h=s||t;if((g.has(r)||l||"meridiem"===o&&u&&!h)&&null!=n){if("ArrowLeft"===r)this._activePart=this._prevPart();else if("ArrowRight"===r)this._activePart=this._nextPart();else if("Tab"===r){const e=a?this._prevPart():this._nextPart();if(e===this._activePart)return;this._activePart=e}else if("ArrowUp"===r)this._shift("up",o);else if("ArrowDown"===r)this._shift("down",o);else if(l)this._setTime(n,o,Number(r));else if(u){const e=r.toLowerCase(),t=n.hour;("a"===e&&t>=12||"p"===e&&t<12)&&this._shift("up",o)}e.preventDefault(),e.stopImmediatePropagation()}else h||(e.preventDefault(),e.stopImmediatePropagation())}_handleInputClick(e){const t=e.target;this._activePart=null,this.renderNow(),this._activePart=this._caretIndexToPartName(t.selectionStart??0)}_getOrderedParts(){return w(this._activeTime,this._dateTimeFormatOptions)?["hours","minutes","meridiem"]:["hours","minutes"]}_prevPart(){const e=this._getOrderedParts(),t=this._activePart?e.indexOf(this._activePart)-1:0;return e[Math.max(t,0)]}_nextPart(){const e=this._getOrderedParts(),t=this._activePart?e.indexOf(this._activePart)+1:0;return e[Math.min(t,e.length-1)]}_setTime(e,t,i){if("hours"===t){const t=w(e,this._dateTimeFormatOptions)?12:24,s=""+e.hour%t,a=i,r=Number(`${s}${i}`);2===s.length||r>t?this._activeTime=e.set({hour:a}):r<=t&&(this._activeTime=e.set({hour:r}))}else if("minutes"===t){const t=59,s=`${e.minute}`,a=i,r=Number(`${s}${i}`);2===s.length||r>t?this._activeTime=e.set({minute:a}):r<t&&(this._activeTime=e.set({minute:r}))}}_parseTime(e){if(!e)return null;let t=p.DateTime.fromFormat(e,P,this._dateTimeOptions);return t.isValid?t:(t=p.DateTime.fromISO(e,this._dateTimeOptions),t.isValid?t:(t=p.DateTime.fromRFC2822(e,this._dateTimeOptions),t.isValid?t:(t=p.DateTime.fromJSDate(new Date(e),this._dateTimeOptions),t.isValid?t:null)))}_handleInputPaste(e){const t=e.clipboardData?.getData("text/plain"),i=this._parseTime(t);i&&(this._activeTime=i),e.preventDefault(),e.stopImmediatePropagation()}_handleInputWheel(e){const t=e.deltaY<0?"up":"down";this._shift(t,this._activePart)}_shift(e,t){if(!t)return;const i="up"===e?"plus":"minus",s="meridiem"===t?12:1,a="hours"===t?"hour":"minutes"===t?"minute":"hours";this._activeTime=this._activeTime?.[i]({[a]:s})??null}};e.__decorate([s.property()],y.prototype,"_dateTimeFormatOptions",null),e.__decorate([s.property()],y.prototype,"_dateTimeOptions",null),e.__decorate([s.property(),m.messageBundle("esri/widgets/support/t9n/TimePicker")],y.prototype,"messages",void 0),e.__decorate([s.property()],y.prototype,"timeZone",void 0),e.__decorate([s.property()],y.prototype,"timeZoneName",void 0),e.__decorate([s.property()],y.prototype,"value",null),e.__decorate([s.property({type:h})],y.prototype,"viewModel",void 0),y=e.__decorate([o.subclass("esri.widgets.support.TimePicker")],y);return y}));
