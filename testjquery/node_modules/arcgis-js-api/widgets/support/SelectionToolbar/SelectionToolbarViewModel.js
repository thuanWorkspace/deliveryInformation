/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/deprecate","../../../core/Evented","../../../core/handleUtils","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/support/layerUtils","../../../views/draw/support/layerUtils","../../../views/support/layerViewUtils","../Selector2D"],(function(e,t,r,o,s,i,a,c,n,l,p,u,h,d,y,_){"use strict";let v=class extends r.EventedAccessor{constructor(e){super(e),this._operationHandlesGroup=null,this.activeOperation=null,this.selector=new _,this.sources=null}initialize(){this.addHandles([a.watch((()=>this._sources),(e=>{this.selector.sources=e,this.activeOperation&&(this.activeOperation.sources=e)}))])}destroy(){this._operationHandlesGroup=i.removeMaybe(this._operationHandlesGroup),this.selector.destroy()}get _sources(){const{sources:e,view:t}=this;return t&&e?.length?e.flatMap((e=>{if(y.isSelectableLayerView2D(e))return e;if(h.isKnowledgeGraphLayer(e)){const r=e.layers||[],o=r.map((e=>{const r=d.findLayerView(t,e)||void 0;return y.isSelectableLayerView2D(r)?r:e}));return o.length?o.toArray():r.length?r.toArray():e}const r=d.findLayerView(t,e)||void 0;return y.isSelectableLayerView2D(r)?r:e})):[]}set cursor(e){this.activeOperation&&(this.activeOperation.cursor=e),this.selector.cursor=e,this._set("cursor",e)}get layers(){return t.deprecatedProperty(s.getLogger(this),"layers",{replacement:"Use SelectionToolbar.sources instead."}),this.sources}set layers(e){t.deprecatedProperty(s.getLogger(this),"layers",{replacement:"Use SelectionToolbar.sources instead."}),this.sources=e}get state(){return this.activeOperation?"active":this.view?.ready&&this._sources.length?"ready":"disabled"}set view(e){this.selector.view=e,this._set("view",e)}async selectionFrom(e,t){const{_sources:r}=this;return this.view&&r.length?this.selector.selectionFrom({geometry:e,selectionOptions:t,sources:r}):[]}cancel(){"active"===this.state&&(this.activeOperation?.cancel(),this._set("activeOperation",null))}activate(e){const{_sources:t,state:r}=this;if("disabled"===r||!t?.length)return;"active"===r&&this.cancel();const s=this.selector.draw({sources:t,operationOptions:e});return this._operationHandlesGroup=o.handlesGroup([s.once("complete",(e=>this._onOperationComplete(e))),s.on("selection-change",(e=>this._onOperationSelectionChange(e)))]),this._set("activeOperation",s),s}_onOperationSelectionChange(e){this.emit("selection-change",e)}_onOperationComplete(e){this._operationHandlesGroup=i.removeMaybe(this._operationHandlesGroup),this._set("activeOperation",null),this.emit("complete",e)}};e.__decorate([c.property()],v.prototype,"_sources",null),e.__decorate([c.property({readOnly:!0})],v.prototype,"activeOperation",void 0),e.__decorate([c.property()],v.prototype,"cursor",null),e.__decorate([c.property()],v.prototype,"layers",null),e.__decorate([c.property({readOnly:!0})],v.prototype,"selector",void 0),e.__decorate([c.property()],v.prototype,"sources",void 0),e.__decorate([c.property({readOnly:!0})],v.prototype,"state",null),e.__decorate([c.property()],v.prototype,"view",null),v=e.__decorate([u.subclass("esri.widgets.support.SelectionToolbar.SelectionToolbarViewModel")],v);return v}));
