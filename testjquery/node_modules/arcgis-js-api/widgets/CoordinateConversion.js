/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../core/events","../core/Logger","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./CoordinateConversion/CoordinateConversionViewModel","./CoordinateConversion/support/Conversion","./support/globalCss","./support/Heading","./support/legacyIcon","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils"],(function(e,t,s,o,i,n,r,a,l,d,p,c,u,h,_,g,v,b){"use strict";const m="esri-coordinate-conversion",y={base:m,captureMode:`${m}--capture-mode`,noBasemap:`${m}--no-basemap`,popup:`${m}__popup`,clipboardPopup:`${m}__clipboard-popup`,conversionList:`${m}__conversion-list`,conversionRow:`${m}__row`,coordDisplay:`${m}__display`,expanded:`${m}__conversions-view--expanded`,expandDown:`${m}__conversions-view--expand-down`,expandUp:`${m}__conversions-view--expand-up`,conversionsView:`${m}__conversions-view`,primarySelect:`${m}__select-primary`,rowSelect:`${m}__select-row`,toolDisplay:`${m}__tools`,modeToggle:`${m}__mode-toggle`,rowButton:`${m}__row-button`,backButton:`${m}__back-button`,convertButton:`${m}__button`,convertButtonSpan:`${m}__convert-button-span`,coordinateInput:`${m}__input-coordinate`,inputForm:`${m}__input-form`,inputFormGroup:`${m}__input-group`,rejectInput:`${m}__input-coordinate--rejected`,sectionHeading:`${m}__heading`,patternInput:`${m}__pattern-input`,settings:`${m}__settings`,settingsFormGroup:`${m}__settings-group`,settingsFormGroupHorizontal:`${m}__settings-group-horizontal`,previewCoordinate:`${m}__preview-coordinate`},x={settingsButton:!0,inputButton:!0,captureButton:!0,expandButton:!0},C=750,w=2500;let I=class extends l{constructor(e,t){super(e,t),this._popupMessage=null,this._popupTimeoutId=void 0,this._clipboardPopupTimeoutId=void 0,this._coordinateInput=null,this._badInput=!1,this._goToEnabled=!1,this._conversionFormat=null,this._settingsFormat=null,this._previewConversion=null,this._expanded=!1,this._clipboardPopupVisible=!1,this._popupVisible=!1,this._settingsVisible=!1,this._inputVisible=!1,this.headingLevel=4,this.messages=null,this.messagesCommon=null,this.orientation="auto",this.viewModel=new d,this.visibleElements={...x}}get conversions(){return this.viewModel.conversions}set conversions(e){this.viewModel.conversions=e}get currentLocation(){return this.viewModel.currentLocation}set currentLocation(e){this.viewModel.currentLocation=e}get formats(){return this.viewModel.formats}set formats(e){this.viewModel.formats=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get mode(){return this.viewModel.mode}set mode(e){this.viewModel.mode=e}set multipleConversions(e){!1===e&&(this._expanded=!1,this.conversions.splice(1,this.conversions.length-1)),this._set("multipleConversions",e)}get multipleConversions(){const e=this._get("multipleConversions");return"boolean"!=typeof e||e}get locationSymbol(){return this.viewModel.locationSymbol}set locationSymbol(e){this.viewModel.locationSymbol=e}get storageEnabled(){return this.viewModel.storageEnabled}set storageEnabled(e){this.viewModel.storageEnabled=e}get storageType(){return this.viewModel.storageType}set storageType(e){this.viewModel.storageType=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...x,...e}}reverseConvert(e,t){return this.viewModel.reverseConvert(e,t)}render(){const e=this.viewModel?.state,t="disabled"===e?v.tsx("div",{key:"esri-coordinate__no-basemap"},this.messages?.noBasemap):null,s=!t&&this._inputVisible?this._renderInputForm():null,o=!t&&this._settingsVisible?this._renderSettings():null,i=t||s||o?null:this._renderConversionsView(),n=this._popupVisible?this._renderPopup():null,r={[y.captureMode]:"capture"===this.mode,[c.globalCss.disabled]:"loading"===e,[y.noBasemap]:"disabled"===e};return v.tsx("div",{class:this.classes(y.base,c.globalCss.widget,r)},n,t,i,o,s)}_addConversion(e){const t=e.target,s=T(t.options[t.options.selectedIndex]),o=f(t);if(null==s||null==o)return;const i=new p({format:s});t.options.selectedIndex=0,o>=0?(this.conversions.removeAt(o),this.conversions.add(i,o)):this.conversions.add(i)}_findSettingsFormat(){return this._settingsFormat||this.conversions.reduceRight(((e,t)=>{const s=t.format;return s?.hasDisplayProperties?s:e}),null)||this.formats.find((e=>e.hasDisplayProperties))}_hidePopup(){this._popupTimeoutId&&(clearTimeout(this._popupTimeoutId),this._popupTimeoutId=void 0),this._popupVisible=!1,this._popupMessage=null,this.scheduleRender()}_hideClipboardPopup(){this._clipboardPopupTimeoutId&&(clearTimeout(this._clipboardPopupTimeoutId),this._clipboardPopupTimeoutId=void 0),this._clipboardPopupVisible=!1,this.scheduleRender()}_onConvertComplete(){this._inputVisible=!1,this._coordinateInput.value=""}_onCopy(e){const t=P(e.currentTarget)?.displayCoordinate;null!=t&&(e.clipboardData?.setData("text/plain",t),this._showClipboardPopup(),e.preventDefault())}_processUserInput(e){const o=t.eventKey(e),i=this.viewModel;if("Enter"!==o&&o)this._badInput&&(this._badInput=!1);else{const e=T(this._coordinateInput);if(!e)return;const t=this._coordinateInput.value;this._reverseConvert(t,e).then((e=>{"capture"===this.mode?i.resume():this.mode="capture",this.currentLocation=e,i.setLocation(e),this._onConvertComplete()})).catch((e=>{s.getLogger(this).error(e),this._showPopup(this.messages?.invalidCoordinate),this._badInput=!0}))}}async _reverseConvert(e,t){const o=this.viewModel,i=await t.reverseConvert(e);return this._goToEnabled&&i&&o.goToLocation(i).catch((e=>{s.getLogger(this).warn(e),this._showPopup(this.messages?.locationOffBasemap)})),i}_setInputFormat(e){const t=e.target,s=T(t[t.options.selectedIndex]);null!=s&&(this._conversionFormat=s)}_setPreviewConversion(){const e=this._findSettingsFormat(),t=this.viewModel;if(e){const s=this.conversions.find((t=>t.format===e));this._previewConversion=new p({format:e,position:{location:this.currentLocation,coordinate:s?.position?.coordinate}}),this._previewConversion.position?.coordinate||t.previewConversion(this._previewConversion)}}_setSettingsFormat(e){const t=e.target,s=T(t[t.options.selectedIndex]);null!=s&&(this._settingsFormat=s,this._setPreviewConversion())}_showClipboardPopup(){this._clipboardPopupVisible?clearTimeout(this._clipboardPopupTimeoutId):this._clipboardPopupVisible=!0,this.scheduleRender(),this._popupTimeoutId=setTimeout((()=>{this._popupTimeoutId=void 0,this._hideClipboardPopup()}),C)}_showPopup(e,t=w){this._popupMessage=e,this._popupVisible?clearTimeout(this._popupTimeoutId):this._popupVisible=!0,this.scheduleRender(),this._popupTimeoutId=setTimeout((()=>{this._popupTimeoutId=void 0,this._hidePopup()}),t)}_toggleGoTo(){this._goToEnabled=!this._goToEnabled}_updateCurrentPattern(e){e.stopPropagation();const t=e.target,s=this._findSettingsFormat();s&&(s.currentPattern=t.value)}_renderConversion(e,t){const{messages:s}=this;if(!s)return v.tsx("li",null);const{format:o}=e,i=o?.label??"",n=`${this.id}__list-item-${t}`,r=`${i} ${s.conversionOutputSuffix}`,a=0===t,l=a||this._expanded,d=a?this._renderFirstConversion(e):this._renderTools(t,e,n),p=a&&!e.displayCoordinate?s.noLocation:e.displayCoordinate,u=v.tsx("div",{"aria-label":p,class:y.coordDisplay,"data-conversion":e,role:"listitem",tabIndex:0,title:p??""},p),h=this._renderOptions(this.formats.filter((e=>e!==o)));return l?v.tsx("li",{"aria-label":r,class:y.conversionRow,id:n,key:e,role:"group",tabIndex:0,title:r},v.tsx("select",{"aria-controls":n,"aria-label":s.selectFormat,bind:this,class:this.classes(c.globalCss.select,y.rowSelect),"data-index":t,onchange:this._addConversion,title:s.selectFormat},v.tsx("option",{"aria-label":i,selected:!0,title:i},i.toUpperCase()),h),u,d):null}_renderCopyButton(e){const t=this._clipboardPopupVisible&&this._renderClipboardPopup(),{messagesCommon:s}=this;return s?v.tsx("li",{"aria-label":s.copy,bind:this,class:this.classes(c.globalCss.widgetButton,y.rowButton),"data-conversion":e,onclick:this._copyCoordinateOutput,oncopy:this._onCopy,onkeydown:this._copyCoordinateOutput,role:"button",tabIndex:0,title:s.copy},t,v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.duplicate})):v.tsx("li",null)}_renderFirstConversion(e){const t=this.id,s={[h.legacyIcon.down]:!this._expanded,[h.legacyIcon.up]:this._expanded},{messages:o,messagesCommon:i,multipleConversions:n,visibleElements:r}=this;if(!i||!o)return v.tsx("ul",null);const a="live"===this.mode?o.captureMode:o.liveMode,l=this._expanded?i.collapse:i.expand,d=e.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(e):null,p=n&&r.expandButton&&v.tsx("li",{"aria-controls":`${t}__${y.conversionList}`,"aria-label":l,bind:this,class:c.globalCss.widgetButton,key:"esri-coordinate-conversion__expand-button",onclick:this._toggleExpand,onkeydown:this._toggleExpand,role:"button",tabIndex:0,title:l},v.tsx("span",{"aria-hidden":"true",class:this.classes(s)})),u=!n&&r.captureButton&&v.tsx("li",{"aria-label":a,bind:this,class:this.classes(c.globalCss.widgetButton,y.modeToggle),key:"esri-coordinate-conversion__mode-toggle",onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabIndex:0,title:a},v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.mapPin}));return v.tsx("ul",{class:y.toolDisplay},d,p,u)}_renderInputForm(){const e=this._conversionFormat||this.conversions.at(0).format,t=this.formats.findIndex((t=>t.name===e?.name)),s=this.id,o=`${s}__${y.coordinateInput}`,i=`${s}__${y.coordinateInput}__header`,n=this._renderOptions(this.formats,!0,t),r={[y.rejectInput]:this._badInput},{messages:a,messagesCommon:l,headingLevel:d}=this;return l&&a?v.tsx("div",{"aria-labelledby":i,class:y.inputForm,key:"esri-coordinate-conversion__input-form",role:"search"},v.tsx("div",{class:y.sectionHeading},v.tsx("div",{"aria-label":l.back,bind:this,class:this.classes(c.globalCss.widgetButton,y.backButton),onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabIndex:0,title:l.back},this._renderBackIcon()),v.tsx(u.Heading,{class:c.globalCss.heading,id:i,level:d},a.inputCoordTitle)),v.tsx("div",{class:y.inputFormGroup},v.tsx("select",{"aria-controls":o,"aria-label":a.selectFormat,bind:this,class:this.classes(c.globalCss.select,y.rowSelect),onchange:this._setInputFormat,title:a.selectFormat},n),v.tsx("input",{afterCreate:b.storeNode,"aria-labelledby":i,"aria-required":"true",bind:this,class:this.classes(y.coordinateInput,c.globalCss.input,r),"data-format":e,"data-node-ref":"_coordinateInput",id:o,onkeydown:this._processUserInput,placeholder:a.inputCoordTitle,role:"textbox",spellcheck:!1,title:a.inputCoordTitle,type:"text"})),v.tsx("div",{class:y.inputFormGroup},v.tsx("label",{"aria-label":a.goTo},v.tsx("input",{bind:this,checked:this._goToEnabled,onclick:this._toggleGoTo,title:a.goTo,type:"checkbox"}),a.goTo),v.tsx("button",{"aria-label":a.convert,bind:this,class:this.classes(y.convertButton,c.globalCss.button),onclick:this._processUserInput,title:a.convert,type:"button"},v.tsx("span",{class:y.convertButtonSpan},a.convert)))):v.tsx("div",null)}_renderConversionsView(){const{messages:e}=this;if(!e)return v.tsx("div",null);const t=`${this.id}__${y.conversionList}`,s=this._renderPrimaryTools(),o=this._renderOptions(this.formats),i=this.conversions.map(((e,t)=>this._renderConversion(e,t))).toArray(),n=this._expanded?v.tsx("div",{class:y.conversionRow},v.tsx("select",{"aria-controls":t,"aria-label":e.addConversion,bind:this,class:this.classes(c.globalCss.select,y.primarySelect),"data-index":-1,onchange:this._addConversion,title:e.addConversion},v.tsx("option",{disabled:!0,selected:!0,value:""},e.addConversion),o),s):null,r={[y.expanded]:this._expanded,[y.expandUp]:"expand-up"===this.orientation,[y.expandDown]:"expand-down"===this.orientation};return v.tsx("div",{class:this.classes(y.conversionsView,r),key:"esri-coordinate-conversion__main-view"},v.tsx("ul",{"aria-expanded":this._expanded?"true":"false",class:y.conversionList,id:t},i),n)}_renderOptions(e,t,s){const o=this.conversions.at(0),i=o.format?.name;return e.map(((e,n)=>{const r=!(t||!o)&&(i===e.name||this.conversions.map((e=>e.format?.name)).includes(e.name));return v.tsx("option",{"aria-label":e.label,"data-format":e,disabled:r,key:e.name??"unnamed-format",selected:n===s,value:e.label},e.label.toUpperCase())})).toArray()}_renderPopup(){return v.tsx("div",{class:y.popup,role:"alert"},this._popupMessage)}_renderClipboardPopup(){const{messages:e}=this;return e?v.tsx("div",{class:this.classes(y.popup,y.clipboardPopup),role:"alert"},e.copySuccessMessage):v.tsx("div",null)}_renderPrimaryTools(){const{messages:e,visibleElements:t}=this;if(!e)return v.tsx("ul",null);const s="live"===this.mode?e.captureMode:e.liveMode,o=t.inputButton&&v.tsx("li",{bind:this,class:c.globalCss.widgetButton,onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabIndex:0,title:e.inputCoordTitle},v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.edit})),i=t.captureButton&&v.tsx("li",{bind:this,class:this.classes(c.globalCss.widgetButton,y.modeToggle),onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabIndex:0,title:s},v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.mapPin})),n=t.settingsButton&&v.tsx("li",{bind:this,class:c.globalCss.widgetButton,onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabIndex:0,title:e.settingsTitle},v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.settings2}));return v.tsx("ul",{class:y.toolDisplay},o,i,n)}_renderSettings(){const e=this.id,t=`${e}__${y.patternInput}`,s=`${e}__${y.patternInput}__header`,o=`${e}__${y.previewCoordinate}`,i=this.formats.filter((e=>e.hasDisplayProperties)),n=this._findSettingsFormat(),r=n?i.indexOf(n):-1,a=this._renderOptions(i,!0,r),l=n?.currentPattern,{messages:d,messagesCommon:p,headingLevel:_}=this;return p&&d?v.tsx("div",{"aria-labelledby":s,class:y.settings,key:y.settings},v.tsx("div",{class:y.sectionHeading},v.tsx("div",{bind:this,class:this.classes(c.globalCss.widgetButton,y.backButton),onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabIndex:0,title:p.back},this._renderBackIcon()),v.tsx(u.Heading,{class:c.globalCss.heading,id:s,level:_},d.settingsTitle)),v.tsx("div",{class:y.settingsFormGroup},v.tsx("label",{for:t},d.changeCoordinateDisplay),v.tsx("select",{"aria-label":d.selectFormat,bind:this,class:c.globalCss.select,onchange:this._setSettingsFormat,title:d.selectFormat},a),v.tsx("div",{class:y.settingsFormGroupHorizontal},v.tsx("input",{"aria-controls":o,bind:this,class:this.classes(y.patternInput,c.globalCss.input),id:t,oninput:this._updateCurrentPattern,spellcheck:!1,title:d.changeCoordinateDisplay,type:"text",value:l}),v.tsx("div",{"aria-controls":t,bind:this,class:c.globalCss.widgetButton,onclick:this._setDefaultPattern,onkeydown:this._setDefaultPattern,role:"button",tabIndex:0,title:d.defaultPattern},v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.refresh})))),v.tsx("div",{class:y.settingsFormGroup},v.tsx("label",null,p.preview,v.tsx("div",{class:y.previewCoordinate,id:o,tabIndex:0},this._previewConversion?.displayCoordinate)))):v.tsx("div",null)}_renderBackIcon(){return v.tsx("span",{"aria-hidden":"true",class:b.isRTL(this.container)?h.legacyIcon.rightArrow:h.legacyIcon.leftArrows})}_renderTools(e,t,s){const o=t.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(t):null,{messages:i}=this;return i?v.tsx("ul",{class:y.toolDisplay,role:"listitem"},o,v.tsx("li",{"aria-controls":s,"aria-label":i.removeConversion,bind:this,class:this.classes(c.globalCss.widgetButton,y.rowButton),"data-index":e,key:`${s}__${c.globalCss.widgetButton}`,onclick:this._removeConversion,onkeydown:this._removeConversion,role:"button",tabIndex:0,title:i.removeConversion},v.tsx("span",{"aria-hidden":"true",class:h.legacyIcon.close}))):v.tsx("ul",null)}_copyCoordinateOutput(e){const t=e.target;if(!("createTextRange"in document.body)){const e=window.getSelection(),s=document.createRange();s.selectNodeContents(t),e?.removeAllRanges(),e?.addRange(s)}document.execCommand("copy")}_removeConversion(e){const t=f(e.currentTarget);null!=t&&this.conversions.removeAt(t)}_setDefaultPattern(e){e.stopPropagation();const t=this._findSettingsFormat();t&&(t.currentPattern=t.defaultPattern)}_toggleExpand(){this._expanded=!this._expanded}_toggleInputVisibility(){this._inputVisible=!this._inputVisible,this._popupVisible&&this._hidePopup(),this._inputVisible?this.viewModel.pause():this.viewModel.resume()}_toggleMode(){this.mode="live"===this.mode?"capture":"live"}_toggleSettingsVisibility(){this._settingsVisible=!this._settingsVisible,this._popupVisible&&this._hidePopup(),this._settingsVisible?(this._setPreviewConversion(),this.viewModel.pause()):this.viewModel.resume()}};function f(e){return e["data-index"]}function T(e){return e["data-format"]}function P(e){return e["data-conversion"]}e.__decorate([o.property()],I.prototype,"conversions",null),e.__decorate([o.property()],I.prototype,"currentLocation",null),e.__decorate([o.property()],I.prototype,"formats",null),e.__decorate([o.property()],I.prototype,"goToOverride",null),e.__decorate([o.property()],I.prototype,"headingLevel",void 0),e.__decorate([o.property()],I.prototype,"label",null),e.__decorate([o.property(),g.messageBundle("esri/widgets/CoordinateConversion/t9n/CoordinateConversion")],I.prototype,"messages",void 0),e.__decorate([o.property(),g.messageBundle("esri/t9n/common")],I.prototype,"messagesCommon",void 0),e.__decorate([o.property()],I.prototype,"mode",null),e.__decorate([o.property()],I.prototype,"orientation",void 0),e.__decorate([o.property()],I.prototype,"multipleConversions",null),e.__decorate([o.property()],I.prototype,"locationSymbol",null),e.__decorate([o.property()],I.prototype,"storageEnabled",null),e.__decorate([o.property()],I.prototype,"storageType",null),e.__decorate([o.property()],I.prototype,"view",null),e.__decorate([o.property({type:d})],I.prototype,"viewModel",void 0),e.__decorate([o.property()],I.prototype,"visibleElements",void 0),e.__decorate([i.cast("visibleElements")],I.prototype,"castVisibleElements",null),e.__decorate([_.accessibleHandler()],I.prototype,"_copyCoordinateOutput",null),e.__decorate([_.accessibleHandler()],I.prototype,"_removeConversion",null),e.__decorate([_.accessibleHandler()],I.prototype,"_setDefaultPattern",null),e.__decorate([_.accessibleHandler()],I.prototype,"_toggleExpand",null),e.__decorate([_.accessibleHandler()],I.prototype,"_toggleInputVisibility",null),e.__decorate([_.accessibleHandler()],I.prototype,"_toggleMode",null),e.__decorate([_.accessibleHandler()],I.prototype,"_toggleSettingsVisibility",null),I=e.__decorate([a.subclass("esri.widgets.CoordinateConversion")],I);return I}));
