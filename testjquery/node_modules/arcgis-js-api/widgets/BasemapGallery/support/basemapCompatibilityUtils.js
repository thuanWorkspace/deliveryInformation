/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/arrayUtils","../../../core/Error","../../../core/promiseUtils","../../../layers/support/layerUtils","../../../views/ViewingMode","../../../views/3d/terrain/terrainUtils","../../../views/3d/terrain/TilingScheme","../../../views/support/spatialReferenceSupport"],(function(e,t,i,a,r,n,l,o,s){"use strict";async function p(e,t={}){const{basemap:i,view:r}=e;await i.load(t),m(i),await w(i,r,t),a.throwIfAborted(t)}async function c(e,i={}){const{basemap:n,view:l}=e;if(a.throwIfAborted(i),!l||"spatialReferenceLocked"in l&&!l.spatialReferenceLocked)return;if(await n.load(i),a.throwIfAborted(i),0===n.baseLayers.length)return;const o=n.baseLayers.at(0);if(!r.isTiledLayer(o))return;if(n.spatialReference){if(l.spatialReference.equals(n.spatialReference))return;f()}await o.load(i),a.throwIfAborted(i);const s=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo?.spatialReference:null]).filter(t.isSome);0!==s.length&&s.every((e=>!l.spatialReference.equals(e)))&&f()}function f(){throw new i("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}function m(e){if(0===e.baseLayers.length&&0===e.referenceLayers.length)return;const t=e.baseLayers.concat(e.referenceLayers).toArray().filter((e=>!r.isBasemap3DSupportedLayer(e))).map((e=>u(e)));if(t.length)throw t[0]}function u(e){return new i("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})}async function w(e,t,a){if(0===e.baseLayers.length)return;const n=e.baseLayers.at(0);if(r.isBasemapSupportedTiledLayer(n)){try{await n.load(a)}catch(l){const e="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:a=e,message:r=t,details:n}=l;throw new i(a,r,n)}y(n,t)}}function y(e,t){const a=t.state.viewingMode;if(!a)return;let r,p;if("wmts"===e?.type){const n=l.getTileInfoAndExtentFromWMTSLayer(e,t.spatialReference,a);if(null==n.tileInfo)throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");r=n.tileInfo,p=n.fullExtent}else r=e.tileInfo,p=e.fullExtent;if(null==r)return;if(!s.isSpatialReferenceSupported(r.spatialReference,a))throw new i(`basemapgalleryitem:spatial-reference-unsupported-${n.stringFromViewingMode(a)}`,`Basemap spatial reference is unsupported in ${n.stringFromViewingMode(a)} mode`);const c=r.spatialReference.isGeographic,f="vector-tile"===e?.type?r.getOrCreateCompatible(256,c?1:2):null;if(a===n.ViewingMode.Global){let t=l.checkIfTileInfoSupportedForView(r,p,null,a);if(t&&"vector-tile"===e?.type&&null!=p&&f&&!l.checkIfTileInfoSupportedForView(f,p,null,a)&&(t=null),t){const e=r.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new i(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(o.TilingScheme.checkUnsupported(r))throw new i("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const m=t.basemapTerrain?.tilingScheme;if(m&&!m.compatibleWith(r)&&("vector-tile"!==e?.type||!f||!m.compatibleWith(f)))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}e.default2DCompatibility=c,e.default3DCompatibility=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
