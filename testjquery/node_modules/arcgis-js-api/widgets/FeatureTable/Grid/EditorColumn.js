/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./Column","../../support/uriUtils"],(function(t,e,o,n,i,r,a,u,s){"use strict";const l="esri-editor-column__cell-input",c={input:l,inputContainer:`${l}--container`},p={showInput:"Enter",hideInput:"Escape"};let d=class extends u{constructor(t){super(t),this.activeEditInfo=null,this.cellValueValidatorFunction=({oldValue:t,value:e})=>t!==e,this.editable=!1,this.inputRenderFunction=({root:t,column:e,rowData:o})=>{if(this.activeEditInfo?.updating)return;if(!this.editable)return;const n=this.getCellValue(e,o),i=this.createInputElement({root:t,column:e,rowData:o,value:n});this._set("activeEditInfo",{column:e,input:i,root:t,rowData:o,updating:!0,oldValue:n});const r=this.createInputContainer();r.appendChild(i),this.removeCellContent(t),t.appendChild(r),i.focus(),i instanceof HTMLInputElement&&i.select(),this.grid?.notifyResize()},this.loadingMessage="",this.inputType="text",this.maxLength=null,this.parseInputValueFunction=({input:t})=>t.value,this.renderFunction=t=>{const{root:e,column:o,rowData:n}=t,{activeEditInfo:i}=this;if(i&&i.updating)return;const r=this.getCellValue(o,n),a=this.cellValueFormatFunction({column:o,rowData:n,value:r});e.onclick=()=>e.focus(),e.ondblclick=()=>this.inputRenderFunction(t),e.ontouchend=()=>this.inputRenderFunction(t);const u=this.grid?.getSlotElementByName(e.slot),l=u?.parentElement;l&&!l.onkeydown&&(l.onkeydown=e=>{e.key!==p.showInput||this.activeEditInfo||this.inputRenderFunction(t),e.key===p.hideInput&&this.activeEditInfo&&this.cancel()}),null!=r&&null!=a?e.title=a.toString():e.title&&e.removeAttribute("title");const c=s.autoLink(this.messagesURIUtils,a);a?.toString()!==e.innerHTML&&c!==e.innerHTML&&(e.innerHTML=c)},this.required=!1,this.store=null,this.updateRowItemFunction=({rowData:t,column:o,value:n})=>{e.assertIsSome(t),t.item[o.path]=n},this.updateStoreItemFunction=async({rowData:t,column:o,value:n})=>{e.assertIsSome(t),await(this.store?.updateItem({index:t.index,name:o.path,value:n}))}}cancel(){const{activeEditInfo:t}=this;if(!t)return;const{column:e,root:o,rowData:n,oldValue:i}=t;this._set("activeEditInfo",null);const r=this.cellValueFormatFunction({column:e,rowData:n,value:i}),a=s.autoLink(this.messagesURIUtils,r);o.innerHTML=a,this.grid?.notifyResize()}createInputContainer(){const t=document.createElement("div");return t.classList.add(c.inputContainer),t}createInputElement({value:t}){const e=document.createElement("input");return e.classList.add(c.input),null!=this.maxLength&&(e.maxLength=this.maxLength),e.type=this.inputType,e.value=t,e.onblur=()=>{e.onblur=null,this.submit()},e}async submit(){const{activeEditInfo:t}=this;if(!t)return;const{column:e,input:o,root:n,rowData:i,oldValue:r}=t,a=this.parseInputValueFunction({input:o,column:e,rowData:i});if(!this.cellValueValidatorFunction({value:a,oldValue:r,column:e,rowData:i}))this.cancel();else{n.innerHTML=this.loadingMessage,this.grid?.notifyResize();try{await this.updateStoreItemFunction({rowData:i,column:e,value:a}),this.updateRowItemFunction({rowData:i,column:e,value:a});const t=this.getCellValue(e,i),o=this.cellValueFormatFunction({column:e,rowData:i,value:t});null!=t&&null!=o?n.title=o.toString():n.title&&n.removeAttribute("title");const r=s.autoLink(this.messagesURIUtils,o);n.innerHTML=r,this.emit("value-change",{column:e,rowData:i,value:t}),this._set("activeEditInfo",null),this.grid?.notifyResize()}catch(u){this.cancel()}}}};t.__decorate([o.property({readOnly:!0})],d.prototype,"activeEditInfo",void 0),t.__decorate([o.property()],d.prototype,"cellValueValidatorFunction",void 0),t.__decorate([o.property()],d.prototype,"editable",void 0),t.__decorate([o.property()],d.prototype,"inputRenderFunction",void 0),t.__decorate([o.property({constructOnly:!0})],d.prototype,"loadingMessage",void 0),t.__decorate([o.property()],d.prototype,"inputType",void 0),t.__decorate([o.property()],d.prototype,"maxLength",void 0),t.__decorate([o.property()],d.prototype,"parseInputValueFunction",void 0),t.__decorate([o.property()],d.prototype,"renderFunction",void 0),t.__decorate([o.property()],d.prototype,"required",void 0),t.__decorate([o.property()],d.prototype,"store",void 0),t.__decorate([o.property()],d.prototype,"updateRowItemFunction",void 0),t.__decorate([o.property()],d.prototype,"updateStoreItemFunction",void 0),d=t.__decorate([a.subclass("esri.widgets.FeatureTable.Grid.EditorColumn")],d);return d}));
