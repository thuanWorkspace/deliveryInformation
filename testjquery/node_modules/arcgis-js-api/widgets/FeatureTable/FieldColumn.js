/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/number","../../layers/support/CodedValueDomain","../../layers/support/editableLayers","../../layers/support/fieldUtils","../../layers/support/layerUtils","../FeatureForm/FieldInput","./Grid/EditorColumn","../support/DatePicker","../support/dateUtils","../support/legacyIcon","../support/TimePicker","../support/widgetUtils"],(function(e,t,n,i,r,a,o,l,d,u,s,p,c,m,h,y,_,g,f,v,F){"use strict";const b={cancelEdit:"Escape"},D="esri-field-column",E={headerContent:`${D}__header-content`,headerLabel:`${D}__header-label`,input:`${D}__cell-input`,inputContainer:`${D}__cell__input-container`,dateInputContainer:`${D}__cell__date-input-container`,dateInputWrapper:`${D}__cell__date-input-wrapper`,button:`${D}__button`},C=d.convertDateFormatToIntlOptions("short-date-short-time"),I=d.convertDateFormatToIntlOptions("short-date"),L={useGrouping:!0,maximumFractionDigits:20};let w=class extends y{constructor(e){super(e),this._inputField=null,this.cellValueFormatFunction=({rowData:e,value:t})=>{if(this.formatFunction){const{template:e,field:n}=this;return this.formatFunction({template:e,field:n,value:F.renderingSanitizer.sanitize(t)})}if(null===t)return"&nbsp;";const{field:n}=this,i=e?.item?.feature,r=this._getDomainForFeature(i);if(r){const e=this._getComputedDomain(t,r);if("date"===n.type&&"range"===r.type)return this._formatDateValueForDisplay(n,e);if(c.isNumericField(n)&&"range"===r.type){const e=this.template?.format,n=e?u.convertNumberFormatToIntlOptions(e):L;return u.formatNumber(parseFloat(t),n)}return g.dateFieldsWithStringFieldValue.has(n.type)?"range"===r.type?F.renderingSanitizer.sanitize(g.getLabelForDateFieldValue(n,e)):F.renderingSanitizer.sanitize(e):e}if("date"===n.type||g.dateFieldsWithStringFieldValue.has(n.type))return this._formatDateValueForDisplay(n,t);if(c.isNumericField(n)){const e=this.template?.format,n=e?u.convertNumberFormatToIntlOptions(e):L;return u.formatNumber(parseFloat(t),n)}return F.renderingSanitizer.sanitize(t)},this.cellValueValidatorFunction=({oldValue:e,value:n})=>{const{_inputField:i,field:r}=this;return!(i&&!i.valid)&&((!this.required||null!=n&&""!==n)&&(c.isNumericField(r)&&c.validateFieldValue(r,n)?(t.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),!1):e!==n))},this.editingEnabled=!1,this.expressionInfos=null,this.field=null,this.formatFunction=null,this.headerRenderFunction=e=>{const{root:t}=e,{editable:n,editingEnabled:i,headerMenuEnabled:r,sortable:a}=this;if(this.removeCellContent(t),t.classList.add(E.headerContent),i&&!n&&t.appendChild(this.createLockedElement()),a)this.headerSorterRenderFunction(e);else{const e=document.createElement("div");e.classList.add(E.headerLabel),e.textContent=this.label,t.appendChild(e)}r&&this.headerMenuRenderFunction(e)},this.inputRenderFunction=({root:e,column:n,rowData:i})=>{if(this.activeEditInfo?.updating||!this.editable)return;const r=this.getCellValue(n,i),{field:a}=this;if(c.isNumericField(a)&&c.validateFieldValue(a,r))return void t.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");const o=this.createInputElement({root:e,column:n,rowData:i,value:r});if(this._set("activeEditInfo",{column:n,input:o,root:e,rowData:i,updating:!0,oldValue:r}),"date"===this.field.type)return void this._renderDateEditors(r,e,o);const l=this.createInputContainer();l.appendChild(o),this.removeCellContent(e),e.appendChild(l),o.focus(),o instanceof HTMLInputElement&&o.select(),this.grid?.notifyResize()},this.layer=null,this.parseInputValueFunction=({input:e})=>{const t=this._inputField;if(!t)return null;const n=e.value,{dataType:i,required:r}=t;return r||""!==n?"number"===i||"date"===i?parseFloat(n):"text"===i?n.trim():n:null},this.store=null,this.template=null,this.updateRowItemFunction=({rowData:e,column:t,value:n})=>{e&&(e.item.feature.attributes[t.path]=n)},this.updateStoreItemFunction=async({rowData:e,column:t,value:n})=>{if(!e||!this.store)return;const i=e.item.objectId,r=this.store.getObjectIdIndex(i)??e.index;await this.store.updateItem({index:r,name:t.path,value:n})}}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.field?.description??null}get editable(){const{editingEnabled:e,field:t,layer:n,template:i}=this;if(null==t||null==n)return!1;const r=p.isEditableLayer(n),a=m.getEffectiveLayerCapabilities(n),o=a?.operations.supportsUpdate;return!!(t.editable&&r&&o)&&(!g.dateFieldsWithStringFieldValue.has(t.type)&&(e?!(!1===i?.editable):!!i?.editable))}get header(){return this.template?.label||this.alias||this.path||null}get hidden(){const{template:e}=this;return!1===e?.visible||this._get("hidden")||!1}set hidden(e){this._set("hidden",e)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:e,template:t}=this,n=e?.length??-1,i=t?.input&&"maxLength"in t.input?t.input.maxLength:null;return null!=i&&!isNaN(i)&&i>=-1&&(-1===n||i<=n)?i:n}get minLength(){const{template:e,maxLength:t}=this,n=e?.input&&"minLength"in e.input?e.input.minLength:null;return t&&n<=t?n:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){const{field:e,template:t}=this,n=e?.nullable,i=t?.required;return this.editable&&(!n||!0===i)}get sortable(){return!(!1===this.template?.sortable)}createInputElement({rowData:e,value:t}){const n=e?.item;if(!n?.feature)return null;this._inputField=this._setUpInputField(n.feature,t);const{field:i,maxLength:r,minLength:a,required:o}=this,{domain:l}=this._inputField;let d;"coded-value"===l?.type?(d=this._createSelectElement(t,l.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),this._inputField),d.onchange=()=>{d.onblur=null,s()}):(d=document.createElement("input"),d.type=c.isNumericField(i)?"number":"text",r>-1&&(d.maxLength=r),a>0&&(d.minLength=a)),d.classList.add(E.input),d.value=t,d.required=o;let u=!1;d.onkeydown=e=>{u=e.key===b.cancelEdit},d.onblur=()=>{d.onblur=null,s()};const s=()=>{u?this.cancel():this.submit(),this._inputField=null};return d}createInputContainer(){const e=document.createElement("div");return e.classList.add(E.inputContainer),e}createLockedElement(){const e=document.createElement("div");return e.classList.add(f.legacyIcon.locked),e}getCellValue({path:e},t){return t?.item?.feature?.attributes?.[e]??null}_formatDateValueForDisplay(e,t){const{timeZone:n,timeZoneName:i}=this;return null!=t?g.getLabelForDateFieldValue(e,t,{...this._getDateFormatOptions(),timeZone:n??void 0,timeZoneName:i??void 0}):null}_renderDateEditors(e,t,i){const{messagesCommon:r,template:a,timeZone:o}=this,l=e?new Date(e):new Date(Date.now()),d=new _({dateInputEnabled:!0,timeZone:o,value:l}),u=new v({timeZone:o,value:l});i.value=l.getTime().toString();let s=!e;const p=()=>{s=!0;const e=this._getCombinedDateTime(d.value,u.value);i.value=e.getTime().toString()},c=()=>{s?this.submit():this.cancel()},m=()=>{i.value=null,this.submit()};n.watch((()=>[d.value,u.value]),(()=>p()));const h=document.createElement("div"),y=document.createElement("div");d.container=h,u.container=y;const g=document.createElement("button");g.classList.add(E.button,f.legacyIcon.save),g.onclick=()=>c(),g.title=r?.save;const F=document.createElement("button");F.classList.add(E.button,f.legacyIcon.trash),F.onclick=()=>m(),F.title=r?.clear;const b=document.createElement("div");b.classList.add(E.dateInputWrapper),b.appendChild(h),(!a||a?.input&&"datetime-picker"===a.input.type&&!1!==a.input.includeTime)&&b.appendChild(y);const D=document.createElement("div");D.classList.add(E.dateInputContainer),D.appendChild(b),D.appendChild(g),D.appendChild(F),d.when((()=>{const e=d._inputOrButtonNode;e&&(e.onblur=e=>{const t=e.relatedTarget;t&&t.className.includes("esri-date-picker")||d.close(!1)}),this.grid?.notifyResize()})),u.when((()=>this.grid?.notifyResize())),this.removeCellContent(t),t.appendChild(D),this.grid?.notifyResize()}_createSelectElement(e,t,n){let i=!1;const r=t.map((t=>{t.value===e&&(i=!0);const n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));if(null!=e&&""!==e&&!i){const t=document.createElement("option");t.text=e,t.value=e,r.unshift(t)}if(!n.required&&null==n.value){const e=document.createElement("option");e.value="",r.unshift(e)}const a=document.createElement("select");return r.forEach((e=>a.add(e))),a.value=e,a}_setUpInputField(e,t){const{field:n,layer:i}=this,r=new h({feature:e,initialFeature:e.clone(),field:n,layer:i});return r.set("value",t),r}_isDomainCompatible(e){const{field:t}=this;if(e&&"coded-value"===e.type){const n=typeof e.codedValues[0].code;if("string"===n&&c.isStringField(t)||"number"===n&&c.isNumericField(t))return!0}return!(!e||"range"!==e.type||!c.isNumericField(t))}_getDomainForFeature(e){const{layer:t,name:n,template:i}=this;if(!t)return null;if("wfs"===t.type||"geojson"===t.type||"csv"===t.type)return null;if(i?.domain&&this._isDomainCompatible(i.domain))return i.domain;const{typeIdField:r}=t,a=r===n,o=this.field.domain;if(a&&!o)return new s({name:"__internal-type-based-coded-value-domain__",codedValues:t.types?.map((({id:e,name:t})=>({code:e,name:t})))});return r&&null!=n&&t.getFieldDomain(n,{feature:e})||o}_getComputedDomain(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const n=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return n&&n.length?n[0].name:e}return null}_getCombinedDateTime(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())}_getDateFormatOptions(){const{template:e}=this,t=e?.format?.dateFormat;return t?d.convertDateFormatToIntlOptions(t):e?.input&&"includeTime"in e.input&&!1===e.input.includeTime?I:C}};e.__decorate([i.property({readOnly:!0})],w.prototype,"alias",null),e.__decorate([i.property()],w.prototype,"cellValueFormatFunction",void 0),e.__decorate([i.property()],w.prototype,"cellValueValidatorFunction",void 0),e.__decorate([i.property({readOnly:!0})],w.prototype,"defaultValue",null),e.__decorate([i.property({readOnly:!0})],w.prototype,"description",null),e.__decorate([i.property({readOnly:!0})],w.prototype,"editable",null),e.__decorate([i.property()],w.prototype,"editingEnabled",void 0),e.__decorate([i.property()],w.prototype,"expressionInfos",void 0),e.__decorate([i.property()],w.prototype,"field",void 0),e.__decorate([i.property()],w.prototype,"formatFunction",void 0),e.__decorate([i.property({readOnly:!0})],w.prototype,"header",null),e.__decorate([i.property()],w.prototype,"hidden",null),e.__decorate([i.property()],w.prototype,"headerRenderFunction",void 0),e.__decorate([i.property()],w.prototype,"inputRenderFunction",void 0),e.__decorate([i.property()],w.prototype,"layer",void 0),e.__decorate([i.property({readOnly:!0})],w.prototype,"loadingMessage",null),e.__decorate([i.property()],w.prototype,"maxLength",null),e.__decorate([i.property()],w.prototype,"minLength",null),e.__decorate([i.property({readOnly:!0})],w.prototype,"name",null),e.__decorate([i.property({readOnly:!0})],w.prototype,"nullable",null),e.__decorate([i.property()],w.prototype,"parseInputValueFunction",void 0),e.__decorate([i.property({readOnly:!0})],w.prototype,"path",null),e.__decorate([i.property({readOnly:!0})],w.prototype,"required",null),e.__decorate([i.property()],w.prototype,"sortable",null),e.__decorate([i.property()],w.prototype,"store",void 0),e.__decorate([i.property()],w.prototype,"template",void 0),e.__decorate([i.property()],w.prototype,"updateRowItemFunction",void 0),e.__decorate([i.property()],w.prototype,"updateStoreItemFunction",void 0),w=e.__decorate([l.subclass("esri.widgets.FeatureTable.FieldColumn")],w);return w}));
