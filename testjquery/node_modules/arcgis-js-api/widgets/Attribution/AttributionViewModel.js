/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Collection","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/contains","../../geometry/support/webMercatorUtils"],(function(t,e,i,r,n,o,s,a,c,u,l,h,d,p){"use strict";function y(t,e){return t&&"copyright"in t&&(!e||"function"==typeof t.originOf&&"user"===t.originOf("copyright"))}function b(t,e){return t.length!==e.length||t.some(((t,i)=>t.text!==e[i].text))}function f(t,e,i){if(!i||!e)return;t.find((t=>t.layerView===e&&t.text===i))||t.push({text:i,layerView:e})}function m(t){return"bing-maps"===t.type}const g=[];let _=class extends e{constructor(t){super(t),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new r,this.view=null,this._allLayerViewsChange=t=>{this.removeHandles("suspension");const e=this.view?.allLayerViews;e&&this.addHandles(e.map((t=>n.watch((()=>[t.suspended,t.layer?.attributionVisible]),(()=>this._updateAttributionItems())))).toArray(),"suspension"),t?.removed&&t.removed.forEach((t=>{this._pendingAttributions.delete(t),this._fetchedAttributionData.delete(t)})),this._updateAttributionItems()},this.addHandles([n.on((()=>this.view?.allLayerViews),"change",(t=>this._allLayerViewsChange(t)),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),n.when((()=>!0===this.view?.stationary),(()=>this._updateAttributionItems()))])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const t=this.view,e=t?.allLayerViews;g.length=0,t&&e?(e.forEach((e=>{if(e.suspended||!e.layer?.attributionVisible)return;const i=e.layer;if(y(i,"user"))return void f(g,e,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(e)){const r=this._fetchedAttributionData.get(e);return void(r?f(g,e,this._getDynamicAttribution(r,t,i)):y(i)&&f(g,e,i.copyright))}return void this._fetchAttributionData(e)}const r="portalItem"in i?i.portalItem?.accessInformation:void 0;f(g,e,r||i.copyright)})),b(this.items,g)&&(this.items.removeAll(),this.items.addMany(g)),g.length=0,this.notifyChange("state")):this._clear()}async _fetchAttributionData(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await i.result(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const i=e.ok?this._createContributionIndex(e.value,m(t.layer)):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)}this._updateAttributionItems()}_createContributionIndex(t,e){const i=t.contributors,r={};if(!i)return r;for(let o=0;o<i.length;o++){const t=i[o],s=t.coverageAreas;if(!s)return;for(const i of s){const s=i.bbox,a=i.zoomMin-(e&&i.zoomMin?1:0),c=i.zoomMax-(e&&i.zoomMax?1:0),u=new l({xmin:s[1],ymin:s[0],xmax:s[3],ymax:s[2],spatialReference:h.WGS84}),d={extent:p.geographicToWebMercator(u),attribution:t.attribution||"",score:null!=i.score?i.score:100,id:o};for(let t=a;t<=c;t++){var n;r[n=t]??(r[n]=[]),r[t].push(d)}}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(t,e,i){const{extent:r,scale:n}=e;let o=i.tileInfo?.scaleToZoom(n)??0;if(o=Math.min(t.maxKey??0,Math.round(o)),!r||null==o||o<=-1)return"";const s=t[o],a=p.project(r.center.clone().normalize(),e.spatialReference),c=new Set;return s?s.filter((t=>{const e=t.id,i=!c.has(e)&&a&&t.extent&&d.extentContainsPoint(t.extent,a);return i&&c.add(e),i})).sort(((t,e)=>e.score-t.score||t.objectId-e.objectId)).map((t=>t.attribution)).join(", "):""}};t.__decorate([o.property({readOnly:!0,type:r})],_.prototype,"items",void 0),t.__decorate([o.property({readOnly:!0})],_.prototype,"state",null),t.__decorate([o.property()],_.prototype,"view",void 0),_=t.__decorate([u.subclass("esri.widgets.Attribution.AttributionViewModel")],_);return _}));
