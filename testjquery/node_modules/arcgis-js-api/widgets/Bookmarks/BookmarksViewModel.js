/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../Viewpoint","../../core/Collection","../../core/deprecate","../../core/Error","../../core/Evented","../../core/Logger","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../webdoc/support/SlideThumbnail","../../webmap/Bookmark","../support/GoTo"],(function(t,e,o,i,a,r,n,s,c,p,l,u,d,k,m){"use strict";const w=o.ofType(k),h={width:128,height:128,format:"png"},b={takeScreenshot:!0,captureViewpoint:!0,captureRotation:!0,captureScale:!0,captureTimeExtent:!0},v={time:!0},_="esri.widgets.Bookmarks.BookmarksViewModel",y=n.getLogger(_);let g=class extends(m.GoToMixin(r.EventedAccessor)){constructor(t){super(t),this.capabilities={...v},this.activeBookmark=null,this.view=null}destroy(){this.view=null,this._set("activeBookmark",null)}get abilities(){return i.deprecatedProperty(y,"abilities",{replacement:"capabilities",version:"4.27"}),this.capabilities}set abilities(t){i.deprecatedProperty(y,"abilities",{replacement:"capabilities",version:"4.27"}),this.capabilities=t}castAbilities(t){return{...v,...t}}castCapabilities(t){return{...v,...t}}get bookmarks(){return this.view?.map?.bookmarks??new w}set bookmarks(t){this._overrideIfSome("bookmarks",t)}set defaultCreateOptions(t){this._set("defaultCreateOptions",{...b,...t})}get defaultCreateOptions(){return b}set defaultEditOptions(t){this._set("defaultEditOptions",{...b,...t})}get defaultEditOptions(){return b}get state(){const{view:t}=this;return t&&!t.ready?"loading":"ready"}async createBookmark(t){const{view:e,defaultCreateOptions:o,capabilities:i}=this;if(!e)throw new a("create-bookmark:invalid-view","Cannot create a bookmark without a view.");const{takeScreenshot:r,screenshotSettings:n,captureViewpoint:s,captureRotation:c,captureScale:p,captureTimeExtent:l}={...o,...t},u=r?await this._createThumbnail(n):void 0,d=i.time&&l&&null!=e.timeExtent?e.timeExtent.clone():void 0;return new k({...u&&{thumbnail:u},...l&&{timeExtent:d},...s&&{viewpoint:this._createViewpoint({view:e,captureScale:p,captureRotation:c})}})}async editBookmark(t,e){if(!t)return t;const{view:o,defaultEditOptions:i}=this;if(!o)throw new a("edit-bookmark:invalid-view","Cannot edit a bookmark without a view.");const{takeScreenshot:r,screenshotSettings:n,captureViewpoint:s,captureRotation:c,captureScale:p,captureTimeExtent:l}={...i,...e},u=r?await this._createThumbnail(n):void 0;return u&&(t.thumbnail=u),s&&(t.viewpoint=this._createViewpoint({view:o,captureScale:p,captureRotation:c})),l&&null!=o.timeExtent&&(t.timeExtent=o.timeExtent.clone()),this.emit("bookmark-edit",{bookmark:t}),t}goTo(t){const{capabilities:e,view:o}=this;if(!o)throw new a("go-to:invalid-view","Cannot go to a bookmark without a view");const i=t?.viewpoint;if(!i)throw new a("go-to:invalid-bookmark","Cannot go to a bookmark that does not contain a 'viewpoint'.",{bookmark:t});this._set("activeBookmark",t);const r={target:i},n=this.callGoTo(r),s=t?.timeExtent;return e.time&&s&&(o.timeExtent=s),this.emit("bookmark-select",{bookmark:t}),n.catch((()=>{})).then((()=>this._set("activeBookmark",null))),n}async _createThumbnail(t){const{view:e}=this;if(!e)throw new a("bookmark:invalid-view","Cannot create slide thumbnail without a view");const o=await e.takeScreenshot({...h,...t});return new d.SlideThumbnail({url:o.dataUrl})}_createViewpoint({view:t,captureRotation:o,captureScale:i}){const a=t.viewpoint?.clone();return new e({targetGeometry:t.extent?.clone(),rotation:(o?a?.rotation:null)??0,scale:(i?a?.scale:null)??0})}};t.__decorate([s.property()],g.prototype,"abilities",null),t.__decorate([c.cast("abilities")],g.prototype,"castAbilities",null),t.__decorate([s.property()],g.prototype,"capabilities",void 0),t.__decorate([c.cast("capabilities")],g.prototype,"castCapabilities",null),t.__decorate([s.property({readOnly:!0})],g.prototype,"activeBookmark",void 0),t.__decorate([s.property({type:w})],g.prototype,"bookmarks",null),t.__decorate([s.property()],g.prototype,"defaultCreateOptions",null),t.__decorate([s.property()],g.prototype,"defaultEditOptions",null),t.__decorate([s.property({readOnly:!0})],g.prototype,"state",null),t.__decorate([s.property()],g.prototype,"view",void 0),g=t.__decorate([u.subclass(_)],g);return g}));
