/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../intl","../core/deprecate","../core/Logger","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./FeatureTable/FeatureTableViewModel","./FeatureTable/Grid/support/ButtonMenu","./FeatureTable/Grid/support/ButtonMenuItem","./support/componentsUtils","./support/globalCss","./support/Heading","./support/legacyIcon","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/substitute"],(function(e,t,l,i,s,o,r,n,a,d,c,h,u,p,g,m,_,b,w,v,y,M,E){"use strict";const S={header:!0,menu:!0,menuItems:{clearSelection:!0,refreshData:!0,toggleColumns:!0,selectedRecordsShowAllToggle:!0,selectedRecordsShowSelectedToggle:!0,zoomToSelection:!0,deleteSelection:!0},selectionColumn:!0,columnMenus:!0},C="esri-feature-table",f=`${C}__prompt`,I={base:C,header:`${C}__header`,title:`${C}__title`,content:`${C}__content`,loader:`${C}__loader`,loaderContainer:`${C}__loader-container`,menuContainer:`${C}__menu`,promptContainer:f,promptHeader:`${f}__header`,promptHeading:`${f}__header__heading`,promptMessage:`${f}__message`,promptDivider:`${f}__divider`,promptActions:`${f}__actions`},F=s.getLogger("esri.widgets.FeatureTable");let R=class extends h{constructor(e,t){super(e,t),this._prompt=null,this.menu=null,this.menuConfig=null,this.viewModel=new u,this.visibleElements={...S},this._showDeletePrompt=this._showDeletePrompt.bind(this),this._onDeleteSelectionClick=this._onDeleteSelectionClick.bind(this)}initialize(){this.addHandles([o.on((()=>this.viewModel.columns),"change",(()=>this._syncMenuConfig())),o.on((()=>this.viewModel.activeFilters),"change",(()=>this._syncMenuConfig())),o.on((()=>this.highlightIds),"change",(e=>{this._syncMenuConfig(),this._onSelectionChange(e)})),o.watch((()=>[this.viewModel.store.querying,this.viewModel.store.syncing,this.editingEnabled]),(()=>this.scheduleRender())),o.watch((()=>[this.menuConfig,this.editingEnabled]),(()=>this._syncMenuConfig())),o.watch((()=>this.messages),(()=>{this.menu&&(this.menu.label=this.messages?.options),this._syncMenuConfig()}))]),this._set("menu",new p({label:this.messages?.options,iconClass:w.legacyIcon.handleHorizontal,...this.menuConfig}));const{attachmentsEnabled:e,relatedRecordsEnabled:t}=this;this.viewModel?.store?.set({attachmentsEnabled:e,relatedRecordsEnabled:t})}loadDependencies(){return m.loadCalciteComponents({button:()=>new Promise(((t,l)=>e(["../chunks/calcite-button"],t,l))),icon:()=>new Promise(((t,l)=>e(["../chunks/calcite-icon"],t,l))),scrim:()=>new Promise(((t,l)=>e(["../chunks/calcite-scrim"],t,l)))})}destroy(){this._prompt=null,this.menu?.destroy()}get activeFilters(){return this.viewModel.activeFilters}get activeSortOrders(){return this.viewModel.activeSortOrders}get attachmentsEnabled(){return this.viewModel.attachmentsEnabled}set attachmentsEnabled(e){this.viewModel.attachmentsEnabled=e}get autoRefreshEnabled(){return this.viewModel.autoRefreshEnabled}set autoRefreshEnabled(e){this.viewModel.autoRefreshEnabled=e}get columnReorderingEnabled(){return this.viewModel.columnReorderingEnabled}set columnReorderingEnabled(e){this.viewModel.columnReorderingEnabled=e}get columns(){return this.viewModel.columns}get editingEnabled(){return this.viewModel.editingEnabled}set editingEnabled(e){this.viewModel.editingEnabled=e}get filterGeometry(){return this.viewModel.filterGeometry}set filterGeometry(e){this.viewModel.filterGeometry=e}get grid(){return this.viewModel.grid}get hiddenFields(){return this.viewModel.hiddenFields}set hiddenFields(e){this.viewModel.hiddenFields=e}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(e){this.viewModel.highlightEnabled=e}get highlightIds(){return this.viewModel.highlightIds}set highlightIds(e){this.viewModel.highlightIds=e}get highlightOnRowSelectEnabled(){return this.viewModel.highlightEnabled}set highlightOnRowSelectEnabled(e){this.viewModel.highlightEnabled=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get messages(){return this.viewModel.messages}set messages(e){this.viewModel.messages=e}get messagesCommon(){return this.viewModel.messagesCommon}set messagesCommon(e){this.viewModel.messagesCommon=e}get messagesURIUtils(){return this.viewModel.messagesURIUtils}set messagesURIUtils(e){this.viewModel.messagesURIUtils=e}get multiSortEnabled(){return this.viewModel.multiSortEnabled}set multiSortEnabled(e){this.viewModel.multiSortEnabled=e}get pageSize(){return this.viewModel.pageSize}set pageSize(e){this.viewModel.pageSize=e}get relatedRecordsEnabled(){return this.viewModel.relatedRecordsEnabled}set relatedRecordsEnabled(e){this.viewModel.relatedRecordsEnabled=e}get state(){return this.viewModel.state}get tableTemplate(){return this.viewModel.tableTemplate}set tableTemplate(e){this.viewModel.tableTemplate=e}get timeExtent(){return this.viewModel.timeExtent}set timeExtent(e){this.viewModel.timeExtent=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){const t={...S,...e};return this.grid?.set("visibleElements",{...this.grid.visibleElements,selectionColumn:t.selectionColumn,columnMenus:t.columnMenus}),t}clearHighlights(){return i.deprecatedFunction(F,"`FeatureTable.clearHighlights` is deprecated in favor of FeatureTable.highlightIds'",{replacement:"FeatureTable.highlightIds",version:"4.25",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-FeatureTable.html#highlightIds"}),this.viewModel.clearHighlights()}clearSelection(){return i.deprecatedFunction(F,"`FeatureTable.clearSelection` is deprecated in favor of FeatureTable.highlightIds'",{replacement:"FeatureTable.highlightIds",version:"4.25",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-FeatureTable.html#highlightIds"}),this.viewModel.clearSelection()}clearSelectionFilter(){return this.viewModel.clearSelectionFilter()}deleteSelection(e){return this.highlightIds.length?e?(this._showDeletePrompt(),this.scheduleRender(),Promise.resolve()):this.viewModel.deleteSelection():Promise.resolve()}deselectRows(e){return this.viewModel.deselectRows(e)}filterBySelection(){return this.viewModel.filterBySelection()}findColumn(e){return this.viewModel.findColumn(e)}hideColumn(e){this.grid?.hideColumn(e),this._syncMenuConfig()}refresh(){return this.viewModel.refresh()}get returnGeometryEnabled(){return this.viewModel.returnGeometryEnabled}set returnGeometryEnabled(e){this.viewModel.returnGeometryEnabled=e}showAllColumns(){return this.viewModel.showAllColumns()}showColumn(e){this.grid?.showColumn(e),this._syncMenuConfig()}sortColumn(e,t){return this.viewModel.sortColumn(e,t)}selectRows(e){return this.viewModel.selectRows(e)}scrollToIndex(e){return this.viewModel.scrollToIndex(e)}zoomToSelection(){this.viewModel.zoomToSelection()}render(){const{_prompt:e}=this,t=null!=e?M.tsx("calcite-scrim",null,this._renderPrompt(e)):null;return M.tsx("div",{bind:this,class:this.classes(I.base,_.globalCss.widget)},this.visibleElements.header?this._renderHeader():null,M.tsx("div",{class:I.content},"disabled"!==this.state&&this.grid?.render()),t)}_renderPrompt({title:e,message:t,context:l,actions:i}){const s=M.tsx("calcite-button",{appearance:"solid",key:"prompt-primary-button",kind:"danger"===l?"danger":"brand",onclick:i.primary.action,width:i.secondary?"half":"full"},i.primary.label),o=i.secondary?M.tsx("calcite-button",{appearance:"outline",key:"prompt-secondary-button",kind:"danger"===l?"danger":"brand",onclick:i.secondary.action,width:"half"},i.secondary.label):null;return M.tsx("div",{class:`${I.promptContainer}--${l}`},M.tsx("div",{class:I.promptHeader},M.tsx("calcite-icon",{icon:"exclamation-mark-triangle"}),M.tsx(b.Heading,{class:I.promptHeading,level:2},e)),M.tsx("div",{class:I.promptMessage},t),M.tsx("div",{class:I.promptDivider}),M.tsx("div",{class:I.promptActions},o,s))}_renderHeader(){return M.tsx("div",{class:I.header,key:"header"},this._renderLoader(),this._renderTitle(),this.visibleElements.menu?this._renderMenu():null)}_renderTitle(){return M.tsx("div",{class:I.title,key:"title"},this._getTitle())}_getTitle(){const{grid:e,highlightIds:t,layer:l,messages:i,viewModel:{size:s}}=this;return e&&l?E.substitute(i.header,{title:l.title,count:s,selected:t.length||0}):""}_renderLoader(){const{state:e,store:t}=this.viewModel,l="loading"===e||t.syncing||t.querying;return M.tsx("div",{class:I.loaderContainer},l?M.tsx("div",{class:I.loader,key:"loader"}):null)}_renderMenu(){return M.tsx("div",{class:I.menuContainer},this.menu?.render())}_onSelectionChange(e){const{added:t,removed:l}=e,i=t.map((e=>this.viewModel.store.getLocalItemByKey(e)||{objectId:e,feature:null,attachments:null,relatedRecords:null})),s=l.map((e=>this.viewModel.store.getLocalItemByKey(e)||{objectId:e,feature:null,attachments:null,relatedRecords:null}));this.emit("selection-change",{added:i,removed:s})}_syncMenuConfig(){this.menu?.set({...this.menuConfig,items:this._getMenuItems()})}_getMenuItems(){const e=this.menuConfig?.items,t=this._getDefaultMenuItems(),l=[];return t?.length&&l.push(...t),e?.length&&l.push(...e),l}_getDefaultMenuItems(){const{highlightIds:e,messages:t,viewModel:l,visibleElements:i}=this,{menuItems:s}=i,o=[];if(s?.refreshData&&o.push(new g({selectionEnabled:!1,label:t?.refreshData,clickFunction:()=>this.refresh()})),e.length){const l=this._getSelectionFilter();if(s?.clearSelection&&o.push(new g({selectionEnabled:!1,label:t?.clearSelection,clickFunction:()=>this.highlightIds?.removeAll()})),s?.zoomToSelection&&this.view&&o.push(new g({selectionEnabled:!1,label:t?.zoomToSelection,clickFunction:()=>this.viewModel.zoomToSelection()})),s?.selectedRecordsShowSelectedToggle&&(!l||e.length!==l.objectIds.length)){const e=t.showSelected,l=new g({selectionEnabled:!1,label:e,clickFunction:()=>{this.filterBySelection(),l.set("label",e)}});o.push(l)}s?.deleteSelection&&this.editingEnabled&&this.layer?.capabilities?.operations?.supportsDelete&&o.push(new g({selectionEnabled:!1,label:t.deleteSelection,clickFunction:this._showDeletePrompt}))}if(s?.selectedRecordsShowAllToggle&&this._hasSelectionFilter()){const e=t.showAllRecords,l=new g({selectionEnabled:!1,label:e,clickFunction:()=>{this.clearSelectionFilter(),l.set("label",e)}});o.push(l)}return s?.toggleColumns&&o.push(new g({iconClass:w.legacyIcon.right,label:t?.toggleColumns,clickFunction:this._toggleMenuItemSelectedIcon,items:l?.columns?.items.map((({header:e,hidden:t,path:l})=>new g({label:e||l,selected:!t,selectionEnabled:!0,iconClass:w.legacyIcon.checkMark,clickFunction:()=>this._toggleColumnFromMenuItem(l)})))})),o.length?o:null}_toggleMenuItemSelectedIcon({item:e}){e?.set("iconClass",e?.selected?w.legacyIcon.down:w.legacyIcon.right)}_toggleColumnFromMenuItem(e){const{grid:t,viewModel:l}=this,i=l.findColumn(e);i?.hidden?t?.showColumn(e):t?.hideColumn(e)}_showDeletePrompt(){const{messages:e,messagesCommon:t}=this,l=this.highlightIds.length||0,i=E.substitute(e.deleteSelectionCount,{count:l});this.menu&&(this.menu.open=!1),this._prompt={title:i,message:e.deleteRecordsRemoved,context:"danger",actions:{primary:{label:t.delete,action:this._onDeleteSelectionClick},secondary:{label:e.keepRecords,action:()=>this._prompt=null}}}}async _onDeleteSelectionClick(){await this.viewModel.deleteSelection(),this._prompt=null}_getSelectionFilter(){return this.viewModel.activeFilters?.find((e=>"selection"===e.type))}_hasSelectionFilter(){return!!this._getSelectionFilter()}};t.__decorate([r.property({readOnly:!0})],R.prototype,"activeFilters",null),t.__decorate([r.property({readOnly:!0})],R.prototype,"activeSortOrders",null),t.__decorate([r.property()],R.prototype,"attachmentsEnabled",null),t.__decorate([r.property()],R.prototype,"autoRefreshEnabled",null),t.__decorate([r.property()],R.prototype,"columnReorderingEnabled",null),t.__decorate([r.property({readOnly:!0})],R.prototype,"columns",null),t.__decorate([r.property()],R.prototype,"editingEnabled",null),t.__decorate([r.property()],R.prototype,"filterGeometry",null),t.__decorate([r.property({readOnly:!0})],R.prototype,"grid",null),t.__decorate([r.property()],R.prototype,"hiddenFields",null),t.__decorate([r.property()],R.prototype,"highlightEnabled",null),t.__decorate([r.property()],R.prototype,"highlightIds",null),t.__decorate([r.property()],R.prototype,"highlightOnRowSelectEnabled",null),t.__decorate([r.property()],R.prototype,"label",null),t.__decorate([r.property()],R.prototype,"layer",null),t.__decorate([r.property(),y.messageBundle("esri/widgets/FeatureTable/t9n/FeatureTable")],R.prototype,"messages",null),t.__decorate([r.property(),y.messageBundle("esri/t9n/common")],R.prototype,"messagesCommon",null),t.__decorate([r.property(),y.messageBundle("esri/widgets/support/t9n/uriUtils")],R.prototype,"messagesURIUtils",null),t.__decorate([r.property({readOnly:!0})],R.prototype,"menu",void 0),t.__decorate([r.property()],R.prototype,"menuConfig",void 0),t.__decorate([r.property()],R.prototype,"multiSortEnabled",null),t.__decorate([r.property()],R.prototype,"pageSize",null),t.__decorate([r.property()],R.prototype,"relatedRecordsEnabled",null),t.__decorate([r.property({readOnly:!0})],R.prototype,"state",null),t.__decorate([r.property()],R.prototype,"tableTemplate",null),t.__decorate([r.property()],R.prototype,"timeExtent",null),t.__decorate([r.property()],R.prototype,"timeZone",null),t.__decorate([r.property()],R.prototype,"view",null),t.__decorate([r.property()],R.prototype,"viewModel",void 0),t.__decorate([r.property()],R.prototype,"visibleElements",void 0),t.__decorate([n.cast("visibleElements")],R.prototype,"castVisibleElements",null),t.__decorate([r.property()],R.prototype,"returnGeometryEnabled",null),R=t.__decorate([c.subclass("esri.widgets.FeatureTable")],R);return R}));
