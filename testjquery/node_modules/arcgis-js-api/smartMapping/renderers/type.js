/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../renderers/PointCloudClassBreaksRenderer","../../renderers/PointCloudRenderer","../../renderers/PointCloudRGBRenderer","../../renderers/PointCloudStretchRenderer","../../renderers/PointCloudUniqueValueRenderer","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Logger","../../core/Error","../../core/lang","../../intl/messages","../../layers/support/fieldUtils","../../renderers/support/LegendOptions","../../renderers/support/utils","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/uniqueValues","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/type"],(function(e,l,r,n,i,a,t,s,o,d,u,p,c,m,y,f,b,g,h,v,w,T,S,z,V,E,I,x,M,C){"use strict";async function L(e){if(!e?.layer||!e.field&&!e.valueExpression)throw new b("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new b("type-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&I.verifyBinningParams(e,"type-renderer");const l={...e,layer:e.layer};l.symbolType=l.symbolType||"2d",l.numTypes=null==l.numTypes?10:l.numTypes,l.defaultSymbolEnabled??(l.defaultSymbolEnabled=!0),l.sortBy??(l.sortBy="count"),l.sortEnabled??(l.sortEnabled=!0),l.statistics=g.clone(l.statistics);const r=e.forBinning?M.binningCapableLayerTypes:M.featureCapableLayerTypes,n=M.createLayerAdapter(l.layer,r,e.forBinning);if(!n)throw new b("type-renderer:invalid-parameters","'layer' must be one of these types: "+M.getLayerTypeLabels(r).join(", "));l.layer=n;const i=null!=l.signal?{signal:l.signal}:null;await n.load(i);const a=n.geometryType;if(l.outlineOptimizationEnabled="polygon"===a&&l.outlineOptimizationEnabled,l.sizeOptimizationEnabled=("point"===a||"multipoint"===a||"polyline"===a)&&l.sizeOptimizationEnabled,"mesh"===a)l.symbolType="3d-volumetric",l.colorMixMode=l.colorMixMode||"replace",l.edgesType=l.edgesType||"none";else{if("3d-volumetric-uniform"===l.symbolType&&"point"!==a)throw new b("type-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(l.symbolType.includes("3d-volumetric")&&(!l.view||"3d"!==l.view.type))throw new b("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const t=await x.getFieldsList({field:l.field,field2:l.field2,field3:l.field3,valueExpression:l.valueExpression}),s=V.verifyBasicFieldValidity(n,t,"type-renderer:invalid-parameters");if(s)throw s;return l}async function O(e){if(!e?.layer||!e.field)throw new b("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required");const l={...e,layer:e.layer};l.statistics=g.clone(l.statistics);const r=[M.LayerType.PointCloudLayer],n=M.createLayerAdapter(l.layer,r);if(!n)throw new b("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+M.getLayerTypeLabels(r).join(", "));if(l.layer=n,l.density=l.density||25,l.size=l.size||"100%",!V.isValidPointSize(l.size))throw new b("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");const i=null!=l.signal?{signal:l.signal}:null;await n.load(i);const a=await x.getFieldsList({field:l.field}),t=V.verifyBasicFieldValidity(n,a,"type-point-cloud-class-renderer:invalid-parameters");if(t)throw t;return l}async function R(e){let l=e.typeScheme,r=null,n=null;const i=await V.getBasemapInfo(e.basemap,e.view);if(r=null!=i.basemapId?i.basemapId:null,n=null!=i.basemapTheme?i.basemapTheme:null,l)return{scheme:C.cloneScheme(l),basemapId:r,basemapTheme:n};const a=C.getSchemes({basemapTheme:n,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});return a&&(l=a.primaryScheme,r=a.basemapId,n=a.basemapTheme),{scheme:l,basemapId:r,basemapTheme:n}}function q(e,l){let r;return r=e.label<l.label?-1:e.label>l.label?1:0,r}function F(e,l){let r;return r=e.value<l.value?-1:e.value>l.value?1:0,r}function B(e,l){let r=l.count-e.count;return 0===r&&(r=q(e,l)),r}function P(e,l){let r=l.count-e.count;return 0===r&&(r=F(e,l)),r}function U(e,l,r){let n;"count"===l?(n=P,r&&"codedValues"in r&&r.codedValues&&(n=B)):"value"===l&&(n=F,r&&"codedValues"in r&&r.codedValues&&(n=q)),n&&e.sort(n)}async function D(e,l,r,n){const i=await h.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),{field:a,field2:t,field3:s}=l,o=e.uniqueValueInfos,d=l.layer,u=a?d.getField(a):null,p=u?d.getFieldDomain(u.name):null,c=-1===l.numTypes?o.length:l.numTypes,y=d.geometryType,f=await R({basemap:l.basemap,geometryType:y,typeScheme:l.typeScheme,worldScale:!!l.symbolType?.includes("3d-volumetric"),view:l.view}),b=f.scheme,g=new m({field:a,field2:t,field3:s,fieldDelimiter:a&&t?x.fieldDelimiter:null}),S=[],z=[],E={value:null,domain:p,fieldInfo:u};o.forEach(((e,l)=>{E.value=e.value,e.label=T.createUniqueValueLabel(E);const r=e.value;(null===r||"string"==typeof r&&r.toLowerCase().includes("<null>"))&&S.unshift(l)}));for(const m of S)z.unshift(o.splice(m,1)[0]);if(!1!==l.sortEnabled&&U(o,l.sortBy,p),u&&(x.isAnyDateField(u)||v.isTimeOnlyField(u))){const e=o.filter(((e,l)=>l<c)).map((e=>e.value)),r=v.isTimeOnlyField(u)?null:T.calculateDateFormatInterval(e),n=r?T.dateFormatIntervalOptions[r]:void 0;if(E.dateFormatOptions={fieldType:u.type,format:n},l.view){const e=d.layer;E.dateFormatOptions.timeZoneOptions={layerTimeZone:"preferredTimeZone"in e?e.preferredTimeZone:null,viewTimeZone:l.view.timeZone,datesInUnknownTimezone:"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone}}}const I=r?.opacity;let M=V.createColors(b.colors,o.length);const L=V.getSymbolSizeFromScheme(b,y),O=V.getSymbolOutlineFromScheme(b,y,I);o.forEach(((e,r)=>{E.value=e.value,e.label=T.createUniqueValueLabel(E),e.symbol=V.createSymbol(y,{type:l.symbolType,color:M[r],size:L,outline:O,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}})})),l.valueExpression&&(g.valueExpression=l.valueExpression,g.valueExpressionTitle=l.valueExpressionTitle),l.legendOptions&&(g.legendOptions=new w.LegendOptions(l.legendOptions)),M=V.createColors(b.colors,c);for(let m=0;m<c;m++){const e=o[m];e&&g.addUniqueValueInfo({value:e.value,label:e.label,symbol:V.createSymbol(y,{type:l.symbolType,color:M[m],size:L,outline:O,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}})})}l.defaultSymbolEnabled&&(g.defaultSymbol=V.createSymbol(y,{type:l.symbolType,color:b.noDataColor,size:L,outline:O,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}}),g.defaultLabel=i.other);for(const m of z)m.symbol=V.createSymbol(y,{type:l.symbolType,color:b.noDataColor,size:L,outline:O,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}}),o.push(m);const q=[],F=g.uniqueValueInfos?.length??0,B=F===o.length?-1:F;if(B>-1)for(let m=B;m<o.length;m++)q.push({...o[m]});return r?.visualVariables?.length&&(g.visualVariables=r.visualVariables.map((e=>e.clone()))),n?.minSize&&(g.visualVariables?g.visualVariables.push(n.minSize):g.visualVariables=[n.minSize]),{renderer:g,uniqueValueInfos:o,excludedUniqueValueInfos:q,typeScheme:C.cloneScheme(b),basemapId:f.basemapId,basemapTheme:f.basemapTheme}}async function k(e,l){const r=e.uniqueValueInfos,n=await R({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:l}),i=n?.scheme,a="point-cloud-class"===i?.theme,t=a?i.colors:V.createColors(i?.colors??[],r.length);return U(r,"value"),r.map(((e,l)=>{const r=e.value;let n=null;return a?(n=t[r],n||(n=t[t.length-1])):n=t[l],{values:[r],color:n,label:e.label}}))}async function A(e){const l=await L(e),{layer:r,view:n,signal:i}=l,a={layer:r,field:l.field,field2:l.field2,field3:l.field3,valueExpression:l.valueExpression,returnAllCodedValues:l.returnAllCodedValues,view:n,signal:i},[t,s,o]=await Promise.all([null!=l.statistics?l.statistics:E(a),l.outlineOptimizationEnabled?S({layer:r,view:n,signal:i}).catch(V.errorCallback):null,l.sizeOptimizationEnabled?z({layer:r,view:n,signal:i}).catch(V.errorCallback):null]);return D(t,l,s,o)}async function Z(e){const l=await O(e),r=null!=l.statistics?l.statistics:await E({layer:l.layer,field:l.field,signal:l.signal});return{renderer:new a({field:l.field,pointsPerInch:l.density,pointSizeAlgorithm:V.getPointSizeAlgorithm(l.size),colorUniqueValueInfos:await k(r,l.typeScheme)})}}e.createPCClassRenderer=Z,e.createRenderer=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
