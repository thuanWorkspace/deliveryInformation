/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../renderers/support/AuthoringInfo","../../renderers/support/ClassBreakInfo","../../renderers/visualVariables/support/SizeStop","../../renderers/visualVariables/support/visualVariableUtils","./color","./size","./support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/support/aboveAndBelowUtils","../../symbols/support/cimSymbolUtils","../../symbols/support/Symbol3DMaterial"],(function(e,i,a,s,o,l,n,t,r,u,p,c,m,d,b){"use strict";const y=2**53-1;async function v(e){if(!e?.layer||!(e.field||e.valueExpression||e.sqlExpression))throw new i("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===e.theme&&e.sizeOptions?.sizeOptimizationEnabled)throw new i("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");e.forBinning&&u.verifyBinningParams(e,"univariate-colorsize-visual-variables");const a={...e,layer:e.layer},s=e.forBinning?c.binningCapableLayerTypes:c.featureCapableLayerTypes,o=c.createLayerAdapter(a.layer,s,e.forBinning);if(!o)throw new i("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+c.getLayerTypeLabels(s).join(", "));if(a.layer=o,a.theme=a.theme||a.colorOptions?.theme?a.theme:"high-to-low","90-10"===a.theme)throw new i("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");const l=null!=a.signal?{signal:a.signal}:null;await o.load(l);const n=await p.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),t=r.verifyBasicFieldValidity(o,n,"univariate-colorsize-visual-variables:invalid-parameters");if(t)throw t;return a}function f(e,i){const a={...e},{sizeOptions:s,theme:o}=a,l=a.legendOptions||a.sizeOptions?.legendOptions;return delete a.sizeOptions,delete a.colorOptions,{...a,...s,statistics:i||a.statistics,theme:"above-and-below"===o?null:o,legendOptions:l}}function w(e,i){const a={...e},s=a.colorOptions,o=a.theme||s?.theme,l=a.legendOptions||a.colorOptions?.legendOptions;return delete a.sizeOptions,delete a.colorOptions,{...a,...s,statistics:i||a.statistics,theme:o,legendOptions:l}}async function h(e){if(!e?.layer||!(e.field||e.valueExpression||e.sqlExpression))throw new i("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&u.verifyBinningParams(e,"univariate-colorsize-continuous-renderer");const a={...e,layer:e.layer};a.symbolType=a.symbolType||"2d",a.colorOptions||(a.colorOptions={}),a.colorOptions.isContinuous=a.colorOptions.isContinuous??!1;const s=e.forBinning?c.binningCapableLayerTypes:c.featureCapableLayerTypes,o=c.createLayerAdapter(a.layer,s,e.forBinning);if(!o)throw new i("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+c.getLayerTypeLabels(s).join(", "));a.layer=o;const l=null!=a.signal?{signal:a.signal}:null;if(await o.load(l),"above-and-below"===a.theme&&a.symbolOptions){if(a.symbolType.includes("3d-volumetric"))throw new i("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==o.geometryType&&"polygon"!==o.geometryType)throw new i("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const n=await p.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),t=r.verifyBasicFieldValidity(o,n,"univariate-colorsize-continuous-renderer:invalid-parameters");if(t)throw t;return a}function g(e){const i={...e},a={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete a.sizeOptimizationEnabled,{...i,...a}}function z(e,i){if("type"in e&&"cim"===e.type)d.applyCIMSymbolColor(e,i);else if("type"in e&&e.type.includes("3d")){e.symbolLayers.forEach((e=>{"material"in e&&null!=e.material&&"color"in e.material&&(e.material?e.material.color=i:e.material=new b.Symbol3DMaterial({color:i}))}))}else"color"in e&&(e.color=i)}function V(e,i,a){if((i?.symbolStyle||i?.symbols)&&("point"===a||"polygon"===a))return i.symbols||m.getAboveAndBelowSymbols(i.symbolStyle);const s=e.classBreakInfos[0].symbol;return{above:s.clone(),below:s.clone()}}function S(e,i,a){const o=a.symbolOptions,l=a.layer,n=o?.symbols?"custom":o?.symbolStyle,t=a.colorOptions?.isContinuous;if(O(e,i,t),n||!t){const a=i.size.visualVariables[0].stops,{above:r,below:u}=V(e,o,l.geometryType);if(!t){const e=i.color.colorScheme.colors,a=e[0];z(r,e[e.length-1]),z(u,a)}e.classBreakInfos=[new s({minValue:-y,maxValue:a[2].value,symbol:u}),new s({minValue:a[2].value,maxValue:y,symbol:r})],n&&e.authoringInfo&&(e.authoringInfo.univariateSymbolStyle=n)}}function O(e,i,a=!0){const s=i?.authoringInfo?.clone(),o=i.size.visualVariables.map((e=>e.clone()));a?o.push(i.color.visualVariable.clone()):s.visualVariables=s.visualVariables?.filter((e=>"size"===e.type)),o.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=s,e.visualVariables=o}function x(e){const i={...e},a=i.symbolType,s=!!a?.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const o=i;return o.worldScale=s,s&&(o.sizeOptions={...o.sizeOptions},o.sizeOptions.axis="3d-volumetric-uniform"===a?"all":"height"),o}async function E(e,i,a,s){const n=i[0],t=i[1],r=Math.round((t-n)/2)+n,u=e.clone();u.stops=[new o({value:a[0],size:t}),new o({value:a[1],size:r}),new o({value:a[2],size:n}),new o({value:a[3],size:r}),new o({value:a[4],size:t})],e.stops=[new o({value:s[0],size:l.getSize(u,s[0])}),new o({value:s[1],size:l.getSize(u,s[1])}),new o({value:s[2],size:l.getSize(u,s[2])}),new o({value:s[3],size:l.getSize(u,s[3])}),new o({value:s[4],size:l.getSize(u,s[4])})]}async function T(e,i,a,s,o){const l=e.find((e=>"width-and-depth"!==e.axis&&!e.target)),n="number"==typeof l?.minSize?l?.minSize:null,t="number"==typeof l?.maxSize?l?.maxSize:null;if(null!=l?.minDataValue&&null!=n&&null!=t)if(s)if("above-and-below"===s){l.minDataValue=null,l.maxDataValue=null,l.minSize=null,l.maxSize=null;const e=r.createStopValuesForAboveBelow(a,o),s=r.clampAboveAndBelowStopValues(e,a);await E(l,[n,t],e,s),i.stops.forEach(((e,i)=>e.value=s[i]))}else{const{minDataValue:e,maxDataValue:a}=l,s=r.createDefaultStopValues(e,a,5);i.stops.forEach(((e,i)=>e.value=s[i])),l.minDataValue=s[0],l.maxDataValue=s[s.length-1]}else l.minDataValue=i.stops[0].value,l.maxDataValue=i.stops[i.stops.length-1].value}function B(e,i,s){const{theme:o,minValue:l,maxValue:n}=e,t=i.authoringInfo.visualVariables[0].clone(),r=s.authoringInfo.visualVariables[0].clone();if("above-and-below"===o){const e=i.visualVariable.stops;t.minSliderValue=r.minSliderValue=l??e[0].value,t.maxSliderValue=r.maxSliderValue=n??e[e.length-1].value,r.theme="above-and-below"}return new a({type:"univariate-color-size",univariateTheme:o,visualVariables:[t,r]})}async function I(e){const i=await v(e),a=await n.createVisualVariable(w(i)),{visualVariable:s,statistics:o}=a,l=await t.createVisualVariables(f(i,o)),r=l.visualVariables,u=e.layer,c=e.field?u.getField(e.field):null;return await T(r,s,o,i.theme,p.isAnyDateField(c)),{basemapId:l.basemapId,basemapTheme:l.basemapTheme,statistics:o,defaultValuesUsed:a.defaultValuesUsed,color:{visualVariable:s,colorScheme:a.colorScheme},size:{visualVariables:r,sizeScheme:l.sizeScheme},authoringInfo:B(i,a,l)}}async function C(e){return D(e)}async function D(e){const i=await h(e),{renderer:a,statistics:s,defaultValuesUsed:o}=await t.createContinuousRenderer(g(i)),l=x(i);l.statistics=s;const n=await I(l);return"above-and-below"===i.theme?S(a,n,i):O(a,n),{renderer:a,statistics:s,defaultValuesUsed:o,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?n.color:null,size:n.size,basemapId:n.basemapId,basemapTheme:n.basemapTheme}}e.createContinuousRenderer=C,e.createRenderer=D,e.createVisualVariables=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
