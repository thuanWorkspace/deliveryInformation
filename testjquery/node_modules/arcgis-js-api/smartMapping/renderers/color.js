/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../renderers/PointCloudClassBreaksRenderer","../../renderers/PointCloudRenderer","../../renderers/PointCloudRGBRenderer","../../renderers/PointCloudStretchRenderer","../../renderers/PointCloudUniqueValueRenderer","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Logger","../../core/Error","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/utils","../../renderers/visualVariables/ColorVariable","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/color"],(function(e,a,r,i,o,l,n,s,t,d,u,m,c,p,y,f,b,h,g,w,v,T,S,x,V,z,E,M,C,I,L,B){"use strict";const F="high-to-low",k=2**53-1,O=5;async function R(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new b("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new b("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&C.verifyBinningParams(e,"color-visual-variable");const a={...e};if("90-10"===a.theme)throw new b("color-visual-variable:not-supported","Only 'high-to-low', 'above-and-below', 'centered-on', 'extremes', 'above', 'below' themes are supported.");const r=e.forBinning?L.binningCapableLayerTypes:L.featureCapableLayerTypes,i=L.createLayerAdapter(a.layer,r,e.forBinning);if(!i)throw new b("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(r).join(", "));a.layer=i;const o=null!=a.signal?{signal:a.signal}:null;await i.load(o);if("mesh"!==i.geometryType&&a.worldScale&&(!a.view||"3d"!==a.view.type))throw new b("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true");const l=await I.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),n=E.verifyBasicFieldValidity(i,l,"color-visual-variable:invalid-parameters");if(n)throw n;return a}async function q(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new b("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new b("color-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&C.verifyBinningParams(e,"color-continuous-renderer");const a={...e};a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled??(a.defaultSymbolEnabled=!0);const r=e.forBinning?L.binningCapableLayerTypes:L.featureCapableLayerTypes,i=L.createLayerAdapter(a.layer,r,e.forBinning);if(!i)throw new b("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(r).join(", "));a.layer=i;const o=null!=a.signal?{signal:a.signal}:null;await i.load(o);const l=i.geometryType;if(a.outlineOptimizationEnabled="polygon"===l&&a.outlineOptimizationEnabled,a.sizeOptimizationEnabled=("point"===l||"multipoint"===l||"polyline"===l)&&a.sizeOptimizationEnabled,"mesh"===l)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==l)throw new b("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(a.symbolType.includes("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new b("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const n=await I.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),s=E.verifyBasicFieldValidity(i,n,"color-continuous-renderer:invalid-parameters");if(s)throw s;return a}async function P(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new b("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new b("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&C.verifyBinningParams(e,"color-class-breaks-renderer");const a={...e};a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled??(a.defaultSymbolEnabled=!0),a.classificationMethod??(a.classificationMethod="equal-interval"),a.normalizationType=I.getNormalizationType(a);const r=e.forBinning?L.binningCapableLayerTypes:L.featureCapableLayerTypes,i=L.createLayerAdapter(a.layer,r,e.forBinning);if(!i)throw new b("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(r).join(", "));a.layer=i;if(!(null!=a.minValue&&null!=a.maxValue)&&(null!=a.minValue||null!=a.maxValue))throw new b("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const o=null!=a.signal?{signal:a.signal}:null;await i.load(o);const l=i.geometryType;if(a.outlineOptimizationEnabled="polygon"===l&&a.outlineOptimizationEnabled,"mesh"===l)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==l)throw new b("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(a.symbolType.includes("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new b("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const n=await I.getFieldsList({field:a.field,normalizationField:a.normalizationField}),s=E.verifyBasicFieldValidity(i,n,"color-class-breaks-renderer:invalid-parameters");if(s)throw s;return a}function U(e){const a={...e};delete a.basemap,delete a.colorScheme,delete a.legendOptions,delete a.symbolType,delete a.defaultSymbolEnabled,delete a.colorMixMode,delete a.edgesType;const r=a;return r.analyzeData=!(null!=a.minValue&&null!=a.maxValue),r}async function A(e){if(!e?.layer)throw new b("color-point-cloud-true-color-renderer:missing-parameters","'layer' parameter is required");const a={...e,layer:e.layer},r=[L.LayerType.PointCloudLayer],i=L.createLayerAdapter(a.layer,r);if(!i)throw new b("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(r).join(", "));if(a.layer=i,a.density=a.density||25,a.size=a.size||"100%",!E.isValidPointSize(a.size))throw new b("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");const o=null!=a.signal?{signal:a.signal}:null;return await i.load(o),a}async function D(e){if(!e?.layer||!e.field)throw new b("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required");const a=e.field.toLowerCase();if("intensity"!==a&&"elevation"!==a)throw new b("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'");const r={...e,layer:e.layer,field:e.field},i=[L.LayerType.PointCloudLayer],o=L.createLayerAdapter(r.layer,i);if(!o)throw new b("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(i).join(", "));if(r.layer=o,r.density=r.density||25,r.size=r.size||"100%",!E.isValidPointSize(r.size))throw new b("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");const l=null!=r.signal?{signal:r.signal}:null;return await o.load(l),r}function j(e){const a={...e},r=!!a.symbolType?.includes("3d-volumetric");delete a.symbolType,delete a.defaultSymbolEnabled,delete a.colorMixMode,delete a.edgesType;const i=a;return i.worldScale=r,i}async function G(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new b("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");const a={...e};a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled??(a.defaultSymbolEnabled=!0);const r=L.createLayerAdapter(a.layer,L.featureCapableLayerTypes);if(!r)throw new b("color-age-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(L.featureCapableLayerTypes).join(", "));a.layer=r;const i=null!=a.signal?{signal:a.signal}:null;await r.load(i);const o=r.geometryType;if(a.outlineOptimizationEnabled="polygon"===o&&a.outlineOptimizationEnabled,a.sizeOptimizationEnabled=("point"===o||"multipoint"===o||"polyline"===o)&&a.sizeOptimizationEnabled,"mesh"===o)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else if("3d-volumetric-uniform"===a.symbolType&&"point"!==o)throw new b("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(a.symbolType.includes("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new b("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");const l=M.verifyDates(r,a.startTime,a.endTime,"color-age-renderer:invalid-parameters");if(l)throw l;if(a.unit&&!M.supportedAgeUnits.includes(a.unit))throw new b("color-age-renderer:invalid-unit",`Supported units are: ${M.supportedAgeUnits.join(", ")}`);return a}async function W(e,a){let r=e.colorScheme,i=null,o=null;const{view:l}=e,n=await E.getBasemapInfo(e.basemap,l);if(i=null!=n.basemapId?n.basemapId:null,o=null!=n.basemapTheme?n.basemapTheme:null,r)return{scheme:B.cloneScheme(r),basemapId:i,basemapTheme:o};const s=a||e.theme||F,t=B.getSchemes({theme:s,basemapTheme:o,geometryType:e.geometryType,worldScale:e.worldScale,view:l});if(t)if(i=t.basemapId,o=t.basemapTheme,e.schemeId){const a=s+"/"+i+"/"+e.schemeId;r=B.getSchemeById({id:a,geometryType:e.geometryType})}else r=t.primaryScheme;return{scheme:r,basemapId:i,basemapTheme:o}}async function $(e,a){const r=a.layer,i=await W({basemap:a.basemap,colorScheme:a.colorScheme,geometryType:r.geometryType,schemeId:"elevation"===a.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"}),o=i.scheme;if(!o)throw new b("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme");const l=E.createColors(o.colors,O);if(l.length<O)throw new b("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors");const n=E.getDefaultDataRange(e,!1,!0),s=n?E.createDefaultStopValues(n[0],n[1],5):E.createStopValues(e);return{stops:T.createColorStops({values:s,isDate:!1,colors:l,labelIndexes:[0,2,4]}),basemapId:i.basemapId,basemapTheme:i.basemapTheme,statistics:e,defaultValuesUsed:!!n,colorScheme:B.cloneScheme(o)}}async function H(e,a,r,i,o){const{field:l,theme:n}=e,s=await W({basemap:e.basemap,theme:e.theme,geometryType:i,colorScheme:e.colorScheme,worldScale:e.worldScale,view:e.view}),t=s.scheme;if(!t)throw new b("color-visual-variable:insufficient-info","Unable to find color scheme");const d=E.createColors(t.colors,O);if(d.length<O)throw new b("color-visual-variable:insufficient-info","Color scheme does not have enough colors");const u=t.id.includes("seq-"),m=E.getDataRange(a,r,n,o,"90-10"!==n),c=E.createDataValues(m,a,n,u),p=E.createColors(d,O),y=new S({field:l,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationField:e.normalizationField,stops:c.map(((e,a)=>({value:e,color:p[a]}))),legendOptions:e.legendOptions}),f=new v({type:"color",minSliderValue:null!=e.minValue?e.minValue:a.min,maxSliderValue:null!=e.maxValue?e.maxValue:a.max,theme:t.theme}),h=new w({visualVariables:[f]});return{basemapId:s.basemapId,basemapTheme:s.basemapTheme,visualVariable:y,statistics:a,defaultValuesUsed:m.defaultValuesUsed,colorScheme:B.cloneScheme(t),authoringInfo:h}}async function N(e,a,r,i,o,l,s){const t=await h.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),{field:d,defaultSymbolEnabled:u}=s,m=B.cloneScheme(e.colorScheme),c=a?.opacity,p=[e.visualVariable.clone()];a?.visualVariables?.length&&p.push(...a.visualVariables.map((e=>e.clone()))),r?.minSize&&p.push(r.minSize);return{renderer:new n({classBreakInfos:[{minValue:-k,maxValue:k,symbol:E.createSymbol(l,{type:s.symbolType,color:m.noDataColor,size:E.getSymbolSizeFromScheme(m,l),outline:E.getSymbolOutlineFromScheme(m,l,c),meshInfo:{colorMixMode:s.colorMixMode,edgesType:s.edgesType}})}],defaultLabel:u?t.other:null,defaultSymbol:u?E.createSymbol(l,{type:s.symbolType,color:m.noDataColor,size:E.getSymbolSizeFromScheme(m,l),outline:E.getSymbolOutlineFromScheme(m,l,c),meshInfo:{colorMixMode:s.colorMixMode,edgesType:s.edgesType}}):null,field:d,normalizationType:i,normalizationField:o,valueExpression:s.valueExpression,valueExpressionTitle:s.valueExpressionTitle,visualVariables:p,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariable:e.visualVariable.clone(),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:B.cloneScheme(e.colorScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}}async function _(e){const a=await R(e),{view:r,field:i,valueExpression:o,minValue:l,maxValue:n,layer:s,normalizationField:t,signal:d,statistics:u}=a,m=t?"field":void 0,[c,p]=await Promise.all([u??E.getSummaryStatistics({layer:s,field:i,valueExpression:o,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:m,normalizationField:t,minValue:l,maxValue:n,view:r,signal:d}),"90-10"===a.theme?E.getClassBreaks({layer:s,field:i,normalizationField:t,valueExpression:o,classificationMethod:"quantile",minValue:l,maxValue:n,view:r,numClasses:10,signal:d}):null]),y=s,f=i&&"function"!=typeof i?y.getField(i):null;return H(a,c,p?.result,y.geometryType,I.isAnyDateField(f))}function J(e,a){const r=e.colorsForClassBreaks;let i;if(r&&r.length>0&&(r.some((e=>(e.numClasses===a&&(i=e.colors),!!i))),!i)){const e=r[r.length-1],o=a-e.numClasses;if(o>0){const a=e.colors[e.numClasses-1];i=e.colors.splice(0);for(let e=1;e<=o;e++)i.push(a)}}return i&&(i=E.createColors(i,i.length)),i}async function K(e,a){const r=await h.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),i=e.layer,o=e.defaultSymbolEnabled,l=i.geometryType,s=e.classificationMethod,t="standard-deviation"===s,d=await W({basemap:e.basemap,geometryType:l,theme:t?"above-and-below":null,colorScheme:e.colorScheme,worldScale:!!e.symbolType?.includes("3d-volumetric"),view:e.view}),u=d.scheme,{result:m,outlineResult:c}=a,p=m.classBreakInfos,y=e.normalizationType;if(!u)throw new b("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");const f=J(u,p.length);if(!f||f.length!==p.length)throw new b("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");const g=c?.opacity,v=new n({classBreakInfos:p.map(((a,r)=>({minValue:a.minValue,maxValue:a.maxValue,symbol:E.createSymbol(l,{type:e.symbolType,color:f[r],size:E.getSymbolSizeFromScheme(u,l),outline:E.getSymbolOutlineFromScheme(u,l,g),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}}),label:a.label}))),defaultLabel:o?r.other:null,defaultSymbol:o?E.createSymbol(l,{type:e.symbolType,color:u.noDataColor,size:E.getSymbolSizeFromScheme(u,l),outline:E.getSymbolOutlineFromScheme(u,l,g),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:y,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===y?m.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new w({type:"class-breaks-color",classificationMethod:s,standardDeviationInterval:e.standardDeviationInterval})});return t||T.setLabelsForClassBreaks({classBreakInfos:v.classBreakInfos,classificationMethod:s,normalizationType:y,round:!0}),c?.visualVariables?.length&&(v.visualVariables=c.visualVariables.map((e=>e.clone()))),{renderer:v,colorScheme:B.cloneScheme(u),classBreaksResult:m,defaultValuesUsed:a.defaultValuesUsed,basemapId:d.basemapId,basemapTheme:d.basemapTheme}}async function Q(e){const a=await q(e),{layer:r,view:i,signal:o}=a,[l,n,s]=await Promise.all([_(j(a)),a.outlineOptimizationEnabled?V({layer:r,view:i,signal:o}).catch(E.errorCallback):null,a.sizeOptimizationEnabled?z({layer:r,view:i,signal:o}).catch(E.errorCallback):null]),t=a.normalizationField;return N(l,n,s,t?"field":void 0,t,r.geometryType,a)}async function X(e){const a=await P(e);return K(a,await E.getClassBreaks(U(a),a.outlineOptimizationEnabled))}function Y(e){return A(e).then((e=>({renderer:new i({field:"RGB",pointsPerInch:e.density,pointSizeAlgorithm:E.getPointSizeAlgorithm(e.size)})})))}async function Z(e){const a=await D(e),r=a.statistics??await E.getSummaryStatistics({layer:a.layer,field:a.field,signal:a.signal}),i=await $(r,a);return{renderer:new o({field:a.field,pointsPerInch:a.density,pointSizeAlgorithm:E.getPointSizeAlgorithm(a.size),stops:i.stops}),basemapId:i.basemapId,basemapTheme:i.basemapTheme,statistics:i.statistics,defaultValuesUsed:i.defaultValuesUsed,colorScheme:i.colorScheme}}async function ee(e){const a=await h.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),r=await G(e),{defaultSymbolEnabled:i,view:o,startTime:l,endTime:n,symbolType:s,colorMixMode:t,edgesType:d,minValue:u,maxValue:m,signal:c}=r,p=r.layer,[y,f,b]=await Promise.all([r.unit?{unit:r.unit,statistics:null}:x({view:o,layer:p,startTime:l,endTime:n,minValue:u,maxValue:m,signal:c}),r.outlineOptimizationEnabled?V({layer:p,view:o,signal:c}).catch(E.errorCallback):null,r.sizeOptimizationEnabled?z({layer:p,view:o,signal:c}).catch(E.errorCallback):null]),{unit:w,statistics:v}=y,T=M.getAgeExpressions({layer:p,startTime:l,endTime:n,unit:w}).valueExpression,S=g.substitute(a[`ageInfo_${w}`],{unit:w,startTime:E.formatDate(l,w,p,o),endTime:E.formatDate(n,w,p,o)}),C=await _(j({layer:p,basemap:r.basemap,valueExpression:T,symbolType:s,statistics:v,legendOptions:{title:S},colorScheme:r.colorScheme,theme:r.theme,view:o,minValue:r.minValue,maxValue:r.maxValue,signal:c})),I={layer:p,valueExpression:T,defaultSymbolEnabled:i,symbolType:s,colorMixMode:t,edgesType:d},L=await N(C,f,b,null,null,p.geometryType,I),B=L.renderer.authoringInfo?.visualVariables;return B?.forEach((e=>E.updateAgeRendererAuthoringInfoVV(e,l,n,w))),{...L,unit:w}}e.createAgeRenderer=ee,e.createClassBreaksRenderer=X,e.createContinuousRenderer=Q,e.createPCContinuousRenderer=Z,e.createPCTrueColorRenderer=Y,e.createVisualVariable=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
