/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../intl/messages","../heuristics/clusterMinSize","./support/utils","../support/clusterUtils","../../views/2d/layers/support/clusterUtils"],(function(e,t,s,r,n,a,i){"use strict";async function l(e){const{layer:s,renderer:r,view:n}=e;await Promise.all([s.load(),n.when()]);const a=r||s.renderer;if(!i.isClusterCompatibleRenderer(a))throw new t("clusters-label-schemes:invalid-parameters","'renderer' is not valid");return{layer:s,renderer:a,view:n}}function o(e,t,s){const r="unique-value"===e.type?e.uniqueValueInfos??[]:[];return a.getPredominantTypeExpression(r,t,s)}async function c(e){const{renderer:t,view:s,statInfo:i}=e,l=i?.statisticType,c=i?a.getClusterField(i.attributeInfo,l):a.clusterCountField,u="type"===l?o(t,c,e.noneValueLabel):n.createNumericLabelExpression(c),d=n.createLabelClass(u);return{name:i?`clusters-${l}-${a.getClusterFieldHash(c,l)}`:"clusters-count",labelingInfo:[d],clusterMinSize:await r(d.symbol,s),fieldName:c}}function u(e){const t=new Map;for(const s of e)"size"===s.attributeInfo.vvType?t.set(s.statisticHash,s):t.has(s.statisticHash)||t.set(s.statisticHash,s);return[...t.values()]}async function d(e){const[{renderer:i,layer:o,view:d},f]=await Promise.all([l(e),s.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")]),p=f.clusters.predominantNoneValue;if(!i)return null;let m=null;const g=[];if(e.field){const s=n.getAggregateFieldInfo(e.field,o);if(!s)throw new t("clusters-label-schemes:invalid-parameters","'field' is not a valid aggregate field");const{name:a}=s,l=n.createLabelExpressionForAggregateField(o,i,s,p),c=n.createLabelClass(l);return m={name:`clusters-${a}`,labelingInfo:[c],clusterMinSize:await r(c.symbol,d),fieldName:a},{primaryScheme:m,secondarySchemes:g}}const y=u(a.getStatisticInfos(o,i,!1));for(const t of y){const e=await c({renderer:i,view:d,statInfo:t,noneValueLabel:p});"size"===t.attributeInfo.vvType?m=e:g.push(e)}const b=await c({renderer:i,view:d});return m?g.unshift(b):m=b,{primaryScheme:m,secondarySchemes:g}}e.getLabelSchemes=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
