/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/support/rasterFunctions/stretchUtils","./RasterLayerAdapter"],(function(t,e,r,a,s,i,o,n,l,c){"use strict";let h=class extends c{async generateRasterInfo(t){const{layer:e}=this,r=t?.rasterFunction;if("imagery-tile"===e.type&&r)try{return e.generateRasterInfo(r,{signal:t?.signal})}catch{return e.rasterInfo}return this.rasterInfo}async estimateStatisticsHistograms(t){const{layer:r}=this,a=r.multidimensionalDefinition?.[0]?.variableName??"",s=`${r.rasterFunction?.functionName??"default"}${a}`,i=this._statsCache.get(s);if(i)return i;const{raster:o}=r,{extent:n,width:c,height:h}=this._getSamplePixelBlockDescriptor(o.rasterInfo),{pixelBlock:m}=await r.fetchPixels(n,c,h,t);if(null==m)throw new e("raster-layer-adapter","Unable to estimate histograms");const p=l.estimateStatisticsHistograms(m);return p&&this._statsCache.put(s,p),p}supportsMultidirectionalHillshade(){return!0}load(t){return this.addResolvingPromise(this.layer.load(t).then((()=>this.rasterInfo=this.layer.raster.rasterInfo))),Promise.resolve(this)}_getSamplePixelBlockDescriptor(t,e=1e3){const{pyramidScalingFactor:r,maximumPyramidLevel:a}=t.storageInfo;let{extent:s,width:i,height:o,pixelSize:l}=t,c=Math.ceil(Math.log(Math.max(i,o)/e)/Math.log(r))-1,h=0,m=0;if(c<=a){const t=r**c;i=Math.floor(i/t),o=Math.floor(o/t)}else c=0,i=Math.min(i,e),o=Math.min(o,e),h=Math.max(Math.floor(i/2-500),0),m=Math.max(Math.floor(o/2-500),0),s=new n({xmin:s.xmin+h*l.x,xmax:Math.min(s.xmax,s.xmin+h*l.x*e),ymin:s.ymin+m*l.y,ymax:Math.min(s.ymax,s.ymin+m*l.y*e)});return{extent:s,width:i,height:o,origin:{x:h,y:m}}}};t.__decorate([r.property()],h.prototype,"layer",void 0),h=t.__decorate([o.subclass("esri.smartMapping.support.adapters.ImageryTileLayerAdapter")],h);return h}));
