/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../../core/has","../../../../layers/support/CodedValueDomain","../../../../layers/support/Domain","../../../../layers/support/InheritedDomain","../../../../layers/support/RangeDomain","../../../../layers/support/Field","../../../../layers/support/fieldUtils","../../../../rest/support/StatisticDefinition","../../../statistics/support/predominanceUtils","../../../statistics/support/utils","../../utils","../../../../statistics/utils"],(function(e,t,n,l,i,a,o,r,s,u,c,m,d,f,p){"use strict";const g=/_value$/i,F=Math.LOG10E,y={SECOND:1e3,MINUTE:6e4,HOUR:36e5},h=10;function S(e){return e.map((e=>e.toJSON()))}function v(e,t){const n=[],l=e.layer,i="featureReduction"in l?l.featureReduction:null,a="binning"===i?.type,o=null!=i&&"fields"in i?i.fields?.map((e=>e.name?.toLowerCase())).filter(Boolean):[];if(!a||!t)return n;for(const r of t)o.includes(r.toLowerCase())||n.push(r);return n}function x(e,t,n){const l=[];if(t)for(const i of t){const t=e.getField(i);t&&n&&"availableFields"in n&&!n.availableFields?.includes(t.name)&&l.push(t.name)}return l}function T(e,t){const n=e&&e.features;if(0===n?.length)return{avg:null,count:0,max:null,median:null,min:null,nullcount:0,stddev:null,sum:null,variance:null};const l=n?.[0]?.attributes,i={};for(const a in l)i[a.replace(g,"").toLowerCase()]=l[a];return null!=i.totalcount&&i.totalcount>=i.count&&(i.nullcount=i.totalcount-i.count),delete i.totalcount,i.min===i.max&&null!=i.min&&null==i.stddev&&(i.stddev=i.variance=0),t&&(["min","max","avg","stddev","sum","variance"].forEach((e=>{null!=i[e]&&(i[e]=Math.ceil(i[e]))})),i.min===i.max&&null!=i.min&&(i.avg=i.min,i.stddev=i.variance=0)),i}function E(e){const t=[],n=e.classBreaks,l=n[0].minValue,i=n[n.length-1].maxValue;n.forEach((e=>{t.push([e.minValue,e.maxValue])}));const a={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:l,max:i,intervals:t,sqlExpr:w(a),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function w(e){const{field:t,normalizationType:n,normalizationField:l,normalizationTotal:i,layer:a}=e,o=f.isIntegerField(a,t);let r=t;return"percent-of-total"===n?r=`((${o?f.castIntegerFieldToFloat(t):t} / ${i}) * 100)`:"log"===n?r=`(log(${t}) * ${F})`:"field"===n?r=`(${o?f.castIntegerFieldToFloat(t):t} / ${l})`:"natural-log"===n?r=`(log(${o?f.castIntegerFieldToFloat(t):t}))`:"square-root"===n&&(r=`(power(${o?f.castIntegerFieldToFloat(t):t}, 0.5))`),r}function V(e,t){let n;if(t=t.toLowerCase(),e)for(const l in e)if(l.toLowerCase()!==t){n=e[l];break}return n}function C(e,t){let n;if(t=t.toLowerCase(),e)for(const l in e)if(l.toLowerCase()===t){n=e[l];break}return n}function z(e,t,n,l,i){const a={},o="countOFExpr";e&&e.features&&e.features.forEach((e=>{const t=e.attributes,n=V(t,o),l=C(t,o);null!=n&&null!=l&&0!==n&&(a[n]=l)}));const r=[];return p.getEqualIntervalBins(t,n,l).forEach(((e,t)=>{const n=(t+1).toString();r.push({minValue:e[0],maxValue:e[1],count:a.hasOwnProperty(n)?a[n]:0})})),{bins:r,minValue:t,maxValue:n,normalizationTotal:i}}function $(e,t){const l=e&&e.features,{field:i,field2:a,field3:o,fieldDelimiter:r,layer:s,view:u,signal:c,labels:m}=t,d=`countOF${!(!i||!a)?"Expr":i||"Expr"}`,f={};let g=!1;if(l.forEach((e=>{const t=e.attributes,n=C(t,d);let l=i?C(t,i):V(t,d),s=a?C(t,a):null,u=o?C(t,o):null;null===l&&0===n&&(g=!0),(null==l||"string"==typeof l&&""===l.trim())&&(l=null),a&&(null==s||"string"==typeof s&&""===s.trim())&&(s=null),o&&(null==u||"string"==typeof u&&""===u.trim())&&(u=null);let c=l;a&&(c=`${p.processNullValue(c)}${r}${p.processNullValue(s)}`,o&&(c=`${c}${r}${p.processNullValue(u)}`)),null==f[c]?f[c]={count:n,data:c}:f[c].count=f[c].count+n})),i&&g){const e=i+" is NULL";return s.queryFeatureCount({whereClause:e,view:u,signal:c}).then((e=>(e=e||0,f.null.count=f.null.count+e,q(f,m)))).catch((()=>(n.throwIfAborted(c),q(f,m))))}return Promise.resolve(q(f,m))}function q(e,t){if(t)for(const n in e)e[n].label=t[n];return{count:e}}async function I(e,t,n){const l=e?n.getField(e):null,a=l?n.getFieldDomain(l.name):null;if(a)return a;const{uniqueValueInfos:o}=await n.uniqueValues({field:e,sqlWhere:t.sqlWhere,features:t.features,useFeaturesInView:t.useFeaturesInView,view:t.view,signal:t.signal}),r=o.map((e=>({code:e.value})));return new i({codedValues:r})}async function b(e,t){if(!e.returnAllCodedValues)return[];const{field:n,field2:l,field3:i}=e;if(n&&!l){const e=n?t.getField(n):null,l=e?t.getFieldDomain(e.name):null;return l?[l]:[]}const a=[];return n&&(a.push(I(n,e,t)),l&&(a.push(I(l,e,t)),i&&a.push(I(i,e,t)))),Promise.all(a)}function O(e,t){return f.getDateDiffSQL(e,new Date(0),t,"milliseconds").sqlExpression}function L(e,t){return`EXTRACT(${t} FROM ${e}) * ${y[t]}`}function D(e){if(!e)return null;const t=["HOUR","MINUTE","SECOND"];return f.castIntegerFieldToFloat(t.map((t=>`(${L(e,t)})`)).join(" + "))}function N(e){return{viewingMode:"2d"===e.type?"map":e.viewingMode,scale:e.scale,spatialReference:e.spatialReference?.toJSON()}}function R(e,t){const n=new Set(e.map((e=>e.value))),l=t.filter((e=>!n.has(e)));for(const i of l)e.push({value:i,count:0});e.sort(((e,n)=>t.indexOf(e.value)-t.indexOf(n.value)));for(const i of e)i.value===m.noDominantCategoryField&&(i.value=null);return{predominantCategoryInfos:e}}function Q(e){const n="featureReduction"in e?e.featureReduction:null;return((null!=n&&"fields"in n?n.fields:null)??[]).map((t=>{const n=U(t,e.fieldsIndex);return n?new s({type:n,name:t.name,alias:t.alias}):null})).filter(t.isSome)}function U(e,t){switch(e.statisticType){case"avg":case"avg_angle":return"double";case"count":return"integer";case"min":case"max":case"sum":return e.onStatisticField?t.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?null:"double":null;case"mode":return e.onStatisticField?t.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?"string":"double":null;default:return null}}function B(e,t){return f.isAnyDateField(t)?O(e,t?.name):u.isTimeOnlyField(t)?D(t?.name):null}function W(e,t,n){const{field:l,normalizationType:i,normalizationField:a,normalizationTotal:o,minValue:r,maxValue:s,filter:m}=t,f=e.supportsSQLExpression?B(e,n)||t.sqlExpression:null,g=w({field:l,normalizationType:i,normalizationField:a,normalizationTotal:o,layer:e}),F=f||g,y=F?d.getRangeExpr(F,r,s):null,h=d.getSQLFilterForNormalization({field:l,normalizationField:a,normalizationType:i}),S=d.mergeWhereClauses(t.sqlWhere,h),v=d.mergeWhereClauses(S,y),x=p.isNullCountSupported({normalizationField:a,normalizationType:i,sqlExpression:f,supportsSQLExpression:e.supportsSQLExpression,minValue:r,maxValue:s}),T=u.isStringField(e.getField(l??void 0)),E=p.statisticTypes.filter((e=>"nullcount"===e?x:!T||"count"===e)),V=e.createQuery();return V.where=d.mergeWhereClauses(V.where,v),V.sqlFormat=f?"standard":null,V.outStatistics=E.map((t=>{const n=new c;let l=null,i=null,a=`${t}_value`;return"variance"===t?(l="var",i=F):"nullcount"===t?(l="count",i=e.objectIdField,a="totalcount_value"):"median"===t?(l="percentile-continuous",i=F,n.statisticParameters={value:.5}):(l=t,i=F),n.statisticType=l,n.onStatisticField=i,n.outStatisticFieldName=a,n})),M(V,m),V}function M(e,t){t&&(e.geometry=t.geometry,e.spatialRelationship=t.spatialRelationship)}function P(e,t){const{field:n,field2:l,field3:i,sqlExpression:a}=t,o=!(!n||!l),r=e.createQuery();return r.where=d.mergeWhereClauses(r.where,t.sqlWhere),r.sqlFormat=a?"standard":null,r.outStatistics=[A(o?null:n,o?"1":a)].filter(Boolean),r.groupByFieldsForStatistics=[n||a,l,i].filter(Boolean),M(r,t.filter),r}function A(e,t){const n="countOF"+(e||"Expr"),l=new c;return l.statisticType="count",l.onStatisticField=t?"1":e,l.outStatisticFieldName=n,l}function _(e,t,n,l=h,i,a,o){const{min:r,max:s,normTotal:u,excludeZerosExpr:c}=t,m=t.intervals||p.getEqualIntervalBins(r,s,l),d=t.sqlExpr||n;return j(e,m,d,c,i,a,o).then((e=>({bins:e.map(((e,t)=>({minValue:m[t][0],maxValue:m[t][1],count:"fulfilled"===e.status?e.value:0}))),minValue:r,maxValue:s,normalizationTotal:u})))}function j(e,t,n,l,i,a,o){const r=[],s=t.length;for(let u=0;u<s;u++){const e=d.mergeWhereClauses(l,d.mergeWhereClauses(n+" >= "+t[u][0],null!==t[u][1]?n+(u===s-1?" <= ":" < ")+t[u][1]:""));r.push(e)}return Promise.allSettled(r.map((t=>e.queryFeatureCount({whereClause:t,view:i,filter:a,signal:o}))))}e.defaultNumBins=h,e.ensureFeaturesJSON=S,e.generateBinParams=E,e.getAggregateFieldType=U,e.getBins=_,e.getDomainsForFields=b,e.getFeatureReductionFields=Q,e.getFieldExpr=w,e.getHistogramFromFeatureSet=z,e.getMissingFields=x,e.getMissingFieldsForBinning=v,e.getPredominantCategoriesFromUVInfos=R,e.getSQLExpressionForDateOrTimeField=B,e.getSummaryStatisticsFromFeatureSet=T,e.getSummaryStatsQuery=W,e.getUVQuery=P,e.getUniqueValuesFromFeatureSet=$,e.getViewInfoParams=N,e.msForTimeOnlyFieldSQL=D,e.msSinceUnixEpochSQL=O,e.updateQueryWithFeatureFilter=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
