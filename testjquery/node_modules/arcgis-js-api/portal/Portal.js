/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../config","../kernel","../request","../core/Error","../core/JSONSupport","../core/Loadable","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/Extent","../intl/locale","./portalDefault","./PortalGroup","./PortalQueryParams","./PortalQueryResult","./PortalUser","../support/apiKeyUtils"],(function(e,t,r,o,s,a,i,p,l,u,n,d,c,y,h,_,m,v,f,S,g,P,G,b){"use strict";const O=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var B;let D;const w={PortalGroup:()=>Promise.resolve({default:S}),PortalItem:()=>new Promise(((t,r)=>e(["./PortalItem"],(e=>t(O(e))),r))),PortalUser:()=>Promise.resolve({default:G})};let U=B=class extends(i.JSONSupportMixin(p)){constructor(e){super(e),this._esriIdCredentialCreateHandle=null,this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.basemapGalleryGroupQuery3D=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=r.portalUrl,this.urlKey=null,this.user=null,this.use3dBasemaps=!0,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(e){return"string"==typeof e?{url:e}:e}destroy(){C.unregister(this),this.defaultBasemap=l.destroyMaybe(this.defaultBasemap),this.defaultDevBasemap=l.destroyMaybe(this.defaultDevBasemap),this.defaultVectorBasemap=l.destroyMaybe(this.defaultVectorBasemap),this._esriIdCredentialCreateHandle=l.removeMaybe(this._esriIdCredentialCreateHandle)}readAuthorizedCrossOriginDomains(e){if(e)for(const t of e)r.request.trustedServers.includes(t)||r.request.trustedServers.push(t);return e}readDefaultBasemap(e){return this._readBasemap(e)}readDefaultDevBasemap(e){return this._readBasemap(e)}readDefaultVectorBasemap(e){return this._readBasemap(e)}get extraQuery(){const e=this.user?.orgId,t=!e||this.canSearchPublic;return this.id&&!t?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get itemPageUrl(){return this.url?`${this.url}/home/item.html`:null}get restUrl(){let e=this.url;if(e){const t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}get thumbnailUrl(){const e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null}readUrlKey(e){return e?e.toLowerCase():e}readUser(e){let t=null;return e&&(t=G.fromJSON(e),t.portal=this),t}load(t){const r=new Promise(((t,r)=>e(["../Basemap"],(e=>t(O(e))),r))).then((({default:e})=>{u.throwIfAborted(t),D=e})).then((()=>this.sourceJSON?this.sourceJSON:this.fetchSelf(this.authMode,!1,t))).then((e=>{if(o.id){const e=o.id;this.credential=e.findCredential(this.restUrl),this.credential||this.authMode!==B.AUTH_MODE_AUTO||(this._esriIdCredentialCreateHandle?.remove(),this._esriIdCredentialCreateHandle=e.on("credential-create",I(new WeakRef(this))),C.register(this,this._esriIdCredentialCreateHandle,this))}this.sourceJSON=e,this.read(e)}));return this.addResolvingPromise(r),Promise.resolve(this)}async createElevationLayers(){await this.load();const t=this._getHelperService("defaultElevationLayers"),r=(await new Promise(((t,r)=>e(["../layers/ElevationLayer"],(e=>t(O(e))),r)))).default;return t?t.map((e=>new r({id:e.id,url:e.url}))):[]}async fetchBasemaps(e,t){const r=await this._fetchBasemaps(e,t);if(!0===t?.include3d&&!1!==this.use3dBasemaps){const o=await this._fetchBasemaps3D(e,t);r.unshift(...o)}return r}fetchCategorySchema(e){return this.hasCategorySchema?this.request(this.restUrl+"/portals/self/categorySchema",e).then((e=>e.categorySchema)):u.isAborted(e)?Promise.reject(u.createAbortError()):Promise.resolve([])}fetchFeaturedGroups(e){const t=this.featuredGroups,r=new g;if(r.num=100,r.sortField="title",t&&t.length){const o=[];for(const e of t)o.push(`(title:"${e.title}" AND owner:${e.owner})`);return r.query=o.join(" OR "),this.queryGroups(r,e).then((e=>e.results))}return u.isAborted(e)?Promise.reject(u.createAbortError()):Promise.resolve([])}fetchRegions(e){const t=this.user?.culture||this.culture||v.getLocale();return this.request(this.restUrl+"/portals/regions",{...e,query:{culture:t}})}fetchSettings(e){const t=this.user?.culture||this.culture||v.getLocale();return this.request(this.restUrl+"/portals/self/settings",{...e,query:{culture:t}})}static getDefault(){return f.ensureDefaultPortalInstance((()=>new B))}queryGroups(e,t){return this.queryPortal("/community/groups",e,"PortalGroup",t)}queryItems(e,t){return this.queryPortal("/search",e,"PortalItem",t)}queryUsers(e,t){return e.sortField||(e.sortField="username"),this.queryPortal("/community/users",e,"PortalUser",t)}fetchSelf(e=this.authMode,t=!1,r){const o=this.restUrl+"/portals/self",s={authMode:e,query:{culture:v.getLocale().toLowerCase()},...r};return"auto"===s.authMode&&(s.authMode="no-prompt"),t&&(s.query.default=!0),this.request(o,s)}queryPortal(e,t,r,o){const s=d.ensureType(g,t),a=t=>this.request(this.restUrl+e,{...s.toRequestOptions(this),...o}).then((e=>{const r=s.clone();return r.start=e.nextStart,new P({nextQueryParams:r,queryParams:s,total:e.total,results:B._resultsToTypedArray(t,{portal:this},e,o)})})).then((e=>Promise.all(e.results.map((t=>"function"==typeof t.when?t.when():e))).then((()=>e),(t=>(u.throwIfAbortError(t),e)))));return r&&w[r]?w[r]().then((({default:e})=>(u.throwIfAborted(o),a(e)))):a()}signIn(){if(this.authMode===B.AUTH_MODE_ANONYMOUS)return Promise.reject(new a("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if("failed"===this.loadStatus)return Promise.reject(this.loadError);const e=e=>Promise.resolve().then((()=>"not-loaded"===this.loadStatus?(e||(this.authMode="immediate"),this.load().then((()=>null))):"loading"===this.loadStatus?this.load().then((()=>this.credential?null:(this.credential=e,this.fetchSelf("immediate")))):this.user&&this.credential===e?null:(this.credential=e,this.fetchSelf("immediate")))).then((e=>{e&&(this.sourceJSON=e,this.read(e))}));return o.id?o.id.getCredential(this.restUrl).then((t=>e(t))):e(this.credential)}normalizeUrl(e){const t=this.credential?.token;return this._normalizeSSL(t?e+(e.includes("?")?"&":"?")+"token="+t:e)}requestToTypedArray(e,t,r){return this.request(e,t).then((e=>{const t=B._resultsToTypedArray(r,{portal:this},e);return Promise.all(t.map((t=>"function"==typeof t.when?t.when():e))).then((()=>t),(()=>t))}))}request(e,t={}){const r={f:"json",...t.query},{authMode:o=(this.authMode===B.AUTH_MODE_ANONYMOUS?"anonymous":"auto"),body:a=null,cacheBust:i=!1,method:p="auto",responseType:l="json",signal:u}=t,n={authMode:o,body:a,cacheBust:i,method:p,query:r,responseType:l,timeout:0,signal:u};return s(this._normalizeSSL(e),n).then((e=>e.data))}toJSON(){throw new a("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new B({sourceJSON:e})}_getHelperService(e){const t=this.helperServices&&this.helperServices[e];if(!t)throw new a("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return t}async _fetchBasemaps(e,t){const o=new g;o.query=e||(r.apiKey&&b.supportsApiKey(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),o.disableExtraQuery=!0;const s=await this.queryGroups(o,t);if(!s.total)return[];const a=s.results[0];o.num=100,o.query='type:"Web Map" -type:"Web Application"',o.sortField=a.sortField||"name",o.sortOrder=a.sortOrder||"desc";const i=await a.queryItems(o,t);if(!i.total)return[];return i.results.filter((e=>"Web Map"===e.type)).map((e=>new D({portalItem:e})))}async _fetchBasemaps3D(e,t){const r=e||this.basemapGalleryGroupQuery3D;if(!r)return[];const o=new g({query:r,disableExtraQuery:!0}),s=await this.queryGroups(o,t);if(!s.total)return[];const a=s.results[0];o.num=100,o.query='type:"Web Scene"',o.sortField=a.sortField||"name",o.sortOrder=a.sortOrder||"desc";const i=await a.queryItems(o,t);if(!i.total)return[];return i.results.filter((e=>"Web Scene"===e.type)).map((e=>new D({portalItem:e})))}_normalizeSSL(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")}_readBasemap(e){if(e){const t=D.fromJSON(e);return t.portalItem={portal:this},t}return null}static _resultsToTypedArray(e,t,r,o){let s=[];if(r){const a=null!=o?o.signal:null;s=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(e||t)&&(s=s.map((r=>{const o=Object.assign(e?e.fromJSON(r):r,t);return"function"==typeof o.load&&o.load(a),o})))}else s=[];return s}};U.AUTH_MODE_ANONYMOUS="anonymous",U.AUTH_MODE_AUTO="auto",U.AUTH_MODE_IMMEDIATE="immediate",t.__decorate([n.property()],U.prototype,"access",void 0),t.__decorate([n.property()],U.prototype,"allSSL",void 0),t.__decorate([n.property()],U.prototype,"authMode",void 0),t.__decorate([n.property()],U.prototype,"authorizedCrossOriginDomains",void 0),t.__decorate([h.reader("authorizedCrossOriginDomains")],U.prototype,"readAuthorizedCrossOriginDomains",null),t.__decorate([n.property()],U.prototype,"basemapGalleryGroupQuery",void 0),t.__decorate([n.property({json:{name:"3DBasemapGalleryGroupQuery"}})],U.prototype,"basemapGalleryGroupQuery3D",void 0),t.__decorate([n.property()],U.prototype,"bingKey",void 0),t.__decorate([n.property()],U.prototype,"canListApps",void 0),t.__decorate([n.property()],U.prototype,"canListData",void 0),t.__decorate([n.property()],U.prototype,"canListPreProvisionedItems",void 0),t.__decorate([n.property()],U.prototype,"canProvisionDirectPurchase",void 0),t.__decorate([n.property()],U.prototype,"canSearchPublic",void 0),t.__decorate([n.property()],U.prototype,"canShareBingPublic",void 0),t.__decorate([n.property()],U.prototype,"canSharePublic",void 0),t.__decorate([n.property()],U.prototype,"canSignInArcGIS",void 0),t.__decorate([n.property()],U.prototype,"canSignInIDP",void 0),t.__decorate([n.property()],U.prototype,"colorSetsGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"commentsEnabled",void 0),t.__decorate([n.property({type:Date})],U.prototype,"created",void 0),t.__decorate([n.property()],U.prototype,"credential",void 0),t.__decorate([n.property()],U.prototype,"culture",void 0),t.__decorate([n.property()],U.prototype,"currentVersion",void 0),t.__decorate([n.property()],U.prototype,"customBaseUrl",void 0),t.__decorate([n.property()],U.prototype,"defaultBasemap",void 0),t.__decorate([h.reader("defaultBasemap")],U.prototype,"readDefaultBasemap",null),t.__decorate([n.property()],U.prototype,"defaultDevBasemap",void 0),t.__decorate([h.reader("defaultDevBasemap")],U.prototype,"readDefaultDevBasemap",null),t.__decorate([n.property({type:m})],U.prototype,"defaultExtent",void 0),t.__decorate([n.property()],U.prototype,"defaultVectorBasemap",void 0),t.__decorate([h.reader("defaultVectorBasemap")],U.prototype,"readDefaultVectorBasemap",null),t.__decorate([n.property()],U.prototype,"description",void 0),t.__decorate([n.property()],U.prototype,"devBasemapGalleryGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"eueiEnabled",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"extraQuery",null),t.__decorate([n.property()],U.prototype,"featuredGroups",void 0),t.__decorate([n.property()],U.prototype,"featuredItemsGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"galleryTemplatesGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"livingAtlasGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"hasCategorySchema",void 0),t.__decorate([n.property()],U.prototype,"helpBase",void 0),t.__decorate([n.property()],U.prototype,"helperServices",void 0),t.__decorate([n.property()],U.prototype,"helpMap",void 0),t.__decorate([n.property()],U.prototype,"homePageFeaturedContent",void 0),t.__decorate([n.property()],U.prototype,"homePageFeaturedContentCount",void 0),t.__decorate([n.property()],U.prototype,"httpPort",void 0),t.__decorate([n.property()],U.prototype,"httpsPort",void 0),t.__decorate([n.property()],U.prototype,"id",void 0),t.__decorate([n.property()],U.prototype,"ipCntryCode",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"isOrganization",null),t.__decorate([n.property()],U.prototype,"isPortal",void 0),t.__decorate([n.property()],U.prototype,"isReadOnly",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"itemPageUrl",null),t.__decorate([n.property()],U.prototype,"layerTemplatesGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"maxTokenExpirationMinutes",void 0),t.__decorate([n.property({type:Date})],U.prototype,"modified",void 0),t.__decorate([n.property()],U.prototype,"name",void 0),t.__decorate([n.property()],U.prototype,"portalHostname",void 0),t.__decorate([n.property()],U.prototype,"portalMode",void 0),t.__decorate([n.property()],U.prototype,"portalProperties",void 0),t.__decorate([n.property()],U.prototype,"region",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"restUrl",null),t.__decorate([n.property()],U.prototype,"rotatorPanels",void 0),t.__decorate([n.property()],U.prototype,"showHomePageDescription",void 0),t.__decorate([n.property()],U.prototype,"sourceJSON",void 0),t.__decorate([n.property()],U.prototype,"staticImagesUrl",void 0),t.__decorate([n.property({json:{name:"2DStylesGroupQuery"}})],U.prototype,"stylesGroupQuery2d",void 0),t.__decorate([n.property({json:{name:"stylesGroupQuery"}})],U.prototype,"stylesGroupQuery3d",void 0),t.__decorate([n.property()],U.prototype,"supportsHostedServices",void 0),t.__decorate([n.property()],U.prototype,"symbolSetsGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"templatesGroupQuery",void 0),t.__decorate([n.property()],U.prototype,"thumbnail",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"thumbnailUrl",null),t.__decorate([n.property()],U.prototype,"units",void 0),t.__decorate([n.property()],U.prototype,"url",void 0),t.__decorate([n.property()],U.prototype,"urlKey",void 0),t.__decorate([h.reader("urlKey")],U.prototype,"readUrlKey",null),t.__decorate([n.property()],U.prototype,"user",void 0),t.__decorate([h.reader("user")],U.prototype,"readUser",null),t.__decorate([n.property()],U.prototype,"use3dBasemaps",void 0),t.__decorate([n.property()],U.prototype,"useStandardizedQuery",void 0),t.__decorate([n.property()],U.prototype,"useVectorBasemaps",void 0),t.__decorate([n.property()],U.prototype,"vectorBasemapGalleryGroupQuery",void 0),U=B=t.__decorate([_.subclass("esri.portal.Portal")],U);const Q=U,C=new FinalizationRegistry((e=>{e.remove()}));function I(e){const t=o.id;return()=>{const r=e.deref();r&&t.findCredential(r.restUrl)&&r.signIn().catch((()=>{}))}}return Q}));
