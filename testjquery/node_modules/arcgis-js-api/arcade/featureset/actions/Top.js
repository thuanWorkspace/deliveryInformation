/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared"],(function(t,e,n,s){"use strict";class i extends e{constructor(t){super(t),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._parent._getSet(t);return this._wset=new n(e._candidates.slice(0),e._known.slice(0),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===s.IdState.NotInFeatureSet)return e;const n=this._idstates[t];return n===s.IdState.InFeatureSet||n===s.IdState.NotInFeatureSet?n:e===s.IdState.InFeatureSet&&void 0===n?this._countedin<this._topnum?(this._idstates[t]=s.IdState.InFeatureSet,this._countedin++,s.IdState.InFeatureSet):(this._idstates[t]=s.IdState.NotInFeatureSet,s.IdState.NotInFeatureSet):s.IdState.Unknown}async _expandPagedSet(e,n,s,i,a){if(null===this._parent)throw new t.FeatureSetError(t.FeatureSetErrorCodes.NotImplemented);if(n>this._topnum&&(n=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){let t=e._known.length;return t>0&&"GETPAGES"===e._known[t-1]&&(e._known.length=t-1),t=e._candidates.length,t>0&&"GETPAGES"===e._candidates[t-1]&&(e._candidates.length=t-1),"success"}const r=await this._parent._expandPagedSet(e,n,s,i,a);return this._setKnownLength(e)>this._topnum&&(e._known.length=this._topnum),this._setKnownLength(e)>=this._topnum&&(e._candidates.length=0),r}async _getFeatures(t,e,s,i){const a=[],r=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,r))return await this._expandPagedSet(t,r,0,0,i),this._getFeatures(t,e,s,i);-1!==e&&void 0===this._featureCache[e]&&a.push(e);let o=0;for(let n=t._lastFetchedIndex;n<t._known.length&&(o++,o<=s&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[n]]&&(t._known[n]!==e&&a.push(t._known[n]),a.length>r)));n++);if(0===a.length)return"success";const _=new n([],a,!1,null),h=Math.min(a.length,s);await this._parent._getFeatures(_,-1,h,i);for(let n=0;n<h;n++){const t=this._parent._featureFromCache(a[n]);void 0!==t&&(this._featureCache[a[n]]=t)}return"success"}async _getFilteredSet(t,e,s,i,a){await this._ensureLoaded();const r=await this._getSet(a);return new n(r._candidates.slice(0).concat(r._known.slice(0)),[],!1,this._clonePageDefinition(r.pagesDefinition))}_refineKnowns(t,e){let n=0,i=null;const a=[];for(let r=0;r<t._candidates.length;r++){const o=this._isInFeatureSet(t._candidates[r]);if(o===s.IdState.InFeatureSet){if(t._known.push(t._candidates[r]),n+=1,null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(a.push(i),i={start:r,end:r}),t._known.length>=this._topnum)break}else if(o===s.IdState.NotInFeatureSet)null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(a.push(i),i={start:r,end:r}),n+=1;else if(o===s.IdState.Unknown)break;if(n>=e)break}null!==i&&a.push(i);for(let s=a.length-1;s>=0;s--)t._candidates.splice(a[s].start,a[s].end-a[s].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){e._featuresetFunctions.top=function(t){return new i({parentfeatureset:this,topnum:t})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}return i}));
