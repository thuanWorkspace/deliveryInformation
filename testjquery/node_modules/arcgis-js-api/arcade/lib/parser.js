/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","./comment-handler","./error-handler","./scanner","./types"],(function(t,e,r,n,s){"use strict";var i,a;function o(t,e=0){let r=t.start-t.lineStart,n=t.lineNumber;return r<0&&(r+=e,n--),{index:t.start,line:n,column:r}}function h(t){return[{index:t.range[0],...t.loc.start},{index:t.range[1],...t.loc.end}]}function c(t){return s.OperatorPrecedence[t]??0}!function(t){t[t.None=0]="None",t[t.Function=1]="Function",t[t.IfClause=2]="IfClause",t[t.ForLoop=4]="ForLoop",t[t.WhileLoop=8]="WhileLoop"}(i||(i={})),function(t){t[t.AsObject=0]="AsObject",t[t.Automatic=1]="Automatic"}(a||(a={}));class p{constructor(t,o={},h){this.delegate=h,this.hasLineTerminator=!1,this.options={tokens:"boolean"==typeof o.tokens&&o.tokens,comments:"boolean"==typeof o.comments&&o.comments,tolerant:"boolean"==typeof o.tolerant&&o.tolerant},this.options.comments&&(this.commentHandler=new e.CommentHandler),this.errorHandler=new r.ErrorHandler(this.options.tolerant),this.scanner=new n.Scanner(t,this.errorHandler),this.context={isAssignmentTarget:!1,blockContext:i.None,curlyParsingType:a.AsObject},this.rawToken={type:s.TokenType.EOF,value:"",lineNumber:this.scanner.lineNumber,lineStart:0,start:0,end:0},this.tokens=[],this.startMarker={index:0,line:this.scanner.lineNumber,column:0},this.endMarker={index:0,line:this.scanner.lineNumber,column:0},this.readNextRawToken(),this.endMarker={index:this.scanner.index,line:this.scanner.lineNumber,column:this.scanner.index-this.scanner.lineStart}}throwIfInvalidType(t,e,{validTypes:r,invalidTypes:n}){r?.some((e=>t.type===e))||n?.some((e=>t.type===e))&&this.throwError(s.ParsingErrorCodes.InvalidExpression,e)}throwError(t,e,r=this.endMarker){const{index:n,line:s,column:i}=e,a=r.index-n-1;this.errorHandler.throwError({code:t,index:n,line:s,column:i+1,len:a})}tolerateError(t,e){throw new Error("######################################### !!!")}unexpectedTokenError(t={}){const{rawToken:e}=t;let n,{code:i,data:a}=t;if(e){if(!i)switch(e.type){case s.TokenType.EOF:i=s.ParsingErrorCodes.UnexpectedEndOfScript;break;case s.TokenType.Identifier:i=s.ParsingErrorCodes.UnexpectedIdentifier;break;case s.TokenType.NumericLiteral:i=s.ParsingErrorCodes.UnexpectedNumber;break;case s.TokenType.StringLiteral:i=s.ParsingErrorCodes.UnexpectedString;break;case s.TokenType.Template:i=s.ParsingErrorCodes.UnexpectedTemplate}n=e.value.toString()}else n="ILLEGAL";i=i??s.ParsingErrorCodes.UnexpectedToken,a||(a={value:n});const o=r.formatErrorDescription(i,a);if(e){const t=e.start,r=e.lineNumber,n=e.start-e.lineStart+1;return new s.ParsingError({code:i,index:t,line:r,column:n,len:e.end-e.start-1,data:a,description:o})}const{index:h,line:c}=this.endMarker;return new s.ParsingError({code:i,index:h,line:c,column:this.endMarker.column+1,data:a,description:o})}throwUnexpectedToken(t={}){throw t.rawToken=t.rawToken??this.rawToken,this.unexpectedTokenError(t)}collectComments(t){const{commentHandler:e}=this;e&&t.length&&t.forEach((t=>{const r={type:t.multiLine?s.Syntax.BlockComment:s.Syntax.LineComment,value:this.getSourceValue(t),range:t.range,loc:t.loc};e.collectComment(r)}))}peekAhead(t){const e=()=>(this.scanner.scanComments(),this.scanner.lex()),r=this.scanner.saveState(),n=t.call(this,e);return this.scanner.restoreState(r),n}getSourceValue(t){return this.scanner.source.slice(t.start,t.end)}convertToToken(t){return{type:s.TokenNames[t.type],value:this.getSourceValue(t),range:[t.start,t.end],loc:{start:{line:this.startMarker.line,column:this.startMarker.column},end:{line:this.scanner.lineNumber,column:this.scanner.index-this.scanner.lineStart}}}}readNextRawToken(){this.endMarker.index=this.scanner.index,this.endMarker.line=this.scanner.lineNumber,this.endMarker.column=this.scanner.index-this.scanner.lineStart;const t=this.rawToken;this.collectComments(this.scanner.scanComments()),this.scanner.index!==this.startMarker.index&&(this.startMarker.index=this.scanner.index,this.startMarker.line=this.scanner.lineNumber,this.startMarker.column=this.scanner.index-this.scanner.lineStart),this.rawToken=this.scanner.lex(),this.hasLineTerminator=t.lineNumber!==this.rawToken.lineNumber,this.options.tokens&&this.rawToken.type!==s.TokenType.EOF&&this.tokens.push(this.convertToToken(this.rawToken))}captureStartMarker(){return{index:this.startMarker.index,line:this.startMarker.line,column:this.startMarker.column}}getItemLocation(t){return{range:[t.index,this.endMarker.index],loc:{start:{line:t.line,column:t.column},end:{line:this.endMarker.line,column:this.endMarker.column}}}}finalize(t){return(this.delegate||this.commentHandler)&&(this.commentHandler?.attachComments(t),this.delegate?.(t)),t}expectPunctuator(t){const e=this.rawToken;this.matchPunctuator(t)?this.readNextRawToken():this.throwUnexpectedToken({rawToken:e,code:s.ParsingErrorCodes.PunctuatorExpected,data:{value:t}})}expectKeyword(t){this.rawToken.type!==s.TokenType.Keyword||this.rawToken.value.toLowerCase()!==t?this.throwUnexpectedToken({rawToken:this.rawToken}):this.readNextRawToken()}expectContextualKeyword(t){this.rawToken.type!==s.TokenType.Identifier||this.rawToken.value.toLowerCase()!==t?this.throwUnexpectedToken({rawToken:this.rawToken}):this.readNextRawToken()}matchKeyword(t){return this.rawToken.type===s.TokenType.Keyword&&this.rawToken.value.toLowerCase()===t}matchContextualKeyword(t){return this.rawToken.type===s.TokenType.Identifier&&this.rawToken.value===t}matchPunctuator(t){return this.rawToken.type===s.TokenType.Punctuator&&this.rawToken.value===t}getMatchingPunctuator(t){if("string"==typeof t&&(t=t.split("")),this.rawToken.type===s.TokenType.Punctuator&&t?.length)return t.find(this.matchPunctuator,this)}isolateCoverGrammar(t){const e=this.context.isAssignmentTarget;this.context.isAssignmentTarget=!0;const r=t.call(this);return this.context.isAssignmentTarget=e,r}inheritCoverGrammar(t){const e=this.context.isAssignmentTarget;this.context.isAssignmentTarget=!0;const r=t.call(this);return this.context.isAssignmentTarget=this.context.isAssignmentTarget&&e,r}withBlockContext(t,e){const r=this.context.blockContext;this.context.blockContext=this.context.blockContext|t;const n=this.context.curlyParsingType;this.context.curlyParsingType=a.Automatic;const s=e.call(this);return this.context.blockContext=r,this.context.curlyParsingType=n,s}consumeSemicolon(){if(this.matchPunctuator(";"))this.readNextRawToken();else if(!this.hasLineTerminator)return this.rawToken.type===s.TokenType.EOF||this.matchPunctuator("}")?(this.endMarker.index=this.startMarker.index,this.endMarker.line=this.startMarker.line,void(this.endMarker.column=this.startMarker.column)):void this.throwUnexpectedToken({rawToken:this.rawToken})}parsePrimaryExpression(){const t=this.captureStartMarker(),e=this.rawToken;switch(e.type){case s.TokenType.Identifier:return this.readNextRawToken(),this.finalize({type:s.Syntax.Identifier,name:e.value,...this.getItemLocation(t)});case s.TokenType.NumericLiteral:case s.TokenType.StringLiteral:return this.context.isAssignmentTarget=!1,this.readNextRawToken(),this.finalize({type:s.Syntax.Literal,value:e.value,raw:this.getSourceValue(e),isString:"string"==typeof e.value,...this.getItemLocation(t)});case s.TokenType.BooleanLiteral:return this.context.isAssignmentTarget=!1,this.readNextRawToken(),this.finalize({type:s.Syntax.Literal,value:e.value.toLowerCase()===s.Keywords.True,raw:this.getSourceValue(e),isString:!1,...this.getItemLocation(t)});case s.TokenType.NullLiteral:return this.context.isAssignmentTarget=!1,this.readNextRawToken(),this.finalize({type:s.Syntax.Literal,value:null,raw:this.getSourceValue(e),isString:!1,...this.getItemLocation(t)});case s.TokenType.Template:return this.parseTemplateLiteral();case s.TokenType.Punctuator:switch(e.value){case"(":return this.inheritCoverGrammar(this.parseGroupExpression);case"[":return this.inheritCoverGrammar(this.parseArrayInitializer);case"{":return this.inheritCoverGrammar(this.parseObjectExpression);default:return this.throwUnexpectedToken({rawToken:this.rawToken})}case s.TokenType.Keyword:return this.context.isAssignmentTarget=!1,this.throwUnexpectedToken({rawToken:this.rawToken});default:return this.throwUnexpectedToken({rawToken:this.rawToken})}}parseArrayInitializer(){const t=this.captureStartMarker();this.expectPunctuator("[");const e=[];for(;!this.matchPunctuator("]");){const t=this.captureStartMarker();this.matchPunctuator(",")?(this.readNextRawToken(),this.throwError(s.ParsingErrorCodes.InvalidExpression,t)):(e.push(this.inheritCoverGrammar(this.parseAssignmentExpression)),this.matchPunctuator("]")||this.expectPunctuator(","))}return this.expectPunctuator("]"),this.finalize({type:s.Syntax.ArrayExpression,elements:e,...this.getItemLocation(t)})}parseObjectPropertyKey(){const t=this.captureStartMarker(),e=this.rawToken;switch(e.type){case s.TokenType.StringLiteral:return this.readNextRawToken(),this.finalize({type:s.Syntax.Literal,value:e.value,raw:this.getSourceValue(e),isString:!0,...this.getItemLocation(t)});case s.TokenType.Identifier:case s.TokenType.BooleanLiteral:case s.TokenType.NullLiteral:case s.TokenType.Keyword:return this.readNextRawToken(),this.finalize({type:s.Syntax.Identifier,name:e.value,...this.getItemLocation(t)});default:this.throwError(s.ParsingErrorCodes.KeyMustBeString,t)}}parseObjectProperty(){const t=this.rawToken,e=this.captureStartMarker(),r=this.parseObjectPropertyKey();let n=!1,i=null;return this.matchPunctuator(":")?(this.readNextRawToken(),i=this.inheritCoverGrammar(this.parseAssignmentExpression)):t.type===s.TokenType.Identifier?(n=!0,i=this.finalize({type:s.Syntax.Identifier,name:t.value,...this.getItemLocation(e)})):this.throwUnexpectedToken({rawToken:this.rawToken}),this.finalize({type:s.Syntax.Property,kind:"init",key:r,value:i,shorthand:n,...this.getItemLocation(e)})}parseObjectExpression(){const t=this.captureStartMarker();this.expectPunctuator("{");const e=[];for(;!this.matchPunctuator("}");)e.push(this.parseObjectProperty()),this.matchPunctuator("}")||this.expectPunctuator(",");return this.expectPunctuator("}"),this.finalize({type:s.Syntax.ObjectExpression,properties:e,...this.getItemLocation(t)})}parseTemplateElement(t=!1){const e=this.rawToken;e.type!==s.TokenType.Template&&this.throwUnexpectedToken({rawToken:e}),t&&!e.head&&this.throwUnexpectedToken({code:s.ParsingErrorCodes.InvalidTemplateHead,rawToken:e});const r=this.captureStartMarker();this.readNextRawToken();const{value:n,cooked:i,tail:a}=e,o=this.finalize({type:s.Syntax.TemplateElement,value:{raw:n,cooked:i},tail:a,...this.getItemLocation(r)});return o.loc.start.column++,o.loc.end.column=o.loc.end.column-(a?1:2),o}parseTemplateLiteral(){const t=this.captureStartMarker(),e=[],r=[];let n=this.parseTemplateElement(!0);for(r.push(n);!n.tail;)e.push(this.parseExpression()),n=this.parseTemplateElement(),r.push(n);return this.finalize({type:s.Syntax.TemplateLiteral,quasis:r,expressions:e,...this.getItemLocation(t)})}parseGroupExpression(){this.expectPunctuator("(");const t=this.inheritCoverGrammar(this.parseAssignmentExpression);return this.expectPunctuator(")"),t}parseArguments(){this.expectPunctuator("(");const t=[];if(!this.matchPunctuator(")"))for(;;){const e=this.isolateCoverGrammar(this.parseAssignmentExpression);if(t.push(e),this.matchPunctuator(")"))break;if(this.expectPunctuator(","),this.matchPunctuator(")"))break}return this.expectPunctuator(")"),t}parseMemberName(){const t=this.rawToken,e=this.captureStartMarker();return this.readNextRawToken(),t.type!==s.TokenType.NullLiteral&&t.type!==s.TokenType.Identifier&&t.type!==s.TokenType.Keyword&&t.type!==s.TokenType.BooleanLiteral&&this.throwUnexpectedToken({rawToken:t}),this.finalize({type:s.Syntax.Identifier,name:t.value,...this.getItemLocation(e)})}parseLeftHandSideExpression(){const t=this.captureStartMarker();let e=this.inheritCoverGrammar(this.parsePrimaryExpression);const r=this.captureStartMarker();let n;for(;n=this.getMatchingPunctuator("([.");)switch(n){case"(":{this.context.isAssignmentTarget=!1,e.type!==s.Syntax.Identifier&&e.type!==s.Syntax.MemberExpression&&this.throwError(s.ParsingErrorCodes.IdentiferExpected,t,r);const n=this.parseArguments();e=this.finalize({type:s.Syntax.CallExpression,callee:e,arguments:n,...this.getItemLocation(t)});continue}case"[":{this.context.isAssignmentTarget=!0,this.expectPunctuator("[");const r=this.isolateCoverGrammar(this.parseExpression);this.expectPunctuator("]"),e=this.finalize({type:s.Syntax.MemberExpression,computed:!0,object:e,property:r,...this.getItemLocation(t)});continue}case".":{this.context.isAssignmentTarget=!0,this.expectPunctuator(".");const r=this.parseMemberName();e=this.finalize({type:s.Syntax.MemberExpression,computed:!1,object:e,property:r,...this.getItemLocation(t)});continue}}return e}parseUpdateExpression(){const t=this.captureStartMarker();let e=this.getMatchingPunctuator(s.UpdateOperators);if(e){this.readNextRawToken();const r=this.captureStartMarker(),n=this.inheritCoverGrammar(this.parseUnaryExpression);return n.type!==s.Syntax.Identifier&&n.type!==s.Syntax.MemberExpression&&n.type!==s.Syntax.CallExpression&&this.throwError(s.ParsingErrorCodes.InvalidExpression,r),this.context.isAssignmentTarget||this.tolerateError(s.ParsingErrorCodes.InvalidLeftHandSideInAssignment,t),this.context.isAssignmentTarget=!1,this.finalize({type:s.Syntax.UpdateExpression,operator:e,argument:n,prefix:!0,...this.getItemLocation(t)})}const r=this.captureStartMarker(),n=this.inheritCoverGrammar(this.parseLeftHandSideExpression),i=this.captureStartMarker();return this.hasLineTerminator?n:(e=this.getMatchingPunctuator(s.UpdateOperators),e?(n.type!==s.Syntax.Identifier&&n.type!==s.Syntax.MemberExpression&&this.throwError(s.ParsingErrorCodes.InvalidExpression,r,i),this.context.isAssignmentTarget||this.tolerateError(s.ParsingErrorCodes.InvalidLeftHandSideInAssignment,t),this.readNextRawToken(),this.context.isAssignmentTarget=!1,this.finalize({type:s.Syntax.UpdateExpression,operator:e,argument:n,prefix:!1,...this.getItemLocation(t)})):n)}parseUnaryExpression(){const t=this.getMatchingPunctuator(s.UnaryOperators);if(t){const e=this.captureStartMarker();this.readNextRawToken();const r=this.inheritCoverGrammar(this.parseUnaryExpression);return this.context.isAssignmentTarget=!1,this.finalize({type:s.Syntax.UnaryExpression,operator:t,argument:r,prefix:!0,...this.getItemLocation(e)})}return this.parseUpdateExpression()}parseBinaryExpression(){const t=this.rawToken;let e=this.inheritCoverGrammar(this.parseUnaryExpression);if(this.rawToken.type!==s.TokenType.Punctuator)return e;const r=this.rawToken.value;let n=c(r);if(0===n)return e;this.readNextRawToken(),this.context.isAssignmentTarget=!1;const i=[t,this.rawToken];let a=e,h=this.inheritCoverGrammar(this.parseUnaryExpression);const p=[a,r,h],l=[n];for(;this.rawToken.type===s.TokenType.Punctuator&&(n=c(this.rawToken.value))>0;){for(;p.length>2&&n<=l[l.length-1];){h=p.pop();const t=p.pop();l.pop(),a=p.pop(),i.pop();const e=i[i.length-1],r=o(e,e.lineStart);p.push(this.finalize(this.createBinaryOrLogicalExpression(r,t,a,h)))}p.push(this.rawToken.value),l.push(n),i.push(this.rawToken),this.readNextRawToken(),p.push(this.inheritCoverGrammar(this.parseUnaryExpression))}let u=p.length-1;e=p[u];let m=i.pop();for(;u>1;){const t=i.pop();if(!t)break;const r=m?.lineStart,n=o(t,r),s=p[u-1];e=this.finalize(this.createBinaryOrLogicalExpression(n,s,p[u-2],e)),u-=2,m=t}return e}createBinaryOrLogicalExpression(t,e,r,n){const i=s.LogicalOperators.includes(e)?s.Syntax.LogicalExpression:s.Syntax.BinaryExpression;return i===s.Syntax.BinaryExpression||(r.type!==s.Syntax.AssignmentExpression&&r.type!==s.Syntax.UpdateExpression||this.throwError(s.ParsingErrorCodes.InvalidExpression,...h(r)),n.type!==s.Syntax.AssignmentExpression&&n.type!==s.Syntax.UpdateExpression||this.throwError(s.ParsingErrorCodes.InvalidExpression,...h(r))),{type:i,operator:e,left:r,right:n,...this.getItemLocation(t)}}parseAssignmentExpression(){const t=this.captureStartMarker(),e=this.inheritCoverGrammar(this.parseBinaryExpression),r=this.captureStartMarker(),n=this.getMatchingPunctuator(s.AssignmentOperators);if(!n)return e;e.type!==s.Syntax.Identifier&&e.type!==s.Syntax.MemberExpression&&this.throwError(s.ParsingErrorCodes.InvalidExpression,t,r),this.context.isAssignmentTarget||this.tolerateError(s.ParsingErrorCodes.InvalidLeftHandSideInAssignment,t),this.matchPunctuator("=")||(this.context.isAssignmentTarget=!1),this.readNextRawToken();const i=this.isolateCoverGrammar(this.parseAssignmentExpression);return this.finalize({type:s.Syntax.AssignmentExpression,left:e,operator:n,right:i,...this.getItemLocation(t)})}parseExpression(){return this.isolateCoverGrammar(this.parseAssignmentExpression)}parseStatements(t){const e=[];for(;this.rawToken.type!==s.TokenType.EOF&&!this.matchPunctuator(t);){const t=this.parseStatementListItem();s.isEmptyStatement(t)||e.push(t)}return e}parseStatementListItem(){return this.context.isAssignmentTarget=!0,this.matchKeyword(s.Keywords.Function)?this.parseFunctionDeclaration():this.matchKeyword(s.Keywords.Export)?this.parseExportDeclaration():this.matchKeyword(s.Keywords.Import)?this.parseImportDeclaration():this.parseStatement()}parseBlock(){const t=this.captureStartMarker();this.expectPunctuator("{");const e=this.parseStatements("}");return this.expectPunctuator("}"),this.finalize({type:s.Syntax.BlockStatement,body:e,...this.getItemLocation(t)})}parseObjectStatement(){const t=this.captureStartMarker(),e=this.parseObjectExpression();return this.finalize({type:s.Syntax.ExpressionStatement,expression:e,...this.getItemLocation(t)})}parseBlockOrObjectStatement(){if(this.context.curlyParsingType===a.AsObject)return this.parseObjectStatement();return this.peekAhead((t=>{let e=t();return(e.type===s.TokenType.Identifier||e.type===s.TokenType.StringLiteral)&&(e=t(),e.type===s.TokenType.Punctuator&&":"===e.value)}))?this.parseObjectStatement():this.parseBlock()}parseIdentifier(){const t=this.rawToken;if(t.type!==s.TokenType.Identifier)return null;const e=this.captureStartMarker();return this.readNextRawToken(),this.finalize({type:s.Syntax.Identifier,name:t.value,...this.getItemLocation(e)})}parseVariableDeclarator(){const t=this.captureStartMarker(),e=this.parseIdentifier();e||this.throwUnexpectedToken({code:s.ParsingErrorCodes.IdentiferExpected});let r=null;if(this.matchPunctuator("=")){this.readNextRawToken();const t=this.rawToken;try{r=this.isolateCoverGrammar(this.parseAssignmentExpression)}catch(n){this.throwUnexpectedToken({rawToken:t,code:s.ParsingErrorCodes.InvalidVariableAssignment})}}return this.finalize({type:s.Syntax.VariableDeclarator,id:e,init:r,...this.getItemLocation(t)})}parseVariableDeclarationList(){const t=[this.parseVariableDeclarator()];for(;this.matchPunctuator(",");)this.readNextRawToken(),t.push(this.parseVariableDeclarator());return t}parseVariableDeclaration(){const t=this.captureStartMarker();this.expectKeyword(s.Keywords.Var);const e=this.parseVariableDeclarationList();return this.consumeSemicolon(),this.finalize({type:s.Syntax.VariableDeclaration,declarations:e,kind:"var",...this.getItemLocation(t)})}parseEmptyStatement(){const t=this.captureStartMarker();return this.expectPunctuator(";"),this.finalize({type:s.Syntax.EmptyStatement,...this.getItemLocation(t)})}parseExpressionStatement(){const t=this.captureStartMarker(),e=this.parseExpression();return this.consumeSemicolon(),this.finalize({type:s.Syntax.ExpressionStatement,expression:e,...this.getItemLocation(t)})}parseIfClause(){return this.withBlockContext(i.IfClause,this.parseStatement)}parseIfStatement(){const t=this.captureStartMarker();this.expectKeyword(s.Keywords.If),this.expectPunctuator("(");const e=this.captureStartMarker(),r=this.parseExpression(),n=this.captureStartMarker();this.expectPunctuator(")"),r.type!==s.Syntax.AssignmentExpression&&r.type!==s.Syntax.UpdateExpression||this.throwError(s.ParsingErrorCodes.InvalidExpression,e,n);const i=this.parseIfClause();let a=null;return this.matchKeyword(s.Keywords.Else)&&(this.readNextRawToken(),a=this.parseIfClause()),this.finalize({type:s.Syntax.IfStatement,test:r,consequent:i,alternate:a,...this.getItemLocation(t)})}parseWhileStatement(){const t=this.captureStartMarker();this.expectKeyword(s.Keywords.While),this.expectPunctuator("(");const e=this.captureStartMarker(),r=this.parseExpression(),n=this.captureStartMarker();this.expectPunctuator(")"),r.type!==s.Syntax.AssignmentExpression&&r.type!==s.Syntax.UpdateExpression||this.throwError(s.ParsingErrorCodes.InvalidExpression,e,n);const a=this.withBlockContext(i.WhileLoop,this.parseStatement);return this.finalize({type:s.Syntax.WhileStatement,test:r,body:a,...this.getItemLocation(t)})}parseForStatement(){let t=null,e=null,r=null,n=null,a=null;const o=this.captureStartMarker();if(this.expectKeyword(s.Keywords.For),this.expectPunctuator("("),this.matchPunctuator(";"))this.readNextRawToken();else if(this.matchKeyword(s.Keywords.Var)){const e=this.captureStartMarker();this.readNextRawToken();const r=this.parseVariableDeclarationList();if(1===r.length&&this.matchKeyword(s.Keywords.In)){r[0].init&&this.throwError(s.ParsingErrorCodes.ForInOfLoopInitializer,e),n=this.finalize({type:s.Syntax.VariableDeclaration,declarations:r,kind:"var",...this.getItemLocation(e)}),this.readNextRawToken(),a=this.parseExpression()}else this.matchKeyword(s.Keywords.In)&&this.throwError(s.ParsingErrorCodes.InvalidLeftHandSideInForIn,e),t=this.finalize({type:s.Syntax.VariableDeclaration,declarations:r,kind:"var",...this.getItemLocation(e)}),this.expectPunctuator(";")}else{const e=this.context.isAssignmentTarget,r=this.captureStartMarker();t=this.inheritCoverGrammar(this.parseAssignmentExpression),this.matchKeyword(s.Keywords.In)?(this.context.isAssignmentTarget||this.tolerateError(s.ParsingErrorCodes.InvalidLeftHandSideInForIn,r),t.type!==s.Syntax.Identifier&&this.throwError(s.ParsingErrorCodes.InvalidLeftHandSideInForIn,r),this.readNextRawToken(),n=t,a=this.parseExpression(),t=null):(this.context.isAssignmentTarget=e,this.expectPunctuator(";"))}n||(this.matchPunctuator(";")||(e=this.isolateCoverGrammar(this.parseExpression)),this.expectPunctuator(";"),this.matchPunctuator(")")||(r=this.isolateCoverGrammar(this.parseExpression))),this.expectPunctuator(")");const h=this.withBlockContext(i.ForLoop,(()=>this.isolateCoverGrammar(this.parseStatement)));return n&&a?this.finalize({type:s.Syntax.ForInStatement,left:n,right:a,body:h,...this.getItemLocation(o)}):this.finalize({type:s.Syntax.ForStatement,init:t,test:e,update:r,body:h,...this.getItemLocation(o)})}parseContinueStatement(){const t=this.captureStartMarker();return this.expectKeyword(s.Keywords.Continue),this.consumeSemicolon(),this.finalize({type:s.Syntax.ContinueStatement,...this.getItemLocation(t)})}parseBreakStatement(){const t=this.captureStartMarker();return this.expectKeyword(s.Keywords.Break),this.consumeSemicolon(),this.finalize({type:s.Syntax.BreakStatement,...this.getItemLocation(t)})}parseReturnStatement(){const t=this.captureStartMarker();this.expectKeyword(s.Keywords.Return);const e=!this.matchPunctuator(";")&&!this.matchPunctuator("}")&&!this.hasLineTerminator&&this.rawToken.type!==s.TokenType.EOF||this.rawToken.type===s.TokenType.StringLiteral||this.rawToken.type===s.TokenType.Template?this.parseExpression():null;return this.consumeSemicolon(),this.finalize({type:s.Syntax.ReturnStatement,argument:e,...this.getItemLocation(t)})}parseStatement(){switch(this.rawToken.type){case s.TokenType.BooleanLiteral:case s.TokenType.NullLiteral:case s.TokenType.NumericLiteral:case s.TokenType.StringLiteral:case s.TokenType.Template:case s.TokenType.Identifier:return this.parseExpressionStatement();case s.TokenType.Punctuator:return"{"===this.rawToken.value?this.parseBlockOrObjectStatement():"("===this.rawToken.value?this.parseExpressionStatement():";"===this.rawToken.value?this.parseEmptyStatement():this.parseExpressionStatement();case s.TokenType.Keyword:switch(this.rawToken.value.toLowerCase()){case s.Keywords.Break:return this.parseBreakStatement();case s.Keywords.Continue:return this.parseContinueStatement();case s.Keywords.For:return this.parseForStatement();case s.Keywords.Function:return this.parseFunctionDeclaration();case s.Keywords.If:return this.parseIfStatement();case s.Keywords.Return:return this.parseReturnStatement();case s.Keywords.Var:return this.parseVariableDeclaration();case s.Keywords.While:return this.parseWhileStatement();default:return this.parseExpressionStatement()}default:return this.throwUnexpectedToken({rawToken:this.rawToken})}}parseFormalParameters(){const t=[];if(this.expectPunctuator("("),!this.matchPunctuator(")"))for(;this.rawToken.type!==s.TokenType.EOF;){const e=this.parseIdentifier();if(e||this.throwUnexpectedToken({rawToken:this.rawToken,code:s.ParsingErrorCodes.IdentiferExpected}),t.push(e),this.matchPunctuator(")"))break;if(this.expectPunctuator(","),this.matchPunctuator(")"))break}return this.expectPunctuator(")"),t}parseFunctionDeclaration(){(this.context.blockContext&i.Function)===i.Function&&this.throwUnexpectedToken({code:s.ParsingErrorCodes.NoFunctionInsideFunction}),(this.context.blockContext&i.WhileLoop)!==i.WhileLoop&&(this.context.blockContext&i.IfClause)!==i.IfClause||this.throwUnexpectedToken({code:s.ParsingErrorCodes.NoFunctionInsideBlock});const t=this.captureStartMarker();this.expectKeyword(s.Keywords.Function);const e=this.parseIdentifier();e||this.throwUnexpectedToken({code:s.ParsingErrorCodes.InvalidFunctionIdentifier});const r=this.parseFormalParameters(),n=this.context.blockContext;this.context.blockContext=this.context.blockContext|i.Function;const a=this.parseBlock();return this.context.blockContext=n,this.finalize({type:s.Syntax.FunctionDeclaration,id:e,params:r,body:a,...this.getItemLocation(t)})}parseScript(){const t=this.captureStartMarker(),e=this.parseStatements(),r=this.finalize({type:s.Syntax.Program,body:e,...this.getItemLocation(t)});return this.options.tokens&&(r.tokens=this.tokens),this.options.tolerant&&(r.errors=this.errorHandler.errors),r}parseExportDeclaration(){this.context.blockContext!==i.None&&this.throwUnexpectedToken({code:s.ParsingErrorCodes.ModuleExportRootOnly});let t=null;const e=this.captureStartMarker();return this.expectKeyword(s.Keywords.Export),this.matchKeyword(s.Keywords.Var)?t=this.parseVariableDeclaration():this.matchKeyword("function")?t=this.parseFunctionDeclaration():this.throwUnexpectedToken({code:s.ParsingErrorCodes.InvalidExpression}),this.finalize({type:s.Syntax.ExportNamedDeclaration,declaration:t,specifiers:[],source:null,...this.getItemLocation(e)})}parseModuleSpecifier(){const t=this.captureStartMarker(),e=this.rawToken;if(e.type===s.TokenType.StringLiteral)return this.readNextRawToken(),this.finalize({type:s.Syntax.Literal,value:e.value,raw:this.getSourceValue(e),isString:!0,...this.getItemLocation(t)});this.throwError(s.ParsingErrorCodes.InvalidModuleUri,t)}parseDefaultSpecifier(){const t=this.captureStartMarker(),e=this.parseIdentifier();return e||this.throwUnexpectedToken({code:s.ParsingErrorCodes.IdentiferExpected}),this.finalize({type:s.Syntax.ImportDefaultSpecifier,local:e,...this.getItemLocation(t)})}parseImportDeclaration(){this.context.blockContext!==i.None&&this.throwUnexpectedToken({code:s.ParsingErrorCodes.ModuleImportRootOnly});const t=this.captureStartMarker();this.expectKeyword(s.Keywords.Import);const e=this.parseDefaultSpecifier();this.expectContextualKeyword(s.Keywords.From);const r=this.parseModuleSpecifier();return this.finalize({type:s.Syntax.ImportDeclaration,specifiers:[e],source:r,...this.getItemLocation(t)})}}t.Parser=p,t.binaryOperatorPrecedence=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
