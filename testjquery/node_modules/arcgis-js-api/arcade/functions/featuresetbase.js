/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../ArcadeDate","../ArcadePortal","../Dictionary","../executionError","../Feature","../featureSetCollection","../featureSetUtils","../ImmutableArray","../../chunks/languageUtils","../portalUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../../core/promiseUtils","../../core/sql/WhereClause","../../layers/FeatureLayer","../../layers/support/Field","../../portal/Portal"],(function(e,t,n,r,i,a,o,s,l,u,c,d,f,m,E,y,p,h,F,g,w,A,x,S,I,C){"use strict";function D(e,t,n,r){if(1===r.length){if(u.isArray(r[0]))return w.calculateStat(e,r[0],-1);if(u.isImmutableArray(r[0]))return w.calculateStat(e,r[0].toArray(),-1)}return w.calculateStat(e,r,-1)}async function T(e,t,n){const r=e.getVariables();if(r.length>0){const i=[];for(let e=0;e<r.length;e++){const a={name:r[e]};i.push(await t.evaluateIdentifier(n,a))}const a={};for(let e=0;e<r.length;e++)a[r[e]]=i[e];return e.parameters=a,e}return e}function b(e,t,n=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return n}function N(e){if(null===e)return null;const t={type:b(e,"type",""),name:b(e,"name","")};if("range"===t.type)t.range=b(e,"range",[]);else{t.codedValues=[];for(const n of b(e,"codedValues",[]))t.codedValues.push({name:b(n,"name",""),code:b(n,"code",null)})}return t}function L(e){if(null===e)return null;const t={},n=b(e,"wkt",null);null!==n&&(t.wkt=n);const r=b(e,"wkid",null);return null!==r&&(t.wkid=r),t}function v(e){if(null===e)return null;const t={hasZ:b(e,"hasz",!1),hasM:b(e,"hasm",!1)},n=b(e,"spatialreference",null);n&&(t.spatialReference=L(n));const r=b(e,"x",null);if(null!==r)return t.x=r,t.y=b(e,"y",null),t;const i=b(e,"rings",null);if(null!==i)return t.rings=i,t;const a=b(e,"paths",null);if(null!==a)return t.paths=a,t;const o=b(e,"points",null);if(null!==o)return t.points=o,t;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const n=b(e,s,null);null!==n&&(t[s]=n)}return t}function P(e,t){for(const n of t)if(n===e)return!0;return!1}function U(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==P(e.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(!1!==u.isArray(e.layerDefinition.fields)&&!1!==u.isArray(e.featureSet.features))))}function $(e){return"utc"===e?.toLowerCase()?"UTC":"unknown"===e?.toLowerCase()?"Unknown":e}function k(e){"async"===e.mode&&(e.functions.timezone=function(n,a){return e.standardFunctionAsync(n,a,(async(e,o,s)=>{if(u.pcCheck(s,1,2,n,a),u.isTime(s[0]))return"Unknown";if(u.isDateOnly(s[0]))return"Unknown";if(u.isFeatureSet(s[0])){if(await s[0].load(),1===s.length||null===s[1])return s[0].datesInUnknownTimezone?$("unknown"):$(s[0].dateFieldsTimeZone);if(!(s[1]instanceof r)||!1===s[1].hasField("type"))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);const e=s[1].field("type");if(!1===u.isString(e))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);switch(u.toString(e).toLowerCase()){case"preferredtimezone":return $(s[0].preferredTimeZone);case"editfieldsinfo":return $(s[0].editFieldsInfo?.timeZone??null);case"timeinfo":return $(s[0].timeInfo?.timeZone??null);case"field":if(s[1].hasField("fieldname")&&u.isString(s[1].field("fieldname")))return $(s[0].fieldTimeZone(u.toString(s[1].field("fieldname"))))}throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a)}const l=u.toDate(s[0],u.defaultTimeZone(n));if(null===l)return null;const c=l.timeZone;return"system"===c?t.ArcadeDate.systemTimeZoneCanonicalName:"utc"===c.toLowerCase()?"UTC":"unknown"===c.toLowerCase()?"Unknown":c}))},e.functions.sqltimestamp=function(t,n){return e.standardFunctionAsync(t,n,(async(e,r,a)=>{u.pcCheck(a,1,3,t,n);const o=a[0];if(u.isDate(o)){if(1===a.length)return o.toSQLWithKeyword();if(2===a.length)return o.changeTimeZone(u.toString(a[1])).toSQLWithKeyword();throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}if(u.isDateOnly(o))return o.toSQLWithKeyword();if(u.isFeatureSet(o)){if(3!==a.length)throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);await o.load();const e=u.toString(a[1]);if(u.isDateOnly(a[2]))return a[2].toSQLWithKeyword();if(!1===u.isDate(a[2]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);const r=o.fieldTimeZone(e);return null===r?a[2].toSQLWithKeyword():a[2].changeTimeZone(r).toSQLWithKeyword()}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"sqltimestamp",min:2,max:4}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,((e,r,a)=>{if(u.pcCheck(a,2,4,t,n),a[0]instanceof o){const e=u.toString(a[1]);let r=u.defaultUndefined(a[2],null);const o=u.toBoolean(u.defaultUndefined(a[3],!0));if(null===r&&(r=["*"]),!1===u.isArray(r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);return a[0].featureSetById(e,o,r)}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"featuresetbyid",min:2,max:4}),e.functions.getfeatureset=function(t,n){return e.standardFunctionAsync(t,n,((e,r,a)=>{if(u.pcCheck(a,1,2,t,n),u.isFeature(a[0])){let e=u.defaultUndefined(a[1],"datasource");return null===e&&(e="datasource"),e=u.toString(e).toLowerCase(),s.convertToFeatureSet(a[0].fullSchema(),e,t.lrucache,t.interceptor,t.spatialReference)}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"getfeatureset",min:1,max:2}),e.functions.featuresetbyportalitem=function(t,r){return e.standardFunctionAsync(t,r,((e,a,o)=>{if(u.pcCheck(o,2,5,t,r),null===o[0])throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.PortalRequired,r);if(o[0]instanceof n){const e=u.toString(o[1]),n=u.toString(o[2]);let a=u.defaultUndefined(o[3],null);const l=u.toBoolean(u.defaultUndefined(o[4],!0));if(null===a&&(a=["*"]),!1===u.isArray(a))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,r);let d=null;return d=t.services?.portal?t.services.portal:C.getDefault(),d=c.getPortal(o[0],d),s.constructFeatureSetFromPortalItem(e,n,t.spatialReference,a,l,d,t.lrucache,t.interceptor)}if(!1===u.isString(o[0]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.PortalRequired,r);const l=u.toString(o[0]),d=u.toString(o[1]);let f=u.defaultUndefined(o[2],null);const m=u.toBoolean(u.defaultUndefined(o[3],!0));if(null===f&&(f=["*"]),!1===u.isArray(f))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,r);return s.constructFeatureSetFromPortalItem(l,d,t.spatialReference,f,m,t.services?.portal??C.getDefault(),t.lrucache,t.interceptor)}))},e.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,((e,r,a)=>{if(u.pcCheck(a,2,4,t,n),a[0]instanceof o){const e=u.toString(a[1]);let r=u.defaultUndefined(a[2],null);const o=u.toBoolean(u.defaultUndefined(a[3],!0));if(null===r&&(r=["*"]),!1===u.isArray(r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);return a[0].featureSetByName(e,o,r)}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"featuresetbyname",min:2,max:4}),e.functions.featureset=function(t,n){return e.standardFunction(t,n,((e,a,o)=>{u.pcCheck(o,1,1,t,n);let s=o[0];const l={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(u.isString(s))s=JSON.parse(s),void 0!==s.layerDefinition?(l.layerDefinition=s.layerDefinition,l.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(l.featureSet.features=s.features,l.featureSet.geometryType=s.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=s.objectIdFieldName??"",l.layerDefinition.typeIdField=s.typeIdFieldName,l.layerDefinition.globalIdField=s.globalIdFieldName,l.layerDefinition.fields=s.fields,s.spatialReference&&(l.layerDefinition.spatialReference=s.spatialReference));else{if(!(o[0]instanceof r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);{s=JSON.parse(o[0].castToText(!0));const e=b(s,"layerdefinition");if(null!==e){l.layerDefinition.geometryType=b(e,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.globalIdField=b(e,"globalidfield",""),l.layerDefinition.objectIdField=b(e,"objectidfield",""),l.layerDefinition.typeIdField=b(e,"typeidfield",""),l.layerDefinition.hasZ=!0===b(e,"hasz",!1),l.layerDefinition.hasM=!0===b(e,"hasm",!1);const t=b(e,"spatialreference",null);t&&(l.layerDefinition.spatialReference=L(t));for(const r of b(e,"fields",[])){const e={name:b(r,"name",""),alias:b(r,"alias",""),type:b(r,"type",""),nullable:b(r,"nullable",!0),editable:b(r,"editable",!0),length:b(r,"length",null),domain:N(b(r,"domain"))};l.layerDefinition.fields.push(e)}const n=b(s,"featureset",null);if(n){const e={};for(const t of l.layerDefinition.fields)e[t.name.toLowerCase()]=t.name;for(const t of b(n,"features",[])){const n={},r=b(t,"attributes",{});for(const t in r)n[e[t.toLowerCase()]]=r[t];l.featureSet.features.push({attributes:n,geometry:v(b(t,"geometry",null))})}}}else{l.layerDefinition.hasZ=!0===b(s,"hasz",!1),l.layerDefinition.hasM=!0===b(s,"hasm",!1),l.layerDefinition.geometryType=b(s,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=b(s,"objectidfieldname",""),l.layerDefinition.typeIdField=b(s,"typeidfieldname","");const e=b(s,"spatialreference",null);e&&(l.layerDefinition.spatialReference=L(e));let t=b(s,"fields",null);if(u.isArray(t))for(const i of t){const e={name:b(i,"name",""),alias:b(i,"alias",""),type:b(i,"type",""),nullable:b(i,"nullable",!0),editable:b(i,"editable",!0),length:b(i,"length",null),domain:N(b(i,"domain"))};l.layerDefinition.fields.push(e)}else t=null,l.layerDefinition.fields=t;const n={};for(const i of l.layerDefinition.fields)n[i.name.toLowerCase()]=i.name;let r=b(s,"features",null);if(u.isArray(r))for(const i of r){const e={},t=b(i,"attributes",{});for(const r in t)e[n[r.toLowerCase()]]=t[r];l.featureSet.features.push({attributes:e,geometry:v(b(i,"geometry",null))})}else r=null,l.featureSet.features=r}}}if(!1===U(l))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);return l.layerDefinition.geometryType||(l.layerDefinition.geometryType="esriGeometryNull"),p.create(l,t.spatialReference)}))},e.signatures.push({name:"featureset",min:1,max:1}),e.functions.filter=function(t,n){return e.standardFunctionAsync(t,n,(async(r,a,o)=>{if(u.pcCheck(o,2,2,t,n),u.isArray(o[0])||u.isImmutableArray(o[0])){const e=[];let r=o[0];r instanceof l&&(r=r.toArray());let a=null;if(!u.isFunctionParameter(o[1]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);a=o[1].createFunction(t);for(const t of r){const n=a(t);A.isPromiseLike(n)?!0===await n&&e.push(t):!0===n&&e.push(t)}return e}if(u.isFeatureSet(o[0])){const n=await o[0].load(),r=x.WhereClause.create(o[1],n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),i=r.getVariables();if(i.length>0){const n=[];for(let r=0;r<i.length;r++){const a={name:i[r]};n.push(await e.evaluateIdentifier(t,a))}const a={};for(let e=0;e<i.length;e++)a[i[e]]=n[e];return r.parameters=a,new f({parentfeatureset:o[0],whereclause:r})}return new f({parentfeatureset:o[0],whereclause:r})}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"filter",min:2,max:2}),e.functions.orderby=function(t,n){return e.standardFunctionAsync(t,n,(async(e,r,a)=>{if(u.pcCheck(a,2,2,t,n),u.isFeatureSet(a[0])){const e=new h(a[1]);return new m({parentfeatureset:a[0],orderbyclause:e})}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"orderby",min:2,max:2}),e.functions.top=function(t,n){return e.standardFunctionAsync(t,n,(async(e,r,a)=>{if(u.pcCheck(a,2,2,t,n),u.isFeatureSet(a[0]))return new E({parentfeatureset:a[0],topnum:a[1]});if(u.isArray(a[0]))return u.toNumber(a[1])>=a[0].length?a[0].slice(0):a[0].slice(0,u.toNumber(a[1]));if(u.isImmutableArray(a[0]))return u.toNumber(a[1])>=a[0].length()?a[0].slice(0):a[0].slice(0,u.toNumber(a[1]));throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"top",min:2,max:2}),e.functions.first=function(t,n){return e.standardFunctionAsync(t,n,(async(e,r,i)=>{if(u.pcCheck(i,1,1,t,n),u.isFeatureSet(i[0])){const n=await i[0].first(e.abortSignal);if(null!==n){const e=a.createFromGraphicLikeObject(n.geometry,n.attributes,i[0],t.timeZone);return e._underlyingGraphic=n,e}return n}return u.isArray(i[0])?0===i[0].length?null:i[0][0]:u.isImmutableArray(i[0])?0===i[0].length()?null:i[0].get(0):null}))},e.signatures.push({name:"first",min:1,max:1}),e.functions.attachments=function(t,n){return e.standardFunctionAsync(t,n,(async(e,a,o)=>{u.pcCheck(o,1,2,t,n);const l={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(o.length>1)if(o[1]instanceof r){if(o[1].hasField("minsize")&&(l.minsize=u.toNumber(o[1].field("minsize"))),o[1].hasField("metadata")&&(l.returnMetadata=u.toBoolean(o[1].field("metadata"))),o[1].hasField("maxsize")&&(l.maxsize=u.toNumber(o[1].field("maxsize"))),o[1].hasField("types")){const e=u.toStringArray(o[1].field("types"),!1);e.length>0&&(l.types=e)}}else if(null!==o[1])throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);if(u.isFeature(o[0])){let e=o[0]._layer;return e instanceof S&&(e=s.constructFeatureSet(e,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===e?[]:!1===u.isFeatureSet(e)?[]:(await e.load(),e.queryAttachments(o[0].field(e.objectIdField),l.minsize,l.maxsize,l.types,l.returnMetadata))}if(null===o[0])return[];throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"attachments",min:1,max:2}),e.functions.featuresetbyrelationshipname=function(t,n){return e.standardFunctionAsync(t,n,(async(e,r,a)=>{u.pcCheck(a,2,4,t,n);const o=a[0],l=u.toString(a[1]);let c=u.defaultUndefined(a[2],null);const d=u.toBoolean(u.defaultUndefined(a[3],!0));if(null===c&&(c=["*"]),!1===u.isArray(c))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);if(null===a[0])return null;if(!u.isFeature(a[0]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);let f=o._layer;if(f instanceof S&&(f=s.constructFeatureSet(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===f)return null;if(!1===u.isFeatureSet(f))return null;f=await f.load();const m=f.relationshipMetaData().filter((e=>e.name===l));if(0===m.length)return null;if(void 0!==m[0].relationshipTableId&&null!==m[0].relationshipTableId&&m[0].relationshipTableId>-1)return s.constructFeatureSetFromRelationship(f,m[0],o.field(f.objectIdField),f.spatialReference,c,d,t.lrucache,t.interceptor);let E=f.serviceUrl();if(!E)return null;E="/"===E.charAt(E.length-1)?E+m[0].relatedTableId.toString():E+"/"+m[0].relatedTableId.toString();const p=await s.constructFeatureSetFromUrl(E,f.spatialReference,c,d,t.lrucache,t.interceptor);await p.load();let h=p.relationshipMetaData();if(h=h.filter((e=>e.id===m[0].id)),!1===o.hasField(m[0].keyField)||null===o.field(m[0].keyField)){const e=await f.getFeatureByObjectId(o.field(f.objectIdField),[m[0].keyField]);if(e){const t=x.WhereClause.create(h[0].keyField+"= @id",p.getFieldsIndex(),p.dateFieldsTimeZoneDefaultUTC);return t.parameters={id:e.attributes[m[0].keyField]},p.filter(t)}return new y({parentfeatureset:p})}const F=x.WhereClause.create(h[0].keyField+"= @id",p.getFieldsIndex(),p.dateFieldsTimeZoneDefaultUTC);return F.parameters={id:o.field(m[0].keyField)},p.filter(F)}))},e.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),e.functions.featuresetbyassociation=function(t,n){return e.standardFunctionAsync(t,n,(async(e,r,a)=>{u.pcCheck(a,2,3,t,n);const o=a[0],l=u.toString(u.defaultUndefined(a[1],"")).toLowerCase(),c=u.isString(a[2])?u.toString(a[2]):null;if(null===a[0])return null;if(!u.isFeature(a[0]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);let f=o._layer;if(f instanceof S&&(f=s.constructFeatureSet(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===f)return null;if(!1===u.isFeatureSet(f))return null;await f.load();const m=f.serviceUrl(),E=await s.constructAssociationMetaDataFeatureSetFromUrl(m,t.spatialReference);let y=null,p=null,h=!1;if(null!==c&&""!==c&&void 0!==c){for(const e of E.terminals)e.terminalName===c&&(p=e.terminalId);null===p&&(h=!0)}const g=E.associations.getFieldsIndex(),w=g.get("TOGLOBALID").name,A=g.get("FROMGLOBALID").name,C=g.get("TOTERMINALID").name,D=g.get("FROMTERMINALID").name,T=g.get("FROMNETWORKSOURCEID").name,b=g.get("TONETWORKSOURCEID").name,N=g.get("ASSOCIATIONTYPE").name,L=g.get("ISCONTENTVISIBLE").name,v=g.get("OBJECTID").name;for(const t of f.fields)if("global-id"===t.type){y=o.field(t.name);break}let P=null,U=new d.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"double"}),x.WhereClause.create("0",E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC)),$=new d.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"string"}),x.WhereClause.create("''",E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC));const k="globalid",R="globalId",Z={};for(const t in E.lkp)Z[t]=E.lkp[t].sourceId;const M=new d.StringToCodeAdapted(new I({name:"classname",alias:"classname",type:"string"}),null,Z);let W="";switch(l){case"midspan":{W=`((${w}='${y}') OR ( ${A}='${y}')) AND (${N} IN (5))`,M.codefield=x.WhereClause.create(`CASE WHEN (${w}='${y}') THEN ${T} ELSE ${b} END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC);const e=F.cloneField(d.AdaptedFeatureSet.findField(E.associations.fields,A));e.name=k,e.alias=k,P=new d.SqlExpressionAdapted(e,x.WhereClause.create(`CASE WHEN (${A}='${y}') THEN ${w} ELSE ${A} END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC)),U=E.unVersion>=4?new d.OriginalField(d.AdaptedFeatureSet.findField(E.associations.fields,g.get("PERCENTALONG").name)):new d.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"double"}),x.WhereClause.create("0",E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC));break}case"junctionedge":{W=`((${w}='${y}') OR ( ${A}='${y}')) AND (${N} IN (4,6))`,M.codefield=x.WhereClause.create(`CASE WHEN (${w}='${y}') THEN ${T} ELSE ${b} END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC);const e=F.cloneField(d.AdaptedFeatureSet.findField(E.associations.fields,A));e.name=k,e.alias=k,P=new d.SqlExpressionAdapted(e,x.WhereClause.create(`CASE WHEN (${A}='${y}') THEN ${w} ELSE ${A} END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC)),$=new d.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"string"}),x.WhereClause.create(`CASE WHEN (${N}=4) THEN 'from' ELSE 'to' END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC));break}case"connected":{let e=`${w}='@T'`,t=`${A}='@T'`;null!==p&&(e+=` AND ${C}=@A`,t+=` AND ${D}=@A`),W="(("+e+") OR ("+t+"))",W=u.multiReplace(W,"@T",y??""),e=u.multiReplace(e,"@T",y??""),null!==p&&(e=u.multiReplace(e,"@A",p.toString()),W=u.multiReplace(W,"@A",p.toString())),M.codefield=x.WhereClause.create("CASE WHEN "+e+` THEN ${T} ELSE ${b} END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC);const n=F.cloneField(d.AdaptedFeatureSet.findField(E.associations.fields,A));n.name=k,n.alias=k,P=new d.SqlExpressionAdapted(n,x.WhereClause.create("CASE WHEN "+e+` THEN ${A} ELSE ${w} END`,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC));break}case"container":W=`${w}='${y}' AND ${N} = 2`,null!==p&&(W+=` AND ${C} = `+p.toString()),M.codefield=T,W="( "+W+" )",P=new d.FieldRename(d.AdaptedFeatureSet.findField(E.associations.fields,A),k,k);break;case"content":W=`(${A}='${y}' AND ${N} = 2)`,null!==p&&(W+=` AND ${D} = `+p.toString()),M.codefield=b,W="( "+W+" )",P=new d.FieldRename(d.AdaptedFeatureSet.findField(E.associations.fields,w),k,k);break;case"structure":W=`(${w}='${y}' AND ${N} = 3)`,null!==p&&(W+=` AND ${C} = `+p.toString()),M.codefield=T,W="( "+W+" )",P=new d.FieldRename(d.AdaptedFeatureSet.findField(E.associations.fields,A),k,R);break;case"attached":W=`(${A}='${y}' AND ${N} = 3)`,null!==p&&(W+=` AND ${D} = `+p.toString()),M.codefield=b,W="( "+W+" )",P=new d.FieldRename(d.AdaptedFeatureSet.findField(E.associations.fields,w),k,R);break;default:throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}h&&(W="1 <> 1");return new d.AdaptedFeatureSet({parentfeatureset:E.associations,adaptedFields:[new d.OriginalField(d.AdaptedFeatureSet.findField(E.associations.fields,v)),new d.OriginalField(d.AdaptedFeatureSet.findField(E.associations.fields,L)),P,$,M,U],extraFilter:W?x.WhereClause.create(W,E.associations.getFieldsIndex(),E.associations.dateFieldsTimeZoneDefaultUTC):null})}))},e.signatures.push({name:"featuresetbyassociation",min:2,max:6}),e.functions.groupby=function(t,n){return e.standardFunctionAsync(t,n,(async(a,o,s)=>{if(u.pcCheck(s,3,3,t,n),!u.isFeatureSet(s[0]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);const l=await s[0].load(),c=[],d=[];let f=!1,m=[];if(u.isString(s[1]))m.push(s[1]);else if(s[1]instanceof r)m.push(s[1]);else if(u.isArray(s[1]))m=s[1];else{if(!u.isImmutableArray(s[1]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);m=s[1].toArray()}for(const e of m)if(u.isString(e)){const t=x.WhereClause.create(u.toString(e),l.getFieldsIndex(),l.dateFieldsTimeZoneDefaultUTC),n=!0===g.isSingleField(t)?u.toString(e):"%%%%FIELDNAME";c.push({name:n,expression:t}),"%%%%FIELDNAME"===n&&(f=!0)}else{if(!(e instanceof r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",a=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(f=!0),!r)throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);c.push({name:r,expression:x.WhereClause.create(a||r,l.getFieldsIndex(),l.dateFieldsTimeZoneDefaultUTC)})}}if(m=[],u.isString(s[2]))m.push(s[2]);else if(u.isArray(s[2]))m=s[2];else if(u.isImmutableArray(s[2]))m=s[2].toArray();else{if(!(s[2]instanceof r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);m.push(s[2])}for(const e of m){if(!(e instanceof r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);{const r=e.hasField("name")?e.field("name"):"",a=e.hasField("statistic")?e.field("statistic"):"",o=e.hasField("expression")?e.field("expression"):"";if(!r||!a||!o)throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);d.push({name:r,statistic:a.toLowerCase(),expression:x.WhereClause.create(o,l.getFieldsIndex(),l.dateFieldsTimeZoneDefaultUTC)})}}if(f){const e={};for(const n of l.fields)e[n.name.toLowerCase()]=1;for(const n of c)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);for(const n of d)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of c)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}for(const n of c)await T(n.expression,e,t);for(const n of d)await T(n.expression,e,t);return s[0].groupby(c,d)}))},e.signatures.push({name:"groupby",min:3,max:3}),e.functions.distinct=function(t,n){return e.standardFunctionAsync(t,n,(async(a,o,s)=>{if(u.isFeatureSet(s[0])){u.pcCheck(s,2,2,t,n);const a=await s[0].load(),o=[];let l=[];if(u.isString(s[1]))l.push(s[1]);else if(s[1]instanceof r)l.push(s[1]);else if(u.isArray(s[1]))l=s[1];else{if(!u.isImmutableArray(s[1]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);l=s[1].toArray()}let c=!1;for(const e of l)if(u.isString(e)){const t=x.WhereClause.create(u.toString(e),a.getFieldsIndex(),a.dateFieldsTimeZoneDefaultUTC),n=!0===g.isSingleField(t)?u.toString(e):"%%%%FIELDNAME";o.push({name:n,expression:t}),"%%%%FIELDNAME"===n&&(c=!0)}else{if(!(e instanceof r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",s=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(c=!0),!r)throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);o.push({name:r,expression:x.WhereClause.create(s||r,a.getFieldsIndex(),a.dateFieldsTimeZoneDefaultUTC)})}}if(c){const e={};for(const n of a.fields)e[n.name.toLowerCase()]=1;for(const n of o)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of o)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}for(const n of o)await T(n.expression,e,t);return s[0].groupby(o,[])}return D("distinct",a,o,s)}))}),e.functions.getfeaturesetinfo=function(t,n){return e.standardFunctionAsync(t,n,(async(e,i,a)=>{if(u.pcCheck(a,1,1,t,n),!u.isFeatureSet(a[0]))return null;const o=await a[0].getFeatureSetInfo();return o?r.convertObjectToArcadeDictionary({layerId:o.layerId,layerName:o.layerName,itemId:o.itemId,serviceLayerUrl:o.serviceLayerUrl,webMapLayerId:o.webMapLayerId??null,webMapLayerTitle:o.webMapLayerTitle??null,className:null,objectClassId:null},u.defaultTimeZone(t),!1,!1):null}))},e.signatures.push({name:"getfeaturesetinfo",min:1,max:1})}e.registerFunctions=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
