/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../request","./executionError","./parser","./featureset/support/RecentlyUsedCache","../portal/Portal"],(function(e,r,t,o,s,l){"use strict";class i{constructor(e){this.portalUri=e}normalizeModuleUri(e){const r=/^[a-z0-9A-Z]+(@[0-9]+\.[0-9]+\.[0-9]+)?([\?|\/].*)?$/gi,o=/(?<portalurl>.+)\/home\/item\.html\?id\=(?<itemid>.+)$/gi,s=/(?<portalurl>.+)\/sharing\/rest\/content\/users\/[a-zA-Z0-9]+\/items\/(?<itemid>.+)$/gi,c=/(?<portalurl>.+)\/sharing\/rest\/content\/items\/(?<itemid>.+)$/gi,u=/(?<itemid>.*)@(?<versionstring>[0-9]+\.[0-9]+\.[0-9]+)([\?|\/].*)?$/gi;if(e.startsWith("portal+")){let i=e.substring(7),n="",a=i,d=!1;for(const e of[o,c,s]){const r=e.exec(i);if(null!==r){const e=r.groups;a=e.itemid,n=e.portalurl,d=!0;break}}if(!1===d){if(!r.test(i))throw new t.ModuleError(t.ModuleErrorCodes.UnsupportedUriProtocol,{uri:e});a=i,n=this.portalUri}a.includes("/")&&(a=a.split("/")[0]),a.includes("?")&&(a=a.split("?")[0]);let h="current";const m=u.exec(a);if(null!==m){const e=m.groups;a=e.itemid,h=e.versionstring}return i=new l({url:n}).restUrl+"/content/items/"+a+"/resources/"+h+".arc",{url:i,scheme:"portal",uri:"PO:"+i}}if(e.startsWith("mock")){if("mock"===e){return{url:"",scheme:"mock",data:'\n      export var hello = 1;\n      export function helloWorld() {\n          return "Hello World " + hello;\n      }\n  ',uri:"mock"}}const r=e.replace("mock:","");if(void 0!==i.mocks[r])return{url:"",scheme:"mock",data:i.mocks[r],uri:e}}throw new t.ModuleError(t.ModuleErrorCodes.UnrecognizedUri,{uri:e})}async fetchModule(e){const r=i.cachedModules.getFromCache(e.uri);if(r)return r;const t=this.fetchSource(e);i.cachedModules.addToCache(e.uri,t);let o=null;try{o=await t}catch(s){throw i.cachedModules.removeFromCache(e.uri),s}return o}async fetchSource(e){if("portal"===e.scheme){const t=await r(e.url,{responseType:"text",query:{}});if(t.data)return o.parseScript(t.data,[])}if("mock"===e.scheme)return o.parseScript(e.data??"",[]);throw new t.ModuleError(t.ModuleErrorCodes.UnsupportedUriProtocol)}static create(e){return new i(e)}static getDefault(){return this._default??(i._default=i._moduleResolverFactory())}static set moduleResolverClass(e){this._moduleResolverFactory=e,this._default=null}}i.mocks={},i.cachedModules=new s(30),i._default=null,i._moduleResolverFactory=()=>{const e=l.getDefault();return new i(e.url)},e.ArcadeModuleResolver=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
