/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","./ArcadeModule","./ArcadeModuleLoader","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/array","./functions/date","./functions/geomasync","./functions/geometry","./functions/maths","./functions/stats","./functions/string","../geometry/Geometry","../geometry/SpatialReference"],(function(e,r,t,o,n,i,a,c,u,s,l,d,E,f,p,w,x,h){"use strict";function m(e){return e&&"function"==typeof e.then}const g=100;async function v(e,r){const t=[];for(let o=0;o<r.arguments.length;o++)t.push(await S(e,r.arguments[o]));return t}async function y(e,r,t){if(!0===r.preparsed)return t(e,null,r.arguments);return t(e,r,await v(e,r))}class b extends a.ArcadeFunction{constructor(e,r){super(),this.definition=null,this.context=null,this.definition=e,this.context=r}createFunction(e){return(...r)=>{const t={spatialReference:this.context.spatialReference,console:this.context.console,lrucache:this.context.lrucache,timeZone:this.context.timeZone??null,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,localScope:{},depthCounter:{depth:e.depthCounter+1},globalScope:this.context.globalScope};if(t.depthCounter.depth>64)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.MaximumCallDepth,null);return Ee(this.definition,t,r,null)}}call(e,r){return C(e,r,((t,o,i)=>{const a={spatialReference:e.spatialReference,services:e.services,console:e.console,libraryResolver:e.libraryResolver,exports:e.exports,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1}};if(a.depthCounter.depth>64)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.MaximumCallDepth,r);return Ee(this.definition,a,i,r)}))}marshalledCall(e,r,t,o){return o(e,r,(async(n,i,u)=>{const s={spatialReference:e.spatialReference,globalScope:t.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,abortSignal:e.abortSignal,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:{}};return u=u.map((r=>!c.isFunctionParameter(r)||r instanceof a.ScopeMarshalledFunction?r:a.wrapModuleScopedResponse(r,e,o))),a.wrapModuleScopedResponse(await Ee(this.definition,s,u,r),t,o)}))}}class A extends r.ArcadeModule{constructor(e){super(e)}async global(e){const r=this.executingContext.globalScope[e.toLowerCase()];if(r.valueset||(r.value=await S(this.executingContext,r.node),r.valueset=!0),c.isFunctionParameter(r.value)&&!(r.value instanceof a.ScopeMarshalledFunction)){const e=new a.ScopeMarshalledFunction;e.fn=r.value,e.parameterEvaluator=C,e.context=this.executingContext,r.value=e}return r.value}setGlobal(e,r){if(c.isFunctionParameter(r))throw new n.ArcadeExecutionError(null,n.ExecutionErrorCodes.AssignModuleFunction,null);this.executingContext.globalScope[e.toLowerCase()]={value:r,valueset:!0,node:null}}hasGlobal(e){return void 0===this.executingContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.executingContext.exports[e]}async loadModule(e){let r=e.spatialReference;null==r&&(r=new h({wkid:102100})),this.moduleScope=we({},e.customfunctions,e.timeZone),this.executingContext={spatialReference:r,services:e.services,libraryResolver:new t.ArcadeModuleLoader(e.libraryResolver._moduleSingletons,this.source.syntax.loadedModules),exports:{},abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,globalScope:this.moduleScope,console:e.console??xe,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:null,depthCounter:{depth:1}},await S(this.executingContext,this.source.syntax)}}async function C(e,r,t){if(!0===r.preparsed){const o=t(e,null,r.arguments);return m(o),o}const o=t(e,r,await v(e,r));return m(o),o}async function S(e,r,t){if(r.breakpoint&&!0!==t){const t=r.breakpoint();return await t,S(e,r,!0)}try{switch(r?.type){case"VariableDeclarator":return await X(e,r);case"ImportDeclaration":return await Y(e,r);case"ExportNamedDeclaration":return await J(e,r);case"VariableDeclaration":return await Q(e,r,0);case"BlockStatement":case"Program":return await V(e,r);case"FunctionDeclaration":return await H(e,r);case"ReturnStatement":return await z(e,r);case"IfStatement":return await W(e,r);case"ExpressionStatement":return await U(e,r);case"UpdateExpression":return await q(e,r);case"AssignmentExpression":return await Z(e,r);case"ForStatement":return await k(e,r);case"WhileStatement":return await I(e,r);case"ForInStatement":return await D(e,r);case"BreakStatement":return c.breakResult;case"EmptyStatement":return c.voidOperation;case"ContinueStatement":return c.continueResult;case"TemplateElement":return await ae(e,r);case"TemplateLiteral":return await ue(e,r);case"Identifier":return await ne(e,r);case"MemberExpression":return await $(e,r);case"Literal":return r.value;case"CallExpression":return await ie(e,r);case"UnaryExpression":return await ee(e,r);case"BinaryExpression":return await te(e,r);case"LogicalExpression":return await oe(e,r);case"ArrayExpression":return await re(e,r);case"ObjectExpression":return await R(e,r);case"Property":return await F(e,r);default:throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.Unrecognized,r)}}catch(o){throw n.ensureArcadeExecutionError(e,r,o)}}async function R(e,r){const t=[];for(let o=0;o<r.properties.length;o++)t[o]=await S(e,r.properties[o]);const i={},a=new Map;for(let o=0;o<t.length;o++){const u=t[o];if(c.isFunctionParameter(u.value))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.NoFunctionInDictionary,r);if(!1===c.isString(u.key))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.KeyMustBeString,r);let s=u.key.toString();const l=s.toLowerCase();a.has(l)?s=a.get(l):a.set(l,s),u.value===c.voidOperation?i[s]=null:i[s]=u.value}const u=new o(i);return u.immutable=!1,u}async function F(e,r){const t=await S(e,r.value);if("Identifier"===r.key.type)return{key:r.key.name,value:t};return{key:await S(e,r.key),value:t}}async function I(e,r){const t={testResult:!0,lastAction:c.voidOperation};if(t.testResult=await S(e,r.test),!1===t.testResult)return c.voidOperation;if(!0!==t.testResult)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.BooleanConditionRequired,r);for(;!0===t.testResult&&(t.lastAction=await S(e,r.body),t.lastAction!==c.breakResult)&&!(t.lastAction instanceof c.ReturnResult);)if(t.testResult=await S(e,r.test),!0!==t.testResult&&!1!==t.testResult)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.BooleanConditionRequired,r);return t.lastAction instanceof c.ReturnResult?t.lastAction:c.voidOperation}async function N(e,r,t){const o=await S(e,r.body);return t.lastAction=o,t.lastAction===c.breakResult||t.lastAction instanceof c.ReturnResult?(t.testResult=!1,t):null!==r.update?(await S(e,r.update),t):t}async function O(e,r,t){if(null!==r.test){const o=await S(e,r.test);if(!0===e.abortSignal?.aborted)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.Cancelled,r);if(t.testResult=o,!1===t.testResult)return t;if(!0!==t.testResult)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.BooleanConditionRequired,r);return N(e,r,t)}return N(e,r,t)}function M(e,r,t,o,n,i){try{O(e,r,t).then((()=>{try{!0===t.testResult?++i>g?(i=0,setTimeout((()=>{M(e,r,t,o,n,i)}),0)):M(e,r,t,o,n,i):t.lastAction instanceof c.ReturnResult?o(t.lastAction):o(c.voidOperation)}catch(a){n(a)}}),(e=>{n(e)}))}catch(a){n(a)}}function k(e,r){try{return null!==r.init?S(e,r.init).then((()=>new Promise(((t,o)=>{const n={testResult:!0,lastAction:c.voidOperation};M(e,r,n,(e=>{t(e)}),(e=>{o(e)}),0)})))):new Promise(((t,o)=>{const n={testResult:!0,lastAction:c.voidOperation};M(e,r,n,(e=>{t(e)}),(e=>{o(e)}),0)}))}catch(t){return Promise.reject(t)}}function L(e,r,t,o,n,i,a,u,s,l){try{if(o<=i)return void u(c.voidOperation);n.value="k"===a?t[i]:i,S(e,r.body).then((d=>{try{d instanceof c.ReturnResult?u(d):d===c.breakResult?u(c.voidOperation):++l>g?(l=0,setTimeout((()=>{L(e,r,t,o,n,i+1,a,u,s,l)}),0)):L(e,r,t,o,n,i+1,a,u,s,l)}catch(E){s(E)}}),(e=>{s(e)}))}catch(d){s(d)}}function B(e,r,t,o,n,i,a,u,s){try{if(t.length()<=n)return void a(c.voidOperation);o.value="k"===i?t.get(n):n,S(e,r.body).then((l=>{l instanceof c.ReturnResult?a(l):l===c.breakResult?a(c.voidOperation):++s>g?(s=0,setTimeout((()=>{B(e,r,t,o,n+1,i,a,u,s)}),0)):B(e,r,t,o,n+1,i,a,u,s)}),(e=>{u(e)}))}catch(l){u(l)}}function P(e,r,t,o,n,i){try{if(void 0===i&&(i="i"),0===t.length)return void o.resolve(c.voidOperation);L(e,r,t,t.length,n,0,i,(e=>{o.resolve(e)}),(e=>{o.reject(e)}),0)}catch(a){o.reject(a)}}function j(e,r,t,o,n,i){try{if(void 0===i&&(i="i"),0===t.length)return void o.resolve(c.voidOperation);B(e,r,t,n,0,i,(e=>{o.resolve(e)}),(e=>{o.reject(e)}),0)}catch(a){o.reject(a)}}function T(e,r,t,o,n){try{P(e,r,t.keys(),o,n,"k")}catch(i){o.reject(i)}}function K(e,r,t,o,n,a,u,s){try{e.next().then((l=>{try{if(null===l)a(c.voidOperation);else{const d=i.createFromGraphicLikeObject(l.geometry,l.attributes,o,r.timeZone);d._underlyingGraphic=l,n.value=d;S(r,t.body).then((i=>{try{i===c.breakResult?a(c.voidOperation):i instanceof c.ReturnResult?a(i):++s>g?(s=0,setTimeout((()=>{K(e,r,t,o,n,a,u,s)}),0)):K(e,r,t,o,n,a,u,s)}catch(l){u(l)}}),(e=>{u(e)}))}}catch(d){u(d)}}),(e=>{u(e)}))}catch(l){u(l)}}async function D(e,r){return new Promise(((t,i)=>{S(e,r.right).then((a=>{try{let u=null;u="VariableDeclaration"===r.left.type?S(e,r.left):Promise.resolve(),u.then((()=>{try{let u="";if("VariableDeclaration"===r.left.type){const e=r.left.declarations[0].id;"Identifier"===e.type&&(u=e.name)}else"Identifier"===r.left.type&&(u=r.left.name);if(!u)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r);u=u.toLowerCase();let s=null;if(null!=e.localScope&&void 0!==e.localScope[u]&&(s=e.localScope[u]),null===s&&void 0!==e.globalScope[u]&&(s=e.globalScope[u]),null===s)return void i(new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r));c.isArray(a)||c.isString(a)?P(e,r,a,{reject:i,resolve:t},s):c.isImmutableArray(a)?j(e,r,a,{reject:i,resolve:t},s):a instanceof o||c.isFeature(a)?T(e,r,a,{reject:i,resolve:t},s):c.isFeatureSet(a)?K(a.iterator(e.abortSignal),e,r,a,s,(e=>{t(e)}),(e=>{i(e)}),0):P(e,r,[],{reject:i,resolve:t},s)}catch(u){i(u)}}),i)}catch(u){i(u)}}),i)}))}async function q(e,r){const t=r.argument;if("MemberExpression"===t.type){const i={t:null},a=await S(e,t.object);let u=null;i.t=a,!0===t.computed?u=await S(e,t.property):"Identifier"===t.property.type&&(u=t.property.name);const s=i.t;let l;if(c.isArray(s)){if(!c.isNumber(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.ArrayAccessorMustBeNumber,r);if(u<0&&(u=s.length+u),u<0||u>=s.length)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.OutOfBounds,r);l=c.toNumber(s[u]),s[u]="++"===r.operator?l+1:l-1}else if(s instanceof o){if(!1===c.isString(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==s.hasField(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FieldNotFound,r,{key:u});l=c.toNumber(s.field(u)),s.setField(u,"++"===r.operator?l+1:l-1)}else if(s instanceof A){if(!1===c.isString(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.ModuleAccessorMustBeString,r);if(!0!==s.hasGlobal(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.ModuleExportNotFound,r);l=c.toNumber(await s.global(u)),s.setGlobal(u,"++"===r.operator?l+1:l-1)}else{if(!c.isFeature(s))throw c.isImmutableArray(s)?new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.Immutable,r):new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidParameter,r);if(!1===c.isString(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==s.hasField(u))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FieldNotFound,r,{key:u});l=c.toNumber(s.field(u)),s.setField(u,"++"===r.operator?l+1:l-1)}return!1===r.prefix?l:"++"===r.operator?l+1:l-1}const i="Identifier"===r.argument.type?r.argument.name.toLowerCase():"";if(!i)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r);let a;if(null!=e.localScope&&void 0!==e.localScope[i])return a=c.toNumber(e.localScope[i].value),e.localScope[i]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},!1===r.prefix?a:"++"===r.operator?a+1:a-1;if(void 0!==e.globalScope[i])return a=c.toNumber(e.globalScope[i].value),e.globalScope[i]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},!1===r.prefix?a:"++"===r.operator?a+1:a-1;throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r)}function G(e,r,t,o,i){switch(r){case"=":return e===c.voidOperation?null:e;case"/=":return c.toNumber(t)/c.toNumber(e);case"*=":return c.toNumber(t)*c.toNumber(e);case"-=":return c.toNumber(t)-c.toNumber(e);case"+=":return c.isString(t)||c.isString(e)?c.toString(t)+c.toString(e):c.toNumber(t)+c.toNumber(e);case"%=":return c.toNumber(t)%c.toNumber(e);default:throw new n.ArcadeExecutionError(i,n.ExecutionErrorCodes.UnsupportedOperator,o)}}async function Z(e,r){const t=r.left;if("MemberExpression"===t.type){const i=await S(e,t.object);let a=null;if(!0===t.computed)a=await S(e,t.property);else{if("Identifier"!==t.property.type)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r);a=t.property.name}const u=await S(e,r.right);if(c.isArray(i)){if(!c.isNumber(a))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.ArrayAccessorMustBeNumber,r);if(a<0&&(a=i.length+a),a<0||a>i.length)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.OutOfBounds,r);if(a===i.length){if("="!==r.operator)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.OutOfBounds,r);i[a]=G(u,r.operator,i[a],r,e)}else i[a]=G(u,r.operator,i[a],r,e)}else if(i instanceof o){if(!1===c.isString(a))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0===i.hasField(a))i.setField(a,G(u,r.operator,i.field(a),r,e));else{if("="!==r.operator)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FieldNotFound,r,{key:a});i.setField(a,G(u,r.operator,null,r,e))}}else if(i instanceof A){if(!1===c.isString(a))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==i.hasGlobal(a))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.ModuleExportNotFound,r);i.setGlobal(a,G(u,r.operator,await i.global(a),r,e))}else{if(!c.isFeature(i))throw c.isImmutableArray(i)?new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.Immutable,r):new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidParameter,r);if(!1===c.isString(a))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0===i.hasField(a))i.setField(a,G(u,r.operator,i.field(a),r,e));else{if("="!==r.operator)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FieldNotFound,r,{key:a});i.setField(a,G(u,r.operator,null,r,e))}}return c.voidOperation}const i=t.name.toLowerCase();if(null!=e.localScope&&void 0!==e.localScope[i]){const t=await S(e,r.right);return e.localScope[i]={value:G(t,r.operator,e.localScope[i].value,r,e),valueset:!0,node:r.right},c.voidOperation}if(void 0!==e.globalScope[i]){const t=await S(e,r.right);return e.globalScope[i]={value:G(t,r.operator,e.globalScope[i].value,r,e),valueset:!0,node:r.right},c.voidOperation}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r)}async function U(e,r){if("AssignmentExpression"===r.expression.type)return S(e,r.expression);if("CallExpression"===r.expression.type){const t=await S(e,r.expression);return t===c.voidOperation?c.voidOperation:new c.ImplicitResult(t)}const t=await S(e,r.expression);return t===c.voidOperation?c.voidOperation:new c.ImplicitResult(t)}async function W(e,r){const t=await S(e,r.test);if(!0===t)return S(e,r.consequent);if(!1===t)return null!==r.alternate?S(e,r.alternate):c.voidOperation;throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.BooleanConditionRequired,r)}async function V(e,r){return _(e,r,0)}async function _(e,r,t){if(t>=r.body.length)return c.voidOperation;const o=await S(e,r.body[t]);return o instanceof c.ReturnResult||o===c.breakResult||o===c.continueResult||t===r.body.length-1?o:_(e,r,t+1)}async function z(e,r){if(null===r.argument)return new c.ReturnResult(c.voidOperation);const t=await S(e,r.argument);return new c.ReturnResult(t)}async function H(e,r){const t=r.id.name.toLowerCase();return e.globalScope[t]={valueset:!0,node:null,value:new b(r,e)},c.voidOperation}async function Y(e,r){const t=r.specifiers[0].local.name.toLowerCase(),o=e.libraryResolver.loadLibrary(t);let n=null;return e.libraryResolver._moduleSingletons?.has(o.uri)?n=e.libraryResolver._moduleSingletons.get(o.uri):(n=new A(o),await n.loadModule(e),e.libraryResolver._moduleSingletons?.set(o.uri,n)),e.globalScope[t]={value:n,valueset:!0,node:r},c.voidOperation}async function J(e,r){if(await S(e,r.declaration),"FunctionDeclaration"===r.declaration.type)e.exports[r.declaration.id.name.toLowerCase()]="function";else if("VariableDeclaration"===r.declaration.type)for(const t of r.declaration.declarations)e.exports[t.id.name.toLowerCase()]="variable";return c.voidOperation}async function Q(e,r,t){return t>=r.declarations.length?c.voidOperation:(await S(e,r.declarations[t]),t===r.declarations.length-1||await Q(e,r,t+1),c.voidOperation)}async function X(e,r){let t=null;if(t=null===r.init?null:await S(e,r.init),null!==e.localScope){if(t===c.voidOperation&&(t=null),"Identifier"!==r.id.type)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r);const o=r.id.name.toLowerCase();return null!=e.localScope&&(e.localScope[o]={value:t,valueset:!0,node:r.init}),c.voidOperation}if("Identifier"!==r.id.type)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r);const o=r.id.name.toLowerCase();return t===c.voidOperation&&(t=null),e.globalScope[o]={value:t,valueset:!0,node:r.init},c.voidOperation}async function $(e,r){const t=await S(e,r.object);if(null===t)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.MemberOfNull,r);if(!1===r.computed){if("Identifier"===r.property.type){if(t instanceof o||c.isFeature(t))return t.field(r.property.name);if(t instanceof x)return E.geometryMember(t,r.property.name,e,r);if(t instanceof A){if(!t.hasGlobal(r.property.name))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r);return t.global(r.property.name)}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}let i=await S(e,r.property);if(t instanceof o||c.isFeature(t)){if(c.isString(i))return t.field(i);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof A){if(c.isString(i))return t.global(i);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof x){if(c.isString(i))return E.geometryMember(t,i,e,r);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(c.isArray(t)){if(c.isNumber(i)&&isFinite(i)&&Math.floor(i)===i){if(i<0&&(i=t.length+i),i>=t.length||i<0)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.OutOfBounds,r);return t[i]}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(c.isImmutableArray(t)){if(c.isNumber(i)&&isFinite(i)&&Math.floor(i)===i){if(i<0&&(i=t.length()+i),i>=t.length()||i<0)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.OutOfBounds,r);return t.get(i)}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(c.isString(t)){if(c.isNumber(i)&&isFinite(i)&&Math.floor(i)===i){if(i<0&&(i=t.length+i),i>=t.length||i<0)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.OutOfBounds,r);return t[i]}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidMemberAccessKey,r)}async function ee(e,r){const t=await S(e,r.argument);if(c.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*c.toNumber(t);if("+"===r.operator)return 1*c.toNumber(t);if("~"===r.operator)return~c.toNumber(t);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}if("-"===r.operator)return-1*c.toNumber(t);if("+"===r.operator)return 1*c.toNumber(t);if("~"===r.operator)return~c.toNumber(t);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}async function re(e,r){const t=[];for(let o=0;o<r.elements.length;o++)t.push(await S(e,r.elements[o]));for(let o=0;o<t.length;o++){if(c.isFunctionParameter(t[o]))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.NoFunctionInArray,r);t[o]===c.voidOperation&&(t[o]=null)}return t}async function te(e,r){const t=[];t[0]=await S(e,r.left),t[1]=await S(e,r.right);const o=t[0],i=t[1];switch(r.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return c.binaryOperator(c.toNumber(o),c.toNumber(i),r.operator);case"==":return c.equalityTest(o,i);case"!=":return!c.equalityTest(o,i);case"<":case">":case"<=":case">=":return c.greaterThanLessThan(o,i,r.operator);case"+":return c.isString(o)||c.isString(i)?c.toString(o)+c.toString(i):c.toNumber(o)+c.toNumber(i);case"-":return c.toNumber(o)-c.toNumber(i);case"*":return c.toNumber(o)*c.toNumber(i);case"/":return c.toNumber(o)/c.toNumber(i);case"%":return c.toNumber(o)%c.toNumber(i);default:throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.UnsupportedOperator,r)}}async function oe(e,r){const t=await S(e,r.left);let o=null;if(!c.isBoolean(t))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r);switch(r.operator){case"||":if(!0===t)return t;if(o=await S(e,r.right),c.isBoolean(o))return o;throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.LogicExpressionOrAnd,r);case"&&":if(!1===t)return t;if(o=await S(e,r.right),c.isBoolean(o))return o;throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.LogicExpressionOrAnd,r);default:throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.LogicExpressionOrAnd,r)}}async function ne(e,r){const t=r.name.toLowerCase();if(null!=e.localScope&&void 0!==e.localScope[t]){const r=e.localScope[t];if(!0===r.valueset)return r.value;if(null!==r.d)return r.d;r.d=S(e,r.node);const o=await r.d;return r.value=o,r.valueset=!0,o}if(void 0!==e.globalScope[t]){const r=e.globalScope[t];if(!0===r.valueset)return r.value;if(null!==r.d)return r.d;r.d=S(e,r.node);const o=await r.d;return r.value=o,r.valueset=!0,o}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.InvalidIdentifier,r)}async function ie(e,r){if("MemberExpression"===r.callee.type){const t=await S(e,r.callee.object);if(!(t instanceof A))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FunctionNotFound,r);const o=!1===r.callee.computed?r.callee.property.name:await S(e,r.callee.property);if(!t.hasGlobal(o))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FunctionNotFound,r);const i=await t.global(o);if(!c.isFunctionParameter(i))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.CallNonFunction,r);return i.call(e,r)}if("Identifier"!==r.callee.type)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FunctionNotFound,r);if(null!=e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){const t=e.localScope[r.callee.name.toLowerCase()];if(c.isFunctionParameter(t.value))return t.value.call(e,r);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.CallNonFunction,r)}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){const t=e.globalScope[r.callee.name.toLowerCase()];if(c.isFunctionParameter(t.value))return t.value.call(e,r);throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.CallNonFunction,r)}throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.FunctionNotFound,r)}async function ae(e,r){return r.value?r.value.cooked:""}function ce(e,r,t){if(c.isFunctionParameter(e))throw new n.ArcadeExecutionError(r,n.ExecutionErrorCodes.NoFunctionInTemplateLiteral,t);return e}async function ue(e,r){const t=[];for(let i=0;i<r.expressions.length;i++){const o=await S(e,r.expressions[i]);t[i]=c.toString(o)}let o="",n=0;for(const i of r.quasis)if(o+=i.value?i.value.cooked:"",!1===i.tail){o+=t[n]?ce(t[n],e,r):"",n++}return o}const se={};async function le(e,r,t,o){const n=await S(e,r.arguments[t]);if(c.equalityTest(n,o))return S(e,r.arguments[t+1]);const i=r.arguments.length-t;return 1===i?S(e,r.arguments[t]):2===i?null:3===i?S(e,r.arguments[t+2]):le(e,r,t+2,o)}async function de(e,r,t,o){if(!0===o)return S(e,r.arguments[t+1]);if(3===r.arguments.length-t)return S(e,r.arguments[t+2]);const i=await S(e,r.arguments[t+2]);if(!1===c.isBoolean(i))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.ModuleExportNotFound,r.arguments[t+2]);return de(e,r,t+2,i)}async function Ee(e,r,t,o){const i=e.body;if(t.length!==e.params.length)throw new n.ArcadeExecutionError(r,n.ExecutionErrorCodes.WrongNumberOfParameters,null);for(let n=0;n<t.length;n++){const o=e.params[n];"Identifier"===o.type&&null!=r.localScope&&(r.localScope[o.name.toLowerCase()]={d:null,value:t[n],valueset:!0,node:null})}const a=await S(r,i);if(a instanceof c.ReturnResult)return a.value;if(a===c.breakResult)throw new n.ArcadeExecutionError(r,n.ExecutionErrorCodes.UnexpectedToken,o);if(a===c.continueResult)throw new n.ArcadeExecutionError(r,n.ExecutionErrorCodes.UnexpectedToken,o);return a instanceof c.ImplicitResult?a.value:a}l.registerFunctions(se,y),w.registerFunctions(se,y),f.registerFunctions(se,y),E.registerFunctions(se,y),p.registerFunctions(se,y),d.registerFunctions({functions:se,compiled:!1,signatures:null,evaluateIdentifier:null,mode:"async",standardFunction:y,standardFunctionAsync:C}),se.iif=async function(e,r){c.pcCheck(null===r.arguments?[]:r.arguments,3,3,e,r);const t=await S(e,r.arguments[0]);if(!1===c.isBoolean(t))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.BooleanConditionRequired,r);return S(e,t?r.arguments[1]:r.arguments[2])},se.decode=async function(e,r){if(r.arguments.length<2)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.WrongNumberOfParameters,r);if(2===r.arguments.length)return S(e,r.arguments[1]);if((r.arguments.length-1)%2==0)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.WrongNumberOfParameters,r);return le(e,r,1,await S(e,r.arguments[0]))},se.when=async function(e,r){if(r.arguments.length<3)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.WrongNumberOfParameters,r);if(r.arguments.length%2==0)throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.WrongNumberOfParameters,r);const t=await S(e,r.arguments[0]);if(!1===c.isBoolean(t))throw new n.ArcadeExecutionError(e,n.ExecutionErrorCodes.BooleanConditionRequired,r.arguments[0]);return de(e,r,0,t)};const fe={fixSpatialReference:c.fixSpatialReference,parseArguments:v,standardFunction:y,standardFunctionAsync:C,evaluateIdentifier:ne};for(const ve in se)se[ve]={value:new a.NativeFunction(se[ve]),valueset:!0,node:null};const pe=function(){};function we(e,r,t){const n=new pe;null==e&&(e={}),null==r&&(r={});const c=new o({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});c.immutable=!1,n.textformatting={value:c,valueset:!0,node:null};for(const o in r)n[o]={value:new a.NativeFunction(r[o]),native:!0,valueset:!0,node:null};for(const o in e)e[o]&&"esri.Graphic"===e[o].declaredClass?n[o]={value:i.createFromGraphic(e[o],t),valueset:!0,node:null}:n[o]={value:e[o],valueset:!0,node:null};return n}function xe(e){console.log(e)}pe.prototype=se,pe.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},pe.prototype.pi={value:Math.PI,valueset:!0,node:null};const he=fe;function me(e){const r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:y,standardFunctionAsync:C,evaluateIdentifier:ne};for(let t=0;t<e.length;t++)e[t].registerFunctions(r);for(const t in r.functions)se[t]={value:new a.NativeFunction(r.functions[t]),valueset:!0,node:null},pe.prototype[t]=se[t];for(let t=0;t<r.signatures.length;t++)u.addFunctionDeclaration(r.signatures[t],"async")}async function ge(e,r){let o=r.spatialReference;null==o&&(o=new h({wkid:102100}));let i=null;e.usesModules&&(i=new t.ArcadeModuleLoader(new Map,e.loadedModules));const a=we(r.vars,r.customfunctions,r.timeZone),u={spatialReference:o,services:r.services,exports:{},libraryResolver:i,abortSignal:void 0===r.abortSignal||null===r.abortSignal?{aborted:!1}:r.abortSignal,globalScope:a,console:r.console??xe,timeZone:r.timeZone??null,lrucache:r.lrucache,interceptor:r.interceptor,localScope:null,depthCounter:{depth:1}};let s=await S(u,e);if(s instanceof c.ReturnResult&&(s=s.value),s instanceof c.ImplicitResult&&(s=s.value),s===c.voidOperation&&(s=null),s===c.breakResult)throw new n.ArcadeExecutionError(u,n.ExecutionErrorCodes.IllegalResult,null);if(s===c.continueResult)throw new n.ArcadeExecutionError(u,n.ExecutionErrorCodes.IllegalResult,null);if(c.isFunctionParameter(s))throw new n.ArcadeExecutionError(u,n.ExecutionErrorCodes.IllegalResult,null);return s}me([s.ArrayFunctions]),e.executeScript=ge,e.extend=me,e.functionHelper=he,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
