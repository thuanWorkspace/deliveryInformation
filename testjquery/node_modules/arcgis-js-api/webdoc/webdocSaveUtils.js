/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../core/Error","../core/MultiOriginJSONSupport","../core/reactiveUtils","../core/urlUtils","../core/accessorSupport/originUtils","../geometry/SpatialReference","../geometry/support/spatialReferenceUtils","../geometry/support/webMercatorUtils","../layers/support/arcgisLayerUrl","../layers/support/layerUtils","../portal/Portal","../portal/PortalItem","../portal/support/portalItemUtils","../rest/geometryService/project","../rest/support/ProjectParameters","../support/basemapUtils","./saveAPIKeyUtils","./support/saveUtils"],(function(e,t,r,a,o,i,n,s,l,p,c,d,u,y,m,w,f,v,h,g){"use strict";const b=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));async function T(e,t,r){r??(r={}),K(e,t),await o.whenOnce((()=>!t.updatingFromView)),await t.load(),await P(t),await g.beforeSave(t),await S(e,t);const a=t.portalItem,n=i.urlToObject(a.itemUrl),s={origin:"web-map",messages:[],writtenProperties:[],url:n,portal:a.portal||u.getDefault(),portalItem:a,verifyItemRelativeUrls:n?{rootPath:n.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l=t.write({},s);return await Promise.all(s.resources.pendingOperations),U(e,s,r),await W(t,a),await ie(e,t,a,l,s),await Promise.all([t.updateItemThumbnail(),g.saveResources(t.resourceReferences,s,null)]),a}async function R(e,t,r,a){a??(a={});const i=O(e,r);await o.whenOnce((()=>!t.updatingFromView)),await t.load(),await P(t),await g.beforeSave(t),await S(e,t);const n={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:i.portal,portalItem:i,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},s=t.write({},n);await Promise.all(n.resources.pendingOperations),U(e,n,a),await j(t,i);const l=t.getThumbnailState();return await ne(e,t,i,s,n,a)&&(t.resourceReferences.portalItem=i),t.restoreThumbnailFromState(l),await Promise.all([t.updateItemThumbnail(),g.saveResources(t.resourceReferences,n,null)]),i}function K(e,t){if(!t.portalItem)throw new r(`${e.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");h.validateSaveAPIKey(t.portalItem),_(e,t.portalItem)}function _(e,t){if(t.type!==e.itemType)throw new r(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function S(e,t){if(!t.basemap?.baseLayers.length)throw new r(`${e.name}:save`,"Map does not have a valid basemap with a base layer.");let a=null;if(await o.whenOnce((()=>{const e=v.findSpatialReference(t.initialViewProperties,t.basemap);return a=e.spatialReference,!e.updating})),!l.equals(a,t.initialViewProperties.spatialReference))throw new r(`${e.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:t.initialViewProperties.spatialReference,actual:a})}function O(e,t){let r=y.from(t);return r.id&&(r=r.clone(),r.id=null),r.type||(r.type=e.itemType),r.portal||(r.portal=u.getDefault()),h.validateSaveAPIKey(r),_(e,r),r}function P(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then((()=>{}))}function U(e,t,a){let o=(t.messages??[]).filter((e=>"error"===e.type)).map((e=>new r(e.name,e.message,e.details)));if(t.blockedRelativeUrls&&(o=o.concat(t.blockedRelativeUrls.map((e=>new r("url:unsupported",`Relative url '${e}' is not supported in Web Map`))))),a.ignoreUnsupported&&(o=o.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name))),o.length>0)throw new r(`${e.name}:save`,"Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:o})}async function W(e,t){t.extent=await ee(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await N(e,t)}const A=m.TypeKeyword.JSAPI,I="CollectorDisabled",L="Collector",M="Data Editing",D="OfflineDisabled",k="Offline",C="Workforce Project",E="Workforce Worker",G="Workforce Dispatcher",V="Offline Map Areas",B="FieldMapsDisabled",F=m.TypeKeyword.DEVELOPER_BASEMAP,$="UtilityNetwork";async function j(e,t){m.removeTypeKeyword(t,I),m.removeTypeKeyword(t,B),m.removeTypeKeyword(t,m.TypeKeyword.METADATA),m.removeTypeKeyword(t,D),m.removeTypeKeyword(t,V),m.removeTypeKeyword(t,G),m.removeTypeKeyword(t,C),m.removeTypeKeyword(t,E),await W(e,t)}async function N(e,t){m.addTypeKeyword(t,A),await x(e),z(e,t),Q(e,t),X(e,t),Y(e,t),Z(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function x(e){const t=J(e).map((e=>e.load())).toArray();return Promise.allSettled(t).then((()=>{}))}function J(e){return e.allLayers.concat(e.allTables)}function q(e){return J(e).some((e=>e.loaded&&d.isLayerWithFeatureLayerSource(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}function H(e){return J(e).filter((e=>"group"!==e.type)).every((t=>t.loaded&&ae(e,t)))}function z(e,t){m.hasTypeKeyword(t,I)||m.hasTypeKeyword(t,C)||m.hasTypeKeyword(t,E)||m.hasTypeKeyword(t,G)||!q(e)?m.removeTypeKeyword(t,L):m.addTypeKeyword(t,L)}function Q(e,t){q(e)?m.addTypeKeyword(t,M):m.removeTypeKeyword(t,M)}function X(e,t){!m.hasTypeKeyword(t,D)&&H(e)?m.addTypeKeyword(t,k):m.removeTypeKeyword(t,k)}function Y(e,t){v.hasDeveloperBasemapLayer(e.basemap)?m.addTypeKeyword(t,F):m.removeTypeKeyword(t,F)}function Z(e,t){e.utilityNetworks?.length?m.addTypeKeyword(t,$):m.removeTypeKeyword(t,$)}async function ee(e,t){const r=t.clone().normalize();let a;if(r.length>1)for(const o of r)a?o.width>a.width&&(a=o):a=o;else a=r[0];return te(e,a)}async function te(t,r){const a=r.spatialReference;if(a.isWGS84)return r.clone();if(a.isWebMercator)return p.webMercatorToGeographic(r);const{getGeometryServiceURL:o}=await new Promise(((t,r)=>e(["../portal/support/geometryServiceUtils"],t,r))),i=await o(t),n=new f;n.geometries=[r],n.outSpatialReference=s.WGS84;return(await w.project(i,n))[0]}function re(e){return d.isFeatureCollectionLayer(e)||"map-notes"===e.type||"route"===e.type}function ae(e,t){return d.isLayerWithFeatureLayerSource(t)&&t.capabilities.operations.supportsSync||re(t)&&!t.portalItem||("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||oe(t)||v.isDeveloperBasemapLayer(t))&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function oe(e){return"tile"===e.type&&(c.isServerOrServicesAGOLUrl(e.url)&&b.some((t=>e.url?.toLowerCase().includes("/"+t+"/"))))}async function ie(e,t,r,a,o){await r.update({data:a}),pe(e,t,r,a,o)}async function ne(e,t,a,o,i,n){const s=t.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},p=a.portal;await p.signIn();const{copyAllowed:c,itemReloaded:d}=await se(l,p);if(l.authenticated||(l.authenticated=d),!c)throw new r(`${e.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const u=await le(a,l,o,n);return t.portalItem=a,pe(e,t,a,o,i),u}async function se(e,t){const{item:r,authenticated:a}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(a||await r.reload(),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function le(e,t,r,a){const o=e.portal,{item:n}=t,{folder:s,copyAllResources:l}=a;let p=!1;if(l&&n?.id&&i.hasSameCanonicalPortal(n.portal.url,o.url)&&parseInt(n.portal.currentVersion,10)>=2023){const{total:e}=await n.fetchResources();p=!!e}if(p){const t=await n.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const a=e.toJSON();await e.load(),e.read(a),await e.update({data:r})}else await(o.user?.addItem({item:e,folder:s,data:r}));return p}function pe(e,t,r,o,s){a.MultiOriginJSONSupport.prototype.read.call(t,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:r.itemUrl?i.urlToObject(r.itemUrl):void 0}),n.updateOrigins(s),t.resourceInfo=o}t.save=T,t.saveAs=R,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
