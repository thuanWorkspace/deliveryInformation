/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/asyncUtils","../../core/Error","../../core/promiseUtils","../../core/uuid","../../portal/support/resourceUtils"],(function(e,r,t,o,s,a){"use strict";async function n(e,r,t=null){const o=await u(e,r,t);await i(o,r,t)}async function c(e,r,t,o,s=null){const a=await u(t,o,s);await e.update({data:r}),await i(a,o,s)}async function u(e,r,n=null){if(!r?.resources)return;const c=r.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=r.portalItem;const u=new Set(r.resources.toKeep.map((e=>e.resource.path))),i=new Set,h=[];u.forEach((r=>{c.delete(r),e.paths.push(r)}));for(const t of r.resources.toUpdate)if(c.delete(t.resource.path),u.has(t.resource.path)||i.has(t.resource.path)){const{resource:r,content:o,finish:c,error:u}=t,i=a.getSiblingOfSameTypeI(r,s.generateUUID());e.paths.push(i.path),h.push(p({resource:i,content:o,compress:t.compress,finish:c,error:u},n))}else e.paths.push(t.resource.path),h.push(l(t,n)),i.add(t.resource.path);for(const t of r.resources.toAdd)e.paths.push(t.resource.path),c.has(t.resource.path)?c.delete(t.resource.path):h.push(p(t,n));if(0===h.length)return c;const f=await o.allSettledErrors(h);if(o.throwIfAborted(n),f.length>0)throw new t("save:resources","Failed to save one or more resources",{errors:f});return c}async function i(e,r,t=null){if(!e||!r.portalItem)return;const s=[];for(const o of e){const e=r.portalItem.resourceFromPath(o);s.push(e.portalItem.removeResource(e,t))}await o.eachAlways(s)}async function p(e,t){const o={...null!=t?t:{},compress:e.compress},s=await r.result(e.resource.portalItem.addResource(e.resource,await a.contentToBlob(e.content),o));if(!0!==s.ok)throw e.error?.(s.error),s.error;e.finish?.(e.resource)}async function l(e,t){const o=await r.result(e.resource.update(await a.contentToBlob(e.content),t));if(!0!==o.ok)throw e.error?.(o.error),o.error;e.finish?.(e.resource)}async function h(e){const r=[];for(const t of e.allLayers)if("beforeSave"in t&&"function"==typeof t.beforeSave){const e=t.beforeSave();e&&r.push(e)}await Promise.allSettled(r)}e.beforeSave=h,e.saveResources=n,e.updateItemWithResources=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
