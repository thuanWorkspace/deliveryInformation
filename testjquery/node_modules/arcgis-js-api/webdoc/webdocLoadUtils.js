/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../Viewpoint","../core/Error","../core/Logger","../core/urlUtils","../geometry/support/webMercatorUtils","../portal/Portal","../rest/geometryService/project","../rest/support/ProjectParameters"],(function(e,t,r,o,a,n,i,l,s,c){"use strict";function p(e,t){return t.resourceInfo?u(t,t.resourceInfo,{origin:e.origin}):t.portalItem?.id?m(e,t,t.portalItem):Promise.resolve()}function u(t,r,o){const a={context:{...o,layerContainerType:"operational-layers"}};return t.portalItem&&(a.context.portal=t.portalItem.portal||l.getDefault()),new Promise(((t,r)=>e(["../layers/support/layersCreator"],t,r))).then((({populateOperationalLayers:e})=>{const o=[],n=r.operationalLayers;n?.length&&o.push(e(t.layers,n,a));const i={...a,context:{...a.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},l=r.tables;return l?.length&&o.push(e(t.tables,l,i)),Promise.allSettled(o).then((()=>{}))}))}async function m(e,t,r){if(await r.load().catch((t=>{throw new o(`${e.name}:load-portal-item`,"Failed to load portal item",{error:t})})),r.type!==e.itemType)throw new o(`${e.name}:invalid-portal-item`,`Invalid portal item type '${r.type}', expected '${e.itemType}'`,{type:r.type});const i=await r.fetchData();t.resourceInfo=i;const s={origin:e.origin,url:n.urlToObject(r.itemUrl),portal:r.portal||l.getDefault(),portalItem:r,readResourcePaths:[]};await y(e,t,i,s),t.resourceReferences={portalItem:r,paths:s.readResourcePaths};const c=await g(t.initialViewProperties,r,a.getLogger(t));if(c){const r=t.initialViewProperties?.clone()??e.createInitialViewProperties();r.viewpoint=c,t.initialViewProperties=r}}function y(e,t,r,o){const a=f(e,r);return t.read(a,o),u(t,a,o)}function f(e,t){const r=e.parseVersion(t.version||"",e.name);return e.currentVersion.validate(r),t.version=`${r.major}.${r.minor}`,t}async function g(e,t,o){const a=e?.viewpoint?.targetGeometry;if(a)return null;const n=await w(e,t,o);if(!n)return null;return new r({targetGeometry:n})}async function w(t,r,o){const a=t?.spatialReference,n=r?.extent;if(!a||!n)return null;if(a.isWGS84)return n.clone();if(a.isWebMercator)return i.geographicToWebMercator(n);const{getGeometryServiceURL:l}=await new Promise(((t,r)=>e(["../portal/support/geometryServiceUtils"],t,r)));try{const e=await l(r),t=new c;t.geometries=[n],t.outSpatialReference=a;return(await s.project(e,t))[0]}catch(p){o.error("Error projecting item's extent:",p)}return null}t.loadFromSource=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
