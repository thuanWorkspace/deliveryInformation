/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/LRUCache","../../../../core/MapUtils","../../../../core/promiseUtils","../../../../core/unitUtils","../../../../symbols/support/unitConversionUtils"],(function(e,t,n,s,o,i,a){"use strict";function r(e=!1,t){if(e){const{elevationInfo:e,alignPointsInFeatures:n}=t;return new d(e,n)}return new c}class c{async alignCandidates(e,t,n){return e}notifyElevationSourceChange(){}}const l=1024;class d{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new n.LRUCache(l),this._cacheVersion=0}async alignCandidates(e,t,n){const s=this._elevationInfo;return null==s||"absolute-height"!==s.mode||s.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(this._alignAbsoluteElevationCandidates(e,t,s),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}_alignAbsoluteElevationCandidates(e,t,n){const{offset:s,unit:o}=n;if(null==s)return;const r=i.getMetersPerVerticalUnitForSR(t),c=o??"meters",l=s*(a.getMetersPerUnit(c)/r);for(const i of e)switch(i.type){case"edge":i.start.z+=l,i.end.z+=l;continue;case"vertex":i.target.z+=l;continue}}async _alignComputedElevationCandidates(e,t,n){const i=new Map;for(const o of e)s.getOrCreateMapValue(i,o.objectId,p).push(o);const[a,r,c]=this._prepareQuery(i,t),l=await this._alignPointsInFeatures(a,n);o.throwIfAborted(n);if(c!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t,n);this._applyCacheAndResponse(a,l,r);const{drapedObjectIds:d,failedObjectIds:u}=l,h=[];for(const s of e){const{objectId:e}=s;d.has(e)&&"edge"===s.type&&(s.draped=!0),u.has(e)||h.push(s)}return h}_prepareQuery(e,t){const n=[],s=[];for(const[o,i]of e){const e=[];for(const t of i)this._addToQueriesOrCachedResult(o,t.target,e,s),"edge"===t.type&&(this._addToQueriesOrCachedResult(o,t.start,e,s),this._addToQueriesOrCachedResult(o,t.end,e,s));0!==e.length&&n.push({objectId:o,points:e})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},s,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,s){const o=h(e,t),i=this._alignmentsCache.get(o);null==i?n.push(t):s.push(new u(t,i))}_applyCacheAndResponse(e,{elevations:t,drapedObjectIds:n,failedObjectIds:s},o){for(const r of o)r.apply();let i=0;const a=this._alignmentsCache;for(const{objectId:r,points:c}of e.pointsInFeatures){if(s.has(r)){i+=c.length;continue}const e=!n.has(r);for(const n of c){const s=h(r,n),o=t[i++];n.z=o,e&&a.put(s,o,1)}}}}class u{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}}function h(e,{x:t,y:n,z:s,spatialReference:o}){return`${e}-${t}-${n}-${s??0}}-wkid:${o?.wkid}`}function p(){return[]}e.getSnappingCandidateElevationAligner=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
