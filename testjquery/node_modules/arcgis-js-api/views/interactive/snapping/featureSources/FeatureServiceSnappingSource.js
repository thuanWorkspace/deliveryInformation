/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/handleUtils","../../../../core/memoize","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/support/layerUtils","../../../../support/elevationInfoUtils","../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D","../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D","../snappingUtils","./queryEngineUtils","./WorkerTileTreeDebugger","./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle","./featureServiceSource/FeatureServiceTilesSimple","../../../support/debugFlags"],(function(e,r,t,i,a,n,o,s,l,u,p,d,c,y,h,S,g,_,f,v,w,m,b,F,H){"use strict";r.FeatureServiceSnappingSource=class extends i{get _updateTilesParameters(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}get _layerView(){return this.view?.allLayerViews.find((e=>e.layer===this._layer))}get _isSuspended(){if(S.isSubtypeGroupLayer(this._layer)){if(!this._layer.sublayers.find((e=>e.visible)))return!0}return!!this.view&&(!1!==this._layerView?.suspended||!this.layerSource.enabled)}get updating(){return this._workerHandle?.updating||this._updatingHandles.updating}get _outFields(){const{view:e,_layerView:r,layerSource:t}=this,{layer:i}=t,{fieldsIndex:a,timeInfo:n,floorInfo:o,subtypeField:s}=i,l=r&&"filter"in r?r.filter:null,u=l?.where&&"1=1"!==l.where?this._getOrLoadWhereFields(l.where,a):[];if(l?.timeExtent&&n){const{startField:e,endField:r}=n,t=a.get(e)?.name??e,i=a.get(r)?.name??r;t&&u.push(t),i&&u.push(i)}if(e?.map&&v.isUtilityNetworkWebMap(e.map)&&e.map.utilityNetworks?.find((e=>e.isUtilityLayer(i)))){const e=i.fieldsIndex.get("assetGroup")?.name,r=i.fieldsIndex.get("assetType")?.name;e&&r&&(u.push(e),u.push(r))}if(i&&o?.floorField&&e?.floors?.length){const e=a.get(o.floorField)?.name??o.floorField;e&&u.push(e)}if(s){const e=a.get(s)?.name??s;e&&u.push(e)}return new Set(u)}get configuration(){const{view:e}=this,r=null!=e?e.type:"2d";return{filter:this._layer.createQuery(),customParameters:this._layer.customParameters,viewType:r}}get availability(){return this._workerHandle?.availability??0}get _layer(){return this.layerSource.layer}constructor(e){super(e),this._updatingHandles=new h.UpdatingHandles,this._workerHandle=null,this._debug=null,this._memoizedMakeGetGroundElevation=o.memoize(w.makeGetGroundElevation)}initialize(){let e;const r=this.view;if(null!=r)switch(r.type){case"2d":this._tilesOfInterest=new _.FeatureServiceTiles2D({view:r,layer:this._layer}),e=this._workerHandle=new b.FeatureServiceSnappingSourceWorkerHandle;break;case"3d":{const{resourceController:t}=r,i=this._layer;this._tilesOfInterest=new f.FeatureServiceTiles3D({view:r}),e=this._workerHandle=new b.FeatureServiceSnappingSourceWorkerHandle({schedule:e=>t.immediate.schedule(e),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:async(e,t)=>{const a=await r.whenLayerView(i);return s.throwIfAborted(t),a.elevationAlignPointsInFeatures(e,t)},queryForSymbologySnapping:async(e,t)=>{const a=await r.whenLayerView(i);return s.throwIfAborted(t),a.queryForSymbologySnapping(e,t)}}),this.addHandles([r.elevationProvider.on("elevation-change",(({context:r})=>{const{elevationInfo:t}=i;g.elevationContextAffectsAlignment(r,t)&&s.ignoreAbortErrors(e.notifyElevationSourceChange())})),l.watch((()=>i.elevationInfo),(()=>s.ignoreAbortErrors(e.notifyElevationSourceChange())),l.initial),l.watch((()=>this._layerView?.processor?.renderer),(()=>s.ignoreAbortErrors(e.notifySymbologyChange())),l.initial),l.watch((()=>this._layerView?.symbologySnappingSupported??!1),(r=>s.ignoreAbortErrors(e.setSymbologySnappingSupported(r))),l.initial),l.on((()=>this._layerView?.layer),["edits","apply-edits","graphic-update"],(()=>e.notifySymbologyChange()))]);break}}else this._tilesOfInterest=new F.FeatureServiceTilesSimple({layer:this._layer}),e=this._workerHandle=new b.FeatureServiceSnappingSourceWorkerHandle;this.addHandles([n.destroyHandle(e)]),s.ignoreAbortErrors(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this._updatingHandles.add((()=>this._updateTilesParameters),(()=>s.ignoreAbortErrors(e.updateTiles(this._updateTilesParameters,null))),l.initial),this.addHandles([l.watch((()=>this.configuration),(r=>s.ignoreAbortErrors(e.configure(r,null))),l.sync),l.watch((()=>this._outFields),(r=>s.ignoreAbortErrors(e.updateOutFields(r))),l.initial),l.watch((()=>this._isSuspended),(r=>s.ignoreAbortErrors(e.setSuspended(r))),l.syncAndInitial)]),null!=r&&this.addHandles(l.watch((()=>H.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES),(t=>{t&&!this._debug?(this._debug=new m.WorkerTileTreeDebugger({view:r,handle:e}),this.addHandles(n.destroyHandle(this._debug),"debug")):!t&&this._debug&&this.removeHandles("debug")}),l.initial)),this.addHandles(this.layerSource.layer.on("apply-edits",(r=>{s.ignoreAbortErrors(e.applyEdits(r,null))})))}destroy(){this._updatingHandles.destroy()}refresh(){this._workerHandle?.refresh(null)}async fetchCandidates(e,r){const{coordinateHelper:t,point:i}=e;this._tilesOfInterest.pointOfInterest=t.arrayToPoint(i);const a=this._memoizedMakeGetGroundElevation(this.view,t.spatialReference);return(await this._workerHandle.fetchCandidates({...e},r)).candidates.map((e=>w.convertSnappingCandidate(e,a)))}getDebugInfo(e){return this._workerHandle.getDebugInfo(e)}_getOrLoadWhereFields(r,t){const{_whereModule:i}=this;if(!this._loadWhereModuleTask&&!i){const r=a.createTask((async()=>{const r=await new Promise(((r,t)=>e(["../../../../core/sql/WhereClause"],r,t)));return this._whereModule=r.WhereClause,this._whereModule}));return this._loadWhereModuleTask=r,this._updatingHandles.addPromise(r.promise),[]}if(!i)return[];try{return i.create(r,t).fieldNames}catch(n){return[]}}},t.__decorate([u.property({constructOnly:!0})],r.FeatureServiceSnappingSource.prototype,"spatialReference",void 0),t.__decorate([u.property({constructOnly:!0})],r.FeatureServiceSnappingSource.prototype,"layerSource",void 0),t.__decorate([u.property({constructOnly:!0})],r.FeatureServiceSnappingSource.prototype,"view",void 0),t.__decorate([u.property()],r.FeatureServiceSnappingSource.prototype,"_tilesOfInterest",void 0),t.__decorate([u.property({readOnly:!0})],r.FeatureServiceSnappingSource.prototype,"_updateTilesParameters",null),t.__decorate([u.property()],r.FeatureServiceSnappingSource.prototype,"_layerView",null),t.__decorate([u.property()],r.FeatureServiceSnappingSource.prototype,"_isSuspended",null),t.__decorate([u.property({readOnly:!0})],r.FeatureServiceSnappingSource.prototype,"updating",null),t.__decorate([u.property()],r.FeatureServiceSnappingSource.prototype,"_outFields",null),t.__decorate([u.property({readOnly:!0})],r.FeatureServiceSnappingSource.prototype,"configuration",null),t.__decorate([u.property({readOnly:!0})],r.FeatureServiceSnappingSource.prototype,"availability",null),t.__decorate([u.property()],r.FeatureServiceSnappingSource.prototype,"_loadWhereModuleTask",void 0),t.__decorate([u.property()],r.FeatureServiceSnappingSource.prototype,"_whereModule",void 0),r.FeatureServiceSnappingSource=t.__decorate([y.subclass("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],r.FeatureServiceSnappingSource),Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
