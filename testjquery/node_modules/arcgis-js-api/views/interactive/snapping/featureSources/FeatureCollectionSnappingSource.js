/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/memoize","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../support/elevationInfoUtils","../snappingUtils","./queryEngineUtils","./snappingCandidateElevationAlignment","./snappingCandidateElevationFilter","./symbologySnappingCandidates"],(function(e,t,n,i,o,r,a,p,l,s,c,y,g,u,d,S,h){"use strict";e.FeatureCollectionSnappingSource=class extends n{get availability(){return 1}get updating(){return this.layerSource.updating}get _snappingElevationAligner(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;if(!n||"subtype-group"===t.type)return d.getSnappingCandidateElevationAligner();const i=async(n,i)=>(await o.whenOrAbort(e.whenLayerView(t),i)).elevationAlignPointsInFeatures(n,i);return d.getSnappingCandidateElevationAligner(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:i})}get _snappingElevationFilter(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"subtype-group"!==this.layerSource.layer.type;return S.getSnappingCandidateElevationFilter(t)}get _symbologySnappingFetcher(){const{view:e}=this,{layer:t}=this.layerSource;return null!=e&&"3d"===e.type&&"subtype-group"!==t.type?h.getSymbologySnappingCandidatesFetcher(this._symbologySnappingSupported,(async(n,i)=>{const r=await e.whenLayerView(t);return o.throwIfAborted(i),r.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},i)})):h.getSymbologySnappingCandidatesFetcher()}get _symbologySnappingSupported(){return null!=this._layerView3D&&this._layerView3D.symbologySnappingSupported}initialize(){const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"subtype-group"!==t.type&&(e.whenLayerView(t).then((e=>this._layerView3D=e)),this.addHandles([e.elevationProvider.on("elevation-change",(({context:e})=>{const{elevationInfo:n}=t;y.elevationContextAffectsAlignment(e,n)&&this._snappingElevationAligner.notifyElevationSourceChange()})),r.watch((()=>t.elevationInfo),(()=>this._snappingElevationAligner.notifyElevationSourceChange()),r.initial),r.watch((()=>null!=this._layerView3D?this._layerView3D.processor?.renderer:null),(()=>this._symbologySnappingFetcher.notifySymbologyChange()),r.initial),r.on((()=>this._layerView3D?.layer),["edits","apply-edits","graphic-update"],(()=>this._symbologySnappingFetcher.notifySymbologyChange()))]))}constructor(e){super(e),this.view=null,this._layerView3D=null,this._memoizedMakeGetGroundElevation=i.memoize(u.makeGetGroundElevation)}refresh(){}async fetchCandidates(e,t){const{layer:n}=this.layerSource,i=n.source;if(!i?.querySnapping)return[];const r=g.makeFilter(n),a=g.makeSnappingQuery(e,this.view?.type??"2d",r),p=await i.querySnapping(a,{signal:t});o.throwIfAborted(t);const l=e.coordinateHelper.spatialReference,s=await this._snappingElevationAligner.alignCandidates(p.candidates,l,t);o.throwIfAborted(t);const c=await this._symbologySnappingFetcher.fetch(s,t);o.throwIfAborted(t);const y=0===c.length?s:[...s,...c],d=this._snappingElevationFilter.filter(a,y),S=this._memoizedMakeGetGroundElevation(this.view,l);return d.map((e=>u.convertSnappingCandidate(e,S)))}},t.__decorate([a.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"layerSource",void 0),t.__decorate([a.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"view",void 0),t.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationAligner",null),t.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationFilter",null),t.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingFetcher",null),t.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_layerView3D",void 0),t.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingSupported",null),e.FeatureCollectionSnappingSource=t.__decorate([c.subclass("esri.views.interactive.snapping.featureSources.FeatureCollectionSnappingSource")],e.FeatureCollectionSnappingSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
