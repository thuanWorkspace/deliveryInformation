/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../geometry/projection","../../../support/elevationInfoUtils","../sketch/normalizedPoint","./Settings","./SnappingDomain","./snappingFactory","./SnappingOptions","./snappingPointUtils","./snappingUtils","./candidates/IntersectionSnappingCandidate","../support/viewUtils"],(function(e,t,n,i,s,a,r,o,p,c,d,h,l,u,g,f,_,S,v,y,C,P){"use strict";var m;e.SnappingManager=class extends(i.EventedMixin(n)){constructor(e){super(e),this.options=new S,this.snappingEnginesFactory=_.defaultSnappingEnginesFactory,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=m.MAIN}initialize(){this.addHandles([a.watch((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:i}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")}),a.sync),a.watch((()=>this.options),(e=>{for(const t of this._engines)t.options=e}),a.sync),a.watch((()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory})),(({viewReady:e,snappingEnginesFactory:t})=>this._recreateEngines(e,t)),a.syncAndInitial)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some((e=>e.updating))}_recreateEngines(e,t){if(this._destroyEngines(),!e)return;const{view:n,options:i}=this;this._engines=t(n,i)}_destroyEngines(){for(const e of this._engines)e.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}get _squaredSatisfiesConstraintThreshold(){return g.defaults.satisfiesConstraintScreenThreshold*g.defaults.satisfiesConstraintScreenThreshold}snap(e){return I(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:n}=e;this._removeVisualization();const i=this._currentMainCandidate;if(null==i)return t;const s=this._selectUpdateInput(e);if(null==s)return t;const{spatialReference:a}=n,r=h.project(s,a);if(null==r)return t;const{view:o}=this,{elevationInfo:p,visualizer:c}=n,d=[],l=u.fromPoint(r,o,p),g=i.constraint.closestTo(l);if(!this._arePointsWithinScreenThreshold(l,g,n))return this._resetSnappingState(),t;i.targetPoint=g,d.push(...i.hints);for(const h of this._currentOtherActiveCandidates)h.targetPoint=g,d.push(...h.hints);return null!=c&&this.addHandles(c.draw(d,{spatialReference:a,elevationInfo:T(n),view:o,selfSnappingZ:n.selfSnappingZ}),M),v.snappingPointToSnappingOutput(g,o,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:p})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case m.MAIN:return e;case m.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=m.MAIN}_removeVisualization(){this.removeHandles(M)}async _snapSinglePoint({point:e,context:t,signal:n}){const{view:i}=this,{elevationInfo:s}=t,a=u.fromPoint(e,i,s),r=await this._fetchCandidates(a,f.SnappingDomain.ALL,t,n);return this._createSnapResult(a,m.MAIN,r,i,t,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:s},n)}async _snapMultiPoint({point:e,scenePoint:t,context:n,signal:i}){const{view:s}=this,{coordinateHelper:a,elevationInfo:r,spatialReference:o}=n;await h.initializeProjection(t.spatialReference,o);const p=h.project(t,o),c=u.fromPoint(p,s,r),d=await this._fetchCandidates(c,f.SnappingDomain.FEATURE,n,i);if(d.length>0){const e=await this._fetchCandidates(c,f.SnappingDomain.SELF,n,i);return this._createSnapResult(c,m.SCENE,[...d,...e],s,n,{z:p.z,m:p.m,spatialReference:p.spatialReference,elevationInfo:r},i)}const l=u.fromPoint(e,s,r),g=await this._fetchCandidates(l,f.SnappingDomain.SELF,n,i);return this._createSnapResult(l,m.MAIN,g,s,n,{z:a.hasZ()&&e.hasZ?e.z??0:void 0,m:a.hasM()&&e.hasM?e.m??0:void 0,spatialReference:e.spatialReference,elevationInfo:r},i)}async _fetchCandidates(e,t,n,i){return(await Promise.all(this._engines.map((s=>s.fetchCandidates(e,t,n,i))))).flat()}_createSnapResult(e,t,n,i,a,r,o){return{get valid(){return!s.isAborted(o)},apply:()=>{const{spatialReference:s}=a,{snappedPoint:o,hints:p}=this._processCandidates(e,t,n,a);return this._removeVisualization(),null!=a.visualizer&&this.addHandles(a.visualizer.draw(p,{spatialReference:s,elevationInfo:l.absoluteHeightElevationInfo,view:i,selfSnappingZ:a.selfSnappingZ}),M),v.snappingPointToSnappingOutput(o,i,r)}}}_processCandidates(e,t,n,i){if(n.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),y.sortCandidatesInPlace(e,n);const s=this._currentMainCandidate;if(null!=s){const a=this._findOldConstraintInNewCandidates(s,n);if(a>=0){if(!(n[a]instanceof C.IntersectionSnappingCandidate))return this._intersectWithOtherCandidates(a,n,e,t,i);if(this._arePointsWithinScreenThreshold(e,s.targetPoint,i))return this._updateSnappingCandidate(s,t,n,i)}}return this._intersectWithOtherCandidates(0,n,e,t,i)}_findOldConstraintInNewCandidates(e,t){return e instanceof C.IntersectionSnappingCandidate?this._findOldCandidateIndex(t,e.first)>=0&&this._findOldCandidateIndex(t,e.second)>=0?0:-1:this._findOldCandidateIndex(t,e)}_intersectWithOtherCandidates(e,t,n,i,s){const{coordinateHelper:a}=s,r=t[e],o=[];for(let p=0;p<t.length;++p){if(p===e)continue;const i=t[p],s=r.constraint.intersect(i.constraint);if(s)for(const e of s.closestPoints(r.targetPoint))o.push([new C.IntersectionSnappingCandidate(e,r,i,i.isDraped),this._squaredScreenDistance(n,e,a)])}return o.length>0&&(o.sort(((e,t)=>e[1]-t[1])),o[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(o[0][0],i,t,s):this._updateSnappingCandidate(r,i,t,s)}_updateSnappingCandidate(e,t,n,i){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const s=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const r of n){if(e instanceof C.IntersectionSnappingCandidate){if(r.constraint.equals(e.first.constraint)||r.constraint.equals(e.second.constraint))continue}else if(r.constraint.equals(e.constraint))continue;const t=r.constraint.closestTo(s);this._squaredScreenDistance(t,s,i.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(r.targetPoint=s,this._currentOtherActiveCandidates.push(r),a.push(...r.hints))}return{snappedPoint:s,hints:a}}_squaredPointProximityThreshold(e){return"touch"===e?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(e,t,n){return this._squaredScreenDistance(e,t,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(e,t,n){return y.squaredScreenDistance(this._toScreen(e,n),this._toScreen(t,n))}_toScreen(e,t){return P.vectorToScreenPoint(e,t.spatialReference,l.absoluteHeightElevationInfo,this.view)}_findOldCandidateIndex(e,t){let n=-1;for(let i=0;i<e.length;++i)if(t.constraint.equals(e[i].constraint)){n=i;break}return n}get test(){return{visualizationsActive:this.hasHandles(M),engines:this._engines}}},t.__decorate([r.property({constructOnly:!0})],e.SnappingManager.prototype,"view",void 0),t.__decorate([r.property()],e.SnappingManager.prototype,"options",void 0),t.__decorate([r.property({readOnly:!0})],e.SnappingManager.prototype,"updating",null),t.__decorate([r.property()],e.SnappingManager.prototype,"snappingEnginesFactory",void 0),t.__decorate([r.property()],e.SnappingManager.prototype,"_engines",void 0),t.__decorate([r.property()],e.SnappingManager.prototype,"_squaredMouseProximityTreshold",null),t.__decorate([r.property()],e.SnappingManager.prototype,"_squaredTouchProximityThreshold",null),t.__decorate([r.property()],e.SnappingManager.prototype,"_squaredSatisfiesConstraintThreshold",null),e.SnappingManager=t.__decorate([d.subclass("esri.views.interactive.snapping.SnappingManager")],e.SnappingManager),function(e){e[e.MAIN=0]="MAIN",e[e.SCENE=1]="SCENE"}(m||(m={}));const M="visualization-handle";function I(e){return null!=e.scenePoint}function T({coordinateHelper:e,elevationInfo:t}){return e.hasZ()?l.absoluteHeightElevationInfo:t}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
