/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/iteratorUtils","../../core/MapUtils","../../core/mathUtils","../../core/screenUtils","./interactiveToolUtils","../support/screenUtils"],(function(e,t,o,r,n,a,i){"use strict";class s{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const o=()=>e.stopPropagation();switch(e.type){case"pointer-move":l(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(o(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!p(e))break;const r=i.createScreenPointFromEvent(e),n=this._intersect(r,e.pointerType,t.forEachTool);if(null==n)break;const a=n.manipulator,s=n.tool;null==a||null==s||!a.interactive||a.grabbable&&a.grabbableForEvent(e)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,e,t),null!=a&&null!=s&&a.interactive&&a.grabbable&&a.grabbableForEvent(e)&&!a.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:a,tool:s,start:r,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&null==t.activeTool&&(this._revertToNullActiveTool=!0,t.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),o());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!p(e))break;const n=this._grabbedManipulators.get(e.pointerId),a=n?.manipulator,s=n?.tool;if(null==a||null==s)break;const l=i.createScreenPointFromEvent(e);l.x=r.clamp(l.x,0,t.view.width),l.y=r.clamp(l.y,0,t.view.height);const c=n.start,u=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(a.dragging=!0,u?a.events.emit("drag",{action:"update",start:c,screenPoint:l}):a.events.emit("drag",{action:"start",start:c,screenPoint:l,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:s,manipulator:a,start:c}));break;case"end":a.dragging=!1,u&&a.events.emit("drag",{action:"end",start:c,screenPoint:l}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}o();break}case"immediate-click":{const r=i.createScreenPointFromEvent(e),n=this._intersect(r,e.pointerType,t.forEachTool);if(c(e)||t.forEachTool((e=>{if((null==n||n.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),null==n)break;const{manipulator:a,tool:s}=n;if(!a.interactive)break;a.selectable&&s.automaticManipulatorSelection&&(a.selected=!a.selected,s.onManipulatorSelectionChanged&&s.onManipulatorSelectionChanged());const l=e.native.shiftKey;a.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:o}),u(a,o);break}case"click":{const r=i.createScreenPointFromEvent(e),n=this._intersect(r,e.pointerType,t.forEachTool),a=n?.manipulator;if(null==a||!a.interactive)break;const s=e.native.shiftKey;a.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s}),o();break}case"double-click":{const r=i.createScreenPointFromEvent(e),n=this._intersect(r,e.pointerType,t.forEachTool),a=null!=n?n.manipulator:null;if(null==a||!a.interactive)break;const s=e.native.shiftKey;a.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s,stopPropagation:o}),u(a,o);break}case"immediate-double-click":{const r=i.createScreenPointFromEvent(e),n=this._intersect(r,e.pointerType,t.forEachTool),a=null!=n?n.manipulator:null;if(null==a||!a.interactive)break;const s=e.native.shiftKey;a.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s,stopPropagation:o}),u(a,o);break}}this._onFocusChange(t.forEachTool)}_ungrabManipulatorBeforeDragging(e,t,o){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:i.createScreenPointFromEvent(t)}),this._grabbedManipulators.forEach((({manipulator:t},o)=>{t===e&&this._grabbedManipulators.delete(o)})),this._afterManipulatorUngrab(o.setActiveTool)}_handlePointerEnd(e,t){const o=this._grabbedManipulators.get(e.pointerId)?.manipulator;null!=o&&o.grabbing&&(o.grabbing=!1,o.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:i.createScreenPointFromEvent(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(t.setActiveTool))}_cursorFromMap(e){let t=null;return o.someMap(e,(({manipulator:e})=>!(null==e||!e.interactive)&&(e.grabbing&&e.grabCursor?(t=e.grabCursor,!0):!!e.cursor&&(t=e.cursor,!0)))),t}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const o=new Set,r=new Set;this._grabbedManipulators.forEach((({tool:e})=>{o.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{r.add(e)})),e((e=>{e.hasGrabbedManipulators=o.has(e),e.hasHoveredManipulators=r.has(e);const n=this._grabbedManipulators.values(),a=t.find(n,(({tool:t})=>t===e));e.firstGrabbedManipulator=null!=a?a.manipulator:null}))}clearPointers(e,{forEachTool:t,setActiveTool:o},r=!0,n){const a=(t,o)=>t===e&&(null==n||n===o);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:o},r)=>{a(e,t)&&(this._grabbedManipulators.delete(r),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:o}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},o)=>{a(e,t)&&(this._draggedManipulators.delete(o),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),r&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},o)=>{a(e,t)&&(this._hoveredManipulators.delete(o),t.hovering=!1)})),this._afterManipulatorUngrab(o),this._onFocusChange(t)}_intersect(e,t,o){let r=null;return o((o=>{if(null==o.manipulators||!a.areToolManipulatorsEditable(o))return!1;const n=o.manipulators.intersect(e,t);return null!=n&&(r={tool:o,manipulator:n},!0)})),r}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,o)=>{this._updateHoveredStateForPointerAtScreenPosition(n.createScreenPoint(t.x,t.y),o,t.pointerType,e)}))}handleHoverEvent(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!l(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(i.createScreenPointFromEvent(e),e.pointerId,e.pointerType,t)}_updateHoveredStateForPointerAtScreenPosition(e,t,o,r){let n=this._intersect(e,o,r);const a=this._hoveredManipulators.get(t)?.manipulator;null==n||n.manipulator.interactive||(n=null),null!=n&&a===n.manipulator||(null!=a&&(a.hovering=!1),null!=n?(n.manipulator.hovering=!0,this._hoveredManipulators.set(t,n)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorUngrab(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}}function l(e){return"mouse"===e}function p(e){return"mouse"!==e.pointerType||0===e.button}function c(e){return!!e.native.shiftKey}function u(e,t){e?.consumesClicks&&t()}e.ToolViewManagerManipulatorState=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
