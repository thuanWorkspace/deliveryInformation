/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../Color","../../core/Accessor","../../core/asyncUtils","../../core/colorUtils","../../core/handleUtils","../../core/promiseUtils","../../core/quantityFormatUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../chunks/vec2","../../chunks/vec2f64","../../chunks/vec3","../../geometry/support/coordsUtils","../../intl/messages","../../support/elevationInfoUtils","../../support/getDefaultUnitForView","../overlay/TextOverlayItem","../support/automaticLengthMeasurementUtils"],(function(e,t,s,o,r,n,a,i,l,c,d,h,p,u,g,b,_,y,x,m,f,v,L,S,I){"use strict";const U=3025,C={default:15,far:25};e.SegmentLabels=class extends o{constructor(e){super(e),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const e=r.createTask((async e=>{const t=await f.fetchMessageBundle("esri/core/t9n/Units");i.throwIfAborted(e),this._messagesUnits=t}));this.addHandles([c.watch((()=>[null!=this.context&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((e=>c.on((()=>this.context?.editGeometryOperations),e,(()=>this._update())))),a.makeHandle((()=>e.abort())),c.watch((()=>this._colors),(e=>this._updateStyle(e)))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return null==this._messagesUnits}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((e=>e.label.text))}}get _edgeDistancePixels(){return C[this.edgeDistance]}get _colors(){const e=this.context?.view.effectiveTheme.textColor??s.fromArray([255,255,255]);return{textColor:e,backgroundColor:n.multiplyOpacity(n.getContrast(e,n.BrightnessThreshold.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const e=this.context;if(null==e)return void this._destroyUnusedLabels();const{components:t,geometry:s,coordinateHelper:o}=e.editGeometryOperations.data;if(!s)return void this._destroyUnusedLabels();const r=t.length;for(let n=0;n<r;++n){const a=[];if(t[n].iterateVertices((e=>{a.push(o.toXYZ(e.pos))})),0===n&&null!=this.stagedVertex&&a.push(o.toXYZ(this.stagedVertex)),a.length<2)continue;const i=a[0],l=a[a.length-1];"polygon"===s.type&&a.length>2&&!x.equals(i,l)&&a.push(i);const c=1===r&&!m.isClockwise(a);let d=D,h=O;this.toScreenPointArray(e,i,d);for(let t=1;t<a.length;++t){const s=a[t-1],o=a[t];this.toScreenPointArray(e,o,h),this._addLabel(e,s,d,o,h,c),[d,h]=[h,d]}}this._destroyUnusedLabels()}_updateStyle({textColor:e,backgroundColor:t}){const s=this._nextLabelIndex,o=this._labelInfos;for(let r=0;r<s;++r){const{label:s}=o[r];s.textColor=e,s.backgroundColor=t}}_addLabel(e,t,s,o,r,n){const{label:a}=this._getOrCreateLabel(e);if(!this.visible||_.squaredDistance(s,r)<U)return void(a.visible=!1);const i=null!=e.graphicState?e.graphicState.isDraped?"on-the-ground":"absolute-height":v.getGeometryEffectiveElevationMode(e.editGeometryOperations.data.geometry,e.elevationInfo),{spatialReference:c}=e.editGeometryOperations.data,d=I.autoDirectDistanceByElevationMode(t,o,c,i),h=this._messagesUnits,p=L.getDefaultUnitForView(e.view);a.text=null!=h&&null!=d?l.formatLength(h,d,p):"",a.visible=!0;const u=r[0]-s[0],g=r[1]-s[1];n?_.set(w,-g,u):_.set(w,g,-u),_.normalize(w,w),_.scale(w,w,this._edgeDistancePixels),_.lerp(k,s,r,.5),_.add(k,k,w),a.position=[k[0],k[1]],Math.abs(w[0])>Math.abs(w[1])?a.anchor=w[0]>0?"left":"right":a.anchor=-w[1]<0?"top":"bottom"}_getOrCreateLabel(e){const t=this._labelInfos.length>this._nextLabelIndex,{textColor:s,backgroundColor:o}=this._colors;if(t){const e=this._labelInfos[this._nextLabelIndex++],{label:t}=e;return t.textColor=s,t.backgroundColor=o,e}const r=new S({anchor:"center",fontSize:10,textColor:s,backgroundColor:o});e.view.overlay?.items.add(r);const n={label:r};return this._labelInfos.push(n),this._nextLabelIndex=this._labelInfos.length,n}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:e}){this.context?.view.overlay?.items.remove(e),e.destroy()}},t.__decorate([h.property()],e.SegmentLabels.prototype,"context",void 0),t.__decorate([h.property()],e.SegmentLabels.prototype,"stagedVertex",void 0),t.__decorate([h.property()],e.SegmentLabels.prototype,"visible",void 0),t.__decorate([h.property()],e.SegmentLabels.prototype,"edgeDistance",void 0),t.__decorate([h.property()],e.SegmentLabels.prototype,"updating",null),t.__decorate([h.property()],e.SegmentLabels.prototype,"_messagesUnits",void 0),t.__decorate([h.property()],e.SegmentLabels.prototype,"_edgeDistancePixels",null),t.__decorate([h.property()],e.SegmentLabels.prototype,"_colors",null),e.SegmentLabels=t.__decorate([b.subclass("esri.views.interactive")],e.SegmentLabels);const w=y.create(),k=y.create(),D=d.createScreenPointArray(),O=d.createScreenPointArray();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
