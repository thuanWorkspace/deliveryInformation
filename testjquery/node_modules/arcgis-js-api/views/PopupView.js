/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../chunks/tslib.es6","../core/asyncUtils","../core/deprecate","../core/Error","../core/Logger","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./input/InputManager"],(function(e,p,t,i,s,o,r,a,n,u,l,c,h,d,y){"use strict";const w=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function P(e){return null!=e&&"open"in e&&"declaredClass"in e}function g(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}const f=p=>{let l=class extends p{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([n.watch((()=>[this.ui,this.popup]),(([e,p],t)=>{const i="popup",s="manual";if(t){const[e,p]=t;e&&P(p)&&(p.view=null,g(p)&&e.remove(p,i))}e&&P(p)&&(p.view=this,g(p)&&e.add(p,{key:i,position:s,internal:!0}))}),n.initial),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(!P(this.popup)&&"autoOpenEnabled"in this.popup&&!1===this.popup.autoOpenEnabled||(P(this.popup)?this.popup.viewModel.handleViewClick(e):e.async((async()=>{await this.setupPopup(),P(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)}))))}),y.ViewEventPriorities.WIDGET)]),n.whenOnce((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{new Promise(((p,t)=>e(["../widgets/Popup"],(e=>p(w(e))),t)))}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(P(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void r.getLogger(this).error(new o("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),P(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,p){await this.when();const{location:t,queryArea:i,layerViewsAndGraphics:s,clientOnlyGraphics:o}=await this._prepareFetchPopupFeatures(e,p),r=Promise.resolve(o),n=this._queryLayerPopupFeatures(i,s,p),u=n.map((e=>e.promise));return{location:t,clientOnlyGraphics:o,allGraphicsPromise:a.eachAlwaysValues([r,...u]).then((e=>Array.from(new Set(e.flat())))),promisesPerLayerView:n}}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!P(this.popup))return this._popupSetupTask=i.createTask((async p=>{const{default:t}=await new Promise(((p,t)=>e(["../widgets/Popup"],(e=>p(w(e))),t)));if(a.throwIfAborted(p),!this.popup||P(this.popup))return;const i=this.popup;delete i.open,delete i.close,this.popup=new t(i)})),this._popupSetupTask.promise}_queryLayerPopupFeatures(e,p,t){return p.map((({layerView:p,graphics:i})=>{const s={clientGraphics:i,event:null!=t?t.event:void 0,signal:null!=t?t.signal:void 0,defaultPopupTemplateEnabled:null!=t&&!!t.defaultPopupTemplateEnabled},o=p.fetchPopupFeatures(e,s);return{layerView:p,promise:o}}))}_isValidPopupGraphic(e,p){return e&&!!e.getEffectivePopupTemplate(null!=p&&p.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(e,p){const{clientGraphics:t,queryArea:i,location:s}=await this._popupHitTestGraphics(e,p),o=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:r,clientOnlyGraphics:a}=this._graphicsPerFetchPopupLayerView(t,o);return{clientOnlyGraphics:a,layerViewsAndGraphics:r,queryArea:i,location:s}}async _popupHitTestGraphics(e,p){const t=await this.popupHitTest(e),i=t.results,s=t.mapPoint,o=i.filter((e=>"graphic"===e.type&&this._isValidPopupGraphic(e.graphic,p))),r=o.length?o[0].mapPoint:null;return{clientGraphics:o.map((e=>e.graphic)),queryArea:s,location:s||r}}_getFetchPopupLayerViews(){const e=[];return this.allLayerViews.forEach((p=>{this._isValidPopupLayerView(p)&&e.push(p)})),null!=this.graphicsView&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()}_isValidPopupLayerView(e){return null!=e&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e}_graphicsPerFetchPopupLayerView(e,p){const t=[],i=new Map,s=p.map((e=>{const p=[];return"layer"in e?i.set(e.layer,p):i.set(e.graphics,p),{layerView:e,graphics:p}}));for(const o of e){const e=i.get(o.layer)||i.get(o.sourceLayer)||null;e?e.push(o):t.push(o)}return{layerViewsAndGraphics:s,clientOnlyGraphics:t}}};return t.__decorate([u.property({cast(e){return!e||P(e)||"object"==typeof e&&(e.open=e=>(s.deprecated(r.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"}),this.openPopup(e)),e.close=()=>(s.deprecated(r.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"}),this.closePopup())),e}})],l.prototype,"popup",void 0),t.__decorate([u.property()],l.prototype,"popupEnabled",void 0),l=t.__decorate([d.subclass("esri.views.PopupView")],l),l};p.PopupView=f,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})}));
