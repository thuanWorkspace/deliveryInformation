/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/ellipsoidUtils","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/TiltMode","../../layers/VoxelWasm","../Constraints","./InteractiveController","../utils/navigationUtils"],(function(t,i,e,o,s,r,a,n,c,h,p,l,m,_,v,P,d,u,C,y,T,E,M,R){"use strict";var w;t.PivotPoint=void 0,(w=t.PivotPoint||(t.PivotPoint={}))[w.CENTER=0]="CENTER",w[w.EYE=1]="EYE",t.RotateController=class extends M.InteractiveController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(i){super(i),this.pivot=t.PivotPoint.CENTER,this._rotScale=0,this._lastPoint=m.create(),this._tmpWorldUp=v.create(),this._tmpViewDir=v.create(),this._tmpRotCurPoint=m.create(),this._tmpTransf=p.create(),this._tmpAxis=v.create(),this._tmpPivotPoint=v.create(),this._pivotPos=v.create(),this._constraintOptions={selection:u.ConstraintTypes.ALL,interactionType:C.InteractionType.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:y.TiltMode.TUMBLE}}initialize(){this._rotScale=this.pivot===t.PivotPoint.CENTER?3:1.5}begin(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:_.copy(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=C.InteractionType.LOOK_AROUND,this._constraintOptions.tiltMode=y.TiltMode.LOOK_AROUND,this._constraintOptions.selection=u.ConstraintTypes.NONE;break;case t.PivotPoint.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?R.contentIntersectorOptions:{});t||_.copy(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(i,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=C.InteractionType.TUMBLE,this._constraintOptions.tiltMode=y.TiltMode.TUMBLE,this._constraintOptions.selection=u.ConstraintTypes.ALL&~u.ConstraintTypes.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,R.normalizeCoordinate(this.startCamera,i,this._lastPoint)}}_constrainPivotPoint(t,i){const e=this.startCamera,s=v.create();_.subtract(s,this._pivotPos,e.eye);const r=_.length(s),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(e.eye,U);let n=Math.max(Math.min(R.rotatePivotDistanceModifier,1/Math.abs(_.dot(U,e.viewForward)))*a,R.rotatePivotMinDistanceModifier);i&&(n=Math.min(r,n));const c=P.getReferenceEllipsoid(this.view.spatialReference),h=o.createScreenPointArray(e.width/e.pixelRatio*.5,e.height/e.pixelRatio*.5),p=R.decideNavigationMode(this.startCamera,h,c);let l=this.view._stage.renderView.getMinimalDepthForArea(T.getVoxelWasm(this.view),e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,2.5*R.rotateScreenPixelArea,R.rotateScreenPixelArea),m=this.view._stage.renderView.getMinimalDepthForArea(T.getVoxelWasm(this.view),t[0],t[1],e,R.rotateScreenPixelArea);null==l&&null==m||(l=l??m??0,m=null==m||p===R.NavigationMode.Horizontal?l:m,n=l>m?m:l,n=i?Math.min(n,r):n),_.normalize(s,s),_.copy(this._pivotPos,_.add(this._tmpPivotPoint,e.eye,_.scale(this._tmpPivotPoint,s,n)))}update(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,i,this.currentCamera.center,this._pivotPos);break;case t.PivotPoint.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,i,this.currentCamera.eye,this._pivotPos)}d.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(i,o,s,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),R.normalizeCoordinate(i,o,this._tmpRotCurPoint);let a=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;_.subtract(this._tmpViewDir,s,r);const c=_.length(this._tmpViewDir),p=e.acosClamped(_.dot(this._tmpViewDir,this._tmpWorldUp)/c);if(this.pivot===t.PivotPoint.EYE){a*=-.5;const t=.5*Math.PI-p,i=.5*Math.PI*.99;a=t-Math.max(-i,Math.min(i,t+a))}return a=e.clamp(a+p,E.TiltDefault.min,E.TiltDefault.max)-p,_.cross(this._tmpAxis,i.up,this._tmpViewDir),this.pivot===t.PivotPoint.CENTER&&(n=-n),h.fromRotation(this._tmpTransf,n,this._tmpWorldUp),h.rotate(this._tmpTransf,this._tmpTransf,a,this._tmpAxis),_.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),i.up=_.transformMat4(f,i.up,this._tmpTransf),_.add(f,r,this._tmpViewDir),l.copy(this._lastPoint,this._tmpRotCurPoint),f}},i.__decorate([s.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=i.__decorate([c.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController);const f=v.create(),U=v.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
