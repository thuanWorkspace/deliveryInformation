/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,a,o,r,i,c,s,l,d,u,m,p,h,g,f,y,M,P){"use strict";var b;e.SpherePickPointFallback=void 0,(b=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[b.Ellipsoid=0]="Ellipsoid",b[b.Silhouette=1]="Silhouette";const v=30,S=[1,3e8],A=80,x=8,z=200,k=1508e5,I=5,T=50,R=5,D=10,E=90,F={exclude:new Set([P.terrainId])};function w(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function C(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function N(e,t,n){const a=o.fromRotation(g.sm4d.get(),n[3],d.axis(n));null==a||o.exactEquals(a,r.IDENTITY)||(s.subtract(De,e.eye,t),s.transformMat4(De,De,a),e.eye=s.add(De,De,t),s.subtract(De,e.center,t),s.transformMat4(De,De,a),e.center=s.add(De,De,t),e.up=s.transformMat4(De,e.up,a))}function H(e,t,n,a){return m.intersectRay(e,f.fromScreen(t,n,Ne),a)}function O(e,t,n,a){return m.intersectRay(e,f.fromScreenAtEye(t,n,Ne),a)}function q(e,t,n,a){const o=g.sv3d.get();let r=1-n;s.subtract(o,t,e.eye);const i=s.length(o);let c=i*(1-r);r>=0&&c<a&&(c=a,r=-(c-i)/i),Math.abs(i-c)<1e-6||(s.scale(o,o,r),e.eye=s.add(De,e.eye,o),e.center=s.lerp(De,e.center,t,r))}function V(e,t,n){t.getScreenCenter(G),y.intersectScreen(e,t,G,De)&&(t.center=De);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=s.scale(g.sv3d.get(),t.viewForward,o);t.eye=s.subtract(De,t.center,r)}const G=a.createScreenPointArray();function U(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)}function W(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}function Z(e,t,n,a){return W(Math.PI/2,t,n,a)+(e-Math.PI/2)}var j;e.NavigationMode=void 0,(j=e.NavigationMode||(e.NavigationMode={}))[j.Vertical=0]="Vertical",j[j.Horizontal=1]="Horizontal";const L={Elevation:3e4,Angle:n.deg2rad(16)},Y={Pole:.95,Angle:n.deg2rad(18),Tilt:45},B=n.deg2rad(80);function J(t,n,a,o,r,i){const c=l.create(),d=p.create();let u=!0,m=!0;return t.intersectScreen(a,c,i)?d[3]=s.length(c):(m=!1,n.aboveGround&&r!==e.SpherePickPointFallback.Ellipsoid?d[3]=Math.max(s.length(n.center),.9*o.radius):d[3]=s.length(n.eye)-n.relativeElevation,r===e.SpherePickPointFallback.Silhouette?$(d,n,a,c):u=y.intersectScreen(d,n,a,c)),{sphere:d,scenePickPoint:u?c:null,hasGeometryIntersection:m}}function K(t,n,a){if(s.length(t.eye)-a.radius>L.Elevation)return e.NavigationMode.Horizontal;f.fromScreenAtEye(t,n,He);return-Math.sign(t.relativeElevation)*(.5*Math.PI+h.angle(t.eye,He.direction))<L.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function Q(e,t,n){s.subtract(X,n,t),e.eye=s.subtract(De,e.eye,X),e.center=s.subtract(De,e.center,X)}const X=l.create();function $(e,t,n,a){const o=f.fromScreenAtEye(t,n,Ne);return null!=o&&(p.closestPointOnSilhouette(e,o,_),p.intersectRay(e,o,a)?!(s.squaredDistance(_,o.origin)<s.squaredDistance(a,o.origin))||(s.copy(a,_),!1):(s.subtract(ee,t.eye,t.center),s.normalize(ee,ee),m.fromNormalAndOffset(ee,-s.dot(s.normalize(ee,ee),_),te),m.intersectRay(te,o,a),!1))}const _=l.create(),ee=l.create(),te=m.create();function ne(e,a,o,r,i,c){let d=0;if(s.cross(we,e,a),s.subtract(Ee,e,a),s.length(e)<=i||!r.aboveGround){s.cross(o,Ee,r.eye);const u=s.dot(e,a)/(s.length(e)*s.length(a));if(u<.9999)d=n.acosClamped(u);else{const t=s.length(s.cross(l.create(),e,a))/(s.length(e)*s.length(a));d=n.asinClamped(t)}const m=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(c)),0,B));d=-d-Math.max(0,s.length(a)-i)/(m*i)}else s.subtract(ae,r.eye,r.center),s.cross(o,Ee,ae),d=-s.length(Ee)/i;return s.normalize(o,o),s.scale(o,o,s.length(we)),d}const ae=l.create();function oe(e,a,o,r){let i,c;const s=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(r)),0,B));return i=a>o?-(a-o)/(s*o):a<-o?Math.PI-(a+o)/(s*o):n.acosClamped(a/o),c=e>o?-(e-o)/(s*o):e<-o?Math.PI-(e+o)/(s*o):n.acosClamped(e/o),(c-i)*o}function re(e,t,n,a,o,r,c,l,d,u){const m=oe(e[2],t[2],r[3],l),p=d?oe(e[0],t[0],r[3],180):t[0]-e[0],h=Math.sin(c)*p-Math.cos(c)*m,g=Math.cos(c)*p+Math.sin(c)*m;s.normalize(De,o);const f=d?h/Math.sqrt(Math.abs(r[3]**2-s.dot(n,De)**2)):h/r[3],y=g/Math.sqrt(Math.abs(r[3]**2-s.dot(n,a)**2));i.set(u,f,y)}function ie(e,t,n,a,o,r,i,c,l,d){s.cross(we,e,t),u.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,Pe,be,ve),u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,fe,ye,Me),s.copy(n,ye),s.copy(a,fe),s.normalize(n,n),s.scale(n,n,s.length(we)),u.vectorCoordinates(e,s.normalize(be,be),s.normalize(ve,ve),s.normalize(Pe,Pe),Se),u.vectorCoordinates(t,be,ve,Pe,Ae),re(Se,Ae,e,fe,ye,i,c,l,d,o)}function ce(e,t,n,a,r,i,c){o.fromRotation(ke,r,a),o.fromRotation(Ie,c,i),o.multiply(Te,ke,Ie),s.subtract(t,e,n),s.transformMat4(t,t,Te),s.add(t,t,n)}function se(e,t,n,a,r,i){o.fromRotation(ke,a,n),o.fromRotation(Ie,i,r),o.multiply(Te,ke,Ie),s.subtract(De,e.eye,t),s.transformMat4(De,De,Te),e.eye=s.add(De,De,t),s.subtract(De,e.center,t),s.transformMat4(De,De,Te),e.center=s.add(De,De,t),s.subtract(De,e.up,t),s.transformMat4(De,De,Te),e.up=s.add(De,De,t)}function le(e,t,n,a,o,r){return(Math.abs(a)>Math.PI-Y.Angle||Math.abs(a)<Y.Angle)&&(Math.abs(e[2])<n*Y.Pole||Math.abs(t)>n)&&r.aboveGround&&o<Y.Tilt}function de(e,t,n,a,o,r){if(r)d.fromPoints(n,a,ze),N(t,e,ze);else{const r=ne(n,a,Ce,t,e[3],o);N(t,e,d.wrapAxisAngle(Ce,r))}}function ue(e,t,n,a,o,r,i){const c=i?20:1,l=1e-12;let d,u;s.copy(Re,a),Fe.copyFrom(t);for(let m=0;m<c&&s.squaredDistance(n,Re)>l&&(d=s.squaredDistance(n,Re),ie(n,Re,ye,fe,xe,Fe,e,o,r,i),se(Fe,e,fe,xe[1],ye,xe[0]),ce(Re,Re,e,fe,xe[1],ye,xe[0]),u=s.squaredDistance(n,Re),u<d||0===m);m++)t.copyFrom(Fe)}function me(e,a,o,r,i,c,l){le(o,s.dot(a.up,o),e[3],-t.cyclicalPI.normalize(n.deg2rad(i)),c,a)?ue(e,a,o,r,-t.cyclicalPI.normalize(n.deg2rad(i)),c,l):de(e,a,o,r,c,l)}function pe(e,t,n,a,r,i){const{eye:c}=e;u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c,fe,ye,Me);const l=t.translation[0]*n.pan,d="zoom"===r.mode?0:t.translation[1]*n.pan,m=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,fe)**2/s.length(e.center)**2)),.5),p=(Math.sin(i)*d+Math.cos(i)*l)/m,h=-Math.cos(i)*d+Math.sin(i)*l;switch(o.rotate(a.pan.matrix,a.pan.matrix,p,fe),a.pan.enabled=!0,r.mode){case"pan":o.rotate(a.pan.matrix,a.pan.matrix,h,ye),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function he(e,t,n,a,r){const{eye:i,viewRight:c}=e,l=s.cross(g.sv3d.get(),c,i),d=t.translation[0]*n.pan;switch(0!==d&&(o.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(o.rotate(a.pan.matrix,a.pan.matrix,e,c),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ge(e,a,o,r,i,c,l,d,u){le(e.center,s.dot(e.up,e.center),s.length(e.center),-t.cyclicalPI.normalize(n.deg2rad(c)),l,a)?pe(a,o,r,d,u,-t.cyclicalPI.normalize(n.deg2rad(i))):he(a,o,r,d,u)}const fe=l.create(),ye=l.create(),Me=l.create(),Pe=l.create(),be=l.create(),ve=l.create(),Se=l.create(),Ae=l.create(),xe=c.create(),ze=d.create(),ke=r.create(),Ie=r.create(),Te=r.create(),Re=l.create(),De=l.create(),Ee=l.create(),Fe=new M.Camera,we=l.create(),Ce=l.create(),Ne={origin:l.create(),direction:l.create()},He={origin:l.create(),direction:l.create()};e.PreservingHeadingThreshold=Y,e.TiltThresholdPanningSpeed=B,e.VerticalPanTresholds=L,e.applyPanPlanar=Q,e.applyPanSphericalDirectRotation=de,e.applyPanSphericalPreserveHeading=ue,e.applyRotation=N,e.applyRotationWithTwoAxes=se,e.applyZoomOnSphere=V,e.applyZoomToPoint=q,e.centroid=U,e.contentIntersectorOptions=F,e.decideNavigationMode=K,e.distanceClampValues=S,e.intersectPlaneFromScreenPoint=H,e.intersectPlaneFromScreenPointAtEye=O,e.lengthFromPoints=oe,e.minHeightLimit=T,e.normalizeCoordinate=w,e.normalizeRotationDelta=C,e.offSurfaceTiltToEyeTiltGlobal=Z,e.onSurfaceTiltToEyeTiltGlobal=W,e.panDistanceModifier=I,e.panMotionToRotationMatrix=ge,e.panToPosition=me,e.pickPointAndInitSphere=J,e.pivotDistanceModifier=v,e.preserveHeadingThreshold=le,e.rotatePivotDistanceModifier=R,e.rotatePivotMinDistanceModifier=D,e.rotatePointAroundTwoAxes=ce,e.rotateScreenPixelArea=E,e.rotationAngleAndAxisDirectRotation=ne,e.rotationAnglesAndAxesHeadingPreserving=ie,e.rotationAnglesHeadingPreserving=re,e.screenPixelArea=A,e.sphereOrPlanePointFromScreenPoint=$,e.zoomDistanceModifier=x,e.zoomMaxDistanceModifier=k,e.zoomMinDistanceModifier=z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
