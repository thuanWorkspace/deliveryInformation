/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../core/Error","../../../../support/requestUtils","../../glTF/internal/resourceUtils","./enums","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/textureUtils","../../webgl-engine/materials/pbrUtils"],(function(e,t,o,a,r,n,s,l,u){"use strict";async function i(e){const o=[],a=[];if(null==e){return{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:o,textureData:a}}const r=d(e);"auto"===e.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const l=u.useSchematicPBR({normalTexture:e.normalTexture,emissiveTexture:r?e.emissiveTexture:null,emissiveFactor:r?t.toUnitRGB(e.emissiveColor):null,occlusionTexture:r?e.occlusionTexture:null,metallicRoughnessTexture:r?e.metallicRoughnessTexture:null,metallicFactor:r?e.metallic:null,roughnessFactor:r?e.roughness:null}),i=l?u.defaultSchematicMRRFactors[0]:r?e.metallic:0,m=l?u.defaultSchematicMRRFactors[1]:r?e.roughness:0;return{material:{alphaMode:"auto"===e.alphaMode?"blend":e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,cullFace:e.doubleSided?s.CullFaceOptions.None:s.CullFaceOptions.Back,normalTextureId:await c(e.normalTexture,o,a,n.TextureUsage.Normal),emissiveTextureId:r?await c(e.emissiveTexture,o,a,n.TextureUsage.Emissive):-1,occlusionTextureId:r?await c(e.occlusionTexture,o,a,n.TextureUsage.Occlusion):-1,emissiveFactor:r&&null!=e.emissiveColor?t.toUnitRGB(e.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=e.color?t.toUnitRGBA(e.color):[1,1,1,1],baseColorTextureId:await c(e.colorTexture,o,a,n.TextureUsage.Color),metallicRoughnessTextureId:r?await c(e.metallicRoughnessTexture,o,a,n.TextureUsage.MetallicRoughness):-1,metallicFactor:i,roughnessFactor:m},wrapTextures:!0,hasParametersFromSource:l},requiredTextures:o,textureData:a}}async function c(e,t,s,u){if(null==e)return-1;const i=s.length,c=e.data,d=e.url;if(null!=c){if(c instanceof HTMLImageElement||c instanceof HTMLCanvasElement){const e=l.downsampleImage(c);return s.push({id:i,usage:u,data:e,encoding:n.TextureEncoding.PNG,downsampled:!1}),t.push({id:i,usage:u,encodings:[{name:void 0,encoding:n.TextureEncoding.PNG}]}),i}if(c instanceof HTMLVideoElement)return-1;if(c instanceof ImageData)throw new o("ImageData textures not supported yet for client side I3S nodes");if(c instanceof r.EncodedMeshTexture)throw new o("EncodedMeshTexture textures not supported yet for client side I3S nodes")}else if(null!=d){const e=new Image;e.src=d;const o=await a.loadImageAsync(e,e.src,!1,void 0),r=l.downsampleImage(o);return s.push({id:i,usage:u,data:r,encoding:n.TextureEncoding.PNG,downsampled:!1}),t.push({id:i,usage:u,encodings:[{name:void 0,encoding:n.TextureEncoding.PNG}]}),i}return-1}function d(e){return e.hasOwnProperty("metallicRoughnessTexture")}e.convertMeshMaterialToPBRMaterial=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
