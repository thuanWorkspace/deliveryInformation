/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces"],(function(e,t,r,n,i,s,o,a,c,l,p,u,h,d,m,f,v,y){"use strict";const _=m.empty(),g=p.create(),x=f.fromValues(0,0,0,0),E=h.create(),b=h.create(),R=h.create();let w=class extends(r.EventedMixin(t)){get spatialReference(){return this.view?.elevationProvider?.spatialReference}constructor(e){super(e),this._tmpEvent={spatialReference:null,extent:_,context:"scene"}}initialize(){this.view=this.layerView.view,this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersector=v.newIntersector(this.view.state.viewingMode),this._intersector.options.store=y.StoreResults.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}getElevation(e,t,r,i){const s=E;s[0]=e,s[1]=t,s[2]=r;const o=this._renderCoordsHelper;if(!o.toRenderCoords(s,i,s))return n.getLogger(this).error("could not project point to compute elevation"),null;const{layerView:a,_intersector:c,intersectionHandler:l}=this,p=a.i3slayer.fullExtent,u=null!=p&&Number.isFinite(p.xmin)&&Number.isFinite(p.xmax)&&Number.isFinite(p.ymin)&&Number.isFinite(p.ymax)&&Number.isFinite(p.zmin)&&Number.isFinite(p.zmax)?{min:p.zmin,max:p.zmax}:a.elevationRange;if(null==u)return null;const h=a.elevationOffset,d=u.min+h,m=u.max+h,f=b,v=R;return o.setAltitude(f,m,s),o.setAltitude(v,d,s),c.reset(f,v,null),l.intersect(c,null,f,v),c.results.min.getIntersectionPoint(s)?o.getAltitude(s):null}getSphereElevationBounds(e,t){return d.projectBoundingSphere(e,t,x,this._renderCoordsHelper.spatialReference),this.layerView.getElevationRange(x)}getRootElevationBounds(){const e=this.layerView.i3slayer.fullExtent;return e?.hasZ?{min:e.zmin,max:e.zmax}:null}layerChanged(){this.spatialReference&&(this._tmpEvent.extent=this._computeLayerExtent(),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._tmpEvent.extent=this._computeObjectExtent(e),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e){return m.empty(_),this._expandExtent(e,_),_}_computeLayerExtent(){m.empty(_);for(const e of this.layerView.getVisibleNodes())this._expandExtent(e,_);return _}_expandExtent(e,t){const r=this.spatialReference;if(null==r)return;const n=this.layerView.getNodeComponentObb(e);if(null!=n){l.fromQuat(g,n.quaternion),g[12]=n.center[0],g[13]=n.center[1],g[14]=n.center[2];for(let e=0;e<8;++e)E[0]=1&e?n.halfSize[0]:-n.halfSize[0],E[1]=2&e?n.halfSize[1]:-n.halfSize[1],E[2]=4&e?n.halfSize[2]:-n.halfSize[2],u.transformMat4(E,E,g),this._renderCoordsHelper.fromRenderCoords(E,E,r),m.expand(t,E,t)}}};e.__decorate([i.property({constructOnly:!0})],w.prototype,"layerView",void 0),e.__decorate([i.property({constructOnly:!0})],w.prototype,"intersectionHandler",void 0),e.__decorate([i.property()],w.prototype,"view",void 0),e.__decorate([i.property()],w.prototype,"spatialReference",null),w=e.__decorate([c.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],w);return w}));
