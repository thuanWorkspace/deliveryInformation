/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Error","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/LayerConstants","../../../../layers/graphics/data/QueryEngine","../../../../layers/support/FieldsIndex","../../../../rest/support/FeatureSet","../../../../rest/support/Query"],(function(e,r,t,n,s,u,o,a,i,y,c,l,p,d,h,Q){"use strict";const g=p.QueryEngine;e.I3SQueryEngine=class extends t{get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new Q({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance=s.destroyMaybe(this._dataQueryEngineInstance),this._set("layerView",null)}async executeQueryForCount(e,r){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:n}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return{count:t,extent:c.fromJSON(n)}}async executeQueryForIds(e,r){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQuery(e,r){const t=this._ensureQueryJSON(e);if(t.returnGeometry)throw new n("unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(t.returnCentroid)throw new n("unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const s=await this._dataQueryEngine.executeQuery(t,r),u=h.fromJSON(s);return u.features.forEach((e=>{e.geometry=null})),u}_ensureQueryJSON(e){return null==e?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||l.fallbackObjectIDAttribute,r="esriGeometryPolygon",t=this.layer.fieldsIndex?.toJSON()||new d([]),n=this.layerView.view.resourceController.scheduler,s=this.spatialReference.toJSON(),u=this.priority,o=this.spatialIndex;return this._dataQueryEngineInstance=new g({hasZ:!0,hasM:!1,geometryType:r,fieldsIndex:t,timeInfo:null,spatialReference:s,objectIdField:e,featureStore:o,scheduler:n,priority:u}),this._dataQueryEngineInstance}},r.__decorate([u.property({constructOnly:!0})],e.I3SQueryEngine.prototype,"layerView",void 0),r.__decorate([u.property({constructOnly:!0})],e.I3SQueryEngine.prototype,"priority",void 0),r.__decorate([u.property({constructOnly:!0})],e.I3SQueryEngine.prototype,"spatialIndex",void 0),r.__decorate([u.property()],e.I3SQueryEngine.prototype,"spatialReference",null),r.__decorate([u.property()],e.I3SQueryEngine.prototype,"layer",null),r.__decorate([u.property()],e.I3SQueryEngine.prototype,"defaultQueryJSON",null),e.I3SQueryEngine=r.__decorate([y.subclass("esri.views.3d.layers.i3s.I3SQueryEngine")],e.I3SQueryEngine),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
