/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../geometry/support/aaBoundingBox","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,n){"use strict";class s{constructor(e,t,n){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=n}addPage(e,t,n=0){for(;this._pages.length<e;)this._pages.push(null);o(t,this._nodeSR,this._renderSR,n),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},r(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[a(e,t)].nodes[h(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[a(e,t)].nodes[h(e,t)].obbInRenderSR}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,t){const s=this.pageSize;n.set(t,this._pages[a(e,s)].nodes[h(e,s)].obbInRenderSR)}getParentId(e){const t=this.pageSize;return this._pages[a(e,t)].parents[h(e,t)]}hasNodes(e,t){const n=a(e,this.pageSize),s=a(e+t-1,this.pageSize);for(let i=n;i<=s;i++)if(null==this._pages[i])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const n=this._pages[t];if(n)for(let s=0;s<n.nodes.length;s++)e(t*this.pageSize+s)}}createVisibilityTraverse(){const t={index:this,queue:[],masks:[],tempAabb:e.create()};return(e,n)=>i(t,e,n)}}function i(t,s,i){const o=t.index;if(!o.hasNodes(0,1))return;const r=t.queue;r.length=0,r.push(0);const h=t.masks;for(h.length=0,h.push(0);r.length>0;){const p=r.pop();let g=h.pop();const u=o.getNode(p),c=o.getRenderObb(p);let l=!0;if(null!=s.clippingBox){const i=1<<s.frustum.length;if(0==(g&i)){const o=n.toAaBoundingBox(c,t.tempAabb);e.contains(s.clippingBox,o)?g|=i:e.intersects(s.clippingBox,o)||(l=!1)}}for(let e=0;e<s.frustum.length&&l;e++){const t=1<<e;if(0==(g&t)){const i=n.intersectPlane(c,s.frustum[e]);i>0?l=!1:i<0&&(g|=t)}}if(i.predicate(p,u,l)){const e=u.firstChild,t=u.childCount;let n=!1;const s=a(e,o.pageSize),c=a(e+t-1,o.pageSize);for(let r=s;r<=c;r++)if(!o.hasPage(r)){i.pageMiss(p,r),n=!0;break}if(!n)for(let i=0;i<t;i++)r.push(e+i),h.push(g)}}}function o(e,n,s,i){for(let o=0;o<e.length;o++){const r=e[o];t.transformObb(r.obb,n,r.obbInRenderSR,s,i)}}function r(e,t){const n=[0];for(;n.length;){const s=n.pop(),i=e[a(s,t)].nodes[h(s,t)];for(let o=0;o<i.childCount;o++){const r=i.firstChild+o;null!=e[a(r,t)]&&(e[a(r,t)].parents[h(r,t)]=s,n.push(r))}}}function a(e,t){return e/t|0}function h(e,t){return e%t}return s}));
