/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/scheduling","../support/I3SLayerView"],(function(e,s,d,i){"use strict";class o{constructor(){this.lodCrossfadeSignedDuration=0}}class t{constructor(e){this._view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=s.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(e,s,i){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=d.addFrameTask({preRender:e=>this._updateAllNodeFading(e)}),this._view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),e.lodCrossfadeSignedDuration=i,e.lodCrossfadeProgress=s}_updateAllNodeFading(e){const s=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode(((d,i)=>{if(null!=i?.lodCrossfadeProgress){const o=i.lodCrossfadeSignedDuration,t=o>0?this._view.fullOpacity:0,a=e.deltaTime/o,r=i.lodCrossfadeProgress+Math.abs(a),n=!s||r>=1||0===o,l=t-(n?0:o>0?1:-1)*(1-r);n?(this.stopNodeFading(i),o<0&&this._view.markNodeToRemove(d)):i.lodCrossfadeProgress=r,this._view.setNodeOpacityByIndex(d,l)}})),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode(((e,s)=>{if(null!=s?.lodCrossfadeProgress){this.stopNodeFading(s);const d=s.lodCrossfadeSignedDuration;d<0&&this._view.markNodeToRemove(e);const i=d>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(e,i)}})),this._view.removeMarkedNodes()}fadeNode(e,s,d,o){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const t=this._view,r=t.nodeCrossfadingEnabled,n=d===i.FadeDirection.FadeIn?t.fullOpacity:0,l=r?o?d===i.FadeDirection.FadeIn?t.lodCrossfadeinDuration:t.lodCrossfadeoutDuration:t.lodCrossfadeUncoveredDuration:0,h=this._view.getNodeOpacityByIndex(e);if(r&&h!==n&&l>0){const e=1-Math.abs(n-h);this._startNodeFading(s,e,a(d)*l)}else this.stopNodeFading(s),this._view.setNodeOpacityByIndex(e,n),d===i.FadeDirection.FadeOut&&this._view.removeNode(e)}isNodeFullyFadedIn(e){const s=this._view.getNodeCrossfadeMetaData(e);return null==s||null==s.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(e)===this._view.fullOpacity}}function a(e){return e===i.FadeDirection.FadeIn?1:-1}e.I3SCrossfadeHelper=t,e.NodeCrossfadeMetaData=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
