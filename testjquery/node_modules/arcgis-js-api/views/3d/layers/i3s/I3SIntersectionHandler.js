/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../ViewingMode","./I3SUtil","./Intersector","../../support/orientedBoundingBox","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,i,n,r,s,l,o){"use strict";class c{constructor(e){this.type=l.IntersectorType.I3S,this._needVerticalOffset=!1,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,i){this._needVerticalOffset=e&&i===t.ViewingMode.Global}intersect(e,t,c,a){const u=e.results,b=e.options.store===l.StoreResults.ALL,f=e.ray.direction,h=e.tolerance;let y=e=>e,g=e=>e;const O=o.getVerticalOffsetI3S(null!=e.verticalOffset?e.verticalOffset:this._needVerticalOffset?0:null);null!=e.verticalOffset&&null!=O&&(y=e=>O.applyToMbs(e),g=e=>O.applyToObb(e)),this._traverseNodeHierarchy(((l,o)=>{if(0===l.childrenLoaded)return!1;const p=null!=l.serviceObbInRenderSR&&i.isValidObb(l.serviceObbInRenderSR)?l.serviceObbInRenderSR:null;return!(null!=p&&!r.intersectLine(g(p),c,f,h))&&(!o||null==p&&i.isValidMbs(l.renderMbs)&&!d(y(l.renderMbs),c,f,h)||null!=l.geometryObb&&!r.intersectLine(g(l.geometryObb),c,f,h)||this._collection.intersect(o,c,a,h,O,((i,r,o,d)=>{if(r>=0){if(null!=t&&!t(c,a,r))return;const f=e=>{const t=new n.I3sTarget(this.layerUid,this.sublayerUid,l.index,i,d);e.set(this.type,t,r,o)};if(this.isGround&&(null==u.ground.dist||r<u.ground.dist)&&f(u.ground),e.options.isFiltered)return;if((null==u.min.dist||r<u.min.dist)&&f(u.min),(null==u.max.dist||r>u.max.dist)&&f(u.max),b){const t=s.newIntersectorResult(e.ray);f(t),e.results.all.push(t)}}})),!0)}))}}function d(e,t,i,n=0){const r=e[3]+n,s=t[0]-e[0],l=t[1]-e[1],o=t[2]-e[2],c=i[0],d=i[1],a=i[2],u=c*s+d*l+a*o;return u*u-(c*c+d*d+a*a)*(s*s+l*l+o*o-r*r)>=0}e.I3SIntersectionHandler=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
