/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/PooledArray","../../../core/workers/WorkerHandle","../../../geometry/projection","../../../geometry/projection/projectVectorToVector","../../../libs/i3s/enums"],(function(e,s,o,t,r,i,n){"use strict";class p extends t.WorkerHandle{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,s,o,t){const r={context:e,modifications:a(s,o,t),isGeodetic:t.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,s){const o=JSON.stringify(s);return this.broadcast({context:e,jsonSchema:o},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}project(e,s){return this.invokeMethod("project",e,s)}transformNormals(e,s){return this.invokeMethod("transformNormals",e,s)}}const h=new o({deallocator:null}),u=[0,0,0];function a(e,o,t){h.clear();let p=1/0,a=1/0,c=-1/0,f=-1/0,l=!1;for(const y of o){const e="clip"===y.type?n.ModificationType.Inside:"mask"===y.type?n.ModificationType.Outside:n.ModificationType.Replace,o=y.geometry;let d=e=>e;if(o.spatialReference){if(!r.canProjectWithoutEngine(o.spatialReference,t)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}d=e=>(i.projectVectorToVector(e,o.spatialReference,u,t),u)}else o.hasZ||(u[2]=0,d=e=>(u[0]=e[0],u[1]=e[1],u));l=l||e===n.ModificationType.Outside,h.push(e),h.push(o.rings.length);for(const s of o.rings){h.push(s.length);for(const e of s){const s=d(e);h.push(s[0]),h.push(s[1]),h.push(s[2]),p=Math.min(p,s[0]),a=Math.min(a,s[1]),c=Math.max(c,s[0]),f=Math.max(f,s[1])}}}if(null!=e)if(l){const s=1e-4;h.push(n.ModificationType.Inside),h.push(2),h.push(4),h.push(p-s),h.push(a-s),h.push(0),h.push(c+s),h.push(a-s),h.push(0),h.push(c+s),h.push(f+s),h.push(0),h.push(p-s),h.push(f+s),h.push(0),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0)}else h.push(n.ModificationType.Outside),h.push(1),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0);h.push(n.ModificationType.Finished);const d=new Float64Array(h.length);for(let s=0;s<h.length;++s)d[s]=h.at(s);return d}e.I3SMeshWorkerHandle=p,e.toWasmModification=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
