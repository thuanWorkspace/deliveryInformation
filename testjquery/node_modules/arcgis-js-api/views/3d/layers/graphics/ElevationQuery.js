/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../support/Scheduler","../../../../geometry/Multipoint"],(function(e,r,t,s,i,o){"use strict";class n{constructor(e,r){this.spatialReference=e,this._view=r}getElevation(e,r,t){return this._view.elevationProvider.getElevation(e,r,0,this.spatialReference,t)}async queryElevation(e,r,t,s,i){return this._view.elevationProvider.queryElevation(e,r,0,this.spatialReference,i,t,s)}}class a{constructor(e,r,t,s){this.spatialReference=r,this._getElevationQueryProvider=t,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(i.TaskPriority.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.running)if(e)this.runTask(i.noBudget);else for(const r of this._queries)r.result.reject(s.createAbortError())}queryElevation(e,r,i,o=0){const n=s.createResolver(),a={x:e,y:r,minDemResolution:o,result:n,signal:i};return this._queries.push(a),s.onAbort(i,(()=>{t.remove(this._queries,a),n.reject(s.createAbortError())})),n.promise}get running(){return this._queries.length>0}runTask(e){const r=this._queries;this._queries=[];const t=this._getElevationQueryProvider();if(!t)return r.forEach((e=>e.result.reject())),void e.madeProgress();const i=r.map((e=>[e.x,e.y])),n=r.reduce(((e,r)=>Math.min(e,r.minDemResolution)),1/0),a=new o({points:i,spatialReference:this.spatialReference}),l=r.length>1&&r.some((e=>!!e.signal))?new AbortController:null,u=null!=l?l.signal:r[0].signal;if(null!=l){let e=0;r.forEach((t=>s.onAbort(t.signal,(()=>{e++,t.result.reject(s.createAbortError()),e===r.length&&l.abort()}))))}const c={...this._queryOptions,minDemResolution:n,signal:u};t.queryElevation(a,c).then((e=>{r.forEach(((r,t)=>{null!=r.signal&&r.signal.aborted?r.result.reject(s.createAbortError()):r.result.resolve(e.geometry.points[t][2])}))})).catch((e=>{r.forEach((r=>r.result.reject(e)))})),e.madeProgress()}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask(i.noBudget)}}}e.ElevationQuery=a,e.ViewElevationProvider=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
