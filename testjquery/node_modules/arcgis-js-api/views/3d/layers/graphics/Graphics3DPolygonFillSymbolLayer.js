/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../core/screenUtils","../../../../chunks/earcut","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","../../../../geometry/support/FloatArray","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./lineUtils","./polygonUtils","../support/FastSymbolUpdates","../support/patternUtils","../support/uvUtils","../../support/engineContent/line","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/PatternMaterial","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,r,a,n,o,s,l,c,p,d,u,h,y,m,g,_,f,b,D,x,A,O,v){"use strict";const S=["polyline","polygon","extent"],C=new m.ConvertOptions({size:!1,color:!0,rotation:!1,opacity:!1});class P extends p.Graphics3DSymbolLayer{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1}async doLoad(){this._fastUpdates=m.initFastSymbolUpdatesState(this._context.renderer,C)}_createMaterials(){if(this._materials.length>0)return;const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e);this._materials[R.Fill]=g.createMaterial(this.symbolLayer,{color:t,forceTransparentMode:this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[R.Fill]instanceof O.PatternMaterial;const r=this.symbolLayer.outline;if(this._isValidOutline(r)){const e=A.getStipplePatternForLinePattern(r.pattern);this._materials[R.Outline]=new v.RibbonLineMaterial({width:i.pt2px(r.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:h.parseCapType(r.patternCap||"butt")})}this._context.stage.addMany(this._materials)}_isValidOutline(e){return null!=e?.size&&e.size>0&&null!=e.color&&(null==e.pattern||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,S,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this._createMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return u.ApplyRendererDiffResult.RecreateSymbol;if(!m.updateFastSymbolUpdatesState(this._fastUpdates,t,C))return u.ApplyRendererDiffResult.RecreateSymbol;this._materials[R.Fill]?.setParameters(this._fastUpdates.materialParameters)}return u.ApplyRendererDiffResult.FastUpdate}layerOpacityChanged(){if(null!=this._materials[R.Fill]){const e=this._materials[R.Fill].parameters.color,t=this.symbolLayer?.material?.color,i=this._getCombinedOpacity(t);this._materials[R.Fill].setParameters({color:[e[0],e[1],e[2],i],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[R.Outline]){const e=this._materials[R.Outline].parameters.color;this._materials[R.Outline].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=s.elevationModeChangeUpdateType(P.elevationModeChangeTypes,i,r);if(a!==s.SymbolUpdateType.UPDATE)return a;const n=s.needsElevationUpdates2D(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){if(this._materials[R.Fill]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[R.Outline]){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[R.Outline].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){const r=y.geometryAsPolygon(e.geometry);if(!r)return null;const a=b.geometryToRenderInfo(r,this._context.elevationProvider,this._context.renderCoordsHelper,i),l=new G(a,t,this._context.layer.uid,e.uid),p=l.renderData.position.length/3;if(this._needsUV&&(l.uvMapSpace=o.newFloatArray(4*p,!0),l.boundingRect=n.newDoubleArray(9*p,!0),_.createMapSpaceUVCoords(l.uvMapSpace,l.boundingRect,l.renderData.position,this._context.renderCoordsHelper)),l.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(l),this._createAs3DShapeFill(e,l),this._materials[R.Outline]&&this._createAs3DShapeOutline(l),this._logGeometryCreationWarnings(l.renderData,r.rings,"rings","FillSymbol3DLayer"),0===l.outGeometries.length)return null;const d=new D.Object3D({geometries:l.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:e.uid}),u=new c.Graphics3DObject3DGraphicLayer(this,d,l.outGeometries,null,null,g.uvElevationAligner,i);return u.alignedSampledElevation=l.renderData.sampledElevation,u.needsElevationUpdates=s.needsElevationUpdates2D(i.mode),u}_createAs3DShapeFill(e,t){const i=t.renderData.polygons;for(const{position:r,mapPositions:s,holeIndices:l,index:c,count:p}of i){if(null!=this._context.clippingExtent&&(a.empty(U),a.expandWithBuffer(U,s),!a.intersectsClippingArea(U,this._context.clippingExtent)))continue;const i=y.createIndices3D(s,l,this._context.elevationProvider.spatialReference);if(0===i.length)continue;const d=this._fastUpdates?.visualVariables.color,u=y.createColorGeometry({material:this._materials[R.Fill],indices:i,mapPositions:s,attributeData:{position:r,color:d?null:t.color,colorFeature:d?m.getAttributeValue(d.field,e):null,uvMapSpace:this._needsUV?o.floatSubArray(t.uvMapSpace,4*c,4*p):null,boundingRect:this._needsUV?n.doubleSubArray(t.boundingRect,9*c,9*p):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(u)}}_createAs3DShapeOutline(e){if(null==this._materials[R.Outline])return;const t=e.renderData.outlines;for(const{mapPositions:i,position:r}of t){if(null!=this._context.clippingExtent&&(a.empty(U),a.expandWithBuffer(U,i),!a.intersectsClippingArea(U,this._context.clippingExtent)))continue;const t=f.createGeometry(this._materials[R.Outline],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:i,attributeData:{position:r}},e.objectAndLayerIdColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){const i=y.geometryAsPolygon(e.geometry);if(null==i)return null;this._materials[R.Fill].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[R.Outline]&&(this._materials[R.Outline].renderPriority=this._renderPriority);const r=b.geometryToRenderInfoDraped(i,this._context.overlaySR),n=new L(r,t,this._context.layer.uid,e.uid),s=n.renderData.position.length/3;return this._needsUV&&(n.uvMapSpace=o.newFloatArray(4*s,!0),_.createMapSpaceUVCoordsDraped(n.uvMapSpace,n.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),n.outBoundingBox=a.empty(),n.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(n),this._createAsOverlayFill(e,n),this._materials[R.Outline]&&this._createAsOverlayOutline(n),this._logGeometryCreationWarnings(n.renderData,i.rings,"rings","FillSymbol3DLayer"),0===n.outGeometries.length?null:new l.Graphics3DDrapedGraphicLayer(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){const i=t.renderData.polygons;for(const{position:n,holeIndices:s,index:l,count:c}of i){const i=a.empty(U);if(a.expandWithBuffer(i,n),!a.intersectsClippingArea(i,this._context.clippingExtent))continue;const p=r.earcut(n,s,3);if(0===p.length)continue;a.expandWithAABB(t.outBoundingBox,i);const d=this._fastUpdates?.visualVariables.color,u=y.createColorGeometry({material:this._materials[R.Fill],indices:p,attributeData:{position:n,color:d?null:t.color,colorFeature:d?m.getAttributeValue(d.field,e):null,uvMapSpace:this._needsUV?o.floatSubArray(t.uvMapSpace,4*l,4*c):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(new x.RenderGeometry(u,t))}}_createAsOverlayOutline(e){if(null==this._materials[R.Outline])return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(a.empty(U),a.expandWithBuffer(U,r),!a.intersectsClippingArea(U,this._context.clippingExtent))continue;a.expandWithAABB(e.outBoundingBox,U);const n=f.createGeometry(this._materials[R.Outline],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.objectAndLayerIdColor);e.outGeometries.push(new x.RenderGeometry(n,e))}}_getOutlineOpacity(){const e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(null!=e?e.a:0)}_getOutlineColor(){const e=this.symbolLayer?.outline?.color,i=this._getOutlineOpacity();return d.mixinColorAndOpacity(null!=e?t.toUnitRGB(e):null,i)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}P.elevationModeChangeTypes={definedChanged:s.SymbolUpdateType.RECREATE,staysOnTheGround:s.SymbolUpdateType.NONE,onTheGroundChanged:s.SymbolUpdateType.RECREATE};const U=a.create();class G extends y.PolygonCreationDataBase{constructor(e,t,i,r){super(e,i,r),this.color=t}}class L extends y.PolygonCreationDataBase{constructor(e,t,i,r){super(e,i,r),this.color=t}}var R;!function(e){e[e.Fill=0]="Fill",e[e.Outline=1]="Outline"}(R||(R={})),e.Graphics3DPolygonFillSymbolLayer=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
