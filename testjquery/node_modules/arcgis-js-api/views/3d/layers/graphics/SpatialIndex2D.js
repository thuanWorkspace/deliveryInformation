/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/rbush/PooledRBush","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures"],(function(e,t,s,i,n,a,r,o,d,c,p,u){"use strict";e.SpatialIndex2D=class extends s{constructor(e){super(e),this._index=new c.PooledRBush(9,i("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=n.destroyMaybe(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,s){null!=t&&t.equals(this.spatialReference)&&(l.minX=e[0],l.minY=e[1],l.maxX=e[2],l.maxY=e[3],this.update(),this._index.search(l,(e=>s(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=u.getObjectId(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const s of e){s.computeExtent(this.spatialReference);const e=u.getObjectId(s.graphic,t);null!=e&&this._boundsByFeature.set(e,s.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){l.minX=e[0],l.minY=e[1],l.maxX=e[2],l.maxY=e[3],this.update(),this._index.search(l,(e=>{t(e)}))}getBounds(e,t){this.update();const s=this._boundsByFeature.get(e);return s?p.fromRect(t,s):null}},t.__decorate([a.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"spatialReference",void 0),t.__decorate([a.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasZ",void 0),t.__decorate([a.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasM",void 0),t.__decorate([a.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"objectIdField",void 0),t.__decorate([a.property()],e.SpatialIndex2D.prototype,"updating",void 0),t.__decorate([a.property({readOnly:!0})],e.SpatialIndex2D.prototype,"updatingRemaining",null),e.SpatialIndex2D=t.__decorate([d.subclass("esri.views.3d.layers.graphics.SpatialIndex2D")],e.SpatialIndex2D);const l={minX:0,minY:0,maxX:0,maxY:0};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
