/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/promiseUtils","./defaultSymbolComplexity","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCreationContext","./Graphics3DSymbolLayerFactory","./interfaces","./Loadable"],(function(e,t,r,s,a,o,l,n,i,y,h){"use strict";class c extends h.Loadable{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=e,s.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const a=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const o=[];for(let r=0;r<a;r++){const l=t.at(r);if(!1===l.enabled)continue;d.renderPriority=1-(1+r)/a,d.renderPriorityStep=1/a,d.ignoreDrivers=l.ignoreDrivers;const n=i.make(this.symbol,l,this._context,d),y=s.onAbortOrThrow(e,(()=>{this.symbolLayers[r]=null,n.destroy()}));y&&o.push(y),this.symbolLayers[r]=n}if(await r.forEach(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),o.forEach((e=>e.remove())),s.throwIfAborted(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>e?.queryForSnapping))}createGraphics3DGraphic(e,t){const r=e.graphic,s=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),a=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new o.Graphics3DGraphic(r,t||this,s,e.layer,a)}get complexity(){return a.totalSymbolComplexities(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],a=e=>{const t=e.layers[s];return t instanceof l.Graphics3DObject3DGraphicLayer?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,a))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==h.LoadStatus.LOADED?y.ApplyRendererDiffResult.RecreateSymbol:this.symbolLayers.reduce(((r,s)=>r!==y.ApplyRendererDiffResult.RecreateSymbol&&null!=s?Math.min(r,s.applyRendererDiff(e,t)):r),y.ApplyRendererDiffResult.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===h.LoadStatus.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach(((t,s)=>{if(null==t)return;const a=r[s];if(a){const r={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const a=e.layers[s];null!=a&&r.graphics3DGraphicPatches.forEach((e=>e(a,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,r)=>e.updateGeometry(r,t)))}updateTransform(e,t,r,s){return this._updateGeometryOrTransform(e,((e,a)=>e.updateTransform(a,t,r,s)))}_updateGeometryOrTransform(e,t){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const a=e.layers[r];if(!a||!t(s,a))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const s=e.layers[t];null!=s&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,t=0,r=0;return this.symbolLayers.forEach((s=>{null!=s&&(s.loadStatus===h.LoadStatus.LOADING?e++:s.isFastUpdatesEnabled()?r++:t++)})),{loading:e,slow:t,fast:r}}async queryForSnapping(e,r,a,o){const l=this.symbolLayers.filter(t.isSome).filter((e=>null!=e.queryForSnapping)).map((t=>t.queryForSnapping(e,r,a,o))),n=await Promise.all(l);return s.throwIfAborted(o),n.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const d=new n.Graphics3DSymbolLayerCreationContext;e.Graphics3DSymbol=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
