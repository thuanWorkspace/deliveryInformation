/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/devEnvironmentUtils","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/FloatArray","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../chunks/vec42","../../../../chunks/vec22","../../../../chunks/vec33","../../../../chunks/vec43","../../glTF/DefaultLoadingContext","../../glTF/loader","../../glTF/internal/indexUtils","../../glTF/internal/resourceUtils","../../glTF/internal/TextureTransformUtils","./ProcessedObjectResource","./wosrLoader","../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../webgl-engine/materials/pbrUtils"],(function(e,t,r,o,s,n,i,a,l,u,c,d,m,f,g,x,p,b,h,T,M,y,w,R,v,B,A,F,V,S,L,E){"use strict";async function O(e,r){const o=C(t.adjustStaticAGOUrl(e));if("wosr"===o.fileType){const e=await(r.cache?r.cache.loadWOSR(o.url,r):w.load(o.url,r)),{engineResources:t,referenceBoundingBox:s}=w.processLoadResult(e,r);return{lods:t,referenceBoundingBox:s,isEsriSymbolResource:!1,isWosr:!0}}const s=await(r.cache?r.cache.loadGLTF(o.url,r,!!r.usePBR):b.loadGLTF(new p.DefaultLoadingContext(r.streamDataRequester),o.url,r,r.usePBR)),n=s.model.meta?.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&null!=n&&s.meta.uri.includes("/RealisticTrees/");i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,G(s,n));const a=!!r.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:a,isSchematic:!1,treeRendering:i,mrrFactors:[...E.defaultEsriSymbologyMRRFactors]}:{usePBR:a,isSchematic:!1,treeRendering:!1,mrrFactors:[...E.defaultAdvancedMRRFactors]},u={...r.materialParameters,treeRendering:i},{engineResources:c,referenceBoundingBox:d}=k(s,l,u,r.skipHighLods&&null==o.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:o.specifiedLodIndex});return{lods:c,referenceBoundingBox:d,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function C(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function k(e,t,r,o){const s=e.model,n=new Array,i=new Map,a=new Map,u=s.lods.length,c=l.empty();return s.lods.forEach(((e,d)=>{const m=!0===o.skipHighLods&&(u>1&&0===d||u>3&&1===d)||!1===o.skipHighLods&&null!=o.singleLodIndex&&d!==o.singleLodIndex;if(m&&0!==d)return;const f=new y.ProcessedObjectResource(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach((e=>{const o=m?new S.DefaultMaterial({}):I(s,e,f,t,r,i,a),{geometry:n,vertexCount:u}=D(e,null!=o?o:new S.DefaultMaterial({})),g=n.boundingInfo;null!=g&&0===d&&(l.expandWithVec3(c,g.bbMin),l.expandWithVec3(c,g.bbMax)),null!=o&&(f.stageResources.geometries.push(n),f.numberOfVertices+=u)})),m||n.push(f)})),{engineResources:n,referenceBoundingBox:c}}function I(e,t,r,o,s,n,i){const a=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),l=e.materials.get(t.material),u=null!=t.attributes.texCoord0,c=null!=t.attributes.normal;if(null==l)return null;const d=P(l.alphaMode);if(!n.has(a)){if(u){const t=(t,r=!1)=>{if(null!=t&&!i.has(t)){const o=e.textures.get(t);if(null!=o){const e=o.data;i.set(t,new F.Texture(T.isEncodedMeshTexture(e)?e.data:e,{...o.parameters,preMultiplyAlpha:!T.isEncodedMeshTexture(e)&&r,encoding:T.isEncodedMeshTexture(e)&&null!=e.encoding?e.encoding:void 0}))}}};t(l.textureColor,d!==B.AlphaDiscardMode.Opaque),t(l.textureNormal),t(l.textureOcclusion),t(l.textureEmissive),t(l.textureMetallicRoughness)}const r=l.color[0]**(1/L.colorGamma),m=l.color[1]**(1/L.colorGamma),f=l.color[2]**(1/L.colorGamma),g=l.emissiveFactor[0]**(1/L.colorGamma),x=l.emissiveFactor[1]**(1/L.colorGamma),p=l.emissiveFactor[2]**(1/L.colorGamma),b=null!=l.textureColor&&u?i.get(l.textureColor):null,h=E.useSchematicPBR({normalTexture:l.textureNormal,metallicRoughnessTexture:l.textureMetallicRoughness,metallicFactor:l.metallicFactor,roughnessFactor:l.roughnessFactor,emissiveTexture:l.textureEmissive,emissiveFactor:l.emissiveFactor,occlusionTexture:l.textureOcclusion});n.set(a,new S.DefaultMaterial({...o,transparent:d===B.AlphaDiscardMode.Blend,customDepthTest:B.DepthTestFunction.Lequal,textureAlphaMode:d,textureAlphaCutoff:l.alphaCutoff,diffuse:[r,m,f],ambient:[r,m,f],opacity:l.opacity,doubleSided:l.doubleSided,doubleSidedType:"winding-order",cullFace:l.doubleSided?B.CullFaceOptions.None:B.CullFaceOptions.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:c?R.NormalType.Attribute:R.NormalType.ScreenDerivative,castShadows:!0,textureId:null!=b?b.id:void 0,colorMixMode:l.colorMixMode,normalTextureId:null!=l.textureNormal&&u?i.get(l.textureNormal).id:void 0,textureAlphaPremultiplied:null!=b&&!!b.parameters.preMultiplyAlpha,occlusionTextureId:null!=l.textureOcclusion&&u?i.get(l.textureOcclusion).id:void 0,emissiveTextureId:null!=l.textureEmissive&&u?i.get(l.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=l.textureMetallicRoughness&&u?i.get(l.textureMetallicRoughness).id:void 0,emissiveFactor:[g,x,p],mrrFactors:h?[...E.defaultSchematicMRRFactors]:[l.metallicFactor,l.roughnessFactor,o.mrrFactors[2]],isSchematic:h,colorTextureTransformMatrix:M.getTransformMatrix(l.colorTextureTransform),normalTextureTransformMatrix:M.getTransformMatrix(l.normalTextureTransform),occlusionTextureTransformMatrix:M.getTransformMatrix(l.occlusionTextureTransform),emissiveTextureTransformMatrix:M.getTransformMatrix(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:M.getTransformMatrix(l.metallicRoughnessTextureTransform),...s}))}const m=n.get(a);if(r.stageResources.materials.push(m),u){const e=e=>{null!=e&&r.stageResources.textures.push(i.get(e))};e(l.textureColor),e(l.textureNormal),e(l.textureOcclusion),e(l.textureEmissive),e(l.textureMetallicRoughness)}return m}function D(e,t){const o=e.attributes.position.count,s=h.convertPrimitiveToTriangles(e.indices||o,e.primitiveType),n=u.newFloatArray(3*o),{typedBuffer:i,typedBufferStride:a}=e.attributes.position;d.transformMat4(n,i,e.transform,3,a);const l=[[V.VertexAttribute.POSITION,new v.Attribute(n,s,3,!0)]];if(null!=e.attributes.normal){const t=u.newFloatArray(3*o),{typedBuffer:n,typedBufferStride:i}=e.attributes.normal;r.normalFromMat4(N,e.transform),d.transformMat3(t,n,N,3,i),l.push([V.VertexAttribute.NORMAL,new v.Attribute(t,s,3,!0)])}if(null!=e.attributes.tangent){const t=u.newFloatArray(4*o),{typedBuffer:n,typedBufferStride:i}=e.attributes.tangent;r.normalFromMat4(N,e.transform),m.transformMat3(t,n,N,4,i),l.push([V.VertexAttribute.TANGENT,new v.Attribute(t,s,4,!0)])}if(null!=e.attributes.texCoord0){const t=u.newFloatArray(2*o),{typedBuffer:r,typedBufferStride:n}=e.attributes.texCoord0;f.normalizeIntegerBuffer(t,r,2,n),l.push([V.VertexAttribute.UV0,new v.Attribute(t,s,2,!0)])}if(null!=e.attributes.color){const t=new Uint8Array(4*o);4===e.attributes.color.elementCount?e.attributes.color instanceof c.BufferViewVec4f?m.scale(t,e.attributes.color,255):e.attributes.color instanceof c.BufferViewVec4u8?x.copy(t,e.attributes.color):e.attributes.color instanceof c.BufferViewVec4u16&&m.scale(t,e.attributes.color,1/256):(t.fill(255),e.attributes.color instanceof c.BufferViewVec3f?d.scale(t,e.attributes.color,255,4):e.attributes.color instanceof c.BufferViewVec3u8?g.copy(t,e.attributes.color.typedBuffer,4,e.attributes.color.typedBufferStride):e.attributes.color instanceof c.BufferViewVec3u16&&d.scale(t,e.attributes.color,1/256,4)),l.push([V.VertexAttribute.COLOR,new v.Attribute(t,s,4,!0)])}return{geometry:new A.Geometry(t,l),vertexCount:o}}const N=o.create();function P(e){switch(e){case"BLEND":return B.AlphaDiscardMode.Blend;case"MASK":return B.AlphaDiscardMode.Mask;case"OPAQUE":case null:case void 0:return B.AlphaDiscardMode.Opaque}}function G(e,t){for(let r=0;r<e.model.lods.length;++r){const o=e.model.lods[r];for(const l of o.parts){const o=l.attributes.normal;if(null==o)return;const u=l.attributes.position,d=u.count,m=a.create(),f=a.create(),g=a.create(),x=new Uint8Array(4*d),p=new Float64Array(3*d),b=s.invert(n.create(),l.transform);let h=0,T=0;for(let s=0;s<d;s++){u.getVec(s,f),o.getVec(s,m),i.transformMat4(f,f,l.transform),i.subtract(g,f,t.center),i.divide(g,g,t.radius);const n=g[2],a=i.length(g),c=Math.min(.45+.55*a*a,1);i.divide(g,g,t.radius),null!==b&&i.transformMat4(g,g,b),i.normalize(g,g),r+1!==e.model.lods.length&&e.model.lods.length>1&&(n>-1?i.lerp(g,g,m,.2):i.lerp(g,g,m,Math.min(-4*n-3.8,1))),p[h]=g[0],p[h+1]=g[1],p[h+2]=g[2],h+=3,x[T]=255*c,x[T+1]=255*c,x[T+2]=255*c,x[T+3]=255,T+=4}l.attributes.normal=new c.BufferViewVec3f(p),l.attributes.color=new c.BufferViewVec4u8(x)}}}e.fetch=O,e.gltfToEngineResources=k,e.parseUrl=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
