/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","./elevationAlignmentUtils","./graphicUtils","../../support/debugFlags","../../support/ElevationProvider","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/VertexAttribute"],(function(e,t,n,o,a,r,i,s,l,c,u,f,g){"use strict";function p(e,t,n,o,a){const r=e.stageObject,i=r.geometries;let s=0;for(const l of i){if(!f.isGeometryWithMapPositions(l))continue;const{update:e,averageGeometrySampledElevation:i}=y(l,t,n,o,a);s+=i,e&&r.geometryVertexAttributeUpdated(l,g.VertexAttribute.POSITION)}return s/i.length}function d(e,n,a,i,s,u){const f=e.stageObject,g=n.centerPointInElevationSR;let p=0;if(f.usesVerticalDistanceToGround)i(g,E),l.updateVertexAttributeAuxpos1w(f,E.verticalDistanceToGround),p=E.sampledElevation;else{i(g,E);"absolute-height"!==n.mode&&(p=E.sampledElevation)}const d=t.copy(m,u??f.transformation),b=o.set(O,d[12],d[13],d[14]);c.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(S[0]=g.x,S[1]=g.y,S[2]=E.z,r.computeTranslationToOriginAndRotation(g.spatialReference,S,d,s.spatialReference)&&(u?t.copy(u,d):f.transformation=d)):s.setAltitudeOfTransformation(E.z,d);const I=T/s.unitInMeters;return(Math.abs(d[12]-b[0])>=I||Math.abs(d[13]-b[1])>=I||Math.abs(d[14]-b[2])>=I)&&(u?t.copy(u,d):f.transformation=d),p}const m=n.create();function b(e,t,n,a,i){const s=e.graphics3DSymbolLayer.lodRenderer;if(null==s)return 0;const l=t.centerPointInElevationSR;a(l,E);const u="absolute-height"!==t.mode?E.sampledElevation:0,f=s.instanceData,g=e.instanceIndex,p=v;f.getGlobalTransform(g,p);const d=o.set(O,p[12],p[13],p[14]);c.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(S[0]=l.x,S[1]=l.y,S[2]=E.z,r.computeTranslationToOriginAndRotation(l.spatialReference,S,p,i.spatialReference)&&f.setGlobalTransform(g,p)):i.setAltitudeOfTransformation(E.z,p);const m=T/i.unitInMeters;return(c.debugFlags.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(p[12]-d[0])>=m||Math.abs(p[13]-d[1])>=m||Math.abs(p[14]-d[2])>=m)&&f.setGlobalTransform(g,p),u}function I(e,t,n,o,a){const r=e.stageObject,i=r.geometries;if(0===i.length)return 0;let s=0,l=null,c=0,u=!1;for(const p of i){if(!f.isGeometryWithMapPositions(p))continue;const e=p.attributes.get(g.VertexAttribute.POSITION);if(e!==l){const{update:r,averageGeometrySampledElevation:i}=y(p,t,n,o,a);c=i,l=e,u=r}u&&r.geometryVertexAttributeUpdated(p,g.VertexAttribute.POSITION),s+=c}return s/i.length}const T=.01,S=a.create(),A=a.create(),h=a.create(),v=n.create(),O=a.create(),E=new s.SampleElevationInfo;function y(e,t,n,o,a){let r=!1;const s=e.transformation,l=t.requiresSampledElevationInfo;A[0]=s[12],A[1]=s[13],A[2]=s[14],e.invalidateBoundingInfo();const f=e.getMutableAttribute(g.VertexAttribute.POSITION),p=f.data,d=f.size,m=p.length/d,b=new u.SamplePosition(e.mapPositions,n);let I=0,v=0;for(let u=0;u<m;u++){if(h[0]=p[I],h[1]=p[I+1],h[2]=p[I+2],o(b,E),l&&(v+=E.sampledElevation),c.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)p[I]=b.array[b.offset],p[I+1]=b.array[b.offset+1],p[I+2]=E.z,i.projectBuffer(p,n,I,p,a.spatialReference,I,1),p[I]-=A[0],p[I+1]-=A[1],p[I+2]-=A[2],r=!0;else{S[0]=p[I]+A[0],S[1]=p[I+1]+A[1],S[2]=p[I+2]+A[2],a.setAltitude(S,E.z),p[I]=S[0]-A[0],p[I+1]=S[1]-A[1],p[I+2]=S[2]-A[2];const e=T/a.unitInMeters;(Math.abs(h[0]-p[I])>=e||Math.abs(h[1]-p[I+1])>=e||Math.abs(h[2]-p[I+2])>=e)&&(r=!0)}I+=d,b.offset+=3}return v/=m,{update:r,averageGeometrySampledElevation:v}}e.perLodInstanceElevationAligner=b,e.perObjectElevationAligner=d,e.perVertexElevationAligner=p,e.sharedGeometryElevationAligner=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
