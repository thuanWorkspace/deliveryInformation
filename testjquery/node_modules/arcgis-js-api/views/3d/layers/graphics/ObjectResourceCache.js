/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/promiseUtils","../../glTF/DefaultLoadingContext","../../glTF/loader","./wosrLoader"],(function(e,t,o,r,s,a){"use strict";class l{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,o){const a=o?`gltfPBR:${e}`:`gltf:${e}`,l=this._gltfMemCache.get(a);return null!=l?Promise.resolve(l):this._loadOnce(this._gltfLoading,this._gltfMemCache,a,(t=>s.loadGLTF(new r.DefaultLoadingContext(t.streamDataRequester),e,t,o)),t)}loadWOSR(e,t){const o=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(o);return null!=r?Promise.resolve(r):this._loadOnce(this._wosrLoading,this._wosrMemCache,o,(t=>a.load(e,t)),t)}async _loadOnce(e,r,s,a,l){o.throwIfAborted(l);const n=o.onAbort(l,(()=>this._abortLoad(e,s)));let i=e.get(s);if(i)i.refCount++;else{const t=new AbortController;i={refCount:1,abortController:t,promise:a({...l,signal:t.signal})},e.set(s,i)}try{const t=await i.promise;return r.put(s,t,t.size),e.delete(s),o.throwIfAborted(l),t}finally{t.removeMaybe(n)}}_abortLoad(e,t){const o=e.get(t);if(null!=o){if(--o.refCount>0)return}e.delete(t),null!=o&&o.abortController.abort()}}e.ObjectResourceCache=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
