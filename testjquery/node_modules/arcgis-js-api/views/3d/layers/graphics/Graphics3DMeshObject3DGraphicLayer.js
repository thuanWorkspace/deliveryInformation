/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","./ElevationAligners","./elevationAlignmentUtils","./featureExpressionInfoUtils","./Graphics3DObject3DGraphicLayer"],(function(t,e,a,r,s,i,n,o,l){"use strict";class m extends l.Graphics3DObject3DGraphicLayer{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(t,a){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:r}=this,s=r.geometries.slice();r.removeAllGeometries();const i=e.getTranslation(f,r.transformation),n=a.getOrigin(i);for(const e of s){const a=t(e.material),s=e.instantiate({material:a});s.localOrigin=n,r.addGeometry(s)}this._originalGeometries=s}disableFastTransformUpdates(t){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:e}=this,a=e.geometries.map((e=>t(e.material)));e.removeAllGeometries();for(let r=0;r<this._originalGeometries.length;r++){const t=this._originalGeometries[r],s=a[r];s.setParameters({modelTransformation:null}),s===t.material?e.addGeometry(t):e.addGeometry(t.instantiate({material:s}))}this._originalGeometries.length=0}updateFastLocalOrigin(t,r,s){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:i}=this;if(0===i.geometries.length)return;const n=i.geometries[0].localOrigin,o=e.getTranslation(f,t),l=s.getOrigin(o);if(l===n)return;const m=r?.localMatrix??a.IDENTITY;i.shaderTransformation=null,i.transformation=t,i.geometries.forEach((t=>{t.transformation=m,t.localOrigin=l}))}updateTransform(t,r,s){const{stageObject:i}=this,n=r?.localMatrix??a.IDENTITY;if(!this._fastTransformUpdatesEnabled)return i.shaderTransformation=null,i.transformation=t,i.geometries.forEach((t=>{t.transformation=n})),void(this._fastUpdateEdgeTransform()||this.resetEdgeObject(s));const o=i.transformation,l=i.geometries[0].transformation,m=t,f=n,g=e.multiply(c,o,l),p=e.multiply(d,m,f),u=e.multiply(h,p,e.invert(h,l));i.shaderTransformation=u,this._setFastMaterialTransformation({matA:g,matB:p}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(s)}alignWithElevation(t,a,r,s){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(t,a,r,s);null!=r&&o.setContextFeature(this.elevationContext.featureExpressionInfoContext,r);const l=(e,r)=>n.evaluateElevationInfoAtPoint(e,t,this.elevationContext,a,r),{stageObject:m}=this;if(!m.geometries[0].material.parameters.modelTransformation)return;const f=m.transformation,h=m.geometries[0].transformation,p=e.multiply(c,f,h),u=m.effectiveTransformation,T=e.copy(g,u);this.alignedSampledElevation=i.perObjectElevationAligner(this,this.elevationContext,t.spatialReference,l,a,T),m.shaderTransformation=T;const E=m.geometries[0].transformation,b=e.multiply(d,T,E);this._setFastMaterialTransformation({matA:p,matB:b}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(s)}_setFastMaterialTransformation({matA:t,matB:a}){const{stageObject:s}=this;if(0===s.geometries.length)return;const i=s.geometries[0].localOrigin,n=e.fromTranslation(T,r.scale(f,i.vec3,-1)),o=e.multiply(p,n,t),l=e.multiply(u,n,a),m=e.invert(p,o),c=e.multiply(u,l,m);for(const e of s.geometries)e.material.setParameters({modelTransformation:c})}_fastUpdateEdgeTransform(){return this._stageLayer.stage.renderer.ensureEdgeView().fastUpdateObject3DEdgesTransform(this.stageObject)}}const f=s.create(),c=a.create(),d=a.create(),g=a.create(),h=a.create(),p=a.create(),u=a.create(),T=a.create();t.Graphics3DMeshObject3DGraphicLayer=m,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
