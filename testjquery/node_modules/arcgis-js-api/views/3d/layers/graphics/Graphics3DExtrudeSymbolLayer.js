/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/Error","../../../../core/lang","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","../../../../geometry/support/Indices","../../../../chunks/vec32","../../../../layers/graphics/data/SnappingCandidate","../../../../renderers/support/renderingInfoUtils","../../../ViewingMode","./elevationAlignmentUtils","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./polygonUtils","../support/edgeUtils","../../support/debugFlags","../../support/ElevationProvider","../../support/renderInfoUtils/polygon","../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/Normals","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,r,a,i,s,o,l,c,h,d,u,p,g,m,y,b,f,_,x,S,A,P,v,w,M,E,C,O,D,I,L,z,G,R,B,T,U,V){"use strict";const k=["polygon","extent"];class j extends A.Graphics3DSymbolLayer{constructor(e,t,n,r){super(e,t,n,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=P.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new n("graphics3dextrudesymbollayer:invalid-size",e)}const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e),r=d.fromArray(t),a=t[3],i=a<1||this.needsDrivenTransparentPass,s={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:a,transparent:i,cullFace:i?L.CullFaceOptions.None:L.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:D.NormalType.Compressed};this._materials[le.Main]=new V.DefaultMaterial(s),this._materials[le.Bottom]=new V.DefaultMaterial({...s,cullFace:L.CullFaceOptions.Back}),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,k,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)}layerOpacityChanged(e,t){const n=this.symbolLayer?.material?.color,r=this._getCombinedOpacity(n),a=r<1||this.needsDrivenTransparentPass;this._materials[le.Main]?.setParameters({opacity:r,transparent:a}),this._materials[le.Bottom]?.setParameters({opacity:r,transparent:a});const i=this._getLayerOpacity();e.forEach((e=>{const n=t(e);null!=n&&n.layerOpacityChanged(i,this._context.isAsync)}))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,x.needsElevationUpdates3D)}slicePlaneEnabledChanged(e,t){return this._materials[le.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[le.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const n=t(e);null!=n&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[le.Main]?.setParameters(e),this._materials[le.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?f.getDriverAxisSizeValue(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?v.ApplyRendererDiffResult.RecreateSymbol:v.ApplyRendererDiffResult.RecreateGraphics}async queryForSnapping(e,t,n,i){const s=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/a.getMetersPerVerticalUnitForSR(t),{objectId:o,target:l}=e,c=r.clone(l);switch(c.z=(c.z??0)+s,e.type){case"edge":{const{start:t,end:n}=e,a=r.clone(t),i=r.clone(n);return a.z=(a.z??0)+s,i.z=(i.z??0)+s,[b.makeEdgeCandidate(o,c,1/0,a,i)]}case"vertex":return[b.makeVertexCandidate(o,c,1/0),b.makeEdgeCandidate(o,l,1/0,l,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,n,r,a){const h=w.geometryAsPolygon(e.geometry);if(null==h)return null;if(0===h.rings.length||!h.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(h.rings,"rings","ExtrudeSymbol3DLayer"),null;const b=O.geometryToRenderInfo(h,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(b,h.rings,"rings","ExtrudeSymbol3DLayer");const f=P.computeCentroid(h);if(null==f)return null;const A=new Array,v=new Array,E=p.create(),C=c.create(),D=d.create(),I=this._context.renderCoordsHelper.viewingMode===_.ViewingMode.Global;I||this._context.renderCoordsHelper.worldUpAtPosition(null,D),u.computeTranslationToOriginAndRotation(h.spatialReference,[f.x,f.y,0],C,this._context.renderCoordsHelper.spatialReference);const L=c.create();l.invert(L,C);const z=o.create();s.normalFromMat4(z,L);const{polygons:G,mapPositions:R,position:U}=b;for(const s of G){const e=s.count;if(this._context.clippingExtent&&(p.empty(E),p.expandWithBuffer(E,s.mapPositions),!p.intersectsClippingArea(E,this._context.clippingExtent)))continue;const r=i.earcut(s.mapPositions,s.holeIndices,3);if(0===r.length)continue;const o=r.length,l=6*e,c=l+o,h=m.newIndexArray(c),d=m.newIndexArray(o),u=g.newDoubleArray(3*l),b=g.newDoubleArray(3*l),f=g.newDoubleArray(3*l),_=g.newDoubleArray(l);F(U,R,r,s,u,f,b,_,h,d,this._getExtrusionSize(t),D,I),y.transformMat4(u,u,L);const x=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid}),S=new ce(u,f,B.compressNormals(b),_);A.push(N(this._materials[le.Main],h,h.length-d.length,S,n,x),N(this._materials[le.Bottom],d,0,S,n,x)),v.push(S.heights)}if(0===A.length)return null;const V=new T.Object3D({geometries:A,layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0});V.transformation=C;const k=M.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),j=null!=k?{baseMaterial:this._materials[le.Main],edgeMaterials:[k],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,H=(e,t,n,r,a)=>te(e,t,n,r,a,v),W=new S.Graphics3DObject3DGraphicLayer(this,V,A,null,null,H,r,j);return W.alignedSampledElevation=b.sampledElevation,W.needsElevationUpdates=x.needsElevationUpdates3D(r.mode),W}}function N(e,t,n,r,a,i){const s=m.getZeroIndexArray(t.length),o=[[U.VertexAttribute.POSITION,new I.Attribute(r.positions,t,3,!0)],[U.VertexAttribute.NORMALCOMPRESSED,new I.Attribute(r.normals,t,2,!0)],[U.VertexAttribute.COLOR,new I.Attribute(a,s,4,!0)]];return new G.Geometry(e,o,r.elevation,z.ContentObjectType.Mesh,i,n)}function F(e,t,n,r,a,i,s,o,l,c,h,d,u){const p=n.length/3;let g=0,m=2*r.count;H(e,t,r.index,r.count,n,0,p,a,i,s,o,l,c,m,h,d,u);let y=2*r.count;m=0,q(a,i,o,s,g,r.pathLengths[0],r.count,y,l,m,h),y+=4*r.pathLengths[0],m+=2*r.pathLengths[0],g+=r.pathLengths[0];for(let b=1;b<r.pathLengths.length;++b)q(a,i,o,s,g,r.pathLengths[b],r.count,y,l,m,h),y+=4*r.pathLengths[b],m+=2*r.pathLengths[b],g+=r.pathLengths[b]}function H(e,t,n,r,a,i,s,o,l,c,d,u,p,g,m,y,b){h.copy(re,y);const f=m>0?1:-1;let _=3*n,x=0,S=3*x,A=r,P=3*A;for(let M=0;M<r;++M)b&&(re[0]=e[_],re[1]=e[_+1],re[2]=e[_+2],h.normalize(re,re)),o[S]=e[_],o[S+1]=e[_+1],o[S+2]=e[_+2],l[S]=t[_],l[S+1]=t[_+1],l[S+2]=t[_+2],c[S]=-f*re[0],c[S+1]=-f*re[1],c[S+2]=-f*re[2],d[x]=0,o[P]=e[_]+m*re[0],o[P+1]=e[_+1]+m*re[1],o[P+2]=e[_+2]+m*re[2],l[P]=t[_],l[P+1]=t[_+1],l[P+2]=t[_+2],c[P]=f*re[0],c[P+1]=f*re[1],c[P+2]=f*re[2],d[A]=m,S+=3,P+=3,_+=3,x+=1,A+=1;_=3*i,S=0,P=3*g;const v=m<0?se:ie,w=m<0?ie:se;for(let h=0;h<s;++h)p[S]=a[_+v[0]],p[S+1]=a[_+v[1]],p[S+2]=a[_+v[2]],u[P]=a[_+w[0]]+r,u[P+1]=a[_+w[1]]+r,u[P+2]=a[_+w[2]]+r,S+=3,P+=3,_+=3}function W(e,t,n,r,a,i,s){r[i]=r[s],s*=3,e[i*=3]=e[s],e[i+1]=e[s+1],e[i+2]=e[s+2],t[i]=t[s],t[i+1]=t[s+1],t[i+2]=t[s+2],n[i]=a[0],n[i+1]=a[1],n[i+2]=a[2]}const Z=d.create();function q(e,t,n,r,a,i,s,o,l,c,h){let d=a,u=a+1,p=a+s,g=a+s+1,m=o,y=o+1,b=o+2*i,f=o+2*i+1;h<0&&(d=a+s+1,g=a),c*=3;for(let _=0;_<i;++_)_===i-1&&(h>0?(u=a,g=a+s):(u=a,d=a+s)),$(e,d,u,p,Z),W(e,t,r,n,Z,m,d),W(e,t,r,n,Z,y,u),W(e,t,r,n,Z,b,p),W(e,t,r,n,Z,f,g),l[c++]=m,l[c++]=b,l[c++]=f,l[c++]=m,l[c++]=f,l[c++]=y,d++,u++,p++,g++,m+=2,y+=2,b+=2,f+=2}const J=d.create(),K=d.create(),Q=d.create(),X=d.create(),Y=d.create();function $(e,t,n,r,a){t*=3,n*=3,r*=3,h.set(J,e[t++],e[t++],e[t++]),h.set(K,e[n++],e[n++],e[n++]),h.set(Q,e[r++],e[r++],e[r++]),h.subtract(X,K,J),h.subtract(Y,Q,J),h.cross(a,Y,X),h.normalize(a,a)}const ee=d.create();function te(e,t,n,r,a,i){const s=e.stageObject,o=s.geometries,d=o.length,u="absolute-height"!==t.mode;let p=0;const g=s.transformation,m=l.invertOrIdentity(c.create(),g);for(let l=0;l<d;l+=2){const e=o[l];if(!R.isGeometryWithMapPositions(e))continue;const t=e.getMutableAttribute(U.VertexAttribute.POSITION).data,c=i[l/2],d=new C.SamplePosition(e.mapPositions),y=t.length/3;let b=0,f=!1,_=0;for(let i=0;i<y;i++){ee[0]=t[b],ee[1]=t[b+1],ee[2]=t[b+2],r(d,ae),u&&(_+=ae.sampledElevation),E.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(h.set(ne,d.array[d.offset],d.array[d.offset+1],ae.z+c[b/3]),null!=n&&a.toRenderCoords(ne,n,ne),h.transformMat4(ne,ne,m)):(h.set(ne,t[b],t[b+1],t[b+2]),h.transformMat4(ne,ne,g),a.setAltitude(ne,ae.z+c[b/3]),h.transformMat4(ne,ne,m)),t[b]=ne[0],t[b+1]=ne[1],t[b+2]=ne[2];const e=oe/a.unitInMeters;(Math.abs(ee[0]-t[b])>=e||Math.abs(ee[1]-t[b+1])>=e||Math.abs(ee[2]-t[b+2])>=e)&&(f=!0),d.offset+=3,b+=3}f&&(e.invalidateBoundingInfo(),s.geometryVertexAttributeUpdated(o[l],U.VertexAttribute.POSITION),o[l+1].invalidateBoundingInfo(),s.geometryVertexAttributeUpdated(o[l+1],U.VertexAttribute.POSITION)),p+=_/y}return p/d}const ne=d.create(),re=d.create(),ae=new x.SampleElevationInfo,ie=[0,2,1],se=[0,1,2],oe=.01;var le;!function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"}(le||(le={}));class ce{constructor(e,t,n,r){this.positions=e,this.elevation=t,this.normals=n,this.heights=r}}e.Graphics3DExtrudeSymbolLayer=j,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
