/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../../../support/Scheduler"],(function(e,t,i,r,s,l,a,u,o,n,p,_,y,c,h,d,F,g){"use strict";e.FeatureVisibilityFilter=class extends i{constructor(e){super(e),this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new c.UpdatingHandles,this._updateVisibility=async e=>{if(null==this._compositedFeatureFilter&&null==this._sceneFilter||0===this.context.getFeatureCount())return this._frameTask.schedule((()=>this.clear()),e);try{const t=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,this._sceneFilter,e);return this._frameTask.schedule((()=>{this.context.updateFeatureVisibilities((e=>t.has(e)))}),e)}catch(t){return a.throwIfAbortError(t),s.getLogger(this).warn(`FeatureFilter query failed: ${t}`,{error:t}),this._frameTask.schedule((()=>{this.context.setAllFeaturesVisibility(!0)}),e)}}}initialize(){const e=g.TaskPriority.FILTER_VISIBILITY,{layer:t,view:i}=this._layerView,{featureStore:r}=this.context,s="hasZ"in this._layerView&&this._layerView.hasZ,l="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new F.QueryEngine({context:{spatialReference:i.spatialReference,layer:t,scheduler:i.resourceController.scheduler,featureStore:r,hasM:l,hasZ:s},priority:e}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),u.initial)}destroy(){this._updateRequested=!1,this._updatingHandles.destroy(),this.clear(),this._updateTask=l.abortMaybe(this._updateTask),this._frameTask=l.removeMaybe(this._frameTask),this._queryEngine=l.destroyMaybe(this._queryEngine),this._set("context",null)}get updating(){return this.running||this._updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return d.getFloorFilterClause(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_timeExtent:t,_floorFilter:i}=this;if(null==t&&null==i)return e;const r=null!=e?e.clone():new h;if(null!=t&&(r.timeExtent=null!=r.timeExtent?r.timeExtent.intersection(t):t),null!=i){const e=null==r.where||""===r.where;r.where=e?i:`(${r.where}) AND (${i})`}return r}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(e){this._updateRequested&&(this._updateTask=l.abortMaybe(this._updateTask),this._updateTask=r.createTask(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)}},t.__decorate([o.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"updating",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"running",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_layerView",null),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_updateTask",void 0),t.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=t.__decorate([y.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
