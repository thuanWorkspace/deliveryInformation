/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/screenUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/triangle","./FeatureTileDescriptor3D","./FeatureTileVisibility3D","../../webgl-engine/lib/Camera"],(function(e,t,i,r,s,a,n,o,c,l,u){"use strict";class h{constructor(e){this._camera=new u.Camera,this._focusOnMap=[0,0],this._screenRect=s.create(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new l.FeatureTileVisibility3D(e.renderCoordsHelper)}begin(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,s.fromValues(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=s.distance(e.extent,this._focusOnMap),e.measures.visibility!==c.Visibility.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=d,i=1<<t,r=e.measures.screenRect;s.empty(r);let a=0;const n=e.lij[0]+t,o=e.lij[1]<<t,c=e.lij[2]<<t,l=this._tileSizeWithBias(e),u=l*l;for(let s=0;s<i;s++)for(let t=0;t<i;t++)if(a+=this._computeScreenArea(e,n,o+s,c+t,r),a>u)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===c.Visibility.VISIBLE_WHEN_EXTENDED?this._tileSize*m:this._tileSize}_computeScreenArea(e,t,i,r,a){const n=e.measures.visibility===c.Visibility.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,i,r,n,p),s.empty(_);for(let o=0;o<4;o++)s.expandPointInPlace(_,p[o]);return s.expand(a,_,a),o.areaPoints2d(p[0],p[1],p[2])+o.areaPoints2d(p[0],p[2],p[3])}_projectToScreen(e,t,i,r,s){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,i,S),this._toRenderCoords(S,0,3,f[0]),this._toRenderCoords(S,2,3,f[1]),this._toRenderCoords(S,2,1,f[2]),this._toRenderCoords(S,0,1,f[3]),r&&(this._projectToPlane(f,this._camera.frustum[a.PlaneIndex.NEAR]),this._projectToPlane(f,this._camera.frustum[a.PlaneIndex.TOP]),this._projectToPlane(f,this._camera.frustum[a.PlaneIndex.BOTTOM]));for(let a=0;a<4;a++)this._camera.projectToRenderScreen(f[a],b),this._camera.renderToScreen(b,s[a])}_projectToPlane(e,t){for(let i=0;i<4;i++)g[i]=n.signedDistance(t,e[i]);const r=Math.max(g[0],g[1],g[2],g[3]);if(r>0){const s=i.scale(y,n.normal(t),-r);for(let t=0;t<4;t++)i.add(e[t],e[t],s)}}_toRenderCoords(e,t,i,r){return y[0]=e[t],y[1]=e[i],y[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(y,this._tilingScheme.spatialReference,r),r}}const _=s.create(),d=2,m=5,p=[t.createScreenPointArray(),t.createScreenPointArray(),t.createScreenPointArray(),t.createScreenPointArray()],S=s.create(),y=r.create(),f=[r.create(),r.create(),r.create(),r.create()],g=[0,0,0,0],b=t.createRenderScreenPointArray3();e.FeatureTileMeasurements3D=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
