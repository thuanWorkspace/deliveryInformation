/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/dehydratedFeatures","../../../../rest/query/operations/query","../../support/PBFDecoder"],(function(e,r,t,s,o,u,a,y,c,l,n,p,i){"use strict";let d=class extends t{constructor(e){super(e)}get queryFeaturesDehydrated(){const e=this.layer.capabilities,r=e&&e.query,t=r&&r.supportsFormatPBF,s=this.layer.parsedUrl;if(t){null==this._decoder&&(this._decoder=new i.PBFDecoder(this.controller));const e={sourceSpatialReference:this.layer.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeLength:1024};return(r,t)=>p.runQuery(s,r,"pbf",this._createRequestOptions(t)).then((r=>(o.throwIfAborted(t),null!=this._decoder?this._decoder.invoke({buffer:r.data,options:e},t.signal):Promise.reject(o.createAbortError()))))}return(e,r)=>p.executeQuery(s,e,this.layer.spatialReference,this._createRequestOptions(r)).then((e=>n.fromFeatureSetJSON(e.data)))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}destroy(){this._decoder=s.destroyMaybe(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};r.__decorate([u.property({constructOnly:!0})],d.prototype,"layer",void 0),r.__decorate([u.property({constructOnly:!0})],d.prototype,"controller",void 0),r.__decorate([u.property({readOnly:!0})],d.prototype,"queryFeaturesDehydrated",null),d=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],d);let h=class extends t{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};r.__decorate([u.property({constructOnly:!0})],h.prototype,"layer",void 0),r.__decorate([u.property({readOnly:!0})],h.prototype,"queryFeaturesDehydrated",null),h=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],h);let _=class extends t{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}};r.__decorate([u.property({constructOnly:!0})],_.prototype,"layer",void 0),_=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],_);let F=class extends t{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.source.queryFeaturesJSON(e,r).then(n.fromFeatureSetJSON,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};function f(e,r){return"feature"===e.type&&"feature-layer"===e.source.type?null!=e.infoFor3D?new h({layer:e}):new d({layer:e,controller:r}):"feature"===e.type&&"memory"===e.source.type||"csv"===e.type||"geojson"===e.type||"oriented-imagery"===e.type||"wfs"===e.type?new F({layer:e,source:e.source}):"ogc-feature"===e.type?new _({layer:e}):null}r.__decorate([u.property({constructOnly:!0})],F.prototype,"layer",void 0),r.__decorate([u.property({constructOnly:!0})],F.prototype,"source",void 0),F=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],F),e.createFeatureTileQuery3D=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
