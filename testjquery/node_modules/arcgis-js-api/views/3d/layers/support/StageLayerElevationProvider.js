/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../symbols/support/unitConversionUtils","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/VertexAttribute"],(function(e,t,r,o,n,s,i,a,l,c,d,h,p,u,y,g,_,v,m){"use strict";const f=1;e.StageLayerElevationProvider=class extends(o.EventedMixin(r)){get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0,this._layerHandlesKey="layerHandles"}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=_.newIntersector(this.view.state.viewingMode),this._intersector.options.store=v.StoreResults.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on("layerObjectAdded",(({object:e})=>this._objectChanged(e))),t.on("layerObjectRemoved",(({object:e})=>this._objectChanged(e))),t.on("geometryAdded",(({object:e})=>this._objectChanged(e))),t.on("geometryRemoved",(({object:e})=>this._objectChanged(e))),t.on("attributesChanged",(({attribute:e,object:t})=>m.affectsGeometry(e)&&this._objectChanged(t))),t.on("transformationChanged",(e=>this._objectChanged(e)))],this._layerHandlesKey)}dispose(){this.removeHandles(this._layerHandlesKey)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=s.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=g.getMetersPerUnit(e.unit??"meters");this._elevationOffset=(e.offset??0)*r/t}else this._elevationOffset=0}getElevation(e,t,r,o){if(C[0]=e,C[1]=t,C[2]=r,!this._renderCoordsHelper.toRenderCoords(C,o,C))return n.getLogger(this).error("could not project point for elevation alignment"),null;const s=this._elevationOffset,i=this._zmin+s,a=this._zmax+s;this._renderCoordsHelper.setAltitude(L,a,C),this._renderCoordsHelper.setAltitude(S,i,C);const l=e=>!!e.lastValidElevationBB;return this._intersector.reset(L,S,null),this._intersector.intersect(this._intersectLayers,null,f,null,l),this._intersector.results.min.getIntersectionPoint(C)?this._renderCoordsHelper.getAltitude(C):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;u.empty(b);const r=e.lastValidElevationBB;r.isEmpty()||this._expandExtent(t,r.min,r.max,b);const{min:o,max:n}=e.boundingVolumeWorldSpace;this._expandExtent(t,o,n,b),u.toRect(b,x),this._zmin=Math.min(this._zmin,b[2]),this._zmax=Math.max(this._zmax,b[5]),E.extent=x,E.spatialReference=t,this.emit("elevation-change",E),h.copy(r.min,o),h.copy(r.max,n)}_computeLayerExtent(e,t){return u.empty(b),null!=e&&t.objects.forAll((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,b))),b}_expandExtent(e,t,r,o){for(let n=0;n<8;++n)C[0]=1&n?t[0]:r[0],C[1]=2&n?t[1]:r[1],C[2]=4&n?t[2]:r[2],this._renderCoordsHelper.fromRenderCoords(C,C,e),u.expandWithVec3(o,C);return o}},t.__decorate([i.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"layer",void 0),t.__decorate([i.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"stageLayer",void 0),t.__decorate([i.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"view",void 0),t.__decorate([i.property()],e.StageLayerElevationProvider.prototype,"spatialReference",null),e.StageLayerElevationProvider=t.__decorate([d.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],e.StageLayerElevationProvider);const b=u.empty(),x=y.empty(),E={spatialReference:null,extent:x,context:"scene"},C=p.create(),L=p.create(),S=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
