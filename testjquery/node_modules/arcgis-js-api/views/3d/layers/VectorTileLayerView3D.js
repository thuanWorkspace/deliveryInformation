/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/has","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D","../../2d/engine/vectorTiles/style/StyleRepository","./LayerView3D","./TiledLayerView3D","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,i,l,r,a,s,o,n,c,h,d,p,y,m,u,g,_){"use strict";let v=class extends(u.TiledLayerView3D(m.LayerView3D(_))){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=i("disable-feature:vtl-level-shift")?0:1}initialize(){if(null==this.layer.fullExtent)return void this.addResolvingPromise(Promise.reject(new t("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:e,spatialReference:i,state:l,viewingMode:s}=this.view,o="local"===s&&!g.vtlAssumes256PixelSizeAsDefault(i)||g.test.force512VTL,n=this.layer.tileInfo.spatialReference.isGeographic,c=o?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,n?1:2),m=this._getTileInfoSupportError(c,this.layer.fullExtent);if(null!=m)return this.addResolvingPromise(Promise.reject(m));const u=a.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const t=e.tilingScheme,i=t.pixelSize,l=256===i?1:2,r=e.spatialReference?.isGeographic&&256===i?1:0,a=e.spatialReference?.isGeographic||256!==i?0:1;let s;if(this.schemaHelper=new h.SchemaHelper(l,r,this.levelShift+a),256===i){const e=this.layer.tileInfo.spatialReference.isGeographic;s=this.layer.tileInfo.getOrCreateCompatible(256,e?1:2)}else s=this.view.spatialReference?.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const o=this._getTileInfoCompatibilityError(s,t);if(o)throw o;this.tileInfo=s}));this._tileHandlerController=new AbortController;const _=this.view.resourceController;this._memCache=_.memoryController.newCache(`vtl-${this.layer.uid}`,(e=>{e.release()})),this.addHandles(a.watch((()=>this.view.qualitySettings.memoryLimit),(e=>this._memCache.maxSize=Math.ceil(e/10*1048576)),a.syncAndInitial));const v=new y(this.layer.currentStyleInfo.style);this._tileHandler=new d(this.layer,v,l.contentPixelRatio,this._memCache);const S=this._tileHandlerController.signal,w=f(_),C=this._tileHandler.start({signal:S,schedule:w}),H=this._tileHandler.spriteMosaic;H.then((e=>{!r.isAborted(S)&&this._tileHandler&&(this.painter=new p(e,this._tileHandler.glyphMosaic))})),C.then((()=>this._tileHandlerController=null)),this._updatingHandles.add((()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio})),(({style:e,pixelRatio:t})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const i=new y(e),l=new d(this.layer,i,t,this._memCache),r=l.start({signal:this._tileHandlerController.signal,schedule:w}),a=l.spriteMosaic;r.then((()=>this._tileHandlerController=null)),this._updatingHandles.addPromise(Promise.all([r,a]).then((([,e])=>{const t=this._tileHandler,i=this.painter;this.painter=new p(e,l.glyphMosaic),this._tileHandler=l,this.emit("data-changed"),t.destroy(),i&&i.dispose()})))}));const R=Promise.all([u,C,H]);this.addResolvingPromise(R)}destroy(){this.painter=l.disposeMaybe(this.painter),this._tileHandlerController=l.abortMaybe(this._tileHandlerController),this._tileHandler=l.destroyMaybe(this._tileHandler),this._memCache=l.destroyMaybe(this._memCache)}get contentZoom(){return i("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,l=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale?l.maxLevel++:l.maxLevel+=this.levelShift,l}get dataScaleRange(){const e=this.tileInfo.lods;return{minScale:e[0].scale,maxScale:e[e.length-1].scale}}get dataLevelRange(){const{minScale:e,maxScale:t}=this.dataScaleRange,i=this.levelRangeFromScaleRange(e,t);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i.maxLevel+=this.levelShift,i}async fetchTile(e,t,i,l){return this._tileHandler.getVectorTile(e,t,i,l)}};e.__decorate([s.property()],v.prototype,"layer",void 0),e.__decorate([s.property()],v.prototype,"levelShift",void 0),e.__decorate([s.property()],v.prototype,"contentZoom",null),e.__decorate([s.property()],v.prototype,"displayLevelRange",null),e.__decorate([s.property()],v.prototype,"tileInfo",void 0),e.__decorate([s.property()],v.prototype,"dataScaleRange",null),e.__decorate([s.property()],v.prototype,"dataLevelRange",null),e.__decorate([s.property()],v.prototype,"updatingProgressValue",void 0),v=e.__decorate([c.subclass("esri.views.3d.layers.VectorTileLayerView3D")],v);function f(e){return t=>e.immediate.schedule(t)}return v}));
