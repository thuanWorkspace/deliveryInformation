/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../geometry/SpatialReference","../../../geometry/support/DoubleArray","../../../geometry/support/MeshGeoreferencedRelativeVertexSpace","../../../geometry/support/MeshLocalVertexSpace","../../../chunks/vec32","../../../libs/i3s/enums","../../../libs/i3s/I3SModule","./i3s/I3SNode"],(function(e,t,r,o,n,i,s,a,f,c){"use strict";async function l(e){E=await _();const t=[e.geometryBuffer];return{result:M(E,e,t),transferList:t}}async function u(e){E=await _();const t=[e.geometryBuffer],{geometryBuffer:r}=e,o=r.byteLength,n=E._malloc(o),i=new Uint8Array(E.HEAPU8.buffer,n,o);i.set(new Uint8Array(r));const s=E.dracoDecompressPointCloudData(n,i.byteLength);if(E._free(n),s.error.length>0)throw new Error(`i3s.wasm: ${s.error}`);const a=s.featureIds?.length>0?s.featureIds.slice():null,f=s.positions.slice();return a&&t.push(a.buffer),t.push(f.buffer),{result:{positions:f,featureIds:a},transferList:t}}async function y(e){await _(),A(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function d(e){await _(),w(e)}async function m(e){E=await _(),E.setLegacySchema(e.context,e.jsonSchema)}async function b(t){const{localMatrix:s,origin:a,positions:f,vertexSpace:c,localMode:l}=t,u=r.fromJSON(t.inSpatialReference),y=r.fromJSON(t.outSpatialReference);let d;if("georeferenced"===c.type){const[{projectBuffer:t},{initializeProjection:r}]=await Promise.all([new Promise(((t,r)=>e(["../../../geometry/projection/projectBuffer"],t,r))),new Promise(((t,r)=>e(["../../../geometry/projection"],t,r)))]);await r(u,y),d=new Float64Array(f.length),t(f,u,0,d,y,0,d.length/3)}else{const t="georeferencedRelative"===c.type?n.fromJSON(c):i.fromJSON(c),{project:r}=await new Promise(((t,r)=>e(["../../../geometry/support/meshUtils/georeference"],t,r)));d=o.toFloat64Array(r({positions:f,transform:s?{localMatrix:s}:void 0,vertexSpace:t,inSpatialReference:u,outSpatialReference:y,localMode:l}))}const m=d.length,[b,p,h]=a;for(let e=0;e<m;e+=3)d[e]-=b,d[e+1]-=p,d[e+2]-=h;return{result:{projected:d,original:f},transferList:[d.buffer,f.buffer]}}async function p({normalMatrix:e,normals:t}){const r=new Float32Array(t.length);return s.transformMat3(r,t,e),s.normalize(r,r),{result:{transformed:r,original:t},transferList:[r.buffer,t.buffer]}}function h(e){S(e)}let g,E;function w(e){if(!E)return;const t=e.modifications,r=E._malloc(8*t.length),o=new Float64Array(E.HEAPU8.buffer,r,t.length);for(let n=0;n<t.length;++n)o[n]=t[n];E.setModifications(e.context,r,t.length,e.isGeodetic),E._free(r)}function M(e,t,r){const{context:o,localOrigin:n,globalTrafo:i,mbs:s,obb:f,elevationOffset:c,geometryBuffer:l,geometryDescriptor:u,indexToVertexProjector:y,vertexToRenderProjector:d}=t,m=e._malloc(l.byteLength),b=33,p=e._malloc(b*Float64Array.BYTES_PER_ELEMENT),h=new Uint8Array(e.HEAPU8.buffer,m,l.byteLength);h.set(new Uint8Array(l));const g=new Float64Array(e.HEAPU8.buffer,p,b);L(g,n);let E=g.byteOffset+3*g.BYTES_PER_ELEMENT,w=new Float64Array(g.buffer,E);L(w,i),E+=16*g.BYTES_PER_ELEMENT,w=new Float64Array(g.buffer,E),L(w,s),E+=4*g.BYTES_PER_ELEMENT,null!=f&&(w=new Float64Array(g.buffer,E),L(w,f.center),E+=3*g.BYTES_PER_ELEMENT,w=new Float64Array(g.buffer,E),L(w,f.halfSize),E+=3*g.BYTES_PER_ELEMENT,w=new Float64Array(g.buffer,E),L(w,f.quaternion));const M=u,I={isDraco:!1,isLegacy:!1,color:t.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:t.needNormals&&t.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:t.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:t.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:M.featureIndex},A=e.process(o,!!t.obb,m,h.byteLength,M,I,p,c,y,d,t.normalReferenceFrame);if(e._free(p),e._free(m),A.error.length>0)throw new Error(`i3s.wasm: ${A.error}`);if(A.discarded)return null;const S=A.componentOffsets.length>0?A.componentOffsets.slice():null,P=A.featureIds.length>0?A.featureIds.slice():null,_=A.anchorIds.length>0?Array.from(A.anchorIds):null,T=A.anchors.length>0?Array.from(A.anchors):null,x=A.interleavedVertedData.slice().buffer,O=A.indicesType===a.IndexType.Int16?new Uint16Array(A.indices.buffer,A.indices.byteOffset,A.indices.byteLength/2).slice():new Uint32Array(A.indices.buffer,A.indices.byteOffset,A.indices.byteLength/4).slice(),R=A.positions.slice(),N=A.positionIndicesType===a.IndexType.Int16?new Uint16Array(A.positionIndices.buffer,A.positionIndices.byteOffset,A.positionIndices.byteLength/2).slice():new Uint32Array(A.positionIndices.buffer,A.positionIndices.byteOffset,A.positionIndices.byteLength/4).slice(),F={layout:t.layouts[0],interleavedVertexData:x,indices:O,hasColors:A.hasColors,hasModifications:A.hasModifications,positionData:{data:R,indices:N}};return P&&r.push(P.buffer),S&&r.push(S.buffer),r.push(x),r.push(O.buffer),r.push(R.buffer),r.push(N.buffer),{componentOffsets:S,featureIds:P,anchorIds:_,anchors:T,transformedGeometry:F,obb:A.obb}}function I(e){return 0===e?c.NodeIMModificationImpact.Unmodified:1===e?c.NodeIMModificationImpact.PotentiallyModified:2===e?c.NodeIMModificationImpact.Culled:c.NodeIMModificationImpact.Unknown}function A(e){if(!E)return;const{context:t,buffer:r}=e,o=E._malloc(r.byteLength),n=r.byteLength/Float64Array.BYTES_PER_ELEMENT,i=new Float64Array(E.HEAPU8.buffer,o,n),s=new Float64Array(r);i.set(s),E.filterOBBs(t,o,n),s.set(i),E._free(o)}function S(e){E&&0===E.destroy(e)&&(E=null)}function L(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function P(){E||await _()}function _(){return E?Promise.resolve(E):(g||(g=f.get().then((e=>(E=e,g=null,E)))),g)}const T={transform:(e,t)=>E&&M(E,e,t),destroy:S};t.destroyContext=h,t.dracoDecompressPointCloudData=u,t.filterObbsForModifications=y,t.filterObbsForModificationsSync=A,t.initialize=P,t.interpretObbModificationResults=I,t.process=l,t.project=b,t.setLegacySchema=m,t.setModifications=d,t.setModificationsSync=w,t.test=T,t.transformNormals=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
