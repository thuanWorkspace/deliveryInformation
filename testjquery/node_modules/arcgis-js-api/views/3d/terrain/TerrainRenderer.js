/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../Color","../../../core/has","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferView","../../ViewingMode","./interfaces","./LayerClass","./OverlayContent","./OverlayRenderer","./PatchRenderData","./RenderOrder","./TerrainAttributesCache","./terrainUtils","./TileRenderer","./TileUpdate","./tileUtils","../webgl-engine/collections/Component/ComponentIntersectionData","../webgl-engine/core/shaderLibrary/ShaderOutput","../../../chunks/Terrain.glsl","../webgl-engine/core/shaderLibrary/terrain/TileBlendInput","../webgl-engine/effects/RenderPlugin","../webgl-engine/lib/Attribute","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/Material","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/VertexAttribute","../webgl-engine/lib/verticalOffsetUtils","../webgl-engine/materials/DrawParameters","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/TerrainTechnique","../webgl-engine/shaders/TerrainTechniqueConfiguration","../../webgl/enums"],(function(e,t,r,i,n,s,a,o,l,d,u,c,h,p,_,g,f,y,T,b,O,R,m,C,S,v,x,P,D,q,w,E,A,N,I,B,M,U,F,L,k,G,z,V,j,H,W,Y,Z){"use strict";const Q=7,X=10,K=g.create();var J;e.TransparencyMode=void 0,(J=e.TransparencyMode||(e.TransparencyMode={}))[J.Opaque=0]="Opaque",J[J.Semitransparent=1]="Semitransparent",J[J.TransparentWithDraped=2]="TransparentWithDraped",J[J.Empty=3]="Empty",e.TerrainRenderer=class extends N.SyncPrepareRenderPlugin{get _isGlobal(){return this._stage.viewingMode===y.ViewingMode.Global}get _techniques(){return this._context.techniqueRepository}get _rctx(){return this._context.renderContext.rctx}constructor(t,r,i,n,o){super({}),this._overlayRenderer=t,this._stage=r,this._allTiles=i,this._ellipsoidRadius=n,this.type=F.IntersectorType.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new Y.TerrainTechniqueConfiguration,this._passParameters=new E.TerrainPassParameters,this._renderDataPool=new a(m.PatchRenderData),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new D.IteratorPreorder,this._transparencyState=e.TransparencyMode.Opaque,this._castShadows=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=L.RenderOccludedFlag.Occlude,this.produces=new Map([[k.RenderSlot.OPAQUE_TERRAIN,()=>this._produces()],[k.RenderSlot.TRANSPARENT_TERRAIN,()=>this._produces()],[k.RenderSlot.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileTextureCache=new s.MemCachePool(((e,t)=>o.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new S.TerrainAttributesCache(o)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this)}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?N.ConsumesDepth:N.ConsumesNone}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}set transparency(t){this._transparencyState!==t&&(this._techniqueConfiguration.invisible=t===e.TransparencyMode.TransparentWithDraped||t===e.TransparencyMode.Empty,this._transparencyState=t,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return V.terrainId}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?R.overlayRenderOccludedFlag:L.RenderOccludedFlag.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,P.TileUpdate.TEXTURE_FADING)}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===P.TileUpdate.TEXTURE_FADING?T.TextureUpdate.FADING:T.TextureUpdate.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const r of e.layerInfo[b.LayerClass.ELEVATION])r.pendingUpdates&=~P.TileUpdate.GEOMETRY;e.resetPendingUpdate(P.TileUpdate.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=X-Q,r=Math.max(0,Math.floor((e.level-t)/Q)*Q);if(this._isGlobal&&0===r)return p.ZEROS;for(;e.parent&&e.level>r;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=B.RenderRequestType.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=B.RenderRequestType.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=B.RenderRequestType.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new x.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=M.createEmptyTexture(this._rctx)}uninitializeRenderContext(){this._emptyTex=n.disposeMaybe(this._emptyTex),this._tileRenderer=n.disposeMaybe(this._tileRenderer)}intersect(t,r,i,n){if(!this._rootTiles||t.options.selectOpaqueTerrainOnly&&t.options.selectionMode&&this.transparency!==e.TransparencyMode.Opaque)return;const s=$,a=ee;h.subtract(s,n,i),h.set(a,1/s[0],1/s[1],1/s[2]);const o=t.results.min,l=t.results.max,d=t.results.ground,u=t.options.store===F.StoreResults.MIN,p=!!t.results.ground.target,_=V.getVerticalOffsetTerrain(t.verticalOffset),y=t.tolerance;let T,b=u&&null!=o.dist?o.dist:1/0;const O=e=>{const p=e.renderData;if(!p?.vao)return;const O=p.geometry;g.set(K,O.boundingBox);const R=p.localOrigin;null!=_&&(_.localOrigin=R,_.applyToAabb(K));const m=K;if(te[0]=i[0]-R[0],te[1]=i[1]-R[1],te[2]=i[2]-R[2],!H.intersectAabbInvDirBefore(m,te,a,y,b))return;const C=(t,r,i)=>{t.set(this.type,e,r,i,c.IDENTITY),b=u&&null!=o.dist?o.dist:1/0},S=(e,a)=>{if(null!=a&&e>=0&&(t.options.backfacesTerrain||h.dot(a,s)<0)&&(t.options.invisibleTerrain||!t.options.selectionMode||null==r||r(i,n,e))){if((null==d.dist||e<d.dist)&&C(d,e,a),t.options.isFiltered)return;t.options.store===F.StoreResults.ALL&&(null==T?(T=U.newIntersectorResult(t.ray),C(T,e,a),t.results.all.push(T)):e<T.dist&&C(T,e,a)),(null==o.dist||e<o.dist)&&C(o,e,a),t.options.store!==F.StoreResults.MIN&&(null==l.dist||e>l.dist)&&C(l,e,a)}},v=re;h.subtract(v,n,R);const x=O.indices,P=O.vertexAttributes,D=P.getField(z.VertexAttribute.POSITION,f.BufferViewVec3f),w=new I.Vertices(D.typedBuffer,3,P.stride/4),E=O.indexCount/3;if(!_&&E>q.componentMinimalSizeForIntersectionData){const t=e.renderData;null==t.intersectionData&&(t.intersectionData=new q.ComponentIntersectionData(x,0,E,w)),t.intersectionData.intersectRay({r0:te,r1:v},S)}else H.intersectTriangles(te,v,0,E,x,w,null,_,S)},R=this._rootTiles;if(null!=R){(()=>{const e=this._tileIterator;e.reset(R);const r=t.options.invisibleTerrain;for(let t=e.next();t;t=e.next())!(t.visible||r&&t.intersectsClippingArea)||null==_&&!t.intersectsRay(i,s,y,b)||p&&this._useStencilForTile(t)?e.skipSubtree():O(t)})()}}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const r of t)null!=r.renderData?.textureReference&&e.queriesForTile(r);e.process(),t.madeProgress()}}prepareTechnique(t){const r=i("enable-feature:terrain-shadows")&&t.bindParameters.shadowMap.enabled;if(r!==this._castShadows&&(this._castShadows=r,this._patchesByOriginDirty=!0),t.bindParameters.slot===k.RenderSlot.OCCLUDED_TERRAIN){if(0==(t.renderOccludedMask&R.overlayRenderOccludedFlag))return null}else{const r=this.transparency===e.TransparencyMode.Opaque?k.RenderSlot.OPAQUE_TERRAIN:k.RenderSlot.TRANSPARENT_TERRAIN;if(t.bindParameters.slot!==r)return null}if(this.transparency===e.TransparencyMode.Empty)return null;switch(t.output){case w.ShaderOutput.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=null!=t.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=t.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=t.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=t.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(w.ShaderOutput.Color,t.bindParameters.slot===k.RenderSlot.OCCLUDED_TERRAIN);case w.ShaderOutput.Shadow:case w.ShaderOutput.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(w.ShaderOutput.Shadow,!1)):null;case w.ShaderOutput.Depth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(w.ShaderOutput.Depth,!1);case w.ShaderOutput.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(w.ShaderOutput.Normal,!1);case w.ShaderOutput.ObjectAndLayerIdColor:return this._updateTechnique(w.ShaderOutput.ObjectAndLayerIdColor,!1);case w.ShaderOutput.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(w.ShaderOutput.Highlight,!1)):null}return null}renderNode(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case w.ShaderOutput.Color:{const r=e.bindParameters.slot===k.RenderSlot.OCCLUDED_TERRAIN?O.OverlayContent.Occluded:O.OverlayContent.Color;this._renderMaterialPass(e,t,r);break}case w.ShaderOutput.Depth:case w.ShaderOutput.Normal:this._renderAuxiliaryPass(e,t,O.OverlayContent.Color,this._visiblePatchesByOrigin);break;case w.ShaderOutput.Highlight:this._renderAuxiliaryPass(e,t,O.OverlayContent.Highlight,this._visiblePatchesByOrigin);break;case w.ShaderOutput.Shadow:case w.ShaderOutput.ShadowExcludeHighlight:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case w.ShaderOutput.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,O.OverlayContent.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=r.toUnitRGBA(e);i=p.fromValues(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,T.TextureUpdate.FADING))),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?A.TileBlendInput.GridComposite:null!=t.backgroundColor?A.TileBlendInput.ColorComposite:A.TileBlendInput.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==C.RenderOrder.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const r of e)D.sortTiles(this.renderOrder,r,t);e.sort(((e,t)=>D.compareTiles(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),r=e.renderData;if(!r){this._numTilesCulled++;continue}const i=r.localOrigin;if(this._castShadows){let t=this._allPatchesByOrigin.get(i);t||(t=new Array,this._allPatchesByOrigin.set(i,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let n=this._visiblePatchesByOrigin.get(i);n||(n=new Array,this._visiblePatchesByOrigin.set(i,n)),n.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,r,i){const n=e.rctx;this._passParameters.overlayContent=r,n.bindTechnique(t,this._passParameters,e.bindParameters);const s=this._stencilEnabledLayerExtents.length>0;i.forEach((i=>{const n=i[0].renderData.localOrigin;t.program.bindDraw(new j.DrawParameters(n),e.bindParameters,this._passParameters);for(let a=0;a<i.length;a++)this._renderPatch(e,t,i[a],Z.PrimitiveType.TRIANGLES,s,r)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,r){const{rctx:i}=e;this._passParameters.overlayContent=r,i.bindTechnique(t,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const n=e.bindParameters.camera,s=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=G.getSettings(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:n.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=r===O.OverlayContent.Occluded;o&&(s.bindTexture("tex",this._emptyTex),s.setUniform3fv("textureOpacities",p.ZEROS),s.setUniform4fv("texOffsetAndScale",_.ZEROS));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:p.ZEROS;this._techniqueConfiguration.tileBlendInput===A.TileBlendInput.ColorComposite&&s.setUniform3fv("backgroundColor",l);const d=this.wireframe?Z.PrimitiveType.LINES:Z.PrimitiveType.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&s.bindTexture("texNext",this._emptyTex);const u=this._visiblePatchesByOrigin;for(const c of u.values()){const i=c[0].renderData.localOrigin;t.program.bindDraw(new j.DrawParameters(i),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const n of c){const i=n.renderData,l=i.textureReference;if(null!=l){if(!o){s.setUniform4fv("texOffsetAndScale",l.offsetAndScale),s.bindTexture("tex",l.texture.texture);const e=i.textureFadeFactor,t=e<1?i.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=t&&e<1?(s.setUniform1f("fadeFactor",e),s.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),s.setUniform3fv("nextTexOpacities",t.opacities),s.bindTexture("texNext",t.texture.texture)):s.setUniform1f("fadeFactor",1),i.textureIsFading&&this.setNeedsRender(),s.setUniform3fv("textureOpacities",l.opacities)}this._renderPatch(e,t,n,d,a,r),n.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,r,i,n,s){const a=r.renderData,o=a.vao,l=o?.indexBuffer;if(null==l)return void(v.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",r.lij," : ",a));const d=t.program;null==s||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(d,a.overlay),n&&(t.useStencil=this._useStencilForTile(r),e.rctx.setPipelineState(t.getPipeline()));const u=a.geometry.indexCount;e.rctx.bindVAO(o),d.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(i,u,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniques.releaseAndAcquire(W.TerrainTechnique,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}},t.__decorate([o.property({readOnly:!0})],e.TerrainRenderer.prototype,"_isGlobal",null),t.__decorate([o.property({value:!1})],e.TerrainRenderer.prototype,"renderingDisabled",null),t.__decorate([o.property({value:!0})],e.TerrainRenderer.prototype,"visible",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"renderPatchBorders",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"visualizeNormals",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"cullBackFaces",null),t.__decorate([o.property({value:C.RenderOrder.FRONT_TO_BACK})],e.TerrainRenderer.prototype,"renderOrder",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"wireframe",null),e.TerrainRenderer=t.__decorate([u.subclass("esri.views.3d.terrain.TerrainRenderer")],e.TerrainRenderer);const $=p.create(),ee=p.create(),te=p.create(),re=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
