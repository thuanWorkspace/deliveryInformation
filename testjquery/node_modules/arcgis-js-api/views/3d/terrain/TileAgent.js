/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","./interfaces","./TerrainConst","./terrainUtils","./tileUtils"],(function(e,t,s,i,l){"use strict";class a{get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,s){this._setUpsampleTile(e,s),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,t.TextureUpdate.FADING,s):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,a=this.tile.surface.layerViewByIndex(e,t),n=i.getLayerWithExtentRange(a),{minLevel:r,maxLevel:h}=a.dataLevelRange,d=this._desiredMinLevelDelta,u=this._progressiveLevelModulo+d,o=this._scaleRangeEnabled?l.fallsWithinLayer:()=>!0;let _=this.tile;const y=_.level;let p;const f=this._tileLayerInfo.upsampleInfo,v=null!=f?f.tile.level:-1,c=null!=f&&v-y>=d,L=n?.tilemapCache,g="vector-tile-3d"===a.type?a.schemaHelper:null;for(;_&&o(_,n,!1)&&_.level>=r;){const i=_.level,l=y-i,a=_.layerInfo[t][e];if(a.data&&l>=d){(!c||i>v)&&this._setUpsampleTile(_),a.dataInvalidated&&(p=_);break}const n=g?.getLevelRowColumn(_.lij)??_.lij;if("unavailable"!==L?.getAvailability(n[0],n[1],_.lij[2])&&i<=h&&!a.data&&!a.dataMissing&&((!p||_.level===r||i%s.progressiveLoadingModulo==0||y-p.level<d)&&(p=_),l>=u))break;_=_.parent}if(null!=p&&y-p.level<d)if(f)p=null;else{const s=this._findAncestorWithData();if(null!=s){this._setUpsampleTile(s);p=s.layerInfo[t][e].dataInvalidated?s:null}}return p}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(e,s){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,t.TextureUpdate.FADING,s)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class n extends a{get _desiredMinLevelDelta(){throw r}get _progressiveLevelModulo(){throw r}dispose(){}}const r=new Error("Abstract method called on TileAgent"),h=new n;e.TileAgent=a,e.tileAgentDone=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
