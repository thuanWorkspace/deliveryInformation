/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/vec3f64","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","./ITile","./PatchGeometryFactory","./Tile","../webgl-engine/materials/internal/MaterialUtil"],(function(e,t,r,a,i,n,s,o,l,c,h){"use strict";class u extends c.Tile{constructor(e,t,r,a,i){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=n.create(),this._baseUsedMemory=900,this.init(e,t,r,a,i)}init(e,i,n,o,l){super.init(e,i,n,o,l);const c=l.view.renderSpatialReference,h=l.spatialReference,u=null!=c&&s.isPlateCarree(c)&&null!=h&&h.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=u;const d=this.surface.isWebMercatorOnPlateeCarree,p=this._extentInRenderSR,S=this.extent;if(d){const e=t.fromValues(S[0],S[1],0);a.projectVectorToVector(e,r.WebMercator,e,r.PlateCarree);const i=t.fromValues(S[2],S[3],0);a.projectVectorToVector(i,r.WebMercator,i,r.PlateCarree),p[0]=e[0],p[1]=e[1],p[2]=i[0],p[3]=i[1]}else for(let t=0;t<4;++t)p[t]=S[t]*u;this.centerAtSeaLevel[0]=.5*(p[0]+p[2]),this.centerAtSeaLevel[1]=.5*(p[1]+p[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(p[2]-p[0],p[3]-p[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),a=Math.sqrt(t*t+r*r),i=.5*(this.elevationBounds[0]-this.elevationBounds[1]),n=Math.max(a,i);this._center[c.CenterPosition.MIDDLE][3]=n}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),r=t[0],a=t[1],i=t[2],n=t[3],s=t[4],l=t[5];let c=!0;for(let h=0;h<6;h++){const t=e[h],u=t[0],d=t[1],p=t[2],S=t[3];if(u*(u>0?r:n)+d*(d>0?a:s)+p*(p>0?i:l)+S>=0)return o.TileFrustumVisibility.OUTSIDE;c=c&&u*(u<0?r:n)+d*(d<0?a:s)+p*(p<0?i:l)+S<=0}return c?o.TileFrustumVisibility.INSIDE:o.TileFrustumVisibility.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return i.wrap(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,t,r,a){return d[0]=1/t[0],d[1]=1/t[1],d[2]=1/t[2],h.intersectAabbInvDirBefore(this._aabb(),e,d,r,a)}createGeometry(){l.createPlanarGlobePatch(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){l.updateCornersPlanar(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){l.updateEdgesAndCornersPlanar(this.renderData,this._horizontalScaleFactor)}get horizontalScale(){return this._horizontalScaleFactor}}const d=t.create();e.PlanarPatch=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
