/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../chunks/vec2","../../../chunks/vec2f64","../../../layers/support/layerUtils","../support/StreamDataLoader","./BlendLayersTechnique","./interfaces","./ITile","./LayerClass","./terrainUtils","./TextureFader","./TextureReference","./TileCompositor","./TileRenderInfo","./TileTexture","./TileUpdate","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(e,t,r,a,s,i,o,n,u,l,c,p,d,h,y,T,_,m,f,x,g,b,I){"use strict";class L{constructor(e,t,r,a,s,i){this.start=e,this.end=t,this.blendMode=r,this.opacity=a,this.output=s,this.baseOpacity=i}}class O{constructor(e,t,r,a){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=a,this._passParameters=new o.BlendLayersPassParameters,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new h.TileCompositor(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=t.disposeMaybe(this._composition),this._backgroundTexture=t.releaseMaybe(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,a=r.baseOpacity;let i=0,o=0,n=this.tileSize,u=!1,p=!1;const d=r.view.state.contentPixelRatio;let h=!1;k.clear(),B.length=0;const y=e.layerInfo[l.LayerClass.MAP];let T=0,m=null;for(;T<y.length;T++){const t=r.layerViewByIndex(T,l.LayerClass.MAP),f=t.layer.opacity,x=t.fullOpacity;if(p=p||s.isBaseLayer(t.layer),c.isBlendableLayerView(t)){let e="normal"!==t.layer.blendMode;if(s.isGroupLayer(t.layer.parent)){const r=M(t.layer.parent);null!=r&&""!==r&&(e=R(t.layer.parent)||e)}e&&(h=e,u=!1)}if(0===f&&!h){y[T].pendingUpdates&=~(_.TileUpdate.TEXTURE_NOFADING&_.TileUpdate.TEXTURE_FADING);continue}++o;const g=c.isVectorTileLayerView(t),b=w(e,T,g);if(b){if(y[T].pendingUpdates&=~(_.TileUpdate.TEXTURE_NOFADING&_.TileUpdate.TEXTURE_FADING),s.isGroupLayer(t.layer.parent)){const e=M(t.layer.parent);null!=e&&""!==e&&P(t.layer.parent,T)}g?n=Math.max(n,this.tileSize*d):1===a&&1===x&&(t.isOpaque||this._dataToTexture(b)&&b.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++i,null===m&&(m=T)}}const f=n/this.tileSize;0!==i&&null!==m?1===i&&!h&&this._useLayerTexture(e,m)||this._composeMapLayers(e,t,T-1,p,n,f,!u||h,k,h):this._useBackgroundTexture(e,o)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=a.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,null!=this.backgroundColor),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useBackgroundTexture(e,t){const r=this._ensureBackgroundTexture(this.tileSize);let a=p.ActivationTime.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(a=p.ActivationTime.Delayed);const s=e.renderData;null==s.textureReference&&(a=p.ActivationTime.Immediate),s.setTextureReference(new d.TextureReference(r,n.TextureUpdate.FADING,N,e.surface.baseOpacity,0,1),a)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,l.LayerClass.MAP),a=s.isBaseLayer(r.layer),i=a?e.surface.baseOpacity:1,o=a?1:e.surface.baseOpacity,u=r.fullOpacity,c=w(e,t,!1);return!!this._dataToTexture(c)&&(e.renderData.setTextureReference(new d.TextureReference(c.sourceLayerInfo.data,n.TextureUpdate.FADING,c,i,o,u)),!0)}_composeMapLayers(e,t,r,i,o,n,u,p,h){this._composition.ensureBuffer(o);const y=e.surface.baseOpacity;let T=!1,_=g.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,x=!1,b=0;for(let d=r;d>=0;d--){const t=e.surface.layerViewByIndex(d,l.LayerClass.MAP),r=c.isVectorTileLayerView(t),I=w(e,d,r),L=t.layer.opacity;if(!I||0===L&&!h)continue;const O=!s.isBaseLayer(t.layer)&&!T;O&&(T=!0);let M=!1;p.forEach((e=>{e.start===d&&(e.output=i?f.BlendLayersOutput.Composite:u&&O?this.backgroundIsGrid?f.BlendLayersOutput.GridComposite:f.BlendLayersOutput.ColorComposite:f.BlendLayersOutput.Composite,e.baseOpacity=O?y:1,B.push(e),this._composition.openGroup(o),M=!0)})),this._passParameters.baseOpacity=O&&!M&&y<1?y:1;const R=this._passParameters.baseOpacity<1?f.BaseOpacityMode.Required:f.BaseOpacityMode.NotRequired,P=0===b,k=M?f.BlendLayersOutput.GroupBackgroundComposite:u&&P?this.backgroundIsGrid?f.BlendLayersOutput.GridComposite:f.BlendLayersOutput.ColorComposite:f.BlendLayersOutput.Composite,A=m.blendModeFromString[c.isBlendableLayerView(t)?t.layer.blendMode:"normal"];for(this._passParameters.opacity=L,c.isVectorTileRenderInfo(I)?x=this._composition.drawVectorData(this._passParameters,k,o,A,R,I,n,this.tileSize,x):c.isImageryTileRenderInfo(I)?(this._composition.drawImageryTileData(this._passParameters,k,o,A,R,I),this._hasNearestInterpolation(I)&&(_=g.TextureSamplingMode.NEAREST)):this._dataToTexture(I)&&(this._passParameters.texture=I.sourceLayerInfo.data.texture,this._passParameters.offset=I.offset,this._passParameters.scale=I.scale,this._composition.drawRasterData(this._passParameters,k,o,A,R));B.length>0&&B[B.length-1].end===d;){const e=B.pop();this._passParameters.baseOpacity=e.baseOpacity;const t=this._passParameters.baseOpacity<1?f.BaseOpacityMode.Required:f.BaseOpacityMode.NotRequired;this._passParameters.opacity=e.opacity,this._passParameters.offset=a.ZEROS,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,e.output,o,m.blendModeFromString[e.blendMode],t)}b++}const I=e.renderData,L=h||T&&y<1,O=I.ensureTexture(o,L,(()=>this._buildTexture(o,L,_)));this._composition.copyFBOToTexture(O),this._composition.unbind(),I.setTextureReference(new d.TextureReference(O,t,N,T?1:y,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){if(c.isRasterTileRenderInfo(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return c.isTextureTileRenderInfo(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,r=g.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(null==e)return null;const a=new I.TextureDescriptor;a.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,a.samplingMode=r,a.maxAnisotropy=this._maxAnisotropy,a.preMultiplyAlpha=!0,a.flipped=!0,a.hasMipmap=!0,t||(a.pixelFormat=g.PixelFormat.RGB);const s=this._rctx;let o;if("number"==typeof e){a.width=a.height=e;const t=`${e} ${a.pixelFormat}`;o=this._cache.pop(t),o?o.retain():o=new T(new b.Texture(s,a),this._cache)}else if(i.isImageWithType(e)){a.isOpaque=e.isOpaque,a.isOpaque&&(a.pixelFormat=g.PixelFormat.RGB);const t=`${e} ${a.pixelFormat}`;o=this._cache.pop(t),o?(o.retain(),o.texture.setData(e.image)):o=new T(new b.Texture(s,a,e.image),this._cache),e.release()}else try{a.width=e.width,a.height=e.height,o=new T(new b.Texture(s,a,e))}catch(u){o=new T(x.createEmptyTexture(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const n=s.bindTexture(o.texture,b.Texture.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),s.bindTexture(n,b.Texture.TEXTURE_UNIT_FOR_UPDATES),o}get test(){return{backgroundTexture:this._backgroundTexture}}}function w(e,t,a){A.layerIndex=t,A.vtlNeighborInfos.clear();const s=e.layerInfo[l.LayerClass.MAP][t];if(r.set(A.offset,0,0),A.tile=e,A.scale=1,A.sourceLod=e.lij,A.sourceLayerInfo=s,A.isVTLBackground=a,s.data)return a&&e.forEachLoadedNeighbor(((r,a)=>{if(r.level!==e.level)return;const i=r.layerInfo[l.LayerClass.MAP][t];if(!c.isVectorTilePerLayerInfo(i)||s.data===i.data)return;const o=A.vtlNeighborInfos.pushNew();o.offset=E[a],o.sourceLod=r.lij,o.sourceLayerInfo=i})),A;const i=s.upsampleInfo;if(i){const e=i.tile.layerInfo[l.LayerClass.MAP][t];return A.tile=i.tile,r.copy(A.offset,i.offset),A.scale=i.scale,A.sourceLod=i.tile.lij,A.sourceLayerInfo=e,A}return a?A:null}function M(e){return e.uid}function R(e){let t="normal"!==e.blendMode;return s.isGroupLayer(e.parent)&&(t=R(e.parent)||t),t}function P(e,t){s.isGroupLayer(e.parent)&&P(e.parent,t);const r=M(e);if(null!=r&&""!==r){const a=k.get(r);a?a.start=t:k.set(r,new L(t,t,e.blendMode,e.opacity,f.BlendLayersOutput.Composite,1))}}const k=new Map,B=new Array,A=new y.TileRenderInfo,N={offset:[0,0],scale:1},E=new Array;E[u.NeighborIndex.NORTH]=[0,-1],E[u.NeighborIndex.NORTH_EAST]=[-1,-1],E[u.NeighborIndex.EAST]=[-1,0],E[u.NeighborIndex.SOUTH_EAST]=[-1,1],E[u.NeighborIndex.SOUTH]=[0,1],E[u.NeighborIndex.SOUTH_WEST]=[1,1],E[u.NeighborIndex.WEST]=[1,0],E[u.NeighborIndex.NORTH_WEST]=[1,-1],e.GroupInfo=L,e.TileRenderer=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
