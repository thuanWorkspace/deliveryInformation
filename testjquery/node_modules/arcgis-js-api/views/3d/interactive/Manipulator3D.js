/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../core/compilerUtils","../../../core/Evented","../../../core/handleUtils","../../../core/mathUtils","../../../core/maybe","../../../core/screenUtils","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/projection","../../../geometry/projection/localRotationUtils","../../../geometry/projection/projectors","../../../geometry/support/aaBoundingRect","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","../../../geometry/support/vectorStacks","../../../layers/graphics/hydratedFeatures","../support/ElevationProvider","../support/geometryUtils/ray","../webgl-engine/lib/Camera","../webgl-engine/lib/Object3D","../webgl-engine/lib/UpdatePolicy","../webgl-engine/lib/WebGLLayer","../../interactive/interfaces","../../../geometry/Point"],(function(e,t,i,n,s,o,r,a,c,l,h,d,u,_,g,f,m,p,y,b,v,S,L,j,R,O,A,w,T,E,P,M,F){"use strict";class D{constructor(e){this.metadata=void 0,this._camera=new w.Camera,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=d.create(),this._worldFrame=null,this._renderLocation=g.create(),this._renderLocationDirty=!0,this._location=new F({x:0,y:0,z:0}),this._elevationAlignedLocation=new F,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=M.ManipulatorStateCustomFlags.None,this._focused=!1,this.events=new n.EventEmitter,this._screenLocation={screenPointArray:a.createScreenPointArray(),renderScreenPointArray:a.createRenderScreenPointArray3(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);const t=this.view.state?.camera;t&&this._camera.copyFrom(t)}destroy(){this._applyObjectTransform=K,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){return this.view?._stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),s.makeHandle((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){C(e)&&(this._screenLocationDirty=!0),h.copy(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=d.create()),k(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){R.clonePoint(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){R.clonePoint(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const e=null!=this._elevation.override?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=R.hydratedSpatialReference(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(C(this._modelTransform)){const t=this._calculateModelTransformOffset(Z);e=_.add(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,t){if(!this.available)return null;const n=a.screenPointObjectToArray(e,z),s=this._getCollisionRadius(t),o=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(u.squaredDistance(this.screenLocation.screenPointArray,n)<s*s)return this.screenLocation.renderScreenPointArray[2]+o;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,N),r=s*this.screenLocation.pixelSize,c=A.fromScreen(this._camera,n,x);if(null==c)return null;for(const n of e){if(0===n.length)continue;const e=_.transformMat4(H,n[0],i);for(let t=1;t<n.length;t++){const s=_.transformMat4(q,n[t],i),l=v.closestRayDistance2(v.fromPoints(e,s,I),c);if(null!=l&&l<r*r){const t=_.add(j.sv3d.get(),e,s);_.scale(t,t,.5);const i=a.castRenderScreenPointArray(j.sv3d.get());return this._camera.projectToRenderScreen(t,i),i[2]+o}_.copy(e,s)}}break}case"disc":{const e=this.collisionType.direction,t=this.collisionType.offset??g.ZEROS,i=this._getWorldToScreenObjectScale(),r=this._calculateObjectTransform(i,N),a=s*this.screenLocation.pixelSize,l=A.fromScreen(this._camera,n,x);if(null==l)return null;const h=c.fromMat4(U,r),d=_.transformMat3(V,e,h),u=_.transformMat4(Y,t,r);S.fromPositionAndNormal(u,d,B);const f=G;if(S.intersectRay(B,l,f)&&_.squaredDistance(f,u)<a*a)return this.screenLocation.renderScreenPointArray[2]+o;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,i=this._getWorldToScreenObjectScale(),r=this._calculateObjectTransform(i,N),l=s*this._camera.computeScreenPixelSizeAt(this.renderLocation),h=A.fromScreen(this._camera,n,x);if(null==h)return null;const d=c.fromMat4(U,r),u=_.transformMat3(V,t,d),g=this._calculateModelTransformPosition(Y);S.fromPositionAndNormal(g,u,B);const f=G;if(!S.intersectRay(B,h,f))break;for(const n of e){if(0===n.length)continue;const e=_.transformMat4(H,n[0],r);for(let t=1;t<n.length;t++){const i=_.transformMat4(q,n[t],r),s=v.distance2(v.fromPoints(e,i,I),f);if(null!=s&&s<l*l){const t=_.add(j.sv3d.get(),e,i);_.scale(t,t,.5);const n=a.castRenderScreenPointArray(j.sv3d.get());return this._camera.projectToRenderScreen(t,n),n[2]+o}_.copy(e,i)}}break}default:i.neverReached(this.collisionType)}return null}attach(e={manipulator3D:{}}){const t=this._stage;if(!t)return;const i=e.manipulator3D;null==i.engineLayerId?(this._engineLayer=new P.WebGLLayer(t,{pickable:!1,updatePolicy:E.UpdatePolicy.SYNC}),i.engineLayerId=this._engineLayer.id):t?.getObject&&(this._engineLayer=t.getObject(i.engineLayerId)),i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,null==this._materialIdReferences&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),m.canProjectWithoutEngine(this._location.spatialReference,this.view.spatialReference)||(this.location=new F({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=0===t.engineLayerReferences;this._removeResourcesFromStage(),i&&(t.engineLayerId=null,r.destroyMaybe(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){m.projectPoint(this.location,J,e.spatialReference)&&b.containsPointObject(e.extent,J)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(null==this.elevationInfo)return;let e=null,t=0;const i=this.elevationInfo.offset??0;switch(this.elevationInfo.mode){case"on-the-ground":e=O.getElevationAtPoint(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":t=(O.getElevationAtPoint(this.view.elevationProvider,this.location,"ground")??0)+i;break;case"relative-to-scene":t=(O.getElevationAtPoint(this.view.elevationProvider,this.location,"scene")??0)+i;break;case"absolute-height":t=i}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=N;if(!0===this.autoScaleRenderObjects){const i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),n=(this.focused?M.ManipulatorStateFlags.Focused:M.ManipulatorStateFlags.Unfocused)|(this.selected?M.ManipulatorStateFlags.Selected:M.ManipulatorStateFlags.Unselected),s=this._noDisplayCount>0;for(const{stateMask:o,objects:r}of i){if(s){for(const e of r)e.visible=!1;continue}const e=(o&M.ManipulatorStateFlags.All)!==M.ManipulatorStateFlags.None,i=(o&M.ManipulatorStateCustomFlags.All)!==M.ManipulatorStateCustomFlags.None,a=!e||(n&o)==(o&M.ManipulatorStateFlags.All),c=!i||(this.state&o)==(o&M.ManipulatorStateCustomFlags.All);if(a&&c)for(const n of r)n.visible=!0,n.transformation=t;else for(const t of r)t.visible=!1}}_ensureEngineResources(){if(null==this._engineResources){const e=this._engineLayer,t=[],i=new Set;this.renderObjects.forEach((({geometry:{material:e}})=>{i.has(e)||(t.push(e),i.add(e))}));const n=new Map;this._renderObjects.forEach((e=>{const t=new T.Object3D({castShadow:!1,geometries:[e.geometry]}),i=n.get(e.stateMask)||[];i.push(t),n.set(e.stateMask,i)}));const s=[];n.forEach(((e,t)=>s.push({stateMask:t,objects:e}))),this._engineResources={objectsByState:s,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const e=this._stage;if(this._engineResourcesAddedToStage||null==this._engineResources||!e)return;const{objectsByState:t,layer:i,materials:n}=this._engineResources;n.forEach((t=>{const i=this._materialIdReferences,n=i.get(t.id)||0;0===n&&e.add(t),i.set(t.id,n+1)})),t.forEach((({objects:t})=>{i.addMany(t),e.addMany(t)})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const e=this._stage;if(!this._engineResourcesAddedToStage||null==this._engineResources||!e)return;const{objectsByState:t,layer:i,materials:n}=this._engineResources;t.forEach((({objects:t})=>{i.removeMany(t),e.removeMany(t)})),n.forEach((t=>{const i=this._materialIdReferences,n=i.get(t.id);1===n?(e.remove(t),i.delete(t.id)):i.set(t.id,n-1)})),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,W);return _.set(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return _.subtract(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return h.set(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&h.multiply(t,t,this._worldFrame),h.multiply(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,null!=this._applyObjectTransform&&this._applyObjectTransform(t),t}get test(){let e=!1;if(null!=this._engineResources)for(const t of this._engineResources.objectsByState){for(const i of t.objects)if(i.visible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function C(e){return 0!==e[12]||0!==e[13]||0!==e[14]}function k(e,t,i){switch(e.viewingMode){case"local":return h.identity(i),!0;case"global":{const n=f.getReferenceEllipsoid(e.renderCoordsHelper.spatialReference);return y.sphericalPCPFtoLonLatElevation(t,0,H,0,n.radius),p.computeENUToSphericalPCPFLocalRotation(o.deg2rad(H[0]),o.deg2rad(H[1]),i),!0}}}const z=a.createScreenPointArray(),I=v.create(),x=L.create(),U=l.create(),W=d.create(),N=d.create(),B=S.create(),H=g.create(),q=g.create(),G=g.create(),V=g.create(),Y=g.create(),Z=g.create(),J=new F({x:0,y:0,z:0,spatialReference:null}),K=()=>{};e.Manipulator3D=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
