/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/vectorStacks","./Object3DVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../support/engineContent/sdfPrimitives","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/HUDMaterial"],(function(e,t,i,r,s,o,n,l,a,u,h,c,p,_,d,m){"use strict";class g extends u.Object3DVisualElement{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=o.fromValues(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=o.fromValues(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){s.exactEquals(e,this._color)||(s.copy(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){s.exactEquals(e,this._outlineColor)||(s.copy(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material&&this._material.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(null==e)return;const t=e.geometries[0];if(null==t)return;const i=t.getMutableAttribute(d.VertexAttribute.SIZE).data,r=this._geometrySize;i[0]=r,i[1]=r,e.geometryVertexAttributeUpdated(e.geometries[0],d.VertexAttribute.SIZE)}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:p.requiresHalfTexelOffset(this._primitive),distanceFieldBoundingBox:f,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/x}createExternalResources(){this._texture=p.createTexture(this._primitive,this._preferredTextureSize),this._material=new m.HUDMaterial(this._materialParameters);const e=this.view._stage;this._texture.load(e.renderView.renderingContext),e.add(this._texture)}destroyExternalResources(){if(this._texture){this.view._stage.remove(this._texture),this._texture.dispose(),this._texture=null}this._material=null}createGeometries(e){const t=this._createRenderGeometry();null!=t&&e.addGeometry(t)}forEachExternalMaterial(e){this._material&&e(this._material)}get _preferredTextureSize(){return t.clamp(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const i=t.attributes.get(d.VertexAttribute.POSITION);return n.projectVectorToVector(i.data,this.view.renderCoordsHelper.spatialReference,S,this.view.spatialReference),l.expandWithBuffer(e,S),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(null==e||null==t)return null;const{renderCoordsHelper:r,elevationProvider:s}=this.view,o=h.evaluateElevationAlignmentAtPoint(e,s,c.ElevationContext.fromElevationInfo(this.elevationInfo),r),l=i.set(a.sv3d.get(),e.x,e.y,o),u=a.sv3d.get();n.projectVectorToVector(l,e.spatialReference,u,r.spatialReference);const p=this._geometrySize;return _.createPointGeometry(t,null,u,null,[p,p],[0,0,0,1])}}const x=p.defaultSymbolSizeRatio,f=[x/2,x/2,1-x/2,1-x/2],S=r.create();e.PointVisualElement=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
