/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Evented","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f32","../../../../geometry/projection/projectBuffer","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","../../../../layers/graphics/dehydratedPoint","../../../../support/elevationInfoUtils","../../../../symbols/support/ElevationInfo","./EngineVisualElement","./LaserlineVisualElement","../../layers/graphics/ElevationContext","../../support/engineContent/line","../../support/renderInfoUtils/line","../../webgl-engine/lib/Material","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,r,i,s,n,a,l,o,h,c,d,u,_,p,m,f,g,y,O,R){"use strict";class b extends u.EngineVisualElement{constructor(e){super(e),this._attachmentOrigin=h.makeDehydratedPoint(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new t,this._geometry=null,this._width=1,this._color=n.fromValues(1,0,1,1),this._innerWidth=0,this._innerColor=n.fromValues(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=g.RenderOccludedFlag.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=e.view.spatialReference,this._laserline=new _.LaserlineVisualElement({view:e.view,isDecoration:e.isDecoration}),this.applyProperties(e),this.attached=e.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyExternalResources(e),recreateGeometry:(e,t)=>{e.geometries.length=0,this._recreateGeometry(t,e.material,e.geometries)}}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyExternalResources(e),recreateGeometry:e=>{e.geometries=this._createRenderGeometriesDraped(e.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&null!=this._laserlineStyle&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(e){this._laserline.attached=this._laserlineAttached,e&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){s.exactEquals(e,this._color)||(s.copy(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){s.exactEquals(e,this._innerColor)||(s.copy(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=null!=e!=(null!=this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&s.exactEquals(e,this._stippleOffColor)||(this._stippleOffColor=e?n.clone(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,null!=e&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=this.object3dResources.resources?.geometries;if(!e||0===e.length)return null;r.set(C,0,0,0);let t=0;for(const i of e)i.computeAttachmentOrigin(v)&&(r.add(C,C,v),t++);return 0===t?null:(r.scale(C,C,1/t),this.view.renderCoordsHelper.fromRenderCoords(C,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){null!=this.object3dResources.resources&&this.object3dResources.resources.material.setParameters(this._materialParameters),null!=this.drapedResources.resources&&this.drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return null!=this.geometry&&"polygon"===this.geometry.type}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===g.RenderOccludedFlag.OccludeAndTransparentStencil?g.RenderOccludedFlag.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,t,r){this._createRenderGeometries(t,r);for(const i of r)e.addGeometry(i);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_destroyExternalResources(e){e.geometries=[]}_createObject3DResources(e){const t=new R.RibbonLineMaterial(this._materialParameters),r=new Array;return this._recreateGeometry(e,t,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}}_createDrapedResources(){const e=new R.RibbonLineMaterial(this._materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const{geometry:t,view:r}=this,i=r.basemapTerrain.spatialReference;if(null==t||null==i)return[];return f.geometryToRenderInfoDraped(t,i).lines.map((({position:t})=>{const s={overlayInfo:{spatialReference:i,renderCoordsHelper:r.renderCoordsHelper},attributeData:{position:t},removeDuplicateStartEnd:this._isClosed};return new y.RenderGeometry(m.createGeometry(e,s))}))}calculateMapBounds(e){if(null==this.object3dResources.resources)return!1;const t=this.view.renderCoordsHelper;for(const r of this.object3dResources.resources.geometries){const i=r.attributes.get(O.VertexAttribute.POSITION),s=o.newDoubleArray(i.data.length);a.projectBuffer(i.data,t.spatialReference,0,s,this.view.spatialReference,0,i.data.length/3),l.expandWithBuffer(e,s)}return!0}_createRenderGeometries(e,t){const r=this.geometry;if(null==r)return;const i=f.geometryToRenderInfo(r,this.view.elevationProvider,this.view.renderCoordsHelper,p.ElevationContext.fromElevationInfo(this.elevationInfo??new d({mode:c.getGeometryEffectiveElevationMode(r,null)}))),s=new Array;for(const{position:n,mapPositions:a}of i.lines){const r={mapPositions:a,attributeData:{position:n},removeDuplicateStartEnd:this._isClosed};t.push(m.createGeometry(e,r)),s.push(n)}this._laserline.pathVerticalPlane=s}}const v=i.create(),C=i.create();e.OutlineVisualElement=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
