/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/reactiveUtils","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/UpdatePolicy","../../webgl-engine/lib/WebGLLayer"],(function(e,t,s,r,c,o){"use strict";class i{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return null!=this._resources?this._resources.object:null}get resources(){return null!=this._resources?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view._stage;if(null==this._resources||!e)return;const t=this._resources.object;this._resources.external.forEach((t=>{t.type!==s.ContentObjectType.Mesh&&t.type!==s.ContentObjectType.Line&&t.type!==s.ContentObjectType.Point||e.remove(t)})),t.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer),this._resources.external.forEach((t=>{t.type!==s.ContentObjectType.Mesh&&t.type!==s.ContentObjectType.Line&&t.type!==s.ContentObjectType.Point||e.add(t)}))}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,i=e.view,a=i._stage;if(!a)return;const n=new o.WebGLLayer(a,{pickable:!1,updatePolicy:c.UpdatePolicy.SYNC}),u=new r.Object3D({castShadow:!1}),h=e.createResources(u,n);h.forEach((e=>{a.add(e),e.type===s.ContentObjectType.Texture&&e.load(a.renderView.renderingContext)})),a.add(u),n.add(u);const l=e.cameraChanged,_=l?t.watch((()=>i.state.camera),(e=>l(e)),t.initial):null;this._resources={layer:n,object:u,external:h,cameraHandle:_},this._syncVisible()}_destroyResources(){if(null==this._resources)return;const e=this._resourceFactory.view._stage;e&&(e.remove(this._resources.object),this._resources.layer.destroy(),this._resources.external.forEach((t=>{e.remove(t),t.type===s.ContentObjectType.Texture&&t.unload()}))),this._resources.object.dispose(),this._resources.cameraHandle?.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncVisible(){null!=this._resources&&(this._resources.object.visible=this._visible)}}e.VisualElementResources=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
