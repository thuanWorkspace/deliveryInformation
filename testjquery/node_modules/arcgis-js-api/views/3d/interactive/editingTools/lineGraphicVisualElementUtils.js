/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../support/elevationInfoUtils","../Manipulator3D","./GrabbingState","./ManipulatorState","./ManipulatorType","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/OutlineVisualElement","../../layers/graphics/GraphicState","../../webgl-engine/lib/Material"],(function(e,t,a,n,l,i,r,o,s,c,h,d,u,p,g,m,v,f){"use strict";function y(e){const{view:a,graphic:n}=e,l=new v.GraphicState({graphic:n}),i=E(e,l),r=[i,w(e,i.visualElement,l),a.maskOccludee(n),a.trackGraphicState(l)];return{visualElement:i.visualElement,remove:()=>t.removeHandles(r)}}function E(e,a){const{view:l,graphic:i}=e,r=new m.OutlineVisualElement({view:l,geometry:G(i)?i.geometry:null,elevationInfo:o.getGraphicEffectiveElevationInfo(i),attached:!1,isDecoration:!0}),s=new u.Settings({getTheme:()=>l.effectiveTheme}),c=()=>{r.attached=a.displaying},h=t.handlesGroup([n.watch((()=>s.visualElements.lineGraphics.outline),(e=>e.apply(r)),n.initial),n.watch((()=>s.visualElements.lineGraphics.shadowStyle),(e=>e.apply(r)),n.initial),n.watch((()=>a.displaying),c),n.watch((()=>a.isDraped),(e=>{r.isDraped=e})),a.on("changed",(()=>r.geometry=G(i)?i.geometry:null)),t.destroyHandle(r)]);return c(),{visualElement:r,remove:()=>h.remove()}}function w(e,i,r){const{graphic:s,view:d}=e,m=[],v=o.getGraphicEffectiveElevationInfo(s),y="on-the-ground"===v.mode||!v.offset&&"absolute-height"!==v.mode,E=new h.ManipulatorState,w=new u.Settings({getTheme:()=>d.effectiveTheme}),M=w.visualElements,T=new p.ExtendedLineVisualElement({view:d,extensionType:M.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:f.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0}),D=a.deg2rad(M.heightPlaneAngleCutoff),L=new g.LaserlineVisualElement({view:d,attached:!1,angleCutoff:D,isDecoration:!0}),V=l.signal(1);m.push(n.watch((()=>({lineShadowStyle:w.visualElements.lineGraphics.shadowStyle,pointShadowStyle:w.visualElements.pointGraphics.shadowStyle,alpha:V.value})),(({lineShadowStyle:e,pointShadowStyle:t,alpha:a})=>{e.apply(i,a),t.apply(T,a)}),n.initial));const O=l.signal(1);m.push(n.watch((()=>({heightPlane:w.visualElements.heightPlane,alpha:O.value})),(({heightPlane:e,alpha:t})=>e.apply(L,t)),n.initial));const A=()=>{if(E.update(e),!r.displaying||y&&(r.isDraped||!G(s)||!s.geometry.hasZ))return i.laserlineEnabled=!1,T.attached=!1,void(L.attached=!1);i.laserlineEnabled=!0;const t=E.grabbingState&c.GrabbingState.XY?M.laserlineAlphaMultiplier:1;V.value=t;const a=E.grabbingState&c.GrabbingState.Z?M.laserlineAlphaMultiplier:1;O.value=a,S(T,E),b(e,i,L,E)};m.push(n.watch((()=>w.visualElements.zVerticalLine),(e=>e.apply(T)),n.initial)),m.push(r.on("changed",A),n.watch((()=>r.displaying),A),i.events.on("attachment-origin-changed",A),t.destroyHandle(T),t.destroyHandle(L));const H=[],x=()=>{t.removeHandles(H),H.length=0,e.forEachManipulator((e=>H.push(e.events.on("grab-changed",A)))),e.forEachManipulator((e=>H.push(e.events.on("select-changed",A)))),A()};return x(),m.push(e.onManipulatorsChanged(x),t.refHandle((()=>t.handlesGroup(H)))),t.handlesGroup(m)}function S(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&null!=t.firstGrabbedXY?t.firstGrabbedXY:null;null!=a?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}function b(e,t,a,n){if(n.numSelected>0){i.set(M,0,0,0);let t=0;e.forEachManipulator(((e,a)=>{a===d.ManipulatorType.TRANSLATE_XY&&e.selected&&e instanceof s.Manipulator3D&&(i.add(M,M,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=i.scale(M,M,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;null!=n&&e.view.renderCoordsHelper.toRenderCoords(n,M)?(a.heightManifoldTarget=M,a.attached=!0):a.attached=!1}}function G(e){return null!=e.geometry&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const M=r.create();e.createVisualElements=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
