/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection/projectPointToVector","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../support/elevationInfoUtils","./GrabbingState","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/PointVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/GraphicState","../../webgl-engine/lib/Material"],(function(e,t,n,a,i,l,o,r,s,c,p,u,h,d,g,v,m,f,y,E,w,S){"use strict";function V(e){const{view:n,graphic:a}=e,i=new w.GraphicState({graphic:a}),l=[],o=T(e,i,l);return b(e,i,l,o),l.push(n.trackGraphicState(i)),{visualElement:o,remove:()=>t.removeHandles(l)}}function b(e,o,r,p){const{view:f,graphic:w}=e,V=new g.Settings({getTheme:()=>f.effectiveTheme}),b=new v.ExtendedLineVisualElement({view:f,extensionType:V.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:S.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0});r.push(a.watch((()=>V.visualElements.zVerticalLine),(e=>e.apply(b)),a.initial));const T=new m.LaserlineVisualElement({view:f,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),x=n.deg2rad(V.visualElements.heightPlaneAngleCutoff),G=new m.LaserlineVisualElement({view:f,attached:!1,angleCutoff:x,isDecoration:!0}),L=u.getGraphicEffectiveElevationInfo(e.graphic),D=E.ElevationContext.fromElevationInfo(L),H="on-the-ground"===L.mode||!L.offset&&"absolute-height"!==L.mode,j=new d.ManipulatorState,C=i.signal(1);r.push(a.watch((()=>({heightPlane:V.visualElements.heightPlane,alpha:C.value})),(({heightPlane:e,alpha:t})=>e.apply(G,t)),a.initial));const R=i.signal(1);r.push(a.watch((()=>({shadowStyle:V.visualElements.pointGraphics.shadowStyle,alpha:R.value})),(({shadowStyle:e,alpha:t})=>e.apply(T,t)),a.initial));const I=()=>{j.update(e);const t=P(w),n=H&&(o.isDraped||null==t||!t.hasZ);let a=!0;if(n||null==t)a=!1;else{const e=y.evaluateElevationAlignmentAtPoint(t,f.elevationProvider,D,f.renderCoordsHelper);l.set(M,t.x,t.y,e),s.projectVectorToVector(M,t.spatialReference,M,f.renderCoordsHelper.spatialReference),b.setStartEndFromWorldDownAtLocation(M),T.intersectsWorldUpAtLocation=M}const i=j.grabbingState&h.GrabbingState.Z?V.visualElements.laserlineAlphaMultiplier:1;C.value=i;const r=c.empty(A);!n&&o.displaying&&p.calculateMapBounds(r)&&s.projectVectorToVector(c.getMin(r,M),f.spatialReference,M,f.renderCoordsHelper.spatialReference)?(G.heightManifoldTarget=M,G.attached=!0):G.attached=!1;const u=j.grabbingState&h.GrabbingState.XY?V.visualElements.laserlineAlphaMultiplier:1;R.value=u;const d=a&&o.displaying&&!n;T.attached=d,b.attached=d};r.push(a.watch((()=>[o.displaying,o.isDraped]),I),o.on("changed",I)),e.forEachManipulator((e=>{r.push(e.events.on("grab-changed",I))})),r.push(t.destroyHandle(T)),r.push(t.destroyHandle(b)),r.push(t.destroyHandle(G)),I()}function T(e,n,a){const{view:i,graphic:l}=e,o=new f.PointVisualElement({view:i,geometry:P(l),elevationInfo:u.getGraphicEffectiveElevationInfo(l),isDecoration:!0});return x(e,o,n,a),a.push(t.destroyHandle(o)),o}function P(e){const t=e.geometry;return null==t?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}function x(e,t,n,i){const l=()=>{t.attached=n.displaying},o=new g.Settings({getTheme:()=>e.view.effectiveTheme});G(e,t,n,i),o.visualElements.pointGraphics.outline.apply(t),i.push(a.watch((()=>n.displaying),l,a.initial))}function G(e,n,a,i){const{view:l,graphic:o}=e;let r=null;const s=e=>{null!=r&&(r.remove(),r=null),a.isDraped&&null!=e&&(r=L(l,e,(()=>{n.geometry=e})))},c=()=>{const e=P(o);s(e),n.geometry=e};i.push(a.on("changed",c),t.refHandle((()=>r))),c()}function L(e,t,n){const a=e.elevationProvider.spatialReference;r.projectPointToVector(t,M,a);const i=M[0],l=M[1];return e.elevationProvider.on("elevation-change",(e=>{p.containsXY(e.extent,i,l)&&n()}))}const M=o.create(),A=c.create();e.createVisualElements=V,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
