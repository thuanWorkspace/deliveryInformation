/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../geometry","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/colorUtils","../../../../../core/has","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/unitUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../core/support/UpdatingHandles","../../../../../geometry/Polyline","../../../../../geometry/support/coordsUtils","../../../../../geometry/support/plane","../../../../../geometry/support/vectorStacks","../../../../../layers/graphics/dehydratedPoint","../../../../../support/elevationInfoUtils","../../../../../symbols/support/utils","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../../SegmentLabels3D","../../SnappingVisualizer3D","../dragEventPipeline3D","../geometryUtils","../ManipulatorType","../manipulatorUtils","../settings","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./edgeOffsetUtils","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../webgl-engine/lib/GeometryUtil","../../../../input/IViewEvents","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/editGeometry/interfaces","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/ReshapeTooltipInfos","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../interactive/tooltip/fields/fields","../../../../support/automaticAreaMeasurementUtils","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils","../../../../support/geodesicLengthMeasurementUtils","../../../../../geometry/SpatialReference"],(function(e,t,a,i,n,o,r,s,l,p,h,u,d,c,g,m,_,f,M,v,y,O,x,b,E,S,G,T,I,w,V,A,H,D,R,L,P,C,F,U,N,k,z,X,Z,Y,B,j,q,W,K,J,Q,$,ee,te,ae,ie,ne,oe,re,se,le){"use strict";function pe(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function he(e,t,a,i,n){if(e){const e=n.toXYZ(n.pointToVector(a)),o=b.projectPoint(i,e,E.sv3d.get()),r=se.geodesicDistance(o,e,n.spatialReference);if(null!=r)return u.createLength(r.value*Math.sign(t),r.unit)}return u.createLength(t*c.getMetersPerUnitForSR(a.spatialReference),"meters")}e.ReshapeOperation=class extends(s.EventedMixin(i)){constructor(e){super(e),this._selectedIndex=0,this._manipulatorHandles=new l,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=me.NONE,this._updatingHandles=new y.UpdatingHandles,this._recreatingManipulators=!1,this._settings=new C.Settings({getTheme:()=>this.view.effectiveTheme}),this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null,this._translateVertexTooltipInfo=null,this._translateVertexXYTooltipInfo=null,this._translateVertexZTooltipInfo=null,this._edgeOffsetTooltipInfo=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:e,view:t}=this,a=this._settings.manipulators,i=a.vertex;this._vertexManipulatorMaterial=w.createManipulatorMaterial(o.unitRGBAFromColor(i.color),i.renderOccluded),this._vertexManipulatorOutlineMaterial=w.createManipulatorOutlineMaterial(o.unitRGBAFromColor(i.outlineColor),i.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=w.createManipulatorOutlineMaterial(o.unitRGBAFromColor(i.hoverOutlineColor),i.renderOccluded);const n=a.edge;this._edgeManipulatorMaterial=w.createManipulatorMaterial(o.unitRGBAFromColor(n.color),n.renderOccluded),this._edgeManipulatorOutlineMaterial=w.createManipulatorOutlineMaterial(o.unitRGBAFromColor(n.outlineColor),n.renderOccluded);const r=a.edgeOffset;this._edgeOffsetManipulatorMaterial=w.createManipulatorMaterial(o.unitRGBAFromColor(r.color),r.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=w.createManipulatorMaterial(o.unitRGBAFromColor(r.hoverColor),r.renderOccluded,!1);const s=a.selected;this._selectedManipulatorMaterial=w.createManipulatorMaterial(o.unitRGBAFromColor(s.color),s.renderOccluded),this._selectedManipulatorOutlineMaterial=w.createManipulatorOutlineMaterial(o.unitRGBAFromColor(s.outlineColor),s.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=w.createManipulatorOutlineMaterial(o.unitRGBAFromColor(s.hoverOutlineColor),s.renderOccluded);const l=this._graphicState=new Y.GraphicState({graphic:e});this._tooltip=new te.Tooltip({view:t}),this.addHandles([d.watch((()=>{const e=this._settings.manipulators;return{vertexSettings:e.vertex,edgeSettings:e.edge,edgeOffsetSettings:e.edgeOffset,selectedSettings:e.selected}}),(({vertexSettings:e,edgeSettings:t,edgeOffsetSettings:a,selectedSettings:i})=>{e.applyColor(this._vertexManipulatorMaterial),e.applyOutline(this._vertexManipulatorOutlineMaterial),e.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),t.applyColor(this._edgeManipulatorMaterial),t.applyOutline(this._edgeManipulatorOutlineMaterial),a.applyColor(this._edgeOffsetManipulatorMaterial),a.applyHover(this._edgeOffsetManipulatorHoverMaterial),i.applyColor(this._selectedManipulatorMaterial),i.applyOutline(this._selectedManipulatorOutlineMaterial),i.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)})),d.watch((()=>l.displaying),(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),d.watch((()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset})),(({labels:e,enabled:t,edgeOffsetEnabled:a})=>{null!=e&&(e.visible=t,e.edgeDistance=a?"far":"default")}),d.initial),d.when((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),d.initial),this.view.trackGraphicState(l)])}destroy(){this._segmentLabels=h.destroyMaybe(this._segmentLabels),this._tooltip=h.destroyMaybe(this._tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get inputGeometry(){return null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.type));this._removeVertices(e)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=h.destroyMaybe(this._moveManipulation),this._graphicMoveManipulation=h.destroyMaybe(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(e){if(null==this._editGeometryOperations)return;const t=G.getGraphicEffectiveElevationInfo(this.graphic);for(const a of this._editGeometryOperations.data.components){const i=e?.byComponentIndex.get(a.index);for(const e of a.vertices){const a=i?.has(e.index);this._createVertexOrEdgeManipulator(e,t,a)}for(const e of a.edges)this._createVertexOrEdgeManipulator(e,t)}this._createGraphicMoveManipulation(),this._createMoveManipulation(t),this._createVisualElements()}get canRedo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canRedo}get canUndo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canUndo}redo(){if(null==this._editGeometryOperations)return null;const e=this._editGeometryOperations.redo();return null!=e&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(null==this._editGeometryOperations)return null;this.emit("undo");const e=this._editGeometryOperations.undo();return null!=e&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(e){const t={byComponentIndex:new Map};if(null!=e&&null!=this.inputGeometry&&x.hasCompatibleTopology(e,this.inputGeometry))for(const i of this._manipulatorInfos)if("vertex"===i.type&&i.manipulator.selected){const{index:e,component:{index:a}}=i.handle,{byComponentIndex:n}=t,o=n.get(a)||new Set;o.add(e),n.set(a,o)}if(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=h.destroyMaybe(this._editGeometryOperations),this._segmentLabels=h.destroyMaybe(this._segmentLabels),null==e)return void(this._recreatingManipulators=!1);const a="mesh"===e.type?e.anchor:e;this._editGeometryOperations=K.EditGeometryOperations.fromGeometry(a,this.view.state.viewingMode),this._createManipulators(t),this._segmentLabels=new A.SegmentLabels3D({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:G.getGraphicEffectiveElevationInfo(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return t;let a=0;const i=[],n=this._manipulatorInfos.some((e=>"vertex"===e.type&&e.manipulator.selected)),o=e===_e.SELECTED_OR_ALL&&n;for(const r of this._manipulatorInfos)"vertex"===r.type&&(r.manipulator.grabbing||o&&!r.manipulator.selected||i.push(r),a++);if(0===i.length)return t;this._moveVertices(i,t);if(i.length===a){if(this._updateEventState(me.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(me.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t}_isMultiVertexSelection(){return this._manipulatorInfos.reduce(((e,t)=>"vertex"===t.type&&t.manipulator.selected?e+1:e),0)>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(me.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:a,mapDeltaZ:i}=e;if(!t&&!a&&!i)return;const n=[];for(const o of this._manipulatorInfos)"vertex"===o.type&&(o.manipulator.selected&&!o.manipulator.grabbing||o===e.info)&&n.push(o);this._moveVertices(n,e,J.AccumulationBehaviour.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case me.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case me.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case me.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case me.MOVING:switch(this._reshapeEventState){case me.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case me.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case me.RESHAPING:switch(this._reshapeEventState){case me.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case me.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulation(){const{tool:e,view:t}=this,a=this._graphicState;if(this._graphicMoveManipulation=new z.MoveXYGraphicManipulation({tool:e,view:t,graphicState:a}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,a,i)=>{a.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=this._editGeometryOperations.createUndoGroup()),t))).next((e=>this._perGraphicManipulatorDragAction(_e.ALL,e))).next((e=>(this._updateTranslateGraphicTooltip(N.ManipulationType.XY,e),e))).next((t=>{"end"===t.action&&(this._tooltip.clear(),e=h.removeMaybe(e))})),i.next((()=>this._onDragCancel(!0,(()=>e=h.removeMaybe(e)))))}))),this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(e,!1))))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add(e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()})))))}_createMoveManipulation(e){const{graphic:t,tool:a,view:i}=this,n=this._graphicState;this._moveManipulation=new N.MoveManipulation({tool:a,view:i,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&P.canMoveZ(t),snapToScene:!1,radius:N.MoveManipulation.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((e=>this.addHandles([e.events.on("immediate-click",(a=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...a,graphic:t}),a.stopPropagation()})),this._watchAndUpdateGrabState(e,!1)])));const o=e=>t=>{this.addHandles(t.events.on("focus-changed",(({action:t})=>{"focus"===t&&this._tooltipOptions.enabled?this._updateTranslateTooltip(e):this._tooltip.clear()})))};this._moveManipulation.xyManipulation.forEachManipulator(o(N.ManipulationType.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(o(N.ManipulationType.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(o(N.ManipulationType.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=t.geometry.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline(((i,n,o,r,s)=>{const{snappingStep:l,cancelSnapping:p}=$.createSnapDragEventPipelineStep({predicate:e=>!!e.info,snappingManager:a.snappingManager,snappingContext:new Q.SnappingContext({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:s,excludeFeature:t,visualizer:new H.SnappingVisualizer3D}),updatingHandles:this._updatingHandles,useZ:!1});return r=r.next((e=>(this._onDragCancel(),e))).next(p),{steps:o=o.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>"vertex"===e.type&&e.manipulator.selected));return e.manipulatorType===L.ManipulatorType.TRANSLATE_XY&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:e})).next(q.sceneSnappingAtLocation(this.view,e,t)).next(...l).next(q.addMapDelta()).next((e=>this._perGraphicManipulatorDragAction(_e.SELECTED_OR_ALL,e))).next((e=>(this._updateTranslateTooltip(i,e),e))),cancel:r}}),e,r,t),d.watch((()=>n.displaying),(()=>this._updateMoveManipulationPosition()),d.initial),n.on("changed",(()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()})),d.watch((()=>n.isDraped),(e=>{this._updateMoveManipulationPosition();const t="align-move-manipulation";e?this.addHandles(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),t):this.removeHandles(t)}),d.initial)])}_createVisualElements(){const{graphic:e,view:t}=this,a=F.createVisualElements({view:t,graphic:e,forEachManipulator:e=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(e),this._moveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,L.ManipulatorType.TRANSLATE_XY)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});null!=a&&(this._outlineVisualElement=a.visualElement instanceof Z.OutlineVisualElement?a.visualElement:null),null!=this._outlineVisualElement&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}))),this._manipulatorHandles.add(a)}_createEdgeOffsetManipulator(e,t=G.getGraphicEffectiveElevationInfo(this.graphic)){const a=this._settings.manipulators.edgeOffset,i=a.size/2,n=i+a.collisionPadding,o=i/n,r=o*Math.sqrt(3)/2;null==this._edgeOffsetManipulatorGeometryInside&&(this._edgeOffsetManipulatorGeometryInside=B.createExtrudedTriangle(this._edgeOffsetManipulatorMaterial,r,o/2,o/2,a.height,a.offset)),null==this._edgeOffsetManipulatorGeometryOutside&&(this._edgeOffsetManipulatorGeometryOutside=B.createExtrudedTriangle(this._edgeOffsetManipulatorMaterial,-r,o/2,o/2,a.height,-a.offset));const s=[new V.RenderObject(this._edgeOffsetManipulatorGeometryInside.instantiate(),W.ManipulatorStateFlags.Unfocused),new V.RenderObject(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),W.ManipulatorStateFlags.Focused),new V.RenderObject(this._edgeOffsetManipulatorGeometryOutside.instantiate(),W.ManipulatorStateFlags.Unfocused),new V.RenderObject(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),W.ManipulatorStateFlags.Focused)],l=new I.Manipulator3D({view:this.view,renderObjects:s,elevationInfo:"on-the-ground"!==t.mode||T.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionType:{type:"disc",direction:v.fromValues(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),h=new I.Manipulator3D({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),d={manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(d,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(d);const c=[];for(const p of[d.handle.leftVertex,d.handle.rightVertex]){const e=this._getManipulatorInfoFromHandle(p);null!=e&&c.push(e.manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(d))))}d.locationUpdateHandle=p.handlesGroup(c),this._manipulatorHandles.add(d.locationUpdateHandle,l),this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!0),this._watchAndUpdateGrabState(h,!0)],l),this._manipulatorHandles.add(q.createManipulatorDragEventPipeline(l,this._createEdgeOffsetPipeline(d,t)),l),this._manipulatorHandles.add(q.createManipulatorDragEventPipeline(h,((e,a,i,n)=>{if("touch"===n){this._createEdgeOffsetPipeline(d,t)(e,a,i)}else if(this.enableMoveGraphic){const n=this.graphic,o=null!=n.geometry?n.geometry.spatialReference:null;a.next((e=>this._trackNumDragging(e))).next(q.dragAtLocation(this.view,e.elevationAlignedLocation)).next(D.screenToMapXYAtLocation(this.view,e.elevationAlignedLocation,t,o,n)).next(q.addScreenDelta()).next(q.addMapDelta()).next((e=>this._perGraphicManipulatorDragAction(_e.ALL,e))).next((e=>(this._updateTranslateGraphicTooltip(N.ManipulationType.XY,e),e))).next((e=>{"end"===e.action&&this._tooltip.clear()})),i.next((()=>this._onDragCancel(!e.metadata.deleting)))}})),l);const g=e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()};return this._manipulatorHandles.add([l.events.on("immediate-click",g),h.events.on("immediate-click",g),l.events.on("focus-changed",(({action:e})=>{const{_tooltipOptions:t,_tooltip:a}=this;"focus"===e&&t.enabled?(a.info=this._edgeOffsetTooltipInfo??(this._edgeOffsetTooltipInfo=new ee.ReshapeEdgeOffsetTooltipInfo({tooltipOptions:t})),a.info.distance=u.zeroMeters,a.info.tooltipOptions=t,this._updateTooltipAreaOrTotalLength(a.info)):a.clear()}))],l),this._manipulatorInfos.push(d),this.manipulators.add(l),this.manipulators.add(h),this.emit("manipulators-changed"),d}_autoHideEdgeOffsetManipulator(e,t){const a=e.manipulator,i=e.edgeManipulator,n=()=>{e.visibilityHandle=h.removeMaybe(e.visibilityHandle);const n=this._getManipulatorInfoFromHandle(e.handle.leftVertex),o=this._getManipulatorInfoFromHandle(e.handle.rightVertex),r=null!=n&&null!=o&&X.screenEdgeLengthSquared(n.manipulator.renderLocation,o.manipulator.renderLocation,this.view.state.camera)<t;(!a.focused&&!i.focused||r)&&(a.grabbable=!r,i.grabbable=!r,e.visibilityHandle=p.handlesGroup([a.disableDisplay(),p.makeHandle((()=>{a.grabbable=!0,i.grabbable=this.enableMoveGraphic}))]))};this._manipulatorHandles.add([a.events.on("focus-changed",n),i.events.on("focus-changed",n),p.makeHandle((()=>{h.removeMaybe(e.visibilityHandle),i.metadata.deleting=!0,this.manipulators.remove(i)}))],a),n()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const{coordinateHelper:t}=this._editGeometryOperations.data,a=X.createEdgeOffsetIntersectionPlane(this.view,e.manipulator.elevationAlignedLocation,X.createEdgeOffsetOperation(t,e.handle,e.manipulator.elevationInfo)),i=this._getManipulatorInfoFromHandle(e.handle.leftVertex),n=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(null==i||null==n)return;const o=i.manipulator.renderLocation,r=n.manipulator.renderLocation,s=null!=a?X.edgeOffsetRotationMatrix(a,o,r):f.IDENTITY;e.manipulator.modelTransform=s,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=s;const l=M.length(M.subtract(de,o,r))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(a,i,n)=>{this._clearSelection();const{step:o,cleanup:r}=this._initializeEdgeOffset(e,t);i.next((e=>this._trackNumDragging(e))).next(q.dragAtLocation(this.view,a.elevationAlignedLocation)).next(o).next(D.screenToRenderPlaneFromEvent(this.view)).next(D.convertToMapCoordinates(this.view,this._editGeometryOperations.data.spatialReference)).next(q.addMapDelta()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next((e=>{"end"===e.action&&r()})),n.next((()=>{a.metadata.deleting||(r(),this._onDragCancel())}))}}_initializeEdgeOffset(e,t){const{view:a}=this,i=this._editGeometryOperations,n=X.createEdgeOffsetOperation(i.data.coordinateHelper,e.handle,t),r=i.createUndoGroup(),s=X.createEdgeOffsetIntersectionPlane(a,e.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const t=this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge);null!=t&&this._splitEdgeManipulator(t,1)}if(n.requiresSplitEdgeRight){const t=this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge);null!=t&&this._splitEdgeManipulator(t,0)}const l=()=>new O({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:i.data.spatialReference}),u=this._settings,c=new Z.OutlineVisualElement({view:a,isDraped:this._graphicState.isDraped,geometry:l(),elevationInfo:e.elevationInfo,width:u.visualElements.lineGraphics.outline.width,attached:!1,isDecoration:!0});let g;const m=()=>{this._cleanEdgeOffsetCollapsedEdges(e),g=h.removeMaybe(g)},_=this.on("undo",m);return g=p.handlesGroup([d.watch((()=>o.unitRGBAFromColor(this._accentColor)),(e=>c.color=e),d.initial),p.destroyHandle(c),d.watch((()=>this._graphicState.isDraped),(e=>c.isDraped=e)),this._graphicState.on("changed",(()=>c.geometry=l())),r,_]),c.attached=!0,{step:e=>null==n||null==s?(m(),null):{...e,operation:n,plane:s},cleanup:m}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||null==t.operation)return t;this._updateEventState(me.RESHAPING);const{mapDeltaX:a,mapDeltaY:i,mapDeltaZ:n}=t;return(a||i||n)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_applyComputeEdgeOffsetDistanceStep(){return e=>{const{operation:t,mapEnd:a}=e;return null==t||null==a?e:("start"===e.action&&t.selectArrowFromStartPoint(a),{...e,signedDistance:t.signedDistanceToPoint(a)})}}_showEdgeOffsetTooltip(){return e=>{const{mapEnd:t,signedDistance:a,operation:i}=e,{_tooltip:n,_tooltipOptions:o}=this;return o.enabled&&null!=a?(n.info=this._edgeOffsetTooltipInfo??(this._edgeOffsetTooltipInfo=new ee.ReshapeEdgeOffsetTooltipInfo({tooltipOptions:o})),n.info.tooltipOptions=o,n.info.distance="end"===e.action?u.zeroMeters:he(this._graphicState.isDraped,a*i.selectedArrow,t,i.plane,this._editGeometryOperations.data.coordinateHelper),this._updateTooltipAreaOrTotalLength(n.info),e):(n.clear(),e)}}_cleanEdgeOffsetCollapsedEdges(e){const t=e.handle.leftVertex.leftEdge?.leftVertex,a=e.handle.leftVertex,i=e.handle.rightVertex.rightEdge?.rightVertex,n=e.handle.rightVertex,o=this._editGeometryOperations.data.coordinateHelper,r=[];if(t&&o.distance(t.pos,a.pos)<ce){const e=this._getManipulatorInfoFromHandle(a);null!=e&&r.push(e)}if(o.distance(a.pos,n.pos)<ce||i&&o.distance(i.pos,n.pos)<ce){const e=this._getManipulatorInfoFromHandle(n);null!=e&&r.push(e)}r.length&&this._removeVertices(r)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,a=t+e.collisionPadding;return{size:t/a,outlineSize:(t+e.outlineSize)/a}}_createVertexOrEdgeManipulator(e,t=G.getGraphicEffectiveElevationInfo(this.graphic),a=!1){const{view:i}=this,n=this._settings;if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(null==this._vertexManipulatorGeometry||null==this._vertexManipulatorOutlineGeometry){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(n.manipulators.vertex);this._vertexManipulatorGeometry=B.createSphereGeometry(this._vertexManipulatorMaterial,e,16,16),this._vertexManipulatorOutlineGeometry=B.createSphereGeometry(this._vertexManipulatorOutlineMaterial,t,16,16)}if(null==this._edgeManipulatorGeometry||null==this._edgeManipulatorOutlineGeometry){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(n.manipulators.edge);this._edgeManipulatorGeometry=B.createSphereGeometry(this._edgeManipulatorMaterial,e,16,16),this._edgeManipulatorOutlineGeometry=B.createSphereGeometry(this._edgeManipulatorOutlineMaterial,t,16,16)}const{geometry:o}=this.graphic,r=o?.type,s="point"===r||"mesh"===r?[]:[new V.RenderObject(this._vertexManipulatorGeometry.instantiate(),ge.Vertex|W.ManipulatorStateFlags.Unselected),new V.RenderObject(this._vertexManipulatorOutlineGeometry.instantiate(),ge.Vertex|W.ManipulatorStateFlags.Unfocused|W.ManipulatorStateFlags.Unselected),new V.RenderObject(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),ge.Vertex|W.ManipulatorStateFlags.Focused|W.ManipulatorStateFlags.Unselected),new V.RenderObject(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),W.ManipulatorStateFlags.Selected),new V.RenderObject(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),W.ManipulatorStateFlags.Selected|W.ManipulatorStateFlags.Unfocused),new V.RenderObject(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),W.ManipulatorStateFlags.Selected|W.ManipulatorStateFlags.Focused)];this.enableMidpoints&&s.push(new V.RenderObject(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),ge.Edge|W.ManipulatorStateFlags.Focused|W.ManipulatorStateFlags.Unselected),new V.RenderObject(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),ge.Edge|W.ManipulatorStateFlags.Focused|W.ManipulatorStateFlags.Unselected),new V.RenderObject(this._edgeManipulatorGeometry.instantiate(),ge.Edge|W.ManipulatorStateFlags.Unfocused|W.ManipulatorStateFlags.Unselected),new V.RenderObject(this._edgeManipulatorOutlineGeometry.instantiate(),ge.Edge|W.ManipulatorStateFlags.Unfocused|W.ManipulatorStateFlags.Unselected));const l=new I.Manipulator3D({view:i,renderObjects:s,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),metadata:{deleting:!1}});l.selected=a,this._setTypeSpecificManipulatorSettings(l,e,t);const u="edge"===e.type?{manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:l,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(u),this.manipulators.add(l),this._updateManipulatorPosition(u),"edge"===u.type){const e=[];for(const t of[u.handle.leftVertex,u.handle.rightVertex]){const a=this._getManipulatorInfoFromHandle(t);null!=a&&e.push(a.manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(u))))}u.locationUpdateHandle=p.handlesGroup(e),this._manipulatorHandles.add(u.locationUpdateHandle,l)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(l,!0),l);const d=q.createManipulatorDragEventPipeline(l,((e,a,i,n)=>{let o=null;const{snappingStep:r,cancelSnapping:s}=$.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Q.SnappingContext({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:n,excludeFeature:this.graphic,visualizer:new H.SnappingVisualizer3D}),updatingHandles:this._updatingHandles,useZ:!1});i=i.next((t=>(this._onDragCancel(!e.metadata.deleting,(()=>o=h.removeMaybe(o))),t))).next(s),a.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(o=this._editGeometryOperations.createUndoGroup()),"edge"===u.type){const t=this._splitEdgeManipulator(u);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:u,snapOrigin:u.handle.pos}})).next(q.dragAtLocation(this.view,e.elevationAlignedLocation)).next(D.screenToMapXYForGraphicAtLocation(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(q.sceneSnappingAtLocation(this.view,t,this.graphic)).next(...r).next(q.addMapDelta()).next((t=>{this._perVertexManipulatorDragAction(t),"end"===t.action&&(o=h.removeMaybe(o)),this._updateTranslateVertexTooltip(e,N.ManipulationType.XY,t)}))}));return this._manipulatorHandles.add([d,l.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,u))),l.events.on("select-changed",(()=>{u.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})),l.events.on("focus-changed",(({action:e})=>{"focus"===e&&"edge"!==u.type?this._updateTranslateVertexTooltip(l,N.ManipulationType.XY):this._tooltip.clear()}))],l),this.emit("manipulators-changed"),u}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_onDragCancel(e=!0,t){switch(this._numDragging--,e&&(this.undo(),this.outputGeometry=null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null),null!=this.tool.snappingManager&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case me.NONE:break;case me.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case me.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(me.NONE)}_setTypeSpecificManipulatorSettings(e,t,a){const{graphic:i}=this,n=this._settings;switch(t.type){case"vertex":{e.state=ge.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2;const{size:t,collisionPadding:o}=n.manipulators.vertex;e.radius=t/2+o,e.elevationInfo=a;const{geometry:r}=i,s=r?.type;e.interactive=null!=s&&"point"!==s&&"mesh"!==s;break}case"edge":{e.state=ge.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1;const{size:t,collisionPadding:o}=n.manipulators.edge;e.radius=t/2+o,e.elevationInfo="on-the-ground"!==a.mode||T.isVolumetricSymbol(i.symbol)?{mode:"absolute-height",offset:0}:a;break}}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(a=>this._onGrabStateChanged(e,t,a.action,a.pointerType)))}_onGrabStateChanged(e,t,a,i="mouse"){if(!this._recreatingManipulators){if("start"===a)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(me.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==i||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((e=>{const{manipulator:t}=e,{geometry:a}=this.graphic,i=a?.type;t.interactive=t.grabbing||!this._numGrabbing&&null!=i&&"point"!==i&&"mesh"!==i,"edgeManipulator"in e&&(e.edgeManipulator.interactive=e.edgeManipulator.grabbing||!this._numGrabbing)})),this._graphicMoveManipulation.forEachManipulator((e=>{e.interactive=e.grabbing||!this._numGrabbing})))}}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){null!=e&&(e.manipulator.metadata.deleting=!0,this.manipulators.remove(e.manipulator),this._manipulatorHandles.remove(e.manipulator),n.removeUnordered(this._manipulatorInfos,e),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(null==e)return;const t=this._editGeometryOperations;if("vertex"===e.type)e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,ue),e.manipulator.grabbing&&null!=this._vertexLaserLineVisualElement&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.type){const a=this._getManipulatorInfoFromHandle(e.handle.leftVertex),i=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(null==a||null==i)return;const n=a.manipulator,o=i.manipulator;if(null!=e.manipulator.elevationInfo&&"on-the-ground"===e.manipulator.elevationInfo.mode){const a=n.location,i=o.location,r=.5,s=a.x+r*(i.x-a.x),l=a.y+r*(i.y-a.y),p=a.hasZ&&i.hasZ?0:void 0;e.manipulator.location=S.makeDehydratedPoint(s,l,p,t.data.spatialReference)}else M.lerp(de,n.renderLocation,o.renderLocation,.5),e.manipulator.renderLocation=de}}_splitEdgeManipulator(e,t=.5){const a=this._editGeometryOperations,i=a.splitEdge(e.handle,t).createdVertex;e.locationUpdateHandle=h.removeMaybe(e.locationUpdateHandle);const n=G.getGraphicEffectiveElevationInfo(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(e),o=this._createVertexOrEdgeManipulator(i)):(o=e,o.handle=i,o.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,n)),i.leftEdge&&this._createVertexOrEdgeManipulator(i.leftEdge),i.rightEdge&&this._createVertexOrEdgeManipulator(i.rightEdge),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(o),this.enableEdgeOffset||this._updateTranslateVertexTooltip(o.manipulator,N.ManipulationType.XY),this._updateSelection(e.manipulator);const r=this._updateEventState(me.RESHAPING),s=a.data.coordinateHelper.vectorToArray(o.handle.pos),l=a.data.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:s,componentIndex:l,vertexIndex:i.index}],added:s}),r&&this._updateEventState(me.NONE),o}_updateMoveManipulationPosition(){const e=M.set(de,0,0,0);let t=0,a=!1,i=null,n=null;for(const o of this._manipulatorInfos)"vertex"===o.type&&(o.manipulator.selected?(t++,M.add(e,e,o.manipulator.renderLocation),null==i||o.selectedIndex>i.selectedIndex?(n=i,i=o):(null==n||o.selectedIndex>n.selectedIndex)&&(n=o)):a=!0);if(0===t){const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&P.canMoveZ(this.graphic),this._moveManipulation.angle=R.orientation(this.graphic.geometry),this._moveManipulation.radius=N.MoveManipulation.radiusForSymbol(this.graphic.symbol)}else{const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&P.canMoveZ(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t;let a=0;if(null!=i){const e=i.handle.pos,t=null!=n?n.handle.pos:i.handle.leftEdge&&i.handle.leftEdge.leftVertex?i.handle.leftEdge.leftVertex.pos:null,o=null==n&&i.handle.rightEdge&&i.handle.rightEdge.rightVertex?i.handle.rightEdge.rightVertex.pos:null;t&&o?this._moveManipulation.xyAxisManipulation.available=!1:t?a=pe(t,e):o&&(a=pe(e,o))}this._moveManipulation.angle=a,this._moveManipulation.radius=U.discRadiusSmall}0!==t&&a?(M.scale(e,e,1/t),ue.spatialReference=this._editGeometryOperations.data.spatialReference,ue.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,ue),this._moveManipulation.elevationAlignedLocation=ue):null==this._outlineVisualElement||this._graphicState.isDraped||null==this._outlineVisualElement.attachmentOrigin?w.placeAtGraphic(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(e){const t=new Array,a=this._editGeometryOperations;for(const i of e)if("vertex"===i.type&&a.canRemoveVertex(i.handle.component)){t.push(i.handle),this._removeManipulator(i),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.rightEdge));const e=a.removeVertices([i.handle]),n=e.removedVertices?.[0].createdEdge;n&&this._createVertexOrEdgeManipulator(n)}if(t.length>0){const e=t.map((e=>{const t=a.data.components.indexOf(e.component);return{coordinates:a.data.coordinateHelper.vectorToArray(e.pos),componentIndex:t,vertexIndex:e.index}}));this.outputGeometry=a.data.geometry;const i=this._updateEventState(me.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(i&&(this._updateEventState(me.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,a=("start"===t.action?J.AccumulationBehaviour.NEW_STEP:J.AccumulationBehaviour.ACCUMULATE_STEPS)){const i=this._editGeometryOperations;i.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,a),this.outputGeometry=i.data.geometry;for(const n of e)this._updateManipulatorPosition(n)}_offsetEdge(e,t){if(null==t.operation||null==t.signedDistance)return;const a=this._editGeometryOperations,i=t.operation.clone();i.distance=t.signedDistance,a.updateVertices([e.handle.leftVertex,e.handle.rightVertex],i),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.type&&(t.manipulator.selected=!t.manipulator.selected,e.button===j.MouseButton.Right&&this._removeVertices([t])),"edge"===t.type&&e.button===j.MouseButton.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}_updateTranslateTooltip(e,t){const a=this._manipulatorInfos.filter((e=>"vertex"===e.type&&e.manipulator.selected));1===a.length?this._updateTranslateVertexTooltip(a[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)}_updateTranslateGraphicTooltip(e,t){const{_tooltipOptions:a,_tooltip:i}=this;if(!a.enabled)return;const n=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case N.ManipulationType.XY:i.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new ae.TranslateGraphicTooltipInfo({tooltipOptions:a})),this._updateTranslateTooltipDistance(i.info,t,((e,t)=>oe.autoHorizontalDistanceByElevationModeBetweenPoints(e,t,n)));break;case N.ManipulationType.XY_AXIS:i.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new ae.TranslateGraphicXYTooltipInfo({tooltipOptions:a})),this._updateTranslateTooltipDistance(i.info,t,((e,a)=>{const i=oe.autoHorizontalDistanceByElevationModeBetweenPoints(e,a,n);return u.scale(i,k.axisConstrainedDragSign(t))}));break;case N.ManipulationType.Z:i.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new ae.TranslateGraphicZTooltipInfo({tooltipOptions:a})),this._updateTranslateTooltipDistance(i.info,t,re.verticalSignedDistanceBetweenPoints)}i.info.tooltipOptions=a}_updateTranslateVertexTooltip(e,t,a){const{_tooltipOptions:i,_tooltip:n}=this;if(!i.enabled)return;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case N.ManipulationType.XY:n.info=this._translateVertexTooltipInfo??(this._translateVertexTooltipInfo=new ae.TranslateVertexTooltipInfo({tooltipOptions:i})),this._updateTranslateTooltipDistance(n.info,a,((e,t)=>oe.autoHorizontalDistanceByElevationModeBetweenPoints(e,t,o))),this._updateTooltipAreaOrTotalLength(n.info);break;case N.ManipulationType.XY_AXIS:n.info=this._translateVertexXYTooltipInfo??(this._translateVertexXYTooltipInfo=new ae.TranslateVertexXYTooltipInfo({tooltipOptions:i})),this._updateTranslateTooltipDistance(n.info,a,((e,t)=>{const i=oe.autoHorizontalDistanceByElevationModeBetweenPoints(e,t,o);return u.scale(i,k.axisConstrainedDragSign(a))})),this._updateTooltipAreaOrTotalLength(n.info);break;case N.ManipulationType.Z:n.info=this._translateVertexZTooltipInfo??(this._translateVertexZTooltipInfo=new ae.TranslateVertexZTooltipInfo({tooltipOptions:i})),this._updateTranslateTooltipDistance(n.info,a,re.verticalSignedDistanceBetweenPoints)}const r=re.elevationOfPoint(e.elevationAlignedLocation);null!=r&&(n.info.elevation=ie.makeElevationField({actual:r})),n.info.tooltipOptions=i}_updateTranslateTooltipDistance(e,t,a){if(null!=t&&"end"!==t.action){const{mapStart:i,mapEnd:n}=t,o=a(i,n);e.distance=null!=o?o:u.zeroMeters}else e.distance=u.zeroMeters}_updateTooltipAreaOrTotalLength(e){const{geometry:t}=this.graphic;if(null==t)return e.area=null,void(e.totalLength=null);const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";e.area="polygon"===t.type?ne.autoAreaByElevationMode(t,a):null,e.totalLength="polyline"===t.type?oe.autoLengthByElevationMode(t,a):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}},t.__decorate([g.property()],e.ReshapeOperation.prototype,"_editGeometryOperations",void 0),t.__decorate([g.property()],e.ReshapeOperation.prototype,"_segmentLabels",void 0),t.__decorate([g.property({constructOnly:!0})],e.ReshapeOperation.prototype,"tool",void 0),t.__decorate([g.property()],e.ReshapeOperation.prototype,"_tooltip",void 0),t.__decorate([g.property()],e.ReshapeOperation.prototype,"inputGeometry",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"outputGeometry",void 0),t.__decorate([g.property({readOnly:!0})],e.ReshapeOperation.prototype,"updating",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"manipulators",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"view",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"graphic",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"enableZShape",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"enableZVertex",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"enableMoveGraphic",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"enableMidpoints",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"enableEdgeOffset",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"_labelOptions",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"_tooltipOptions",null),t.__decorate([g.property()],e.ReshapeOperation.prototype,"_accentColor",null),e.ReshapeOperation=t.__decorate([_.subclass("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],e.ReshapeOperation);const ue=S.makeDehydratedPoint(0,0,void 0,le.WGS84),de=v.create(),ce=1e-6;var ge,me,_e;!function(e){e.Vertex=W.ManipulatorStateCustomFlags.Custom1,e.Edge=W.ManipulatorStateCustomFlags.Custom2}(ge||(ge={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(me||(me={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(_e||(_e={})),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
