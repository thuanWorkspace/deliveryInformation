/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/support/UpdatingHandles","../../../../../layers/graphics/dehydratedPoint","../../../../../support/elevationInfoUtils","../../manipulatorUtils","../../SnappingVisualizer3D","../geometryUtils","../isSupportedGraphicUtils","../manipulatorUtils","../meshFastUpdateUtils","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./isSupportedGraphic","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/sketch/SketchTooltipOptions","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils"],(function(t,e,i,a,n,o,s,r,p,l,c,h,u,d,v,g,M,f,m,_,y,T,G,w,E,S,b,x,I,O,H,D,z,U,X,P,Y,A,k,R){"use strict";class Z{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class V{constructor(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"}}class C{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const B="manipulators";t.GraphicMoveTool=class extends(a.EventedMixin(D.InteractiveToolBase)){constructor(t){super(t),this._infos=new Map,this.graphics=new i,this.enableZ=!0,this.tooltipOptions=new U,this.type="move-3d",this._updatingHandles=new d.UpdatingHandles,this._moveManipulation=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),r.watch((()=>this.tooltipOptions.enabled),(e=>{this._tooltip=e?new Y.Tooltip({view:t}):o.destroyMaybe(this._tooltip)}),r.syncAndInitial)]);const e=this.graphics.toArray();this._updateGraphicInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=o.destroyMaybe(this._tooltip),this._moveManipulation=o.destroyMaybe(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:t,removed:e}){for(const i of t){if(x.isSupportedGraphic(i)!==_.SupportedGraphicResult.SUPPORTED)continue;const t=new F(i),e=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:e})}for(const i of e)this._infos.get(i)?.handle.remove(),this._infos.delete(i)}_setupFastTransformUpdates(t){for(const e of t){const{info:t}=this._infos.get(e);this.addHandles(T.meshTransformFastUpdateHandles(t.state),e)}}_refreshManipulators(){if(this.removeHandles(B),this._moveManipulation=o.destroyMaybe(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new b.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;null!=i&&("start"===t?(this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new A.TranslateGraphicTooltipInfo({tooltipOptions:e})),i.info=this._translateGraphicTooltipInfo,i.info.tooltipOptions=e,i.info.distance=s.zeroMeters):i.clear())}))],B))),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,a,n)=>this._buildDragEventPipeline(t,E.ManipulationType.XY,e,i,a,n))),B)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new E.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?E.MoveManipulation.radiusForSymbol(t[0].graphic.symbol):w.discRadius});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.at(0)}),i.stopPropagation()})),B)}));const i=e=>i=>{this.addHandles(i.events.on("focus-changed",(({action:i})=>{const a=this._tooltip;null!=a&&("focus"===i?this._updateMoveTooltip(t,e):a.clear())})),B)};this._moveManipulation.xyManipulation.forEachManipulator(i(E.ManipulationType.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(E.ManipulationType.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(E.ManipulationType.Z));const a=()=>this._updateMoveManipulation(t);for(const o of t)this.addHandles([o.state.on("changed",a),r.watch((()=>o.state.displaying),a)],B);const n=t[t.length-1];this.addHandles(n.state.on("changed",(()=>this._updateMoveManipulationAngle(n))),B),this.addHandles(e.createDragPipeline(((e,i,a,n,o)=>this._buildDragEventPipeline(t,e,i,a,n,o)),g.getGraphicEffectiveElevationInfo(n.graphic),n.graphic.geometry.spatialReference,n.graphic),B),this._updateMoveManipulationAngle(n)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=G.createVisualElements({view:this.view,graphic:i,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>n.makeHandle()});null!=a&&(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof I.OutlineVisualElement&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",(()=>{e.state.isDraped||this._updateMoveManipulation(t)})),r.watch((()=>e.state.isDraped),(()=>this._updateMoveManipulation(t)))],B),this.addHandles(a,B))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=m.orientation(t.graphic.geometry))}_updateMoveManipulation(t){const e=v.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,a=!1;const n=this._moveManipulation;if(n){for(const n of t){if(!n.state.displaying)continue;const t=n.state.graphic;this.enableZ&&y.canMoveZ(t)&&(a=!0);const o=n.geometryRepresentation instanceof I.OutlineVisualElement&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:M.getGraphicAttachmentOrigin(this.view,t);if(null!=o){const{x:t,y:a,z:n}=o;e.x+=t,e.y+=a,n&&(e.z??(e.z=0),e.z+=n),i++}}i>0?(e.x/=i,e.y/=i,e.z??(e.z=0),e.z/=i,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(t,e,i,a,n,o){const s=[],r=[];let p=null,l=null;const c=()=>{for(const t of s)t.dragging=!1;s.length=0,r.length=0,p=null,l=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===E.ManipulationType.XY){const e=t[0].graphic;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(e,g.getGraphicEffectiveElevationInfo(e),a,n,o))}return n=n.next((t=>l?.(t))).next((()=>(this.emit("graphic-move-stop",new C(r)),this.destroyed||c(),null))),{steps:a=a.next((e=>{if("start"===e.action){s.length=0,r.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(s.push(e),r.push(e.graphic),e.dragging=!0);if(0!==r.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),p=H.dragGraphicMany(r,this.view.state.viewingMode),l=H.resetGraphicMany(r),this.emit("graphic-move-start",new Z(r)),this.destroyed))return null}return 0!==r.length?e:null})).next((t=>p?.(t))).next((i=>(this._updateMoveTooltip(t,e,i),i))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),a=i.x-e.x,n=i.y-e.y;if(this.emit("graphic-move",new V(a,n,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new C(r)),this.destroyed)return null;c()}return null})),cancel:n}}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:n}=this;if(null==n)return;n.clear();const o=0===t.length?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(e){case E.ManipulationType.XY:n.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new A.TranslateGraphicTooltipInfo({tooltipOptions:a})),this._updateMoveTooltipDistance(n.info,i,((t,e)=>k.autoHorizontalDistanceByElevationModeBetweenPoints(t,e,o)));break;case E.ManipulationType.XY_AXIS:n.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new A.TranslateGraphicXYTooltipInfo({tooltipOptions:a})),this._updateMoveTooltipDistance(n.info,i,((t,e)=>{const a=k.autoHorizontalDistanceByElevationModeBetweenPoints(t,e,o);return s.scale(a,S.axisConstrainedDragSign(i))}));break;case E.ManipulationType.Z:n.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new A.TranslateGraphicZTooltipInfo({tooltipOptions:a})),this._updateMoveTooltipDistance(n.info,i,R.verticalSignedDistanceBetweenPoints)}n.info.tooltipOptions=a}_updateMoveTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:n}=e,o=i(a,n);t.distance=null!=o?o:s.zeroMeters}else t.distance=s.zeroMeters}_buildSnappingPipelineSteps(t,e,i,a,n){const o=t.geometry;if(null==o||"point"!==o.type&&"mesh"!==o.type)return{steps:i,cancel:a};const s=("point"===o.type?o:o.anchor).clone(),r=new X.SnappingContext({elevationInfo:e,pointer:n,editGeometryOperations:z.EditGeometryOperations.fromGeometry(s,this.view.state.viewingMode),visualizer:new f.SnappingVisualizer3D,excludeFeature:t}),p=this.snappingManager,{snappingStep:l,cancelSnapping:c}=P.createSnapDragEventPipelineStep({snappingContext:r,snappingManager:p,updatingHandles:this._updatingHandles});return a=a.next(c),{steps:i=i.next((e=>{s.z=g.getConvertedElevation(this.view,s,g.getGraphicEffectiveElevationInfo(t),{mode:"absolute-height",offset:0});return{...e,snapOrigin:r.coordinateHelper.pointToVector(s)}})).next(...l),cancel:a}}get test(){return{tooltip:this._tooltip}}},e.__decorate([p.property({constructOnly:!0,nonNullable:!0})],t.GraphicMoveTool.prototype,"view",void 0),e.__decorate([p.property()],t.GraphicMoveTool.prototype,"graphics",void 0),e.__decorate([p.property({constructOnly:!0,nonNullable:!0})],t.GraphicMoveTool.prototype,"enableZ",void 0),e.__decorate([p.property({constructOnly:!0,type:U})],t.GraphicMoveTool.prototype,"tooltipOptions",void 0),e.__decorate([p.property({constructOnly:!0})],t.GraphicMoveTool.prototype,"snappingManager",void 0),e.__decorate([p.property()],t.GraphicMoveTool.prototype,"type",void 0),e.__decorate([p.property()],t.GraphicMoveTool.prototype,"updating",null),t.GraphicMoveTool=e.__decorate([u.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],t.GraphicMoveTool);class F{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new O.GraphicState({graphic:t})}get graphic(){return this.state.graphic}}t.GraphicMoveEvent=V,t.GraphicMoveStartEvent=Z,t.GraphicMoveStopEvent=C,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
