/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../Color","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","./config","./Manipulation","./moveUtils","../snapping/SnapToScene","../../../webgl-engine/lib/basicInterfaces","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces"],(function(e,t,a,i,n,s,r,l,o,c,u,p,d,h,_,g,M,m,S,v,f,T,y,w,b){"use strict";class D extends M.Manipulation{constructor(e){super(),this._handles=new a,this._snapToScene=new S.SnapToScene,this._scale=1,this._radius=g.discRadius,this._view=e.view,this._tool=e.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=i.destroyMaybe(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,_.ManipulatorType.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t,a){const i=t.graphic,n=u.getGraphicEffectiveElevationInfo(i),s=i.geometry.spatialReference;return m.createGraphicMoveDragPipeline(i,a,(t=>this.createDragPipeline(((a,i,n,s,r)=>(({steps:i,cancel:n}=e(a,i,n,s,r)),t(a,i,n))),n,s,i)),this._view.state.viewingMode)}createDragPipeline(e,t,a,i){const n=this._view;return w.createManipulatorDragEventPipeline(this._manipulator,((s,r,l,o,c)=>{const u=r.next(w.dragAtLocation(n,s.elevationAlignedLocation)).next(h.screenToMapXYAtLocation(n,s.elevationAlignedLocation,t,a,i)).next(...this._snapToScene.createDragEventPipelineStep(n,t)).next((e=>({...e,manipulatorType:_.ManipulatorType.TRANSLATE_XY}))).next(w.addScreenDelta());e(s,u,l,o,c)}))}_updateManipulatorTransform(){const e=s.fromScaling(c.sm4d.get(),l.set(c.sv3d.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new p.Manipulator3D({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:o.fromValues(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=f.createCylinderGeometry(this._discMaterial,g.discHeight,1,g.geometrySegments,o.fromValues(0,0,1),o.fromValues(0,0,0));e.transformation=s.fromScaling(r.create(),o.fromValues(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new d.RenderObject(e,b.ManipulatorStateFlags.Focused),new d.RenderObject(e.instantiate({material:this._discMaterialTransparent}),b.ManipulatorStateFlags.Unfocused)],this._manipulator.radius=g.discCollisionRadius*(this._radius/g.discRadius)}_createMaterial(e=1){const a=new y.ColorMaterial({cullFace:v.CullFaceOptions.Back,renderOccluded:T.RenderOccludedFlag.Transparent,isDecoration:!0});return this._handles.add(n.watch((()=>t.toUnitRGBA(this._view.effectiveTheme.accentColor)),(t=>{t[3]*=e,a.setParameters({color:t})}),n.initial)),a}get test(){return{discManipulator:this._manipulator}}}e.MoveXYDiscManipulation=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
