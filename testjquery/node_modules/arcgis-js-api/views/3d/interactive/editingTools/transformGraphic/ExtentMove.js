/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/quantityUtils","../../../../../chunks/mat4","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/vectorStacks","../../../analysis/Slice/ShiftManipulator","../../../analysis/Slice/sliceToolUtils","../dragEventPipeline3D","../ManipulatorType","../manipulations/MoveManipulation","../manipulations/MoveXYGraphicManipulation","../../../../interactive/dragEventPipeline","../../../../interactive/editGeometry/interfaces","../../../../interactive/editGeometry/support/editPlaneUtils","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils"],(function(t,e,o,i,a,n,r,s,p,l,c,u,h,m,d,v,M,_){"use strict";class g{constructor(t,e,o,i){this._tool=t,this._graphicState=e,this._editGeometryOperations=o,this._bounds=i,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const a=this._tool,n=a.view;this.moveXYGraphicManipulation=new u.MoveXYGraphicManipulation({view:n,tool:a,graphicState:this._graphicState}),a.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new r.ShiftManipulator(n,r.OffsetMode.CENTER_ON_CALLOUT),this.moveZManipulator.state|=s.IsShiftEdgeOnScreenFlag,a.manipulators.add(this.moveZManipulator),a.addHandles([this._createMoveZDragPipeline()]),a.addHandles([a.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,l.ManipulatorType.TRANSLATE_Z)}updateManipulators(t,e){const a=this.moveZManipulator,r=o.rotateZ(n.sm4d.get(),t,Math.PI);r[12]=0,r[13]=0,r[14]=0,a.modelTransform=r,a.renderLocation=i.subtract(n.sv3d.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool.tooltipOptions;return this._moveXYTooltipInfo??(this._moveXYTooltipInfo=new v.TranslateGraphicTooltipInfo({tooltipOptions:t}))}_computeMoveZTooltipInfo(){const t=this._tool,o=t.tooltipOptions,i=this._moveZTooltipInfo??(this._moveZTooltipInfo=new v.TranslateGraphicZTooltipInfo({tooltipOptions:o}));if(this.moveZManipulator.dragging){const t=this._bounds,e=t.mapBoundsStart.origin,o=t.mapBounds.origin,a=_.verticalSignedDistance(e,o,this._tool.view.spatialReference);if(null==a)return null;i.distance=a}else i.distance=e.createLength(0,t.moveUnit);return i}_updateMoveTooltip(t,e){if(e===c.ManipulationType.XY||e===c.ManipulationType.XY_AXIS){const e=M.autoHorizontalDistanceByElevationModeBetweenPoints(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");null!=e&&null!=this._moveXYTooltipInfo&&(this._moveXYTooltipInfo.distance=e)}return t}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline(((t,e,o)=>this._applyGraphicMoveSteps(e,o,c.ManipulationType.XY)))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return h.createManipulatorDragEventPipeline(this.moveZManipulator,((e,o,i)=>{const n=a.clone(e.renderLocation),r=o.next(p.screenToZConstrained(this._tool.view,n,t)).next(h.addScreenDelta());this._applyGraphicMoveSteps(r,i,c.ManipulationType.Z)}))}_applyGraphicMoveSteps(t,e,o){const i=this._tool,a=i.graphic,n=t.next((t=>("start"===t.action&&(i.inputState={type:"move"},this._bounds.backupMapBounds(),i.emit("graphic-translate-start",{graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(h.addMapDelta()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&i.emit("graphic-translate",e);break;case"end":i.inputState=null,i.emit("graphic-translate-stop",e)}return t})).next((t=>this._updateMoveTooltip(t,o)));return e.next((()=>{null!=i.inputState&&i.emit("graphic-translate-stop",{graphic:a,dxScreen:0,dyScreen:0}),i.cancel()})),n}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(null==t.inputState||"move"!==t.inputState.type)return e;const o=[];for(const t of this._editGeometryOperations.data.components)o.push(...t.vertices);const i="start"===e.action?m.AccumulationBehaviour.NEW_STEP:m.AccumulationBehaviour.ACCUMULATE_STEPS,a=this._editGeometryOperations.moveVertices(o,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);return d.apply(a,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}}t.ExtentMove=g,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
