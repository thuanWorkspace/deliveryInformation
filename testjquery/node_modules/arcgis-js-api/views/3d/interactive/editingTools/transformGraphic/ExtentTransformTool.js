/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Evented","../../../../../core/handleUtils","../../../../../core/reactiveUtils","../../../../../core/unitUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../geometry/support/aaBoundingRect","../../../../../geometry/support/vectorStacks","../../../analysis/Slice/sliceToolUtils","../../Manipulator3D","../../manipulatorUtils","../ManipulatorType","../manipulatorUtils","../visualElementUtils","./ExtentMove","./ExtentRotate","./ExtentScale","./extentUtils","./PreserveAspectRatio","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/editGeometry/support/editPlaneUtils","../../../../interactive/sketch/SketchTooltipOptions","../../../../interactive/tooltip/Tooltip"],(function(t,e,a,i,o,n,s,r,l,p,h,c,d,u,_,g,y,v,m,T,b,M,f,E,x,S,O,R,A,w,G){"use strict";t.ExtentTransformTool=class extends(a.EventedMixin(O.InteractiveToolBase)){constructor(t){super(t),this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.tooltipOptions=new w,this._preserveAspectRatio=new E.PreserveAspectRatio,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:t,graphic:e}=this,a=this._graphicState=new S.GraphicState({graphic:e}),n=e.geometry,s=this._editGeometryOperations=R.EditGeometryOperations.fromGeometry(n,t.state.viewingMode),r=this._bounds=new f.TransformBounds(this,(()=>this._updateManipulators()),s.data);this._extentMove=new T.ExtentMove(this,a,s,r),this._extentScale=new M.ExtentScale(this,a,s,r,(()=>this._preserveAspectRatio.createDragEventPipelineStep())),this._extentRotate=new b.ExtentRotate(this,s,r),this.addHandles([o.watch((()=>this.enableZ),(()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,y.ManipulatorType.TRANSLATE_Z))),o.watch((()=>this.enableScaling),(()=>this._extentScale.forEachManipulator((t=>this._updateManipulatorAvailability(t,y.ManipulatorType.SCALE))))),o.watch((()=>this.enableRotation),(()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,y.ManipulatorType.ROTATE)))]),this._updateAllManipulatorAvailability();const l=m.createVisualElements({view:t,graphic:e,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>i.makeHandle()});if(null!=l){const{visualElement:t}=l;t instanceof x.OutlineVisualElement&&(this._outlineVisualElement=t,this.addHandles(t.events.on("attachment-origin-changed",(()=>this._bounds.updateDisplayBounds())))),this.addHandles(l)}this.addHandles([a.on("changed",(()=>this._onGeometryChanged())),o.watch((()=>a.displaying),(()=>this._updateAllManipulatorAvailability())),o.watch((()=>a.isDraped),(()=>this._graphicDrapedChanged()),o.initial),o.watch((()=>t.pointsOfInterest?.centerOnSurfaceFrequent.location),(()=>r.updateDisplayBounds())),t.trackGraphicState(a)]);const p=t=>{this.addHandles(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this._updateAllManipulatorAvailability()})))};this._forEachManipulator(p);const h=(t,a)=>{this.addHandles(t.events.on("immediate-click",(t=>{a===y.ManipulatorType.TRANSLATE_XY&&this.emit("immediate-click",{...t,graphic:e}),t.stopPropagation()})))};this._forEachManipulator(h),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{view:t}=this,e=this._tooltip=new G.Tooltip({view:t}),a=()=>{e.info=this._getUpdatedTooltipInfo()};this.addHandles([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",(()=>{this._tooltip.clear()})),this.on("graphic-rotate-start",a),this.on("graphic-rotate",a),this.on("graphic-rotate-stop",a),this.on("graphic-scale-start",a),this.on("graphic-scale",a),this.on("graphic-scale-stop",a)]),this._forEachManipulator((t=>{this.addHandles([t.events.on("focus-changed",a),t.events.on("grab-changed",a),t.events.on("drag",(t=>{"cancel"===t.action?this._tooltip.clear():a()}))])}))}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(U),this._bounds.updateDisplayBounds(),this._graphicState.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",(t=>{null!=this._attachmentOrigin&&c.containsXY(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()})),U)}_updateManipulators(){if(!this.visible)return;const t=this._bounds.displayBounds,e=u.calculateBoundedPlaneTranslateRotate(t,d.sm4d.get());this._extentMove.updateManipulators(e,t),this._extentScale.updateManipulators(e,t),this._extentRotate.updateManipulators(e,t)}_updateAllManipulatorAvailability(){this._forEachManipulator(((t,e)=>this._updateManipulatorAvailability(t,e)))}_updateManipulatorAvailability(t,e){const a=this.grabbing&&!t.grabbing;if(t.interactive=!a,t instanceof _.Manipulator3D){const i=this._graphicState.displaying,o=this.enableZ&&v.canMoveZ(this.graphic);switch(e){case y.ManipulatorType.ROTATE:t.available=i&&this.enableRotation;break;case y.ManipulatorType.SCALE:t.available=i&&(this.enableScaling||this.enableRotation||o),t.interactive=!a&&this.enableScaling,t.state=this.enableScaling?u.resizeNormal:u.resizeOutlineOnly;break;case y.ManipulatorType.TRANSLATE_Z:t.available=i&&o;break;default:t.available=i}}}_forEachManipulator(t){this._extentMove.forEachManipulator(t),this._extentScale.forEachManipulator(t),this._extentRotate.forEachManipulator(t)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get moveUnit(){return n.lengthUnitFromSpatialReference(this.view.spatialReference)??"meters"}get attachmentOrigin(){const t=this.graphic.geometry,e=this._graphicState.isDraped?null:this._outlineVisualElement?.attachmentOrigin;return this._attachmentOrigin=e??g.getGraphicAttachmentOrigin(this.view,this.graphic)??t?.extent?.center,this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){const t=this._editGeometryOperations.undo();A.unapply(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}this.inputState=null}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(null!=this.inputState)this.view.activeTool=null;else if(this.canUndo){const t=this._editGeometryOperations.undo();A.unapply(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this._editGeometryOperations.redo();A.apply(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get test(){return{moveZManipulator:this._extentMove.moveZManipulator,resizeManipulators:this._extentScale.resizeManipulators,rotateManipulator:this._extentRotate.rotateManipulator,tooltip:this._tooltip}}},e.__decorate([s.property({constructOnly:!0,nonNullable:!0})],t.ExtentTransformTool.prototype,"view",void 0),e.__decorate([s.property({constructOnly:!0,nonNullable:!0})],t.ExtentTransformTool.prototype,"graphic",void 0),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"enableZ",void 0),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"enableScaling",void 0),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"enableRotation",void 0),e.__decorate([s.property({constructOnly:!0,type:w})],t.ExtentTransformTool.prototype,"tooltipOptions",void 0),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"preserveAspectRatio",null),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"moveUnit",null),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"grabbing",void 0),e.__decorate([s.property()],t.ExtentTransformTool.prototype,"inputState",void 0),e.__decorate([s.property({readOnly:!0})],t.ExtentTransformTool.prototype,"type",void 0),t.ExtentTransformTool=e.__decorate([h.subclass("esri.views.3d.interactive.editingTools.transformGraphic.ExtentTransformTool")],t.ExtentTransformTool);const U="draped-elevation-changes";Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
