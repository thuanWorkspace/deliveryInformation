/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../ViewingMode"],(function(e,t,a){"use strict";function r(e,t){return new m(e,d,t)}function n(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:n}=d;return new m(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:h.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:h.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:n,minPixelSize:h.minPixelSize},t)}function c(e){return Math.abs(e*e*e)}function i(e,t,a){const r=a.parameters;return v.scale=Math.min(r.divisor/(t-r.offset),1),v.factor=c(e),v}function l(e,a){return t.lerp(e*Math.max(a.scale,a.minScaleFactor),e,a.factor)}function s(e,t,a){const r=i(e,t,a);return r.minScaleFactor=0,l(1,r)}function o(e,t,a,r){r.scale=s(e,t,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function u(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}function f(e,t,a,r){return l(e,i(t,a,r))}class m{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,r,n=p(),c){this._viewingMode=e,this._description=t,this._ellipsoidRadius=r,this.parameters=n,this._fontHeight=c,this._viewingMode===a.ViewingMode.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),!0)}overrideFontHeight(e){return e!==this._fontHeight?new m(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:r,scaleFallOffRange:n}=this._description,{fovY:c,distance:i}=e,l=this._calculateCurvatureDependentParameters(e,t),s=this._coverageCompensation(e,t,l),{tiltAngle:o,scaleFallOffFactor:u}=l,f=Math.sin(o)*i,m=.5*Math.PI-o-c*(.5-r*s),d=f/Math.cos(m),h=m+c*n*s,p=(d-u*(f/Math.cos(h)))/(1-u);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=p,a.divisor=d-p,a}_calculateCurvatureDependentParametersLocal(e,t,a=g){return a.tiltAngle=this._description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(e,a,r=g){const n=this._description.curvatureDependent,c=1+e.distance/a,i=Math.sqrt(c*c-1),[l,s]=[n.min.curvature,n.max.curvature],o=t.clamp((i-l)/(s-l),0,1),[u,f]=[n.min,n.max];return r.tiltAngle=t.lerp(u.tiltAngle,f.tiltAngle,o),r.scaleFallOffFactor=t.lerp(u.scaleFallOffFactor,f.scaleFallOffFactor,o),r}_surfaceCoverageCompensationLocal(e,t,a){return(e.fovY-a.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,t,a){const r=t*t,n=a.tiltAngle+.5*Math.PI,{fovY:c,distance:i}=e,l=i*i+r-2*Math.cos(n)*i*t,s=Math.sqrt(l),o=Math.sqrt(l-r);return(Math.acos(o/s)-Math.asin(t/(s/Math.sin(n)))+.5*c)/c}}const d={curvatureDependent:{min:{curvature:t.deg2rad(10),tiltAngle:t.deg2rad(12),scaleFallOffFactor:.5},max:{curvature:t.deg2rad(70),tiltAngle:t.deg2rad(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},h={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function p(){return{camera:{distance:0,fovY:0},divisor:0,offset:0}}const v={scale:0,factor:0,minScaleFactor:0},g={tiltAngle:0,scaleFallOffFactor:0};e.applyPrecomputedScaleFactor=u,e.applyScaleFactor=l,e.getLabelSettings=n,e.getSettings=r,e.precomputeScaleFactor=o,e.scale=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
