/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../core/FBOCache","./TransparencyPassType","../../../webgl/enums","../../../webgl/FramebufferObject"],(function(t,e,r,i,h,s,o){"use strict";class a{constructor(t,e){this._fbos=t,this.compositingHelper=e,this._width=4,this._height=4}dispose(){this._color=r.releaseMaybe(this._color),this.releaseBuffers()}get framebuffer(){return this.color.detachDepth(),this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.colorTexture}get depthTexture(){return this.depth.attachment}initializeFrame(t,e,r){this._fbos.interactive=!r;const i=this._fbos.rctx;this._width=t.fullWidth,this._height=t.fullHeight,o.ensureAttachmentMaxSize(this,i.parameters.maxTextureSize);const h=this._color;return this._color=null,this.releaseBuffers(),this.bindFbo(),i.setClearStencil(0),i.setClearColor(e[0],e[1],e[2],e[3]),i.clearSafe(s.ClearBufferBit.COLOR_BUFFER_BIT|s.ClearBufferBit.DEPTH_BUFFER_BIT|s.ClearBufferBit.STENCIL_BUFFER_BIT),h}releaseBuffers(){this._color?.detachDepth(),this._depth=r.releaseMaybe(this._depth)}renderHUDVisibility(t,e,r){return t?.fbo.width===this._width&&t?.fbo.height===this._height||(t?.release(),t=this._fbos.acquire(i.ColorFormat.RGBA4,this._width,this._height)),t.attachDepth(r||this.depth),this._fbos.rctx.bindFramebuffer(t.fbo),this.renderToFBO(e,c),t.detachDepth(),t}compositeToHUDVisibility(t,e){this._fbos.rctx.bindFramebuffer(t.hudVisibility?.fbo),this.compositingHelper.compositeHUD(t,e)}renderOITPass(t,e,r){let s,o;switch(e){case h.TransparencyPassType.Color:s=this._fbos.acquire(i.ColorFormat.RGBA16F,this._width,this._height),o=[0,0,0,0];break;case h.TransparencyPassType.Alpha:s=this._fbos.acquire(i.ColorFormat.R16F,this._width,this._height),o=[1,1,1,1];break;case h.TransparencyPassType.FrontFace:s=this._fbos.acquire(i.ColorFormat.RGBA,this._width,this._height),o=[0,0,0,0]}return r?(s.acquireDepth(i.DepthFormat.DEPTH16_BUFFER),this._fbos.rctx.bindFramebuffer(s.fbo),this.renderToFBO(t,o,!0,!0),s.releaseDepth()):(s.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(s.fbo),this.renderToFBO(t,o),s.detachDepth()),s}compositeToFramebuffer(t,e,r,i){this.bindFbo(),this.compositingHelper.composite(t,e,r,i)}compositeTransparentOntoOpaque(t,e,r,i,h){h?(this._fbos.rctx.bindFramebuffer(h.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clearSafe(s.ClearBufferBit.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(t,e.colorTexture,r.colorTexture,i.colorTexture)}renderDepthDetached(t){this._bindTarget(this.color),t(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(t,e,h,s=i.ColorFormat.RGBA,o=i.DepthFormat.DEPTH16_BUFFER,a=this._width,c=this._height,f=null){return t?.fbo.width===a&&t?.fbo.height===c||(t=r.releaseMaybe(t)),t=t??this._fbos.acquire(s,a,c),null!=o&&t.acquireDepth(o),f?.forEach((e=>{t.acquireColor(e.format,e.attachment)})),this._fbos.rctx.bindFramebuffer(t.fbo),this.renderToFBO(e,h,!0,!0),t}renderToFBO(t,e,r=!1,i=!1){const h=this._fbos.rctx;let o=0;if(e){const t=1e-13,r=Math.max(t,e[3]);h.setClearColor(e[0],e[1],e[2],r),o|=s.ClearBufferBit.COLOR_BUFFER_BIT}r&&(o|=s.ClearBufferBit.DEPTH_BUFFER_BIT),!1===i?i=0:(!0===i&&(i=255),o|=s.ClearBufferBit.STENCIL_BUFFER_BIT),o&&h.clearSafe(o,i),t(),h.gl.flush()}renderToTargets(t,e,r,i,h=!1,s=!1){this._bindTarget(e,r),this.renderToFBO(t,i,h,s),e.detachDepth()}bindFbo(){this._bindTarget(this.color,this.depth)}_bindTarget(t,e){t.detachDepth(),t.attachDepth(e),this._fbos.rctx.bindFramebuffer(t.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._color||(this._color=this._fbos.acquire(i.ColorFormat.RGBA,this._width,this._height)),this._color}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(i.DepthFormat.DEPTH_STENCIL_TEXTURE,this._width,this._height)),this._depth}}const c=[0,1,0,1];t.OffscreenRendering=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
