/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/floatRGBA","../../../../core/PooledArray","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./depthRange","./Octree","./Util"],(function(e,t,r,n,i,s,a,o,h,c,f,l,u,_){"use strict";const d=1e4,m=100,g=500,p=500,b=.1;function w(e,r,n){return t.unpackFloatRGBA(r,e)*(n[1]-n[0])+n[0]}function R(e,t,r){let n=0;if(!t.some((e=>(n+=e.numGeometries,n>=d))))return P.compute(e,t);const i=l.empty();return r.forAll((t=>l.union(i,v(e,t)))),i}function v(e,t){if(!t.visible)return;const r=l.empty(),n=t.getSpatialQueryAccelerator();return n?C(r,e,n):M(r,e,t.objects),r}function C(e,t,r){const n=t.eye,i=t.viewForward,s=t.frustum,a=e=>e.visible,o=r.objectCount;if(o<g)l.set(S,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(n,i,u.DepthOrder.FRONT_TO_BACK,S,((r,n)=>{A(e,t,r),S.far=e.near,n.setRange(S)}),s,a),l.set(S,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(n,i,u.DepthOrder.BACK_TO_FRONT,S,((r,n)=>{A(e,t,r),S.near=e.far,n.setRange(S)}),s,a);else{const n=Math.max(Math.min(o,p),Math.ceil(o*b)),h=r.findClosest(i,u.DepthOrder.FRONT_TO_BACK,s,a,n),c=r.findClosest(i,u.DepthOrder.BACK_TO_FRONT,s,a,n);h&&c&&(O(e,t,h.boundingVolumeWorldSpace.bounds),O(e,t,c.boundingVolumeWorldSpace.bounds))}}function M(e,t,r){I.clear(),r.forAll((e=>{e.visible&&0!==e.geometries.length&&I.add(e)})),I.empty||(I.sort(t),l.set(S,t.near,Math.min(e.near,t.far)),I.forEachInDepthRange(S,u.DepthOrder.FRONT_TO_BACK,((r,n)=>{n<e.near&&A(e,t,r)})),l.set(S,Math.max(e.far,t.near),t.far),I.forEachInDepthRange(S,u.DepthOrder.BACK_TO_FRONT,((t,r,n)=>{e.far=Math.max(e.far,n)})))}function A(e,t,r){if(!r.visible)return;if(!h.intersectsSphere(t.frustum,r.boundingVolumeWorldSpace.bounds))return;const i=r.transformation,s=j;r.geometries.forEach((r=>{n.multiply(s,i,r.transformation);const a=f.maxScale(s);B(e,t,r.boundingInfo,s,a)}))}function B(e,t,r,n,i){if(null==r)return;s.transformMat4(x,r.center,n);const{eye:a,viewForward:o}=t,c=o[0]*(x[0]-a[0])+o[1]*(x[1]-a[1])+o[2]*(x[2]-a[2]);if(x[3]=r.radius*i,!(c-x[3]>e.near&&c+x[3]<e.far)&&h.intersectsSphere(t.frustum,x))if(r.radius>m&&r.getChildren())for(const s of r.getChildren())B(e,t,s,n,i);else N.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,r.bbMin,r.bbMax)}function O(e,t,r){const n=t.eye,i=t.viewForward,s=(r[0]-n[0])*i[0]+(r[1]-n[1])*i[1]+(r[2]-n[2])*i[2];e.near=Math.min(e.near,s-r[3]),e.far=Math.max(e.far,s+r[3])}class y{constructor(){this._items=new r({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const n=e.object.boundingVolumeWorldSpace.bounds,i=(n[0]-t[0])*r[0]+(n[1]-t[1])*r[1]+(n[2]-t[2])*r[2];e.distance=i,e.near=i-n[3],e.far=i+n[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,r){if(t===u.DepthOrder.FRONT_TO_BACK)for(let n=0;n<this._items.length;++n){const t=this._items.data[n];t.far<e.near||t.near>e.far||r(t.object,t.near,t.far)}else for(let n=this._items.length-1;n>=0;--n){const t=this._items.data[n];t.far<e.near||t.near>e.far||r(t.object,t.near,t.far)}}}class T{constructor(){this._view=i.create(),this._viewProj=i.create(),this._frustum=h.create(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),n.copy(this._view,e.viewMatrix),n.multiply(this._viewProj,e.projectionMatrix,this._view),h.copy(this._frustum,e.frustum);const r=this._view,i=r[2],s=r[6],a=r[10],o=r[14];t.forAll((e=>e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,r=i*t[0]+s*t[1]+a*t[2]+o,n=r-t[3],h=r+t[3];this._geometries.push(e),this._near.push(-h),this._far.push(-n)}))));const c=new l.DepthRange;if(0===this._geometries.length)return c;for(let n=0;n<this._geometries.length;++n)this._near[n]>c.far&&(c.far=this._near[n]),this._near[n]>2&&this._far[n]<c.near&&(c.near=this._far[n]);const f=this._looseRange;f.near=Math.max(.5*c.near,2),f.far=2*c.far;let u=0,_=0;for(let n=0;n<this._geometries.length;++n)this._near[n]<c.near&&(this._near[n]>=f.near?c.near=this._near[n]:this._nearCandidates[u++]=n),this._far[n]>c.far&&(this._far[n]<=f.far?c.far=this._far[n]:this._farCandidates[_++]=n);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return c;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let n=0;n<this._nearCandidates.length;++n){const e=this._nearCandidates[n];if(this._near[e]<c.near){const t=this._geometries[e],r=t.boundingInfo;this._includeNearBoundingInfoRec(r,t.shaderTransformation,c)}}for(let n=0;n<this._farCandidates.length;++n){const e=this._farCandidates[n];if(this._far[e]>c.far){const t=this._geometries[e],r=t.boundingInfo;this._includeFarBoundingInfoRec(r,t.shaderTransformation,c)}}return this._reset(),c}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,r){if(null==e)return;const n=e.center;s.transformMat4(x,n,t);const i=f.maxScale(t),a=x[0],o=x[1],h=x[2],c=e.radius*i,l=this._frustum;if(l[0][0]*a+l[0][1]*o+l[0][2]*h+l[0][3]>c||l[1][0]*a+l[1][1]*o+l[1][2]*h+l[1][3]>c||l[2][0]*a+l[2][1]*o+l[2][2]*h+l[2][3]>c||l[3][0]*a+l[3][1]*o+l[3][2]*h+l[3][3]>c)return;const u=this._view[2]*a+this._view[6]*o+this._view[10]*h+this._view[14],_=u+c;if(!(-(u-c)<2||-_>=r.near))if(-_>this._looseRange.near)r.near=-_;else{if(c>m){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeNearBoundingInfoRec(e,t,r);return}}N.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,r){if(null==e)return;let n=e.radius;const i=e.center;s.transformMat4(x,i,t);const a=f.maxScale(t),o=x[0],h=x[1],c=x[2];n*=a;const l=this._frustum;if(l[0][0]*o+l[0][1]*h+l[0][2]*c+l[0][3]>n||l[1][0]*o+l[1][1]*h+l[1][2]*c+l[1][3]>n||l[2][0]*o+l[2][1]*h+l[2][2]*c+l[2][3]>n||l[3][0]*o+l[3][1]*h+l[3][2]*c+l[3][3]>n)return;const u=this._view[2]*o+this._view[6]*h+this._view[10]*c+this._view[14]-n;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(n>m){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeFarBoundingInfoRec(e,t,r);return}}N.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}}class D{constructor(){this._modelViewProj=i.create(),this._clipPosition=[o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create()]}unionDepthRangeWithAABB(e,t,r,i,s){const a=this._modelViewProj;n.multiply(a,t,r);let o=!1;for(let n=0;n<8;++n){const e=this._clipPosition[n],t=0===n||3===n||4===n||7===n?i[0]:s[0],r=0===n||1===n||4===n||5===n?i[1]:s[1],o=n<4?i[2]:s[2];e[0]=a[0]*t+a[4]*r+a[8]*o+a[12],e[1]=a[1]*t+a[5]*r+a[9]*o+a[13],e[2]=a[2]*t+a[6]*r+a[10]*o+a[14],e[3]=a[3]*t+a[7]*r+a[11]*o+a[15]}for(let n=0;n<12;++n){const t=this._clipPosition[F[n][0]],r=this._clipPosition[F[n][1]],i=this._clipPosition[F[n][2]],s=this._clipTriangle(t,r,i);let a=!0;for(let e=0;e<s.length;++e){if(s[e][3]>=2){a=!1;break}}if(!a){o=!0;for(let t=0;t<s.length;++t){const r=s[t][3];Number.isFinite(r)&&(e.near=Math.min(r,e.near),e.far=Math.max(r,e.far))}}}return o}_inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void _.assert(!1)}_intersect(e,t,r){let n=0;return 0===r?n=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?n=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?n=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(n=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),a.lerp(o.create(),e,t,n)}_clipTriangle(e,t,r){let n=[e,t,r];for(let i=0;i<4;++i){const e=n;n=[];for(let t=0;t<e.length;++t){const r=e[t],s=e[(t+1)%e.length];this._inside(s,i)?(this._inside(r,i)||n.push(this._intersect(r,s,i)),n.push(s)):this._inside(r,i)&&n.push(this._intersect(r,s,i))}}return n}}const F=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],x=c.create(),j=i.create(),S=l.empty(),I=new y,P=new T,N=new D;e.DepthRangeFromRenderGeometries=T,e.depthRangeFromLayer=v,e.depthRangeFromScene=R,e.textureToDepth=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
