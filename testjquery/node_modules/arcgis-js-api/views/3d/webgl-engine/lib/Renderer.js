/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/colorUtils","../../../../core/has","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../chunks/boundedPlane","../../support/debugFlags","../../terrain/TerrainRenderer","../core/FBOCache","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDRenderStyle","../effects/RenderPluginInput","../effects/RenderPluginManager","../effects/blit/Blit","../effects/highlight/Highlight","../effects/highlight/ShadowHighlight","../effects/smaa/SMAA","../effects/ssao/SSAO","./AnimationTimeStep","./basicInterfaces","./BoundingInfo","./depthRange","./depthRangeUtils","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderFeature","./RenderSlot","./ShadowAccumulator","./ShadowMap","./SliceHelper","./TransparencyPassType","./edgeRendering/EdgeView","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../shaders/CompositingTechniqueConfiguration","../statistics/RendererPerformanceInfo","../../../support/RenderState","../../../webgl/enums"],(function(e,r,t,s,a,n,i,d,h,o,l,_,u,c,p,m,R,g,f,T,S,P,A,E,y,b,I,C,O,D,w,M,F,L,N,H,x,v,U,B,G,q,V,Q,W,k,j,Y,X,z,J,K){"use strict";var Z,$;e.Renderer=class extends t{get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,r=!n("disable-feature:high-quality-idle")){this._renderStateFeatures=B.setupFeatureDefaults(r,e),this.notifyChange("_renderStateFeatures"),this._renderPlugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,r=this._state){return this._renderStateFeatures.get(r,e)??!1}setFeatureEnabled(e,r,t){this._renderStateFeatures.set(r,e,t),this.notifyChange("_renderStateFeatures"),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(B.RenderFeature.HighQualityTransparency)}get hasReflections(){return this.hasWater&&(this._ssrEnabled||this.isFeatureEnabled(B.RenderFeature.WaterReflection))}get hasDecorations(){return this._materialRenderersHas.decorations||this._renderPlugins.hasDecorations}get hasHighlights(){return this._materialRenderersHas.highlights||this._renderPlugins.produces(G.RenderSlot.OPAQUE_MATERIAL,P.ShaderOutput.Highlight)||this._renderPlugins.produces(G.RenderSlot.DRAPED_MATERIAL,P.ShaderOutput.Highlight)}get hasShadowHighlights(){return this._materialRenderersHas.highlights||this._renderPlugins.produces(G.RenderSlot.OPAQUE_MATERIAL,P.ShaderOutput.ShadowHighlight)}get _magnifierEnabled(){return this._bindParameters.decorations===M.Decorations.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(B.RenderFeature.HighResolutionAtmosphere)}get hasWater(){return this._materialRenderersHas.water||this._hasOverlayWater}constructor(e,r,t,s,i,o,l,_){super({}),this._stage=e,this._techniqueRepository=s,this._rctx=i,this._compositingHelper=o,this._magnifierHelper=l,this._requestRender=_,this._materialRenderers=new d,this._needsTransparentPass=!1,this._materialRenderersHas={hudElements:!1,highlights:!1,water:!1,decorations:!1,occludees:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._backgroundColor=m.fromValues(0,0,0,1),this._sliceHelper=new Q,this._state=J.RenderState.IDLE,this._highQualityTransparencyEnabled=!0,this._terrainTransparency=f.TransparencyMode.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new w.AnimationTimeStep,this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new E.RenderPluginInput,this._releaseGeometryLinearDepth=e=>e?.release(),this._geometryLinearDepthFormat=T.DepthFormat.DEPTH16_BUFFER,this.fboCache=new T.FBOCache(i),this._renderStateFeatures=B.setupFeatureDefaults(!n("disable-feature:high-quality-idle"),e.view.qualityProfile),this._offscreen=new x.OffscreenRendering(this.fboCache,this._compositingHelper),this.performanceInfo=new z.RendererPerformanceInfo(this._rctx),this._shadowMap=new V.ShadowMap(this.fboCache,e.viewingMode),this._highlight=new I.Highlight({view:e.view}),this._shadowHighlight=new C.ShadowHighlight({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new q.ShadowAccumulator(this.fboCache,s,e,(e=>{const r=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(e.camera,e.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=r}),((e,r,t)=>{e.shadowMap.start(e.camera,r,t,!0,this._stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(P.ShaderOutput.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._prepare(e.camera,e.contentCamera)}),_),this._ssao=new D.SSAO({view:this._stage.view}),this._renderContext=new v.RenderContext(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._renderPlugins=new y.RenderPluginManager({renderContext:this._renderContext,techniqueRepository:s,textureRepository:t,materialRepository:r,requestRender:_,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new S.RenderPassManager,this._renderPlugins.add(this.renderPassManager),this._smaa=new O.SMAA({view:this._stage.view}),this._renderPlugins.add(this._smaa),this._blit=new b.Blit({opacity:1,alphaMode:X.AlphaMode.None}),this._renderPlugins.add(this._blit),this._renderPlugins.add(this._ssao),this._renderPlugins.add(this._highlight),this._renderPlugins.add(this._shadowHighlight),this.addHandles([h.watch((()=>this._stage.view.state.camera),(()=>_()),h.syncAndInitial),h.watch((()=>g.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(j.Transparency.TRANSPARENT):()=>{},_()}),h.initial),h.watch((()=>this._stage.view.environment.background?.color),(e=>{const r=e?a.unitRGBAFromColor(e):m.ZEROS;p.set(this._backgroundColor,r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),_()}),h.syncAndInitial)])}normalizeCtorArgs(){return{}}destroy(){this._smaa.destroy(),this._blit.destroy(),this._gpuTimerHandle=i.removeMaybe(this._gpuTimerHandle),this._materialRenderers.forAll((e=>e.dispose())),this._materialRenderers.clear(),this._offscreen.dispose(),this._shadowMap.dispose(),this._ssao.destroy(),this._highlight.dispose(),this._shadowHighlight.destroy(),this._shadowAccumulator.dispose(),this._edgeView=i.destroyMaybe(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),F.BoundingInfo.prune()}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=i.releaseMaybe(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=i.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=i.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=i.releaseMaybe(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=i.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._renderPlugins.updating||!this.isCameraFinal}ensureEdgeView(){if(null==this._edgeView){const e=this._stage.view.resourceController;this._edgeView=new k.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:ne(e)}),this.addHandles(h.watch((()=>this._edgeView?.updating),(()=>this._requestRender()),h.sync)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return u.equals(this._bindParameters.ssr.reprojectionMatrix,c.IDENTITY)}set _reprojectionMatrix(e){s.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:r,_bindParameters:t}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const r="virtual"!==e.environment.lighting.type;t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,r){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:s,updates:a}=e;if(0===t.length&&0===s.length&&0===a.length)return;const n=U.splitRenderGeometryChangeSetByMaterial(e);let i=!1;n.forEach(((t,s)=>{if(r.done)return;let a=this._materialRenderers.find((e=>e.material===s));if(null==a&&t.adds.length>0){const e=new Y.MergedRenderer({material:s});e.initializeRenderContext(this._renderPlugins._context),a=e,this._materialRenderers.push(a)}a&&(a.modify(t),a.isEmpty&&(i=!0)),t.removes.forEach((r=>e.removes.removeUnordered(r))),t.adds.forEach((r=>e.adds.removeUnordered(r))),t.updates.forEach((r=>e.updates.removeUnordered(r))),r.madeProgress()})),i&&this._materialRenderers.filterInPlace((e=>!e.isEmpty||(e.dispose(),!1))),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._materialRenderersHas;e.decorations=!1,e.highlights=!1,e.hudElements=!1,e.water=!1,e.occludees=!1,this._materialRenderers.forAll((r=>{e.highlights||(e.highlights=r.hasHighlights),e.occludees||(e.occludees=r.hasOccludees),e.water||(e.water=r.hasWater),e.decorations||(e.decorations=r.isDecoration),e.hudElements||(e.hudElements=r.material.produces(G.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,P.ShaderOutput.Color)||r.material.produces(G.RenderSlot.HUD_MATERIAL,P.ShaderOutput.Color)||r.material.produces(G.RenderSlot.LABEL_MATERIAL,P.ShaderOutput.Color))})),this._bindParameters.hasOccludees=e.occludees}updateAnimation(e){const r=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll((r=>this._hasAnimations=r.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?i.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,r,t,s,a){const n=null!=e;this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frame(),this._disposeBindBuffers();const d=this._offscreen,{camera:h,contentCamera:o,mode:l,alignPixelEnabled:_}=t;this._state=l,this._bindParameters.overlay=this.renderOverlay(a),this.performanceInfo.advance(z.PerformanceCategory.OVERLAY),this._renderContext.time=a,this._bindParameters.transparencyPassType=W.TransparencyPassType.NONE,this._bindParameters.alignPixelEnabled=_,this._bindParameters.decorations=s;const u=R.create(this._sliceHelper.plane);s===M.Decorations.OFF&&(this._sliceHelper.plane=null),h.setGLViewport(this._rctx);const c=d.initializeFrame(h,this._backgroundColor,n);this.hasReflections?this._bindParameters.ssr.lastFrameColor=c:c?.release(),this._prepare(h,o),this._renderPlugins.prepareRender(),this.performanceInfo.advance(z.PerformanceCategory.PREPARE);const p=this._computeDepthRange(h);this._renderShadowMap(h,this._bindParameters.lighting.mainLight.direction,p),this.performanceInfo.advance(z.PerformanceCategory.SHADOW_MAP),this._ensureBindParameters(h,o);const m=this._renderPlugins.produces(G.RenderSlot.OPAQUE_TERRAIN)&&(this._terrainTransparency===f.TransparencyMode.Semitransparent||this._terrainTransparency===f.TransparencyMode.TransparentWithDraped),g=this._highQualityTransparency&&m,S=this._needsTransparentPass||this._renderPlugins.produces(G.RenderSlot.TRANSPARENT_MATERIAL);this._prepareShaders(g,S),this._renderLinearDepth(),this.performanceInfo.advance(z.PerformanceCategory.LINEAR_DEPTH),this._renderShadowAccumulation(p,h,o),this.performanceInfo.advance(z.PerformanceCategory.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(a),this._renderSSAO(),this.performanceInfo.advance(z.PerformanceCategory.SSAO),this._renderContext.output=P.ShaderOutput.Color,d.bindFbo(),this._renderOpaqueGeometry(),this._renderPlugins.render(G.RenderSlot.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(z.PerformanceCategory.OPAQUE),this._renderTerrainLinearDepth(g),this._setMultipassTerrain(g),this._renderEdges(j.Transparency.OPAQUE),this.performanceInfo.advance(z.PerformanceCategory.OPAQUE_EDGES),d.bindFbo(),this._renderPlugins.render(G.RenderSlot.VOXEL),this.performanceInfo.advance(z.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),S&&(this._oitEnabled?this._renderOITPass(Z.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(z.PerformanceCategory.TRANSPARENT);const E=this._renderGeometryLinearDepth(g);this._renderHUDVisibility(E),g||this._renderInternalSlot(G.RenderSlot.LINE_CALLOUTS),this.performanceInfo.advance(z.PerformanceCategory.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(r),this.performanceInfo.advance(z.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(j.Transparency.TRANSPARENT,E),this._releaseGeometryLinearDepth(E),this.performanceInfo.advance(z.PerformanceCategory.TRANSPARENT_EDGES);const y=m?this._renderTransparentTerrain():null;y&&this._bindParameters.hudVisibility&&(g?this._renderLineCallouts(A.HUDRenderStyle.Occluded):d.compositeToHUDVisibility(this._bindParameters,y.colorTexture),this._renderHUD(A.HUDRenderStyle.Occluded,d.color),this.performanceInfo.advance(z.PerformanceCategory.HUD_OCCLUDED)),this.performanceInfo.advance(z.PerformanceCategory.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),y&&(d.compositeToFramebuffer(this._bindParameters,y.colorTexture,X.AlphaMode.PremultipliedAlpha,1),y.release(),g&&(this._renderEdges(j.Transparency.OPAQUE),this.performanceInfo.advance(z.PerformanceCategory.OPAQUE_EDGES),S&&(this._oitEnabled?this._renderOITPass(Z.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(z.PerformanceCategory.TRANSPARENT),this._renderEdges(j.Transparency.TRANSPARENT),this.performanceInfo.advance(z.PerformanceCategory.TRANSPARENT_EDGES))),this._bindParameters.ssao=i.releaseMaybe(this._bindParameters.ssao),g&&this._renderLineCallouts(A.HUDRenderStyle.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),d.bindFbo(),this._renderInternalSlot(G.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderPlugins.render(G.RenderSlot.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(z.PerformanceCategory.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(z.PerformanceCategory.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(z.PerformanceCategory.OCCLUDED);const b=this._magnifierEnabled&&null==e?this.fboCache.acquire(T.ColorFormat.RGBA,this._offscreen.width,this._offscreen.height):null,I=this._renderComposite(b??e,this._offscreen.color)??e;this.performanceInfo.advance(z.PerformanceCategory.ANTIALIASING),this._renderHUD(A.HUDRenderStyle.NotOccluded,I),this.performanceInfo.advance(z.PerformanceCategory.HUD),this._renderHighlights(I,this._bindParameters),this.performanceInfo.advance(z.PerformanceCategory.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),I!==e&&(this._rctx.bindFramebuffer(e?.fbo),this._compositingHelper.composite(this._bindParameters,b?.colorTexture,X.AlphaMode.None)),b!==e&&b?.release(),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=u,this._isRendering=!1,this.performanceInfo.finishFrame(),n&&(this._releaseFBOs(),this._disposeOffscreenBuffers())}_prepareShaders(e,r){this._renderContext.output=P.ShaderOutput.Color,this._prepareOpaqueGeometrySlots(),this._setMultipassTerrain(e),this._renderPlugins.prepare(G.RenderSlot.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.LINE_CALLOUTS),r&&this._prepareTransparencySlots(),this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderPlugins.prepare(G.RenderSlot.ENVIRONMENT_TRANSPARENT),this._renderPlugins.prepare(G.RenderSlot.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(e){if(null==e||!n("enable-feature:objectAndLayerId-rendering"))return;const r=this._renderContext.output;this._rctx.bindFramebuffer(e.fbo),this._offscreen.renderToFBO((()=>this._renderAllGeometry(P.ShaderOutput.ObjectAndLayerIdColor)),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e.fbo),this._offscreen.renderToFBO((()=>{this._bindParameters.hudRenderStyle=A.HUDRenderStyle.NotOccluded,this._renderInternalSlot(G.RenderSlot.HUD_MATERIAL)}),void 0,!0,!0),this._renderContext.output=r}finish(e){this._hasAnimations||this._animationTimestep.clear();const r=this.performanceInfo.gpuSamplingEnabled,t=e===M.RenderRequestType.BACKGROUND;if(t||r){const e=t?this.performanceInfo.elapsedTime:0,s=r?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),a=Math.max(e,s);this._animationTimestep.frame(a,t)}}readDepthPixels(e,r,t){const s=this._bindParameters.linearDepth?.fbo;if(s?.colorTexture)return void s.readPixels(r[0],r[1],r[2],r[3],K.PixelFormat.RGBA,K.PixelType.UNSIGNED_BYTE,t);const a=this.fboCache.acquire(T.ColorFormat.RGBA,this._offscreen.width,this._offscreen.height).acquireDepth(T.DepthFormat.DEPTH16_BUFFER);this._rctx.bindFramebuffer(a.fbo),this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const n=K.ClearBufferBit.COLOR_BUFFER_BIT|K.ClearBufferBit.DEPTH_BUFFER_BIT|K.ClearBufferBit.STENCIL_BUFFER_BIT;this._rctx.clearSafe(n),this._renderAllGeometry(P.ShaderOutput.Depth),a.fbo.readPixels(r[0],r[1],r[2],r[3],K.PixelFormat.RGBA,K.PixelType.UNSIGNED_BYTE,t),a.release()}readHUDVisibility(e,r,t,s,a){this._bindParameters.hudVisibility?.fbo.readPixels(e,r,t,s,K.PixelFormat.RGBA,K.PixelType.UNSIGNED_BYTE,a)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,r){const t=this._edgeView;if(t?.shouldRender()){const{width:s,height:a,depth:n}=this._offscreen,i=this.fboCache.acquire(T.ColorFormat.RGBA,s,a),d=()=>t.render(this._bindParameters,e);this._offscreen.renderToTargets(d,i,r??n,ee),this._offscreen.compositeToFramebuffer(this._bindParameters,i.colorTexture,X.AlphaMode.Alpha,1),i.release()}}_renderShadowMap(e,r,t){const s=this._shadowMap;s.enabled&&(s.start(e,r,t,this.isFeatureEnabled(B.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(P.ShaderOutput.ShadowHighlight,this._shadowMap),s.moveSnapshot(V.SnapshotSlot.Highlight),s.clear(),this._renderShadowCascades(P.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(V.SnapshotSlot.Default),this._renderShadowCascades(P.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(P.ShaderOutput.Shadow),s.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e,r=this._shadowMap){for(const t of r.cascades)t.camera.setGLViewport(this._rctx),this._prepare(t.camera,t.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._renderPlugins.consumes(P.ShaderOutput.Depth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,(()=>this._renderAllGeometry(P.ShaderOutput.Depth)),[0,0,0,0],T.ColorFormat.RGBA,T.DepthFormat.DEPTH_STENCIL_BUFFER),this._bindParameters.linearDepth.releaseDepth(),this._offscreen.bindFbo()):this._bindParameters.linearDepth=i.releaseMaybe(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=P.ShaderOutput.Depth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,(()=>this._renderTransparentTerrain()),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.releaseDepth(),this._renderContext.output=e}else this._bindParameters.multipassTerrain.linearDepth=i.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=i.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth));const r=this._renderContext.output;return this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,(()=>this._renderOpaqueGeometryAndTransparentMaterial(P.ShaderOutput.Depth)),[1,1,1,1],T.ColorFormat.RGBA,this._geometryLinearDepthFormat),this._renderContext.output=r,this._bindParameters.multipassGeometry.linearDepth.detachDepth()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return L.zero;const r=N.depthRangeFromScene(e,this._materialRenderers,this._stage.layers);return L.union(r,this._renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}_renderAllGeometry(e){this._renderContext.output=e,this._renderPlugins.prepare(G.RenderSlot.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._renderPlugins.prepare(G.RenderSlot.TRANSPARENT_MATERIAL),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderSSAO(){if(!this._renderPlugins.produces(G.RenderSlot.SSAO))return;const e=this._offscreen.renderToCachedFBO(null,(()=>this._renderAllGeometry(P.ShaderOutput.Normal)),[0,0,0,0],T.ColorFormat.RGBA4,T.DepthFormat.DEPTH24_BUFFER);e.releaseDepth(),this._offscreen.bindFbo(),this._pluginInput.normal=e,this._bindParameters.ssao=this._renderPlugins.render(G.RenderSlot.SSAO,this._pluginInput),e.release()}_prepareOpaqueGeometrySlots(){this._renderPlugins.prepare(G.RenderSlot.INTEGRATED_MESH),this._renderPlugins.prepare(G.RenderSlot.OPAQUE_TERRAIN),this._renderPlugins.prepare(G.RenderSlot.OPAQUE_MATERIAL),this._renderPlugins.prepare(G.RenderSlot.ENVIRONMENT_OPAQUE),this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.OPAQUE_MATERIAL)}_renderOpaqueGeometry(){this._renderPlugins.render(G.RenderSlot.INTEGRATED_MESH),this._renderPlugins.render(G.RenderSlot.OPAQUE_TERRAIN),this._renderInternalSlot(G.RenderSlot.OPAQUE_MATERIAL),this._renderPlugins.render(G.RenderSlot.OPAQUE_MATERIAL)}_renderTransparentMaterial(){this._renderInternalSlot(G.RenderSlot.TRANSPARENT_MATERIAL),this._renderPlugins.render(G.RenderSlot.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){if(!this._renderPlugins.produces(G.RenderSlot.TRANSPARENT_TERRAIN))return;const e=()=>this._renderPlugins.render(G.RenderSlot.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==P.ShaderOutput.Color)return void e();const{width:r,height:t,depth:s}=this._offscreen,a=this.fboCache.acquire(T.ColorFormat.RGBA,r,t);return this._offscreen.renderToTargets(e,a,s,[0,0,0,0]),a}_renderHUDVisibility(e){this._shouldRenderInternalSlot(this._materialRenderers,G.RenderSlot.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._renderInternalSlot(G.RenderSlot.OCCLUSION_PIXELS)),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=i.releaseMaybe(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===A.HUDRenderStyle.Occluded){const e=()=>this._renderInternalSlot(G.RenderSlot.LINE_CALLOUTS),{width:r,height:t,color:s}=this._offscreen,a=this.fboCache.acquireDepth(T.DepthFormat.DEPTH16_BUFFER,r,t);this._offscreen.renderToTargets(e,s,a,void 0,!0,!0),a.release()}else this._renderInternalSlot(G.RenderSlot.LINE_CALLOUTS)}_renderLaserlines(){if(this._renderPlugins.render(G.RenderSlot.LASERLINES),this._renderPlugins.produces(G.RenderSlot.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:r,height:t,depth:s}=e,a=this.fboCache.acquire(T.ColorFormat.RGBA,r,t),n=()=>this._renderPlugins.render(G.RenderSlot.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(n,a,s,ee),e.compositeToFramebuffer(this._bindParameters,a.colorTexture,X.AlphaMode.PremultipliedAlpha,1),a.release()}}_renderHUD(e,r){if(this._materialRenderersHas.hudElements)if(this._oitEnabled){const t=this._renderOITPass(Z.HUD,e);this._rctx.bindFramebuffer(r?.fbo),this._compositingHelper.composite(this._bindParameters,t.colorTexture,X.AlphaMode.PremultipliedAlpha),t.release()}else if(e===A.HUDRenderStyle.Occluded){const r=()=>this._renderHUDElements(e),{width:t,height:s,color:a}=this._offscreen,n=this.fboCache.acquireDepth(T.DepthFormat.DEPTH16_BUFFER,t,s);this._offscreen.renderToTargets(r,a,n,void 0,!0,!0),n.release()}else this._rctx.bindFramebuffer(null),r?.acquireDepth(T.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(r?.fbo),this._renderHUDElements(e),r?.releaseDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,G.RenderSlot.HUD_MATERIAL,G.RenderSlot.LABEL_MATERIAL),this._renderInternalSlot(G.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(G.RenderSlot.HUD_MATERIAL),this._renderInternalSlot(G.RenderSlot.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._renderPlugins.produces(G.RenderSlot.SHADOW_HIGHLIGHT)&&this.hasShadowHighlights}_renderHighlights(e,r){if(!this.hasHighlights||r.decorations===M.Decorations.OFF)return;const t=()=>{this._renderAllGeometry(P.ShaderOutput.Highlight),this._rctx.clearSafe(K.ClearBufferBit.DEPTH_BUFFER_BIT),this._renderHUDElements(A.HUDRenderStyle.Both)},s=this._offscreen.renderToCachedFBO(null,t,[0,0,0,0],T.ColorFormat.RGBA4,T.DepthFormat.DEPTH_STENCIL_BUFFER);s.releaseDepth(),this._needsShadowHighlight&&(this._pluginInput.highlight=s,this._renderPlugins.render(G.RenderSlot.SHADOW_HIGHLIGHT,this._pluginInput,e)),this._renderPlugins.produces(G.RenderSlot.HIGHLIGHT)&&(this._pluginInput.composite=null,this._pluginInput.normal=null,this._pluginInput.highlight=s,this._renderPlugins.render(G.RenderSlot.HIGHLIGHT,this._pluginInput,e)),s.release()}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,r,t){this._needsShadowCast&&this._bindParameters.linearDepth?.colorTexture&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,r,t)}_prepareTransparencySlots(){this._renderContext.output=P.ShaderOutput.Alpha,this._bindParameters.transparencyPassType=W.TransparencyPassType.Alpha,this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.TRANSPARENT_MATERIAL),this._renderPlugins.prepare(G.RenderSlot.TRANSPARENT_MATERIAL),this._renderContext.output=P.ShaderOutput.Color,this._bindParameters.transparencyPassType=W.TransparencyPassType.Color,this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.TRANSPARENT_MATERIAL),this._renderPlugins.prepare(G.RenderSlot.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=W.TransparencyPassType.FrontFace,this._prepareInternalSlots(this._materialRenderers,G.RenderSlot.TRANSPARENT_MATERIAL),this._renderPlugins.prepare(G.RenderSlot.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=W.TransparencyPassType.NONE}_renderOITPass(e,r=A.HUDRenderStyle.Both){const t=e===Z.HUD,s=t?this.fboCache.acquire(T.ColorFormat.RGBA,this._offscreen.width,this._offscreen.height):null,a=t?()=>this._renderHUDElements(r):()=>this._renderTransparentMaterial(),n=this._renderContext.output;this._renderContext.output=P.ShaderOutput.Alpha,this._bindParameters.transparencyPassType=W.TransparencyPassType.Alpha;const i=this._offscreen.renderOITPass(a,W.TransparencyPassType.Alpha,t);this._renderContext.output=P.ShaderOutput.Color,this._bindParameters.transparencyPassType=W.TransparencyPassType.Color;const d=this._offscreen.renderOITPass(a,W.TransparencyPassType.Color,t);this._bindParameters.transparencyPassType=W.TransparencyPassType.FrontFace;const h=this._offscreen.renderOITPass(a,W.TransparencyPassType.FrontFace,t);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,d,i,h,s),s?.releaseDepth(),h.release(),d.release(),i.release(),this._bindParameters.transparencyPassType=W.TransparencyPassType.NONE,this._renderContext.output=n,s}_renderOccluded(){let e=0;re.clear(),this._materialRenderers.forAll((r=>{r.material&&r.material.isVisible()&&r.material.parameters.renderOccluded===H.RenderOccludedFlag.OccludeAndTransparentStencil&&(e|=r.material.parameters.renderOccluded,re.push(r))}));const r=this._offscreen,t=(t,s,a,n,i)=>{if(0==(e&s))return;const{width:d,height:h,depth:o}=r,l=this.fboCache.acquire(T.ColorFormat.RGBA,d,h);r.renderToTargets(a,l,o,[0,0,0,0],n,i),r.compositeToFramebuffer(this._bindParameters,l.colorTexture,X.AlphaMode.PremultipliedAlpha,t),l.release()};0!==re.length&&(this._prepareInternalSlots(re,G.RenderSlot.OCCLUDER_MATERIAL,G.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),this._renderInternalSlot(G.RenderSlot.OCCLUDER_MATERIAL,re),t(.5,H.RenderOccludedFlag.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(G.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,re)),!1,!1)),re.clear(),this._materialRenderers.forAll((r=>{r.material&&r.material.isVisible()&&(r.material.parameters.renderOccluded===H.RenderOccludedFlag.OccludeAndTransparent||r.material.parameters.renderOccluded===H.RenderOccludedFlag.Transparent||r.material.parameters.renderOccluded===H.RenderOccludedFlag.Opaque)&&(e|=r.material.parameters.renderOccluded,re.push(r))}));const s=this._renderPlugins.renderOccludedFlags;if(e|=s,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,this._prepareInternalSlots(re,G.RenderSlot.OPAQUE_MATERIAL,G.RenderSlot.TRANSPARENT_MATERIAL,G.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),s>H.RenderOccludedFlag.Occlude&&this._renderPlugins.render(G.RenderSlot.OCCLUDED_TERRAIN),this._renderInternalSlot(G.RenderSlot.OPAQUE_MATERIAL,re),this._renderInternalSlot(G.RenderSlot.TRANSPARENT_MATERIAL,re),this._renderInternalSlot(G.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,re),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=P.ShaderOutput.Color,t(.5,H.RenderOccludedFlag.OccludeAndTransparent,(()=>a(H.RenderOccludedFlag.OccludeAndTransparent)),!0,M.StencilBits.OutlineVisualElementMask),t(.5,H.RenderOccludedFlag.Transparent,(()=>a(H.RenderOccludedFlag.Transparent)),!0,M.StencilBits.OutlineVisualElementMask),t(1,H.RenderOccludedFlag.Opaque,(()=>a(H.RenderOccludedFlag.Opaque)),!0,M.StencilBits.OutlineVisualElementMask),re.clear()}_renderComposite(e,r){this._renderPlugins.consumes(P.ShaderOutput.CompositeColor)&&(this._pluginInput.composite=r);let t=null;const s=this._renderPlugins.produces(G.RenderSlot.COMPOSITE);s&&(t=this._renderPlugins.renderComposition(G.RenderSlot.COMPOSITE,this._pluginInput),this._pluginInput.composite=t);const a=this._renderPlugins.produces(G.RenderSlot.ANTIALIASING),n=this._renderPlugins.render(a?G.RenderSlot.ANTIALIASING:G.RenderSlot.BLIT,this._pluginInput,e);return s&&t?.release(),n}_prepare(e,r){this._needsTransparentPass=this._materialRenderers.some((e=>e.material.produces(G.RenderSlot.TRANSPARENT_MATERIAL,P.ShaderOutput.Color))),this._bindParameters.camera=e,this._bindParameters.contentCamera=r}_ensureBindParameters(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r;const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.mainColor=t.colorTexture,this._bindParameters.mainDepth=t.depthTexture}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=c.IDENTITY:(u.invert(se,this._bindParameters.camera.viewMatrix),u.invert(te,this._bindParameters.camera.projectionMatrix),u.multiply(ae,se,te),u.multiply(ae,this._renderContext.lastFrameCamera.viewMatrix,ae),u.multiply(ae,this._renderContext.lastFrameCamera.projectionMatrix,ae),this._reprojectionMatrix=ae);const r=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=r>0?Math.min(r,e-this._ssrEnableTime)/r:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=c.IDENTITY,this._ssrEnableTime=null}_shouldRenderInternalSlot(e,r){return this._bindParameters.slot=r,e.some((e=>null!=e.prepareTechnique(this._renderContext)))}_prepareInternalSlots(e,...r){for(const t of r)this._bindParameters.slot=t,e.forAll((e=>null!=e.prepareTechnique(this._renderContext)))}_renderInternalSlot(e,r=this._materialRenderers){this._bindParameters.slot=e,r.forAll((e=>{const r=e.prepareTechnique(this._renderContext);r&&e.renderNode(this._renderContext,r)}))}get memoryInfo(){return{fbos:this.fboCache.usedMemory,vaos:this._materialRenderers.reduce(((e,r)=>e+r.usedMemory),0),plugins:this._renderPlugins.usedMemory}}getMemoryForMaterial(e){if(null==e)return 0;const r=this._materialRenderers.find((r=>r.material===e));return r?.usedMemory??0}get usedMemory(){return this.fboCache.usedMemory+(this.edgeView?.usedMemory??0)+this._renderPlugins.usedMemory}get test(){const r=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{r._renderStateFeatures=B.setupFeatureDefaults(),this._renderPlugins.renderFeatureChanged(),this._requestRender()},releaseGeometryLinearDepth(e){r._releaseGeometryLinearDepth=e??(e=>e?.release()),r._geometryLinearDepthFormat=e?T.DepthFormat.DEPTH_STENCIL_TEXTURE:T.DepthFormat.DEPTH16_BUFFER},getFramebufferTexture:t=>{switch(t){case e.FramebufferId.Color:return r._offscreen.colorTexture;case e.FramebufferId.LinearDepth:return r._bindParameters.linearDepth?.colorTexture;case e.FramebufferId.ShadowMap:return r._shadowMap.depthTexture;case e.FramebufferId.HudVisibility:return r._bindParameters.hudVisibility?.colorTexture}}}}},r.__decorate([o.property()],e.Renderer.prototype,"_renderPlugins",void 0),r.__decorate([o.property()],e.Renderer.prototype,"_shadowAccumulator",void 0),r.__decorate([o.property()],e.Renderer.prototype,"_state",void 0),r.__decorate([o.property()],e.Renderer.prototype,"_renderStateFeatures",void 0),r.__decorate([o.property({readOnly:!0})],e.Renderer.prototype,"fullResolutionAtmosphere",null),r.__decorate([o.property()],e.Renderer.prototype,"_smaa",void 0),r.__decorate([o.property()],e.Renderer.prototype,"_blit",void 0),r.__decorate([o.property({autoDestroy:!0})],e.Renderer.prototype,"_edgeView",void 0),r.__decorate([o.property()],e.Renderer.prototype,"updating",null),r.__decorate([o.property()],e.Renderer.prototype,"isCameraFinal",null),e.Renderer=r.__decorate([_.subclass("esri.views.3d.webgl-engine.lib.Renderer")],e.Renderer),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(Z||(Z={})),e.FramebufferId=void 0,($=e.FramebufferId||(e.FramebufferId={}))[$.Color=0]="Color",$[$.LinearDepth=1]="LinearDepth",$[$.ShadowMap=2]="ShadowMap",$[$.HudVisibility=3]="HudVisibility";const ee=[0,0,0,0],re=new d,te=c.create(),se=c.create(),ae=c.create();function ne(e){return r=>e.immediate.schedule(r)}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
