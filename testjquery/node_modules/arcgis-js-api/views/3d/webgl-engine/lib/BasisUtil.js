/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../libs/basisu/BasisU","../../../../libs/basisu/TextureFormat","../../../webgl/enums","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,r,n,s,a){"use strict";let i=null,o=null;async function u(){return null==o&&(o=t.getBasisTranscoder(),i=await o),o}function l(e,t){if(null==i)return e.byteLength;const r=new i.BasisFile(new Uint8Array(e)),n=T(r)?g(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),n}function m(e,t){if(null==i)return e.byteLength;const r=new i.KTX2File(new Uint8Array(e)),n=c(r)?g(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),n}function g(e,t,r,s,i){const o=a.getBytesPerElementFormat(t?n.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC:n.CompressedTextureFormat.COMPRESSED_RGB8_ETC2),u=i&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*s*o*u)}function T(e){return e.getNumImages()>=1&&!e.isUASTC()}function c(e){return e.getFaces()>=1&&e.isETC1S()}async function d(e,t,r){null==i&&(i=await u());const n=new i.BasisFile(new Uint8Array(r));if(!T(n))return null;n.startTranscoding();const s=E(e,t,n.getNumLevels(0),n.getHasAlpha(),n.getImageWidth(0,0),n.getImageHeight(0,0),((e,t)=>n.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>n.transcodeImage(r,0,e,t,0,0)));return n.close(),n.delete(),s}async function C(e,t,r){null==i&&(i=await u());const n=new i.KTX2File(new Uint8Array(r));if(!c(n))return null;n.startTranscoding();const s=E(e,t,n.getLevels(),n.getHasAlpha(),n.getWidth(),n.getHeight(),((e,t)=>n.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>n.transcodeImage(r,e,0,0,t,0,-1,-1)));return n.close(),n.delete(),s}function E(e,t,a,i,o,u,l,m){const{compressedTextureETC:g,compressedTextureS3TC:T}=e.capabilities,[c,d]=g?i?[r.TextureFormat.ETC2_RGBA,n.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC]:[r.TextureFormat.ETC1_RGB,n.CompressedTextureFormat.COMPRESSED_RGB8_ETC2]:T?i?[r.TextureFormat.BC3_RGBA,n.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[r.TextureFormat.BC1_RGB,n.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT]:[r.TextureFormat.RGBA32,n.PixelFormat.RGBA],C=t.hasMipmap?a:Math.min(1,a),E=[];for(let r=0;r<C;r++)E.push(new Uint8Array(l(r,c))),m(r,c,E[r]);return t.internalFormat=d,t.hasMipmap=E.length>1,t.samplingMode=t.hasMipmap?n.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:n.TextureSamplingMode.LINEAR,t.width=o,t.height=u,new s.Texture(e,t,{type:"compressed",levels:E})}e.createTextureBasis=d,e.createTextureKTX2=C,e.estimateMemoryBasis=l,e.estimateMemoryKTX2=m,e.loadBasis=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
