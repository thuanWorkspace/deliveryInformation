/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./basicInterfaces","./ContentObject","./ContentObjectType","./Object3DStateID","./Util","./VertexAttribute","../materials/renderers/utils"],(function(t,e,i,s,a,r,n,o,h,m,c,l,d,u){"use strict";class b extends h.ContentObject{get geometries(){return this._geometries}get transformation(){return this._transformation??i.IDENTITY}set transformation(t){this._transformation=e.copy(this._transformation??i.create(),t),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(t){this._shaderTransformation=t?e.copy(this._shaderTransformation??i.create(),t):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(t={}){super(),this.type=m.ContentObjectType.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=t.castShadow??!0,this.usesVerticalDistanceToGround=t.usesVerticalDistanceToGround??!1,this.graphicUid=t.graphicUid,this.layerUid=t.layerUid,t.isElevationSource&&(this.lastValidElevationBB=new g),this._geometries=t.geometries?Array.from(t.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){l.assert(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t){t.visible=this._visible,this._geometries.push(t),this._emit("geometryAdded",{object:this,geometry:t}),this._invalidateBoundingVolume()}removeGeometry(t){const e=this._geometries.splice(t,1)[0];e&&(this._emit("geometryRemoved",{object:this,geometry:e}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(t,e,i=!1){this._emit("attributesChanged",{object:this,geometry:t,attribute:e,sync:i}),d.affectsGeometry(e)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(t){if(this._visible!==t){this._visible=t;for(const t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new c.Object3DStateID(o.Object3DState.MaskOccludee);for(const e of this._geometries)e.occludees=u.addObject3DStateID(e.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometries)e.occludees=u.removeObject3DStateID(e.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new c.Object3DStateID(o.Object3DState.Highlight);for(const e of this._geometries)e.highlights=u.addObject3DStateID(e.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const e of this._geometries)e.highlights=u.removeObject3DStateID(e.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,i){return e.multiply(i,this.transformation,t.transformation)}getCombinedShaderTransformation(t,s=i.create()){return e.multiply(s,this.effectiveTransformation,t.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new f,this._validateBoundingVolume(this._bvWorldSpace,O.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new f,this._validateBoundingVolume(this._bvObjectSpace,O.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(t,e){const i=e===O.ObjectSpace;for(const s of this._geometries){const e=s.boundingInfo;e&&_(e,t,i?s.transformation:this.getCombinedShaderTransformation(s))}s.lerp(t.bounds,t.min,t.max,.5);for(const a of this._geometries){const e=a.boundingInfo;if(null==e)continue;const r=i?a.transformation:this.getCombinedShaderTransformation(a),o=n.maxScale(r);s.transformMat4(S,e.center,r);const h=s.distance(S,t.bounds),m=e.radius*o;t.bounds[3]=Math.max(t.bounds[3],h+m)}}_invalidateBoundingVolume(){const t=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&t&&this._parentLayer.notifyObjectBBChanged(this,t)}_emit(t,e){this._parentLayer&&this._parentLayer.events.emit(t,e)}get test(){const t=this;return{hasGeometry:e=>t._geometries.includes(e),getGeometryIndex:e=>t._geometries.indexOf(e)}}}class g{constructor(){this.min=a.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=a.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class f extends g{constructor(){super(...arguments),this.bounds=r.create()}}function _(t,i,a){const r=t.bbMin,n=t.bbMax;if(e.hasIdentityRotation(a)){const t=s.set(p,a[12],a[13],a[14]);s.add(v,r,t),s.add(y,n,t);for(let e=0;e<3;++e)i.min[e]=Math.min(i.min[e],v[e]),i.max[e]=Math.max(i.max[e],y[e])}else if(s.transformMat4(v,r,a),s.exactEquals(r,n))for(let e=0;e<3;++e)i.min[e]=Math.min(i.min[e],v[e]),i.max[e]=Math.max(i.max[e],v[e]);else{s.transformMat4(y,n,a);for(let t=0;t<3;++t)i.min[t]=Math.min(i.min[t],v[t],y[t]),i.max[t]=Math.max(i.max[t],v[t],y[t]);for(let t=0;t<3;++t){s.copy(v,r),s.copy(y,n),v[t]=n[t],y[t]=r[t],s.transformMat4(v,v,a),s.transformMat4(y,y,a);for(let t=0;t<3;++t)i.min[t]=Math.min(i.min[t],v[t],y[t]),i.max[t]=Math.max(i.max[t],v[t],y[t])}}}const p=a.create(),v=a.create(),y=a.create(),S=a.create();var O;!function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"}(O||(O={})),t.Object3D=b,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
