/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../ViewingMode","../core/FBOCache","./CascadeCamera","./textureUtils","./Util","../../../webgl/enums","../../../webgl/Texture"],(function(t,e,s,a,i,r,c,h,n,o,l,d,u,_,m,p,f,g,x,b){"use strict";var y;t.SnapshotSlot=void 0,(y=t.SnapshotSlot||(t.SnapshotSlot={}))[y.Highlight=0]="Highlight",y[y.Default=1]="Default";class M{constructor(){this.camera=new p.CascadeCamera,this.lightMat=c.create()}}class T{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class C{get depthTexture(){return this._handle?.colorTexture}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return d.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(t,s){this._fbos=t,this._viewingMode=s,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new T,this._projectionView=c.create(),this._projectionViewInverse=c.create(),this._modelViewLight=c.create(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=u.create(),this._cascades=[new M,new M,new M,new M],this._lastOrigin=null,this._maxTextureWidth=Math.min(e("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=a.releaseMaybe(this._handle),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=s.clamp(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let t=0;t<this._numCascades;++t)B[t]=this._cascades[t];return B.length=this._numCascades,B}start(t,e,s,a,i){g.assert(this.enabled);const{near:r,far:c}=this._clampNearFar(s);this._computeCascadeDistances(r,c,a),this._textureHeight=this._computeTextureHeight(t,i,a),this._setupMatrices(t,e);const{viewMatrix:h,projectionMatrix:n}=t;for(let o=0;o<this._numCascades;++o)this._constructCascade(o,n,h,e);this._lastOrigin=null,this.clear()}finish(){g.assert(this.enabled),this._handle?.releaseDepth()}getShadowMapMatrices(t){if(!this._lastOrigin||!o.exactEquals(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||l.create(),o.copy(this._lastOrigin,t);for(let e=0;e<this._numCascades;++e){r.translate(O,this._cascades[e].lightMat,t);for(let t=0;t<16;++t)N[16*e+t]=O[t]}}return N}moveSnapshot(t){g.assert(this.enabled),this._handle?.releaseDepth(),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle=null}copySnapshot(t){const e=this._handle?.colorTexture?.descriptor;if(!this.enabled||!e)return;this._snapshots[t]?.release();const{width:s,height:a}=e;this._snapshots[t]=this._fbos.acquire(m.ColorFormat.RGBA4,s,a);const i=this._fbos.rctx;this._bindFbo();const r=i.bindTexture(this._snapshots[t]?.colorTexture,b.Texture.TEXTURE_UNIT_FOR_UPDATES);i.gl.copyTexSubImage2D(x.TextureType.TEXTURE_2D,0,0,0,0,0,s,a),i.bindTexture(r,b.Texture.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(t){return this.enabled?this._snapshots[t]?.colorTexture:null}clear(){const t=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT|x.ClearBufferBit.DEPTH_BUFFER_BIT)}_computeTextureHeight(t,e,s){const a=Math.min(window.devicePixelRatio,e)/t.pixelRatio,i=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,r=f.applyTextureResizeModulo(Math.floor(Math.max(t.fullWidth,t.fullHeight)*a*i));return Math.min(this._maxTextureWidth,this._numCascades*r)/this._numCascades}_ensureFbo(){this._handle?.fbo.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(m.ColorFormat.RGBA4,this._textureWidth,this._textureHeight)),this._handle.acquireDepth(m.DepthFormat.DEPTH16_BUFFER)}_discardSnapshot(t){this._snapshots[t]=a.releaseMaybe(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}_bindFbo(){const t=this._fbos.rctx;t.unbindTexture(this.depthTexture),t.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,e,s,a){const i=this._cascades[t],c=-this._cascadeDistances[t],h=-this._cascadeDistances[t+1],n=(e[10]*c+e[14])/Math.abs(e[11]*c+e[15]),l=(e[10]*h+e[14])/Math.abs(e[11]*h+e[15]);g.assert(n<l);for(let r=0;r<8;++r){const t=r%4==0||r%4==3?-1:1,e=r%4==0||r%4==1?-1:1,s=r<4?n:l;d.set(D,t,e,s,1);const a=v[r];d.transformMat4(a,D,this._projectionViewInverse),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3]}o.negate(I,v[0]),i.camera.viewMatrix=r.translate(w,this._modelViewLight,I);for(let r=0;r<8;++r)o.transformMat4(v[r],v[r],i.camera.viewMatrix);let u=v[0][2],_=v[0][2];for(let r=1;r<8;++r)u=Math.min(u,v[r][2]),_=Math.max(_,v[r][2]);u-=200,_+=200,i.camera.near=-_,i.camera.far=-u,$(s,a,u,_,i.camera),r.multiply(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const m=this._textureHeight;i.camera.viewport=[t*m,0,m,m]}_setupMatrices(t,e){r.multiply(this._projectionView,t.projectionMatrix,t.viewMatrix),r.invert(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===_.ViewingMode.Global?t.eye:o.set(I,0,0,1);r.lookAt(this._modelViewLight,[0,0,0],[-e[0],-e[1],-e[2]],s)}_clampNearFar(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}}_computeCascadeDistances(t,e,a){const i=a?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(g.logWithBase(e/t,4)),i);const r=(e-t)/this._numCascades,c=(e/t)**(1/this._numCascades);let h=t,n=t;for(let o=0;o<this._numCascades+1;++o)this._cascadeDistances[o]=s.lerp(h,n,this.settings.splitSchemeLambda),h*=c,n+=r}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const w=c.create(),D=u.create(),v=[];for(let tt=0;tt<8;++tt)v.push(u.create());const S=n.create(),R=n.create(),H=n.create(),F=n.create(),E=n.create(),I=l.create(),B=[],O=c.create(),N=c.IDENTITY.concat(c.IDENTITY,c.IDENTITY,c.IDENTITY,c.IDENTITY),j=n.create(),U=n.create(),V=[n.create(),n.create(),n.create(),n.create()],k=n.create(),L=n.create(),Q=n.create(),z=n.create(),A=n.create(),q=n.create(),W=n.create();function P(t,e,s,a,i,r,c,n){h.set(j,0,0);for(let g=0;g<4;++g)h.add(j,j,t[g]);h.scale(j,j,.25),h.set(U,0,0);for(let g=4;g<8;++g)h.add(U,U,t[g]);h.scale(U,U,.25),h.lerp(V[0],t[4],t[5],.5),h.lerp(V[1],t[5],t[6],.5),h.lerp(V[2],t[6],t[7],.5),h.lerp(V[3],t[7],t[4],.5);let o=0,l=h.squaredDistance(V[0],j);for(let g=1;g<4;++g){const t=h.squaredDistance(V[g],j);t<l&&(l=t,o=g)}h.subtract(k,V[o],t[o+4]);const d=k[0];let u,_;k[0]=-k[1],k[1]=d,h.subtract(L,U,j),h.dot(L,k)<0&&h.negate(k,k),h.lerp(k,k,L,s),h.normalize(k,k),u=_=h.dot(h.subtract(Q,t[0],j),k);for(let g=1;g<8;++g){const e=h.dot(h.subtract(Q,t[g],j),k);e<u?u=e:e>_&&(_=e)}h.copy(a,j),h.scale(Q,k,u-e),h.add(a,a,Q);let m=-1,p=1,f=0,x=0;for(let g=0;g<8;++g){h.subtract(z,t[g],a),h.normalize(z,z);const e=k[0]*z[1]-k[1]*z[0];e>0?e>m&&(m=e,f=g):e<p&&(p=e,x=g)}g.verify(m>0,"leftArea"),g.verify(p<0,"rightArea"),h.scale(A,k,u),h.add(A,A,j),h.scale(q,k,_),h.add(q,q,j),W[0]=-k[1],W[1]=k[0];const b=g.rayRay2D(a,t[x],q,h.add(Q,q,W),1,i),y=g.rayRay2D(a,t[f],q,Q,1,r),M=g.rayRay2D(a,t[f],A,h.add(Q,A,W),1,c),T=g.rayRay2D(a,t[x],A,Q,1,n);g.verify(b,"rayRay"),g.verify(y,"rayRay"),g.verify(M,"rayRay"),g.verify(T,"rayRay")}function Y(t,e){return 3*e+t}const G=n.create();function X(t,e){return h.set(G,t[e],t[e+3]),G}const J=n.create(),K=i.create();function Z(t,e,s,a,i){h.subtract(J,s,a),h.scale(J,J,.5),K[0]=J[0],K[1]=J[1],K[2]=0,K[3]=J[1],K[4]=-J[0],K[5]=0,K[6]=J[0]*J[0]+J[1]*J[1],K[7]=J[0]*J[1]-J[1]*J[0],K[8]=1,K[Y(0,2)]=-h.dot(X(K,0),t),K[Y(1,2)]=-h.dot(X(K,1),t);let r=h.dot(X(K,0),s)+K[Y(0,2)],c=h.dot(X(K,1),s)+K[Y(1,2)],n=h.dot(X(K,0),a)+K[Y(0,2)],o=h.dot(X(K,1),a)+K[Y(1,2)];r=-(r+n)/(c+o),K[Y(0,0)]+=K[Y(1,0)]*r,K[Y(0,1)]+=K[Y(1,1)]*r,K[Y(0,2)]+=K[Y(1,2)]*r,r=1/(h.dot(X(K,0),s)+K[Y(0,2)]),c=1/(h.dot(X(K,1),s)+K[Y(1,2)]),K[Y(0,0)]*=r,K[Y(0,1)]*=r,K[Y(0,2)]*=r,K[Y(1,0)]*=c,K[Y(1,1)]*=c,K[Y(1,2)]*=c,K[Y(2,0)]=K[Y(1,0)],K[Y(2,1)]=K[Y(1,1)],K[Y(2,2)]=K[Y(1,2)],K[Y(1,2)]+=1,r=h.dot(X(K,1),e)+K[Y(1,2)],c=h.dot(X(K,2),e)+K[Y(2,2)],n=h.dot(X(K,1),s)+K[Y(1,2)],o=h.dot(X(K,2),s)+K[Y(2,2)],r=-.5*(r/c+n/o),K[Y(1,0)]+=K[Y(2,0)]*r,K[Y(1,1)]+=K[Y(2,1)]*r,K[Y(1,2)]+=K[Y(2,2)]*r,r=h.dot(X(K,1),e)+K[Y(1,2)],c=h.dot(X(K,2),e)+K[Y(2,2)],n=-c/r,K[Y(1,0)]*=n,K[Y(1,1)]*=n,K[Y(1,2)]*=n,i[0]=K[0],i[1]=K[1],i[2]=0,i[3]=K[2],i[4]=K[3],i[5]=K[4],i[6]=0,i[7]=K[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=K[6],i[13]=K[7],i[14]=0,i[15]=K[8]}function $(t,e,a,i,r){const c=1/v[0][3],h=1/v[4][3];g.assert(c<h);let n=c+Math.sqrt(c*h);const o=Math.sin(s.acosClamped(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));n/=o,P(v,n,o,S,R,H,F,E),Z(S,R,F,E,r.projectionMatrix),r.projectionMatrix[10]=2/(a-i),r.projectionMatrix[14]=-(a+i)/(a-i)}t.ShadowMap=C,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
