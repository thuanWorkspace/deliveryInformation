/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f64","../../../../../chunks/quat","../../../../../chunks/quatf64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/plane","../../../support/orientedBoundingBox","../../lib/depthRange"],(function(t,e,n,o,r,a,c,s,u,l,f){"use strict";function i(t,e){const n=f.empty(),{eye:o,frustum:r,viewForward:a}=t;e.forAll((t=>{const e=null!=t.offsetObb?t.offsetObb:t.obb,s=c.dot(c.sub(A,e.center,o),a),u=l.projectedRadius(e,a);if(f.within(n,s-u)&&f.within(n,s+u))return;const i=v(e,r);if(-1===i)return;if(0===i)return d.far=s+u,d.near=s-u,void f.union(n,d);const b=h.pushNew();b.near=s-u,b.far=s+u,b.mask=i,b.object=t}));for(let s=0;s<h.length;s++){const t=h.data[s];if(f.within(n,t.near)&&f.within(n,t.far))continue;d.far=t.far,d.near=1/0;const e=y(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,o,g,(e=>{let n=m;for(let o=0;o<z&&e.length>0;o++){if(0==(t.mask&1<<o))continue;w(r[o],e,n);const a=e;e=n,n=a}for(let t=0;t<e.length;t+=3){c.set(b,e.data[t],e.data[t+1],e.data[t+2]);const n=c.dot(c.sub(b,b,o),a);d.near=Math.min(d.near,n)}}));0===e&&(d.near=0),f.union(n,d)}return h.length=0,n}const h=new e({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),d=f.empty(),b=s.create(),p=s.create(),g=new e({deallocator:null}),m=new e({deallocator:null});function w(t,e,n){n.length=0;const o=e.length-3;j(b,e,o);const r=u.signedDistance(t,b);r<=0&&(n.push(b[0]),n.push(b[1]),n.push(b[2]));let a=0,s=r;for(;a<o;a+=3){j(p,e,a);const o=u.signedDistance(t,p);if(s*o<0){const t=o/(o-s);c.lerp(b,p,b,t),k(n,b)}o<=0&&k(n,p),s=o,c.copy(b,p)}if(s*r<0){j(p,e,o);const t=r/(r-s);c.lerp(b,p,b,t),k(n,b)}}function j(t,e,n){return c.set(t,e.data[n],e.data[n+1],e.data[n+2])}function k(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function y(t,e,o,a){r.conjugate(q,t.quaternion),c.sub(A,e,t.center),c.transformQuat(A,A,q);const s=8*((A[0]<-t.halfSize[0]?-1:A[0]>t.halfSize[0]?1:0)+3*(A[1]<-t.halfSize[1]?-1:A[1]>t.halfSize[1]?1:0)+9*(A[2]<-t.halfSize[2]?-1:A[2]>t.halfSize[2]?1:0)+13),u=S[s];if(0===u)return u;n.fromQuat(O,t.quaternion),n.scale(O,O,t.halfSize);const l=(e,n)=>{const o=S[s+n+1];return c.set(e,((1&o)<<1)-1,(2&o)-1,((4&o)>>1)-1),c.transformMat3(e,e,O),c.add(e,t.center,e)};return o.length=0,k(o,l(D,0)),k(o,l(M,1)),k(o,l(A,2)),k(o,l(P,3)),a(o),1===u?u:(o.length=0,k(o,D),k(o,P),k(o,l(A,4)),k(o,l(R,5)),a(o),2===u||(o.length=0,k(o,D),k(o,R),k(o,l(A,6)),k(o,M),a(o)),u)}const S=(()=>{const t=new Array(216);let e=0;const n=n=>{for(let o=0;o<n.length;o++)t[e+o]=n[o];e+=8};return n([3,0,6,2,3,1,5,4]),n([2,0,2,3,1,5,4,0]),n([3,1,0,2,3,7,5,4]),n([2,0,1,3,2,6,4,0]),n([1,0,1,3,2,0,0,0]),n([2,1,5,7,3,2,0,0]),n([3,2,0,1,3,7,6,4]),n([2,2,0,1,3,7,6,0]),n([3,3,0,1,5,7,6,2]),n([2,0,1,5,4,6,2,0]),n([1,0,1,5,4,0,0,0]),n([2,1,3,7,5,4,0,0]),n([1,0,2,6,4,0,0,0]),n([0,0,0,0,0,0,0,0]),n([1,1,3,7,5,0,0,0]),n([2,2,3,7,6,4,0,0]),n([1,2,3,7,6,0,0,0]),n([2,3,1,5,7,6,2,0]),n([3,4,0,1,5,7,6,2]),n([2,5,7,6,4,0,1,0]),n([3,5,0,1,3,7,6,4]),n([2,4,5,7,6,2,0,0]),n([1,4,5,7,6,0,0,0]),n([2,5,1,3,7,6,4,0]),n([3,6,0,2,3,7,5,4]),n([2,6,2,3,7,5,4,0]),n([3,7,6,2,3,1,5,4]),t})(),z=4;function v(t,e){let n=0;for(let o=0;o<z;o++){const r=l.intersectPlane(t,e[o]);if(r>0)return-1;0===r&&(n|=1<<o)}return n}const O=o.create(),q=a.create(),A=s.create(),D=s.create(),M=s.create(),P=s.create(),R=s.create();t.computeDepthRange=i,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
