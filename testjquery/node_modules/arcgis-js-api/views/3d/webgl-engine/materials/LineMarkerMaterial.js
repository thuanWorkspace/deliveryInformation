/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/vec3","../../../../chunks/vec3f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLTextureMaterial","../lib/Material","../lib/RenderSlot","../lib/VertexAttribute","./VisualVariablePassParameters","../shaders/LineMarkerTechnique","../shaders/LineMarkerTechniqueConfiguration","../shaders/RibbonLineTechniqueConfiguration"],(function(e,t,r,a,i,s,n,u,h,o,c,l,p){"use strict";class d extends n.Material{constructor(e){super(e,new A),this._vertexAttributeLocations=c.vertexAttributeLocations,this._configuration=new l.LineMarkerTechniqueConfiguration,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===u.RenderSlot.DRAPED_MATERIAL?l.LineMarkerSpace.Draped:this.parameters.worldSpace?l.LineMarkerSpace.World:l.LineMarkerSpace.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==p.CapType.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===n.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=a.newLayout().vec3f(h.VertexAttribute.POSITION).vec2f(h.VertexAttribute.UV0).vec3f(h.VertexAttribute.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(h.VertexAttribute.NORMAL),this.parameters.vvSize?e.f32(h.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(h.VertexAttribute.SIZE),this.parameters.vvColor?e.f32(h.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4f(h.VertexAttribute.COLOR),this.parameters.vvOpacity&&e.f32(h.VertexAttribute.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new T(this._layout,this.parameters)}produces(e,t){if(t===i.ShaderOutput.Color||t===i.ShaderOutput.Alpha||t===i.ShaderOutput.Highlight||t===i.ShaderOutput.Depth){if(e===u.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===n.RenderOccludedFlag.OccludeAndTransparentStencil)return e===u.RenderSlot.OPAQUE_MATERIAL||e===u.RenderSlot.OCCLUDER_MATERIAL||e===u.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;if(t===i.ShaderOutput.Color||t===i.ShaderOutput.Alpha){return e===(this.parameters.writeDepth?u.RenderSlot.TRANSPARENT_MATERIAL:u.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===u.RenderSlot.OPAQUE_MATERIAL}return!1}createGLMaterial(e){return new m(e)}}class m extends s.GLTextureMaterial{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(c.LineMarkerTechnique,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==i.ShaderOutput.Color&&this._output!==i.ShaderOutput.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class A extends o.VisualVariablePassParameters{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=p.CapType.BUTT,this.anchor=l.LineMarkerAnchor.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class T{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(e,r,a,i,s){const n=a.attributes.get(h.VertexAttribute.POSITION).data,u=n.length/3;let o=[1,0,0];const c=a.attributes.get(h.VertexAttribute.NORMAL);this._parameters.worldSpace&&null!=c&&(o=c.data);let l=1,p=0;this._parameters.vvSize?p=a.attributes.get(h.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:a.attributes.has(h.VertexAttribute.SIZE)&&(l=a.attributes.get(h.VertexAttribute.SIZE).data[0]);let d=[1,1,1,1],m=0;this._parameters.vvColor?m=a.attributes.get(h.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:a.attributes.has(h.VertexAttribute.COLOR)&&(d=a.attributes.get(h.VertexAttribute.COLOR).data);let A=0;this._parameters.vvOpacity&&(A=a.attributes.get(h.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const T=new Float32Array(i.buffer);let O=s*(this.vertexBufferLayout.stride/4);const v=(e,t,r,a)=>{if(T[O++]=e[0],T[O++]=e[1],T[O++]=e[2],T[O++]=r[0],T[O++]=r[1],T[O++]=t[0],T[O++]=t[1],T[O++]=t[2],this._parameters.worldSpace&&(T[O++]=o[0],T[O++]=o[1],T[O++]=o[2]),this._parameters.vvSize?T[O++]=p:T[O++]=l,this._parameters.vvColor)T[O++]=m;else{const e=Math.min(4*a,d.length-4);T[O++]=d[e],T[O++]=d[e+1],T[O++]=d[e+2],T[O++]=d[e+3]}this._parameters.vvOpacity&&(T[O++]=A)};let E;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(E||(E={}));const f=(r,a)=>{const i=t.set(S,n[3*r],n[3*r+1],n[3*r+2]),s=_;let h=r+a;do{t.set(s,n[3*h],n[3*h+1],n[3*h+2]),h+=a}while(t.equals(i,s)&&h>=0&&h<u);e&&(t.transformMat4(i,i,e),t.transformMat4(s,s,e)),v(i,s,[-1,-1],r),v(i,s,[1,-1],r),v(i,s,[1,1],r),v(i,s,[-1,-1],r),v(i,s,[1,1],r),v(i,s,[-1,1],r)},b=this._parameters.placement;"begin"!==b&&"begin-end"!==b||f(0,E.ASCENDING),"end"!==b&&"begin-end"!==b||f(u-1,E.DESCENDING)}}const S=r.create(),_=r.create();e.LineMarkerMaterial=d,e.Parameters=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
