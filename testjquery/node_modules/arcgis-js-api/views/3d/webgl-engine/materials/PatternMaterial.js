/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/vec4f64","../../../../geometry/support/buffer/BufferView","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/basicInterfaces","../lib/GLMaterial","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./DefaultBufferWriter","./PatternStyle","./TriangleMaterial","./VisualVariablePassParameters","./internal/bufferWriterUtils","../shaders/PatternTechnique"],(function(e,t,r,i,a,s,n,u,o,l,h,c,f,p,d,g,A){"use strict";class b extends p.TriangleMaterial{constructor(e){super(e,new S),this.supportsEdges=!0,this._vertexAttributeLocations=A.vertexAttributeLocations,this._configuration=new A.PatternTechniqueConfiguration}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<u.OITPolygonOffsetLimit,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}produces(e,t){if(t===a.ShaderOutput.Color||t===a.ShaderOutput.Alpha||t===a.ShaderOutput.Highlight||t===a.ShaderOutput.Depth&&this.parameters.writeLinearDepth){if(e===o.RenderSlot.DRAPED_MATERIAL)return!0;if(t===a.ShaderOutput.Highlight)return e===o.RenderSlot.OPAQUE_MATERIAL;return e===(this.parameters.writeDepth?o.RenderSlot.TRANSPARENT_MATERIAL:o.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return!1}createGLMaterial(e){return new m(e)}createBufferWriter(){const e=i.newLayout().vec3f(h.VertexAttribute.POSITION).vec4f(h.VertexAttribute.UVMAPSPACE);return this.parameters.draped||e.mat3f(h.VertexAttribute.BOUNDINGRECT),this.parameters.vvColor?e.f32(h.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4u8(h.VertexAttribute.COLOR),new O(e)}}class m extends n{_updateParameters(e){return this.ensureTechnique(A.PatternTechnique,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==a.ShaderOutput.Color&&this._output!==a.ShaderOutput.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class O extends c.DefaultBufferWriter{write(e,t,i,a,s){for(const n of this.vertexBufferLayout.fields.keys()){const u=i.attributes.get(n),o=u?.indices;if(u&&o)switch(n){case h.VertexAttribute.UVMAPSPACE:{l.assert(4===u.size);const e=a.getField(n,r.BufferViewVec4f);e&&g.writeBufferVec4(u,e,s);break}case h.VertexAttribute.BOUNDINGRECT:{l.assert(9===u.size);const t=a.getField(n,r.BufferViewMat3f);t&&this.writeBoundingRect(u,e,t,s);break}default:g.writeDefaultAttribute(n,u,e,t,a,s)}}}writeBoundingRect(e,t,r,i){const{data:a,indices:s}=e,n=t,u=r.typedBuffer,o=r.typedBufferStride,l=s.length;i*=o;for(let h=0;h<l;++h){const e=9*s[h],t=a[e],r=a[e+1],l=a[e+2];u[i]=n[0]*t+n[4]*r+n[8]*l+n[12],u[i+1]=n[1]*t+n[5]*r+n[9]*l+n[13],u[i+2]=n[2]*t+n[6]*r+n[10]*l+n[14];for(let s=3;s<9;++s)u[i+s]=a[e+s];i+=o}}}class S extends d.VisualVariablePassParameters{constructor(){super(...arguments),this.color=t.fromValues(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=s.CullFaceOptions.None,this.hasOccludees=!1,this.style=f.Style.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}e.Parameters=S,e.PatternMaterial=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
