/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/MapUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../effects/RenderPlugin","../../lib/GLMaterials","../../lib/Material","../../lib/ModelDirtyTypes","../../lib/RenderSlot","../../lib/Util","../DrawParameters","../WaterMaterial","./BufferRange","./Instance","./PerBufferData","./PerOriginData","./VaoCache"],(function(e,t,r,a,s,i,n,o,l,u,h,c,d,f,g,m,p,y,_,b,v,w,O,C,M,S,R,A,D){"use strict";e.MergedRenderer=class extends p.SyncPrepareRenderPlugin{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this.priority=0,this.produces=new Map}dispose(){this._glMaterials=i.disposeMaybe(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=i.disposeMaybe(this._vaoCache)}initializeRenderContext(e,t){const{rctx:r}=e.renderContext;this._glMaterials=new y.GLMaterials(this.material,t??e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new D.VaoCache(r,this.material.vertexAttributeLocations,g.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof C.WaterMaterial}get isDecoration(){return this.material.parameters.isDecoration}get rendersOccluded(){return!this.isEmpty&&this.material.parameters.renderOccluded!==_.RenderOccludedFlag.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const r=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.renderGeometry,s=this._dataByOrigin.get(e.localOrigin.id),i=s?.findBuffer(e.id);if(null==i)return;const n=i.instances.get(e.id);if(a.updateType&(b.DirtyState.GEOMETRY|b.DirtyState.TRANSFORMATION)){const a=N(t.elementCount(n.geometry.geometry)*r),s=t.vertexBufferLayout.createView(a.buffer);this._writeGeometry(e,s,0),i.vao.vertexBuffers.geometry.setSubData(a,n.from*r,0,n.numElements*r)}a.updateType&(b.DirtyState.HIGHLIGHT|b.DirtyState.OCCLUDEE|b.DirtyState.VISIBILITY)&&(i.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new n.NestedMap;for(const a of e){const e=a.localOrigin;if(null==e)continue;let t=r.get(e.id,null);null==t&&(t=new B(e.vec3),r.set(e.id,null,t)),t.changes.push(a)}for(const a of t){const e=a.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),s=t?.findBuffer(a.id);if(null==s)continue;let i=r.get(e.id,s);null==i&&(i=new B(e.vec3),r.set(e.id,s,i)),i.changes.push(a)}return r}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:a,_dataByOrigin:s}=this,i=a.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach(((e,t)=>{const o=e.get(null),l=null!=o?o.changes:[];n.delete(t,null);let u=s.get(t);if(e.forEach(((e,o)=>{if(n.delete(t,o),null==o)return void w.assert(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),r.removeUnordered(u.buffers,o),void(0===u.buffers.length&&0===l.length&&s.delete(t));const h=o.numElements,c=o.vao.byteSize/4,d=l.reduce(((e,t)=>e+a.elementCount(t.geometry)),0),f=e.changes.reduce(((e,t)=>e+a.elementCount(t.geometry)),0),g=Math.min((h+d-f)*i,V),m=g>c;g>P&&g<c/2?(e.changes.forEach((({id:e})=>o.deleteInstance(e))),o.instances.forEach((({geometry:e})=>l.push(e))),this._vaoCache.deleteVao(o.vao),r.removeUnordered(u.buffers,o)):m?this._applyAndRebuild(o,l,e):this._applyRemoves(o,e)})),l.length>0)for(null==u&&(u=new A.PerOriginData(o.origin),s.set(t,u)),u.buffers.forEach((e=>this._applyAdds(e,l)));l.length>0;)u.buffers.push(this._applyAndRebuild(new R.PerBufferData,l,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,a.someMap(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(null!=r)for(const f of r.changes)e.deleteInstance(f.id);const a=this._bufferWriter,s=a.vertexBufferLayout.stride,i=s/4,n=Math.floor(V/i);let o=e.numElements;for(;t.length>0;){const r=t.pop(),s=a.elementCount(r.geometry);if(o+s>n&&o>0){t.push(r);break}o+=s;const i=new S.Instance(r,0,0);w.assert(null==e.instances.get(r.id)),e.addInstance(r.id,i)}const l=o*i,u=N(l),h=a.vertexBufferLayout.createView(u.buffer);let c=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,h,c);const s=c;c+=a.elementCount(t.geometry.geometry),e.updateInstance(r,s,c),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(z(l)),e.vao.vertexBuffers.geometry.setSubData(u,0,0,c*i),e.holes.clear();const d=e.holes.pushNew();return d.from=c,d.to=Math.floor(e.vao.byteSize/s),e.updateDrawCommands(s),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const n of t.changes){const t=n.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const a=I.back();if(a){if(a.to===r.from){a.to=r.to;continue}if(a.from===r.to){a.from=r.from;continue}}const s=I.pushNew();s.from=r.from,s.to=r.to}M.mergeAdjacentRanges(I);const r=this._bufferWriter.vertexBufferLayout.stride/4,a=I.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,s=N(a);s.fill(0,0,a);const i=e.vao.vertexBuffers.geometry;I.forAll((e=>i.setSubData(s,e.from*r,0,e.numElements*r))),e.holes.pushArray(I.data,I.length),I.forAll(((e,t)=>I.data[t]=null)),I.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!R.hasVao(e))return void this._applyAndRebuild(e,t,null);const a=this._bufferWriter,s=a.vertexBufferLayout.stride/4,i=e.numElements,n=t.reduce(((e,t)=>e+a.elementCount(t.geometry)),0),o=Math.min((i+n)*s,V),l=4*o;if(e.vao.byteSize<z(V-P)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);M.mergeAdjacentRanges(e.holes);const u=new Array;for(const r of t){const t=a.elementCount(r.geometry),s=E(e.holes,t);u.push(s)}const h=e.vao.vertexBuffers.geometry;let c=0,d=0,f=0;const g=N(o),m=a.vertexBufferLayout.createView(g.buffer);t.forEach(((t,r)=>{const i=u[r];if(null==i)return;if(!(f===i)){const e=f-d;e>0&&h.setSubData(g,d*s,0,e*s),d=i,c=0}const n=a.elementCount(t.geometry);this._writeGeometry(t,m,c),c+=n,f=i+n;const o=new S.Instance(t,i,i+n);w.assert(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const p=f-d;p>0&&h.setSubData(g,d*s,0,p*s),r.filterInPlace(t,((e,t)=>null==u[t]))}_writeGeometry(e,t,r){if(null===this._bufferWriter)return;const a=e.localOrigin.vec3;w.setMatrixTranslation3(H,-a[0],-a[1],-a[2]);const s=d.multiply(x,H,e.transformation);d.invert(L,s),d.transpose(L,L),this._bufferWriter.write(s,L,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:r}=e;if(!this.material.produces(r.slot,t))return null;const a=t===m.ShaderOutput.Highlight||t===m.ShaderOutput.ShadowHighlight;if(a&&!this._hasHighlights)return null;const s=t===m.ShaderOutput.ShadowExcludeHighlight,i=!(a||s);for(const n of this._dataByOrigin.values())for(const o of n.buffers){if(a&&!o.hasHighlights)continue;const n=(a?o.drawCommandsHighlight:s&&o.needsMultipleCommands()?o.drawCommandsShadowHighlightRest:o.drawCommandsDefault)||null,l=i&&o.drawCommandsOccludees||null;if(n?.length||l?.length){const a=this._glMaterials.load(e.rctx,r.slot,t),s=null!=a?a.beginSlot(r):null;if(null!=s)return s}}return null}renderNode(e,t){const{output:r,bindParameters:a}=e,s=r===m.ShaderOutput.Highlight||r===m.ShaderOutput.ShadowHighlight,i=r===m.ShaderOutput.ShadowExcludeHighlight,n=!(s||i),o=e.rctx,l=e.bindParameters.slot===v.RenderSlot.OCCLUDER_MATERIAL,u=e.bindParameters.slot===v.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;o.runAppleAmdDriverHelper(),o.bindTechnique(t,this.material.parameters,a);for(const h of this._dataByOrigin.values())for(const e of h.buffers){if(s&&!e.hasHighlights)continue;const r=(s?e.drawCommandsHighlight:i&&e.needsMultipleCommands()?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,c=n&&e.drawCommandsOccludees||null;if(r?.length||c?.length){t.program.bindDraw(new O.DrawParameters(h.origin),a,this.material.parameters),t.ensureAttributeLocations(e.vao),o.bindVAO(e.vao),r?.length&&(o.setPipelineState(t.getPipeline(!1,l,u)),r.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),c?.length&&(o.setPipelineState(t.getPipeline(!0,l,u)),c.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count))))}}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}},t.__decorate([l.property({constructOnly:!0})],e.MergedRenderer.prototype,"material",void 0),e.MergedRenderer=t.__decorate([c.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],e.MergedRenderer);class B{constructor(e){this.origin=e,this.changes=new Array}}function E(e,t){let r;if(!e.some((e=>!(e.numElements<t)&&(r=e,!0))))return null;const a=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),a}const H=f.create(),x=f.create(),L=f.create(),I=new o({allocator:e=>e||new M.BufferRange,deallocator:null}),P=65536,T=4*P,W=1024,G=16777216,V=G/4;let U=new Float32Array(P);function N(e){return U.length<e&&(U=new Float32Array(e)),U}function z(e){const t=4*e;return t<=W?W:t<T?s.nextHighestPowerOfTwo(t):Math.max(Math.min(Math.ceil(1.5*t/T)*T,G),t)}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
