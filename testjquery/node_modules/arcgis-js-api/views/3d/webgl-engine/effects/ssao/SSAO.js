/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/time","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec2","../../core/FBOCache","../RenderPlugin","./SSAOBlurTechnique","./SSAONoiseData","./SSAOParameters","./SSAOTechnique","../../lib/RenderFeature","../../lib/RenderSlot","../../../../../chunks/SSAO.glsl","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,s,i,a,o,n,c,u,l,h,d,_,p,m,b,S,T,x,w,P,f){"use strict";const q=2;e.SSAO=class extends d.SyncRenderPlugin{constructor(e){super(e),this._context=null,this._passParameters=new m.SSAOPassParameters,this._drawParameters=new m.BlurDrawParameters,this.produces=new Map([[T.RenderSlot.SSAO,()=>this._produces()]])}_produces(){return null!=this._enableTime&&null!=this._context}consumes(){return this._produces()?d.ConsumesDepthNormal:d.ConsumesNone}initializeRenderContext(e){this._context=e,this.addHandles([s.watch((()=>this.view.qualitySettings.ambientOcclusion||this._context?.isFeatureEnabled(S.RenderFeature.SSAO)),(e=>e?this._enable():this._disable()),s.syncAndInitial)])}uninitializeRenderContext(){this._disable(),this._context=null}_disable(){this._passParameters.noiseTexture=r.disposeMaybe(this._passParameters.noiseTexture),this._enableTime=null}destroy(){this._disable()}_enable(){if(null!=this._enableTime||!this._context)return;const e=Uint8Array.from(atob(p.noiseData),(e=>e.charCodeAt(0))),t=new f.TextureDescriptor;t.wrapMode=w.TextureWrapMode.CLAMP_TO_EDGE,t.pixelFormat=w.PixelFormat.RGB,t.wrapMode=w.TextureWrapMode.REPEAT,t.hasMipmap=!0,t.width=32,t.height=32,this._passParameters.noiseTexture=new P.Texture(this._context.renderContext.rctx,t,e),null==this._ssaoTechnique&&(this._ssaoTechnique=this._context.techniqueRepository.acquire(b.SSAOTechnique)),null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(_.SSAOBlurTechnique)),this._enableTime=i.Milliseconds(0),this._context?.requestRender()}renderNode(e,t,r){const s=e.bindParameters,i=s.linearDepth?.colorTexture,a=r?.normal?.colorTexture;if(null==this._enableTime||null==this._context||null==i||!a)return;if(!this._ssaoTechnique.compiled||!this._blurTechnique.compiled)return this._enableTime=e.time,void this._context.requestRender();0===this._enableTime&&(this._enableTime=e.time);const o=e.rctx,n=s.camera,c=this.view.qualitySettings.fadeDuration,u=c>0?Math.min(c,e.time-this._enableTime)/c:1;this._passParameters.normalTexture=a,this._passParameters.depthTexture=i,this._passParameters.projScale=1/n.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*O/x.getRadius(n)**6*u;const d=n.fullViewport[2],_=n.fullViewport[3],p=Math.round(d/q),m=Math.round(_/q),b=this._context.fbos,S=b.acquire(h.ColorFormat.RED,d,_);o.bindFramebuffer(S.fbo),o.setViewport(0,0,d,_);o.bindTechnique(this._ssaoTechnique,this._passParameters,s).bindDraw(this._drawParameters,s,this._passParameters),o.screen.draw();const T=o.bindTechnique(this._blurTechnique,this._passParameters,s);o.setViewport(0,0,p,m);const P=b.acquire(h.ColorFormat.RED,p,m);o.bindFramebuffer(P.fbo),this._drawParameters.colorTexture=S.colorTexture,l.set(this._drawParameters.blurSize,0,q/_),T.bindDraw(this._drawParameters,s,this._passParameters),o.setViewport(0,0,p,m),o.screen.draw(),S.release();const f=b.acquire(h.ColorFormat.RED,p,m);return o.bindFramebuffer(f.fbo),o.setViewport(0,0,d,_),o.setClearColor(1,1,1,0),o.clear(w.ClearBufferBit.COLOR_BUFFER_BIT),o.setViewport(0,0,p,m),this._drawParameters.colorTexture=P.colorTexture,l.set(this._drawParameters.blurSize,q/d,0),T.bindDraw(this._drawParameters,s,this._passParameters),o.screen.draw(),o.setViewport4fv(n.fullViewport),P.release(),u<1&&this._context.requestRender(),f}},t.__decorate([a.property({constructOnly:!0})],e.SSAO.prototype,"view",void 0),t.__decorate([a.property()],e.SSAO.prototype,"_context",void 0),e.SSAO=t.__decorate([u.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],e.SSAO);const O=.5;e.blurSizePixels=q,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
