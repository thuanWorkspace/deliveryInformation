/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/colorUtils","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../ViewingMode","../../core/shaderLibrary/shading/ReadShadowMap.glsl","../RenderPlugin","./HighlightDefaults","./ShadowHighlightTechnique","../../lib/RenderSlot"],(function(e,t,i,a,s,r,h,o,c,n,d,l,p,u,_,w,g,m){"use strict";const y=.001953125,S=4e4,f=5e4;e.ShadowHighlight=class extends _.SyncRenderPlugin{constructor(e){super(e),this._maxOpacity=1,this._passParameters=new g.ShadowHighlightPassParameters,this._drawParameters=new u.ReadShadowMapDrawParameters,this._shadowDifference=.2,this._context=null,this.produces=new Map([[m.RenderSlot.SHADOW_HIGHLIGHT,()=>this._isVisible]])}consumes(){return _.ConsumesHighlight}initializeRenderContext(e){this._context=e,this.addHandles([s.watch((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??w.defaultShadowOpacity,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),s.syncAndInitial),s.watch((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??w.defaultShadowDifference,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),s.syncAndInitial),s.watch((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=i.unitRGBAFromColor(e??w.defaultShadowColor),this._updateMaxOpacity()}),s.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}uninitializeRenderContext(){this._context=null}enable(){this._context&&null==this._technique&&(this._technique=this._context.techniqueRepository.acquire(g.ShadowHighlightTechnique))}renderNode(e,t,i,a){const s=i?.highlight?.colorTexture;if(!(this._context&&i&&s&&this._isVisible))return;if(!this._technique?.compiled)return void this._context.requestRender();const r=e.bindParameters;if(!r.shadowMap.enabled||!r.linearDepth)return;const h=e.rctx,o=this._technique;this._passParameters.highlight=s,this._drawParameters.origin=r.camera.center,h.bindFramebuffer(a?.fbo),h.bindTechnique(o,this._passParameters,r).bindDraw(this._drawParameters,r,this._passParameters),h.screen.draw()}updateParameters(e,t){this._passParameters.opacityElevation=1-a.smoothstep(S,f,e.relativeElevation);const i=this.viewingMode===p.ViewingMode.Global?d.normalize(O,e.center):d.set(O,0,0,1),s=d.dot(i,t);this._passParameters.dayNightTerminator=a.smoothstep(0,1,a.clamp(30*s,0,1)),this._isVisible&&this.enable()}get _isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=y}},t.__decorate([r.property()],e.ShadowHighlight.prototype,"_context",void 0),t.__decorate([r.property()],e.ShadowHighlight.prototype,"view",void 0),t.__decorate([r.property()],e.ShadowHighlight.prototype,"viewingMode",void 0),e.ShadowHighlight=t.__decorate([n.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],e.ShadowHighlight);const O=l.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
