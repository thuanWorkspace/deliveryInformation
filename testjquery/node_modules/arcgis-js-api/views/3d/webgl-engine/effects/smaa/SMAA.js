/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../core/FBOCache","../RenderPlugin","./SMAABlendWeightsTechnique","./SMAABlurTechnique","./SMAAEdgeDetectTechnique","./SMAAPassParameters","../../lib/RenderFeature","../../lib/RenderSlot","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,s,i,a,o,n,l,u,h,c,d,_,b,p,T,x,A,m,g,q,C){"use strict";function S(e,t,r,s){const i=new C.TextureDescriptor;return i.pixelFormat=r,i.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,i.width=s.width,i.height=s.height,i.samplingMode=t,new q.Texture(e,i,s)}t.SMAA=class extends _.SyncRenderPlugin{constructor(e){super(e),this._context=null,this._areaTexture=null,this._searchTexture=null,this._isEnabled=!1,this._smaaParameters=new x.SMAAPassParameters,this.produces=new Map([[m.RenderSlot.ANTIALIASING,()=>this._isEnabled&&null!=this._context]])}consumes(){return _.ConsumesCompositeColor}get updating(){return null!=this._abortController}initializeRenderContext(e){this._context=e,this.addHandles([a.watch((()=>this.view.qualitySettings.antialiasingEnabled),(e=>e||this._context?.isFeatureEnabled(A.RenderFeature.Antialiasing)?this.enable():this.disable()),a.syncAndInitial)])}renderFeatureChanged(){this.view.qualitySettings.antialiasingEnabled||this._context?.isFeatureEnabled(A.RenderFeature.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable(),this._context=null}enable(){if(this._isEnabled||!this._context||this._abortController)return;if(null==this._edgeTechnique&&(this._edgeTechnique=this._context.techniqueRepository.acquire(T.SMAAEdgeDetectTechnique)),null==this._blendTechnique&&(this._blendTechnique=this._context.techniqueRepository.acquire(b.SMAABlendWeightsTechnique)),null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(p.SMAABlurTechnique)),this._areaTexture&&this._searchTexture)return void(this._isEnabled=!0);this._abortController=new AbortController;const t=this._abortController.signal;new Promise(((t,r)=>e(["./SMAAData"],t,r))).then((e=>this._loadTextures(this._context,e,t))).then((()=>{this._context?.requestRender(),this._abortController=null})).catch((e=>{i.isAbortError(e)||this._disposeTextures()}))}_loadTextures(e,t,r){return i.throwIfAborted(r),e?Promise.all([c.requestImage(t.areaTexture).then((t=>S(e.fbos.rctx,g.TextureSamplingMode.LINEAR,g.PixelFormat.RGB,t))),c.requestImage(t.searchTexure).then((t=>S(e.fbos.rctx,g.TextureSamplingMode.NEAREST,g.PixelFormat.LUMINANCE,t)))]).then((([e,t])=>{i.isAborted(r)?(e.dispose(),t.dispose(),i.throwIfAborted(r)):(this._areaTexture=e,this._searchTexture=t,this._isEnabled=!0)})):Promise.reject()}_disposeTextures(){this._areaTexture=s.disposeMaybe(this._areaTexture),this._searchTexture=s.disposeMaybe(this._searchTexture)}disable(){this._abortController=s.abortMaybe(this._abortController),this._isEnabled=!1}destroy(){this.disable(),this._disposeTextures()}renderNode(e,t,r,s){const i=r?.composite?.colorTexture;if(!(this._isEnabled&&this._context&&r&&i))return s;if(!(this._edgeTechnique?.compiled&&this._blendTechnique?.compiled&&this._blurTechnique?.compiled))return this._context.requestRender(),s;const a=i.descriptor.width,o=i.descriptor.height,n=this._context.fbos,l=e.rctx;l.setViewport(0,0,a,o);const u=n.acquire(d.ColorFormat.RG,a,o);l.bindFramebuffer(u.fbo),l.setClearColor(0,0,0,1),l.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),this._smaaParameters.color=i,l.bindTechnique(this._edgeTechnique,this._smaaParameters),l.screen.draw();const h=n.acquire(d.ColorFormat.RGBA,a,o);return l.bindFramebuffer(h.fbo),l.setClearColor(0,0,1,1),l.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=u.colorTexture,this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(this._blendTechnique,this._smaaParameters),l.screen.draw(),l.bindFramebuffer(s?.fbo),u.release(),l.setClearColor(0,1,0,1),l.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=h.colorTexture,l.bindTechnique(this._blurTechnique,this._smaaParameters),l.screen.draw(),h.release(),s}},r.__decorate([o.property()],t.SMAA.prototype,"view",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_context",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_abortController",void 0),r.__decorate([o.property({readOnly:!0})],t.SMAA.prototype,"updating",null),t.SMAA=r.__decorate([h.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],t.SMAA),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
