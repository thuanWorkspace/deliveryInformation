/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/vec3f64","../output/BlendOptions","./BackgroundGrid.glsl","../util/BlendModes.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/interfaces","../../shaderModules/Texture2DPassUniform"],(function(o,e,r,l,a,t,s,u,d){"use strict";var c,i,n;o.BlendLayersOutput=void 0,(c=o.BlendLayersOutput||(o.BlendLayersOutput={}))[c.Composite=0]="Composite",c[c.ColorComposite=1]="ColorComposite",c[c.GridComposite=2]="GridComposite",c[c.GroupBackgroundComposite=3]="GroupBackgroundComposite",c[c.COUNT=4]="COUNT",o.BaseOpacityMode=void 0,(i=o.BaseOpacityMode||(o.BaseOpacityMode={}))[i.NotRequired=0]="NotRequired",i[i.Required=1]="Required",i[i.COUNT=2]="COUNT",o.PremultipliedAlphaSource=void 0,(n=o.PremultipliedAlphaSource||(o.PremultipliedAlphaSource={}))[n.Off=0]="Off",n[n.On=1]="On",n[n.COUNT=2]="COUNT";class p extends u.NoParameters{constructor(){super(...arguments),this.baseOpacity=1,this.backgroundColor=e.ZEROS,this.fboTexture=null}}function g(e,c){const i=c.output===o.BlendLayersOutput.GridComposite,n=c.output===o.BlendLayersOutput.ColorComposite,p=c.output===o.BlendLayersOutput.GroupBackgroundComposite,g=c.output===o.BlendLayersOutput.Composite;i&&e.fragment.include(l.BackgroundGrid),n&&e.fragment.uniforms.add(new t.Float3PassUniform("backgroundColor",(o=>o.backgroundColor)));const m=c.baseOpacityMode===o.BaseOpacityMode.Required;m&&e.fragment.uniforms.add(new s.FloatPassUniform("baseOpacity",(o=>o.baseOpacity))),g&&e.fragment.uniforms.add(new d.Texture2DPassUniform("fboColor",(o=>o.fboTexture)));const y=c.blendMode!==r.LayerBlendMode.Normal,C=c.premultipliedSource===o.PremultipliedAlphaSource.On;e.fragment.include(a.BlendModes,c),e.fragment.code.add(u.glsl`
    vec4 getBackground(vec2 uv) {
      return ${m?u.glsl`baseOpacity *`:""} ${p?u.glsl`vec4(0.0, 0.0, 0.0, 0.0)`:n?u.glsl`vec4(backgroundColor, 1.0)`:i?u.glsl`vec4(gridColor(uv), 1.0)`:u.glsl`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${y?u.glsl`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:u.glsl`
          float composeAlpha = colorLayer.a * opacity;
          return ${!C&&(g&&!m||p)?u.glsl`colorLayer * opacity;`:u.glsl`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}o.TileBackground=g,o.TileBackgroundPassParameters=p,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
