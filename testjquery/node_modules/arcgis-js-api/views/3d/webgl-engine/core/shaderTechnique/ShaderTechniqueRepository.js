/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/NestedMap","./ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";class n{constructor(e){this._context=e,this._perConstructorInstances=new t.NestedMap,this._frameCounter=0,this._keepAliveFrameCount=o}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=c){const r=t.key;let n=this._perConstructorInstances.get(e,r);if(null==n){const o=new e(this._context,t,(()=>this.release(o)));n=new s(o),this._perConstructorInstances.set(e,r,n)}return++n.refCount,n.technique}releaseAndAcquire(e,t,r){if(null!=r){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==o&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,r)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,r))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{const n=async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>e.technique.reload(this._context))))};e.push(n(t,r))})),await Promise.all(e)}}class s{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const o=-1,c=new r.ShaderTechniqueConfiguration;e.ShaderTechniqueRepository=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
