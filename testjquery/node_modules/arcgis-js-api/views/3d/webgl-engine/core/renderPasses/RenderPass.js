/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/PooledArray","../../lib/TransparencyPassType","../../../../webgl/enums"],(function(e,t,r,a){"use strict";var n;e.RenderPassSorting=void 0,(n=e.RenderPassSorting||(e.RenderPassSorting={}))[n.FrontToBack=0]="FrontToBack",n[n.BackToFront=1]="BackToFront";class s{constructor(r,a,n=e.RenderPassSorting.FrontToBack){this._rctx=r,this._techniqueRepository=a,this._sorting=n,this._draws=new t({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,a){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=r,n.material=e,n.depthSquaredHint=a,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0}prepare(e,t){return this._draws.map((r=>r.material.prepareTechnique(this._techniqueRepository,e,t,r.geometry.parameters)))}dispatch(e,t,a){const n=this._rctx;this._previouslyBoundDraw.clear();let s=null;const o=this._draws.length;for(let d=0;d<o;d++){const o=a[d];o===s&&o.configuration.transparencyPassType===r.TransparencyPassType.NONE||(n.bindTechnique(o,e,t),s=o);const p=this._draws.data[d],l=p.geometry;n.bindVAO(l.vao),this._previouslyBoundDraw.get(o)!==p.material&&(o.program.bindDraw(p.material,t,e),this._previouslyBoundDraw.set(o,p.material));const c=p.geometryRanges,u=c.length;if(0!==p.indexType){const e=i.get(p.indexType);for(let t=0;t<u;t+=2){const r=c[t],a=c[t+1];n.drawElements(l.primitiveType,a,p.indexType,r*e)}}else for(let e=0;e<u;e+=2){const t=c[e],r=c[e+1];n.drawArrays(l.primitiveType,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const t=this._sorting===e.RenderPassSorting.FrontToBack?1:-1;this._draws.sort(((e,r)=>{const a=t*(e.depthSquaredHint-r.depthSquaredHint);return 0!==a?a:e.geometry.vao.byteSize-r.geometry.vao.byteSize}))}get count(){return this._draws.length}}const i=new Map;i.set(a.DataType.UNSIGNED_BYTE,1),i.set(a.DataType.UNSIGNED_SHORT,2),i.set(a.DataType.UNSIGNED_INT,4),e.RenderPass=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
