/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat3","../../../../../chunks/mat3f64","../../../../../chunks/mat4","../../../../../chunks/vec3","../../../../../chunks/vec3f64","./AllRenderPasses","./RenderPass","../shaderLibrary/ShaderOutput","../util/TwoVectorPosition","../../effects/RenderPlugin","../../lib/depthRange","../../lib/RenderSlot"],(function(e,s,t,a,r,i,h,n,o,u,d,p,l,c,m,P,g,_,S,R){"use strict";e.RenderPassManager=class extends _.SyncPreparesRenderPlugin{constructor(){super({}),this._passes=null,this.produces=new Map([[R.RenderSlot.OPAQUE_MATERIAL,e=>this._produces(e)],[R.RenderSlot.TRANSPARENT_MATERIAL,e=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(e)],[R.RenderSlot.INTEGRATED_MESH,e=>this._produces(e)]]),this._materialPassParameters=new c.MaterialPassParameters,this._shadowPassParameters=new c.ShadowMapPassParameters,this._highlightPassParameters=new c.HighlightPassParameters,this._systems=new Set}initializeRenderContext(e){this._context=e;const s=e.renderContext.rctx,t=e.techniqueRepository;this._passes={materialOpaque:new m.RenderPass(s,t),materialTransparent:new m.RenderPass(s,t,m.RenderPassSorting.BackToFront),materialIntegratedMesh:new m.RenderPass(s,t),shadowMap:new m.RenderPass(s,t),highlight:new m.RenderPass(s,t),highlightIntegratedMesh:new m.RenderPass(s,t),highlightShadowMap:new m.RenderPass(s,t),defaultShadowMap:new m.RenderPass(s,t)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e){return 0!==this._systems.size&&null!==this._passes&&(e===P.ShaderOutput.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==P.ShaderOutput.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(e){if(0!==this._systems.size&&null!==this._passes){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((s=>s.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this._context.techniqueRepository.frameUpdate()}}prepareTechniques(e){if(0===this._systems.size)return null;const s=e.output===P.ShaderOutput.Shadow||e.output===P.ShaderOutput.ShadowHighlight||e.output===P.ShaderOutput.ShadowExcludeHighlight?this._shadowPassParameters:e.output===P.ShaderOutput.Highlight?this._highlightPassParameters:this._materialPassParameters,t=e.bindParameters;return this._updateParameters(t.camera,s,t.slot===R.RenderSlot.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,((s,t)=>s.prepare(t,e.bindParameters)))}renderNode(e,s){this._invoke(e,((t,a)=>t.dispatch(a,e.bindParameters,s)))}_invoke(e,s){if(null===this._passes)return null;switch(e.bindParameters.slot){case R.RenderSlot.OPAQUE_MATERIAL:switch(e.output){case P.ShaderOutput.Color:case P.ShaderOutput.Depth:case P.ShaderOutput.Normal:case P.ShaderOutput.ObjectAndLayerIdColor:return s(this._passes.materialOpaque,this._materialPassParameters);case P.ShaderOutput.Highlight:return s(this._passes.highlight,this._highlightPassParameters);case P.ShaderOutput.Shadow:return s(this._passes.shadowMap,this._shadowPassParameters);case P.ShaderOutput.ShadowHighlight:return s(this._passes.highlightShadowMap,this._shadowPassParameters);case P.ShaderOutput.ShadowExcludeHighlight:return s(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case R.RenderSlot.TRANSPARENT_MATERIAL:switch(e.output){case P.ShaderOutput.Color:case P.ShaderOutput.Alpha:case P.ShaderOutput.Depth:case P.ShaderOutput.Normal:case P.ShaderOutput.ObjectAndLayerIdColor:return s(this._passes.materialTransparent,this._materialPassParameters)}break;case R.RenderSlot.INTEGRATED_MESH:switch(e.output){case P.ShaderOutput.Color:case P.ShaderOutput.Depth:case P.ShaderOutput.Normal:case P.ShaderOutput.ObjectAndLayerIdColor:return s(this._passes.materialIntegratedMesh,this._materialPassParameters);case P.ShaderOutput.Highlight:return s(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const s=new S.DepthRange;return this._systems.forEach((t=>S.union(s,t.queryShadowCasterDepthRange(e)))),s}_updateParameters(e,s,t){const a=e.viewInverseTransposeMatrix;p.set(w,a[3],a[7],a[11]),M.set(w),p.copy(s.transformWorldFromViewTH,M.high),p.copy(s.transformWorldFromViewTL,M.low),p.copy(s.slicePlaneLocalOrigin,w),o.fromMat4(s.transformViewFromCameraRelativeRS,e.viewMatrix),d.copy(s.transformProjFromView,e.projectionMatrix),s.identifier===c.RenderPassIdentifier.Material&&(this._materialPassParameters.transparent=t,o.transpose(O,s.transformViewFromCameraRelativeRS),o.invert(s.transformNormalViewFromGlobal,O))}},e.RenderPassManager=s.__decorate([n.subclass("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],e.RenderPassManager);const w=l.create(),O=u.create(),M=new g.TwoVectorPosition;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
