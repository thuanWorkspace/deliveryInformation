/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils","../layers/graphics/ElevationQuery"],(function(e,t,r,n,o,i,s,a,l,c,u,h,d,v){"use strict";function p(e,t,r,n,o,i,s){for(const a of t){const t=a.getElevation(r,n,o,i,s);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e.CombinedElevationProvider=class extends(n.EventedMixin(r)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=o.destroyMaybe(this._elevationQueryCached)}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,r,n,o){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const i=this.lastElevationQuery;if(e===i.x&&t===i.y&&r===i.z&&d.equals(n,i.spatialReference)&&o===i.queryContext)return i.result}let i=null;return i=p(i,this._im,e,t,r,n,o),null==i&&(i=p(i,this._ground,e,t,r,n,o)),"scene"===o&&(i=p(i,this._scene,e,t,r,n,o)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:n,queryContext:o,result:i}),i}getSphereElevationBounds(e,t){let r=1/0,n=-1/0;for(const o of[this._im,this._ground,this._scene])o.forEach((o=>{if(o.getSphereElevationBounds){const i=o.getSphereElevationBounds(e,t);null!=i&&(r=Math.min(r,i.min),n=Math.max(n,i.max))}}));return{min:r,max:n}}getRootElevationBounds(){let e=1/0,t=-1/0;for(const r of[this._im,this._ground,this._scene])r.forEach((r=>{if(r.getRootElevationBounds){const n=r.getRootElevationBounds();null!=n&&(e=Math.min(e,n.min),t=Math.max(t,n.max))}}));return{min:e,max:t}}async queryElevation(e,t,r,n,o,s=null,a=0){const l=this._getElevationQuery(n);try{const i=await l.queryElevation(e,t,s,a);return"scene"===o?p(i,this._scene,e,t,r,n,o):i}catch(c){return i.throwIfAbortError(c),this.getElevation(e,t,r,n,o)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._elevationQueryCached;if(null!=t&&d.equals(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:r,wkt:n,wkt2:o,latestWkid:i}=e,s=new v.ElevationQuery(this.view.resourceController.scheduler,new h({wkid:r,wkt:n,wkt2:o,latestWkid:i}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._elevationQueryCached=s,s}},t.__decorate([s.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),t.__decorate([s.property()],e.CombinedElevationProvider.prototype,"spatialReference",null),e.CombinedElevationProvider=t.__decorate([u.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
