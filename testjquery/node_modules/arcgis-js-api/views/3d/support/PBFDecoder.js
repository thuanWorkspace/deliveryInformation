/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../Graphic","../../../core/typedArrayUtil","../../../core/workers/WorkerHandle","../../../geometry/SpatialReference","../../../layers/support/Field"],(function(e,r,t,s,o,a){"use strict";class n{constructor(e){this._controller=e,this._handle=new l((r=>e.schedule(r)))}destroy(){this._handle.destroy()}invoke(e,t){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof o&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,t).then((e=>{let t=0,s=0;const n=o.fromJSON(e.spatialReference);e.spatialReference=n;const l=async o=>{if(e.fields)for(;t<e.fields.length;)if(e.fields[t]=a.fromJSON(e.fields[t]),t++,o.madeProgress())return this._controller.reschedule((e=>l(e)));for(;s<e.features.length;){const t=e.features[s];if(++s,t.uid=r.generateUID(),null!=t.geometry&&(t.geometry.spatialReference=n,i(t.geometry),o.madeProgress()))return this._controller.reschedule((e=>l(e)))}return e};return this._controller.schedule((e=>l(e)))}))):Promise.resolve(null)}}function i(e){switch(e.type){case"polyline":e.paths.reduce(((e,r)=>e+r.length),0)<t.nativeArrayMaxSize&&(e.paths=e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]])))));break;case"polygon":e.rings.reduce(((e,r)=>e+r.length),0)<t.nativeArrayMaxSize&&(e.rings=e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]])))))}}class l extends s.WorkerHandle{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}e.PBFDecoder=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
