/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../ViewingMode","../../../chunks/SunCalc","./mathUtils"],(function(t,e,n,o,i,l,a,r,c,s,u){"use strict";const m={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class d{constructor(t,e){this.direct=t,this.ambient=e}}function f(t,n,o,i,l,c){a.set(c.ambient.color,1,1,1),c.ambient.intensity=m.global.ambient,a.set(c.direct.color,1,1,1),c.direct.intensity=m.global.direct;const u=n[2],d=e.clamp((Math.abs(u)-m.local.altitude)/(m.global.altitude-m.local.altitude),0,1);let f;if(c.globalFactor=d,null!=t&&(f=s.SunCalc.getTimes(t,n[1],n[0])),d<1){let n;if(null!=t)n=X(t,f,i);else{const t=S(i);n={direct:{intensity:m.local.directAtNoon*t.direct,color:r.fromValues(1,1,1)},ambient:{intensity:m.local.ambientAtNoon*t.ambient,color:r.fromValues(1,1,1)},timeOfDay:"early afternoon"}}a.lerp(c.ambient.color,n.ambient.color,c.ambient.color,d),c.ambient.intensity=e.lerp(n.ambient.intensity,c.ambient.intensity,d),a.lerp(c.direct.color,n.direct.color,c.direct.color,d),c.direct.intensity=e.lerp(n.direct.intensity,c.direct.intensity,d),c.specularStrength="rainy"===i||"snowy"===i||"foggy"===i?0:1,c.environmentStrength="rainy"===i?.7:"snowy"===i||"foggy"===i?.75:1}c.noonFactor=null!=t?M(t,f):1,null!=t?h(t,n,o,c.direct.directionToLightSource):g(l,o,c.direct.directionToLightSource)}function g(t,e,o){e===c.ViewingMode.Global?a.normalize(Z,t.eye):a.set(Z,0,0,1),a.scale(q,t.viewForward,-1);const i=u.angle(q,Z),l=Math.max(i-2*J,0),r=.85*l/(l+1),s=Math.max(J,i-J-r);n.fromRotation(Y,-s,t.viewRight),a.transformMat4(o,q,Y),a.add(o,o,a.scale(B,t.viewRight,K)),a.normalize(o,o)}function h(t,o,i,l){const r=V,u=n.identity(w);if(i===c.ViewingMode.Global)s.SunCalc.getPosition(t,0,0,r),a.set(l,0,0,-1),n.rotateX(u,u,-r.azimuth),n.rotateY(u,u,-r.altitude),a.transformMat4(l,l,u);else{const i=m.planarDirection,c=i.globalAngles,d=o[2];let f=(Math.abs(d)-i.localAltitude)/(i.globalAltitude-i.localAltitude);f=e.clamp(f,0,1),f<1?(s.SunCalc.getPosition(t,o[1],o[0],r),r.azimuth=(1-f)*r.azimuth+f*c.azimuth,r.altitude=(1-f)*r.altitude+f*c.altitude):(r.azimuth=c.azimuth,r.altitude=c.altitude),a.set(l,0,-1,0),n.rotateZ(u,u,-r.azimuth),n.rotateX(u,u,-r.altitude),a.transformMat4(l,l,u)}}function p(t,e){if(e===c.ViewingMode.Global)return!0;const n=m.planarDirection;return Math.abs(t)<n.localAltitude}function b(t,e,n,o,i){const l=t.getTime(),a=e.getTime()-l,c=Math.floor(a/n)+1,s=new Array(c);for(let u=0;u<c;++u)j.setTime(l+n*u),s[u]=r.create(),h(j,o,i,s[u]);return s}const y=r.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);class A{constructor(){this.ambient={color:r.fromValues(1,1,1),intensity:.55},this.direct={color:r.fromValues(1,1,1),intensity:.55,directionToLightSource:r.clone(y)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const w=o.create(),V={azimuth:0,altitude:0};function M(t,n){const o=t.valueOf();let i,l;n.polarException===s.SunCalc.PolarException.MIDNIGHT_SUN?(i=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,l=i+432e6):n.polarException===s.SunCalc.PolarException.POLAR_NIGHT?(i=o-2,l=o-1):(i=n.sunrise.valueOf(),l=n.sunset.valueOf());const a=i+(l-i)/2;return 1-e.clamp(Math.abs(o-a)/432e5,0,1)}function S(t){switch(t){case"disabled":case"sunny":case"cloudy":return new d(1,1);case"rainy":return new d(.4,1.2);case"snowy":return new d(.5,1.3);case"foggy":return new d(.2,1.6)}}function v(t,e){const n=(t[0]+t[1]+t[2])/3;t[0]+=(n-t[0])*e,t[1]+=(n-t[1])*e,t[2]+=(n-t[2])*e}const T=r.fromValues(.01,.01,.01),N=r.fromValues(1,.6,.5),O=r.fromValues(1,.98,.98),x=r.fromValues(1,1,1),z=r.fromValues(.8,.8,1),P=r.fromValues(.8,.8,1),C=r.fromValues(.98,.98,1),D=r.fromValues(1,1,1),I=l.fromValues(.01,m.local.ambientAtNight),E=l.fromValues(m.local.directAtTwilight,m.local.ambientAtTwilight),k=l.fromValues(.9*m.local.directAtNoon,m.local.ambientAtNoon),G=l.fromValues(m.local.directAtNoon,m.local.ambientAtNoon),H=k,L=O,F=C,R=E,U=N,_=P;function X(t,e,n){const o=t.valueOf();let c,u;e.polarException===s.SunCalc.PolarException.MIDNIGHT_SUN?(c=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,u=c+432e6):e.polarException===s.SunCalc.PolarException.POLAR_NIGHT?(c=o-2,u=o-1):(c=e.sunrise.valueOf(),u=e.sunset.valueOf());const m=u-c,d=c+m/2,f=m/4,g=d-f,h=d+f,p=.06*m,b=c-p/2,y=c+p/2,A=u-p/2,w=u+p/2,V=l.create(),M=r.create(),X=r.create();let j="";if(o<b||o>w)i.copy(V,I),a.copy(M,T),a.copy(X,z),j="night";else if(o<y){const t=(o-b)/(y-b);i.lerp(V,I,E,t),a.lerp(M,T,N,t),a.lerp(X,z,P,t),j="sun rising"}else if(o<g){const t=(o-y)/(g-y);i.lerp(V,E,k,t),a.lerp(M,N,O,t),a.lerp(X,P,C,t),j="early morning"}else if(o<d){const t=(o-g)/(d-g);i.lerp(V,k,G,t),a.lerp(M,O,x,t),a.lerp(X,C,D,t),j="late morning"}else if(o<h){const t=(o-d)/(h-d);i.lerp(V,G,H,t),a.lerp(M,x,L,t),a.lerp(X,D,F,t),j="early afternoon"}else if(o<A){const t=(o-h)/(A-h);i.lerp(V,H,R,t),a.lerp(M,L,U,t),a.lerp(X,F,_,t),j="late afternoon"}else if(o<w){const t=(o-A)/(w-A);i.lerp(V,R,I,t),a.lerp(M,U,T,t),a.lerp(X,_,z,t),j="sun setting"}let Y=0;switch(n){case"rainy":case"foggy":Y=.8;break;case"snowy":Y=.5}Y>0&&(v(M,Y),v(X,Y));const Z=S(n);return{direct:{intensity:V[0]*Z.direct,color:M},ambient:{intensity:V[1]*Z.ambient,color:X},timeOfDay:j}}const j=new Date(0),Y=o.create(),Z=r.create(),q=r.create(),B=r.create(),J=.25,K=.2;t.ColorAndIntensity=A,t.computeColorAndIntensity=f,t.computeDirectionsOverTime=b,t.computeShadowsEnabled=p,t.computeVirtualLightDirection=g,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
