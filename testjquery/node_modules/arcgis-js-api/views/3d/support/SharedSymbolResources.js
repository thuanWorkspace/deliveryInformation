/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/arrayUtils","../../../core/Handles","../../../core/handleUtils","../../../core/maybe","../../../core/reactiveUtils","../../../geometry/ellipsoidUtils","../layers/graphics/ObjectResourceCache","./index","./StreamTextureCollection","../webgl-engine/lib/screenSizePerspectiveUtils"],(function(e,t,s,r,i,n,c,a,l,o,d){"use strict";class h{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(l.ClientType.SYMBOLOGY),this.objectResourceCache=new a.ObjectResourceCache(((t,s)=>e.resourceController.memoryController.newCache(t,s))),this.textures=new o.StreamTextureCollection(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=c.getReferenceEllipsoid(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=d.getSettings(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=d.getLabelSettings(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return r.makeHandle();this._graphicsOwners.push(e);const s=n.watch((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),r.makeHandle((()=>{s.remove(),t.removeUnordered(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new s;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([n.watch((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,n.sync),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=i.destroyMaybe(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;S.distance=e.centerOnSurfaceInfrequent.distance,S.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(S),this.screenSizePerspectiveSettingsLabels.update(S),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}}const S={distance:0,fovY:0};e.SharedSymbolResources=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
