/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Point","../../../geometry/projection","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectPointToVectorWithEngine","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToPointWithEngine","../../../geometry/projection/projectVectorToVector","../../ViewingMode","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical","./earthUtils","./ElevationProvider","../../support/spatialReferenceSupport"],(function(e,t,n,r,o,i,a,c,l,s,u,f,d,p,m,g,h,y,v,T,w,S,M,R){"use strict";const x=r.getLogger("esri.views.3d.support.cameraUtils"),P=39.37,A=96,C=1,b=8,j=5,V=1,z=c.create(),E={heading:0,tilt:0},D=c.create(),O=new n.Cyclical(-20037508.342788905,20037508.342788905),U=new n.Cyclical(-180,180);var I;function H(e){return e.spatialReference??f.WGS84}function G(e){return"global"===e.viewingMode?w.cameraUtilsSpherical:T.cameraUtilsPlanar}function L(e,t,n,r,o){return G(e).headingTiltToDirectionUp(t,n,r,o)}function W(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=G(e).headingTiltToDirectionUp,i=c.create();if(!d.projectPointToVector(t.position,i,n))return null;const l=r(i,t.heading,t.tilt);a.scale(l.direction,l.direction,e.state.camera.distance),a.add(l.direction,l.direction,i);const s=v.cameraOnContentAlongViewDirection(e,i,l.direction,l.up);return s.fov=o.deg2rad(t.fov),s}e.OrientationMode=void 0,(I=e.OrientationMode||(e.OrientationMode={}))[I.LOCKED=0]="LOCKED",I[I.ADJUST=1]="ADJUST";const k=c.create();function q(e,n,r){const i=e.renderSpatialReference,a=Y(e,n.eye,n.viewForward,n.up,E);let c=H(e);return h.projectVectorToVector(n.eye,i,k,c)||(c=f.WGS84,h.projectVectorToVector(n.eye,i,k,c)),null==r?new t(new s(k,c),a.heading,a.tilt,o.rad2deg(n.fov)):(r.position.x=k[0],r.position.y=k[1],r.position.z=k[2],r.position.spatialReference=c,r.heading=a.heading,r.tilt=a.tilt,r.fov=o.rad2deg(n.fov),r)}function F(e,t,n){const r=e.state.camera,i=r.width/2/r.pixelRatio;e.renderCoordsHelper.viewingMode===y.ViewingMode.Global&&null!=n&&(t*=Math.cos(o.deg2rad(n))),t/=e.renderCoordsHelper.unitInMeters;return i/(A*P/t)/Math.tan(r.fovX/2)}function J(e,t,n){const r=e.state.camera,i=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let c=A*P/(a/i);return e.renderCoordsHelper.viewingMode===y.ViewingMode.Global&&null!=n&&(c/=Math.cos(o.deg2rad(n))),c*e.renderCoordsHelper.unitInMeters}async function X(e,t,n,r,o,i){return Z(e,t,F(e,n,t.latitude),r,o,i)}function K(e,t,n,r,o,i){return Te(e,_(e,r.heading,r.tilt,t,n,o),r.fov,i)}async function Z(e,t,n,r,o,a){const c=await ee(e,r.heading,r.tilt,t,n,o,a);return i.throwIfAborted(a),we(e,c,r.fov,a)}function Y(e,t,n,r,o){return G(e).directionToHeadingTilt(t,n,r,o)}function N(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,D,e.spatialReference)&&e.elevationProvider&&(M.getElevationAtPoint(e.elevationProvider,D)??0)>D[2]-V)}async function B(e,t,n){if(N(e,t))return!0;const{elevationProvider:r,spatialReference:o,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,D,o))return!1;const[c,l,s]=D,u=await r.queryElevation(c,l,s,o,"ground",n)??0;return i.throwIfAborted(n),u>s-V}async function Q(e,t,n){const r=c.create();if(null==t)return a.copy(r,e.state.camera.center);if(t instanceof s){const{renderSpatialReference:o,basemapTerrain:a,elevationProvider:c}=e,l=t.spatialReference;if(await p.projectPointToVectorWithEngine(t,r,o,0,{signal:n}),i.throwIfAborted(n),null==t.z&&null!=a&&null!=c){const o=await c.queryElevation(t.x,t.y,t.z??0,l,"ground",n);i.throwIfAborted(n),null!=o&&e.renderCoordsHelper.setAltitude(r,o)}return r}return a.copy(r,t)}function $(e,t){const n=c.create();if(null==t)return a.copy(n,e.state.camera.center);if(t instanceof s){if(!d.projectPointToVector(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:o}=e;if(null==t.z&&null!=r&&null!=o){const r=M.getElevationAtPoint(o,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return a.copy(n,t)}function _(e,t,n,r,o,i){return te(e,t,n,r instanceof s?r:null,$(e,r),o,i)}async function ee(e,t,n,r,o,a,c){const l=r instanceof s?r:null,u=await Q(e,r,c);return i.throwIfAborted(c),ne(e,t,n,l,u,o,a,c)}function te(e,t,n,r,o,i,a){if(null==o)return null;if(r??(r=m.projectVectorToPoint(o,e.renderSpatialReference,H(e))),null==r)return null;const c=re(e,t,n,o,i,a);if(oe(e,n,a)&&N(e,c.eye)){const{tilt:a,mode:c}=ie(e,n,o,i);return te(e,t,a,r,o,i,c)}return ae(c,o)}async function ne(e,t,n,r,o,a,c,l){r??(r=await g.projectVectorToPointWithEngine(o,e.renderSpatialReference,H(e),{signal:l})),i.throwIfAborted(l);const s=re(e,t,n,o,a,c);if(oe(e,n,c)&&await B(e,s.eye,l)){i.throwIfAborted(l);const{tilt:c,mode:s}=ie(e,n,o,a);return ne(e,t,c,r,o,a,s,l)}return ae(s,o)}function re(e,t,n,r,o,i){const a=pe(e,t,n,r,o=Math.max(o,e.state.constraints.minimumPoiDistance),i);return(0,G(e).eyeForCenterWithHeadingTilt)(r,o,a.heading,a.tilt)}function oe(t,n,r){const o=t.map.ground.navigationConstraint;return r===e.OrientationMode.ADJUST&&"global"===t.viewingMode&&n>0&&(null==o||"stay-above"===o.type)}function ie(t,n,r,o){const i=ye(t,r,o,he(t,o,n,r));return{tilt:i,mode:n-i<1?e.OrientationMode.LOCKED:e.OrientationMode.ADJUST}}function ae(e,t){return{...e,center:c.clone(t)}}function ce(e,t){const{state:n,spatialReference:r}=e,o=t.spatialReference;return n.isGlobal&&R.isSpatialReferenceSupported(o,y.ViewingMode.Global)||n.isLocal&&r.equals(o)}function le(e,t){let n,r,o;if(e.state.isGlobal){const e=new s(t.xmin,t.ymin,t.spatialReference),i=new s(t.xmax,t.ymax,t.spatialReference),a=t.spatialReference.isGeographic?U:O;n=new s({x:a.center(e.x,i.x),y:(i.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const c=l.getReferenceEllipsoid(t.spatialReference),u=S.getGreatCircleSpanAt(n,e,i);r=u.lon,o=u.lat,a.diff(e.x,i.x)>a.range/2&&(r+=c.halfCircumference),r=Math.min(r,c.halfCircumference),o=Math.min(o,c.halfCircumference)}else{const i=e.renderSpatialReference??t.spatialReference;i.equals(t.spatialReference)||(t=u.project(t,i)),r=t.xmax-t.xmin,o=t.ymax-t.ymin;const a=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new s({x:t.xmin+.5*r,y:t.ymin+.5*o,z:a,spatialReference:i})}const i=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,a=e.state.camera,c=1/Math.tan(a.fovX/2),f=1/Math.tan(a.fovY/2),d=1/Math.tan(a.fov/2);return{center:n,distance:Math.max(.5*r*c,.5*o*f,.5*i*d)/C}}async function se(e,t,n,r,o,a){const c=ce(e,t)?t:await u.projectWithZConversion(t,e.spatialReference,{signal:a});i.throwIfAborted(a);const{center:l,distance:s}=le(e,c),f=await ee(e,n,r,l,s,o,a);return i.throwIfAborted(a),we(e,f,e.camera.fov,a)}function ue(e,t,n,r,o,i){let a;try{a=ce(e,t)?t:u.project(t,e.spatialReference)}catch(f){return null}const{center:c,distance:l}=le(e,a),s=_(e,n,r,c,l,o);return null==s?null:Te(e,s,e.camera.fov,i)}function fe(e,t,n){const r=e.renderSpatialReference,o=m.projectVectorToPoint(n,r,H(e));if(null==o)return null;const i=Math.tan(t.fovX/2),c=Math.tan(t.fovY/2),l=a.dist(t.eye,n),s=2*l*i*C,u=2*l*c*C;return"global"===e.viewingMode?w.toExtent(e,o,s,u):T.toExtent(e,o,s,u)}function de(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>b)return!0;const o=e.renderSpatialReference,i=H(e),a=m.projectVectorToPoint(t,o,i),c=m.projectVectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,i);if(null==a||null==c)return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return c.distance(a)/l>j}function pe(t,n,r,o,i,a){let c=0;return a===e.OrientationMode.ADJUST&&de(t,o,i)?(n=0,c=ge(t,i,r,o)):c=ve(t,o,i,r),c=t.state.constraints.clampTilt(i,c),{heading:n,tilt:r=ye(t,o,i,c)}}const me=.7;function ge(e,t,n,r){const o=ve(e,r,t,n);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const a=i.min*(1-me)+i.max*me;return Math.min(o,a)}function he(e,t,n,r){let o=ve(e,r,t,n);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(t);return o=Math.min(o,.5*Math.PI),i.min*(1-me)+o*me}function ye(e,t,n,r){return G(e).lookAtTiltToEyeTilt(r,t,n)}function ve(e,t,n,r){return G(e).eyeTiltToLookAtTilt(r,t,n)}function Te(e,n,r,o){if(null==n)return null;const i=e.renderSpatialReference,a=m.projectVectorToPoint(n.eye,i,H(e));return null==a?null:(o??(o=new t),o.position=a,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o)}async function we(e,n,r,o){const a=e.renderSpatialReference,c=await g.projectVectorToPointWithEngine(n.eye,a,H(e),{signal:o});return i.throwIfAborted(o),new t(c,n.heading,n.tilt,r)}function Se(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);x.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Me(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);x.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Re(e,t){return h.projectVectorToVector(t.center,e.renderSpatialReference,z,f.WGS84),J(e,t.distance,z[1])}e.computeScale=Re,e.directionToHeadingTilt=Y,e.distanceToScale=J,e.externalToInternal=W,e.fromCenterDistanceAsync=Z,e.fromCenterDistanceSync=K,e.fromCenterScale=X,e.fromExtentAsync=se,e.fromExtentSync=ue,e.getObserverForPointAtDistanceAsync=ee,e.getObserverForPointAtDistanceSync=_,e.getViewSR=H,e.headingTiltToDirectionUp=L,e.internalToExternal=q,e.scaleToDistance=F,e.scaleToZoom=Se,e.toExtent=fe,e.zoomToScale=Me,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
