/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/MemCache","../../../core/scheduling","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./MemoryManagedView"],(function(e,t,r,a,i,s,o,y,d,h,u,l){"use strict";function _(e){return new w({view:e})}const c=.1,n=1,m=1,p=.75,M=.6,g=1.3;let w=class extends r{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new i.MemCacheStorage,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(s.addFrameTask({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(n),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new i.MemCache(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<M&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(n);else if(e)(this._memoryPredicted>1.1*m||this._usedMemory>m)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>c&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/g),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>m)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/g),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<p&&this._quality<n){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,c),n))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view._stage?.renderer?.tick();let e=(this.view.basemapTerrain?.usedMemory??0)+(this.view._stage?.renderer?.usedMemory??0),t=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((r=>{if(l.isMemoryManagedView(r)){const a=r.ignoresMemoryFactor?this._quality:1;e+=r.usedMemory*a,t+=r.unloadedMemory*a}}));const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),i=1048576*this.maxMemory;if(e>i&&r){this._warnMemoryUsage=e;const r=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);a.getLogger(this).warn(`Memory Limit exceeded! Limit: ${r(i)} Current: ${r(e)} Projected: ${r(e+t)} Quality: ${s}%`)}this._usedMemory=e/i,this._memoryPredicted=(e+t)/i;const s=i-e;this._cacheStorage.maxSize=Math.max(0,s+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}};t.__decorate([o.property({constructOnly:!0})],w.prototype,"view",void 0),t.__decorate([o.property()],w.prototype,"maxMemory",null),t.__decorate([o.property()],w.prototype,"additionalCacheMemory",null),t.__decorate([o.property({readOnly:!0})],w.prototype,"memoryFactor",null),t.__decorate([o.property({readOnly:!0})],w.prototype,"updating",null),t.__decorate([o.property({readOnly:!0})],w.prototype,"usedMemory",null),t.__decorate([o.property({readOnly:!0})],w.prototype,"usedCacheMemory",null),t.__decorate([o.property()],w.prototype,"_quality",void 0),t.__decorate([o.property()],w.prototype,"_usedMemory",void 0),t.__decorate([o.property()],w.prototype,"_updating",void 0),t.__decorate([o.property()],w.prototype,"_stableQuality",void 0),t.__decorate([o.property()],w.prototype,"_maxMemory",void 0),t.__decorate([o.property()],w.prototype,"_additionalCacheMemory",void 0),w=t.__decorate([u.subclass("esri.views.3d.support.MemoryController")],w),e.minQuality=c,e.newMemoryController=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
