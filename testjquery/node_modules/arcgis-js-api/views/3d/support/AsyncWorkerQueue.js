/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../webgl-engine/lib/Util"],(function(t,s){"use strict";class e{constructor(t){this.client=t,this._cancelled=!1,this.size=0,this.duration=0}}class r{constructor(t){this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new i}}class i{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class o{constructor(t,s,e,i){this._workerFunc=t,this._callbackFunc=s,this._maxTotalNumWorkers=e,this._totalNumWorkers=0,this._clients=i.map((t=>new r(t)))}destroy(){this._clients.length=0}hasQuota(t){const s=this._clients[t];return!!s&&(this._totalNumWorkers<this._maxTotalNumWorkers||s.numWorkers+s.tasks.length<s.typeWorkerQuota)}push(t){const s=this._clients[t.client];s&&(this._totalNumWorkers<this._maxTotalNumWorkers?(s.numWorkers++,this._totalNumWorkers++,this._workerFunc(t,((t,s)=>this._taskCallback(t,s)))):s.tasks.push(t))}cancel(t){this._taskFinished(t),t._cancelled=!0}_taskFinished(t){const e=this._clients[t.client];this._totalNumWorkers--,e&&(e.numWorkers--,e.statistics.requests++,e.statistics.size+=t.size||0,e.statistics.duration+=t.duration||0,e.statistics.speed=e.statistics.duration>0?e.statistics.size/e.statistics.duration:0,s.assert(e.numWorkers>=0)),this._next()}_next(){for(const t of this._clients)if(t&&t.numWorkers<t.typeWorkerQuota&&this._processQueue(t))return;for(const t of this._clients)if(t&&this._processQueue(t))return}_processQueue(t){for(;t.tasks.length>0;)if(this._workerFunc(t.tasks.shift(),((t,s)=>this._taskCallback(t,s))))return t.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(t,s){t._cancelled||(this._callbackFunc(t,s),this._taskFinished(t))}getStatsForType(t){const s=this._clients[t];return s?{quota:s.typeWorkerQuota,workers:s.numWorkers,queueSize:s.tasks.length,requestStats:s.statistics}:null}get test(){const t=this;return{set workerFunc(s){t._workerFunc=s}}}}t.AsyncWorkerQueue=o,t.BaseTask=e,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
