/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/handleUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/signal","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./index","./MemoryController","./StreamDataLoader","../../support/Scheduler"],(function(e,t,r,s,a,o,i,d,l,n,u,c,h,m,p,_,y,g){"use strict";let v=class extends r{constructor(){super(...arguments),this.updating=!1}};function T(e){return new k({view:e})}t.__decorate([n.property({readOnly:!0})],v.prototype,"updating",void 0),v=t.__decorate([m.subclass("esri.views.3d.support.ResourceControllerMain")],v);let k=class extends v{constructor(){super(...arguments),this._immediateTask=g.ImmediateTask,this._normalTask=g.ImmediateTask,this._updatingObjects=d.signal([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=g.newScheduler(),this._memoryController=_.newMemoryController(this.view),this._streamDataLoader=new y.StreamDataLoader,this._streamDataLoader.setup(p.maxDownloadSlots,p.downloadSlotsPerClient,this._scheduler),this.addHandles([o.watch((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),o.sync),o.watch((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=i.addFrameTask({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(g.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(g.TaskPriority.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=a.removeMaybe(this._frameTask),this._streamDataLoader=a.destroyMaybe(this._streamDataLoader),this._memoryController=a.destroyMaybe(this._memoryController),this._scheduler=a.destroyMaybe(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(r,s,a)=>t.request(r,s,e,a),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],s.makeHandle((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(l.secondsFromMilliseconds(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};t.__decorate([n.property()],k.prototype,"view",void 0),t.__decorate([n.property()],k.prototype,"_scheduler",void 0),t.__decorate([n.property()],k.prototype,"_memoryController",void 0),t.__decorate([n.property()],k.prototype,"_streamDataLoader",void 0),t.__decorate([n.property()],k.prototype,"_immediateTask",void 0),t.__decorate([n.property()],k.prototype,"_normalTask",void 0),t.__decorate([n.property()],k.prototype,"_updatingObjects",void 0),t.__decorate([n.property({readOnly:!0})],k.prototype,"updating",null),k=t.__decorate([m.subclass("esri.views.3d.support.ResourceControllerImpl")],k),e.newResourceController=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
