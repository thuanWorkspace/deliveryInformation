/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/mathUtils","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../ViewingMode","../../support/mathUtils"],(function(t,e,i,s,a,o,n){"use strict";const r=a.create(),c=a.create(),h=a.create(),p=a.create(),l=a.create(),d=a.create(),m={upward:a.fromValues(0,0,1),forward:a.fromValues(0,1,0),sideway:a.fromValues(1,0,0)},w=i.create();class u{constructor(t=o.ViewingMode.Global){this.viewingMode=t,this.center=a.create(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=a.clone(m.forward)}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,e){if(e||(e={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===o.ViewingMode.Global){const i=(s.length(this.center)+s.length(t.center))/2;e.pan=n.angle(this.center,t.center)*i}else e.pan=s.distance(this.center,t.center);let i=Math.abs(t.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const a=Math.abs(t.pitch-this.pitch);return e.rotate=Math.max(i,a),e.sourceZoom=this.distance,e.targetZoom=t.distance,e}interpolate(e,i,a){this.viewingMode===o.ViewingMode.Global?n.slerp(e.center,i.center,a.pan,this.center):s.lerp(this.center,e.center,i.center,a.pan),this.distance=isFinite(i.distance)?t.lerp(e.distance,i.distance,a.zoom):e.distance,this.pitch=t.lerp(e.pitch,i.pitch,a.rotate);let r=e.yaw;const c=i.yaw;Math.abs(c-r)>=Math.PI&&(r+=2*(r<c?1:-1)*Math.PI),this.yaw=t.lerp(r,c,a.rotate)}copyFrom(t){s.copy(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,s.copy(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode}copyFromRenderCamera(t){const e=this._lookAtOrientation(t.center,w);s.copy(this.center,t.center),s.subtract(p,t.center,t.eye),s.transformMat3(p,p,e),s.transformMat3(l,t.up,e),this.distance=s.length(p),0!==this.distance&&(p[0]/=this.distance,p[1]/=this.distance,p[2]/=this.distance),this.pitch=this._eyeUpToPitch(p),this.yaw=this._eyeUpToYaw(p,l),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t)}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(t){const i=this._lookAtOrientation(this.center,w);e.transpose(i,i),this._axisAngleVec3(m.sideway,this.pitch-Math.PI/2,m.forward,p),this._axisAngleVec3(m.upward,this.yaw,p),this._axisAngleVec3(m.sideway,this.pitch-Math.PI/2,m.upward,l),this._axisAngleVec3(m.upward,this.yaw,l),s.scale(p,p,this.distance),s.transformMat3(p,p,i),s.transformMat3(l,l,i),t.center=this.center,t.eye=s.subtract(p,this.center,p),t.up=l}_axisAngleVec3(t,e,i,a=i){const o=Math.cos(e),n=Math.sin(e);return s.scale(r,i,o),s.cross(c,t,i),s.scale(c,c,n),s.scale(h,t,(1-o)*s.dot(t,i)),s.add(a,s.add(a,r,c),h)}_lookAtOrientation(t,e=i.create()){return this._upAtLookAt(t,h),s.cross(r,this.lookAtDirection,h),s.normalize(r,r),0===r[0]&&0===r[1]&&0===r[2]&&s.copy(r,m.sideway),s.cross(c,h,r),s.normalize(c,c),e[0]=r[0],e[1]=c[0],e[2]=h[0],e[3]=r[1],e[4]=c[1],e[5]=h[1],e[6]=r[2],e[7]=c[2],e[8]=h[2],e}_upAtLookAt(t,e){return this.viewingMode===o.ViewingMode.Local?s.copy(e,m.upward):s.normalize(e,t)}_eyeUpToPitch(t){return Math.PI-n.angle(m.upward,t)}_eyeUpToYaw(t,e){const i=d;return Math.abs(e[2])<.5?(s.copy(i,e),t[2]>0&&s.scale(i,i,-1)):s.copy(i,t),s.cross(c,i,m.upward),s.normalize(c,c),n.angle(m.sideway,c,m.upward)}}return u}));
