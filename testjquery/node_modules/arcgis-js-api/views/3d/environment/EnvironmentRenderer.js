/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/spatialReferenceUtils","../../ViewingMode","./AtmosphereType","./ChapmanAtmosphere","./CloudsComposition","./CloudsData","./CloudsGenerator","./CloudsParameters","./CloudsPresets","./Fog","./LocalAtmosphere","./MarsAtmosphere","./Precipitation","./Stars","./weather","../webgl-engine/effects/RenderPlugin","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Update"],(function(e,t,r,s,n,a,o,i,h,d,l,p,u,c,_,m,g,y,w,f,v,R,b,P,A,E,M,F,x,C,N){"use strict";var W;e.EnvironmentRenderer=W=class extends x.SyncRenderPlugin{constructor(e){super(e),this.produces=new Map([[C.RenderSlot.ENVIRONMENT_OPAQUE,()=>!(null===this._atmosphere&&null===this._stars)],[C.RenderSlot.ENVIRONMENT_TRANSPARENT,()=>!(null===this._atmosphere)]]),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new T,this._newWeatherParameters=new T,this._fadedWeatherParameters=new T,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return null!=this.atmosphere?this.atmosphere.type:m.AtmosphereType.None}consumes(){return this._atmosphereType===m.AtmosphereType.Realistic?x.ConsumesDepth:x.ConsumesNone}updateAnimation(e){return null!=this._precipitation&&this._precipitation.update(e)}get updating(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}get weatherVisible(){return l.length(this.view.state.camera.eye)-u.getReferenceEllipsoid(this.view.spatialReference).radius<=F.weatherHeightLimit}get usedMemory(){return this._clouds?.usedMemory??0}get _stars(){const e=this.view,t=e.environment?.starsEnabled??!1,r=this._get("_stars");return t&&null!=this._context?null!=r?r:new M.Stars({view:e,requestRender:()=>this._setNeedsRender()}):(n.destroyMaybe(r),null)}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||null==this._context)return n.destroyMaybe(e),null;const t=this.view,r=this._context;return null!=e&&e.context===r?e:(n.destroyMaybe(e),new E.Precipitation({context:r,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return n.destroyMaybe(e),null;if(null!=e)return e;const t=this.view,r=this._context;return n.destroyMaybe(e),new f.CloudsGenerator({context:r,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return n.destroyMaybe(e),null;const t=this.view.state.viewingMode,r=this._context.renderContext.rctx,s=u.getReferenceEllipsoid(this.view.spatialReference).radius;return null!=e&&e.viewingMode===t&&e.planetRadius===s?e:(n.destroyMaybe(e),new y.CloudsComposition({rctx:r,viewingMode:t,planetRadius:s,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||null==this._context)return n.destroyMaybe(e),null;if(null!=e)return e;const t=this.view,r=this._context,s=this._context.renderContext.rctx,a=this.view.state.viewingMode;return new b.Fog({context:r,view:t,rctx:s,viewingMode:a})}get weatherEnabled(){return!!this.view?.environmentManager?.weatherEnabled}get _precipitationEnabled(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}initializeRenderContext(e=null){this._context=e;const t=()=>this._setNeedsRender();this.addHandles([a.watch((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled})),(e=>this._updateAtmosphere(e)),a.syncAndInitial),a.watch((()=>this._stars),t),a.watch((()=>this._precipitation),t),a.watch((()=>this._clouds),(()=>this._updateWeather()),a.initial),a.watch((()=>this._fog),(()=>this._updateFogHaze()),a.initial),a.watch((()=>this.view.state.mode),(()=>{this._setNeedsRender()}),a.sync),a.watch((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),a.syncAndInitial)])}uninitializeRenderContext(){this._context=null,this._atmosphere=n.destroyMaybe(this._atmosphere),this._set("_stars",n.destroyMaybe(this._stars)),this._set("_precipitation",n.destroyMaybe(this._precipitation)),this._set("_clouds",n.destroyMaybe(this._clouds)),this._set("_cloudsComposition",n.destroyMaybe(this._cloudsComposition)),this._set("_fog",n.destroyMaybe(this._fog))}prepareRender(e){e.bindParameters.cloudsFade.data=w.isReadyCloudsData(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&null!=e.bindParameters.cloudsFade.data?.cubeMap&&(this._updateWeatherFading(e.bindParameters,e.time),e.bindParameters.cloudsFade.renderingStage===w.CloudsRenderingStages.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}renderNode(e){switch(e.bindParameters.slot){case C.RenderSlot.ENVIRONMENT_OPAQUE:null!=this._stars&&this._stars.render(e),null!=this.atmosphere&&(this.atmosphere.render(e,this.view?._stage?.renderer?.fullResolutionAtmosphere),null!=this._cloudsComposition&&null!=e.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),e.bindParameters.cloudsFade.isFading&&null!=this._context&&null!=e.bindParameters.cloudsFade.data?.cubeMap&&this._context.requestRender());break;case C.RenderSlot.ENVIRONMENT_TRANSPARENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,this.view?._stage?.renderer?.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&null!=this._fog&&this._fog.render(e,this._weatherParameters.fog),null!=this._precipitation)){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}updateLightSources(e,t,r,s){if(null!=this._context){const n=this._context.renderContext;n.bindParameters.oldLighting.copyFrom(n.bindParameters.lighting),n.bindParameters.newLighting.noonFactor=t,n.bindParameters.newLighting.globalFactor=r,n.bindParameters.newLighting.set(e);s===N.Update.Faded||n.bindParameters.weatherFading?n.bindParameters.fadeLighting(0):n.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return null==e?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeatherFading(e,t){e.cloudsFade.updateFading(e.camera,this.view.state.mode,t,this.view.qualitySettings.fadeDuration),e.cloudsFade.updateParallax(e.camera),e.weatherFading&&(this._updateLighting(e),this._updateFogAtmoshpere(e))}_updateLighting(e){e.cloudsFade.fadeMode!==v.FadeMode.CROSS_FADE&&e.cloudsFade.fadeMode!==v.FadeMode.FADE_IN?e.fadeLighting(0):e.fadeLighting(e.cloudsFade.fadeFactor)}_updateFogAtmoshpere(e){e.cloudsFade.fadeMode!==v.FadeMode.CROSS_FADE&&e.cloudsFade.fadeMode!==v.FadeMode.FADE_IN?this._fadeWeather(0):this._fadeWeather(e.cloudsFade.fadeFactor)}_fadeWeather(e){const{_newWeatherParameters:t,_oldWeatherParameters:r}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(r,t,e),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const e=this._weatherUpdateParameters;null!=e&&null!=this._clouds&&(this._clouds.applyPreset(R.cloudPresets[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){null!=this._context&&this._context.requestRender()}_updateFogHaze(){const e=this._weatherUpdateParameters;if(null==this._fog||null==e||null==this._context)return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=s.lerp(3e-5,.005,e.weatherAdjustment**3),l.copy(this._newWeatherParameters.fog.color,O),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=s.lerp(4e-6,2e-4,(e.effect??0)**3),l.copy(this._newWeatherParameters.fog.color,S),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=s.lerp(4e-6,2e-4,(e.effect??0)**3),l.copy(this._newWeatherParameters.fog.color,O),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(e){const t=this._selectAtmosphereType(e);if(t!==m.AtmosphereType.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=n.destroyMaybe(this._atmosphere);const e=this._getAtmosphereClass(t);e&&(this._atmosphere=new e(this.view,this._context))}}else this._atmosphere=n.destroyMaybe(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(e){switch(e){case m.AtmosphereType.Realistic:return g.ChapmanAtmosphere;case m.AtmosphereType.Local:return P.LocalAtmosphere;case m.AtmosphereType.Mars:return A;default:case m.AtmosphereType.None:return null}}_selectAtmosphereType(e){const{enabled:t,viewingMode:r}=e;return!t||c.isMoon(this.view.spatialReference)?m.AtmosphereType.None:r===_.ViewingMode.Local?m.AtmosphereType.Local:null!=this._context&&g.ChapmanAtmosphere.isSupported(this._context)&&c.isEarth(this.view.spatialReference)?m.AtmosphereType.Realistic:c.isMars(this.view.spatialReference)?m.AtmosphereType.Mars:m.AtmosphereType.None}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),stubGetAtmosphereClass:e=>{z=W.prototype._getAtmosphereClass,W.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{W.prototype._getAtmosphereClass=z}}}},t.__decorate([o.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"atmosphere",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_atmosphereType",null),t.__decorate([o.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherVisible",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"_context",void 0),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"_atmosphere",void 0),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_stars",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitation",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_clouds",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_cloudsComposition",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_fog",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherEnabled",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitationEnabled",null),t.__decorate([o.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null),e.EnvironmentRenderer=W=t.__decorate([d.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer);class T{constructor(){this.fog=new b.FogParameters,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,l.copy(this.fog.color,e.fog.color)}lerp(e,t,r){this.fog.amount=s.lerp(e.fog.amount,t.fog.amount,r),this.hazeAmount=s.lerp(e.hazeAmount,t.hazeAmount,r),this.fog.strength=s.lerp(e.fog.strength,t.fog.strength,r),l.lerp(this.fog.color,e.fog.color,t.fog.color,r)}}const S=p.fromValues(.5,.5,.5),O=p.fromValues(1.5,1.5,1.5);let z;e.WeatherParameters=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
