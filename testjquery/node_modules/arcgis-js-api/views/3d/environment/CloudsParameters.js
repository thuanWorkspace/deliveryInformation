/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./CloudsData","./weather","../../support/RenderState"],(function(e,t,a,i,s,d,o,r,h,n,c){"use strict";class F{constructor(){this.readChannels=h.CloudsTextureChannels.RG,this.renderingStage=h.CloudsRenderingStages.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=d.create(),this.parallax=new u,this.parallaxNew=new u,this.pointOnGround=d.create(),this.fadeMode=e.FadeMode.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(t){const d=this.parallax,h=s.length(t.eye);if(d.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(h*h-r.earth.radius*r.earth.radius,0))/h,o.fromPoints(p,d.anchorPointClouds,f),a.rotate(d.transform,i.IDENTITY,f[3],o.axis(f)),this.fadeMode===e.FadeMode.CROSS_FADE){const e=this.parallaxNew;o.fromPoints(p,e.anchorPointClouds,f),a.rotate(e.transform,i.IDENTITY,f[3],o.axis(f))}}updateFading(e,t,a,i){this.isFading&&this._advanceFading(a,i),this._evaluateFading(e,t,a)}_evaluateFading(t,a,i){const s=t.relativeElevation,d=this._calculateDistanceToAnchorPoint(t);if((s>1.7*n.weatherHeightLimit||s<-n.weatherHeightLimit||d>E)&&this.opacity>0)this._setFade(e.FadeMode.HIDE,i);else if(!this.isFading)if((s>n.weatherHeightLimit||s<-.35*n.weatherHeightLimit||d>g)&&this.opacity>0)this._setFade(e.FadeMode.FADE_OUT,i);else if(s<=n.weatherHeightLimit&&s>=-.35*n.weatherHeightLimit&&a===c.RenderState.IDLE&&h.ensureClouds(this.data)){if(0===this.opacity)return void this._setFade(e.FadeMode.FADE_IN,i);(d>_||this.renderingStage===h.CloudsRenderingStages.FADING)&&this._setFade(e.FadeMode.CROSS_FADE,i)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(a,i){if(this.fadeFactor<1)return this.fadeFactor=i?t.clamp((a-this.startTime)/(D*i),0,1):1,this.fadeMode===e.FadeMode.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===e.FadeMode.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===e.FadeMode.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===e.FadeMode.FADE_OUT&&(this.opacity=0),this.fadeMode===e.FadeMode.FADE_IN&&(this.opacity=1),this.fadeMode===e.FadeMode.CROSS_FADE&&(this.opacity=1),this.fadeMode=e.FadeMode.NONE}_switchReadChannels(){const t=this.fadeMode===e.FadeMode.CROSS_FADE&&1===this.fadeFactor,a=this.fadeMode===e.FadeMode.FADE_IN&&0===this.fadeFactor;this.renderingStage===h.CloudsRenderingStages.FADING&&(t||a)&&(this.readChannels=1-this.readChannels,this.renderingStage=h.CloudsRenderingStages.FINISHED)}_calculateDistanceToAnchorPoint(e){return s.normalize(this.pointOnGround,e.eye),s.scale(this.pointOnGround,this.pointOnGround,r.earth.radius),s.length(s.subtract(M,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===e.FadeMode.CROSS_FADE&&(0===this.fadeFactor&&s.copy(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&s.copy(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===e.FadeMode.FADE_IN&&0===this.fadeFactor&&s.copy(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(t,a){switch(t){case e.FadeMode.HIDE:this.opacity=0;break;case e.FadeMode.FADE_OUT:this.opacity=1;break;case e.FadeMode.FADE_IN:this.opacity=0;break;case e.FadeMode.CROSS_FADE:this.opacity=1}this.fadeMode=t,this.fadeFactor=0,this.startTime=a}get isFading(){return this.fadeMode===e.FadeMode.FADE_OUT||this.fadeMode===e.FadeMode.FADE_IN||this.fadeMode===e.FadeMode.CROSS_FADE}}var l;e.FadeMode=void 0,(l=e.FadeMode||(e.FadeMode={}))[l.NONE=0]="NONE",l[l.HIDE=1]="HIDE",l[l.FADE_OUT=2]="FADE_OUT",l[l.FADE_IN=3]="FADE_IN",l[l.CROSS_FADE=4]="CROSS_FADE";class u{constructor(){this.anchorPointClouds=d.create(),this.radiusCurvatureCorrectionFactor=0,this.transform=i.create()}}const p=d.fromValues(0,0,1),f=o.create(),M=d.create(),D=1.25,_=34e3,g=64e3,E=2e5;e.CloudsParameters=F,e.crossFadeDistanceThreshold=_,e.fadeOutDistanceThreshold=g,e.hideDistanceThreshold=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
