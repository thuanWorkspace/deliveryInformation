/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/maybe","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../core/support/UpdatingHandles","../../../geometry/ellipsoidUtils","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/AnimationTimer","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Util"],(function(e,t,i,r,n,s,a,o,c,u,p,h,d,_,l,y,f,b,T,g,m,P,w){"use strict";e.Precipitation=class extends i{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new _.PrecipitationPassParameters,this._animation=new b.AnimationTimer,this._updatingTracking=new h.UpdatingHandles,this._passParameters.time=0,this._passParameters.radius=d.getReferenceEllipsoid(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=n.releaseMaybe(this._snowTechniqueCached),this._rainTechniqueCached=n.releaseMaybe(this._rainTechniqueCached),this._vao=n.disposeMaybe(this._vao),this._instanceIdBuffer=n.disposeMaybe(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(null==this._rainTechniqueCached){const e=new l.PrecipitationTechniqueConfiguration;e.type=l.PrecipitationType.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(_.PrecipitationTechnique,e)}return this._rainTechniqueCached}get _snowTechnique(){if(null==this._snowTechniqueCached){const e=new l.PrecipitationTechniqueConfiguration;e.type=l.PrecipitationType.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(_.PrecipitationTechnique,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,i){const n="rainy"===i?this._rainTechnique:this._snowTechnique;if(!n.compiled)return void this.context.requestRender();const a=e.rctx;if(this._ensureResources(a),null==n||null==this._vao||null==this._instanceIdBuffer)return;if(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0)return;const o=.35;t=t<.5?r.lerp(0,o,2*t):r.lerp(o,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*s.secondsFromMilliseconds(this._animation.time)%1e5;const c=a.bindTechnique(n,this._passParameters,e.bindParameters);a.bindVAO(this._vao),c.assertCompatibleVertexAttributeLocations(this._vao),w.bindVertexBufferLayout(a,_.attributeLocations,this._instanceIdBuffer,A,0),a.drawArraysInstanced(P.PrimitiveType.TRIANGLES,0,3,this._numParticles*t),w.unbindVertexBufferLayout(a,_.attributeLocations,this._instanceIdBuffer,A)}_ensureResources(e){null==this._vao&&(this._vao=this._createVertexArrayObject(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return m.BufferObject.createVertex(e,P.Usage.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new T.VertexArrayObject(e,_.attributeLocations,{geometry:y.glLayout(q)},{geometry:m.BufferObject.createVertex(e,P.Usage.STATIC_DRAW,t)})}},t.__decorate([a.property({constructOnly:!0})],e.Precipitation.prototype,"context",void 0),t.__decorate([a.property({constructOnly:!0})],e.Precipitation.prototype,"view",void 0),t.__decorate([a.property({readOnly:!0})],e.Precipitation.prototype,"updating",null),t.__decorate([a.property()],e.Precipitation.prototype,"_updatingTracking",void 0),e.Precipitation=t.__decorate([p.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const q=f.newLayout().vec3f(g.VertexAttribute.POSITION),A=y.glLayout(f.newLayout().f32(g.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
