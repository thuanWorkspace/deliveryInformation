/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/clock","../../../../core/handleUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/vectorStacks","./lengthDimensionManipulatorUtils","./LengthDimensionSubTool","./settings","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../../interactive/AnalysisToolBase","../../../interactive/keybindings","../../../support/screenUtils"],(function(e,t,o,i,n,s,r,a,l,c,u,p,h,d,m,v,_,y,T,D){"use strict";var g;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(g||(g={})),e.DimensionTool=class extends y.AnalysisToolBase{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=m.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=v.newIntersector(this.view.state.viewingMode),this._intersector.options.store=_.StoreResults.MIN,this._lengthDimensionSubTool=new d.LengthDimensionSubTool({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([i.destroyHandle(this._lengthDimensionSubTool),i.makeHandle((()=>this._clearPointerMoveTimeout())),s.watch((()=>this.state),(e=>{e===g.Created&&this.finishToolCreation()}),s.syncAndInitial),s.when((()=>this.firstGrabbedManipulator),(e=>{this.selectedDimension=e.metadata}),s.syncAndInitial),s.watch((()=>this.selectedDimension),(()=>this._resetPointerMoveTimeout()),s.syncAndInitial)])}get state(){return this.analysis.dimensions.some((e=>"length"===e.type))?null!=this._activeSubTool?g.Creating:g.Created:g.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(T.sketchKeys.cancel===e.key){if(null!=this._activeSubTool&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else T.sketchKeys.delete.includes(e.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){null!=this._activeSubTool&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(null==this._activeSubTool)return;const t=this._intersectScreen(e);null!=t&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),null==this._activeSubTool)return;if(this.hasFocusedManipulators)return;const t=this._intersectScreen(e);null!=t&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_deleteKeyHandler(){null!=this._activeSubTool&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(e){const t=D.createScreenPointArrayFromEvent(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const o=this._intersector.results.min,i=p.sv3d.get();return o.getIntersectionPoint(i)?this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference):null}_removeSelected(){null!=this.selectedDimension&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=n.removeMaybe(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach((e=>e.manipulator.state|=h.DidPointerMoveRecentlyFlag)),this._prevPointerMoveTimeout=o.clock.setTimeout((()=>{this.manipulators.forEach((e=>e.manipulator.state&=~h.DidPointerMoveRecentlyFlag))}),this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:e=>{this._pointerMoveTimerMs=e,this._resetPointerMoveTimeout()}}}},t.__decorate([r.property({constructOnly:!0})],e.DimensionTool.prototype,"view",void 0),t.__decorate([r.property({constructOnly:!0})],e.DimensionTool.prototype,"analysis",void 0),t.__decorate([r.property({readOnly:!0})],e.DimensionTool.prototype,"state",null),t.__decorate([r.property({readOnly:!0})],e.DimensionTool.prototype,"updating",null),t.__decorate([r.property({readOnly:!0})],e.DimensionTool.prototype,"cursor",null),t.__decorate([r.property({constructOnly:!0})],e.DimensionTool.prototype,"analysisViewData",void 0),t.__decorate([r.property()],e.DimensionTool.prototype,"selectedDimension",null),t.__decorate([r.property()],e.DimensionTool.prototype,"automaticManipulatorSelection",void 0),t.__decorate([r.property()],e.DimensionTool.prototype,"_activeSubTool",void 0),t.__decorate([r.property()],e.DimensionTool.prototype,"_lengthDimensionSubTool",void 0),e.DimensionTool=t.__decorate([u.subclass("esri.views.3d.analysis.Dimension.DimensionTool")],e.DimensionTool),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
