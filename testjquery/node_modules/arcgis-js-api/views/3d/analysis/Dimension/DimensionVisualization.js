/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../Color","../../../../intl","../../../../core/Accessor","../../../../core/handleUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec4f64","./LengthDimensionVisualization","./settings","../../webgl-engine/lib/Material","../../webgl-engine/materials/LineMarkerMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/shaders/LineMarkerTechniqueConfiguration","../../../../intl/locale","../../../../intl/messages"],(function(e,i,a,t,s,n,r,o,l,c,d,u,m,h,p,g,_,M,y,f,w,z,L){"use strict";function O(e){const{fontSize:i,lineSize:a,textColor:t,textBackgroundColor:s}=e.style;return{fontSize:i,lineSize:a,textBackgroundColor:s.clone(),textColor:t.clone()}}e.DimensionVisualization=class extends s{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null}initialize(){const e=this.isDecoration;this._markerMaterial=new M.LineMarkerMaterial({width:1,anchor:w.LineMarkerAnchor.Tip,color:h.ZEROS,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:_.RenderOccludedFlag.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:e}),this._dimensionLineMaterial=new f.RibbonLineMaterial({width:1,color:h.ZEROS,renderOccluded:_.RenderOccludedFlag.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:e}),this._offsetLineMaterial=new f.RibbonLineMaterial({width:1,color:h.ZEROS,renderOccluded:_.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:y.createStipplePatternSimple(5),isDecoration:e}),this._smallDimensionLineMaterial=new f.RibbonLineMaterial({width:1,color:h.ZEROS,renderOccluded:_.RenderOccludedFlag.OccludeAndTransparent,isDecoration:e}),this._smallOffsetLineMaterial=new f.RibbonLineMaterial({width:1,color:h.ZEROS,renderOccluded:_.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:y.createStipplePatternSimple(5),isDecoration:e});for(const a of this._lineMaterials())this.view._stage.add(a),this.addHandles(n.makeHandle((()=>{this.view._stage?.remove(a)})));const i=r.mapCollection((()=>this.analysisViewData.computations),(({computation:e})=>this._createVisualization(e)));this._dimensionVisualizations=i,this.addHandles([n.destroyHandle(i),r.watch((()=>a.toUnitRGBA(this.analysis.style.color)),(e=>{for(const i of this._lineMaterials())i.setParameters({color:e})}),r.syncAndInitial),r.watch((()=>this.analysis.style.lineSize),(e=>{const i=o.pt2px(e);this._markerMaterial.setParameters({width:i*g.markerLineSizeFraction}),this._dimensionLineMaterial.setParameters({width:i,markerParameters:this._markerMaterial.parameters});const a=Math.max(i*g.offsetLineSizeFraction,1);this._offsetLineMaterial.setParameters({width:a})}),r.syncAndInitial),r.watch((()=>({camera:this.view.state.camera,style:O(this.analysis)})),(({camera:e,style:i})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(e,a.computation.geometry,i),a.updateLabelStyle(i)})),r.watch((()=>this.visible),(e=>{for(const{visualization:i}of this._dimensionVisualizations)i.visible=e}))]),this.addHandles([z.onLocaleChange((()=>this._updateMessageBundle())),r.when((()=>!this.loadingMessages),(()=>{for(const{visualization:e}of this._dimensionVisualizations)e.updateUnitsMessages(this._messages)}),r.sync)]),this._updateMessageBundle()}get testInfo(){return{visualizations:this._dimensionVisualizations.items.map((({visualization:e})=>e)),disablePartialOcclusion:()=>{for(const e of this._lineMaterials())e.setParameters({renderOccluded:_.RenderOccludedFlag.Occlude})}}}_createVisualization(e){const i=new p.LengthDimensionVisualization({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:i,remove:()=>i.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await L.fetchMessageBundle("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}},i.__decorate([l.property({constructOnly:!0})],e.DimensionVisualization.prototype,"analysisViewData",void 0),i.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.DimensionVisualization.prototype,"view",void 0),i.__decorate([l.property({constructOnly:!0})],e.DimensionVisualization.prototype,"isDecoration",void 0),i.__decorate([l.property()],e.DimensionVisualization.prototype,"analysis",null),i.__decorate([l.property()],e.DimensionVisualization.prototype,"visible",null),i.__decorate([l.property()],e.DimensionVisualization.prototype,"loadingMessages",void 0),e.DimensionVisualization=i.__decorate([m.subclass("esri.views.3d.analysis.Dimension.DimensionVisualization")],e.DimensionVisualization),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
