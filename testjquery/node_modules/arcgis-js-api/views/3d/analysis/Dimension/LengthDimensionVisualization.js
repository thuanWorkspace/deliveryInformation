/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Handles","../../../../core/lang","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","./lengthDimensionUtils","./settings","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MarkerVisualElement","../../interactive/visualElements/support/Segment"],(function(e,t,s,n,i,l,a,m,o,r,f,d,u,c){"use strict";class h{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new t,this._messages=null,this._labelSegment=new c.EuclideanSegment;const{analysis:n,computation:i,view:m,messages:o,isDecoration:r}=e;this.analysis=n,this.computation=i,this.view=m,this._messages=o;const h=e.visible,S={view:m,attached:h,isDecoration:r},{fontSize:g,textColor:p,textBackgroundColor:b}=n.style;this._visualElements=new v({marker:new u.MarkerVisualElement(S,e.markerMaterial),dimension:new d.LineVisualElement(S,e.dimensionLineMaterial),startOffset:new d.LineVisualElement(S,e.offsetLineMaterial),endOffset:new d.LineVisualElement(S,e.offsetLineMaterial),dimensionSmall:new d.LineVisualElement(S,e.smallDimensionLineMaterial),startOffsetSmall:new d.LineVisualElement(S,e.smallOffsetLineMaterial),endOffsetSmall:new d.LineVisualElement(S,e.smallOffsetLineMaterial),label:new f.LabelVisualElement({view:m,attached:h,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:a.pt2px(g),textColor:p.clone(),backgroundColor:b.clone(),isDecoration:r})}),this._handles.add([l.watch((()=>i.geometry),(e=>{this.updateCameraDependentElements(m.state.camera,e,n.style),null!=i.geometry&&this._updateLines(i.geometry)}),{...l.initial,equals:s.equals}),l.watch((()=>i.length),(e=>this._updateLabelContent(e)),l.initial)])}destroy(){this.destroyed=!0,this._handles=n.destroyMaybe(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=o.computeSpanningSegment(S,o.OffsetSegmentLocation.Start,e.directSegment,e.dimensionSegment),s=o.computeSpanningSegment(g,o.OffsetSegmentLocation.End,e.directSegment,e.dimensionSegment),n=this._visualElements;n.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),n.dimension.setGeometryFromSegment(e.dimensionSegment),n.startOffset.setGeometryFromSegment(t),n.endOffset.setGeometryFromSegment(s),n.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),n.startOffsetSmall.setGeometryFromSegment(t),n.endOffsetSmall.setGeometryFromSegment(s)}updateCameraDependentElements(e,t,s){const n=this._visualElements;if(null==t){for(const e of n.values())e.visible=!1;return}const i=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,p)),l=o.maxScreenLengthSquaredFromGeometry(t,i),m=l<(a.pt2px(s.lineSize)*r.smallScreenLengthLineSizeFactor)**2,f=!m;n.marker.visible=f,n.dimension.visible=f,n.startOffset.visible=f,n.endOffset.visible=f,n.dimensionSmall.visible=m,n.startOffsetSmall.visible=m,n.endOffsetSmall.visible=m;const d=a.pt2px(s.fontSize)*r.minScreenLengthFontSizeFactor,{label:u}=n;if(u.visible=l>=d**2,!u.visible)return;const{dimensionSegment:c,primaryOffsetAxis:h}=t,{offset:S}=this.computation.dimension,g=(Math.sign(S)>=0?1:-1)*this._labelOffsetPx(s)*i;o.offsetSegment(this._labelSegment,c,h,g),u.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=a.pt2px(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;null!=e&&null!=this._messages?t.text=i.formatDecimal(this._messages,e,e.unit):t.text=""}_labelOffsetPx(e){return 1.5*a.pt2px(e.fontSize)+r.labelMarginPx+a.pt2px(e.lineSize/2)}}const S=new c.EuclideanSegment,g=new c.EuclideanSegment,p=m.create();class v{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}e.LengthDimensionVisualElements=v,e.LengthDimensionVisualization=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
