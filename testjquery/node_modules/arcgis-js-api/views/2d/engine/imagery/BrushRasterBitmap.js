/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/maybe","./RasterBitmap","./colorizer/rasterColorizer","./processor/rasterProcessor","../webgl/definitions","../webgl/VertexStream","../webgl/brushes/WGLBrush","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/rasterUtils"],(function(e,t,r,s,i,n,o,a,d,c){"use strict";class u extends o{constructor(){super(...arguments),this.name="raster",this._quad=null,this._rendererUniformInfos=new Map,this._fbo=null}dispose(){e.disposeMaybe(this._quad),e.disposeMaybe(this._fbo)}prepareState(e){const{context:t,renderPass:r}=e,s="raster"===r;t.setBlendingEnabled(!s),t.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA,a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!s)}draw(e,r){if(!t.hasSource(r)||r.suspended)return;const{renderPass:s}=e;if("raster-bitmap"!==s)return"raster"===s?this._process(e,r):void this._drawBitmap(e,r,!0);this._drawBitmap(e,r)}_process(t,r){const{rasterFunction:i}=t,n="Reproject"===i.name;if(!(n?!(r.rasterTexture&&r.projected):!r.processed))return;const{timeline:o,context:d}=t;o.begin(this.name);const c=d.getBoundFramebufferObject(),u=d.getViewport();n||(r.processedTexture=e.disposeMaybe(r.processedTexture)),d.setStencilFunction(a.CompareFunction.EQUAL,r.stencilRef,255),r.updateTexture(t),this._initQuad(d);const[m,f]=r.getRasterTextureSize(n),{isStandardRasterTileSize:l,fbo:h}=this._getRasterFBO(d,m,f);s.process(t,this._quad,h,r),l||h.dispose(),d.bindFramebuffer(c),d.setViewport(u.x,u.y,u.width,u.height),o.end(this.name)}_drawBitmap(e,t,s=!1){const{timeline:i,context:o}=e;if(i.begin(this.name),o.setStencilFunction(a.CompareFunction.EQUAL,t.stencilRef,255),t.updateTexture(e),s&&!t.processedTexture){if(t.updateProcessedTexture(),!t.processedTexture)return void i.end(this.name);t.processed=!0}this._initBitmapCommonUniforms(t);const d=t.symbolizerParameters.type,c=r.getColorizer(d),{requestRender:u,allowDelayedRender:m}=e,{defines:f,program:l}=c.createProgram(e,t,t.projected&&s);if(m&&null!=u&&!l.compiled)return void u();o.useProgram(l);const h=this._getUniformInfos(d,o,l,f);this._quad||(this._quad=new n(o,[0,0,1,0,0,1,1,1])),c.bindTextureAndUniforms(e,l,t,h,s),this._quad.draw(),i.end(this.name)}_initBitmapCommonUniforms(e){if(!e.commonUniforms){const t=c.getBasicGridUniforms(1,[0,0]),{transformGrid:r,width:s,height:i}=e,n=c.getCommonUniforms(r,[s,i],[e.source.width,e.source.height],1,!1);e.commonUniforms={...t,...n,u_coordScale:e.coordScale}}}_getRasterFBO(e,t,r){const s=t===i.tileSize&&r===i.tileSize;return s?(this._fbo||(this._fbo=this._createNewFBO(e,t,r)),{isStandardRasterTileSize:s,fbo:this._fbo}):{isStandardRasterTileSize:s,fbo:this._createNewFBO(e,t,r)}}_createNewFBO(e,t,r){const i=s.createTextureDescriptor(e,t,r);return new d.FramebufferObject(e,i)}_initQuad(e){this._quad||(this._quad=new n(e,[0,0,1,0,0,1,1,1]))}_getUniformInfos(e,t,r,s){const i=s.length>0?e+"-"+s.join("-"):e;if(this._rendererUniformInfos.has(i))return this._rendererUniformInfos.get(i);const n=c.getUniformLocationInfos(t,r);return this._rendererUniformInfos.set(i,n),n}}return u}));
