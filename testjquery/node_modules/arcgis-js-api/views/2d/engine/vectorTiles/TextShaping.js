/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","./ScriptUtils","../webgl/Rect"],(function(t,e,i){"use strict";const s=24,o=17;class c{constructor(t,e,i,s,o,c,a){this._glyphItems=t,this._maxWidth=e,this._lineHeight=i,this._letterSpacing=s,this._hAnchor=o,this._vAnchor=c,this._justify=a}getShaping(t,i,s){const o=this._letterSpacing,c=this._lineHeight,a=this._justify,h=this._maxWidth,n=[];let l=0,r=0;for(const M of t){const t=M.codePointAt(0);if(null==t)continue;const i=s&&e.hasVerticalOrientation(t);let c;for(const e of this._glyphItems)if(c=e[t],c)break;n.push({codePoint:t,x:l,y:r,vertical:i,glyphMosaicItem:c}),c&&(l+=c.metrics.advance+o)}let f=l;if(h>0){f=l/Math.max(1,Math.ceil(l/h))}const p=t.includes("â€‹"),m=[],g=n.length;for(let M=0;M<g-1;M++){const t=n[M].codePoint,i=e.allowsIdeographicBreak(t);if(e.isLineBreak(t)||i){let e=0;if(10===t)e-=1e4;else if(i&&p)e+=150;else{40!==t&&65288!==t||(e+=50);const i=n[M+1].codePoint;41!==i&&65289!==i||(e+=50)}m.push(this._buildBreak(M+1,n[M].x,f,m,e,!1))}}const d=this._optimalBreaks(this._buildBreak(g,l,f,m,0,!0));let y=0;const u=i?-c:c;let x=0;for(let M=0;M<d.length;M++){const t=d[M];let i=x;for(;i<t&&e.isWhiteSpace(n[i].codePoint);)n[i].glyphMosaicItem=null,++i;let s=t-1;for(;s>i&&e.isWhiteSpace(n[s].codePoint);)n[s].glyphMosaicItem=null,--s;if(i<=s){const t=n[i].x;for(let o=i;o<=s;o++)n[o].x-=t,n[o].y=r;let e=n[s].x;n[s].glyphMosaicItem&&(e+=n[s].glyphMosaicItem.metrics.advance),y=Math.max(e,y),a&&this._applyJustification(n,i,s)}x=t,r+=u}if(n.length>0){const t=d.length-1,e=(a-this._hAnchor)*y;let s=(-this._vAnchor*(t+1)+.5)*c;i&&t&&(s+=t*c);for(const i of n)i.x+=e,i.y+=s}return n.filter((t=>t.glyphMosaicItem))}static getTextBox(t,e){if(!t.length)return null;let i=1/0,s=1/0,c=0,a=0;for(const h of t){const t=h.glyphMosaicItem.metrics.advance,n=h.x,l=h.y-o,r=n+t,f=l+e;i=Math.min(i,n),c=Math.max(c,r),s=Math.min(s,l),a=Math.max(a,f)}return{x:i,y:s,width:c-i,height:a-s}}static getBox(t){if(!t.length)return null;let e=1/0,i=1/0,s=0,o=0;for(const c of t){const{height:t,left:a,top:h,width:n}=c.glyphMosaicItem.metrics,l=c.x,r=c.y-(t-Math.abs(h)),f=l+n+a,p=r+t;e=Math.min(e,l),s=Math.max(s,f),i=Math.min(i,r),o=Math.max(o,p)}return{x:e,y:i,width:s-e,height:o-i}}static addDecoration(t,e){const s=t.length;if(0===s)return;const o=3;let c=t[0].x+t[0].glyphMosaicItem.metrics.left,a=t[0].y;for(let n=1;n<s;n++){const s=t[n];if(s.y!==a){const h=t[n-1].x+t[n-1].glyphMosaicItem.metrics.left+t[n-1].glyphMosaicItem.metrics.width;t.push({codePoint:0,x:c,y:a+e-o,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new i(4,0,4,8),metrics:{width:h-c,height:2+2*o,left:0,top:0,advance:0},page:0,code:0}}),a=s.y,c=s.x+s.glyphMosaicItem.metrics.left}}const h=t[s-1].x+t[s-1].glyphMosaicItem.metrics.left+t[s-1].glyphMosaicItem.metrics.width;t.push({codePoint:0,x:c,y:a+e-o,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new i(4,0,4,8),metrics:{width:h-c,height:2+2*o,left:0,top:0,advance:0},page:0,code:0}})}_breakScore(t,e,i,s){const o=(t-e)*(t-e);return s?t<e?o/2:2*o:o+Math.abs(i)*i}_buildBreak(t,e,i,s,o,c){let a=null,h=this._breakScore(e,i,o,c);for(const n of s){const t=e-n.x,s=this._breakScore(t,i,o,c)+n.score;s<=h&&(a=n,h=s)}return{index:t,x:e,score:h,previousBreak:a}}_optimalBreaks(t){return t?this._optimalBreaks(t.previousBreak).concat(t.index):[]}_applyJustification(t,e,i){const o=t[i],c=o.vertical?s:o.glyphMosaicItem?o.glyphMosaicItem.metrics.advance:0,a=(o.x+c)*this._justify;for(let s=e;s<=i;s++)t[s].x-=a}}t.TextShaping=c,t.sdfGlyphBaseline=o,t.sdfGlyphSize=s,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
