/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","./decluttering/SymbolFader","./style/StyleDefinition","../webgl/enums","../webgl/RenderableTile","../webgl/TileContainer","../../tiling/TileCoverage","../../tiling/TileKey","../../../webgl/enums"],(function(e,t,s,r,i,l,n,a,o,d,c){"use strict";const h=1e-6;function y(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||s.getValue()!==i.Visibility.NONE&&(void 0===e.minzoom||e.minzoom<t+h)&&(void 0===e.maxzoom||e.maxzoom>=t-h))return!0}return!1}class u extends a{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}get fading(){return this._symbolFader?.fading??!1}setStyleResources(e,t,s){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,null==this._symbolFader&&(this._symbolFader=new r.SymbolFader(this._styleRepository,this.children)),this._symbolFader.styleRepository=s}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e)}async hitTest(e){const s=t.createResolver();return this._pointToCallbacks.set(e,s),this.requestRender(),s.promise}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==l.WGLDrawPhase.MAP&&e.drawPhase!==l.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||super.doRender(e)}addChild(e){return super.addChild(e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;if(t!==l.WGLDrawPhase.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=l.WGLDrawPhase.HITTEST;const s=e.painter.effects.hittestVTL;s.bind(e),this._doRender(e),s.draw(e,this._pointToCallbacks),s.unbind(e),e.drawPhase=t}}else super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t}=e,s=this._styleRepository;if(!s)return;const r=s.layers;let i=!0;e.drawPhase===l.WGLDrawPhase.HITTEST&&(i=!1),s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===l.WGLDrawPhase.MAP&&this._fade(e.displayLevel,e.state);const n=this.children.filter((e=>e.visible&&e.hasData()));if(!n||0===n.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const l of n)l.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(c.StencilOperation.KEEP,c.StencilOperation.KEEP,c.StencilOperation.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(c.CompareFunction.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let l=r.length-1;l>=0;l--)this._renderStyleLayer(r[l],e,n);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(i),t.setBlendFunctionSeparate(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA,c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<r.length;l++)this._renderStyleLayer(r[l],e,n);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}_fade(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,s){const{painter:r,renderPass:l}=t;if(void 0===e)return;const n=e.getLayoutProperty("visibility");if(n&&n.getValue()===i.Visibility.NONE)return;let a;switch(e.type){case i.StyleLayerType.BACKGROUND:return;case i.StyleLayerType.FILL:if("opaque"!==l&&"translucent"!==t.renderPass)return;a="vtlFill";break;case i.StyleLayerType.LINE:if("translucent"!==l)return;a="vtlLine";break;case i.StyleLayerType.CIRCLE:if("translucent"!==l)return;a="vtlCircle";break;case i.StyleLayerType.SYMBOL:if("translucent"!==l)return;a="vtlSymbol"}if(s=e.type===i.StyleLayerType.SYMBOL?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==a){const r=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=r+h||void 0!==e.maxzoom&&e.maxzoom<r-h)return}const o=e.uid;t.styleLayerUID=o,t.styleLayer=e;for(const i of s)if(i.layerData.has(o)){r.renderObjects(t,s,a);break}}_renderBackgroundLayers(e,t){const{context:r,displayLevel:a,painter:h,state:u}=e,p=this._styleRepository;let b=!1;for(const s of t){if(p.getLayerById(s).type===i.StyleLayerType.BACKGROUND&&y(p.getLayerById(s),a)){b=!0;break}}if(!b)return;const _=this._tileInfoView.getTileCoverage(e.state,0,!0,"smallest"),{spans:g,lodInfo:m}=_,{level:f}=m,T=s.create(),L=[];if(this._renderPasses){const t=this._renderPasses[0];null!=this._clippingInfos&&(t.brushes[0].prepareState(e),t.brushes[0].drawMany(e,this._clippingInfos))}const S=this._backgroundTiles;let C,E=0;for(const{row:i,colFrom:l,colTo:o}of g)for(let e=l;e<=o;e++){if(E<S.length)C=S[E],C.key.set(f,i,m.normalizeCol(e),m.getWorldForColumn(e)),this._tileInfoView.getTileBounds(T,C.key,!1),C.x=T[0],C.y=T[3],C.resolution=this._tileInfoView.getTileResolution(f);else{const t=new d(f,i,m.normalizeCol(e),m.getWorldForColumn(e)),r=this._tileInfoView.getTileBounds(s.create(),t),l=this._tileInfoView.getTileResolution(f);C=new n.RenderableTile(t,l,r[0],r[3],512,512,4096,4096),S.push(C)}C.setTransform(u),L.push(C),E++}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(c.StencilOperation.KEEP,c.StencilOperation.KEEP,c.StencilOperation.REPLACE),r.setStencilFunction(c.CompareFunction.EQUAL,0,255);let F=!0;e.drawPhase===l.WGLDrawPhase.HITTEST&&(F=!1),r.setStencilTestEnabled(F);for(const s of t){const t=p.getLayerById(s);t.type===i.StyleLayerType.BACKGROUND&&y(t,a)&&(e.styleLayerUID=t.uid,e.styleLayer=t,h.renderObjects(e,L,"vtlBackground"))}o.pool.release(_)}}e.VectorTileContainer=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
