/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry","../../../../Viewpoint","../../tiling/TileInfoView","../../tiling/TileKey","../../tiling/TileQueue","../../tiling/TileStrategy","../../ViewState","./style/StyleDefinition","../webgl/RenderableTile","../../../webgl/enums","../../../../geometry/Point"],(function(e,t,n,i,l,s,r,a,o,d,c,u){"use strict";const p=.125;class y{constructor(){this._renderParams={context:null,drawPhase:1,state:new a({viewpoint:new n({targetGeometry:new u(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new d.RenderableTile(new l(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,n,i,l,s,r,a,o,d){const c=this._backgroundTile;this._updateRenderParams(e,t,c,n,l,s,r,a,o,d),this._renderParams.stencilSymbols=!1,n.drawBackground(this._renderParams,c,i)}renderContent(e,t,n,i,l,s,r,a,o,d,u,p){this._stencilSymbols(e,t,n,i,l,s,r,Math.round(1/a),o,d,u,p);let y=1;n.stencilRef=y++,e.setStencilFunction(c.CompareFunction.EQUAL,n.stencilRef,255),this._render(e,t,n,l,s,r,a,o,d,u,p),i.forAll((t=>{t.sourceLayerInfo.data.stencilRef=y++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,l,s,r,Math.round(1/a),t.offset,d,u,p)}))}_stencilSymbols(e,t,n,i,l,s,r,a,o,d,u,p){let y=1;n.stencilRef=y++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(c.StencilOperation.KEEP,c.StencilOperation.KEEP,c.StencilOperation.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(c.CompareFunction.ALWAYS,n.stencilRef,255),this._stencilTileSymbols(e,t,n,l,s,r,a,o,d,u,p);for(const m of i.toArray()){const{sourceLod:t,offset:n,sourceLayerInfo:i}=m;i.data.stencilRef=y++,e.setStencilFunction(c.CompareFunction.ALWAYS,i.data.stencilRef,255),this._stencilTileSymbols(e,t,i.data,l,s,r,a,n,d,u,p)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,n,i,l,s,r,a,d,u,p){e.setStencilFunction(c.CompareFunction.EQUAL,n.stencilRef,255),this._render(e,t,n,i,l,s,r,a,d,u,p,o.StyleLayerType.SYMBOL)}_render(e,t,n,i,l,s,r,a,o,d,c,u){this._updateRenderParams(e,t,n,i,s,r,a,o,d,c),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,n,l,u)}_stencilTileSymbols(e,t,n,i,l,s,r,a,o,d,c){this._updateRenderParams(e,t,n,i,s,r,a,o,d,c),this._renderParams.stencilSymbols=!0,n.triangleCount=0,i.drawSymbols(this._renderParams,n,l)}_updateRenderParams(e,t,n,i,l,s,r,a,o,d){"type"in n&&"vector-tile"===n.type&&!n.stage&&n.attachWithContext(e);const c=t[0]-l.getLevelShift(t[0]),u=this._renderParams;u.context=e,u.painter=i,u.glyphMosaic=i.glyphMosaic,u.spriteMosaic=i.spriteMosaic,u.pixelRatio=o*d,u.displayLevel=c,u.requiredLevel=c;const y=l.getScale(t[0]),[m,h]=l.getOffset(t,s*y),S=p*s*y/a,g=n.transforms.dvs;g[0]=S,g[4]=-S,g[6]=-1-m-r[0]*s*2,g[7]=1+h+(1-r[1])*s*2-2,u.state.size[0]=a/d,u.state.size[1]=a/d,u.state.pixelRatio=d}}e.VectorTileRendererHelper3D=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
