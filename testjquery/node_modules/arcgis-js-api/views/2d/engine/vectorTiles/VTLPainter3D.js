/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/maybe","../vtlBrushes","./shaders/VTLMaterialManager","./style/StyleDefinition","../../../webgl/enums"],(function(e,t,r,s,a){"use strict";const i=1e-6;class n{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new r}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=e.disposeMaybe(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,r){const a=r.layers;e.renderPass="translucent";for(let n=0;n<a.length;n++){const r=a[n];if(r.type!==s.StyleLayerType.SYMBOL)continue;const l=r.getLayoutProperty("visibility");if(l&&l.getValue()===s.Visibility.NONE)continue;const o=e.displayLevel;void 0!==r.minzoom&&r.minzoom>o+i||void 0!==r.maxzoom&&r.maxzoom<=o-i||(e.styleLayerUID=r.uid,e.styleLayer=r,this._drawWithBrush(e,t,"vtlSymbol"))}}drawBackground(e,t,r){if(0===r.backgroundBucketIds.length)return;const{context:a,displayLevel:n,requiredLevel:l}=e;t.key.level=l,a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!1),e.renderPass="background",r.backgroundBucketIds.forEach((a=>{const l=r.getLayerById(a);if(l.type!==s.StyleLayerType.BACKGROUND)return;const o=l.getLayoutProperty("visibility");o&&o.getValue()===s.Visibility.NONE||void 0!==l.minzoom&&l.minzoom>n+i||void 0!==l.maxzoom&&l.maxzoom<=n-i||(e.styleLayerUID=l.uid,e.styleLayer=l,this._drawWithBrush(e,t,"vtlBackground"))}))}drawTile(e,t,r,s){const{context:i}=e,n=r.layers;i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),i.setDepthWriteEnabled(!0),i.setDepthFunction(a.CompareFunction.LEQUAL),e.renderPass="opaque";for(let a=n.length-1;a>=0;a--){const r=n[a];null!=s&&s!==r.type||this._renderStyleLayer(r,e,t,!1)}i.setDepthWriteEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA,a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let a=0;a<n.length;a++){const r=n[a];null!=s&&s!==r.type||this._renderStyleLayer(r,e,t,!1)}i.setDepthTestEnabled(!1),i.bindVAO()}_renderStyleLayer(e,t,r,a){if(!(a||e&&r.layerData.has(e.uid)))return;const n=e.getLayoutProperty("visibility");if(n&&n.getValue()===s.Visibility.NONE)return;const{renderPass:l}=t;let o;switch(e.type){case s.StyleLayerType.BACKGROUND:if("background"!==l)return;o="vtlBackground";break;case s.StyleLayerType.FILL:if("opaque"!==l&&"translucent"!==t.renderPass)return;o="vtlFill";break;case s.StyleLayerType.LINE:if("translucent"!==l)return;o="vtlLine";break;case s.StyleLayerType.CIRCLE:if("translucent"!==l)return;o="vtlCircle";break;case s.StyleLayerType.SYMBOL:if("translucent"!==l)return;o="vtlSymbol"}const y=t.displayLevel;if(void 0!==e.minzoom&&e.minzoom>y+i||void 0!==e.maxzoom&&e.maxzoom<=y-i)return;const{context:c}=t;c.setStencilTestEnabled(!1),c.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,r,o)}_drawWithBrush(e,r,s){if(!this._brushCache.has(s)){const e=t.vtlBrushes[s];this._brushCache.set(s,new e)}this._brushCache.get(s).drawMany(e,[r])}}return n}));
