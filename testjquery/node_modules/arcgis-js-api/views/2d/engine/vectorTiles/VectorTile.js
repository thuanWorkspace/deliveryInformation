/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../chunks/mat3","../../../../chunks/mat3f32","./enums","./RenderBucket","./decluttering/config","../webgl/TiledDisplayObject"],(function(e,t,s,a,r,i,o,n){"use strict";class h extends n.TiledDisplayObject{constructor(e,t,s,a,r,i,o,n=null){super(e,t,s,a,r,i,4096,4096),this.styleRepository=o,this._memCache=n,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<o.fadeDuration}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<o.fadeDuration)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const s of e){const e=this.layerData.get(s);e&&(this._memoryUsedByLayerData-=e.memoryUsed,e.type===r.BucketType.SYMBOL&&this.symbols.delete(s)&&(t=!0),e.destroy(),this.layerData.delete(s))}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){"unloaded"!==this.status&&(c.delete(this),h._destroyRenderBuckets(this.layerData),this.layerData=null,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsed(){return this._memoryUsedByLayerData+256}changeDataImpl(e){let t=!1;if(e){const{bucketsWithData:s,emptyBuckets:a}=e,i=this._createRenderBuckets(s);if(a&&a.byteLength>0){const e=new Uint32Array(a);for(const t of e)this._deleteLayerData(t)}for(const[e,o]of i)this._deleteLayerData(e),o.type===r.BucketType.SYMBOL&&(this.symbols.set(e,o.symbols),t=!0),this._memoryUsedByLayerData+=o.memoryUsed,this.layerData.set(e,o);this._memCache?.updateSize(this.key.id,this,this.memoryUsed)}this._hasSymbolBuckets=!1;for(const[s,a]of this.layerData)a.type===r.BucketType.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),a=this.width/this.rangeX*t,r=this.height/this.rangeY*t,i=[0,0];e.toScreen(i,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;s.identity(o),s.translate(o,o,i),s.rotate(o,o,Math.PI*e.rotation/180),s.scale(o,o,[a,r,1])}_createTransforms(){return{dvs:a.create(),tileMat3:a.create(),tileUnitsToPixels:a.create()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const s of e.values())t.has(s)||(s.destroy(),t.add(s));e.clear()}_createRenderBuckets(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e)}return t}_deserializeBucket(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case r.BucketType.FILL:s=new i.FillRenderBucket(e,this.styleRepository);break;case r.BucketType.LINE:s=new i.LineRenderBucket(e,this.styleRepository);break;case r.BucketType.SYMBOL:s=new i.SymbolRenderBucket(e,this.styleRepository,this);break;case r.BucketType.CIRCLE:s=new i.CircleRenderBucket(e,this.styleRepository)}return t.set(e,s),s}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e)}}const c=new Map;function l(){c.forEach(((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log("========"),e[1].forEach((e=>console.log(e)))}))}e.VectorTile=h,e.printAllocations=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
