/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/MemCache","../../../../core/promiseUtils","../../../../chunks/mat3f32","../../../../geometry/support/aaBoundingRect","./TileHandler","./VectorTile","./decluttering/jobsUtil","../../tiling/TileInfoViewPOT","../../tiling/TileKey"],(function(e,t,i,o,n,s,l,r,a){"use strict";class g extends n.TileHandler{constructor(e,t,i,o){super(e,t,i),this._memCache=o,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new r(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(n,r,g,h){const u=new a(n,r,g,0);let c=this._memCache.get(u.id);if(null!=c)return c.retain(),c;const T=await this._getVectorTileData(u);if(t.throwIfAborted(h),!this._layer)return null;if(c=this._memCache.get(u.id),null!=c)return c.retain(),c;const _=this._layer.tileInfo.getTileBounds(o.create(),u),d=this._tileInfoView.getTileResolution(n);return c=new s.VectorTile(u,d,_[0],_[3],512,512,this._styleRepository,this._memCache),T?(c.setData(T),c.retain(),this._memCache.put(u.id,c,c.memoryUsed,e.minPriority)):c.setData(null),c.neededForCoverage=!0,c.transforms.tileUnitsToPixels=i.fromValues(1/8,0,0,0,1/8,0,0,0,1),l.declutterSingleTile(c),c}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const i=new AbortController,o={signal:i.signal},n=this._getParsedVectorTileData(e,o).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,n),this._ongoingRequestToController.set(t,i),n}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((i=>this.parseTileData({key:e,data:i},t)))}}return g}));
