/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/promiseUtils","./Placement","./TileParser","../../tiling/enums"],(function(t,e,s,r){"use strict";class i{constructor(t,s,i,n){this.status=r.TileStatus.INITIALIZED,this.placementEngine=new e.PlacementEngine,this.tileKey=t,this.refKeys=s,this._workerTileHandler=i,this._styleRepository=n}release(){this.tileKey="",this.refKeys=null,this.status=r.TileStatus.INITIALIZED,this._workerTileHandler=null}async parse(e,s){const i=s?.signal;if(null!=i){const t=()=>{i.removeEventListener("abort",t),this.status=r.TileStatus.INVALID};i.addEventListener("abort",t)}let n;const a={bucketsWithData:[],emptyBuckets:null};try{n=await this._parse(e,s)}catch(c){if(t.isAbortError(c))throw c;return{result:a,transferList:[]}}this.status=r.TileStatus.READY;const l=a.bucketsWithData,u=[];for(const t of n)if(t.hasFeatures()){const e=t.serialize();l.push(e)}else u.push(t.layer.uid);const o=[...l];let h=null;return u.length>0&&(h=Uint32Array.from(u),o.push(h.buffer)),a.emptyBuckets=h,{result:a,transferList:o}}setObsolete(){this.status=r.TileStatus.INVALID}getLayers(){return this._workerTileHandler.getLayers()}getWorkerTileHandler(){return this._workerTileHandler}async _parse(t,e){const i=t.sourceName2DataAndRefKey;if(0===Object.keys(i).length)return[];this.status=r.TileStatus.MODIFIED;return new s(i,this,e.client,this._styleRepository,t.styleLayerUIDs).parse(e)}}return i}));
