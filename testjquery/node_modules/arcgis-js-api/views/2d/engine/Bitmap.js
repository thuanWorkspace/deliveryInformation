/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/promiseUtils","../../../chunks/mat3","../../../chunks/mat3f32","../../../chunks/vec2f32","./DisplayObject","./ImageryBitmapSource","../../webgl/contextUtils","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(t,e,i,s,r,h,o,u,a,n,l){"use strict";function d(t){return t&&"render"in t}function c(t){const e=document.createElement("canvas");return e.width=t.width,e.height=t.height,t.render(e.getContext("2d")),e}function _(t){return d(t)?t instanceof o?t.getRenderedRasterPixels()?.renderedRasterPixels:c(t):t}class x extends h.DisplayObject{constructor(t=null,e=!1){super(),this.blendFunction="standard",this._sourceWidth=0,this._sourceHeight=0,this._textureInvalidated=!1,this._texture=null,this.stencilRef=0,this.coordScale=[1,1],this._height=void 0,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._width=void 0,this.x=0,this.y=0,this.immutable=e,this.source=t,this.requestRender=this.requestRender.bind(this)}destroy(){this._texture&&(this._texture.dispose(),this._texture=null),null!=this._uploadStatus&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)}get isSourceScaled(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}get height(){return void 0!==this._height?this._height:this._sourceHeight}set height(t){this._height=t}get source(){return this._source}set source(t){null==t&&null==this._source||(this._source=t,this.invalidateTexture(),this.requestRender())}get width(){return void 0!==this._width?this._width:this._sourceWidth}set width(t){this._width=t}beforeRender(t){super.beforeRender(t),this.updateTexture(t)}async setSourceAsync(t,i){null!=this._uploadStatus&&this._uploadStatus.controller.abort();const s=new AbortController,r=e.createResolver();return e.onAbortOrThrow(i,(()=>s.abort())),e.onAbortOrThrow(s,(t=>r.reject(t))),this._uploadStatus={controller:s,resolver:r},this.source=t,r.promise}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):this._source&&(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width))}updateTransitionProperties(t,e){t>=64&&(this.fadeTransitionEnabled=!1,this.inFadeTransition=!1),super.updateTransitionProperties(t,e)}setTransform(t){const e=i.identity(this.transforms.dvs),[s,h]=t.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/t.resolution,u=o*this.width,a=o*this.height,n=Math.PI*this.rotation/180;i.translate(e,e,r.fromValues(s,h)),i.translate(e,e,r.fromValues(u/2,a/2)),i.rotate(e,e,-n),i.translate(e,e,r.fromValues(-u/2,-a/2)),i.scaleByVec2(e,e,r.fromValues(u,a)),i.multiply(this.transforms.dvs,t.displayViewMat3,e)}setSamplingProfile(t){this._texture&&(t.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(t.samplingMode))}bind(t,e){this._texture&&t.bindTexture(this._texture,e)}async updateTexture({context:t,painter:i}){if(!this._textureInvalidated)return;if(this._textureInvalidated=!1,this._texture||(this._texture=this._createTexture(t)),!this.source)return void this._texture.setData(null);this._texture.resize(this._sourceWidth,this._sourceHeight);const s=_(this.source);try{if(null!=this._uploadStatus){const{controller:t,resolver:e}=this._uploadStatus,r={signal:t.signal},{width:h,height:o}=this,u=this._texture,a=i.textureUploadManager;await a.enqueueTextureUpdate({data:s,texture:u,width:h,height:o},r),e.resolve(),this._uploadStatus=null}else this._texture.setData(s);this.ready()}catch(r){e.throwIfNotAbortError(r)}}onDetach(){this.destroy()}_createTransforms(){return{dvs:s.create()}}_createTexture(t){const e=this.immutable&&t.type===u.ContextType.WEBGL2,i=new l.TextureDescriptor;return i.internalFormat=e?a.SizedPixelFormat.RGBA8:a.PixelFormat.RGBA,i.wrapMode=a.TextureWrapMode.CLAMP_TO_EDGE,i.isImmutable=e,i.width=this._sourceWidth,i.height=this._sourceHeight,new n.Texture(t,i)}}t.Bitmap=x,t.isImageSource=d,t.rasterize=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
