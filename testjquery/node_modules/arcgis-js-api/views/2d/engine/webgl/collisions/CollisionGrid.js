/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/mathUtils","../../../layers/features/support/StaticBitSet"],(function(t,s,e){"use strict";const i=2,o=1,h=0,l=1,r=2;class c{constructor(t,s,i){this._debugMap=new Map,this._width=t*i,this._height=s*i,this._pixelRatio=i;const h=Math.ceil(this._width/o),l=Math.ceil(this._height/o);this._cols=h,this._rows=l,this._cells=e.StaticBitSet.create(h*l)}insertMetrics(t){const s=this._hasCollision(t);return s===h&&this._markMetrics(t),s}getCellId(t,s){return t+s*this._cols}has(t){return this._cells.has(t)}hasRange(t,s){return this._cells.hasRange(t,s)}set(t){this._cells.set(t)}setRange(t,s){this._cells.setRange(t,s)}_collide(t,e,i,c){const n=t-i/2,a=e-c/2,d=n+i,_=a+c;if(d<0||_<0||n>this._width||a>this._height)return l;const u=s.clamp(Math.floor(n/o),0,this._cols),p=s.clamp(Math.floor(a/o),0,this._rows),m=s.clamp(Math.ceil(d/o),0,this._cols),M=s.clamp(Math.ceil(_/o),0,this._rows);for(let s=p;s<=M;s++)for(let t=u;t<=m;t++){const e=this.getCellId(t,s);if(this.has(e))return r}return h}_mark(t,e,i,h,l){const r=t-i/2,c=e-h/2,n=r+i,a=c+h,d=s.clamp(Math.floor(r/o),0,this._cols),_=s.clamp(Math.floor(c/o),0,this._rows),u=s.clamp(Math.ceil(n/o),0,this._cols),p=s.clamp(Math.ceil(a/o),0,this._rows);for(let s=_;s<=p;s++)for(let t=d;t<=u;t++){const e=this.getCellId(t,s);this._debugMap.set(e,l),this.set(e)}return!1}_hasCollision(t){const s=t.id;let e=0,o=0;t.save();do{const s=t.boundsCount;e+=s;for(let e=0;e<s;e++){const s=t.boundsComputedAnchorX(e),h=t.boundsComputedAnchorY(e),c=(t.boundsWidth(e)+i)*this._pixelRatio,n=(t.boundsHeight(e)+i)*this._pixelRatio;switch(this._collide(s,h,c,n)){case r:return r;case l:o++}}}while(t.peekId()===s&&t.next());return t.restore(),e===o?l:h}_markMetrics(t){const s=t.id;t.save();do{const s=t.boundsCount;for(let e=0;e<s;e++){const s=t.boundsComputedAnchorX(e),o=t.boundsComputedAnchorY(e),h=(t.boundsWidth(e)+i)*this._pixelRatio,l=(t.boundsHeight(e)+i)*this._pixelRatio;this._mark(s,o,h,l,t.id)}}while(t.peekId()===s&&t.next());t.restore()}}t.CollisionBitsetGrid=c,t.hasCollision=r,t.none=h,t.outsideExtent=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
