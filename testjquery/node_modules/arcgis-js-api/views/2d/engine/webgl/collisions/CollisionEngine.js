/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../definitions","./CollisionGrid"],(function(e,i,t){"use strict";const o=254,s=255,n=0;function l(e,i){const t=[];e.forEachTile((e=>t.push(e))),t.sort(((e,i)=>e.instanceId-i.instanceId)),t.forEach((e=>{null!=e.labelMetrics&&e.isReady&&i(e,e.labelMetrics.getCursor())}))}class r{run(e,i,t){const o=[];for(let s=e.length-1;s>=0;s--){const i=e[s];i.labelingCollisionInfos&&o.push(...i.labelingCollisionInfos)}this._transformMetrics(o),this._runCollision(o,i,t)}_runCollision(e,i,o){const[r,a]=i.state.size,d=new t.CollisionBitsetGrid(r,a,i.pixelRatio);for(const{tileRenderer:t,deconflictionEnabled:c,visible:u}of e){const e=t.featuresView.attributeView;c?u?(this._prepare(t),this._collideVisible(d,t,o),this._collideInvisible(d,t)):l(t,((i,t)=>{for(;t.nextId();)e.setLabelMinZoom(t.id,s)})):l(t,((i,t)=>{for(;t.nextId();)e.setLabelMinZoom(t.id,n),u&&d.insertMetrics(t)}))}}_isFiltered(e,t,o){const s=t.getFilterFlags(e),n=!o.hasFilter||!!(s&i.filterFlag0),l=null==o.featureEffect||o.featureEffect.excludedLabelsVisible||!!(s&i.effectFlag0);return!(n&&l)}_prepare(e){const i=e.featuresView.attributeView,t=new Set;l(e,((l,r)=>{for(;r.nextId();){if(t.has(r.id))continue;if(t.add(r.id),this._isFiltered(r.id,i,e.layerView)){i.setLabelMinZoom(r.id,o);continue}i.getLabelMinZoom(r.id)!==n?i.setLabelMinZoom(r.id,s):i.setLabelMinZoom(r.id,n)}}))}_collideVisible(e,i,s){const r=i.featuresView.attributeView,a=new Set;l(i,((i,l)=>{for(;l.nextId();)if(!a.has(l.id))if(i.key.level===s){if(0===r.getLabelMinZoom(l.id)){switch(e.insertMetrics(l)){case t.outsideExtent:break;case t.hasCollision:r.setLabelMinZoom(l.id,o),a.add(l.id);break;case t.none:r.setLabelMinZoom(l.id,n),a.add(l.id)}}}else r.setLabelMinZoom(l.id,o)}))}_collideInvisible(e,i){const o=i.featuresView.attributeView,r=new Set;l(i,((i,l)=>{for(;l.nextId();)if(!r.has(l.id)&&o.getLabelMinZoom(l.id)===s){switch(e.insertMetrics(l)){case t.outsideExtent:break;case t.hasCollision:o.setLabelMinZoom(l.id,s),r.add(l.id);break;case t.none:o.setLabelMinZoom(l.id,n),r.add(l.id)}}}))}_transformMetrics(e){for(const{tileRenderer:i,geometryType:t,vvEvaluators:o}of e)l(i,((e,s)=>{const n=i.featuresView.attributeView,l=e.transforms.labelMat2d;l[4]=Math.round(l[4]),l[5]=Math.round(l[5]);const r="polyline"===t;for(;s.next();){const e=s.boundsCount,i=s.anchorX,t=s.anchorY;let a=s.size;const d=o[0];if(null!=d){const e=d(n.getVVSize(s.id));a=isNaN(e)||null==e||e===1/0?a:e}const c=s.directionX*(a/2),u=s.directionY*(a/2);for(let o=0;o<e;o++){let e=i,n=s.anchorY;if(r){let i=e+s.boundsX(o)+c,t=n+s.boundsY(o)+u;i=l[0]*i+l[2]*t+l[4],t=l[1]*i+l[3]*t+l[5],s.setBoundsComputedAnchorX(o,Math.floor(i)),s.setBoundsComputedAnchorY(o,Math.floor(t))}else{e=l[0]*i+l[2]*t+l[4],n=l[1]*i+l[3]*t+l[5];const r=e+s.boundsX(o)+c,a=n+s.boundsY(o)+u;s.setBoundsComputedAnchorX(o,r),s.setBoundsComputedAnchorY(o,a)}}}}))}}e.CollisionEngine=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
