/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../chunks/common","../../../../chunks/mat3","../../../../chunks/mat3f32","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","./VertexStream","./shaders/StencilPrograms","../../../webgl/enums","../../../webgl/ProgramTemplate"],(function(t,e,i,s,n,r,a,o,c,l,h,d){"use strict";const _=r.fromValues(-.5,-.5);class u{constructor(){this._centerNdc=o.create(),this._pxToNdc=o.create(),this._worldDimensionsPx=o.create(),this._mat3=n.create(),this._initialized=!1}dispose(){this._program=e.disposeMaybe(this._program),this._quad=e.disposeMaybe(this._quad)}render(t,e,i){const{context:s}=t,n=this._updateGeometry(t,i);if(null!=e){const{r:t,g:i,b:n,a:r}=e;s.setClearColor(r*t/255,r*i/255,r*n/255,r)}else s.setClearColor(0,0,0,0);if(s.setStencilFunction(h.CompareFunction.ALWAYS,0,255),s.setStencilWriteMask(255),!n)return s.setClearStencil(1),void s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT);s.setClearStencil(0),s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(s),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setColorMask(!1,!1,!1,!1),s.setBlendingEnabled(!1),s.setStencilOp(h.StencilOperation.KEEP,h.StencilOperation.KEEP,h.StencilOperation.REPLACE),s.setStencilFunction(h.CompareFunction.ALWAYS,1,255),s.setStencilTestEnabled(!0),s.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(t){if(this._initialized)return;const e=d.createProgram(t,l.stencil);e&&(this._program=e,this._quad=new c(t,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(t,e){const{state:n,pixelRatio:r}=t,{size:o,rotation:c}=n,l=Math.round(o[0]*r),h=Math.round(o[1]*r);if(!n.spatialReference.isWrappable)return!1;const d=i.toRadian(c),u=Math.abs(Math.cos(d)),m=Math.abs(Math.sin(d)),p=Math.round(l*u+h*m),g=Math.round(n.worldScreenWidth);if(p<=g)return!1;const S=l*m+h*u,E=g*r,b=(e.left-e.right)*r/l,f=(e.bottom-e.top)*r/h;a.set(this._worldDimensionsPx,E,S,1),a.set(this._pxToNdc,2/l,-2/h,1),a.set(this._centerNdc,b,f,1);const C=this._mat3;return s.fromTranslation(C,this._centerNdc),s.scale(C,C,this._pxToNdc),0!==c&&s.rotate(C,C,d),s.scale(C,C,this._worldDimensionsPx),s.translate(C,C,_),!0}}t.WorldExtentRenderer=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
