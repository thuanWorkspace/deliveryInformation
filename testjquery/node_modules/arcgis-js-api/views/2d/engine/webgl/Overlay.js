/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/Error","../../../../core/events","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/perspectiveUtils","../../../../core/reactiveUtils","../../../../chunks/mat3f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../symbols/cim/enums","../DisplayObject","./animatedFormats/utils","../../../webgl/BufferObject","../../../webgl/contextUtils","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/VertexArrayObject"],(function(e,t,i,s,r,n,a,o,l,h,c,p,u,m,d,y,w,f,g){"use strict";const x=o.create(),T={none:c.AnimatedSymbolRepeatType.None,loop:c.AnimatedSymbolRepeatType.Loop,oscillate:c.AnimatedSymbolRepeatType.Oscillate};function v(e){return e?{...e,playAnimation:e.playing,repeatType:e.repeatType?T[e.repeatType]:void 0}:{}}class b extends p.DisplayObject{constructor(s){super(),this.elementView=s,this.isWrapAround=!1,this.perspectiveTransform=h.create(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(a.watch((()=>this.elementView.element.opacity),(e=>this.opacity=e),a.initial),a.watch((()=>[this.elementView.coords]),(()=>{this.requestRender()}),a.initial),a.watch((()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions]),(()=>{this._playHandle?.remove(),this.texture=r.disposeMaybe(this.texture),this.requestRender()}),a.initial),a.when((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&null!=e.content&&this._handles.push(t.on(e.content,"play",(()=>this.requestRender())))}),a.initial)),s.element.load().catch((t=>{i.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new e("element-load-error","Element cannot be displayed",{element:s,error:t}))}))}destroy(){this._playHandle?.remove(),this._handles.forEach((e=>e.remove())),this.texture=r.disposeMaybe(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,i=this.elementView.element.content;if(null!=i){const e=i instanceof HTMLImageElement,r=i instanceof HTMLVideoElement,n=e?i.naturalWidth:r?i.videoWidth:i.width,a=e?i.naturalHeight:r?i.videoHeight:i.height;if(this._updatePerspectiveTransform(n,a),this.texture)r&&!i.paused&&(this.texture.setData(i),this.requestRender(),(t.type===d.ContextType.WEBGL2||s.isPowerOfTwo(n)&&s.isPowerOfTwo(a))&&this.texture.generateMipmap());else{const e=new f.TextureDescriptor;if(e.wrapMode=y.TextureWrapMode.CLAMP_TO_EDGE,e.preMultiplyAlpha=!0,e.width=n,e.height=a,"getFrame"in i){const s=i=>{this.texture?this.texture.setData(i):this.texture=new w.Texture(t,e,i),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=u.play(i,v(this.elementView.element.animationOptions),null,s))}else this.texture=new w.Texture(t,e,i);(t.type===d.ContextType.WEBGL2||s.isPowerOfTwo(n)&&s.isPowerOfTwo(a))&&this.texture.generateMipmap(),r&&!i.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const i=this.elementView.coords;if(null==i)return;const[s,r,n,a]=i.rings[0],o=this._vertices,{x:l,y:h}=e,c=0!==t;c?o.set([r[0]-l,r[1]-h,s[0]-l,s[1]-h,n[0]-l,n[1]-h,a[0]-l,a[1]-h,a[0]-l,a[1]-h,r[0]+t-l,r[1]-h,r[0]+t-l,r[1]-h,s[0]+t-l,s[1]-h,n[0]+t-l,n[1]-h,a[0]+t-l,a[1]-h]):o.set([r[0]-l,r[1]-h,s[0]-l,s[1]-h,n[0]-l,n[1]-h,a[0]-l,a[1]-h]),this.isWrapAround=c}getVAO(e,t,i){if(null==this.elementView.coords)return null;const s=this._vertices;if(this._vao)this._geometryVbo.setData(s);else{this._geometryVbo=m.BufferObject.createVertex(e,y.Usage.DYNAMIC_DRAW,s);const r=m.BufferObject.createVertex(e,y.Usage.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new g.VertexArrayObject(e,i,t,{geometry:this._geometryVbo,tex:r})}return this._vao}_updatePerspectiveTransform(e,t){const i=this._vertices;n.getProjectiveTransform(x,[0,0,e,0,0,t,e,t],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),l.set(this.perspectiveTransform,x[6]/x[8]*e,x[7]/x[8]*t)}}return b}));
