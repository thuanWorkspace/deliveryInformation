/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/Error","../../../../core/Logger","../../../../chunks/earcut","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedGeometry","./number","../../../webgl/BufferObject","../../../webgl/enums"],(function(e,t,r,n,i,o,c,s,a,h){"use strict";const f=t=>{switch(t.BYTES_PER_ELEMENT){case 1:return h.DataType.UNSIGNED_BYTE;case 2:return h.DataType.UNSIGNED_SHORT;case 4:return h.DataType.UNSIGNED_INT;default:throw new e("Cannot get DataType of array")}},u=(e,t,r,n)=>{let i=0;for(let o=1;o<r;o++){const r=e[2*(t+o-1)],n=e[2*(t+o-1)+1];i+=(e[2*(t+o)]-r)*(e[2*(t+o)+1]+n)}return n?i>0:i<0},y=({coords:e,lengths:t},n)=>{const i=[];for(let o=0,c=0;o<t.length;c+=t[o],o+=1){const s=c,a=[];for(;o<t.length-1&&u(e,c+t[o],t[o+1],n);o+=1,c+=t[o])a.push(c+t[o]-s);const h=e.slice(2*s,2*(c+t[o])),f=r.earcut(h,a,2);for(const e of f)i.push(e+s)}return i};class m{constructor(e,t,r,n=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=n}static fromRect({x:e,y:t,width:r,height:n}){const i=e,o=t,c=i+r,s=o+n;return m.fromScreenExtent({xmin:i,ymin:o,xmax:c,ymax:s})}static fromPath(e){const t=o.convertFromNestedArray(new c,e.path,!1,!1),r=t.coords,n=new Uint32Array(y(t,!0)),i=new Uint32Array(r.length/2);for(let o=0;o<i.length;o++)i[o]=s.i1616to32(Math.floor(r[2*o]),Math.floor(r[2*o+1]));return new m({geometry:i},n,h.PrimitiveType.TRIANGLES)}static fromGeometry(r,n){const i=n.geometry?.type;switch(i){case"polygon":return m.fromPolygon(r,n.geometry);case"extent":return m.fromMapExtent(r,n.geometry);default:return t.getLogger("esri.views.2d.engine.webgl.Mesh2D").error(new e("mapview-bad-type",`Unable to create a mesh from type ${i}`,n)),m.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(e,t){const r=o.convertFromPolygon(new c,t,!1,!1),a=r.coords,f=new Uint32Array(y(r,!1)),u=new Uint32Array(a.length/2),g=i.create(),l=i.create();for(let i=0;i<u.length;i++)n.set(g,a[2*i],a[2*i+1]),e.toScreen(l,g),u[i]=s.i1616to32(Math.floor(l[0]),Math.floor(l[1]));return new m({geometry:u},f,h.PrimitiveType.TRIANGLES,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:r,ymax:n}){const i={geometry:new Uint32Array([s.i1616to32(e,r),s.i1616to32(t,r),s.i1616to32(e,n),s.i1616to32(e,n),s.i1616to32(t,r),s.i1616to32(t,n)])},o=new Uint32Array([0,1,2,3,4,5]);return new m(i,o,h.PrimitiveType.TRIANGLES)}static fromMapExtent(e,t){const[r,n]=e.toScreen([0,0],[t.xmin,t.ymin]),[i,o]=e.toScreen([0,0],[t.xmax,t.ymax]),c={geometry:new Uint32Array([s.i1616to32(r,n),s.i1616to32(i,n),s.i1616to32(r,o),s.i1616to32(r,o),s.i1616to32(i,n),s.i1616to32(i,o)])},a=new Uint32Array([0,1,2,3,4,5]);return new m(c,a,h.PrimitiveType.TRIANGLES)}destroy(){null!=this._cache.indexBuffer&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)null!=this._cache.vertexBuffers[e]&&this._cache.vertexBuffers[e].dispose()}get elementType(){return f(this.indices)}getIndexBuffer(e,t=h.Usage.STATIC_DRAW){return this._cache.indexBuffer||(this._cache.indexBuffer=a.BufferObject.createIndex(e,t,this.indices)),this._cache.indexBuffer}getVertexBuffers(e,t=h.Usage.STATIC_DRAW){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((r,n)=>({...r,[n]:a.BufferObject.createVertex(e,t,this.vertices[n])})),{})),this._cache.vertexBuffers}}return m}));
