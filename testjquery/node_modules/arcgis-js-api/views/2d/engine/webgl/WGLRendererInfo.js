/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/screenUtils","../../../../core/unitUtils","../../../../renderers/support/lengthUtils","./Utils","./techniques/Technique","./techniques/utils","../../../webgl/capabilities"],(function(e,t,i,s,a,l,r,n){"use strict";function o(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}class v{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=l.Technique}getSizeVVFieldStops(e){const t=this._vvSizeFieldStops;if(t)switch(t.type){case"static":return t;case"level-dependent":return t.levels[e]??(()=>{let i=1/0,s=0;for(const n in t.levels){const t=parseFloat(n),a=Math.abs(e-t);a<i&&(i=a,s=t)}if(i===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const a=2**((e-s)/2),l=t.levels[s],r=new Float32Array(l.values);return r[2]*=a,r[3]*=a,{sizes:l.sizes,values:r}})();default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){null!=this._vvInfo&&this._updateVisualVariables(this._vvInfo.vvRanges,e)}setInfo(e,t,i){this._updateEffects(i),this._vvInfo=t,this._technique=r.getTechniqueFromRenderer(e),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,e)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:n.getWebGLCapabilities("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(e){this.outsideLabelsVisible=null!=e&&e.excludedLabelsVisible}_updateVisualVariables(e,l){const r=this._vvMaterialParameters;if(r.vvOpacityEnabled=!1,r.vvSizeEnabled=!1,r.vvColorEnabled=!1,r.vvRotationEnabled=!1,!e)return;const n=e.size;if(n){if(r.vvSizeEnabled=!0,n.minMaxValue){const e=n.minMaxValue;let i,s;if(a.isDefined(e.minSize)&&a.isDefined(e.maxSize))if(a.isNumber(e.minSize)&&a.isNumber(e.maxSize))i=t.pt2px(e.minSize),s=t.pt2px(e.maxSize);else{const a=l.scale;i=t.pt2px(o(a,e.minSize.stops)),s=t.pt2px(o(a,e.maxSize.stops))}this.vvSizeMinMaxValue.set([e.minDataValue,e.maxDataValue,i,s])}if(n.scaleStops&&(this.vvSizeScaleStopsValue=t.pt2px(o(l.scale,n.scaleStops.stops))),n.unitValue){const e=i.getMetersPerUnitForSR(l.spatialReference)/s.meterIn[n.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=e/l.resolution}n.fieldStops&&(this._vvSizeFieldStops=n.fieldStops)}const v=e.color;v&&(r.vvColorEnabled=!0,this.vvColorValues.set(v.values),this.vvColors.set(v.colors));const u=e.opacity;u&&(r.vvOpacityEnabled=!0,this.vvOpacityValues.set(u.values),this.vvOpacities.set(u.opacities));const c=e.rotation;c&&(r.vvRotationEnabled=!0,r.vvRotationType=c.type)}}e.WGLRendererInfo=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
