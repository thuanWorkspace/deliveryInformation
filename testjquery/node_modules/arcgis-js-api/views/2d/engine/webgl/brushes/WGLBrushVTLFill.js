/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a,r,l){"use strict";const o=1/65536;class s extends r{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(e,t){const{displayLevel:i,drawPhase:r,renderPass:l,spriteMosaic:o,styleLayerUID:s}=e;let u=!1;for(const n of t)if(n.layerData.has(s)){const e=n.layerData.get(s);if(e.fillIndexCount>0||e.outlineIndexCount>0){u=!0;break}}if(!u)return;const f=e.styleLayer,d=f.getPaintProperty("fill-pattern"),c=void 0!==d,p=c&&d.isDataDriven;let m;if(c&&!p){const e=d.getValue(i);m=o.getMosaicItemPosition(e,!0)}const g=!c&&f.getPaintValue("fill-antialias",i);let y=!0,T=1;if(!c){const e=f.getPaintProperty("fill-color"),t=f.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=f.getPaintValue("fill-color",i);T=f.getPaintValue("fill-opacity",i)*e[3],T>=1&&(y=!1)}}if(y&&"opaque"===l)return;let v;r===n.WGLDrawPhase.HITTEST&&(v=a.u32to4Xu8(s+1));const P=f.getPaintValue("fill-translate",i),M=f.getPaintValue("fill-translate-anchor",i);(y||"translucent"!==l)&&this._drawFill(e,s,f,t,P,M,c,m,p,v);const _=!f.hasDataDrivenOutlineColor&&f.outlineUsesFillColor&&T<1;g&&"opaque"!==l&&!_&&this._drawOutline(e,s,f,t,P,M,v)}_drawFill(e,a,r,s,u,f,d,c,p,m){if(d&&!p&&null==c)return;const{context:g,displayLevel:y,state:T,drawPhase:v,painter:P,pixelRatio:M,spriteMosaic:_,requestRender:E,allowDelayedRender:U}=e,x=r.fillMaterial,D=P.vectorTilesMaterialManager,S=M>i.vtlHighResCutoff?2:1,h=v===n.WGLDrawPhase.HITTEST,I=this._fillProgramOptions;I.id=h,I.pattern=d;const w=D.getMaterialProgram(g,x,I);if(U&&null!=E&&!w.compiled)return void E();if(g.useProgram(w),null!=c){const{page:e}=c,t=_.getPageSize(e);null!=t&&(_.bind(g,l.TextureSamplingMode.LINEAR,e,i.vtlTextureBindingUnitSprites),w.setUniform2fv("u_mosaicSize",t),w.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites))}w.setUniformMatrix3fv("u_displayMat3",f===t.TranslateAnchor.VIEWPORT?T.displayMat3:T.displayViewMat3),w.setUniform2fv("u_fillTranslation",u),w.setUniform1f("u_depth",r.z+o),h&&w.setUniform4fv("u_id",m);let L=-1;for(const t of s){if(!t.layerData.has(a))continue;t.key.level!==L&&(L=t.key.level,x.setDataUniforms(w,y,r,L,_));const e=t.layerData.get(a);if(!e.fillIndexCount)continue;e.prepareForRendering(g);const n=e.fillVAO;if(null!=n){if(g.bindVAO(n),w.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),g.setStencilFunction(l.CompareFunction.EQUAL,t.stencilRef,255),d){const e=Math.max(2**(Math.round(y)-t.key.level),1),i=t.rangeX/(S*t.width*e);w.setUniform1f("u_patternFactor",i)}if(p){const t=e.patternMap;if(!t)continue;for(const[e,n]of t){const t=_.getPageSize(e);null!=t&&(_.bind(g,l.TextureSamplingMode.LINEAR,e,i.vtlTextureBindingUnitSprites),w.setUniform2fv("u_mosaicSize",t),w.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites),g.drawElements(l.PrimitiveType.TRIANGLES,n[1],l.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else g.drawElements(l.PrimitiveType.TRIANGLES,e.fillIndexCount,l.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.fillIndexStart);t.triangleCount+=e.fillIndexCount/3}}}_drawOutline(e,i,a,r,s,u,f){const{context:d,displayLevel:c,state:p,drawPhase:m,painter:g,pixelRatio:y,spriteMosaic:T,requestRender:v,allowDelayedRender:P}=e,M=a.outlineMaterial,_=g.vectorTilesMaterialManager,E=.75/y,U=m===n.WGLDrawPhase.HITTEST,x=this._outlineProgramOptions;x.id=U;const D=_.getMaterialProgram(d,M,x);if(P&&null!=v&&!D.compiled)return void v();d.useProgram(D),D.setUniformMatrix3fv("u_displayMat3",u===t.TranslateAnchor.VIEWPORT?p.displayMat3:p.displayViewMat3),D.setUniform2fv("u_fillTranslation",s),D.setUniform1f("u_depth",a.z+o),D.setUniform1f("u_outline_width",E),U&&D.setUniform4fv("u_id",f);let S=-1;for(const t of r){if(!t.layerData.has(i))continue;t.key.level!==S&&(S=t.key.level,M.setDataUniforms(D,c,a,S,T));const e=t.layerData.get(i);if(e.prepareForRendering(d),!e.outlineIndexCount)continue;const n=e.outlineVAO;null!=n&&(d.bindVAO(n),D.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),d.setStencilFunction(l.CompareFunction.EQUAL,t.stencilRef,255),d.drawElements(l.PrimitiveType.TRIANGLES,e.outlineIndexCount,l.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),t.triangleCount+=e.outlineIndexCount/3)}}}e.WGLBrushVTLFill=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
