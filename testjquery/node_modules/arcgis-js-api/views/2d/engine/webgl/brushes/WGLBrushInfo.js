/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../../chunks/vec4f32","../DefaultVertexAttributeLayouts","./WGLBrush","../shaders/BackgroundPrograms","../shaders/TileInfoPrograms","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/ProgramTemplate","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexArrayObject","../../../../webgl/capabilities/isWebGL2Context"],(function(e,t,r,i,s,o,n,a,l,u,c,g){"use strict";const _=300,d=32;class f extends r{constructor(){super(...arguments),this._color=e.fromValues(1,0,0,1)}dispose(){this._outlineProgram?.dispose(),this._outlineProgram=null,this._tileInfoProgram?.dispose(),this._tileInfoProgram=null,this._outlineVertexArrayObject?.dispose(),this._outlineVertexArrayObject=null,this._tileInfoVertexArrayObject?.dispose(),this._tileInfoVertexArrayObject=null,this._canvas=null}prepareState({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA,n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!1)}draw(e,t){const{context:r,requestRender:i,allowDelayedRender:s}=e;if(!t.isReady)return;if(this._loadWGLResources(r),s&&null!=i&&(!this._outlineProgram.compiled||!this._tileInfoProgram.compiled))return void i();r.bindVAO(this._outlineVertexArrayObject),r.useProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._outlineProgram.setUniform2f("u_coord_range",t.rangeX,t.rangeY),this._outlineProgram.setUniform1f("u_depth",0),this._outlineProgram.setUniform4fv("u_color",this._color),r.drawArrays(n.PrimitiveType.LINE_STRIP,0,4);const o=this._getTexture(r,t);o?(r.bindVAO(this._tileInfoVertexArrayObject),r.useProgram(this._tileInfoProgram),r.bindTexture(o,0),this._tileInfoProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._tileInfoProgram.setUniform1f("u_depth",0),this._tileInfoProgram.setUniform2f("u_coord_ratio",t.rangeX/t.width,t.rangeY/t.height),this._tileInfoProgram.setUniform2f("u_delta",8,8),this._tileInfoProgram.setUniform2f("u_dimensions",o.descriptor.width,o.descriptor.height),r.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,0,4),r.bindVAO()):r.bindVAO()}_loadWGLResources(e){if(this._outlineProgram&&this._tileInfoProgram)return;const r=a.createProgram(e,i.background),l=a.createProgram(e,s.tileInfo),u=new Int8Array([0,0,1,0,1,1,0,1]),g=o.BufferObject.createVertex(e,n.Usage.STATIC_DRAW,u),_=new c.VertexArrayObject(e,i.background.attributes,t.Pos2b,{geometry:g}),d=new Int8Array([0,0,1,0,0,1,1,1]),f=o.BufferObject.createVertex(e,n.Usage.STATIC_DRAW,d),h=new c.VertexArrayObject(e,s.tileInfo.attributes,t.Pos2b,{geometry:f});this._outlineProgram=r,this._tileInfoProgram=l,this._outlineVertexArrayObject=_,this._tileInfoVertexArrayObject=h}_getTexture(e,t){if(t.texture&&t.triangleCountReportedInDebug===t.triangleCount)return t.texture;t.triangleCountReportedInDebug=t.triangleCount,this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","tileCanvas2d"),this._canvas.setAttribute("width",`${_}`),this._canvas.setAttribute("height",`${d}`),this._canvas.setAttribute("style","display:none"));const r=t.triangleCount;let i=t.key.id;t.triangleCount>0&&(i+=`, ${r}`);const s=this._canvas,o=s.getContext("2d");o.font="24px sans-serif",o.textAlign="left",o.textBaseline="top",o.clearRect(0,0,_,d),r>1e5?(o.fillStyle="red",o.fillRect(0,0,_,d),o.fillStyle="black"):(o.clearRect(0,0,_,d),o.fillStyle="blue"),o.fillText(i,0,0);const a=new u.TextureDescriptor;return a.wrapMode=n.TextureWrapMode.CLAMP_TO_EDGE,a.samplingMode=n.TextureSamplingMode.NEAREST,a.isImmutable=g(e.gl),t.texture=new l.Texture(e,a,s),t.texture}}return f}));
