/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../definitions","./WGLBrush","../materialKey/MaterialKey","../../../../webgl/enums"],(function(t,e,i,a){"use strict";class s extends e{constructor(){super(...arguments),this._computeDesc=new Map}prepareState({context:t},e){e&&e.includes("hittest")?t.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE,a.BlendFactor.ONE,a.BlendFactor.ONE):t.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA,a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!0)}draw(t,e,s){const o=this.getGeometryType();e.commit(t);const n=e.getGeometry(o);null!=n&&(t.timeline.begin(this.name),t.attributeView.bindTextures(t.context),t.context.setStencilFunction(a.CompareFunction.EQUAL,e.stencilRef,255),n.forEachCommand((a=>{const o=i.MaterialKeyBase.load(a.materialKey).symbologyType;this.supportsSymbology(o)&&this.drawGeometry(t,e,a,s)})))}_setSharedUniforms(e,i,a){const{displayLevel:s,pixelRatio:o,state:n,passOptions:r}=i;null!=r&&"hittest"===r.type&&(e.setUniform2fv("u_hittestPos",r.position),e.setUniform1f("u_hittestDist",r.distance)),e.setUniform1f("u_pixelRatio",o),e.setUniformMatrix3fv("u_tileMat3",a.transforms.tileMat3),e.setUniformMatrix3fv("u_viewMat3",n.viewMat3),e.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),e.setUniformMatrix3fv("u_displayViewMat3",n.displayViewMat3),e.setUniform1f("u_currentZoom",Math.floor(s*t.minMaxZoomPrecisionFactor)),e.setUniform1i("u_attributeTextureSize",i.attributeView.size),e.setUniform1i("u_attributeData0",t.textureBindingAttributeData0),e.setUniform1i("u_attributeData1",t.textureBindingAttributeData1),e.setUniform1i("u_attributeData2",t.textureBindingAttributeData2),e.setUniform1i("u_attributeData3",t.textureBindingAttributeData3),e.setUniform1i("u_attributeData4",t.textureBindingAttributeData4),e.setUniform1i("u_attributeData5",t.textureBindingAttributeData5)}_setSizeVVUniforms(t,e,i,a){if(t.vvSizeMinMaxValue&&e.setUniform4fv("u_vvSizeMinMaxValue",i.vvSizeMinMaxValue),t.vvSizeScaleStops&&e.setUniform1f("u_vvSizeScaleStopsValue",i.vvSizeScaleStopsValue),t.vvSizeFieldStops){const t=i.getSizeVVFieldStops(a.key.level);null!=t&&(e.setUniform1fv("u_vvSizeFieldStopsValues",t.values),e.setUniform1fv("u_vvSizeFieldStopsSizes",t.sizes))}t.vvSizeUnitValue&&e.setUniform1f("u_vvSizeUnitValueWorldToPixelsRatio",i.vvSizeUnitValueToPixelsRatio)}_setColorAndOpacityVVUniforms(t,e,i){t.vvColor&&(e.setUniform1fv("u_vvColorValues",i.vvColorValues),e.setUniform4fv("u_vvColors",i.vvColors)),t.vvOpacity&&(e.setUniform1fv("u_vvOpacityValues",i.vvOpacityValues),e.setUniform1fv("u_vvOpacities",i.vvOpacities))}_setRotationVVUniforms(t,e,i){t.vvRotation&&e.setUniform1f("u_vvRotationType","geographic"===i.vvMaterialParameters.vvRotationType?0:1)}_getTriangleDesc(t,e,i=["a_pos"]){const a=e.bufferLayouts.geometry,s=i.map((t=>a.findIndex((e=>e.name===t)))),o=`${t}-${s.join("-")}`;let n=this._computeDesc.get(o);if(!n){const t=e.strides,i=e.strides.geometry,r=new Map(e.attributes),u=a.map((t=>({...t}))),l=Math.max(...e.attributes.values()),v={geometry:u};let f=0;for(const e of s){const t=a[e];v.geometry.push({count:t.count,name:t.name+"1",divisor:t.divisor,normalized:t.normalized,offset:i+t.offset,stride:i,type:t.type}),v.geometry.push({count:t.count,name:t.name+"2",divisor:t.divisor,normalized:t.normalized,offset:2*i+t.offset,stride:i,type:t.type}),r.set(t.name+"1",l+ ++f),r.set(t.name+"2",l+ ++f)}n={bufferLayouts:v,attributes:r,strides:t},this._computeDesc.set(o,n)}return n}}return s}));
