/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a,r,s){"use strict";class o extends r{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(e,r){const{context:o,displayLevel:l,state:u,drawPhase:f,painter:d,pixelRatio:c,spriteMosaic:p,styleLayerUID:m,requestRender:g,allowDelayedRender:y}=e;if(!r.some((e=>e.layerData.get(m)?.lineIndexCount??!1)))return;const T=e.styleLayer,v=T.lineMaterial,M=d.vectorTilesMaterialManager,U=T.getPaintValue("line-translate",l),S=T.getPaintValue("line-translate-anchor",l),E=T.getPaintProperty("line-pattern"),x=void 0!==E,P=x&&E.isDataDriven;let _,I;if(x&&!P){const e=E.getValue(l);_=p.getMosaicItemPosition(e)}let D=!1;if(!x){const e=T.getPaintProperty("line-dasharray");if(I=void 0!==e,D=I&&e.isDataDriven,I&&!D){const t=e.getValue(l),i=T.getDashKey(t,T.getLayoutValue("line-cap",l));_=p.getMosaicItemPosition(i)}}const L=1/c,h=f===n.WGLDrawPhase.HITTEST,N=this._programOptions;N.id=h,N.pattern=x,N.sdf=I;const R=M.getMaterialProgram(o,v,N);if(y&&null!=g&&!R.compiled)return void g();if(o.useProgram(R),R.setUniformMatrix3fv("u_displayViewMat3",u.displayViewMat3),R.setUniformMatrix3fv("u_displayMat3",S===t.TranslateAnchor.VIEWPORT?u.displayMat3:u.displayViewMat3),R.setUniform2fv("u_lineTranslation",U),R.setUniform1f("u_depth",T.z),R.setUniform1f("u_antialiasing",L),h){const e=a.u32to4Xu8(m+1);R.setUniform4fv("u_id",e)}if(_&&null!=_){const{page:e}=_,t=p.getPageSize(e);null!=t&&(p.bind(o,s.TextureSamplingMode.LINEAR,e,i.vtlTextureBindingUnitSprites),R.setUniform2fv("u_mosaicSize",t),R.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites))}let V=-1;for(const t of r){if(!t.layerData.has(m))continue;t.key.level!==V&&(V=t.key.level,v.setDataUniforms(R,l,T,V,p));const e=2**(l-V)/c;R.setUniform1f("u_zoomFactor",e);const n=t.layerData.get(m);if(!n.lineIndexCount)continue;n.prepareForRendering(o);const a=n.vao;if(null!=a){if(o.bindVAO(a),R.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),o.setStencilFunction(s.CompareFunction.EQUAL,t.stencilRef,255),P||D){const e=n.patternMap;if(!e)continue;for(const[t,n]of e){const e=p.getPageSize(t);null!=e&&(p.bind(o,s.TextureSamplingMode.LINEAR,t,i.vtlTextureBindingUnitSprites),R.setUniform2fv("u_mosaicSize",e),R.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites),o.drawElements(s.PrimitiveType.TRIANGLES,n[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else o.drawElements(s.PrimitiveType.TRIANGLES,n.lineIndexCount,s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.lineIndexStart);t.triangleCount+=n.lineIndexCount/3}}}}e.WGLBrushVTLLine=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
