/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/vec2f32","../../vectorTiles/decluttering/config","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../GeometryUtils","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,a,n,r,o,s,l,u){"use strict";const c=1/65536;class f extends l{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t.create()}dispose(){}drawMany(e,t){const{drawPhase:i,styleLayerUID:a}=e,n=e.styleLayer;let o;i===r.WGLDrawPhase.HITTEST&&(o=s.u32to4Xu8(a+1)),this._drawIcons(e,n,t,o),this._drawText(e,n,t,o)}_drawIcons(e,t,s,l){const{context:u,displayLevel:c,drawPhase:f,painter:p,spriteMosaic:m,state:d,styleLayerUID:g,requestRender:y,allowDelayedRender:T}=e,h=t.iconMaterial,_=p.vectorTilesMaterialManager;let P,M=!1;for(const i of s)if(i.layerData.has(g)&&(P=i.layerData.get(g),P.iconPerPageElementsMap.size>0)){M=!0;break}if(!M)return;const U=t.getPaintValue("icon-translate",c),S=t.getPaintValue("icon-translate-anchor",c);let v=t.getLayoutValue("icon-rotation-alignment",c);v===a.RotationAlignment.AUTO&&(v=t.getLayoutValue("symbol-placement",c)===a.SymbolPlacement.POINT?a.RotationAlignment.VIEWPORT:a.RotationAlignment.MAP);const E=v===a.RotationAlignment.MAP,x=t.getLayoutValue("icon-keep-upright",c)&&E,D=P.isIconSDF,R=f===r.WGLDrawPhase.HITTEST,A=this._iconProgramOptions;A.id=R,A.sdf=D;const I=_.getMaterialProgram(u,h,A);if(T&&null!=y&&!I.compiled)return void y();u.useProgram(I),I.setUniformMatrix3fv("u_displayViewMat3",v===a.RotationAlignment.MAP?d.displayViewMat3:d.displayMat3),I.setUniformMatrix3fv("u_displayMat3",S===a.TranslateAnchor.VIEWPORT?d.displayMat3:d.displayViewMat3),I.setUniform2fv("u_iconTranslation",U),I.setUniform1f("u_depth",t.z),I.setUniform1f("u_mapRotation",o.degToByte(d.rotation)),I.setUniform1f("u_keepUpright",x?1:0),I.setUniform1f("u_level",10*c),I.setUniform1i("u_texture",n.vtlTextureBindingUnitSprites),I.setUniform1f("u_fadeDuration",i.fadeDuration/1e3),R&&I.setUniform4fv("u_id",l);let V=-1;for(const i of s){if(!i.layerData.has(g))continue;if(i.key.level!==V&&(V=i.key.level,h.setDataUniforms(I,c,t,V,m)),P=i.layerData.get(g),0===P.iconPerPageElementsMap.size)continue;P.prepareForRendering(u),P.updateOpacityInfo();const a=P.iconVAO;if(null!=a){u.bindVAO(a),I.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),I.setUniform1f("u_time",(performance.now()-P.lastOpacityUpdate)/1e3);for(const[t,a]of P.iconPerPageElementsMap)this._renderIconRange(e,I,a,t,i)}}}_renderIconRange(e,t,i,a,r){const{context:o,spriteMosaic:s}=e;this._spritesTextureSize[0]=s.getWidth(a)/4,this._spritesTextureSize[1]=s.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),s.bind(o,u.TextureSamplingMode.LINEAR,a,n.vtlTextureBindingUnitSprites),this._setStencilState(e,r),o.drawElements(u.PrimitiveType.TRIANGLES,i[1],u.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),r.triangleCount+=i[1]/3}_drawText(e,s,l,u){const{context:f,displayLevel:p,drawPhase:m,glyphMosaic:d,painter:g,pixelRatio:y,spriteMosaic:T,state:h,styleLayerUID:_,requestRender:P,allowDelayedRender:M}=e,U=s.textMaterial,S=g.vectorTilesMaterialManager;let v,E=!1;for(const t of l)if(t.layerData.has(_)&&(v=t.layerData.get(_),v.glyphPerPageElementsMap.size>0)){E=!0;break}if(!E)return;const x=s.getPaintProperty("text-opacity");if(x&&!x.isDataDriven&&0===x.getValue(p))return;const D=s.getPaintProperty("text-color"),R=!D||D.isDataDriven||D.getValue(p)[3]>0,A=s.getPaintProperty("text-halo-width"),I=s.getPaintProperty("text-halo-color"),V=(!A||A.isDataDriven||A.getValue(p)>0)&&(!I||I.isDataDriven||I.getValue(p)[3]>0);if(!R&&!V)return;const L=24/8;let w=s.getLayoutValue("text-rotation-alignment",p);w===a.RotationAlignment.AUTO&&(w=s.getLayoutValue("symbol-placement",p)===a.SymbolPlacement.POINT?a.RotationAlignment.VIEWPORT:a.RotationAlignment.MAP);const O=w===a.RotationAlignment.MAP,N=s.getLayoutValue("text-keep-upright",p)&&O,b=m===r.WGLDrawPhase.HITTEST,G=.8*L/y;this._glyphTextureSize||(this._glyphTextureSize=t.fromValues(d.width/4,d.height/4));const z=s.getPaintValue("text-translate",p),W=s.getPaintValue("text-translate-anchor",p),k=this._sdfProgramOptions;k.id=b;const B=S.getMaterialProgram(f,U,k);if(M&&null!=P&&!B.compiled)return void P();f.useProgram(B),B.setUniformMatrix3fv("u_displayViewMat3",w===a.RotationAlignment.MAP?h.displayViewMat3:h.displayMat3),B.setUniformMatrix3fv("u_displayMat3",W===a.TranslateAnchor.VIEWPORT?h.displayMat3:h.displayViewMat3),B.setUniform2fv("u_textTranslation",z),B.setUniform1f("u_depth",s.z+c),B.setUniform2fv("u_mosaicSize",this._glyphTextureSize),B.setUniform1f("u_mapRotation",o.degToByte(h.rotation)),B.setUniform1f("u_keepUpright",N?1:0),B.setUniform1f("u_level",10*p),B.setUniform1i("u_texture",n.vtlTextureBindingUnitGlyphs),B.setUniform1f("u_antialiasingWidth",G),B.setUniform1f("u_fadeDuration",i.fadeDuration/1e3),b&&B.setUniform4fv("u_id",u);let F=-1;for(const t of l){if(!t.layerData.has(_))continue;if(t.key.level!==F&&(F=t.key.level,U.setDataUniforms(B,p,s,F,T)),v=t.layerData.get(_),0===v.glyphPerPageElementsMap.size)continue;v.prepareForRendering(f),v.updateOpacityInfo();const i=v.textVAO;if(null==i)continue;f.bindVAO(i),B.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._setStencilState(e,t);const a=(performance.now()-v.lastOpacityUpdate)/1e3;B.setUniform1f("u_time",a),v.glyphPerPageElementsMap.forEach(((e,i)=>{this._renderGlyphRange(f,e,i,d,B,V,R,t)}))}}_renderGlyphRange(e,t,i,a,r,o,s,l){a.bind(e,u.TextureSamplingMode.LINEAR,i,n.vtlTextureBindingUnitGlyphs),o&&(r.setUniform1f("u_halo",1),e.drawElements(u.PrimitiveType.TRIANGLES,t[1],u.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),s&&(r.setUniform1f("u_halo",0),e.drawElements(u.PrimitiveType.TRIANGLES,t[1],u.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)}_setStencilState(e,t){const{context:i,is3D:a,stencilSymbols:n}=e;if(i.setStencilTestEnabled(!0),n)return i.setStencilWriteMask(255),void i.setStencilFunction(u.CompareFunction.ALWAYS,t.stencilRef,255);i.setStencilWriteMask(0),a?i.setStencilFunction(u.CompareFunction.EQUAL,t.stencilRef,255):i.setStencilFunction(u.CompareFunction.GREATER,255,255)}}e.WGLBrushVTLSymbol=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
