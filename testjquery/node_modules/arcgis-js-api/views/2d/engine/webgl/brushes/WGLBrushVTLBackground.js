/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/mathUtils","../../../../../chunks/mat3f32","../../../../../chunks/vec4f32","../definitions","../enums","../number","./WGLBrush","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(t,e,r,o,i,a,s,n,c,l,u){"use strict";class f extends n{constructor(){super(...arguments),this._color=o.fromValues(1,0,0,1),this._patternMatrix=r.create(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(t,r){const{context:o,painter:n,styleLayerUID:c,requestRender:u,allowDelayedRender:f}=t;this._loadWGLResources(t);const d=t.displayLevel,g=t.styleLayer,_=g.backgroundMaterial,h=n.vectorTilesMaterialManager,m=g.getPaintValue("background-color",d),p=g.getPaintValue("background-opacity",d),v=g.getPaintValue("background-pattern",d),x=void 0!==v,y=m[3]*p,b=1|window.devicePixelRatio,M=t.spriteMosaic;let w,T;const U=b>i.vtlHighResCutoff?2:1,L=t.drawPhase===a.WGLDrawPhase.HITTEST,P=this._programOptions;P.id=L,P.pattern=x;const A=h.getMaterialProgram(o,_,P);if(!f||null==u||A.compiled){if(o.bindVAO(this._vao),o.useProgram(A),x){const t=M.getMosaicItemPosition(v,!0);if(null!=t){const{tl:e,br:r,page:a}=t;w=r[0]-e[0],T=r[1]-e[1];const s=M.getPageSize(a);null!=s&&(M.bind(o,l.TextureSamplingMode.LINEAR,a,i.vtlTextureBindingUnitSprites),A.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),A.setUniform2fv("u_mosaicSize",s),A.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites))}A.setUniform1f("u_opacity",p)}else this._color[0]=y*m[0],this._color[1]=y*m[1],this._color[2]=y*m[2],this._color[3]=y,A.setUniform4fv("u_color",this._color);if(A.setUniform1f("u_depth",g.z||0),L){const t=s.u32to4Xu8(c+1);A.setUniform4fv("u_id",t)}for(const t of r){if(A.setUniform1f("u_coord_range",t.rangeX),A.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),x){const r=Math.max(2**(Math.round(d)-t.key.level),1),o=U*t.width*r,i=o/e.nextPowerOfTwo(w),a=o/e.nextPowerOfTwo(T);this._patternMatrix[0]=i,this._patternMatrix[4]=a,A.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}o.setStencilFunction(l.CompareFunction.EQUAL,0,255),o.drawArrays(l.PrimitiveType.TRIANGLE_STRIP,0,4)}}else u()}_loadWGLResources(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),a=c.BufferObject.createVertex(e,l.Usage.STATIC_DRAW,i),s=new u.VertexArrayObject(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:a});this._vao=s}}t.WGLBrushVTLBackground=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
