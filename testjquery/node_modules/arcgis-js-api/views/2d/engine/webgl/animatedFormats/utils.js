/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/handleUtils","../../../../../core/time","../../../../../geometry/support/meshUtils/exporters/gltf/imageutils","../../../../../symbols/cim/enums","../grouping"],(function(e,t,i,a,r,n){"use strict";function o(e){return i.Milliseconds(e.frameDurations.reduce(((e,t)=>e+t),0))}function s(e){const{width:t,height:i}=e,a=e.frameDurations.reverse(),r=t=>{const i=e.frameDurations.length-1-t;return e.getFrame(i)};return{frameCount:e.frameCount,duration:e.duration,frameDurations:a,getFrame:r,width:t,height:i}}function m(e,t){const{width:a,height:r,getFrame:n}=e,o=t/e.duration,s=e.frameDurations.map((e=>i.Milliseconds(e*o)));return{frameCount:e.frameCount,duration:e.duration,frameDurations:s,getFrame:n,width:a,height:r}}function u(e,t){const{width:a,height:r,getFrame:n}=e,o=e.frameDurations.slice(),s=o.shift();return o.unshift(i.Milliseconds(s+t)),{frameCount:e.frameCount,duration:e.duration+t,frameDurations:o,getFrame:n,width:a,height:r}}function c(e,t){const{width:a,height:r,getFrame:n}=e,o=e.frameDurations.slice(),s=o.pop();return o.push(i.Milliseconds(s+t)),{frameCount:e.frameCount,duration:e.duration+t,frameDurations:o,getFrame:n,width:a,height:r}}class l{constructor(e,t,i,a){this._animation=e,this._repeatType=i,this._onFrameData=a,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let r=0;for(;t>r;)r+=this.timeToFrame,this.nextFrame();const n=this._animation.getFrame(this._currentFrame);this._onFrameData(n)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case r.AnimatedSymbolRepeatType.None:this._currentFrame-=this._direction;break;case r.AnimatedSymbolRepeatType.Loop:this._currentFrame=0;break;case r.AnimatedSymbolRepeatType.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case r.AnimatedSymbolRepeatType.None:this._currentFrame-=this._direction;break;case r.AnimatedSymbolRepeatType.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case r.AnimatedSymbolRepeatType.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const e=this._animation.getFrame(this._currentFrame);this._onFrameData(e)}}function h(e,t,a,h){let d,{repeatType:f}=t;if(null==f&&(f=r.AnimatedSymbolRepeatType.Loop),!0===t.reverseAnimation&&(e=s(e)),null!=t.duration&&(e=m(e,i.Milliseconds(1e3*t.duration))),null!=t.repeatDelay){const a=1e3*t.repeatDelay;f===r.AnimatedSymbolRepeatType.Loop?e=c(e,i.Milliseconds(a)):f===r.AnimatedSymbolRepeatType.Oscillate&&(e=u(c(e,i.Milliseconds(a/2)),i.Milliseconds(a/2)))}if(null!=t.startTimeOffset)d=i.Milliseconds(1e3*t.startTimeOffset);else if(null!=t.randomizeStartTime){const r=n.getMaterialGroup(a),s=82749913,m=null!=t.randomizeStartSeed?t.randomizeStartSeed:s,u=n.getRandomValue(r,m);d=i.Milliseconds(u*o(e))}else d=i.Milliseconds(0);return new l(e,d,f,h)}function d(e,i,a,r){const n=null==i.playAnimation||i.playAnimation,o=h(e,i,a,r);let s,m=o.timeToFrame;function u(){s=n?setTimeout((()=>{o.nextFrame(),m=o.timeToFrame,u()}),m):void 0}return u(),t.makeHandle((()=>n&&clearTimeout(s)))}let f,p;function g(){return f??(f=document.createElement("canvas")),p??(p=f.getContext("2d")),{canvas:f,ctx:p}}function F(e,t,i){const{canvas:r,ctx:n}=g();r.width=t,r.height=i;const o=[],s=e.frameDurations.length;for(let m=0;m<s;m++){const r=e.getFrame(m);n.clearRect(0,0,t,i),r instanceof ImageData?n.drawImage(a.imageTypeToCanvas(r),0,0,t,i):n.drawImage(r,0,0,t,i),o.push(n.getImageData(0,0,t,i))}return{width:t,height:i,frameDurations:e.frameDurations,getFrame:e=>o[e],frameCount:e.frameCount,duration:e.duration}}e.Player=l,e.adjustDuration=m,e.appendDelay=c,e.createPlayer=h,e.getDuration=o,e.play=d,e.prependDelay=u,e.resize=F,e.reverse=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
