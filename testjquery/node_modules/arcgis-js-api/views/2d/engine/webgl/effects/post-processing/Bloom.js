/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/maybe","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject","../../../../../webgl/TextureDescriptor"],(function(e,t,s,i,r,o){"use strict";const n=5,a=[1,0],u=[0,1],l=[1,.8,.6,.4,.2],c=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class m{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(n),this._nMips=n,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=t.disposeMaybe(this._quad),this._intensityFBO=t.disposeMaybe(this._intensityFBO),this._compositeFBO=t.disposeMaybe(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,r){const{width:o,height:m}=t,{context:p,painter:_}=e,{materialManager:h}=_,d=p.gl,f=this._programDesc,{strength:b,radius:F,threshold:B}=r;this._quad||(this._quad=new s(p,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,o,m),p.setStencilTestEnabled(!1),p.setBlendingEnabled(!0),p.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),p.setStencilWriteMask(0);const O=this._quad;O.bind(),p.bindFramebuffer(this._intensityFBO);const x=h.getProgram(f.luminosityHighPass);p.useProgram(x),p.bindTexture(t.colorTexture,0),x.setUniform1i("u_texture",0),x.setUniform3fv("u_defaultColor",[0,0,0]),x.setUniform1f("u_defaultOpacity",0),x.setUniform1f("u_luminosityThreshold",B),x.setUniform1f("u_smoothWidth",.01);const g=[Math.round(o/2),Math.round(m/2)];p.setViewport(0,0,g[0],g[1]),p.setClearColor(0,0,0,0),p.clear(d.COLOR_BUFFER_BIT),O.draw(),p.setBlendingEnabled(!1);let T=this._intensityFBO.colorTexture;for(let s=0;s<this._nMips;s++){const e=h.getProgram(f.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[s]}]);p.useProgram(e),p.bindTexture(T,s+1),e.setUniform1i("u_colorTexture",s+1),e.setUniform2fv("u_texSize",g),e.setUniform2fv("u_direction",a),p.setViewport(0,0,g[0],g[1]);const t=this._mipsFBOs[s];p.bindFramebuffer(t.horizontal),O.draw(),T=t.horizontal.colorTexture,p.bindFramebuffer(t.vertical),p.bindTexture(T,s+1),e.setUniform2fv("u_direction",u),O.draw(),T=t.vertical.colorTexture,g[0]=Math.round(g[0]/2),g[1]=Math.round(g[1]/2)}p.setViewport(0,0,o,m);const M=h.getProgram(f.composite,[{name:"nummips",value:n}]);p.bindFramebuffer(this._compositeFBO),p.useProgram(M),M.setUniform1f("u_bloomStrength",b),M.setUniform1f("u_bloomRadius",F),M.setUniform1fv("u_bloomFactors",l),M.setUniform3fv("u_bloomTintColors",c),p.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),M.setUniform1i("u_blurTexture1",1),p.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),M.setUniform1i("u_blurTexture2",2),p.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),M.setUniform1i("u_blurTexture3",3),p.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),M.setUniform1i("u_blurTexture4",4),p.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),M.setUniform1i("u_blurTexture5",5),O.draw(),p.bindFramebuffer(t),p.setBlendingEnabled(!0);const w=h.getProgram(f.blit);p.useProgram(w),p.bindTexture(this._compositeFBO.colorTexture,6),w.setUniform1i("u_texture",6),p.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE),O.draw(),O.unbind(),p.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),p.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,s){const{context:n}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===s)return;this._size[0]=t,this._size[1]=s;const a=[Math.round(t/2),Math.round(s/2)];if(this._compositeFBO)this._compositeFBO.resize(t,s);else{const e=new o.TextureDescriptor(t,s);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._compositeFBO=new r.FramebufferObject(n,e)}if(this._intensityFBO)this._intensityFBO.resize(a[0],a[1]);else{const e=new o.TextureDescriptor(a[0],a[1]);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._intensityFBO=new r.FramebufferObject(n,e)}for(let u=0;u<this._nMips;u++){if(this._mipsFBOs[u])this._mipsFBOs[u].horizontal.resize(a[0],a[1]),this._mipsFBOs[u].vertical.resize(a[0],a[1]);else{const e=new o.TextureDescriptor(a[0],a[1]);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._mipsFBOs[u]={horizontal:new r.FramebufferObject(n,e),vertical:new r.FramebufferObject(n,e)}}a[0]=Math.round(a[0]/2),a[1]=Math.round(a[1]/2)}}}e.Bloom=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
