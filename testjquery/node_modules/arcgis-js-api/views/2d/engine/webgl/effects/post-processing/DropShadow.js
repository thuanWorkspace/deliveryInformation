/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/maybe","../../../../../../core/screenUtils","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject","../../../../../webgl/Texture","../../../../../webgl/TextureDescriptor"],(function(e,t,r,s,i,o,a,n){"use strict";const l=[1,0],u=[0,1];class c{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=t.disposeMaybe(this._layerFBOTexture),this._horizontalBlurFBO=t.disposeMaybe(this._horizontalBlurFBO),this._verticalBlurFBO=t.disposeMaybe(this._verticalBlurFBO)}draw(e,t,o){const{context:a,state:n,painter:c}=e,{materialManager:h}=c,p=this._programDesc,_=t.width,d=t.height,B=[Math.round(_),Math.round(d)],{blurRadius:f,offsetX:b,offsetY:m,color:x}=o,F=[r.pt2px(b),r.pt2px(m)];this._createOrResizeResources(e,_,d,B);const T=this._horizontalBlurFBO,O=this._verticalBlurFBO;a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1);const w=this._layerFBOTexture;t.copyToTexture(0,0,_,d,0,0,w),this._quad||(this._quad=new s(a,[-1,-1,1,-1,-1,1,1,1])),a.setViewport(0,0,B[0],B[1]);const g=this._quad;g.bind(),a.setBlendingEnabled(!1);const M=h.getProgram(p.blur,[{name:"radius",value:Math.ceil(f)}]);a.useProgram(M),a.bindFramebuffer(T),a.bindTexture(t.colorTexture,4),M.setUniform1i("u_colorTexture",4),M.setUniform2fv("u_texSize",B),M.setUniform2fv("u_direction",l),M.setUniform1f("u_sigma",f),g.draw(),a.bindFramebuffer(O),a.bindTexture(T?.colorTexture,5),M.setUniform1i("u_colorTexture",5),M.setUniform2fv("u_direction",u),g.draw(),a.bindFramebuffer(t),a.setViewport(0,0,_,d);const z=h.getProgram(p.composite);a.useProgram(z),a.bindTexture(O?.colorTexture,2),z.setUniform1i("u_blurTexture",2),a.bindTexture(w,3),z.setUniform1i("u_layerFBOTexture",3),z.setUniform4fv("u_shadowColor",[x[3]*(x[0]/255),x[3]*(x[1]/255),x[3]*(x[2]/255),x[3]]),z.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),z.setUniform2fv("u_shadowOffset",F),g.draw(),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!0),a.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),g.unbind()}_createOrResizeResources(e,t,r,s){const{context:l}=e;if(!this._horizontalBlurFBO||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(s[0],s[1]);else{const e=new n.TextureDescriptor(s[0],s[1]);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._horizontalBlurFBO=new o.FramebufferObject(l,e)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(s[0],s[1]);else{const e=new n.TextureDescriptor(s[0],s[1]);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._verticalBlurFBO=new o.FramebufferObject(l,e)}if(this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{const e=new n.TextureDescriptor;e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,e.width=t,e.height=r,this._layerFBOTexture=new a.Texture(l,e)}}}}e.DropShadow=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
