/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,s,i){"use strict";class n extends s.Effect{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0,this._boundFBO=null}dispose(){null!=this._fbo&&this._fbo.dispose()}bind({context:t,painter:e}){this._boundFBO=t.getBoundFramebufferObject();const s=e.getFbos().effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind({context:t}){t.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw(t,s,i=2*e.hittestRadius){this._resolve(t,s,i)}async _resolve({context:t,state:e,pixelRatio:s},n,o){const r=t.getBoundFramebufferObject(),f=e.size[1]*s,a=Math.round(o*s),u=a/2,l=a/2;this._ensureBuffer(a),n.forEach((async(t,e)=>{const o=new Map,h=Math.floor(e.x*s-a/2),c=Math.floor(f-e.y*s-a/2);await r.readPixelsAsync(h,c,a,a,i.PixelFormat.RGBA,i.PixelType.UNSIGNED_BYTE,this._buf);for(let s=0;s<this._buf32.length;s++){const t=this._buf32[s];if(4294967295!==t&&0!==t){const e=s%a,i=a-Math.floor(s/a),n=(u-e)*(u-e)+(l-i)*(l-i),r=o.has(t)?o.get(t):4294967295;o.set(t,Math.min(n,r))}}const b=Array.from(o).sort(((t,e)=>t[1]-e[1])).map((t=>t[0]));t.resolve(b),n.delete(e)}))}_ensureBuffer(t){this._lastSize!==t&&(this._lastSize=t,this._buf=new Uint8Array(4*t*t),this._buf32=new Uint32Array(this._buf.buffer))}}t.HittestEffectVTL=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
