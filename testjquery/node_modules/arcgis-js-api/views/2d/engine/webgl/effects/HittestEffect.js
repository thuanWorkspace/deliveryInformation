/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,i,s){"use strict";class n extends i.Effect{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:t},i,s=e.hittestRadius){if(!i.length)return null;const n=i.shift(),r=n.x,o=n.y;return this._outstanding=n,{type:"hittest",distance:s*t,position:[r,o]}}bind(t){const{context:i,attributeView:s}=t;if(!s.size)return;const n=s.getBlock(e.attributeDataGpgpu);if(null==n)return;const r=n.getFBO(i);i.setViewport(0,0,s.size,s.size),i.bindFramebuffer(r),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT)}unbind(t){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,i){const{context:n,attributeView:r}=t,o=r.getBlock(e.attributeDataGpgpu);if(null==o)return void i.forEach((t=>t.resolve([])));const c=o.getFBO(n),l=new Uint8Array(c.width*c.height*4);try{await c.readPixelsAsync(0,0,c.width,c.height,s.PixelFormat.RGBA,s.PixelType.UNSIGNED_BYTE,l)}catch(d){return void i.forEach((t=>t.resolve([])))}const a=[];for(let e=0;e<l.length;e+=4){const t=l[e],i=l[e+3];t&&a.push({id:e/4,directHits:i})}a.sort(((t,e)=>e.directHits===t.directHits?e.id-t.id:e.directHits-t.directHits));const u=a.map((t=>t.id));i.forEach((t=>t.resolve(u)))}}t.HittestEffect=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
