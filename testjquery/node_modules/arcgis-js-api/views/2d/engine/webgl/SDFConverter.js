/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/floatRGBA","../../../../core/promiseUtils"],(function(t,e){"use strict";const s=1e20;class i{constructor(t){this._svg=null,this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(i,r,h,n=31){this._initSVG();const o=this.createSVGString(i,r);return new Promise(((i,r)=>{const d=new Image;d.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(o),d.onload=()=>{d.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(d,0,0,this.size,this.size);const e=this._context.getImageData(0,0,this.size,this.size),r=new Uint8Array(this.size*this.size*4);for(let t=0;t<this.size*this.size;t++){const i=e.data[4*t+3]/255;this._gridOuter[t]=1===i?0:0===i?s:Math.max(0,.5-i)**2,this._gridInner[t]=1===i?s:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let s=0;s<this.size*this.size;s++){const e=.5-(this._gridOuter[s]-this._gridInner[s])/(2*n);t.packFloatRGBA(e,r,4*s)}i(r)};const a=h?.signal;a&&e.onAbort(a,(()=>r(e.createAbortError())))}))}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}return this._svg}createSVGString(t,e){const s=this._initSVG(),i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",t),s.appendChild(i);const r=i.getBBox(),h=r.width/r.height,n=this.size/2;let o,d,a;if(h>1){o=n/r.width;const t=n*(1/h);d=this.size/4,a=n-t/2}else{o=n/r.height;d=n-n*h/2,a=this.size/4}const l=-r.x*o+d,c=-r.y*o+a;i.setAttribute("style",`transform: matrix(${o}, 0, 0, ${o}, ${l}, ${c})`),i.setAttribute("stroke-width",""+.5/o);const _=`<svg style="fill:${e?"red":"none"}; stroke:${e?"none":"red"}" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${s.innerHTML}</svg>`;return s.removeChild(i),_}_edt(t,e,s){const i=this._f,r=this._d,h=this._v,n=this._z;for(let o=0;o<e;o++){for(let r=0;r<s;r++)i[r]=t[r*e+o];this._edt1d(i,r,h,n,s);for(let i=0;i<s;i++)t[i*e+o]=r[i]}for(let o=0;o<s;o++){for(let s=0;s<e;s++)i[s]=t[o*e+s];this._edt1d(i,r,h,n,e);for(let s=0;s<e;s++)t[o*e+s]=Math.sqrt(r[s])}}_edt1d(t,e,i,r,h){i[0]=0,r[0]=-s,r[1]=+s;for(let n=1,o=0;n<h;n++){let e=(t[n]+n*n-(t[i[o]]+i[o]*i[o]))/(2*n-2*i[o]);for(;e<=r[o];)o--,e=(t[n]+n*n-(t[i[o]]+i[o]*i[o]))/(2*n-2*i[o]);o++,i[o]=n,r[o]=e,r[o+1]=+s}for(let s=0,n=0;s<h;s++){for(;r[n+1]<s;)n++;e[s]=(s-i[n])*(s-i[n])+t[i[n]]}}}return i}));
