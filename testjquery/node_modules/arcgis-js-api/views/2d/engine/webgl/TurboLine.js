/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../symbols/cim/enums","./definitions"],(function(t,e,i){"use strict";function x(t,e){return t.x===e.x&&t.y===e.y}function n(t){if(!t)return;const e=t.length;if(e<=1)return;let i=0;for(let n=1;n<e;n++)x(t[n],t[i])||++i===n||(t[i]=t[n]);t.length=i+1}function r(t,e){return t.x=e.y,t.y=-e.x,t}function y(t,e){return t.x=-e.y,t.y=e.x,t}function s(t,e){return t.x=e.x,t.y=e.y,t}function o(t,e){return t.x=-e.x,t.y=-e.y,t}function h(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function l(t,e){return t.x*e.y-t.y*e.x}function a(t,e){return t.x*e.x+t.y*e.y}function _(t,e,i,x){return t.x=e.x*i+e.y*x,t.y=e.x*x-e.y*i,t}class c{constructor(t,e,i){this._writeVertex=t,this._writeTriangle=e,this._canUseThinTessellation=i,this._prevNormal={x:void 0,y:void 0},this._nextNormal={x:void 0,y:void 0},this._textureNormalLeft={x:0,y:1},this._textureNormalRight={x:0,y:-1},this._textureNormal={x:void 0,y:void 0},this._joinNormal={x:void 0,y:void 0},this._inner={x:void 0,y:void 0},this._outer={x:void 0,y:void 0},this._roundStart={x:void 0,y:void 0},this._roundEnd={x:void 0,y:void 0},this._startBreak={x:void 0,y:void 0},this._endBreak={x:void 0,y:void 0},this._innerPrev={x:void 0,y:void 0},this._innerNext={x:void 0,y:void 0},this._bevelStart={x:void 0,y:void 0},this._bevelEnd={x:void 0,y:void 0},this._bevelMiddle={x:void 0,y:void 0}}tessellate(t,e){n(t),this._canUseThinTessellation&&e.halfWidth<i.thinLineHalfWidthThreshold&&!e.offset?this._tessellateThin(t,e):this._tessellate(t,e)}_tessellateThin(t,e){if(t.length<2)return;const i=e.wrapDistance||65535;let x=e.initialDistance||0,n=!1,r=t[0].x,y=t[0].y;const s=t.length;for(let o=1;o<s;++o){n&&(n=!1,x=0);let e=t[o].x,s=t[o].y,h=e-r,l=s-y,a=Math.sqrt(h*h+l*l);if(h/=a,l/=a,x+a>i){n=!0;const t=(i-x)/a;a=i-x,e=(1-t)*r+t*e,s=(1-t)*y+t*s,--o}const _=this._writeVertex(r,y,0,0,h,l,l,-h,0,-1,x),c=this._writeVertex(r,y,0,0,h,l,-l,h,0,1,x);x+=a;const d=this._writeVertex(e,s,0,0,h,l,l,-h,0,-1,x),T=this._writeVertex(e,s,0,0,h,l,-l,h,0,1,x);this._writeTriangle(_,c,d),this._writeTriangle(c,d,T),r=e,y=s}}_tessellate(t,i){const n=t[0],c=t[t.length-1],d=x(n,c),T=d?3:2;if(t.length<T)return;const u=i.pixelCoordRatio,v=null!=i.capType?i.capType:e.CapType.BUTT,f=null!=i.joinType?i.joinType:e.JoinType.MITER,w=null!=i.miterLimit?Math.min(i.miterLimit,4):2,p=null!=i.roundLimit?Math.min(i.roundLimit,1.05):1.05,g=null!=i.halfWidth?i.halfWidth:2,V=!!i.textured;let m,N,b,E=null;const R=this._prevNormal,M=this._nextNormal;let U=-1,k=-1;const L=this._joinNormal;let B,C;const D=this._textureNormalLeft,J=this._textureNormalRight,S=this._textureNormal;let O=-1,A=-1;const P=i.wrapDistance||65535;let j=i.initialDistance||0;const I=this._writeVertex,W=this._writeTriangle,q=(t,e,i,x,n,r)=>{const y=I(N,b,B,C,i,x,t,e,n,r,j);return O>=0&&A>=0&&y>=0&&W(O,A,y),O=A,A=y,y};d&&(m=t[t.length-2],M.x=c.x-m.x,M.y=c.y-m.y,k=h(M),M.x/=k,M.y/=k);let Q=!1;for(let x=0;x<t.length;++x){if(Q&&(Q=!1,j=0),m&&(R.x=-M.x,R.y=-M.y,U=k,j+U>P&&(Q=!0)),Q){const e=(P-j)/U;U=P-j,m={x:(1-e)*m.x+e*t[x].x,y:(1-e)*m.y+e*t[x].y},--x}else m=t[x];N=m.x,b=m.y;const i=x<=0&&!Q,n=x===t.length-1;if(i||(j+=U),E=n?d?t[1]:null:t[x+1],E?(M.x=E.x-N,M.y=E.y-b,k=h(M),M.x/=k,M.y/=k):(M.x=void 0,M.y=void 0),!d){if(i){y(L,M),B=L.x,C=L.y,v===e.CapType.SQUARE&&(q(-M.y-M.x,M.x-M.y,M.x,M.y,0,-1),q(M.y-M.x,-M.x-M.y,M.x,M.y,0,1)),v===e.CapType.ROUND&&(q(-M.y-M.x,M.x-M.y,M.x,M.y,-1,-1),q(M.y-M.x,-M.x-M.y,M.x,M.y,-1,1)),v!==e.CapType.ROUND&&v!==e.CapType.BUTT||(q(-M.y,M.x,M.x,M.y,0,-1),q(M.y,-M.x,M.x,M.y,0,1));continue}if(n){r(L,R),B=L.x,C=L.y,v!==e.CapType.ROUND&&v!==e.CapType.BUTT||(q(R.y,-R.x,-R.x,-R.y,0,-1),q(-R.y,R.x,-R.x,-R.y,0,1)),v===e.CapType.SQUARE&&(q(R.y-R.x,-R.x-R.y,-R.x,-R.y,0,-1),q(-R.y-R.x,R.x-R.y,-R.x,-R.y,0,1)),v===e.CapType.ROUND&&(q(R.y-R.x,-R.x-R.y,-R.x,-R.y,1,-1),q(-R.y-R.x,R.x-R.y,-R.x,-R.y,1,1));continue}}let c,T,I=-l(R,M);if(Math.abs(I)<.01)a(R,M)>0?(L.x=R.x,L.y=R.y,I=1,c=Number.MAX_VALUE,T=!0):(y(L,M),I=1,c=1,T=!1);else{L.x=(R.x+M.x)/I,L.y=(R.y+M.y)/I,c=h(L);const t=(c-1)*g*u;T=c>4||t>U&&t>k}B=L.x,C=L.y;let W=f;switch(f){case e.JoinType.BEVEL:c<1.05&&(W=e.JoinType.MITER);break;case e.JoinType.ROUND:c<p&&(W=e.JoinType.MITER);break;case e.JoinType.MITER:c>w&&(W=e.JoinType.BEVEL)}switch(W){case e.JoinType.MITER:if(q(L.x,L.y,-R.x,-R.y,0,-1),q(-L.x,-L.y,-R.x,-R.y,0,1),n)break;if(V){const t=Q?0:j;O=this._writeVertex(N,b,B,C,M.x,M.y,L.x,L.y,0,-1,t),A=this._writeVertex(N,b,B,C,M.x,M.y,-L.x,-L.y,0,1,t)}break;case e.JoinType.BEVEL:{const t=I<0;let e,i,x,h;if(t){const t=O;O=A,A=t,e=D,i=J}else e=J,i=D;if(T)x=t?y(this._innerPrev,R):r(this._innerPrev,R),h=t?r(this._innerNext,M):y(this._innerNext,M);else{const e=t?o(this._inner,L):s(this._inner,L);x=e,h=e}const l=t?r(this._bevelStart,R):y(this._bevelStart,R);q(x.x,x.y,-R.x,-R.y,e.x,e.y);const a=q(l.x,l.y,-R.x,-R.y,i.x,i.y);if(n)break;const c=t?y(this._bevelEnd,M):r(this._bevelEnd,M);if(T){const t=this._writeVertex(N,b,B,C,-R.x,-R.y,0,0,0,0,j);O=this._writeVertex(N,b,B,C,M.x,M.y,h.x,h.y,e.x,e.y,j),A=this._writeVertex(N,b,B,C,M.x,M.y,c.x,c.y,i.x,i.y,j),this._writeTriangle(a,t,A)}else{if(V){const t=this._bevelMiddle;t.x=(l.x+c.x)/2,t.y=(l.y+c.y)/2,_(S,t,-R.x,-R.y),q(t.x,t.y,-R.x,-R.y,S.x,S.y),_(S,t,M.x,M.y),O=this._writeVertex(N,b,B,C,M.x,M.y,t.x,t.y,S.x,S.y,j),A=this._writeVertex(N,b,B,C,M.x,M.y,h.x,h.y,e.x,e.y,j)}else{const t=O;O=A,A=t}q(c.x,c.y,M.x,M.y,i.x,i.y)}if(t){const t=O;O=A,A=t}break}case e.JoinType.ROUND:{const t=I<0;let e,i;if(t){const t=O;O=A,A=t,e=D,i=J}else e=J,i=D;const x=t?o(this._inner,L):s(this._inner,L);let h,l;T?(h=t?y(this._innerPrev,R):r(this._innerPrev,R),l=t?r(this._innerNext,M):y(this._innerNext,M)):(h=x,l=x);const d=t?r(this._roundStart,R):y(this._roundStart,R),u=t?y(this._roundEnd,M):r(this._roundEnd,M),v=q(h.x,h.y,-R.x,-R.y,e.x,e.y),f=q(d.x,d.y,-R.x,-R.y,i.x,i.y);if(n)break;const w=this._writeVertex(N,b,B,C,-R.x,-R.y,0,0,0,0,j);T||this._writeTriangle(O,A,w);const p=o(this._outer,x),g=this._writeVertex(N,b,B,C,M.x,M.y,u.x,u.y,i.x,i.y,j);let m,E;const U=c>2;if(U){let e;c!==Number.MAX_VALUE?(p.x/=c,p.y/=c,e=a(R,p),e=(c*(e*e-1)+1)/e):e=-1,m=t?r(this._startBreak,R):y(this._startBreak,R),m.x+=R.x*e,m.y+=R.y*e,E=t?y(this._endBreak,M):r(this._endBreak,M),E.x+=M.x*e,E.y+=M.y*e}_(S,p,-R.x,-R.y);const k=this._writeVertex(N,b,B,C,-R.x,-R.y,p.x,p.y,S.x,S.y,j);_(S,p,M.x,M.y);const P=V?this._writeVertex(N,b,B,C,M.x,M.y,p.x,p.y,S.x,S.y,j):k,W=w,Q=V?this._writeVertex(N,b,B,C,M.x,M.y,0,0,0,0,j):w;let X=-1,H=-1;if(U&&(_(S,m,-R.x,-R.y),X=this._writeVertex(N,b,B,C,-R.x,-R.y,m.x,m.y,S.x,S.y,j),_(S,E,M.x,M.y),H=this._writeVertex(N,b,B,C,M.x,M.y,E.x,E.y,S.x,S.y,j)),V?U?(this._writeTriangle(W,f,X),this._writeTriangle(W,X,k),this._writeTriangle(Q,P,H),this._writeTriangle(Q,H,g)):(this._writeTriangle(W,f,k),this._writeTriangle(Q,P,g)):U?(this._writeTriangle(w,f,X),this._writeTriangle(w,X,H),this._writeTriangle(w,H,g)):(this._writeTriangle(w,f,k),this._writeTriangle(w,P,g)),T?(O=this._writeVertex(N,b,B,C,M.x,M.y,l.x,l.y,e.x,e.y,j),A=g):(O=V?this._writeVertex(N,b,B,C,M.x,M.y,l.x,l.y,e.x,e.y,j):v,this._writeTriangle(O,Q,g),A=g),t){const t=O;O=A,A=t}break}}}}}t.LineTessellation=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
