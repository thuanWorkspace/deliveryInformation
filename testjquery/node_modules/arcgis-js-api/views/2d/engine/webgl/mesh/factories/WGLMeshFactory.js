/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/has","../../../../../../core/promiseUtils","../../../../../../geometry/libtess","../../DisplayId","../templates/WGLLabelTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore"],(function(e,t,s,l,r,i,a,o){"use strict";class n{constructor(e,t,s){this._geometryType=e,this._idField=t,this._templateStore=s}update(e,t){null!=e.mesh.labels&&(this._labelTemplates=this._createLabelTemplates(e.mesh.labels,t)),this._schema=e}_createLabelTemplates(e,t){const s=new Map;if("simple"===e.type){for(const l of e.classes){const e=i.fromLabelClass(l,t);s.set(l.index,e)}return s}for(const l in e.classes){const r=e.classes[l];for(const e of r){const l=i.fromLabelClass(e,t);s.set(e.index,l)}}return s}get templates(){return this._templateStore}async analyze(e,t,i,a,n,u,p){if(s.isAborted(p))return;let c;"dictionary"===i?.type&&(c=await i.analyze(this._idField,e.copy(),t,n,u,p));let d=0;for(;e.next();){let t=null;if(t=c?c[d++]:null!=a&&r.isAggregateId(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?a.match(this._idField,e,this._geometryType,n,u):i.match(this._idField,e,this._geometryType,n,u),e.setGroupId(t),o.isDynamicId(t)){const s=this._templateStore.getDynamicTemplateGroup(t).templates;for(const t of s)t&&t.analyze&&t.analyze(this._templateStore,e,n,u)}}return await l.loadLibtess(),this._templateStore.finalize(p)}async analyzeGraphics(e,t,r,i,a,n){if(s.isAborted(n))return;const u=e.getCursor();for(r&&await r.analyze(this._idField,u.copy(),t,i,a,n);u.next();){let e=u.getGroupId();if(null!=e&&-1!==e||(e=r?.match(this._idField,u,u.geometryType,i,a),u.setGroupId(e)),o.isDynamicId(e)){const t=this._templateStore.getDynamicTemplateGroup(e).templates;for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,u,i,a)}u.setGroupId(e)}return await l.loadLibtess(),this._templateStore.finalize(n)}writeGraphic(e,t,s,l){const r=t.getGroupId(),i=t.getDisplayId(),a=this._templateStore.getTemplateGroup(r);if(e.featureStart(t.insertAfter,0),null!=i){if(o.isDynamicId(r))for(const e of a.templates)e&&e.bindFeature(t,null,null);if(a){for(const r of a.templates)r&&r.write(e,t,s,l);e.featureEnd()}}}writeCursor(e,t,s,l,r,i,a){const n=t.getGroupId(),u=t.getDisplayId(),p=this._templateStore.getTemplateGroup(n),c=p.templates,d=this._getSortKeyValue(t,p);if(e.featureStart(0,d),null==u)return;if(!c)return;if(o.isDynamicId(n))for(const o of c)o.bindFeature(t,s,l);for(const o of c)o.write(e,t,r,a);if(!!c.length&&null!=i){const s=i&&this._findLabelRef(c);this._writeLabels(e,t,i,s,r,a)}e.featureEnd()}_getSortKeyValue(e,t){const s=this._schema.mesh.sortKey;if(null==s)return 0;let l=0;return l=!0===s.byRenderer&&null!=t.sortKey?t.sortKey:null!=s.fieldIndex?e.getComputedNumericAtIndex(s.fieldIndex):null!=s.field?e.readAttribute(s.field):e.readAttribute(this._idField),l*="asc"===s.order?1:-1,null==l||isNaN(l)?0:l}_findLabelRef(e){for(const t of e)if(t instanceof a)return t;return null}_writeLabels(e,t,s,l,r,i){for(const a of s)if(null!=a&&a){const{glyphs:s,rtl:o,index:n}=a,u=this._labelTemplates.get(n);if(!u)continue;u.setZoomLevel(r),u.bindReferenceTemplate(l),u.bindTextInfo(s,o),u.write(e,t,null,i)}}}e.WGLMeshFactory=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
