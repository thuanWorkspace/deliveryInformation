/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../../../core/Logger","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/cim/utils","./WGLMeshTemplate"],(function(e,t,a,n){"use strict";const i=e.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class s extends n{constructor(e){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=e}async analyze(e,n,s,r,l){if(l&&0===l.length)return null;const o=l&&l.length>0,c=n.readLegacyFeature(),u=n.getObjectId(),m=this._materialCache,h=this._cimLayer.materialHash;if(!h)return i.error("A Dynamic mesh template must have a material hash value or function!"),null;const g="function"==typeof h?h(c,s,r,u):h,p=m.get(g);if(null!=p)return p;const y=this._ongoingMaterialRequestMap.get(g);if(y)return y;const M=this._cimLayer,d=t.analyzeCIMResource(M.cim,this._cimLayer.materialOverrides);d.mosaicHash=g;const{type:f,url:_}=M,b={cim:d,type:f,mosaicHash:g,url:_,size:null,dashTemplate:null,text:null,fontName:null,objectId:u,animatedSymbolProperties:null};switch(f){case"marker":b.size=a.evaluateValueOrFunction(M.size,c,s,r),b.animatedSymbolProperties=a.evaluateValueOrFunction(M.animatedSymbolProperties,c,s,r);break;case"line":b.dashTemplate=M.dashTemplate;break;case"text":b.text=a.evaluateValueOrFunction(M.text,c,s,r),b.fontName=a.evaluateValueOrFunction(M.fontName,c,s,r)}const L=e.getMosaicItem(b,l).then((e=>(o||(this._ongoingMaterialRequestMap.delete(g),m.set(g,e)),e))).catch((e=>(this._ongoingMaterialRequestMap.delete(g),i.error(".analyze()",e.message),null)));return o||this._ongoingMaterialRequestMap.set(g,L),L}}return s}));
