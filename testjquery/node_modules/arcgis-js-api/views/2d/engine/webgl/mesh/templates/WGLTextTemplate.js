/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../../../core/BidiText","../../../../../../core/screenUtils","../../../../../../symbols/cim/enums","../../alignmentUtils","../../color","../../definitions","../../number","../../materialKey/MaterialKey","./util","./WGLBaseTextTemplate","./WGLMeshTemplate"],(function(e,t,i,o,r,n,l,a,s,h,c){"use strict";const m=5;class d extends(h(c)){constructor(e,r,s,h,c,d,p,u,f,x,A,_,g,b,y,M,z,C,S,B,R,L,G,T){super(),this._xOffset=t.pt2px(g),this._yOffset=t.pt2px(b),this._decoration=x||"none",this._backgroundColor=L,this._borderLineColor=G,this._borderLineSize=T,this._color=c,this._haloColor=d,this._haloSize=Math.min(Math.floor(m*t.pt2px(t.toPt(s))),127),this._size=Math.min(Math.round(t.pt2px(r)),127);const V=Math.min(Math.round(t.pt2px(h||r)),127);this._referenceSize=Math.round(Math.sqrt(256*V)),this._scale=this._size/n.glyphSize,this._angle=_,this._justify=o.getJustification(p||"center"),this._xAlignD=o.getXAnchorDirection(p||"center"),this._yAlignD=o.getYAnchorDirection(u||"baseline"),this._baseline="baseline"===(u||"baseline"),this._bitset=(f===i.Alignment.MAP?1:0)|(A?1:0)<<1;const k=a.MaterialKeyBase.load(e);k.sdf=!0,this._materialKey=k.data,this._lineWidth=t.pt2px(y)||512,this._lineHeight=M||1,this._textPlacement=z,this._effects=C,this._isCIM=S??!1,this._minMaxZoom=l.i1616to32(Math.round(B*n.minMaxZoomPrecisionFactor),Math.round(R*n.minMaxZoomPrecisionFactor))}static fromText(t,o){const n=t.font?.size,l=new d(t.materialKey,n,t.haloSize||0,n,t.color&&r.premultiplyAlphaRGBAArray(t.color)||0,t.haloColor&&r.premultiplyAlphaRGBAArray(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,i.Alignment.SCREEN,t.font?.decoration,!1,t.angle||0,t.xoffset||0,t.yoffset||0,t.lineWidth||0,t.lineHeight||0,null,null,!1,s.defaultMinZoom,s.defaultMaxZoom,t.backgroundColor&&r.premultiplyAlphaRGBAArray(t.backgroundColor),t.borderLineColor&&r.premultiplyAlphaRGBAArray(t.borderLineColor),t.borderLineSize),[,a]=e.bidiText(t.text);return l.bindTextInfo(o??[],a),l._vertexBoundsScale=t.maxVVSize&&n?t.maxVVSize/n:1,l}static fromCIMText(t,i,o){const n=t.scaleFactor||1,l=t.size*t.sizeRatio*n,[a,h]=s.getMinMaxZoom(t.scaleInfo,o),c=new d(t.materialKey,l,t.outlineSize*t.sizeRatio,t.referenceSize,r.premultiplyAlphaRGBA(t.color),r.premultiplyAlphaRGBA(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked??!1,t.angle,t.offsetX*t.sizeRatio*n,t.offsetY*t.sizeRatio*n,t.lineWidth||512,1,t.markerPlacement,t.effects,!0,a,h,t.backgroundColor?r.premultiplyAlphaRGBA(t.backgroundColor):void 0,t.borderLineColor?r.premultiplyAlphaRGBA(t.borderLineColor):void 0,t.borderLineWidth),[,m]=e.bidiText(t.text);return c.bindTextInfo(i,m),c._vertexBoundsScale=t.maxVVSize?t.maxVVSize/l:1,c}}return d}));
