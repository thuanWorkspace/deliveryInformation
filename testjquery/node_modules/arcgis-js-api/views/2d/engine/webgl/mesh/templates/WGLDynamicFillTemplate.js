/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../../../core/screenUtils","../../../../../../symbols/cim/utils","../../color","../../definitions","../../GeometryUtils","../../number","../../materialKey/MaterialKey","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,s,o,a,r,l,n,c,h){"use strict";class p extends(n(c)){constructor(r,l,n){if(super(r),this._minMaxZoom=a.i1616to32(Math.round(l*s.minMaxZoomPrecisionFactor),Math.round(n*s.minMaxZoomPrecisionFactor)),e.isFeatureValueFn(r.color)){const t=(t,e,s)=>{const o=r.color(t,e,s);return o&&i.premultiplyAlphaRGBA(o)||0};this._dynamicPropertyMap.set("fillColor",t)}else{const t=r.color;this.fillColor=t&&i.premultiplyAlphaRGBA(t)||0}const c="CIMMarkerPlacementInsidePolygon"===r.cim.placement?.type&&r.cim.placement.shiftOddRows?2:1,h=r.height;if(e.isFeatureValueFn(h)){const t=(t,e,i)=>h(t,e,i)*c;this._dynamicPropertyMap.set("_height",t)}else this._height=(h||0)*c;const p=r.offsetX;if(e.isFeatureValueFn(p)){const e=(e,i,s)=>t.pt2px(p(e,i,s));this._dynamicPropertyMap.set("_offsetX",e)}else this._offsetX=t.pt2px(p||0);const m=r.offsetY;if(e.isFeatureValueFn(m)){const e=(e,i,s)=>t.pt2px(-m(e,i,s));this._dynamicPropertyMap.set("_offsetY",e)}else this._offsetY=t.pt2px(-m||0);const f=r.scaleX;e.isFeatureValueFn(f)?this._dynamicPropertyMap.set("_scaleX",f):this._scaleX=f||1;const u=r.angle;if(e.isFeatureValueFn(u)){const t=(t,e,i)=>o.degToByte(u(t,e,i));this._dynamicPropertyMap.set("_angle",t)}else this._angle=o.degToByte(u)||0;if(null!=r.effects){const t=r.effects;e.isFeatureValueFn(t)?this._dynamicPropertyMap.set("_effects",t):this._effects=t}this._cimFillLayer=r,this._bitset=(r.colorLocked?s.bitsetGenericLockColor:0)|(r.applyRandomOffset?s.bitsetFillRandomPatternOffset:0)|(r.sampleAlphaOnly?s.bitsetGenericConsiderAlphaOnly:0)|(r.hasUnresolvedReplacementColor?s.bitsetFillHasUnresolvedReplacementColor:0),this._fillMaterialKey=r.materialKey}static fromCIMFill(t,e){const[i,s]=l.getMinMaxZoom(t.scaleInfo,e);return new p(t,i,s)}bindFeature(e,i,o){const l=e.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(l,i,o)}));const n=r.FillMaterialKey.load(this._fillMaterialKey),c=this._materialCache,p=(0,this._cimFillLayer.materialHash)(l,i,o),m=c.get(p);let f=null;if(m&&h.ok(m.spriteMosaicItem)&&(f=m.spriteMosaicItem),f){const{rect:e,width:i,height:o}=f,r=e.x+s.spritePadding,l=e.y+s.spritePadding,c=r+i,h=l+o;let p=t.pt2px(this._height);p<=0&&(p=h-l),p<s.maxSizeForU16Compression&&(p*=s.compressionFactorForU16,this._bitset|=s.bitsetFillHasPatternHeightPrecisionFactor),p=Math.round(p);let m=t.pt2px(this._height/o*i);m<=0&&(m=c-r),m<s.maxSizeForU16Compression&&(m*=s.compressionFactorForU16,this._bitset|=s.bitsetFillHasPatternWidthPrecisionFactor),m=Math.round(m);const u=this._scaleX,d=1;this.tl=a.i1616to32(r,l),this.br=a.i1616to32(c,h),this.aux21=a.i1616to32(m,p),this.aux22=a.i1616to32(this._offsetX,this._offsetY),this.aux3=a.i8888to32(u*s.compressionFactorForU16,d*s.compressionFactorForU16,this._angle,0),n.sdf=f.sdf,n.pattern=!0,n.textureBinding=f.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}return p}));
