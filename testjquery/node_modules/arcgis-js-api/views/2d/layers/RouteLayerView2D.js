/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/Collection","../../../core/CollectionFlattener","../../../core/handleUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../rest/support/DirectionLine","../../../rest/support/DirectionPoint","../../../rest/support/PointBarrier","../../../rest/support/PolygonBarrier","../../../rest/support/PolylineBarrier","../../../rest/support/RouteInfo","../../../rest/support/Stop","./LayerView2D","./graphics/GraphicContainer","./graphics/GraphicsView2D","../../layers/LayerView"],(function(e,t,r,i,s,a,h,o,n,p,c,l,d,u,g,_,w,y,f,m,k){"use strict";const M=["route-info","direction-line","direction-point","polygon-barrier","polyline-barrier","point-barrier","stop"],V={graphic:null,property:null,oldValue:null,newValue:null};function v(e){return e instanceof c||e instanceof l||e instanceof d||e instanceof u||e instanceof g||e instanceof _||e instanceof w}function G(e){return r.isCollection(e)&&e.length&&v(e.at(0))}function I(e){return Array.isArray(e)&&e.length>0&&v(e[0])}let F=class extends(y.LayerView2DMixin(k)){constructor(){super(...arguments),this._graphics=new r,this._highlightIds=new Map,this._networkFeatureMap=new Map,this._networkGraphicMap=new Map}get _routeItems(){return new i({getCollections:()=>null==this.layer||this.destroyed?[]:[null!=this.layer.routeInfo?new r([this.layer.routeInfo]):null,this.layer.directionLines,this.layer.directionPoints,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.pointBarriers,this.layer.stops]})}initialize(){this._updatingHandles.addOnCollectionChange((()=>this._routeItems),(e=>this._routeItemsChanged(e)),a.initial)}destroy(){this._networkFeatureMap.clear(),this._networkGraphicMap.clear(),this._graphics.removeAll(),this._get("_routeItems")?.destroy()}attach(){this._createGraphicsView()}detach(){this._destroyGraphicsView()}async fetchPopupFeatures(e){return this._graphicsView.hitTest(e).filter((e=>!!e.popupTemplate))}highlight(e){let r;r=v(e)?[this._getNetworkFeatureUid(e)]:I(e)?e.map((e=>this._getNetworkFeatureUid(e))):G(e)?e.map((e=>this._getNetworkFeatureUid(e))).toArray():[e.uid];const i=r.filter(t.isSome);return i.length?(this._addHighlight(i),s.makeHandle((()=>this._removeHighlight(i)))):s.makeHandle()}async hitTest(e,r){if(this.suspended)return null;const i=this._graphicsView.hitTest(e).filter(t.isSome).map((e=>this._networkGraphicMap.get(e)));if(!i.length)return null;const{layer:s}=this;return i.reverse().map((t=>({type:"route",layer:s,mapPoint:e,networkFeature:t})))}isUpdating(){return this._graphicsView.updating}moveStart(){}moveEnd(){}update(e){this._graphicsView.processUpdate(e)}viewChange(){this._graphicsView.viewChange()}_addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t);this._highlightIds.set(t,e+1)}else this._highlightIds.set(t,1);this._updateHighlight()}_createGraphic(e){const t=e.toGraphic();return t.layer=this.layer,t.sourceLayer=this.layer,t}_createGraphicsView(){const e=this.view,t=()=>this.requestUpdate(),r=new f(e.featuresTilingScheme);this._graphicsView=new m({container:r,graphics:this._graphics,requestUpdateCallback:t,view:e}),this.container.addChild(r),this._updateHighlight()}_destroyGraphicsView(){this.container.removeChild(this._graphicsView.container),this._graphicsView.destroy()}_getDrawOrder(e){const t=this._networkGraphicMap.get(e);return M.indexOf(t.type)}_getNetworkFeatureUid(e){return this._networkFeatureMap.has(e)?this._networkFeatureMap.get(e).uid:null}_removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t)-1;0===e?this._highlightIds.delete(t):this._highlightIds.set(t,e)}this._updateHighlight()}_routeItemsChanged(e){if(e.removed.length){this._graphics.removeMany(e.removed.map((e=>{const t=this._networkFeatureMap.get(e);return this._networkFeatureMap.delete(e),this._networkGraphicMap.delete(t),t})));for(const t of e.removed)this.removeHandles(t)}if(e.added.length){this._graphics.addMany(e.added.map((e=>{const t=this._createGraphic(e);return null==t.symbol?null:(this._networkFeatureMap.set(e,t),this._networkGraphicMap.set(t,e),t)})).filter(t.isSome));for(const t of e.added)this.addHandles([a.watch((()=>t.geometry),((e,r)=>{this._updateGraphic(t,"geometry",e,r)})),a.watch((()=>t.symbol),((e,r)=>{this._updateGraphic(t,"symbol",e,r)}))],t);this._graphics.sort(((e,t)=>this._getDrawOrder(e)-this._getDrawOrder(t)))}}_updateGraphic(e,t,r,i){if(!this._networkFeatureMap.has(e)){const t=this._createGraphic(e);return this._networkFeatureMap.set(e,t),this._networkGraphicMap.set(t,e),void this._graphics.add(t)}const s=this._networkFeatureMap.get(e);s[t]=r,V.graphic=s,V.property=t,V.oldValue=i,V.newValue=r,this._graphicsView.graphicUpdateHandler(V)}_updateHighlight(){const e=Array.from(this._highlightIds.keys());this._graphicsView.setHighlight(e)}};e.__decorate([h.property()],F.prototype,"_graphics",void 0),e.__decorate([h.property()],F.prototype,"_routeItems",null),F=e.__decorate([p.subclass("esri.views.2d.layers.RouteLayerView2D")],F);return F}));
