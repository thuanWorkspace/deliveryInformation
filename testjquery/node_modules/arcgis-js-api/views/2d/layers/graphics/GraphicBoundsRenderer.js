/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f32","../../../../chunks/vec2f32","../../../../chunks/vec3f32","../../../../geometry/support/normalizeUtils","../../engine/DisplayObject","../../engine/webgl/Utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject"],(function(e,t,r,i,s,a,n,o,l,u,c){"use strict";const f=Math.PI/180,_=4;class h extends n.DisplayObject{constructor(e){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=r.create(),this._localOrigin={x:0,y:0},this._getBounds=e}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=e.disposeMaybe(this._program)}doRender(e){const{context:t}=e,r=this._getBounds();if(r.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(e),this._updateBufferData(t,r),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(u.BlendFactor.ONE,u.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0);const i=this._program;t.bindVAO(this._vao),t.useProgram(i),i.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(u.PrimitiveType.LINES,8*r.length,u.DataType.UNSIGNED_INT,0),t.bindVAO()}_createTransforms(){return{dvs:r.create()}}_createShaderProgram(e){if(this._program)return;const t="precision highp float;\n        uniform mat3 u_dvsMat3;\n\n        attribute vec2 a_position;\n\n        void main() {\n          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);\n          gl_Position = vec4(pos.xy, 0.0, 1.0);\n        }",r="precision mediump float;\n      void main() {\n        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);\n      }";this._program=e.programCache.acquire(t,r,d().attributes)}_updateMatricesAndLocalOrigin(e){const{state:r}=e,{displayMat3:n,size:o,resolution:l,pixelRatio:u,rotation:c,viewpoint:_}=r,h=f*c,{x:d,y:g}=_.targetGeometry,p=a.normalizeMapX(d,r.spatialReference);this._localOrigin.x=p,this._localOrigin.y=g;const m=u*o[0],v=u*o[1],y=l*m,b=l*v,x=t.identity(this._dvsMat3);t.multiply(x,x,n),t.translate(x,x,i.fromValues(m/2,v/2)),t.scale(x,x,s.fromValues(o[0]/y,-v/b,1)),t.rotate(x,x,-h)}_updateBufferData(e,t){const{x:r,y:i}=this._localOrigin,s=2*_*t.length,a=new Float32Array(s),n=new Uint32Array(8*t.length);let o=0,f=0;for(const l of t)l&&(a[2*o]=l[0]-r,a[2*o+1]=l[1]-i,a[2*o+2]=l[0]-r,a[2*o+3]=l[3]-i,a[2*o+4]=l[2]-r,a[2*o+5]=l[3]-i,a[2*o+6]=l[2]-r,a[2*o+7]=l[1]-i,n[f]=o+0,n[f+1]=o+3,n[f+2]=o+3,n[f+3]=o+2,n[f+4]=o+2,n[f+5]=o+1,n[f+6]=o+1,n[f+7]=o+0,o+=4,f+=8);if(this._vertexBuffer?this._vertexBuffer.setData(a.buffer):this._vertexBuffer=l.BufferObject.createVertex(e,u.Usage.DYNAMIC_DRAW,a.buffer),this._indexBuffer?this._indexBuffer.setData(n):this._indexBuffer=l.BufferObject.createIndex(e,u.Usage.DYNAMIC_DRAW,n),!this._vao){const t=d();this._vao=new c.VertexArrayObject(e,t.attributes,t.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const d=()=>o.createProgramDescriptor("bounds",{geometry:[{location:0,name:"a_position",count:2,type:u.DataType.FLOAT}]});return h}));
