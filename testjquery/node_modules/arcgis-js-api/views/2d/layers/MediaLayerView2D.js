/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../renderers/ClassBreaksRenderer","../../../renderers/DictionaryRenderer","../../../renderers/DotDensityRenderer","../../../renderers/HeatmapRenderer","../../../renderers/PieChartRenderer","../../../renderers/Renderer","../../../renderers/SimpleRenderer","../../../renderers/UniqueValueRenderer","../../../renderers/support/jsonUtils","../../../core/Logger","../../../symbols","../../../core/Collection","../../../core/has","../../../core/MapUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/aaBoundingRect","../../../geometry/support/contains","../../../geometry/support/intersectsBase","../../../layers/support/MediaElementView","../../../core/Error","../../../core/scheduling","../../../core/accessorSupport/tracking/Flags","../../../config","../../../request","../../../core/urlUtils","../../../layers/effects/EffectView","../engine/DisplayObject","../engine/webgl/effects/highlight/HighlightGradient","../../../core/Evented","../../../core/mathUtils","../../webgl/contextUtils","../engine/webgl/BufferPool","../engine/webgl/enums","../engine/webgl/brushes/BrushBitmap","../../../chunks/vec4f32","../engine/webgl/Utils","../engine/webgl/shaders/BackgroundPrograms","../../webgl/enums","../../webgl/checkWebGLError","../../../chunks/builtins","../engine/webgl/definitions","../../../core/RandomLCG","../engine/webgl/materialKey/MaterialKey","../engine/webgl/techniques/Technique","../engine/webgl/techniques/dotDensity/TechniqueDotDensity","../engine/webgl/techniques/heatmap/TechniqueHeatmap","../engine/webgl/techniques/pieChart/TechniquePieChart","../../webgl/BufferObject","../../webgl/FramebufferObject","../../webgl/GLObjectType","../../webgl/Texture","../../webgl/VertexArrayObject","../engine/webgl/brushes/WGLBrushHeatmap","../engine/webgl/DefaultVertexAttributeLayouts","../engine/webgl/shaders/TileInfoPrograms","../engine/webgl/brushes/WGLGeometryBrushMarker","../engine/webgl/number","../engine/vectorTiles/style/StyleDefinition","../../../chunks/vec2f32","../engine/vectorTiles/enums","../engine/vectorTiles/shaders/sources/resolver","../engine/webgl/shaders/BitBlitPrograms","../engine/webgl/shaders/sources/resolver","../engine/webgl/TextureManager","../engine/webgl/shaders/StencilPrograms","../engine/webgl/effects/BlendEffect","../engine/webgl/shaders/HighlightPrograms","../engine/webgl/Profiler","../../webgl/renderState","../../3d/webgl-engine/core/shaderModules/interfaces","../../../core/floatRGBA","../../3d/webgl-engine/lib/OrderIndependentTransparency","../../webgl/testSVGPremultipliedAlpha","../LabelManager","./graphics/GraphicsView2D","../engine/webgl/AttributeStoreView","../../../chunks/earcut","../../../layers/graphics/featureConversionUtils","../../../core/unitUtils","../../../renderers/support/lengthUtils","../../../chunks/vec3f32","../../../geometry/support/normalizeUtils","../navigation/MapViewNavigation","../../../core/asyncUtils","../engine/webgl/shaders/MagnifierPrograms","../tiling/TileInfoView","../tiling/TileKey","../tiling/TileQueue","../tiling/TileStrategy","../engine/webgl/Overlay","../engine/webgl/OverlayContainer","./LayerView2D","../../layers/LayerView","../../../geometry/Extent"],(function(e,t,r,i,s,n,l,a,o,c,h,u,d,g,m,p,y,f,w,b,_,v,T,E,R,S,C,U,V,q,G,x,B,P,k,M,D,L,j,A,H,O,z,Q,I,K,W,F,N,J,X,Y,Z,$,ee,te,re,ie,se,ne,le,ae,oe,ce,he,ue,de,ge,me,pe,ye,fe,we,be,_e,ve,Te,Ee,Re,Se,Ce,Ue,Ve,qe,Ge,xe,Be,Pe,ke,Me,De,Le,je,Ae,He,Oe,ze,Qe,Ie,Ke,We,Fe){"use strict";let Ne=class extends(Ke.LayerView2DMixin(We)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new m}attach(){this.addAttachHandles([w.on((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((e=>this._updateTile(e))),this.requestUpdate()})),w.on((()=>this.layer.effectiveSource),"change",(({element:e})=>this._elementUpdateHandler(e)))]),this._overlayContainer=new Ie,this.container.addChild(this._overlayContainer),this._fetchQueue=new Oe({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new ze({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){const r=[],i=e.normalize(),s=[i.x,i.y];for(const{projectedElement:{normalizedCoords:n,element:l}}of this._elementReferences.values())null!=n&&R.ringsContainsCoords(n.rings,s)&&r.push({type:"media",element:l,layer:this.layer,mapPoint:e,sourcePoint:l.toSource(e)});return r.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((e=>this._updateTile(e)))}_acquireTile(e){const t=new Ze(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[r,i]=e.setElements(t);this._referenceElements(e,r),this._dereferenceElements(e,i),this.requestUpdate()}),(e=>{f.isAbortError(e)||d.getLogger(this).error(e)})))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){const r=this.layer.effectiveSource;if(null==r)return[];this.view.featuresTilingScheme.getTileBounds(Je,e,!0);const i=new Fe({xmin:Je[0],ymin:Je[1],xmax:Je[2],ymax:Je[3],spatialReference:this.view.spatialReference});return r.queryElements(i,t)}_referenceElements(e,t){if(null!=this.layer.source)for(const r of t)this._referenceElement(e,r)}_referenceElement(e,t){y.getOrCreateMapValue(this._elementReferences,t.uid,(()=>{const e=new C.MediaElementView({element:t,spatialReference:this.view.spatialReference}),r=new Qe(e);this._overlayContainer.addChild(r),this.elements.add(t);let i=null;return{tiles:new Set,projectedElement:e,overlay:r,debugGraphic:i}})).tiles.add(e)}_dereferenceElements(e,t){for(const r of t)this._dereferenceElement(e,r)}_dereferenceElement(e,t){const r=this._elementReferences.get(t.uid);r.tiles.delete(e),r.tiles.size||(this._overlayContainer.removeChild(r.overlay),r.overlay.destroy(),r.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(r.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){const r=t.projectedElement.normalizedCoords;if(null==r)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const i=[],s=[];for(const e of this._tileStrategy.tiles){const n=Ye(this.view.featuresTilingScheme,e,r);t.tiles.has(e)?n||s.push(e):n&&i.push(e)}for(const t of i)this._referenceElement(t,e);for(const t of s)this._dereferenceElement(t,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const r=new C.MediaElementView({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=r)for(const i of this._tileStrategy.tiles){Ye(this.view.featuresTilingScheme,i,r)&&this._referenceElement(i,e)}}};e.__decorate([b.property()],Ne.prototype,"layer",void 0),e.__decorate([b.property({readOnly:!0})],Ne.prototype,"elements",void 0),Ne=e.__decorate([T.subclass("esri.views.2d.layers.MediaLayerView2D")],Ne);const Je=E.create(),Xe={xmin:0,ymin:0,xmax:0,ymax:0};function Ye(e,t,r){return e.getTileBounds(Je,t.key,!0),Xe.xmin=Je[0],Xe.ymin=Je[1],Xe.xmax=Je[2],Xe.ymax=Je[3],S.extentIntersectsPolygon(Xe,r)}class Ze{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const t=[],r=new Set(this.elements);this.elements=e;for(const i of e)r.has(i)?r.delete(i):t.push(i);return this.isReady=!0,[t,Array.from(r)]}destroy(){}}return Ne}));
