/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/Collection","../../../core/handleUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../support/GraphicsCollection","../engine/flow/FlowView2D","./LayerView2D","./graphics/GraphicsView2D","./graphics/HighlightGraphicContainer","./imagery/ImageryView2D","./imagery/VectorFieldView2D","../../layers/ImageryLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,i,r,s,a,h,n,c,l,o,w,u,d,y,p,g,v,b,m){"use strict";let _=class extends(v(m(u.LayerView2DMixin(b)))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new o.GraphicsCollection,this._highlightView=void 0,this.layer=null,this.subview=null}get pixelData(){const{subview:e}=this;return this.updating||!e?null:"getPixelData"in e?e.getPixelData():null}async hitTest(e,t){return this.subview?[{type:"graphic",graphic:this.subview.hitTest(e),layer:this.layer,mapPoint:e}]:null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new d({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new y(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([s.watch((()=>this.layer.exportImageServiceParameters.version),(e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())}),s.sync),s.watch((()=>this.timeExtent),(e=>{const{subview:t}=this;t&&(t.timeExtent=e,"redraw"in t?this.requestUpdate():t.redrawOrRefetch())}),s.sync),this.layer.on("redraw",(()=>{const{subview:e}=this;e&&("redraw"in e?e.redraw():e.redrawOrRefetch())})),s.watch((()=>this.layer.renderer),(()=>this._setSubView()))])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,s){if(!((Array.isArray(e)?e[0]:i.isCollection(e)?e.at(0):e)instanceof t))return r.makeHandle();let a=[];return Array.isArray(e)||i.isCollection(e)?a=e.map((e=>e.clone())):e instanceof t&&(a=[e.clone()]),this._highlightGraphics.addMany(a),r.makeHandle((()=>this._highlightGraphics.removeMany(a)))}async doRefresh(){this.requestUpdate()}isUpdating(){return!this.subview||this.subview.updating}_setSubView(){if(!this.view)return;const e=this.layer.renderer?.type;let t="imagery";if("vector-field"===e?t="imageryVF":"flow"===e&&(t="flow"),this.subview){const{type:e}=this.subview;if(e===t)return this._attachSubview(this.subview),void("flow"===e?this.subview.redrawOrRefetch():"imagery"===e&&"lerc"===this.layer.format?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}this.subview="imagery"===t?new p({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):"imageryVF"===t?new g({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new w({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}};e.__decorate([a.property()],_.prototype,"pixelData",null),e.__decorate([a.property()],_.prototype,"subview",void 0),_=e.__decorate([l.subclass("esri.views.2d.layers.ImageryLayerView2D")],_);return _}));
