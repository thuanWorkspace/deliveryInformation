/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../support/QueueProcessor"],(function(e,t,s,r,o,n,d,i){"use strict";function a(e){return e.some((e=>e.globalId))}function c(e){return e.filter((e=>!e.error)).map((e=>e.objectId??e.globalId)).filter((e=>null!=e))}function u(e,t){const s=new Set(e);for(const r of t.values())s.add(r);return s}function p(e,t){const s=new Set(e);for(const r of t.values())s.delete(r);return s}let l=class extends t{constructor(e){super(e),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(e){return this._queueProcessor=new i.QueueProcessor({concurrency:1,process:e.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(e){const t=this._queueProcessor,s=t.last();switch(e.type){case"update":case"refresh":if(s?.type===e.type)return;t.push(e).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const r="processed-edit"===s?.type?s:null;r&&t.popLast();const o=this._mergeEdits(r,e);for(const e of o)e&&t.push(e).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(e,t){const{addedFeatures:s,deletedFeatures:r,updatedFeatures:o}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||a(s)||a(o)||a(r),this._hasGlobalIds){return[e,{type:"processed-edit",edits:{addOrModified:[...s,...o],removed:r}}]}const n=new Set(c(e?.edits.addOrModified??[])),d=new Set(c(e?.edits.removed??[])),i=new Set([...c(s),...c(o)]),l=new Set(c(r));return[{type:"processed-edit",edits:{addOrModified:Array.from(u(p(n,l),i)).map((e=>({objectId:e}))),removed:Array.from(u(p(d,i),l)).map((e=>({objectId:e})))}}]}};e.__decorate([s.property({readOnly:!0})],l.prototype,"updating",null),e.__decorate([s.property()],l.prototype,"process",void 0),l=e.__decorate([d.subclass("esri.views.2d.layers.support.FeatureCommandQueue")],l);return l}));
