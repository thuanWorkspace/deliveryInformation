/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/has","../../../../../../core/workers/Connection","../../../../../../geometry/support/quantizationUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../layers/support/FieldsIndex","../../../../../../rest/query/operations/query","../../support/FeatureSetReaderJSON","../../support/FeatureSetReaderPBF"],(function(e,t,r,a,i,s,n,u,o,c){"use strict";class y{constructor(e){this.service=e,this._arcadeLayerSchema={...e,fieldsIndex:n.fromJSON(e.fieldsIndex)}}destroy(){}}function d(e){return Array.isArray(e.source)}function l(e){return"ogc-source"===e?.type}function p(e){const{capabilities:r}=e;return l(e.source)?new F(e):d(e)?new S(e):r.query.supportsFormatPBF&&t("featurelayer-pbf")?new f(e):new h(e)}async function m(e){const t=new r;return await t.open(e,{}),t}class S extends y{constructor(e){super(e),this._portsOpen=m(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return o.FeatureSetReaderJSON.fromFeatureSet(r,this._arcadeLayerSchema)}}class f extends y{async executeQuery(e,t){const{data:r}=await u.executeQueryPBFBuffer(this.service.source,e,t),a=!e.quantizationParameters;return c.FeatureSetReaderPBF.fromBuffer(r,this._arcadeLayerSchema,a)}}class h extends y{async executeQuery(e,t){const{source:r,capabilities:s,spatialReference:n,objectIdField:c,geometryType:y}=this.service;if(null!=e.quantizationParameters&&!s.query.supportsQuantization){const s=e.clone(),y=a.toQuantizationTransform(s.quantizationParameters);s.quantizationParameters=null;const{data:d}=await u.executeQuery(r,s,n,t),l=i.convertFromFeatureSet(d,c);return i.quantizeOptimizedFeatureSet(y,l),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(l,this._arcadeLayerSchema)}const{data:d}=await u.executeQuery(r,e,this.service.spatialReference,t);return"esriGeometryPoint"===y&&(d.features=d.features?.filter((e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),o.FeatureSetReaderJSON.fromFeatureSet(d,this._arcadeLayerSchema)}}class F extends y{async executeQuery(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){const r=e.clone(),n=a.toQuantizationTransform(r.quantizationParameters);r.quantizationParameters=null;const u=await s.queryOptimizedFeatureSet(this.service.source,e,t);return i.quantizeOptimizedFeatureSet(n,u),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(u,this._arcadeLayerSchema)}const n=await s.queryOptimizedFeatureSet(this.service.source,e,t);return o.FeatureSetReaderJSON.fromOptimizedFeatureSet(n,this._arcadeLayerSchema)}}e.SourceAdapter=y,e.createSourceAdapter=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
