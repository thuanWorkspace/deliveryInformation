/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,s,o,i,n,u,a){"use strict";e.EditsQueue=class extends r{constructor(e){super(e),this._queue=[],this._onGoingRequest=null,this._abortController=new AbortController}destroy(){this.clear()}get updating(){return!this.destroyed&&(this._queue.length>0||null!=this._onGoingRequest)}clear(){if(this.destroyed)throw new Error("instance is already destroyed");let e=this._queue.pop();for(;e;)e.resolver.reject(s.createAbortError()),e=this._queue.pop();this._queue.length=0,this._abortController.abort(),this._abortController=new AbortController}async push(e){if(this.destroyed)throw new Error("instance is already destroyed");const t=s.createResolver();return this._queue.push({event:e,resolver:t}),this.notifyChange("updating"),Promise.resolve().then((()=>{this._processNext()})),t.promise}async _processNext(){if(this._onGoingRequest)return;const e=[],t=new Set,r=new Set,s=new Set;let o=this._queue.shift();for(;o;){const{event:{addedFeatures:i,deletedFeatures:n,updatedFeatures:u},resolver:a}=o;e.push(a);for(const{objectId:e,error:o}of i)o||null==e||(t.add(e),r.add(e),s.delete(e));for(const{objectId:e,error:t}of u)t||null==e||(r.add(e),s.delete(e));for(const{objectId:e,error:o}of n)o||null==e||(t.has(e)?t.delete(e):s.add(e),r.delete(e));o=this._queue.shift()}if(!r.size&&!s.size)return this.notifyChange("updating"),void e.forEach((e=>e()));const i=[],n=[];r.size&&r.forEach((e=>{i.push(e)})),s.size&&s.forEach((e=>{n.push(e)})),this._onGoingRequest=Promise.resolve().then((()=>this.processEdits(i,n,{signal:this._abortController.signal}))).catch((()=>{})),this.notifyChange("updating"),await this._onGoingRequest,this._onGoingRequest=null,this.notifyChange("updating"),e.forEach((e=>e())),this._queue.length>0&&this._processNext()}},t.__decorate([o.property({constructOnly:!0})],e.EditsQueue.prototype,"processEdits",void 0),t.__decorate([o.property({readOnly:!0})],e.EditsQueue.prototype,"updating",null),e.EditsQueue=t.__decorate([a.subclass("esri.views.2d.layers.features.controllers.EditsQueue")],e.EditsQueue),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
