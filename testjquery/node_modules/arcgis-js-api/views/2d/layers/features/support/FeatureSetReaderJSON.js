/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/support/FieldsIndex","./FeatureSetReader"],(function(e,t,r,s,n){"use strict";function i({coords:e,lengths:t}){let r=0;for(const s of t){for(let t=1;t<s;t++)e[2*(r+t)]+=e[2*(r+t)-2],e[2*(r+t)+1]+=e[2*(r+t)-1];r+=s}}class o extends n.FeatureSetReader{static fromFeatures(e,r){const{objectIdField:s,geometryType:n}=r,i=t.convertFromFeatures([],e,n,!1,!1,s);for(let t=0;t<i.length;t++)i[t].displayId=e[t].displayId;return o.fromOptimizedFeatures(i,r)}static fromFeatureSet(e,r){const s=t.convertFromFeatureSet(e,r.objectIdField);return o.fromOptimizedFeatureSet(s,r)}static fromOptimizedFeatureSet(e,t){const{features:r}=e,n=o.fromOptimizedFeatures(r,t);return n._exceededTransferLimit=e.exceededTransferLimit,n._transform=e.transform,n._fieldsIndex=new s(t.fields),n}static fromOptimizedFeatures(e,t,r){const i=n.FeatureSetReader.createInstance(),u=new o(i,e,t);return u._fieldsIndex=new s(t.fields),u._transform=r,u}constructor(e,t,r){super(e,r),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=r?.geometryType,this._features=t}get fields(){return this._fieldsIndex}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(e){const t=new Set(e);this._features=this._features.filter((e=>!(null!=e.objectId&&t.has(e.objectId))))}append(e){for(const t of e)this._features.push(t)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}getGroupId(){return this._current.groupId}setGroupId(e){this._current.groupId=e}copy(){const e=new o(this.instance,this._features,this.fullSchema());return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return t.convertToFeature(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const e=this.readUnquantizedGeometry();return t.convertToGeometry(e,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const e=this.readCentroid();return null==e?null:{x:e.coords[0]*this._sx+this._tx,y:e.coords[1]*this._sy+this._ty}}readGeometryArea(){return r.hasGeometry(this._current)?t.getQuantizedArea(this._current.geometry,2):0}readUnquantizedGeometry(){const e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;const t=e.clone();return i(t),t}readHydratedGeometry(){const e=this._current.geometry;if(null==e)return null;const r=e.clone();return null!=this._transform&&t.unquantizeOptimizedGeometry(r,r,this.hasZ,this.hasM,this._transform),r}getXHydrated(){if(!r.hasGeometry(this._current))return 0;const e=this._current.geometry.coords[0],t=this.getQuantizationTransform();return null==t?e:e*t.scale[0]+t.translate[0]}getYHydrated(){if(!r.hasGeometry(this._current))return 0;const e=this._current.geometry.coords[1],t=this.getQuantizationTransform();return null==t?e:t.translate[1]-e*t.scale[1]}getX(){return r.hasGeometry(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return r.hasGeometry(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!r.hasGeometry(this._current)){if(null!=this._current.centroid){const[e,t]=this._current.centroid.coords;return this.createQuantizedExtrudedGeometry(e,t)}return null}const e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sy+this._ty,e;let t=0;for(const r of e.lengths)e.coords[2*t]=e.coords[2*t]*this._sx+this._tx,e.coords[2*t+1]=e.coords[2*t+1]*this._sy+this._ty,t+=r;return e}readCentroid(){return r.hasGeometry(this._current)?this._computeCentroid():this._current.centroid}_readAttribute(e,t){const r=this._fieldsIndex.get(e);if(!r)return;let s=this._current.attributes[r.name];return null==s?s:("esriFieldTypeTimestampOffset"===this.fields.get(e)?.type&&(s=this.parseTimestampOffset(s)),t&&this.fields.isDateField(e)?new Date(s):s)}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}_readAttributes(){return this._current.attributes}}e.FeatureSetReaderJSON=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
