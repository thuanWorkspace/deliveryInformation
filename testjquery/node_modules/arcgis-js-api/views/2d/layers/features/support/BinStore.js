/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../geometry","../../../../../core/Evented","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/diffUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/Ellipsoid","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/projectionSupport","../../../../../layers/support/FieldsIndex","../../../engine/webgl/DisplayId","../FeatureStore2D","../Store2D","./FeatureSetReaderJSON","../../../../../geometry/SpatialReference","../../../../../geometry/Polygon","../../../../../geometry/Extent"],(function(e,t,s,r,i,a,o,h,n,d,l,u,g,c,p,f,_,y,m,I,b,S,x){"use strict";const B=i.getLogger("esri.view.2d.layers.features.support.BinStore"),v=12,F=64,G=n.create(),R=5;function O(e){return 57.29577951308232*e}class T extends m.Store2D{constructor(e,t,r,i){super(e,r),this.type="bin",this.events=new s,this.objectIdField="aggregateId",this.featureAdapter=y.featureAdapter,this._geohashLevel=R,this._geohashBuf=[],this._serviceInfo=i,this.geometryInfo=e.geometryInfo,this._spatialReference=t,this._projectionSupportCheck=p.checkProjectionSupport(t,b.WGS84),this._bitsets.geohash=r.getBitset(r.createBitset()),this._bitsets.inserted=r.getBitset(r.createBitset())}destroy(){this._tree&&this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}async updateSchema(e,t){const s=this._schema;try{await super.updateSchema(e,t),await this._projectionSupportCheck}catch(h){}this._fields=this._schema.params.fields,this._fieldsIndex=new f(this._fields);const i=a.diff(s,t);t&&(null!=i||e.source||e.storage.filters)?((a.hasDiff(i,"params.fields")||a.hasDiff(i,"params")||!this._tree||e.source)&&(this._tree&&this._tree.destroy(),this._tree=new o.GeohashTree(this._statisticFields,this._serviceInfo),this._tree.onRelease=e=>e.displayId&&this._storage.releaseDisplayId(e.displayId),this._geohashLevel=this._schema.params.fixedBinLevel,this._rebuildTree(),r("esri-2d-update-debug")&&B.info("Aggregate mesh needs update due to tree changing")),r("esri-2d-update-debug")&&B.info("Aggregate mesh needs update due to tree changing"),e.targets[t.name]=!0,e.mesh=!1):s&&(e.mesh=!0)}clear(){this._rebuildTree()}sweepFeatures(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))}sweepAggregates(e,t,s){}onTileData(e,t,s,r,i,a=!0){if(!this._schema||null==t.addOrUpdate)return t;this.events.emit("changed");const o=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,r)}if(t.status.mesh||!a)return t;const h=new Array;this._getBinsForTile(h,e,o,s),t.addOrUpdate=I.FeatureSetReaderJSON.fromOptimizedFeatures(h,{fields:this.fields,fieldsIndex:this._fieldsIndex,geometryType:"esriGeometryPolygon",objectIdField:this.objectIdField}),t.addOrUpdate.attachStorage(s),t.end=!0,t.isRepush||(t.clear=!0);{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale,i)}}return t}forEachBin(e){this._tree.forEach(e)}forEach(e){this._tree.forEach((t=>{if(t.depth!==this._geohashLevel)return;const s=this._toFeatureJSON(t),r=I.FeatureSetReaderJSON.fromFeatures([s],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields,fieldsIndex:this._fieldsIndex}).getCursor();r.next(),e(r)}))}forEachInBounds(e,t){}forEachBounds(e,t){const{hasM:s,hasZ:r}=this.geometryInfo;for(const i of e){const e=u.getBoundsOptimizedGeometry(G,i.readGeometry(),r,s);null!=e&&t(e)}}onTileUpdate(e){}getAggregate(e){const t=_.createDisplayId(e,!0),s=this._tree.findIf((e=>e.displayId===t));return s?this._toFeatureJSON(s):null}getAggregates(){return this._tree.findAllIf((e=>e.depth===this._geohashLevel)).map(this._toFeatureJSON.bind(this))}getDisplayId(e){return this._tree.findIf((t=>t.id===e))?.displayId}getFeatureDisplayIdsForAggregate(e){const t=this._tree.findIf((t=>t.id===e));return null!=t?Array.from(t.displayIds):[]}getDisplayIdForReferenceId(e){return this._tree.findIf((t=>1===t.displayIds.size&&t.displayIds.has(e)))?.displayId}_toFeatureJSON(e){const t=this._spatialReference;return{displayId:e.displayId,attributes:e.getAttributes(),geometry:u.convertToGeometry(e.getGeometry(t),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(e){const t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),i=this._geohashBuf[2*t],a=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,i,a,this._geohashLevel))}_update(e,t){const s=e.getDisplayId(),r=this._bitsets.inserted,i=t.isVisible(s);if(i===r.has(s))return;if(!i)return void this._remove(e);const a=e.getXHydrated(),o=e.getYHydrated();if(!this._setGeohash(s,a,o))return;const h=this._geohashBuf[2*s],n=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,a,o,h,n,this._geohashLevel),r.set(s)}_setGeohash(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const i=O(t/d.earth.radius),a=i-360*Math.floor((i+180)/360),o=O(Math.PI/2-2*Math.atan(Math.exp(-s/d.earth.radius)));h.setGeohashBuf(r,e,o,a,v)}else{const i={x:t,y:s},a=p.project(i,this._spatialReference,b.WGS84);if(!a)return!1;h.setGeohashBuf(r,e,a.y,a.x,v)}return this._bitsets.geohash.set(e),!0}_getBinsForTile(e,t,s,r){try{const i=this._getGeohashBounds(t),a=this._tree.getBins(i);for(const t of a){t.displayId||(t.displayId=r.createDisplayId(!0));let i=null;const a=t.getGeometry(this._spatialReference,s.tile);a||(i=t.getGeometryCentroid(this._spatialReference,s.tile));const o=new g.OptimizedFeature(a,t.getAttributes(),i);o.objectId=t.id,o.displayId=t.displayId,e.push(o)}}catch(i){return void B.error("Unable to get bins for tile",t.key.id)}}_getGeohash(e,t,s){const r={geohashX:0,geohashY:0};return h.setGeohashXY(r,t,e,s),r}_getGeohashBounds(e){const t=this._getGeohashLevel(e.key.level),s=[e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax],r=S.fromExtent(x.fromBounds(s,this._spatialReference)),i=p.project(r,this._spatialReference,b.WGS84,{densificationStep:e.resolution*F}),a=u.convertFromPolygon(new c,i,!1,!1),o=a.coords.filter(((e,t)=>!(t%2))),h=a.coords.filter(((e,t)=>t%2)),n=Math.min(...o),d=Math.min(...h),l=Math.max(...o),g=Math.max(...h),f=this._getGeohash(n,d,t),_=this._getGeohash(l,g,t);return{bounds:s,geohashBounds:{xLL:f.geohashX,yLL:f.geohashY,xTR:_.geohashX,yTR:_.geohashY},level:t}}_getGeohashLevel(e){return this._schema.params.fixedBinLevel}_getTransforms(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=l.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[i,a]=r.valid;return{tile:s,left:{...s,translate:[a,e.bounds[3]]},right:{...s,translate:[i-a+e.bounds[0],e.bounds[3]]}}}}e.BinStore=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
