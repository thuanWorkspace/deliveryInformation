/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../../../core/Evented","../../../../../core/has","../../../../../chunks/rbush","./Tile","../../../tiling/TileCoverage","../../../tiling/TileKey"],(function(e,t,s,i,n,h){"use strict";const d={added:[],removed:[]},o=new Set,l=new h(0,0,0,0);class r extends e{constructor(e){super(),this._tiles=new Map,this._index=s.rbush(9,t("esri-csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=e}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){const t={added:[],removed:[]};for(const s of e.added)if(!this.has(s)){const e=new i.Tile(this.tileScheme,s);this._tiles.set(s,e),this._index.insert(e),t.added.push(e)}for(const s of e.removed)if(this.has(s)){const e=this.get(s);this._tiles.delete(s),this._index.remove(e),t.removed.push(e)}this.tiles.length=0,this._tiles.forEach((e=>this.tiles.push(e))),(t.added.length||t.removed.length)&&this.emit("update",t)}setViewState(e){const t=this.tileScheme.getTileCoverage(e,0);if(!t)return;const{spans:s,lodInfo:h}=t,{level:r}=h;if(s.length>0)for(const{row:n,colFrom:a,colTo:c}of s)for(let e=a;e<=c;e++){const t=l.set(r,n,h.normalizeCol(e),h.getWorldForColumn(e)).id;if(o.add(t),!this.has(t)){const e=new i.Tile(this.tileScheme,t);this._tiles.set(t,e),this._index.insert(e),this.tiles.push(e),d.added.push(e)}}for(let i=this.tiles.length-1;i>=0;i--){const e=this.tiles[i];o.has(e.id)||(this._tiles.delete(e.id),this.tiles.splice(i,1),this._index.remove(e),d.removed.push(e))}(d.added.length||d.removed.length)&&this.emit("update",d),n.pool.release(t),o.clear(),d.added.length=0,d.removed.length=0}}return r}));
