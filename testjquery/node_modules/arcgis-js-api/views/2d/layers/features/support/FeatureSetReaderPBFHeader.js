/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../layers/support/FieldsIndex","../../../../../rest/query/operations/pbfFeatureServiceParser"],(function(e,t,s,r){"use strict";const n=268435455;class o{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}}function a(e,a,i=!1){const c=1,f=3,d=9,u=12,l=13,g=15,p=e.asUnsafe(),h=p.pos(),b=new o;let y=0,w=0;const k=1,x=2,I=4,m=3;let F=null,L=null,A=null,S=!1;const C=[];for(;p.next();)switch(p.tag()){case c:F=p.getString();break;case f:L=p.getString();break;case u:A=p.processMessage(r.parseTransform);break;case d:if(b.exceededTransferLimit=p.getBool(),b.exceededTransferLimit){b.offsets.geometry=i?new Float64Array(8e3):new Int32Array(8e3),b.centroid=i?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<b.centroid.length;e++)b.centroid[e]=n}break;case l:{const e=p.processMessage(r.parseField);e.index=y++,C.push(e);break}case g:{const e=p.getLength(),t=p.pos()+e;if(!b.exceededTransferLimit){const e=b.offsets.geometry,t=b.centroid;e.push(0),t.push(n),t.push(n)}!S&&b.exceededTransferLimit&&(S=!0,b.offsets.attributes=i?new Float64Array(8e3*y):new Uint32Array(8e3*y));let s=w*y;for(;p.pos()<t&&p.next();)switch(p.tag()){case k:{if(S)b.offsets.attributes[s++]=p.pos();else{b.offsets.attributes.push(p.pos())}const e=p.getLength();p.skipLen(e);break}case x:if(a){const e=p.getLength(),t=p.pos()+e;for(;p.pos()<t&&p.next();)switch(p.tag()){case m:{p.getUInt32();const e=p.getSInt64(),t=p.getSInt64();b.centroid[2*w]=e,b.centroid[2*w+1]=t;break}default:p.skip()}}else{b.offsets.geometry[w]=p.pos();const e=p.getLength();b.vertexCount+=e,p.skipLen(e)}break;case I:{const e=p.getLength(),t=p.pos()+e;for(;p.pos()<t&&p.next();)switch(p.tag()){case m:{p.getUInt32();const e=p.getSInt64(),t=p.getSInt64();b.centroid[2*w]=e,b.centroid[2*w+1]=t;break}default:p.skip()}break}default:p.skip()}w++,b.hasFeatures=!0;break}default:p.skip()}const T=F||L;if(!T)throw new t("FeatureSet has no objectId or globalId field name");return b.fields=new s(C),b.featureCount=w,b.fieldCount=y,b.objectIdFieldIndex=b.fields.get(T)?.index,b.transform=A,b.displayIds=new Uint32Array(b.featureCount),b.groupIds=new Uint16Array(b.featureCount),p.move(h),b}e.FeatureSetHeader=o,e.parseHeader=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
