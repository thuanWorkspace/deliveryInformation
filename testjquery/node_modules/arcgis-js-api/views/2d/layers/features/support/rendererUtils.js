/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/screenUtils","../../../../webgl/capabilities"],(function(e,t,r,o,s,l){"use strict";const a=8,n=a-2,i=o.getLogger("esri.views.2d.layers.features.support.rendererUtils"),u=e=>{if(!("visualVariables"in e)||!e.visualVariables?.length)return e;const t=e.clone(),r=t.visualVariables.map((e=>c(e)?f(e):e));return t.visualVariables=r,t};function p(e){return e.map((e=>c(e)?f(e.clone()):e))}function c(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function f(e){return e.stops=y(e.type,e.stops??[]),e}function b(e,t,r){return(1-r)*e+r*t}function g(e,t){const[r,...o]=t,l=o.pop(),a=o[0].value,i=o[o.length-1].value,u=(i-a)/n,p=[];for(let n=a;n<i;n+=u){let r=0;for(;n>=o[r].value;)r++;const l=o[r],a=t[r-1],i=n-a.value,u=l.value===a.value?1:i/(l.value-a.value);if("color"===e){const e=o[r],s=t[r-1],l=e.color.clone();l.r=b(s.color.r,l.r,u),l.g=b(s.color.g,l.g,u),l.b=b(s.color.b,l.b,u),l.a=b(s.color.a,l.a,u),p.push({value:n,color:l,label:e.label})}else if("size"===e){const e=o[r],l=t[r-1],a=s.toPt(e.size),i=b(s.toPt(l.size),a,u);p.push({value:n,size:i,label:e.label})}else{const e=o[r],s=b(t[r-1].opacity,e.opacity,u);p.push({value:n,opacity:s,label:e.label})}}return[r,...p,l]}function d(e){const[t,...r]=e,o=r.pop();for(;r.length>n;){let e=0,t=0;for(let o=1;o<r.length;o++){const s=r[o-1],l=r[o],a=Math.abs(l.value-s.value);a>t&&(t=a,e=o)}r.splice(e,1)}return[t,...r,o]}function y(e,t){return t.length<=a?t:(i.warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${a}. Displayed stops will be simplified.`),t.length>2*a?g(e,t):d(t))}function m(){if(r("heatmap-force-raster"))return"raster";const{supportsTextureFloat:e,supportsTextureHalfFloat:t,supportsColorBufferFloat:o,supportsColorBufferFloatBlend:s,supportsColorBufferHalfFloat:a}=l.getWebGLCapabilities("2d");return e&&o&&s||t&&a?"symbol":r("heatmap-allow-raster-fallback")?"raster":"none"}function h(e){if(!e)return!0;switch(e.type){case"dot-density":if(!l.getWebGLCapabilities("2d").supportsTextureFloat)return i.error(new t("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),!1;break;case"heatmap":{const e=m();if("none"===e||"raster"===e&&!r("heatmap-force-raster")){const r=l.getWebGLCapabilities("2d"),o=["supportsTextureFloat","supportsTextureHalfFloat","supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((e=>!r[e])).join(", ");if("none"===e)return i.errorOnce(new t("webgl-missing-extension",`Missing WebGL${r.type} requirements for Heatmap: ${o}`)),!1;"raster"===e&&i.warnOnce(`Missing WebGL${r.type} requirements for accelerated Heatmap: ${o}. Feature support may be limited.`)}break}}return!0}e.getSupportedHeatmapRenderer=m,e.isRendererSupported=h,e.simplifyVVRenderer=u,e.simplifyVisualVariables=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
