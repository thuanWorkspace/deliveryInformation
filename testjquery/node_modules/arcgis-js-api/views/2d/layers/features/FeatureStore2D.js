/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/CircularArray","../../../../core/Evented","../../../../core/has","../../../../chunks/rbush","../../../../geometry/support/aaBoundingBox","./Store2D","./support/FeatureSetReaderPBFIndirect"],(function(t,e,s,a,n,r,i,o){"use strict";const d=r.create();function h(t,e){return t<<16|e}function c(t){return(4294901760&t)>>>16}function u(t){return 65535&t}const I={getObjectId:t=>t.getObjectId(),getAttributes:t=>t.readAttributes(),getAttribute:(t,e)=>t.readAttribute(e),getAttributeAsTimestamp:(t,e)=>t.readAttributeAsTimestamp(e),cloneWithGeometry:(t,e)=>t,getGeometry:t=>t.readHydratedGeometry(),getCentroid:(t,e)=>t.readCentroid()};class l extends i.Store2D{constructor(t,a,r){super(t,a),this.featureAdapter=I,this.events=new s,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new e(50),this._index=n.rbush(9,(t=>({minX:this._storage.getXMin(t),minY:this._storage.getYMin(t),maxX:this._storage.getXMax(t),maxY:this._storage.getYMax(t)}))),this.mode=r}get storeStatistics(){let t=0,e=0,s=0;return this.forEach((a=>{const n=a.readGeometry();n&&(e+=n.isPoint?1:n.lengths.reduce(((t,e)=>t+e),0),s+=n.isPoint?1:n.lengths.length,t+=1)})),{featureCount:t,vertexCount:e,ringCount:s}}hasInstance(t){return this._featureSetsByInstance.has(t)}onTileData(t,e,s){if(null==e.addOrUpdate)return e;if(e.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const a=e.addOrUpdate.getCursor();for(;a.next();){const e=a.getDisplayId();this.setComputedAttributes(this._storage,a,e,t.scale,s)}return e}this._featureSetsByInstance.set(e.addOrUpdate.instance,e.addOrUpdate);const a=e.addOrUpdate.getCursor();for(;a.next();)this._insertFeature(a,t.scale,s);return this._spatialIndexInvalid=!0,this.events.emit("changed"),e}search(t){this._rebuildIndex();const e=t.id,s=this._indexSearchCache.find((t=>t.tileId===e));if(null!=s)return s.readers;const a=new Map,n=this._searchIndex(t.bounds),r=[];for(const i of n){const t=this._storage.getInstanceId(i),e=c(t),s=u(t);a.has(e)||a.set(e,[]);a.get(e).push(s)}return a.forEach(((t,e)=>{const s=this._featureSetsByInstance.get(e);r.push(o.FeatureSetReaderIndirect.from(s,t))})),this._indexSearchCache.enqueue({tileId:e,readers:r}),r}insert(t){const e=t.getCursor(),s=this._storage;for(;e.next();){const t=h(e.instance,e.getIndex()),a=e.getObjectId(),n=this._objectIdToDisplayId.get(a)??this._storage.createDisplayId();e.setDisplayId(n),s.setInstanceId(n,t),this._objectIdToDisplayId.set(a,n)}this._featureSetsByInstance.set(t.instance,t),this._spatialIndexInvalid=!0}remove(t){const e=this._objectIdToDisplayId.get(t);if(!e)return;const s=this._storage.getInstanceId(e),a=u(s),n=c(s),r=this._featureSetsByInstance.get(n);this._objectIdToDisplayId.delete(t),this._storage.releaseDisplayId(e),r.removeAtIndex(a),r.isEmpty&&this._featureSetsByInstance.delete(n),this._spatialIndexInvalid=!0}forEach(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),a=this._lookupFeature(s);t(a)}))}forEachUnsafe(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),a=c(s),n=u(s),r=this._getFeatureSet(a);r.setIndex(n),t(r)}))}forEachInBounds(t,e){const s=this._searchIndex(t);for(const a of s){e(this.lookupFeatureByDisplayId(a,this._storage))}}forEachBounds(t,e){this._rebuildIndex();for(const s of t){if(!s.readGeometry())continue;const t=s.getDisplayId();r.fromRectValues(d,this._storage.getXMin(t),this._storage.getYMin(t),this._storage.getXMax(t),this._storage.getYMax(t)),e(d)}}sweepFeatures(t,e,s){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach(((a,n)=>{t.has(a)||(e.releaseDisplayId(a),s&&s.unsetAttributeData(a),this._objectIdToDisplayId.delete(n))})),this.events.emit("changed")}sweepFeatureSets(t){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach(((e,s)=>{t.has(s)||this._featureSetsByInstance.delete(s)}))}lookupObjectId(t,e){const s=this.lookupFeatureByDisplayId(t,e);return null==s?null:s.getObjectId()}lookupDisplayId(t){return this._objectIdToDisplayId.get(t)}lookupFeatureByDisplayId(t,e){const s=e.getInstanceId(t);return this._lookupFeature(s)}lookupByDisplayIdUnsafe(t){const e=this._storage.getInstanceId(t),s=c(e),a=u(e),n=this._getFeatureSet(s);return n?(n.setIndex(a),n):null}_insertFeature(t,e,s){const a=this._storage,n=t.getObjectId(),r=h(t.instance,t.getIndex());a.getInstanceId(t.getDisplayId());let i=this._objectIdToDisplayId.get(n);i||(i=a.createDisplayId(),this._objectIdToDisplayId.set(n,i),this._spatialIndexInvalid=!0),t.setDisplayId(i),a.setInstanceId(i,r),this.setComputedAttributes(a,t,i,e,s)}_searchIndex(t){this._rebuildIndex();const e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this._index.search(e)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const t=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach((e=>{const s=e.getCursor();for(;s.next();){const e=s.getDisplayId();this._storage.setBounds(e,s)&&t.push(e)}})):this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e);this._storage.setBounds(e,this._lookupFeature(s))&&t.push(e)})),this._index.clear(),this._index.load(t),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(t){const e=c(t),s=this._getFeatureSet(e);if(!s)return;const a=s.getCursor(),n=u(t);return a.setIndex(n),a}_getFeatureSet(t){return this._featureSetsByInstance.get(t)}}t.FeatureStore2D=l,t.featureAdapter=I,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
