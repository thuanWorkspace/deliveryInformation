/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/arrayUtils","../../../../../core/CircularArray","../../../../../core/has","../../../../../core/promiseUtils","../support/FeatureSetReaderJSON","../support/UpdateToken"],(function(e,t,s,r,i,o,d){"use strict";class a{constructor(e,t){this.requests={done:new Array,stream:new s(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._isDone=!1,this.didSend=!1,this.tile=e,this._version=t,this._resolver=i.createResolver(),this._resolver.promise.catch((e=>i.throwIfNotAbortError(e)))}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length&&null==this.edits}get edits(){return this._edits}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0,this._resolver.resolve()}clear(){this.requests.done=[]}applyUpdate(e){this.requests.done.forEach((t=>t.message.status.unset(e))),this._version=e.version,null!=this._edits&&this._edits.status.unset(e)}add(e){e.message.status=e.message.status??d.UpdateToken.empty(),e.message.status.version=this._version,r("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),e.message.end&&(this.requests.done.forEach((e=>{null!=e.message&&e.message.end&&(e.message.end=!1)})),this._resolver.resolve(),this._isDone=!0),this.requests.done.push(e)}edit(e,s){const r=e.getQuantizationTransform(),i=e.fullSchema(),a=Array.from(e.features()).filter(t.isSome),n=[...s,...a.map((e=>e.objectId))];if(this.removeIds(n),this._invalidate(),null==this._edits)return void(this._edits={type:"append",addOrUpdate:o.FeatureSetReaderJSON.fromOptimizedFeatures(a,i,r),id:this.tile.id,status:d.UpdateToken.empty(),end:!0});this.requests.done.forEach((e=>e.message.end=!1));this._edits.addOrUpdate.append(e.features())}*readers(){for(const{message:e}of this.requests.done)null!=e.addOrUpdate&&(yield e.addOrUpdate);null!=this._edits?.addOrUpdate&&(yield this._edits.addOrUpdate)}_invalidate(){for(const e of this.requests.done)e.message.status=d.UpdateToken.empty();null!=this._edits&&(this._edits.status=d.UpdateToken.empty())}removeIds(e){this._invalidate();for(const{message:t}of this.requests.done){const s=t.addOrUpdate;null!=s&&(s.removeIds(e),s.isEmpty&&(r("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),t.addOrUpdate=null))}null!=this._edits?.addOrUpdate&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter((e=>e.message.addOrUpdate||e.message.end))}abort(){this._abortController.abort(),this._resolver.reject(i.createAbortError())}}e.DataTileSubscription=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
