/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../core/Logger","../../../../../core/promiseUtils","./BaseFeatureSource"],(function(e,t,r,a,s){"use strict";class o extends s.BaseFeatureSource{constructor(e){super(e)}async _fetchDataTile(e){const s=6,o=20,i=this._subscriptions.get(e.key.id);let n=!1,d=0,u=0;const c=(t,r)=>{u--,a.throwIfAborted(i);const s=e.id,o=t.reader,d=t.query;if(!o.exceededTransferLimit){if(n=!0,0!==r&&!o.hasFeatures){const e={id:s,addOrUpdate:o,end:0===u,type:"append"};return i.add({message:e,query:d}),void this._onMessage(e)}const e={id:s,addOrUpdate:o,end:0===u,type:"append"};return i.add({message:e,query:d}),void this._onMessage(e)}const c={id:s,addOrUpdate:o,end:n&&0===u,type:"append"};i.add({message:c,query:d}),this._onMessage(c)};let h=0,l=0;for(;!n&&l++<o;){let o;for(let s=0;s<h+1;s++){const s=d++;u++,o=this._fetchDataTilePage(e,s,i).then((e=>e&&c(e,s))).catch((s=>{if(n=!0,!a.isAbortError(s)){r.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new t("mapview-query-error","Encountered error when fetching tile",{tile:e,error:s}));const a={id:e.id,addOrUpdate:null,end:n,type:"append"},o={start:this.pageSize*d,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};null!=this.maxRecordCountFactor&&(o.maxRecordCountFactor=this.maxRecordCountFactor);const u=this.createTileQuery(e,o);i.add({message:a,query:u}),this._onMessage(a)}}))}await o,a.throwIfAborted(i),h=Math.min(h+2,s)}}async _fetchDataTilePage(e,t,r){a.throwIfAborted(r);const s=this._queryInfo,o={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};null!=this.maxRecordCountFactor&&(o.maxRecordCountFactor=this.maxRecordCountFactor);const i=this.createTileQuery(e,o);try{const o=r.signal,n=await this.enqueueQuery({tile:e,query:i,signal:o,depth:t});return a.throwIfAborted(r),n?s!==this._queryInfo?this._fetchDataTilePage(e,t,r):{reader:n,query:i}:null}catch(n){return a.throwIfNotAbortError(n),null}}}e.PagedFeatureSource=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
