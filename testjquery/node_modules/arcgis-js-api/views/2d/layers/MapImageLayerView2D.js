/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../support/GraphicsCollection","../engine/BitmapContainer","./LayerView2D","./graphics/GraphicsView2D","./graphics/HighlightGraphicContainer","./support/ExportStrategy","../../layers/LayerView","../../layers/MapImageLayerView","../../layers/RefreshableLayerView","../../layers/support/MapServiceLayerViewHelper","../../support/drapedUtils"],(function(e,t,i,r,a,s,h,p,o,n,c,g,l,d,u,y,m,w,_,H){"use strict";let f=class extends(m(w(g.LayerView2DMixin(y)))){constructor(){super(...arguments),this._highlightGraphics=new n.GraphicsCollection,this._updateHash=""}fetchPopupFeatures(e,t){return this._popupHighlightHelper.fetchPopupFeatures(e,t)}update(e){const r=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==r&&(this._updateHash=r,this.strategy.update(e).catch((e=>{i.isAbortError(e)||t.getLogger(this).error(e)})),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){const{imageMaxWidth:e,imageMaxHeight:t,version:i}=this.layer,a=i>=10.3,s=i>=10;this._bitmapContainer=new c.BitmapContainer,this.container.addChild(this._bitmapContainer),this._highlightView=new l({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new d(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new _.MapServiceLayerViewHelper({createFetchPopupFeaturesQueryGeometry:(e,t)=>H.createQueryGeometry(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(e,t)=>{this._highlightView.graphicUpdateHandler({graphic:e,property:t})},layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new u({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:a,imageNormalizationSupported:s,hidpi:!0}),this.addAttachHandles(r.watch((()=>this.exportImageVersion),(()=>this.requestUpdate()))),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash="",this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,i,r){return this.layer.fetchImage(e,t,i,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(e,t,i,r){return this.layer.fetchImageBitmap(e,t,i,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(e){return this._popupHighlightHelper.highlight(e)}};e.__decorate([a.property()],f.prototype,"strategy",void 0),e.__decorate([a.property()],f.prototype,"updating",void 0),f=e.__decorate([o.subclass("esri.views.2d.layers.MapImageLayerView2D")],f);return f}));
