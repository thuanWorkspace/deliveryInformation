/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../geometry","../../Viewpoint","../../core/Accessor","../../core/maybe","../../core/scheduling","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../ViewAnimation","./unitBezier","./viewpointUtils","../../geometry/Point"],(function(t,i,e,s,n,o,a,r,h,p,c,u,d,l,m){"use strict";class y{constructor(t,i,e,s){const n=t.targetGeometry,o=i.targetGeometry;s?"string"==typeof s&&(s=d.parse(s)||d.easingFunctions.ease):s=d.easingFunctions.ease,this.easing=s,this.duration=e,this.sCenterX=n.x,this.sCenterY=n.y,this.sScale=t.scale,this.sRotation=t.rotation,this.tCenterX=o.x,this.tCenterY=o.y,this.tScale=i.scale,this.tRotation=i.rotation,this.dCenterX=this.tCenterX-this.sCenterX,this.dCenterY=this.tCenterY-this.sCenterY,this.dScale=this.tScale-this.sScale,this.dRotation=this.tRotation-this.sRotation,this.dRotation>180?this.dRotation-=360:this.dRotation<-180&&(this.dRotation+=360)}applyRatio(t,i){const e=this.easing(i);let s,n,o,a;i>=1?(s=this.tCenterX,n=this.tCenterY,o=this.tRotation,a=this.tScale):(s=this.sCenterX+e*this.dCenterX,n=this.sCenterY+e*this.dCenterY,o=this.sRotation+e*this.dRotation,a=this.sScale+e*this.dScale),t.targetGeometry.x=s,t.targetGeometry.y=n,t.scale=a,t.rotation=o}}let w=class extends s{constructor(t){super(t),this.updateFunction=null,this.animation=null,this.duration=200,this.transition=null,this.easing=d.easingFunctions.ease,this.view=null,this.viewpoint=new e({targetGeometry:new m,scale:0,rotation:0}),this._updateTask=o.addFrameTask({postRender:this._postRender.bind(this)}),this._updateTask.pause()}destroy(){this._updateTask=n.removeMaybe(this._updateTask)}animate(t,i,e){this.stop();const s=this.viewpoint;l.copy(s,i),this.transition=new y(this.viewpoint,t.target,e?.duration||this.duration,e?.easing||this.easing);const n=()=>{this.animation===t&&this._updateTask&&("finished"===t.state&&(this.transition?.applyRatio(this.viewpoint,1),this.view?.state&&(this.view.state.viewpoint=this.viewpoint.clone())),this.animation=null,this.updateFunction=null)};return t.when(n,n),this._startTime=performance.now(),this._updateTask.resume(),this.animation=t,t}animateContinous(t,i){this.stop(),this.updateFunction=i,this.viewpoint=t;const e=new u({target:t.clone()}),s=()=>{this.animation===e&&this._updateTask&&(this.animation=null,this.updateFunction=null)};return e.when(s,s),this._startTime=performance.now(),this._updateTask.resume(),this.animation=e,e}stop(){this.animation&&(this.animation.stop(),this.animation=null,this.updateFunction=null)}_postRender(t){const i=this.animation;if(i&&i.state!==u.State.STOPPED){if(this.updateFunction)this.updateFunction(this.viewpoint,t.deltaTime);else{const t=this.transition,i=(performance.now()-this._startTime)/t.duration,e=i>=1;t.applyRatio(this.viewpoint,i),e&&this.animation?.finish()}this.view?.state&&(this.view.state.viewpoint=this.viewpoint.clone())}else this._updateTask.pause()}};t.__decorate([a.property()],w.prototype,"animation",void 0),t.__decorate([a.property()],w.prototype,"duration",void 0),t.__decorate([a.property()],w.prototype,"transition",void 0),t.__decorate([a.property()],w.prototype,"easing",void 0),t.__decorate([a.property()],w.prototype,"view",void 0),t.__decorate([a.property()],w.prototype,"viewpoint",void 0),w=t.__decorate([c.subclass("esri.views.2d.AnimationManager")],w);return w}));
