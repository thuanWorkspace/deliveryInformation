/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Handles","../../../../../chunks/vec2","../../../../../chunks/vec2f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/boundedPlane","../../../../../geometry/support/spatialReferenceUtils","./Manipulation","./utils","../../../../interactive/dragEventPipeline","../../../../interactive/GraphicManipulator","../../../../interactive/editGeometry/interfaces","../../../../interactive/editGeometry/operations/UpdateVertices","../../../../interactive/editGeometry/support/editPlaneUtils"],(function(t,e,i,a,n,r,s,o,c,l,h,u,p,d,_){"use strict";const v=10,g=1e-6,m=.3;function y(t){const e=n.length(t.basis1),i=n.length(t.basis2);return m*Math.min(e,i)}class b extends c.Manipulation{constructor(t){super(),this._handles=new e,this._planeStart=s.create(),this._displayPlaneStart=s.create(),this._originCache=r.create(),this._axisCache=a.create(),this._renderStartCache=r.create(),this._renderEndCache=r.create(),this._resizeOriginCache=r.create(),this._view=t.view,this._tool=t.tool,this._graphic=t.graphic,this._direction=t.direction,this._preserveAspectRatio=t.preserveAspectRatio,this._manipulator=this._createManipulator(),this._handles.add([this._manipulator.events.on("grab-changed",(t=>l.onGrabChangedHandle(t,this._manipulator)))]),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._graphic=null,this._manipulator=null,this._direction=null,this._handles=null,this._planeStart=null,this._displayPlaneStart=null,this._originCache=null,this._axisCache=null,this._renderStartCache=null,this._renderEndCache=null,this._resizeOriginCache=null,this._preserveAspectRatio=null}forEachManipulator(t){t(this._manipulator,c.ManipulatorType.SCALE)}createDragPipeline(t,e){let a=null,r=null,c=null,l=0,u=null,m=null;const b=this._planeStart,f=this._displayPlaneStart,A=this._direction;return h.createManipulatorDragEventPipeline(this._manipulator,((C,S)=>{S.next((e=>{if("start"===e.action){C.cursor="grabbing";const e=t();a=e.plane,r=e.displayPlane,c=e.editGeometryOperations,l=v*this._view.resolution,s.copy(a,b),s.copy(r,f);const i=o.getInfo(c.data.spatialReference);u=i?i.valid[1]-i.valid[0]-3*v*this._view.resolution:null}return e})).next(h.screenToMap(this._view)).next((t=>{const e=n.copy(this._renderStartCache,[t.mapStart.x,t.mapStart.y,0]),i=n.copy(this._renderEndCache,[t.mapEnd.x,t.mapEnd.y,0]),a=n.copy(this._resizeOriginCache,f.origin);n.scaleAndAdd(a,a,f.basis1,-A[0]),n.scaleAndAdd(a,a,f.basis2,-A[1]),n.subtract(i,i,a),n.subtract(e,e,a);const s=0!==A[0]&&0!==A[1],o=y(f),c=y(r)/o,h=(t,a)=>{if(0===t)return 1;let r=n.length(a),o=.5*t*n.dot(a,i)/r;const h=o<0?-1:1;if(s){o+=(r-.5*t*n.dot(a,e)/r)*h*c}const u=r<1.5*l?1:g;return r=Math.max(r-l,g),h>0&&(o-=v*this._view.resolution),h*Math.max(h*(o/r),u)},u=h(A[0],f.basis1),p=h(A[1],f.basis2);return{...t,direction:A,factor1:u,factor2:p}})).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next((t=>{const r=n.copy(this._originCache,b.origin);n.scaleAndAdd(r,r,b.basis1,-A[0]),n.scaleAndAdd(r,r,b.basis2,-A[1]);const o=i.set(this._axisCache,b.basis1[0],b.basis1[1]);i.normalize(o,o);const l=[];for(const e of c.data.components)l.push(...e.vertices);const h="start"===t.action?p.AccumulationBehaviour.NEW_STEP:p.AccumulationBehaviour.ACCUMULATE_STEPS,v=c.scaleVertices(l,r,o,t.factor1,t.factor2,h,d.AccumulationType.REPLACE);return u&&u<c.data.geometry.extent.width&&m?c.updateVertices(l,m):(s.copy(b,a),_.apply(v,a),m=v.operation,e(t,v)),t})).next((t=>("end"===t.action&&(C.cursor="grab"),t)))}))}_createManipulator(){return new u.GraphicManipulator({view:this._view,graphic:this._graphic,selectable:!0,cursor:"grab"})}}t.ScaleManipulation=b,t.calculateDiagonalResizeHandleScale=y,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
