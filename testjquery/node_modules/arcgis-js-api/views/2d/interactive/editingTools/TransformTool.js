/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../geometry","../../../../Graphic","../../../../symbols","../../../../core/colorUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../chunks/boundedPlane","../../../../geometry/support/spatialReferenceUtils","../../../../layers/GraphicsLayer","../../../ViewingMode","./manipulations/DragManipulation","./manipulations/RotateManipulation","./manipulations/ScaleManipulation","./manipulations/utils","../../../input/keys","../../../interactive/InteractiveToolBase","../../../interactive/editGeometry/EditGeometry","../../../interactive/editGeometry/EditGeometryOperations","../../../interactive/editGeometry/interfaces","../../../interactive/editGeometry/operations/UpdateVertices","../../../interactive/editGeometry/support/editPlaneUtils","../../../support/hitTestSelectUtils","../../../support/screenUtils","../../../../geometry/Polygon","../../../../geometry/Point","../../../../symbols/SimpleFillSymbol","../../../../symbols/SimpleMarkerSymbol"],(function(e,t,i,s,o,a,r,n,c,l,h,p,_,d,u,y,g,m,f,v,G,w,R,b,T,P,k,A,C,S,M,O,U,D,E,x,B,L,V,H){"use strict";const j={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",plus:"+",minus:"-",toggleOpacity:"t",shift:"Shift",primaryKey:A.primaryKey},z=80,I=10,F=30,K=[[1,1],[1,-1],[-1,-1],[-1,1],[1,0],[0,-1],[-1,0],[0,1]],N=1,q=10;e.TransformTool=class extends C.InteractiveToolBase{constructor(e){super(e),this._initialControlPoints=null,this._initialGeometry=null,this._graphic=null,this._planeCache=v.create(),this._displayPlaneCache=v.create(),this._mainAxisCache=y.create(),this._rotationHandleCache=m.create(),this._cornerA=m.create(),this._cornerB=m.create(),this._cornerC=m.create(),this._cornerD=m.create(),this._avgAB=m.create(),this._avgBC=m.create(),this._avgCD=m.create(),this._avgDA=m.create(),this._preserveAspectRatio=new k.PreserveAspectRatio,this._snapRotation=new k.SnapRotation,this._graphicsLayer=new w({internal:!0,listMode:"hide",visible:!1}),this._sharedUndoStack=[],this._sharedRedoStack=[],this._isOpacityToggled=!1,this._isModifierActive=!1,this._factor=1,this.preserveAspectRatio=null,this.snapRotation=null}initialize(){this._initialize()}destroy(){const{map:e}=this.view;this._dragManipulation.destroy(),this._rotateManipulation.destroy(),this._scaleManipulations.forEach((e=>e.destroy())),this._editGeometryOperations.destroy(),e.removeMany([this._graphicsLayer]),this._graphicsLayer.removeAll(),this._graphicsLayer=r.destroyMaybe(this._graphicsLayer),this._initialControlPoints=null,this._initialGeometry=null,this._graphic=null,this._preserveAspectRatio=null,this._snapRotation=null,this._planeCache=null,this._displayPlaneCache=null,this._rotationHandleCache=null,this._mainAxisCache=null,this._cornerA=null,this._cornerB=null,this._cornerC=null,this._cornerD=null,this._avgAB=null,this._avgBC=null,this._avgCD=null,this._avgDA=null,this._sharedUndoStack=null,this._sharedRedoStack=null}get _plane(){const e=this._graphic.geometry;if(null==e)return null;const t=this._editGeometryOperations.data,i=t.components[0].edges[0],s=u.subtract(this._mainAxisCache,i.leftVertex.pos,i.rightVertex.pos);u.normalize(s,s);let o=z*this.view.resolution;const a=this.view.spatialReference;return G.equals(a,e.spatialReference)&&(o*=c.getMetersPerUnitForSR(a)/c.getMetersPerUnitForSR(e.spatialReference)),D.calculateOrientedBounds(s,t,o,this._planeCache)}get _displayPlane(){const e=this._plane;if(!e)return null;const t=this._displayPlaneCache;v.copy(e,t);const i=I*this.view.resolution;return g.scale(t.basis1,t.basis1,1+i/g.length(t.basis1)),g.scale(t.basis2,t.basis2,1+i/g.length(t.basis2)),t}get _backgroundGraphicGeometry(){const e=this._displayPlane;if(!e)return null;const t=this.view.spatialReference;return this._updateDisplayPlaneConrers(e),new B({spatialReference:t,rings:[[this._cornerA,this._cornerB,this._cornerC,this._cornerD,this._cornerA]]})}get _rotateGraphicGeometry(){const e=this._plane;if(!e)return null;const t=this._rotationHandleCache;return g.normalize(t,e.basis1),g.scale(t,t,F*this.view.resolution),g.add(t,t,e.origin),g.add(t,t,e.basis1),new L({x:t[0],y:t[1],spatialReference:this.view.spatialReference})}get _scaleGraphicGeometries(){const e=this._displayPlane;if(!e)return[];const t=this.view.spatialReference;this._updateDisplayPlaneConrers(e);const{_cornerA:i,_cornerB:s,_cornerC:o,_cornerD:a}=this,r=g.lerp(this._avgAB,i,s,.5),n=g.lerp(this._avgBC,s,o,.5),c=g.lerp(this._avgCD,o,a,.5),l=g.lerp(this._avgDA,a,i,.5);return[new L({x:i[0],y:i[1],spatialReference:t}),new L({x:s[0],y:s[1],spatialReference:t}),new L({x:o[0],y:o[1],spatialReference:t}),new L({x:a[0],y:a[1],spatialReference:t}),new L({x:r[0],y:r[1],spatialReference:t}),new L({x:n[0],y:n[1],spatialReference:t}),new L({x:c[0],y:c[1],spatialReference:t}),new L({x:l[0],y:l[1],spatialReference:t})]}onActivate(){this.visible=!0}onDeactivate(){this.visible=!1}onShow(){this._graphicsLayer.visible=!0}onHide(){this._graphicsLayer.visible=!1}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this._editGeometryOperations.undo(),this.updateGraphics()}redo(){this._editGeometryOperations.redo(),this.updateGraphics()}refresh(){const{view:e,target:t}=this,i="georeference"in t?t.georeference.coords:t.geometry,s=this._editGeometryOperations,o=s.data.components[0].vertices,a=S.EditGeometry.fromGeometry(f.project(i,e.spatialReference),R.ViewingMode.Local).components[0].vertices;o.forEach(((e,t)=>{s.setVertexPosition(e,a[t].pos)})),this.updateGraphics()}reset(){const{target:e}=this;if("georeference"in e){const t=e.georeference;"control-points"===t.type&&(t.controlPoints=this._initialControlPoints)}else e.geometry=this._initialGeometry;this.refresh(),this._sharedUndoStack.length=0,this._sharedRedoStack.length=0}updateGraphics(){const e=this._editGeometryOperations.data.geometry;if("georeference"in this.target){this.target.georeference.coords=e}this._graphic.geometry=e,this._backgroundGraphic.geometry=this._backgroundGraphicGeometry,this._rotateGraphic.geometry=this._rotateGraphicGeometry,this._scaleGraphicGeometries.forEach(((e,t)=>{this._scaleGraphics[t].geometry=e}))}setSharedUndoStack(e){this._sharedUndoStack=e}setSharedRedoStack(e){this._sharedRedoStack=e}async _initialize(){const{view:e,target:t}=this;if("georeference"in t){const e=t.georeference;this._graphic=new s({geometry:e.coords}),this._initialControlPoints="control-points"===e.type?e.controlPoints:null}else this._graphic=t,this._initialGeometry=t.geometry;e.map.addMany([this._graphicsLayer]),e.focus(),this.visible=!1,this.finishToolCreation(),await this._loadProjectionEngine(),this._editGeometryOperations=M.EditGeometryOperations.fromGeometry(f.project(this._graphic.geometry,e.spatialReference),R.ViewingMode.Local),this._backgroundGraphic=new s({symbol:new V({color:"transparent",outline:{type:"simple-line",color:e.effectiveTheme.accentColor,width:2}}),geometry:this._backgroundGraphicGeometry}),this._rotateGraphic=new s({symbol:new H({color:a.getContrast(e.effectiveTheme.accentColor),outline:{type:"simple-line",color:e.effectiveTheme.accentColor,width:1}}),geometry:this._rotateGraphicGeometry}),this._scaleGraphics=this._scaleGraphicGeometries.map((t=>new s({symbol:new H({size:6,style:"square",color:a.getContrast(e.effectiveTheme.accentColor),outline:{type:"simple-line",color:e.effectiveTheme.accentColor,width:1}}),geometry:t}))),this._graphicsLayer.graphics.addMany([this._backgroundGraphic,this._rotateGraphic,...this._scaleGraphics]),this._dragManipulation=new b.DragManipulation({tool:this,view:e,graphic:this._graphic}),this._rotateManipulation=new T.RotateManipulation({tool:this,view:e,graphic:this._rotateGraphic,snapRotation:this._snapRotation}),this._scaleManipulations=this._scaleGraphics.map(((t,i)=>new P.ScaleManipulation({tool:this,view:e,graphic:t,direction:K[i],preserveAspectRatio:this._preserveAspectRatio}))),this.addHandles([this._dragManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),this._rotateManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),...this._scaleManipulations.map((e=>e.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)))),n.watch((()=>this.view.scale),(()=>this.active?this.updateGraphics():null)),e.on("click",(async i=>{if(null!=e.activeTool&&e.activeTool!==this)return;const s=x.createScreenPointFromEvent(i),o=[];e.map.allLayers.forEach((e=>{"vector-tile"!==e.type&&"imagery"!==e.type||o.push(e)}));const a=await this.view.hitTest(s,{exclude:o}),r=a.results;if(0===r.length)e.activeTool=null;else{const i=E.findFirstGraphicHit(a.results),s="georeference"in t,o=r.map((e=>"media"===e.type?e.element:null)).filter(Boolean),n=new Set([...this._graphicsLayer.graphics,s?null:t].filter(Boolean));s&&o.includes(t)||null!=i&&n.has(i.graphic)?null==e.activeTool&&(e.activeTool=this):e.activeTool=null}}))]);const i=e=>{this.addHandles(e.events.on("grab-changed",(e=>{"georeference"in t&&("start"===e.action?t.opacity*=.5:"end"===e.action&&(t.opacity*=2))})))};this._dragManipulation.forEachManipulator(i),this._rotateManipulation.forEachManipulator(i),this._scaleManipulations.forEach((e=>e.forEachManipulator(i))),this.addHandles([e.on("key-down",(i=>{e.activeTool===this&&(i.key!==j.shift||i.repeat||(null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled),null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled),this._isModifierActive=!0,i.stopPropagation()),i.key!==j.toggleOpacity||i.repeat||("georeference"in t&&(t.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled),i.stopPropagation()),i.key!==j.primaryKey||i.repeat||(this._factor=q,i.stopPropagation()),this._isModifierActive&&(i.key===j.plus&&(this._scale(this._factor),i.stopPropagation()),i.key===j.minus&&(this._scale(-this._factor),i.stopPropagation()),i.key===j.up&&(this._move(0,this._factor),i.stopPropagation()),i.key===j.down&&(this._move(0,-this._factor),i.stopPropagation()),i.key===j.left&&(this._move(-this._factor,0),i.stopPropagation()),i.key===j.right&&(this._move(this._factor,0),i.stopPropagation())))})),e.on("key-up",(t=>{e.activeTool===this&&(t.key===j.shift&&(null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled),null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled),this._isModifierActive=!1,t.stopPropagation()),t.key===j.primaryKey&&(this._factor=N,t.stopPropagation()))}))])}async _loadProjectionEngine(){const e=this._graphic.geometry;return f.initializeProjection(e.spatialReference,this.view.spatialReference)}_updateDisplayPlaneConrers(e){const{basis1:t,basis2:i,origin:s}=e,o=this._cornerA;g.add(o,s,t),g.add(o,o,i);const a=this._cornerB;g.add(a,s,t),g.subtract(a,a,i);const r=this._cornerC;g.subtract(r,s,t),g.subtract(r,r,i);const n=this._cornerD;g.subtract(n,s,t),g.add(n,n,i)}_getInfo(){return{editGeometryOperations:this._editGeometryOperations,plane:this._plane,displayPlane:this._displayPlane}}_updateGraphics(e,t){"start"===e.action&&(this._sharedUndoStack.push({tool:this,operation:t}),this._sharedRedoStack.length=0),this.updateGraphics()}_scale(e){const t=this._editGeometryOperations,i=[];for(const r of t.data.components)i.push(...r.vertices);const s=t.data.geometry.extent?.width,o=(s+e*this.view.resolution)/s,a=t.scaleVertices(i,this._plane.origin,y.UNIT_X,o,o,O.AccumulationBehaviour.NEW_STEP,U.AccumulationType.REPLACE);this._sharedUndoStack.push({tool:this,operation:a}),this._sharedRedoStack.length=0,this.updateGraphics()}_move(e,t){const i=this._editGeometryOperations,s=[];for(const a of i.data.components)s.push(...a.vertices);const o=i.moveVertices(s,e*this.view.resolution,t*this.view.resolution,0,O.AccumulationBehaviour.NEW_STEP);this._sharedUndoStack.push({tool:this,operation:o}),this._sharedRedoStack.length=0,this.updateGraphics()}},t.__decorate([l.property()],e.TransformTool.prototype,"_plane",null),t.__decorate([l.property()],e.TransformTool.prototype,"_backgroundGraphicGeometry",null),t.__decorate([l.property()],e.TransformTool.prototype,"_rotateGraphicGeometry",null),t.__decorate([l.property()],e.TransformTool.prototype,"_scaleGraphicGeometries",null),t.__decorate([l.property()],e.TransformTool.prototype,"preserveAspectRatio",void 0),t.__decorate([l.property()],e.TransformTool.prototype,"snapRotation",void 0),t.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.TransformTool.prototype,"target",void 0),t.__decorate([l.property({constructOnly:!0})],e.TransformTool.prototype,"view",void 0),e.TransformTool=t.__decorate([d.subclass("esri.views.2d.interactive.editingTools.TransformTool")],e.TransformTool),e.keys=j,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
