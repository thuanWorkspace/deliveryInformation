/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","./ControlPointsTransformTool","./TransformTool"],(function(o,t,e,r,a,s,i,n,d,l,c){"use strict";const h={redo:"r",undo:"z"};o.MediaTransformToolsWrapper=class extends e{constructor(o){super(o),this._transformTool=null,this._controlPointsTransformTool=null,this._advancedModeTransformTool=null,this._activeTool=null,this._sharedUndoStack=[],this._sharedRedoStack=[],this._originalOpacity=null,this.activeHandle=0}initialize(){const{view:o,mediaElement:t,preserveAspectRatio:e,snapRotation:a,advancedMode:s}=this;this._originalOpacity=t.opacity,this._transformTool=new c.TransformTool({target:t,view:o,preserveAspectRatio:e,snapRotation:a}),this._controlPointsTransformTool=new l.ControlPointsTransformTool({mediaElement:t,view:o}),this._advancedModeTransformTool=new l.ControlPointsTransformTool({mediaElement:s.mediaElement,view:s.view}),this._transformTool.setSharedUndoStack(this._sharedUndoStack),this._transformTool.setSharedRedoStack(this._sharedRedoStack),this._controlPointsTransformTool.setSharedUndoStack(this._sharedUndoStack),this._controlPointsTransformTool.setSharedRedoStack(this._sharedRedoStack),this._advancedModeTransformTool.setSharedUndoStack(this._sharedUndoStack),this._advancedModeTransformTool.setSharedRedoStack(this._sharedRedoStack);const i=t.georeference,n=s.mediaElement.georeference;s.view.tools.addMany([this._advancedModeTransformTool]),"controlPoints"in n&&"controlPoints"in i&&this.addHandles([s.view.on("key-down",(o=>{o.key===h.undo&&this.canUndo()&&(this.undo(),o.stopPropagation()),o.key===h.redo&&this.canRedo()&&(this.redo(),o.stopPropagation())})),s.view.on("focus",(async o=>{this._controlPointsTransformTool.removeHighlightActiveHandle(),this._advancedModeTransformTool.highlightActiveHandle()})),r.watch((()=>n.controlPoints),(o=>{i.controlPoints=o.map((({sourcePoint:o},t)=>({sourcePoint:o,mapPoint:i.controlPoints[t].mapPoint}))),this._activeTool?.refresh()})),r.watch((()=>this._controlPointsTransformTool.activeHandle),(o=>{this._advancedModeTransformTool.updateActiveHandle(o),this.activeHandle=o})),r.watch((()=>this._advancedModeTransformTool.activeHandle),(o=>{this._controlPointsTransformTool.updateActiveHandle(o),this.activeHandle=o}))]),this.addHandles([o.on("key-down",(o=>{o.key===h.undo&&this.canUndo()&&(this.undo(),o.stopPropagation()),o.key===h.redo&&this.canRedo()&&(this.redo(),o.stopPropagation())})),o.on("focus",(async o=>{this._advancedModeTransformTool.removeHighlightActiveHandle(),this._controlPointsTransformTool.highlightActiveHandle()}))]),o.tools.addMany([this._transformTool,this._controlPointsTransformTool]),o.activeTool=this._transformTool,this._activeTool=this._transformTool,o.focus()}destroy(){this._transformTool?.destroy(),this._controlPointsTransformTool?.destroy(),this._transformTool=null,this._controlPointsTransformTool=null,this._advancedModeTransformTool=null,this._activeTool=null,this._sharedUndoStack=null,this._sharedRedoStack=null}canUndo(){return this._sharedUndoStack.length>0}canRedo(){return this._sharedRedoStack.length>0}undo(){if(this._sharedUndoStack.length>0){const{tool:o,operation:t}=this._sharedUndoStack.pop();o!==this._activeTool&&o.refresh(),t.undo(),o.updateGraphics(),this._sharedRedoStack.push({tool:o,operation:t}),this._activeTool!==o&&this._activeTool?.refresh()}}redo(){if(this._sharedRedoStack.length>0){const{tool:o,operation:t}=this._sharedRedoStack.pop();o!==this._activeTool&&o.refresh(),t.apply(),o.updateGraphics(),this._sharedUndoStack.push({tool:o,operation:t}),this._activeTool!==o&&this._activeTool?.refresh()}}refresh(){this._activeTool.refresh()}reset(){this._activeTool.reset(),this._advancedModeTransformTool.reset()}async enableAdvancedMode(){this.view.activeTool=this._controlPointsTransformTool,this._activeTool=this._controlPointsTransformTool,this._activeTool.refresh(),await this.advancedMode.view.when(),this.advancedMode.view.activeTool=this._advancedModeTransformTool,this._originalOpacity=this._controlPointsTransformTool.mediaElement.opacity,this._controlPointsTransformTool.mediaElement.opacity=.25*this._originalOpacity}disableAdvancedMode(){this.view.activeTool=this._transformTool,this._activeTool=this._transformTool,this._activeTool.refresh(),this.advancedMode.view.activeTool=null,this._controlPointsTransformTool.mediaElement.opacity=this._originalOpacity}},t.__decorate([a.property()],o.MediaTransformToolsWrapper.prototype,"activeHandle",void 0),t.__decorate([a.property({constructOnly:!0})],o.MediaTransformToolsWrapper.prototype,"advancedMode",void 0),t.__decorate([a.property()],o.MediaTransformToolsWrapper.prototype,"preserveAspectRatio",void 0),t.__decorate([a.property()],o.MediaTransformToolsWrapper.prototype,"snapRotation",void 0),t.__decorate([a.property({constructOnly:!0,nonNullable:!0})],o.MediaTransformToolsWrapper.prototype,"mediaElement",void 0),t.__decorate([a.property({constructOnly:!0})],o.MediaTransformToolsWrapper.prototype,"view",void 0),o.MediaTransformToolsWrapper=t.__decorate([d.subclass("esri.views.2d.interactive.editingTools.MediaTransformToolsWrapper")],o.MediaTransformToolsWrapper),o.keys=h,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
