/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../geometry/support/aaBoundingRect","./TileCache","./TileCoverage","./TileKey"],(function(e,i,t,s){"use strict";const l=new s(0,0,0,0),a=new Map,h=[],o=[];class c{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,null!=e.resampling&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new i(e.cacheSize,this.tileInfoView,(e=>{this.releaseTile(e)})))}destroy(){this.tileIndex.clear()}update(e){const{resampling:i,tileIndex:s}=this,{scale:c,center:n,resolution:r}=e.state,{minScale:f,maxScale:d}=this.tileInfoView,u=!e.stationary&&c>this._previousScale;if(this._previousScale=c,!i&&(c>f||c<d))return this.tiles.length=0,void this.clear();const y=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!y)return this.tiles.length=0,void this.clear();const{spans:p,lodInfo:g}=y,{level:I}=g;this.tiles.length=0,s.forEach((e=>e.visible=!0));let v=0,T=0;if(p.length>0)for(const{row:t,colFrom:h,colTo:o}of p)for(let e=h;e<=o;e++){v++;const i=l.set(I,t,g.normalizeCol(e),g.getWorldForColumn(e)).id;let h=s.get(i);if(h)h.isReady?(a.set(i,h),T++):u||this._addParentTile(i,a);else{if(this._tileCache?.has(i)){if(h=this._tileCache.pop(i),this.tileIndex.set(i,h),h.isReady){a.set(i,h),T++;continue}}else h=this.acquireTile(l),this.tileIndex.set(i,h);u||this._addParentTile(i,a)}}const _=T===v;for(const[t,C]of s){if(a.has(t))continue;l.set(t);const e=this.tileInfoView.intersects(y,l),i="purge"===this.cachePolicy?l.level!==I:l.level>I;!e||!u&&_?!i&&e||h.push(C):C.isReady?i&&"purge"===this.cachePolicy&&this._hasReadyAncestor(l,I)?h.push(C):o.push(C):i&&h.push(C)}for(const t of o)t.isReady&&a.set(t.key.id,t);for(const t of h)this._tileCache?this._tileCache.add(t):this.releaseTile(t),s.delete(t.key.id);for(const t of a.values())this.tiles.push(t);for(const t of s.values())a.has(t.key.id)||(t.visible=!1);this._tileCache?.prune(I,n,r),t.pool.release(y),o.length=0,h.length=0,a.clear()}clear(){const{tileIndex:e}=this;for(const i of e.values())this.releaseTile(i);e.clear()}refresh(e){for(const i of this.tileIndex.values())this.tiles.includes(i)?e(i):h.push(i);for(const i of h)this.releaseTile(i),this.tileIndex.delete(i.key.id);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,i){let t=e,s=null;for(;t=this.tileInfoView.getTileParentId(t),t;)if(this.tileIndex.has(t)){if(s=this.tileIndex.get(t),s?.isReady){i.has(s.key.id)||i.set(s.key.id,s);break}}else if(this._tileCache?.has(t)&&(s=this._tileCache.pop(t),this.tileIndex.set(t,s),s?.isReady)){i.has(s.key.id)||i.set(s.key.id,s);break}}_hasReadyAncestor(i,t){const s=e.create();this.tileInfoView.getTileBounds(s,i,!0);for(const l of this.tileIndex.values())if(l.isReady&&l.key.level>=t&&l.key.level<i.level){const i=e.create();if(this.tileInfoView.getTileBounds(i,l.key,!0),e.contains(i,s))return!0}return!1}}return c}));
