/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../Graphic","../../../core/arrayUtils","../../../core/iteratorUtils","../../support/screenUtils"],(function(e,t,r,i,a){"use strict";async function l(e,t,i){const l=a.isSupportedScreenPointEvent(t)?a.createScreenPointFromSupportedEvent(e,t):t;if(!e.ready||isNaN(l.x)||isNaN(l.y))return{screenPoint:l,results:[]};let d=new Set;const p=new Set;let u=!1,y=null,f=null;i?.include?n(i.include,s(e,(e=>{d.add(e),o(e,(e=>p.add(e)))}),((e,t)=>{p.add(e),d.add(t)}),(e=>{y||(y=new Set),y.add(e)}),(e=>d.add(e)),(()=>u=!0))):(u=!0,d=new Set(e.allLayerViews),d.forEach((e=>{o(e,(e=>p.add(e)))}))),i?.exclude&&n(i.exclude,s(e,(e=>{d.delete(e),o(e,(e=>p.delete(e)))}),(e=>p.delete(e)),(e=>{f||(f=new Set),f.add(e)})));const h=e.allLayerViews.filter((e=>!e.suspended&&d.has(e))).reverse(),g=e.toMap(l);let w=[...u?e.graphicsView.hitTest(g).map((e=>({type:"graphic",graphic:e,layer:null,mapPoint:g}))):[],...await Promise.all(h.map((e=>e.hitTest(g,l))).toArray())].filter(r.isSome).flat().filter(r.isSome);return w=w.filter((e=>"graphic"!==e.type||"subtype-group"!==e.layer?.type||p.has(e.graphic.layer))),y&&(w=w.filter((e=>!("graphic"in e)||!e.graphic||y?.has(c(e.graphic))))),f&&(w=w.filter((e=>!("graphic"in e)||!e.graphic||!f?.has(c(e.graphic))))),{screenPoint:l,results:w}}function s(e,r,i,a,l,s){return n=>{if(n instanceof t){if(n.layer===e)s?.();else{const t=e.allLayerViews.find((e=>e.layer===n.layer));t&&l?.(t)}a(c(n))}else if("subtype-sublayer"===n.type){const t=e.allLayerViews.find((e=>e.layer===n.parent));t&&i(n,t)}else{const t=e.allLayerViews.find((e=>e.layer===n));t&&r(t)}}}function n(e,t){if(e)if(i.isIterable(e))for(const r of e)if(i.isIterable(r))for(const e of r)t(e);else t(r);else t(e)}function c(e){const t=e.getObjectId();return t?`${e.layer?.uid??e.sourceLayer?.uid??"MapView"}/${t}`:`"MapView/${e.uid}`}function o({layer:e},t){"subtype-group"===e.type&&e.sublayers.forEach((e=>{t(e)}))}e.hitTest=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
