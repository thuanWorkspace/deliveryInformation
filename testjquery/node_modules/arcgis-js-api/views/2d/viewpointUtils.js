/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Viewpoint","../../core/Collection","../../core/unitUtils","../../chunks/common","../../chunks/mat2d","../../chunks/mat2df64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/normalizeUtils","../../geometry/support/spatialReferenceUtils"],(function(e,t,n,r,a,o,c,i,s,l,u,f,y,m,g,p){"use strict";const d=96,x=39.37,h=180/Math.PI;function b(e){return e.wkid?e:e.spatialReference||m.WGS84}function w(e,t){return t.type?i.set(e,t.x,t.y):i.copy(e,t)}function R(e){return r.getMetersPerUnitForSR(e)}function G(e,t){const n=Math.max(1,t[0]),r=Math.max(1,t[1]);return Math.max(e.width/n,e.height/r)*q(e.spatialReference)}async function S(e,t,r,a){let o,c;if(!e)return null;if(Array.isArray(e)&&!e.length)return null;if(n.isCollection(e)&&(e=e.toArray()),Array.isArray(e)&&e.length&&"object"==typeof e[0]){const n=e.every((e=>"attributes"in e)),o=e.some((e=>!e.geometry));let c=e;if(n&&o&&t&&t.allLayerViews){const n=new Map;for(const t of e){const e=t.layer,r=n.get(e)||[],a=t.attributes[e.objectIdField];null!=a&&r.push(a),n.set(e,r)}const r=[];n.forEach(((e,n)=>{const a=t.allLayerViews.find((e=>e.layer.id===n.id));if(a&&"queryFeatures"in a){const t=n.createQuery();t.objectIds=e,t.returnGeometry=!0,r.push(a.queryFeatures(t))}}));const a=await Promise.all(r),o=[];for(const e of a)if(e&&e.features&&e.features.length)for(const t of e.features)null!=t.geometry&&o.push(t.geometry);c=o}for(const e of c)a=await S(e,t,r,a);return a}if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])o=new f(e);else if(e instanceof u)o=e;else if("geometry"in e)if(e.geometry)o=e.geometry;else if(e.layer){const n=e.layer,r=t.allLayerViews.find((e=>e.layer.id===n.id));if(r&&"queryFeatures"in r){const t=n.createQuery();t.objectIds=[e.attributes[n.objectIdField]],t.returnGeometry=!0;const a=await r.queryFeatures(t);o=a?.features?.[0]?.geometry}}if(null==o)return null;switch(o.type){case"point":c=new l({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":c=g.getDenormalizedExtent(o);break;default:c=o.extent}if(!c)return null;y.isLoaded()||y.canProjectWithoutEngine(c.spatialReference,r)||await y.load();const i=y.project(c,r);return i?a=a?a.union(i):i:null}function A(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&null!=e.layer?.minScale&&null!=e.layer.maxScale){const t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every((e=>"layer"in e))){let t=0,n=0;for(const r of e){const e=r.layer;e?.minScale&&e.maxScale&&(t=e.minScale<t?e.minScale:t,n=e.maxScale>n?e.maxScale:n)}return t&&n?{min:t,max:n}:null}}}function k(e,t){return p.equals(b(e),t)?e:y.project(e,t)}async function M(e,n){if(!e||!n)return new t({targetGeometry:new f,scale:0,rotation:0});let r=n.spatialReference;const{constraints:a,padding:o,viewpoint:c,size:i}=n,s=[o?i[0]-o.left-o.right:i[0],o?i[1]-o.top-o.bottom:i[1]];let u=null;e instanceof t?u=e:e.viewpoint?u=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(u=e.target);let m=null;u?.targetGeometry?m=u.targetGeometry:e instanceof l?m=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(m=await S(e.center,n,r)||await S(e.extent,n,r)||await S(e.target,n,r)||await S(e,n,r)),!m&&c?.targetGeometry?m=c.targetGeometry:!m&&n.extent&&(m=n.extent),r||(r=b(n.spatialReference||n.extent||m)),y.isLoaded()||p.equals(m.spatialReference,r)||y.canProjectWithoutEngine(m.spatialReference,r)||await y.load();const d=k("center"in m?m.center:m,r);!1!==n.pickClosestTarget&&"point"===d.type&&"point"===c.targetGeometry?.type&&(d.x=g.getClosestDenormalizedXToReference(d.x,c.targetGeometry.x,d.spatialReference));let x=0;if(null!=u?.targetGeometry&&"point"===u.targetGeometry.type)x=u.scale;else if("scale"in e&&e.scale)x=e.scale;else if("zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs)x=a.zoomToScale(e.zoom);else if(Array.isArray(m)||"point"===m.type||"extent"===m.type&&0===m.width&&0===m.height){const e=k(n.extent,r);x=null!=e?G(e,s):n.extent?G(n.extent,s):c.scale}else x=G(k(m.extent,r),s);const h=A(e.target??e);h&&(h.min&&h.min<x?x=h.min:h.max&&h.max>x&&(x=h.max));let w=0;u?w=u.rotation:e.hasOwnProperty("rotation")?w=e.rotation:c&&(w=c.rotation);let R=new t({targetGeometry:d,scale:x,rotation:w});return a&&(R=a.fit(R),a.constrainByGeometry(R),a.rotationEnabled||(R.rotation=c.rotation)),R}function j(e,t){const n=e.targetGeometry,r=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function T(e,t,n){return n?i.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)):i.scale(e,t,.5)}const v=function(){const e=s.create();return function(t,n,r){const a=n.targetGeometry;w(e,a);const o=.5*V(n);return t.xmin=e[0]-o*r[0],t.ymin=e[1]-o*r[1],t.xmax=e[0]+o*r[0],t.ymax=e[1]+o*r[1],t.spatialReference=a.spatialReference,t}}();function z(e,t,n,r,a){return X(e,t,n.center),e.scale=G(n,r),a?.constraints?.constrain(e),e}function P(e,t,n,r){return L(e,t,n,r),o.invert(e,e)}const E=function(){const e=s.create();return function(t,n,r){return i.sub(t,B(t,n),T(e,n,r))}}(),F=function(){const e=c.create(),t=s.create();return function(n,r,a,c){const s=V(r),l=W(r);return i.set(t,s,s),o.fromScaling(e,t),o.rotate(e,e,l),o.translate(e,e,E(t,a,c)),o.translate(e,e,[0,c.top-c.bottom]),i.set(n,e[4],e[5])}}();function V(e){return e.scale*N(e.targetGeometry)}function N(e){return null!=e&&p.isValid(e.spatialReference)?1/(R(e.spatialReference)*x*d):1}function W(e){return a.toRadian(e.rotation)||0}function q(e){return p.isValid(e)?R(e)*x*d:1}function B(e,t){return i.scale(e,t,.5)}const I=function(){const e=s.create(),t=s.create(),n=s.create();return function(r,a,c,s,l,u){return i.negate(e,a),i.scale(t,c,.5*u),i.set(n,1/s*u,-1/s*u),o.fromTranslation(r,t),l&&o.rotate(r,r,l),o.scale(r,r,n),o.translate(r,r,e),r}}(),L=function(){const e=s.create();return function(t,n,r,a){const o=V(n),c=W(n);return w(e,n.targetGeometry),I(t,e,r,o,c,a)}}(),C=function(){const e=s.create();return function(t,n,r,a){const o=V(n);return w(e,n.targetGeometry),I(t,e,r,o,0,a)}}();function U(e){const t=p.getInfo(e);return t?t.valid[1]-t.valid[0]:0}function D(e,t){return Math.round(U(e)/t)}const O=function(){const e=s.create(),t=s.create(),n=[0,0,0];return function(r,a,o){i.subtract(e,r,a),i.normalize(e,e),i.subtract(t,r,o),i.normalize(t,t),i.cross(n,e,t);let c=Math.acos(i.dot(e,t)/(i.length(e)*i.length(t)))*h;return n[2]<0&&(c=-c),isNaN(c)&&(c=0),c}}(),Q=function(){const e=s.create();return function(t,n,r,a){const o=t.targetGeometry;return j(t,n),F(e,n,r,a),o.x+=e[0],o.y+=e[1],t}}(),X=function(e,t,n){j(e,t);const r=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e},H=function(){const e=s.create();return function(t,n,r,a,o){o||(o="center"),i.sub(e,r,a),i.scale(e,e,.5);const c=e[0],s=e[1];switch(o){case"center":i.set(e,0,0);break;case"left":i.set(e,-c,0);break;case"top":i.set(e,0,s);break;case"right":i.set(e,c,0);break;case"bottom":i.set(e,0,-s);break;case"top-left":i.set(e,-c,s);break;case"bottom-left":i.set(e,-c,-s);break;case"top-right":i.set(e,c,s);break;case"bottom-right":i.set(e,c,-s)}return ne(t,n,e),t}}();function J(e,t,n){return j(e,t),e.rotation+=n,e}function K(e,t,n){return j(e,t),e.rotation=n,e}const Y=function(){const e=s.create();return function(t,n,r,a,o){return j(t,n),isNaN(r)||0===r||(ee(e,a,n,o),t.scale=n.scale*r,te(e,e,t,o),ne(t,t,i.set(e,e[0]-a[0],a[1]-e[1]))),t}}();function Z(e,t,n){return j(e,t),e.scale=n,e}const $=function(){const e=s.create();return function(t,n,r,a,o,c){return j(t,n),isNaN(r)||0===r||(ee(e,o,n,c),t.scale=n.scale*r,t.rotation+=a,te(e,e,t,c),ne(t,t,i.set(e,e[0]-o[0],o[1]-e[1]))),t}}(),_=function(){const e=s.create(),t=s.create();return function(n,r,a,o,c,s,l){return E(t,s,l),i.add(e,c,t),o?$(n,r,a,o,e,s):Y(n,r,a,e,s)}}(),ee=function(){const e=c.create();return function(t,n,r,a){return i.transformMat2d(t,n,P(e,r,a,1))}}(),te=function(){const e=c.create();return function(t,n,r,a){return i.transformMat2d(t,n,L(e,r,a,1))}}(),ne=function(){const e=s.create(),t=c.create();return function(n,r,a){j(n,r);const c=V(r),l=n.targetGeometry;return o.fromRotation(t,W(r)),o.scale(t,t,s.fromValues(c,c)),i.transformMat2d(e,a,t),l.x+=e[0],l.y+=e[1],n}}();e.addPadding=Q,e.angleBetween=O,e.centerAt=X,e.copy=j,e.create=M,e.extentToScale=G,e.getAnchor=T,e.getExtent=v,e.getMatrix=I,e.getPaddingMapTranslation=F,e.getPaddingScreenTranslation=E,e.getResolution=V,e.getResolutionToScaleFactor=q,e.getTransform=L,e.getTransformNoRotation=C,e.getWorldScreenWidth=D,e.getWorldWidth=U,e.padAndScaleAndRotateBy=_,e.resize=H,e.rotateBy=J,e.rotateTo=K,e.scaleAndRotateBy=$,e.scaleTo=Z,e.setExtent=z,e.toMap=ee,e.toScreen=te,e.translateBy=ne,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
