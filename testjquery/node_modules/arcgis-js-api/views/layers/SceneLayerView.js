/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../../chunks/tslib.es6","../../core/arrayUtils","../../core/Logger","../../core/maybe","../../core/maybeUpdating","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/projection","./LayerView"],(function(e,r,t,o,n,i,l,a,s,c,p,y,u,d){"use strict";const m="esri.views.layers.SceneLayerView",g=o.getLogger(m);let h=class extends d{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return i.unwrapUpdating(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(null==e||e.geometries.length<1)return null;const r=this._geometryEngine;if(null==r||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return i.updating;const o=e.geometries.at(0).spatialReference,n=e.geometries.toArray().map((e=>{try{e=r.simplify(e)}catch(t){return g.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(o))return e;try{return u.project(e,o)}catch(t){return g.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}})).filter(t.isSome).sort(((e,r)=>e.extent.xmin-r.extent.xmin)),l=new Set,a=new Array,s=new Array;for(let t of n){const e=t.extent.xmin;if(a.length=0,l.forEach((o=>{if(e>=o.extent.xmax)return s.push(o),void l.delete(o);t.extent.ymin<=o.extent.ymax&&t.extent.ymax>=o.extent.ymin&&r.intersects(t,o)&&a.push(o)})),a.length>0){a.push(t);try{t=r.union(a)}catch(c){g.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}a.pop(),a.forEach((e=>l.delete(e)))}l.add(t)}return l.forEach((e=>s.push(e))),s.length>0?{spatialRelationship:e.spatialRelationship,geometries:s}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(null==e||e.geometries.length<=1)return!1;const r=e.geometries.at(0).spatialReference;return e.geometries.some((({spatialReference:e})=>!e.equals(r)&&!u.canProjectWithoutEngine(e,r)))}get layerFilterUpdating(){return i.isUpdating(this._layerFilter)}initialize(){const{signal:r}=this._abortController;a.whenOnce((()=>this.destroyed||!this._geometryEngine&&this.layer?.filter?.geometries?.length),r).then((async()=>{l.throwIfAbortError(r),this._geometryEngine=await new Promise(((r,t)=>e(["../../geometry/geometryEngine"],r,t)))})).catch(l.throwIfNotAbortError),this._projectionEngineLoaded=u.isLoaded(),a.whenOnce((()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine),r).then((async()=>{l.throwIfAbortError(r),await u.load(),this._projectionEngineLoaded=!0})).catch(l.throwIfNotAbortError)}destroy(){this._abortController=n.abortMaybe(this._abortController)}highlight(e){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}};r.__decorate([s.property()],h.prototype,"layer",void 0),r.__decorate([s.property()],h.prototype,"availableFields",null),r.__decorate([s.property()],h.prototype,"maximumNumberOfFeatures",null),r.__decorate([s.property({readOnly:!0})],h.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([s.property()],h.prototype,"filter",void 0),r.__decorate([s.property({readOnly:!0})],h.prototype,"layerFilter",null),r.__decorate([s.property({readOnly:!0})],h.prototype,"_layerFilter",null),r.__decorate([s.property()],h.prototype,"_geometryEngine",void 0),r.__decorate([s.property()],h.prototype,"_projectionEngineLoaded",void 0),r.__decorate([s.property()],h.prototype,"_filterNeedsProjectionEngine",null),r.__decorate([s.property()],h.prototype,"layerFilterUpdating",null),h=r.__decorate([y.subclass(m)],h);return h}));
