/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../Graphic","../../core/Error","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/rasterFunctions/rasterProjectionHelper","./support/popupUtils"],(function(e,t,r,a,o,s,i,n,l,p,u){"use strict";const c=o=>{let s=class extends o{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return p.projectDatasetExtent(this.layer.rasterInfo,this.view.spatialReference)}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return p.getDefaultDatumTransformationForDataset(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(e){return!!p.projectDatasetExtent(this.layer.rasterInfo,e)}async fetchPopupFeatures(e,a){const{layer:o}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:o});const{popupEnabled:s}=o,i=u.getFetchPopupTemplate(o,a);if(!s||null==i)throw new r("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:s,popupTemplate:i});const n=[],{value:l,magdirValue:p,processedValue:c}=await o.identify(e,{timeExtent:this.timeExtent});let y="";if(l&&l.length){y="imagery-tile"===o.type&&o.hasStandardTime()&&null!=l[0]?l.map((e=>o.getStandardTimeValue(e))).join(", "):l.join(", ");const e={ObjectId:0},r="Raster.ServicePixelValue";e[r]=c?.join(", ")??y,e[r+".Raw"]=y;const a=o.rasterInfo.attributeTable;if(null!=a){const{fields:t,features:r}=a,o=t.find((({name:e})=>"value"===e.toLowerCase())),s=o?r.find((e=>String(e.attributes[o.name])===y)):null;if(s)for(const a in s.attributes)if(s.attributes.hasOwnProperty(a)){e[this._rasterFieldPrefix+a]=s.attributes[a]}}const s=o.rasterInfo.dataType;"vector-magdir"!==s&&"vector-uv"!==s||(e["Raster.Magnitude"]=p?.[0],e["Raster.Direction"]=p?.[1]);const i=new t(this.fullExtent.clone(),null,e);i.layer=o,i.sourceLayer=i.layer,n.push(i)}return n}};return e.__decorate([a.property()],s.prototype,"layer",void 0),e.__decorate([a.property(l.combinedViewLayerTimeExtentProperty)],s.prototype,"timeExtent",void 0),e.__decorate([a.property()],s.prototype,"view",void 0),e.__decorate([a.property()],s.prototype,"fullExtent",null),e.__decorate([a.property()],s.prototype,"tileInfo",void 0),e.__decorate([a.property({readOnly:!0})],s.prototype,"hasTilingEffects",null),e.__decorate([a.property()],s.prototype,"datumTransformation",null),s=e.__decorate([n.subclass("esri.views.layers.ImageryTileLayerView")],s),s};return c}));
