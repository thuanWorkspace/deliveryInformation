/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Error","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/fieldUtils","../../layers/support/floorFilterUtils","../../rest/support/Query","../../support/arcadeOnDemand","./support/popupUtils"],(function(e,t,r,i,l,o,s,n,a,u,d,p,c,f,y,h,m){"use strict";const F="esri.views.layers.FeatureLayerView",g=r.getLogger(F);return r=>{let o=class extends r{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([i.watch((()=>{const e=this.layer;return[e?.elevationInfo?.featureExpressionInfo,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),i.syncAndInitial),i.on((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),i.on((()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null}),"change",(()=>this._handleRequiredFieldsChange()))])}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?c.fixFields(t,[...c.unpackFieldNames(t,e.outFields),...r]):c.fixFields(t,r)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){g.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new y(e);if("feature"===this.layer.type){const e=f.getFloorFilterClause(this);null!=e&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new y(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeatures(e,t){const r=this.validateFetchPopupFeatures(t);if(r)throw r;return this.fetchClientPopupFeatures(t)}_loadArcadeModules(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?h.loadArcade():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:i}}=this,l="renderer"in t&&t.renderer,o="orderBy"in t&&t.orderBy,s="featureReduction"in t?t.featureReduction:null,n=new Set,a=await Promise.allSettled([l?l.collectRequiredFields(n,r):null,c.collectLabelingFields(n,t),e?c.collectElevationFields(n,t):null,null!=this.filter?c.collectFilterFields(n,t,this.filter):null,null!=this.featureEffect?c.collectFilterFields(n,t,this.featureEffect.filter):null,s?c.collectFeatureReductionFields(n,t,s):null,o?c.collectOrderByInfos(n,t,o):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&c.collectFields(n,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&(t.floorInfo&&c.collectFields(n,t.fieldsIndex,[t.floorInfo.floorField]),e&&null!=t.infoFor3D&&(null==t.globalIdField&&g.error("globalIdField missing on 3DObjectFeatureLayer"),c.collectFields(n,t.fieldsIndex,[t.globalIdField]))),"subtype-group"===t.type){c.collectField(n,r,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(n,r),c.collectLabelingFields(n,e)])));await Promise.allSettled(e)}for(const d of a)"rejected"===d.status&&g.error(d.reason);c.collectField(n,r,i),e&&"displayField"in t&&t.displayField&&c.collectField(n,r,t.displayField);const u=Array.from(n).sort();this._set("requiredFields",u)}validateFetchPopupFeatures(e){if(null==e)return null;for(const r of e.clientGraphics??[]){const i=r.layer;if("popupEnabled"in i&&!i.popupEnabled)return new t("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if(r.isAggregate){const e="featureReduction"in i?i.featureReduction:null;if(!(e&&"popupTemplate"in e&&e.popupEnabled&&e.popupTemplate))return new t("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i})}else if("popupTemplate"in i){if(!m.getFetchPopupTemplate(i,e))return new t("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}}async fetchClientPopupFeatures(e){const t=null!=e?e.clientGraphics:null;if(!t||0===t.length)return[];const r=new Array(t.length),i=new Map,l=await this.createPopupQuery(e);for(let o=0;o<t.length;o++){const s=t[o];if(s.isAggregate){r[o]=s;continue}const n=s.layer;if(!("popupEnabled"in n))continue;const a=c.unpackFieldNames(this.layer.fieldsIndex,l.outFields),u=m.getFetchPopupTemplate(n,e);if(null==u)continue;const d=await this._loadArcadeModules(u);d&&d.arcadeUtils.hasGeometryOperations(u)||!c.featureHasFields(a,s)?i.set(s.getObjectId(),{graphic:s,index:o}):r[o]=s}if("stream"===this.layer.type||0===i.size)return r.filter(Boolean);l.objectIds=Array.from(i.keys());try{const e=await this.layer.queryFeatures(l);for(const t of e.features){const{graphic:{geometry:e},index:l}=i.get(t.getObjectId());t.geometry||(t.geometry=e),r[l]=t}}catch{}return r.filter(Boolean)}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let i=!1;const l=e?.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const o of l){if(!("popupEnabled"in o))continue;const t=m.getFetchPopupTemplate(o,e);if(null==t)continue;const l=await this._loadArcadeModules(t),s=l&&l.arcadeUtils.hasGeometryOperations(t);i=!("point"!==this.layer.geometryType&&!s);const n=await m.getRequiredFields(this.layer,t);for(const e of n)r.add(e)}if(t.returnGeometry=i,t.returnZ=i,t.returnM=i,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=f.getFloorFilterClause(this);null!=e&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}canResume(){return!!super.canResume()&&(null==this.timeExtent||!this.timeExtent.isEmpty)}};return e.__decorate([l.property()],o.prototype,"_updatingRequiredFieldsPromise",void 0),e.__decorate([l.property({readOnly:!0})],o.prototype,"availableFields",null),e.__decorate([l.property({readOnly:!0})],o.prototype,"dataUpdating",void 0),e.__decorate([l.property({type:d})],o.prototype,"featureEffect",null),e.__decorate([l.property({type:p})],o.prototype,"filter",void 0),e.__decorate([l.property(u.combinedViewLayerTimeExtentProperty)],o.prototype,"timeExtent",void 0),e.__decorate([l.property()],o.prototype,"layer",void 0),e.__decorate([l.property({type:Number})],o.prototype,"maximumNumberOfFeatures",null),e.__decorate([l.property({readOnly:!0,type:Boolean})],o.prototype,"maximumNumberOfFeaturesExceeded",null),e.__decorate([l.property({readOnly:!0})],o.prototype,"requiredFields",void 0),e.__decorate([l.property()],o.prototype,"suspended",void 0),e.__decorate([l.property()],o.prototype,"view",void 0),o=e.__decorate([a.subclass(F)],o),o}}));
