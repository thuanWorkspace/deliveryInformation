/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../Color","../geometry","../Viewpoint","../core/Accessor","../core/Evented","../core/Promise","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../layers/support/ExtentAndRotationGeoreference","../layers/support/MediaElementView","../layers/support/VideoElement","./DOMContainer","./2d/viewpointUtils","./2d/ViewStateManager","./2d/engine/webgl/Overlay","./2d/engine/webgl/OverlayContainer","../geometry/SpatialReference","../geometry/Extent"],(function(e,t,i,r,s,a,n,o,d,l,h,c,p,y,w,g,u,m,v,_,V,f,M,E){"use strict";const C=new i("#000");let b;async function x(){const[,{Stage:t}]=await Promise.all([new Promise(((t,i)=>e(["./2d/webglDeps"],t,i))),new Promise(((t,i)=>e(["./2d/mapViewDeps"],t,i)))]);b=t}function O(e,t){const[i,r]=e,[s,a]=t,n=s/a,o=r*n,d=i/n;return i/r>=1?n>=1?o<=i?[o,r]:[i,d]:d<=r?[i,d]:[o,r]:n>=1?d<=r?[i,d]:[o,r]:o<=i?[o,r]:[i,d]}function R(e,t){const i=e&&v.extentToScale(e,t);return new s({targetGeometry:e.center,scale:i})}function H(e){return new E({xmin:0,ymin:0,xmax:e[0],ymax:e[1],spatialReference:{wkid:0}})}let P=class extends a{};P=t.__decorate([y.subclass("Base")],P);let S=class extends(m.DOMContainer(n.EventedMixin(o.EsriPromiseMixin(P)))){constructor(e){super(e),this.stateManager=new _.ViewStateManager,this._isValid=!1,this.layer=null,this.ready=!1,this.addHandles([d.watch((()=>this.preconditionsReady),(e=>{e?this._startup():this._teardown()})),d.watch((()=>this.layer),(()=>this.addResolvingPromise(d.whenOnce((()=>this.ready)))),d.initial)])}initialize(){this.addResolvingPromise(Promise.all([x()]).then((()=>(this._isValid=!0,d.whenOnce((()=>this.ready))))))}destroy(){this._teardown()}get state(){return this.stateManager.state}get preconditionsReady(){return!(!this._isValid||0===this.width||0===this.height||0===this.videoWidth||0===this.videoHeight)}get videoHeight(){return this.layer?.videoHeight||0}get videoWidth(){return this.layer?.videoWidth||0}_startup(){if(!this.layer)return;const e=O(this.size,[this.videoWidth,this.videoHeight]),t=H(e),i=R(t,e);this._mediaElementView=new g.MediaElementView({element:new u({video:this.layer.videoElement,georeference:new w({extent:t}),autoplay:!1}),spatialReference:new M({wkid:0})}),this.stateManager.startup(i,this.size,i.targetGeometry.spatialReference);const r=new b(this.surface,{renderingOptions:{samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},backgroundColor:C});this.stage=r,this.addHandles([d.watch((()=>this.state.id),(()=>r.state=this.state),d.syncAndInitial),this.on("resize",(({width:e,height:t})=>{if(this._mediaElementView){const i=O([e,t],[this.videoWidth,this.videoHeight]),r=H(i);this._mediaElementView.element.georeference=new w({extent:r}),this.stateManager.viewpoint=R(r,i),this.stateManager.resize(e,t)}}))],"video-view");const s=new V(this._mediaElementView);this.overlayContainer=new f,this.overlayContainer.addChild(s),this.stage.addChild(this.overlayContainer),this._set("ready",!0)}_teardown(){this.stage.destroy(),this.stage=null,this._mediaElementView=null,this.overlayContainer.removeAllChildren(),this.overlayContainer=null,this.removeHandles("video-view"),this._set("ready",!1),this.stateManager.teardown()}};t.__decorate([l.property()],S.prototype,"stateManager",void 0),t.__decorate([l.property({readOnly:!0})],S.prototype,"state",null),t.__decorate([l.property()],S.prototype,"_isValid",void 0),t.__decorate([l.property()],S.prototype,"layer",void 0),t.__decorate([l.property({readOnly:!0})],S.prototype,"preconditionsReady",null),t.__decorate([l.property({readOnly:!0})],S.prototype,"ready",void 0),t.__decorate([l.property({readOnly:!0})],S.prototype,"videoHeight",null),t.__decorate([l.property({readOnly:!0})],S.prototype,"videoWidth",null),S=t.__decorate([y.subclass("esri.views.VideoView")],S);return S}));
