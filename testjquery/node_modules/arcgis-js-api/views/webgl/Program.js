/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/arrayUtils","../../core/has","./checkWebGLError","./contextUtils","./enums","./ShaderTranspiler"],(function(t,e,o,i,n,r,s){"use strict";const a=4294967295;class h{constructor(t,e,o,h,f=new Map){this._context=t,this._locations=h,this._uniformBlockBindings=f,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,t||console.error("RenderingContext isn't initialized!"),0===e.length&&console.error("Shaders source should not be empty!"),this._context.type===n.ContextType.WEBGL2&&(e=s.transpileShader(e,r.ShaderType.VERTEX_SHADER),o=s.transpileShader(o,r.ShaderType.FRAGMENT_SHADER)),this._vShader=m(this._context,r.ShaderType.VERTEX_SHADER,e),this._fShader=m(this._context,r.ShaderType.FRAGMENT_SHADER,o),l.enabled&&(this._linesOfCode=e.match(/\n/g).length+o.match(/\n/g).length+2,this._context.instanceCounter.increment(r.ResourceType.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(r.ResourceType.Shader,this),i.webglValidateShadersEnabled()&&(this.vertexShader=e,this.fragmentShader=o);const c=this._context.gl,_=c.createProgram();if(c.attachShader(_,this._vShader),c.attachShader(_,this._fShader),this._locations.forEach(((t,e)=>c.bindAttribLocation(_,t,e))),c.linkProgram(_),i.webglValidateShadersEnabled()&&!c.getProgramParameter(_,c.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${c.getProgramParameter(_,c.VALIDATE_STATUS)}, gl error ${c.getError()}, vertex: ${c.getShaderParameter(this._vShader,c.COMPILE_STATUS)}, fragment: ${c.getShaderParameter(this._fShader,c.COMPILE_STATUS)}, info log: ${c.getProgramInfoLog(_)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===n.ContextType.WEBGL2){const t=c;for(const[e,o]of this._uniformBlockBindings){const i=t.getUniformBlockIndex(_,e);i<a&&t.uniformBlockBinding(_,i,o)}}this._glName=_,this._context.instanceCounter.increment(r.ResourceType.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get compiled(){if(this._compiled)return!0;const t=this._context.gl.getExtension("KHR_parallel_shader_compile");return null==t||null==this.glName?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,t.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const t=this._context.gl,e=this._context.instanceCounter;this._nameToUniformLocation.forEach((t=>t&&e.decrement(r.ResourceType.Uniform,t))),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(e.decrement(r.ResourceType.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),t.deleteShader(this._vShader),this._vShader=null,e.decrement(r.ResourceType.Shader,this)),this._fShader&&(t.deleteShader(this._fShader),this._fShader=null),this._glName&&(t.deleteProgram(this._glName),this._glName=null,e.decrement(r.ResourceType.Program,this))}ref(){++this._refCount}_getUniformLocation(t){const e=this._nameToUniformLocation.get(t);if(void 0!==e)return e;if(this.glName){const e=this._context.gl.getUniformLocation(this.glName,t);return this._nameToUniformLocation.set(t,e),e&&this._context.instanceCounter.increment(r.ResourceType.Uniform,e),e}return null}hasUniform(t){return null!=this._getUniformLocation(t)}setUniform1i(t,e){const o=this._nameToUniform1.get(t);void 0!==o&&e===o||(this._context.gl.uniform1i(this._getUniformLocation(t),e),this._nameToUniform1.set(t,e))}setUniform1iv(t,e){_(this._nameToUniform1v,t,e)&&this._context.gl.uniform1iv(this._getUniformLocation(t),e)}setUniform2iv(t,e){_(this._nameToUniform2,t,e)&&this._context.gl.uniform2iv(this._getUniformLocation(t),e)}setUniform3iv(t,e){_(this._nameToUniform3,t,e)&&this._context.gl.uniform3iv(this._getUniformLocation(t),e)}setUniform4iv(t,e){_(this._nameToUniform4,t,e)&&this._context.gl.uniform4iv(this._getUniformLocation(t),e)}setUniform1f(t,e){const o=this._nameToUniform1.get(t);void 0!==o&&e===o||(this._context.gl.uniform1f(this._getUniformLocation(t),e),this._nameToUniform1.set(t,e))}setUniform1fv(t,e){_(this._nameToUniform1v,t,e)&&this._context.gl.uniform1fv(this._getUniformLocation(t),e)}setUniform2f(t,e,o){const i=this._nameToUniform2.get(t);void 0===i?(this._context.gl.uniform2f(this._getUniformLocation(t),e,o),this._nameToUniform2.set(t,[e,o])):e===i[0]&&o===i[1]||(this._context.gl.uniform2f(this._getUniformLocation(t),e,o),i[0]=e,i[1]=o)}setUniform2fv(t,e){_(this._nameToUniform2,t,e)&&this._context.gl.uniform2fv(this._getUniformLocation(t),e)}setUniform3f(t,e,o,i){const n=this._nameToUniform3.get(t);void 0===n?(this._context.gl.uniform3f(this._getUniformLocation(t),e,o,i),this._nameToUniform3.set(t,[e,o,i])):e===n[0]&&o===n[1]&&i===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(t),e,o,i),n[0]=e,n[1]=o,n[2]=i)}setUniform3fv(t,e){_(this._nameToUniform3,t,e)&&this._context.gl.uniform3fv(this._getUniformLocation(t),e)}setUniform4f(t,e,o,i,n){const r=this._nameToUniform4.get(t);void 0===r?(this._context.gl.uniform4f(this._getUniformLocation(t),e,o,i,n),this._nameToUniform4.set(t,[e,o,i,n])):void 0!==r&&e===r[0]&&o===r[1]&&i===r[2]&&n===r[3]||(this._context.gl.uniform4f(this._getUniformLocation(t),e,o,i,n),r[0]=e,r[1]=o,r[2]=i,r[3]=n)}setUniform4fv(t,e){_(this._nameToUniform4,t,e)&&this._context.gl.uniform4fv(this._getUniformLocation(t),e)}setUniformMatrix3fv(t,e,o=!1){_(this._nameToUniformMatrix3,t,e)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(t),o,e)}setUniformMatrix4fv(t,e,o=!1){_(this._nameToUniformMatrix4,t,e)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(t),o,e)}stop(){}}function m(t,e,o){const n=t.gl,s=n.createShader(e);return n.shaderSource(s,o),n.compileShader(s),i.webglValidateShadersEnabled()&&!n.getShaderParameter(s,n.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===r.ShaderType.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(n.getShaderInfoLog(s)),console.error(f(o))),s}function f(t){let e=2;return t.replaceAll("\n",(()=>"\n"+c(e++)+":"))}function c(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function _(t,o,i){const n=t.get(o);return n?e.update(n,i):(t.set(o,Array.from(i)),!0)}const l={enabled:!1};t.Program=h,t.test=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
