/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/Logger","./storageLayouts"],(function(t,e,a){"use strict";function r(t,e){return t+(e-t%e)%e}const n=(()=>{const t=new ArrayBuffer(2),e=new Uint8Array(t),a=new Uint16Array(t);return e[0]=170,e[1]=187,48042===a[0]})(),i=4,s=e.getLogger("esri.views.webgl.UniformBufferLayout");class o{constructor(t){this._layout=new Map,this.byteLength=this._buildLayout(t),this.array=new ArrayBuffer(this.byteLength),this.arrayView32=new Float32Array(this.array),this._dataView=new DataView(this.array)}setValues(t,e){for(const a in t)this.setValue(a,t[a],e)}setValue(t,e,r){if(!this._layout.has(t))return void s.warn("Trying to set an unrecognized layout array member!");let n=this.byteLength/i,o=0;const{type:h,offset:u,arrayLength:y}=this._layout.get(t),{numberType:l,elementLength:f,elementCount:g,arrayStride:m}=a.STD140_LAYOUT[h],c="number"!=typeof e,w=y*g,L=w*f;if((c?"byteLength"in e?e.byteLength/i:e.length:1)!==L&&s.warn("Attempting to set layout array member value with the wrong length!"),c)for(let a=0;a<w;a++)for(let t=0;t<f;t++){const r=u+a*m+t*i,s=a*f+t;if(this._setData(r,e[s],l)){const t=r/i;n=Math.min(n,t),o=Math.max(o,t+1)}}else if(this._setData(u,e,l)){const t=u/i;n=Math.min(n,t),o=Math.max(o,t+1)}r&&(r.from=Math.min(n,r.from),r.to=Math.max(o,r.to))}_setData(t,e,a){switch(a){case"Int32":if(e!==this._dataView.getInt32(t,n))return this._dataView.setInt32(t,e,n),!0;break;case"Uint32":if(e!==this._dataView.getUint32(t,n))return this._dataView.setUint32(t,e,n),!0;break;case"Float32":if(e!==this._dataView.getFloat32(t,n))return this._dataView.setFloat32(t,e,n),!0}return!1}_buildLayout(t){let e=0;for(const{name:n,type:s,count:o}of t){const{elementLength:t,elementCount:h,elementAlignment:u,arrayStride:y,arrayAlignment:l}=a.STD140_LAYOUT[s],f=o??1,g=f*h,m=g>1,c=m?l:u,w=m?g*y:t*i;e=r(e,c),this._layout.set(n,{type:s,offset:e,arrayLength:f}),e+=w,m&&(e=r(e,c))}return r(e,4*i)}}t.UniformBufferLayout=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
