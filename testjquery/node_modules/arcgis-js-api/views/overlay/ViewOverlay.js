/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../libs/maquette/projection","../../libs/maquette/projector"],(function(e,t,r,o,s,i,a,c,n,d,h){"use strict";let l=class extends t{constructor(){super(...arguments),this.items=new r,this._watchUpdatingTracking=new n.UpdatingHandles,this._callbacks=new Map,this._projector=h.createProjector(),this._hiddenProjector=h.createProjector()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange((()=>this.items),(e=>{for(const t of e.added){const e=()=>t.render();this._callbacks.set(t,e),this._projector.append(this.surface,e)}for(const t of e.removed){const e=this._projector.detach(this._callbacks.get(t));this.surface.removeChild(e.domNode),this._callbacks.delete(t)}}))}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach((e=>this._projector.detach(e))),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,r=this._hiddenProjector;let o;const s=()=>(o=e.render(),o);r.append(t,s),r.renderNow();const i={left:0,top:0,right:0,bottom:0};if(o?.domNode){const e=o.domNode.getBoundingClientRect();i.left=e.left,i.top=e.top,i.right=e.right,i.bottom=e.bottom}for(r.detach(s);t.firstChild;)t.removeChild(t.firstChild);return i}overlaps(e,t){const r=this.computeBoundingRect(e),o=this.computeBoundingRect(t);return Math.max(r.left,o.left)<=Math.min(r.right,o.right)&&Math.max(r.top,o.top)<=Math.min(r.bottom,o.bottom)}get hasVisibleItems(){return this.items.some((e=>e.visible))}async prepare(){await document.fonts.load(this._fontString()).catch((()=>{}))}renderCanvas(e,t){const r=!!t?.disableDecorations;if(!this.items.some((e=>e.visible&&!(r&&e.isDecoration))))return;const o=e.getContext("2d");o.save(),o.font=this._fontString(),this.items.forEach((e=>{r&&e.isDecoration||(o.save(),e.renderCanvas(o),o.restore())})),o.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};e.__decorate([o.property({readOnly:!0})],l.prototype,"surface",void 0),e.__decorate([o.property({readOnly:!0})],l.prototype,"items",void 0),e.__decorate([o.property({readOnly:!0})],l.prototype,"needsRender",null),e.__decorate([o.property({readOnly:!0})],l.prototype,"_watchUpdatingTracking",void 0),e.__decorate([o.property({readOnly:!0})],l.prototype,"updating",null),l=e.__decorate([c.subclass("esri.views.overlay.ViewOverlay")],l);return l}));
