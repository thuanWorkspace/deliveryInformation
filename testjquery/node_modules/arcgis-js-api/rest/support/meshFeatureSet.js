/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Graphic","../../core/Logger","../../core/MapUtils","../../chunks/vec3f64","../../geometry/Extent","../../geometry/Mesh","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/MeshGeoreferencedRelativeVertexSpace","../../geometry/support/MeshLocalVertexSpace","../../geometry/support/MeshTransform","../../geometry/support/meshUtils/External","../../layers/support/infoFor3D","./FeatureSet"],(function(e,t,r,n,o,s,a,i,u,c,l,f,p,m,g){"use strict";const y=()=>r.getLogger("esri.rest.support.meshFeatureSet");function h(e,r,n){const o=n.features;n.features=[],delete n.geometryType;const s=g.fromJSON(n);if(s.geometryType="mesh",!n.assetMaps)return s;const a=T(r,n.assetMaps),i=e.sourceSpatialReference??u.WGS84,c=n.globalIdFieldName,{outFields:l}=e,f=null!=l&&l.length>0?S(l.includes("*")?null:new Set(l)):()=>({});for(const u of o){const e=d(u,c,i,r,a);null!=e&&s.features.push(new t({geometry:e,attributes:f(u)}))}return s}function S(e){return({attributes:t})=>{if(!t)return{};if(!e)return t;for(const r in t)e.has(r)||delete t[r];return t}}function d(e,t,r,n,o){const i=e.attributes[t],u=o.get(i);if(null==u)return y().error("mesh-feature-set:asset-not-found","Service returned a feature which was not found in the asset map",e),null;if(!e.geometry)return y().error("mesh-feature-set:no-geometry","Service returned a feature without geometry",e),null;const{originPoint:f,originVector:p}=E(e,r,n),m=s.fromJSON(e.geometry);m.spatialReference=r;const g=M(e.attributes,n),h=u.projectVertices?new c({origin:p}):new l({origin:p}),S=F(u);return S?a.createWithExternalSource(f,S,{extent:m,transform:g,vertexSpace:h}):a.createIncomplete(f,{extent:m,transform:g,vertexSpace:h})}function E({attributes:e},t,{transformFieldRoles:r}){const n=e[r.originX],s=e[r.originY],a=e[r.originZ];return{originPoint:new i({x:n,y:s,z:a,spatialReference:t}),originVector:o.fromValues(n,s,a)}}function M(e,{transformFieldRoles:t}){return new f({translation:[e[t.translationX],-e[t.translationZ],e[t.translationY]],rotationAxis:[e[t.rotationX],-e[t.rotationZ],e[t.rotationY]],rotationAngle:e[t.rotationDeg],scale:[e[t.scaleX],e[t.scaleZ],e[t.scaleY]]})}var w;function T(e,t){const r=new Map;for(const o of t){const t=o.parentGlobalId;if(null==t)continue;const s=o.assetName,a=o.assetType,i=o.assetHash,u=o.assetURL,c=o.conversionStatus,l=o.seqNo,f=m.getFormatIdMimeType(a,e.supportedFormats);if(!f){y().error("mesh-feature-set:unknown-format",`Service returned an asset of type ${a}, but it does not list it as a supported type`);continue}const p=n.getOrCreateMapValue(r,t,(()=>({projectVertices:D(o.flags).projectVertices,files:new Map})));n.getOrCreateMapValue(p.files,s,(()=>({name:s,type:a,mimeType:f,status:P(c),parts:[]}))).parts[l]={hash:i,url:u}}return r}function F(e){const t=Array.from(e.files.values()),r=new Array;for(const n of t){if(n.status!==w.COMPLETED)return null;const e=new Array;for(const t of n.parts){if(!t)return null;e.push(new p.ServiceAssetPart(t.url,t.hash))}r.push(new p.ServiceAsset(n.name,n.mimeType,e))}return r}function P(e){switch(e){case"COMPLETED":case"SUBMITTED":return w.COMPLETED;case"INPROGRESS":return w.PENDING;default:return w.FAILED}}function D(e){return{projectVertices:e.includes("PROJECT_VERTICES")}}!function(e){e[e.FAILED=0]="FAILED",e[e.PENDING=1]="PENDING",e[e.COMPLETED=2]="COMPLETED"}(w||(w={})),e.assetMapFromAssetMapsJSON=T,e.extractMesh=d,e.meshFeatureSetFromJSON=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
