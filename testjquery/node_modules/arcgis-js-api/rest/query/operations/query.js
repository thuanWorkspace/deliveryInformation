/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../request","../../../core/urlUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","../../operations/urlUtils","./pbfQueryUtils","./queryZScale"],(function(e,t,n,r,u,a,i,o,l){"use strict";const s="Layer does not support extent calculation.";function y(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const n=e.toJSON();return delete n.spatialReference,JSON.stringify(n)}function c(e,t){const n=e.geometry,u=e.toJSON();delete u.compactGeometryEnabled,delete u.defaultSpatialReferenceEnabled;const i=u;let o,l,s;if(null!=n&&(l=n.spatialReference,s=a.srToRESTValue(l),i.geometryType=r.getJsonType(n),i.geometry=y(n,e.compactGeometryEnabled),i.inSR=s),u.groupByFieldsForStatistics&&(i.groupByFieldsForStatistics=u.groupByFieldsForStatistics.join(",")),u.objectIds&&(i.objectIds=u.objectIds.join(",")),u.orderByFields&&(i.orderByFields=u.orderByFields.join(",")),!u.outFields||!u.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete i.outFields:u.outFields.includes("*")?i.outFields="*":i.outFields=u.outFields.join(","),u.outSR?(i.outSR=a.srToRESTValue(u.outSR),o=e.outSpatialReference):n&&(u.returnGeometry||u.returnCentroid)&&(i.outSR=i.inSR,o=l),u.returnGeometry&&delete u.returnGeometry,u.outStatistics&&(i.outStatistics=JSON.stringify(u.outStatistics)),u.fullText&&(i.fullText=JSON.stringify(u.fullText)),u.pixelSize&&(i.pixelSize=JSON.stringify(u.pixelSize)),u.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=e.quantizationParameters?.extent&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete u.quantizationParameters.extent.spatialReference,i.quantizationParameters=JSON.stringify(u.quantizationParameters)),u.parameterValues&&(i.parameterValues=JSON.stringify(u.parameterValues)),u.rangeValues&&(i.rangeValues=JSON.stringify(u.rangeValues)),u.dynamicDataSource&&(i.layer=JSON.stringify({source:u.dynamicDataSource}),delete u.dynamicDataSource),u.timeExtent){const e=u.timeExtent,{start:t,end:n}=e;null==t&&null==n||(i.time=t===n?t:`${t??"null"},${n??"null"}`),delete u.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=o&&l.equals(o)&&(i.defaultSR=i.inSR,delete i.inSR,delete i.outSR),i}async function d(e,t,n,r){const u=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await g(e,t,"json",r);return l.applyFeatureSetZUnitScaling(t,n,u.data),u}async function m(e,t,n,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:n.createFeatureResult()};const u=await f(e,t,r),a=u;return a.data=o.parsePBFFeatureQuery(u.data,n),a}function f(e,t,n){return g(e,t,"pbf",n)}function p(e,t,n){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):g(e,t,"json",n,{returnIdsOnly:!0})}function S(e,t,n){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):g(e,t,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}async function x(e,t,n){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const r=await g(e,t,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}),u=r.data;if(u.hasOwnProperty("extent"))return r;if(u.features)throw new Error(s);if(u.hasOwnProperty("count"))throw new Error(s);return r}async function g(e,r,a,o={},l={}){const s="string"==typeof e?n.urlToObject(e):e,y=r.geometry?[r.geometry]:[],d=await u.normalizeCentralMeridian(y,null,{signal:o.signal}),m=d?.[0];null!=m&&((r=r.clone()).geometry=m);const f=i.mapParameters({...s.query,f:a,...l,...c(r,l)});return t(n.join(s.path,E(r,l)?"query3d":"query"),{...o,responseType:"pbf"===a?"array-buffer":"json",query:{...f,...o.query}})}function E(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}e.encodeGeometry=y,e.executeQuery=d,e.executeQueryForCount=S,e.executeQueryForExtent=x,e.executeQueryForIds=p,e.executeQueryPBF=m,e.executeQueryPBFBuffer=f,e.queryToQueryStringParameters=c,e.runQuery=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
