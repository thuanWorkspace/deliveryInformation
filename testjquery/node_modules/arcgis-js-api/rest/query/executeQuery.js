/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../core/Error","../../core/has","../../core/promiseUtils","../../layers/support/infoFor3D","../../layers/support/source/DataLayerSource","./executeQueryJSON","./executeQueryPBF","../support/FeatureSet","../support/Query"],(function(e,t,r,o,n,a,s,i,u,c,l){"use strict";async function f(e,t,r,o){return p(t,await m(e,t,r,o),r,o)}async function m(e,t,r,n){const a={...n},s=y(t,r),c=null!=t.outStatistics?.[0],l=o("featurelayer-pbf-statistics"),f=!c||l;let m;if("pbf"===r?.format&&f)try{m=await u.executeRawQueryPBF(e,s,a)}catch(p){if("query:parsing-pbf"!==p.name)throw p;r.format="json"}return"json"!==r?.format&&f||(m=await i.executeRawQueryJSON(e,s,a)),d(r?.fieldsIndex,m.fields),m}function d(e,t){if(null!=e&&null!=t)for(const r of t){const t=e.get(r.name);t&&Object.assign(r,t.toJSON())}}async function p(t,r,o,a){const s=o?.infoFor3D;if(!F(t,s)||null==s||!r.assetMaps||!r.features?.length)return c.fromJSON(r);const{meshFeatureSetFromJSON:i}=await n.whenOrAbort(new Promise(((t,r)=>e(["../support/meshFeatureSet"],t,r))),a);return i(t,s,r)}function y(e,t){let o=l.from(e);o.sourceSpatialReference=o.sourceSpatialReference??t?.sourceSpatialReference??null,(t?.gdbVersion||t?.dynamicDataSource)&&(o=o===e?o.clone():o,o.gdbVersion=e.gdbVersion||t.gdbVersion,o.dynamicDataSource=e.dynamicDataSource?s.DataLayerSource.from(e.dynamicDataSource):t.dynamicDataSource);const n=t?.infoFor3D;if(null!=n&&F(e,n)){o=o===e?o.clone():o,o.formatOf3DObjects=null;const{supportedFormats:t,queryFormats:s}=n,i=a.getMimeTypeFormatId("model/gltf-binary",t)??a.getFilenameFormatId("glb",t),u=a.getMimeTypeFormatId("model/gltf+json",t)??a.getFilenameFormatId("gtlf",t);for(const e of s){if(e===i){o.formatOf3DObjects=e;break}e!==u||o.formatOf3DObjects||(o.formatOf3DObjects=e)}if(!o.formatOf3DObjects)throw new r("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==o.outFields||!o.outFields.includes("*")){o=o===e?o.clone():o,null==o.outFields&&(o.outFields=[]);const{originX:t,originY:r,originZ:a,translationX:s,translationY:i,translationZ:u,scaleX:c,scaleY:l,scaleZ:f,rotationX:m,rotationY:d,rotationZ:p,rotationDeg:y}=n.transformFieldRoles;o.outFields.push(t,r,a,s,i,u,c,l,f,m,d,p,y)}}return o}function F(e,t){return null!=t&&!0===e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics}t.executeQuery=f,t.executeRawQuery=m,t.normalizeFields=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
