/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/sql","../../geometry/support/jsonUtils","../../geometry/support/scaleUtils","../../geometry/support/spatialReferenceUtils","../../layers/support/floorFilterUtils","../../layers/support/sublayerUtils"],(function(e,t,r,n,i,l,s){"use strict";function o(e,t){const{dpi:n,gdbVersion:l,geometry:s,geometryPrecision:o,height:y,layerOption:f,mapExtent:p,maxAllowableOffset:u,returnFieldName:c,returnGeometry:m,returnUnformattedValues:d,returnZ:g,spatialReference:x,timeExtent:S,tolerance:b,width:E}=e.toJSON(),{dynamicLayers:h,layerDefs:O,layerIds:N}=a(e),R=null!=t?.geometry?t.geometry:null,I={geometryPrecision:o,maxAllowableOffset:u,returnFieldName:c,returnGeometry:m,returnUnformattedValues:d,returnZ:g,tolerance:b},J=R&&R.toJSON()||s;I.imageDisplay=`${E},${y},${n}`,l&&(I.gdbVersion=l),J&&(delete J.spatialReference,I.geometry=JSON.stringify(J),I.geometryType=r.getJsonType(J));const T=x??J?.spatialReference??p?.spatialReference;if(T&&(I.sr=i.srToRESTValue(T)),I.time=S?[S.start,S.end].join(","):null,p){const{xmin:e,ymin:t,xmax:r,ymax:n}=p;I.mapExtent=`${e},${t},${r},${n}`}return O&&(I.layerDefs=O),h&&!O&&(I.dynamicLayers=h),I.layers="popup"===f?"visible":f,N&&!h&&(I.layers+=`:${N.join(",")}`),I}function a(e){const{mapExtent:t,floors:r,width:i,sublayers:o,layerIds:a,layerOption:f,gdbVersion:p}=e,u=o?.find((e=>null!=e.layer))?.layer?.serviceSublayers,c="popup"===f,m={},d={extent:t,width:i,spatialReference:t?.spatialReference},g=n.getScale(d),x=[],S=e=>{const t=0===g,r=0===e.minScale||g<=e.minScale,n=0===e.maxScale||g>=e.maxScale;if(e.visible&&(t||r&&n))if(e.sublayers)e.sublayers.forEach(S);else{if(!1===a?.includes(e.id)||c&&(!e.popupTemplate||!e.popupEnabled))return;x.unshift(e)}};if(o?.forEach(S),o&&!x.length)m.layerIds=[];else{const e=s.isExportDynamic(x,u,p),t=x.map((e=>{const t=l.getLayerFloorFilterClause(r,e);return e.toExportImageJSON(t)}));if(e)m.dynamicLayers=JSON.stringify(t);else{if(o){let e=x.map((({id:e})=>e));a&&(e=e.filter((e=>a.includes(e)))),m.layerIds=e}else a?.length&&(m.layerIds=a);const e=y(r,x);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(m.layerDefs=JSON.stringify(t))}}}return m}function y(e,r){const n=!!e?.length,i=r.filter((e=>null!=e.definitionExpression||n&&null!=e.floorInfo));return i.length?i.map((r=>{const n=l.getLayerFloorFilterClause(e,r),i=t.sqlAnd(n,r.definitionExpression);return{id:r.id,definitionExpression:i??void 0}})):null}e.identifyToIdentifyRESTParameters=o,e.toDynamicLayersJSON=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
