/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../geometry","../request","../geometry/support/normalizeUtils","../geometry/support/spatialReferenceUtils","./utils","./support/ImageAngleResult","./support/ImageAreaResult","./support/ImageDistanceResult","./support/ImageHeightResult","./support/ImageIdentifyResult","./support/ImagePixelLocationResult","./support/ImagePointResult","./support/ImageSampleResult","../geometry/SpatialReference"],(function(e,t,a,n,r,o,s,i,l,c,u,m,p,f,g){"use strict";function d(e){const t=e?.time;if(t&&(null!=t.start||null!=t.end)){const a=[];null!=t.start&&a.push(t.start),null==t.end||a.includes(t.end)||a.push(t.end),e.time=a.join(",")}}async function y(e,t,a){const r=o.parseUrl(e),s=t.geometry?[t.geometry]:[],i=await n.normalizeCentralMeridian(s),l=t.toJSON();d(l);const c=i?.[0];null!=c&&(l.geometry=c.toJSON());const u=o.encode({...r.query,f:"json",...l});return o.asValidOptions(u,a)}async function S(e,t,n){const r=t.toJSON();null!=r.angleName&&(r.angleName=r.angleName.join(",")),t?.point?.spatialReference?.imageCoordinateSystem&&(r.point.spatialReference=A(t.point.spatialReference)),t?.spatialReference?.imageCoordinateSystem&&(r.spatialReference=P(t.spatialReference));const i=o.parseUrl(e),l=o.encode({...i.query,f:"json",...r}),c=o.asValidOptions(l,n),{data:u}=await a(`${i.path}/computeAngles`,c);return u.spatialReference=u.spatialReference?null!=u.spatialReference.geodataXform?new g({wkid:0,imageCoordinateSystem:u.spatialReference}):g.fromJSON(u.spatialReference):null,"NaN"===u.north&&(u.north=null),"NaN"===u.up&&(u.up=null),new s(u)}async function N(e,t,n){const r=t.toJSON(),{geometries:s}=t;if(s)for(let a=0;a<s.length;a++)s[a].spatialReference?.imageCoordinateSystem&&(r.geometries.geometries[a].spatialReference=A(s[a].spatialReference));const i=o.parseUrl(e),l=o.encode({...i.query,f:"json",...r}),c=o.asValidOptions(l,n),{data:u}=await a(`${i.path}/computePixelLocation`,c);return m.fromJSON(u)}async function O(e,t,n){const r=await y(e,t,n),s=o.parseUrl(e),{data:i}=await a(`${s.path}/computeStatisticsHistograms`,r),{statistics:l}=i;return l?.length&&l.forEach((e=>{e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:l,histograms:i.histograms}}async function R(e,t,n){const r=await y(e,t,n),s=o.parseUrl(e),{data:i}=await a(`${s.path}/computeHistograms`,r);return{histograms:i.histograms}}async function J(e,t,r){const s=t.toJSON();d(s),s.outFields?.length&&(s.outFields=s.outFields.join(","));const i=await n.normalizeCentralMeridian(t.geometry),l=i?.[0];null!=l&&(s.geometry=l.toJSON());const c=o.parseUrl(e),u=o.encode({...c.query,f:"json",...s}),m=o.asValidOptions(u,r),{data:p}=await a(`${c.path}/getSamples`,m),g=p?.samples?.map((e=>{const t="NaN"===e.value||""===e.value?null:e.value.split(" ").map((e=>Number(e)));return{...e,pixelValue:t}}));return f.fromJSON({samples:g})}async function h(e,t,r){const s=o.parseUrl(e),i=t.geometry?[t.geometry]:[];return n.normalizeCentralMeridian(i).then((e=>{const n=t.toJSON(),i=e?.[0];null!=i&&(n.geometry=JSON.stringify(i.toJSON()));const l=o.encode({...s.query,f:"json",...n}),c=o.asValidOptions(l,r);return a(s.path+"/identify",c)})).then((e=>u.fromJSON(e.data)))}async function w(e,t,a){const n=await U(e,t,[t.fromGeometry,t.toGeometry],a);return c.fromJSON(n)}async function C(e,t,a){const n=await U(e,t,[t.geometry],a);return i.fromJSON(n)}async function I(e,t,a){const n=await U(e,t,[t.geometry],a);return p.fromJSON(n)}async function j(e,t,a){const n=await U(e,t,[t.fromGeometry,t.toGeometry],a);return l.fromJSON(n)}async function U(e,t,r,s){const i=o.parseUrl(e),l=await n.normalizeCentralMeridian(r),c=t.toJSON();null!=l[0]&&(c.fromGeometry=JSON.stringify(v(l[0]))),null!=l[1]&&(c.toGeometry=JSON.stringify(v(l[1])));const u=o.encode({...i.query,f:"json",...c}),m=o.asValidOptions(u,s),{data:p}=await a(i.path+"/measure",m);return p}function v(e){const t=e.toJSON();return e.spatialReference?.imageCoordinateSystem&&(t.spatialReference=A(e.spatialReference)),t}function A(e){const{imageCoordinateSystem:t}=e;if(t){const{id:e,referenceServiceName:a}=t;return null!=e?a?{icsid:e,icsns:a}:{icsid:e}:{ics:t}}return e.toJSON()}function P(e,t){if(!e.imageCoordinateSystem)return r.srToRESTValue(e);const a=A(e),{icsid:n,icsns:o}=a;return null==n||null!=o&&!t?.toLowerCase().includes("/"+o.toLowerCase()+"/")?JSON.stringify(a):`0:${n}`}e.computeAngles=S,e.computeHistograms=R,e.computePixelSpaceLocations=N,e.computeStatisticsHistograms=O,e.getImageSpatialReferenceJSON=A,e.getImageSpatialReferenceQueryParameter=P,e.getSamples=J,e.identify=h,e.measureAreaAndPerimeter=C,e.measureDistanceAndAngle=j,e.measureHeight=w,e.measurePointOrCentroid=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
