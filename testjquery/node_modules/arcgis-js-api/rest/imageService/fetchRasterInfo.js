/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../request","../../geometry/Extent","../../geometry/Point","../../geometry/SpatialReference","../../layers/support/RasterInfo","../utils","../support/FeatureSet"],(function(e,t,a,l,n,i,s,r){"use strict";async function u(e,u,o){const c=s.parseUrl(e),{rasterFunction:f,sourceJSON:m}=u||{},d=f?JSON.stringify(f.rasterFunctionDefinition||f):null,p=s.encode({...c.query,renderingRule:d,f:"json"}),h=s.asValidOptions(p,o);e=c.path;const g=m||await t(e,h).then((e=>e.data)),S=g.hasRasterAttributeTable?t(`${e}/rasterAttributeTable`,h):null,b=g.hasColormap?t(`${e}/colormap`,h):null,v=g.hasHistograms?t(`${e}/histograms`,h):null,y=g.currentVersion>=10.3?t(`${e}/keyProperties`,h):null,V=g.hasMultidimensions?t(`${e}/multidimensionalInfo`,h):null,x=await Promise.allSettled([S,b,v,y,V]);let D=null;if(g.minValues&&g.minValues.length===g.bandCount){D=[];for(let e=0;e<g.minValues.length;e++)D.push({min:g.minValues[e],max:g.maxValues[e],avg:g.meanValues[e],stddev:g.stdvValues[e]})}const T=a.fromJSON(g.extent),R=Math.ceil(T.width/g.pixelSizeX-.1),I=Math.ceil(T.height/g.pixelSizeY-.1),O=n.fromJSON(g.spatialReference||g.extent.spatialReference),w="fulfilled"===x[0].status?x[0].value?.data:null,J=w?.features?.length?r.fromJSON(w):null,N="fulfilled"===x[1].status?x[1].value?.data.colormap:null,C=N?.length?N:null,z="fulfilled"===x[2].status?x[2].value?.data.histograms:null,M=z?.[0]?.counts?.length?z:null,P="fulfilled"===x[3].status?x[3].value?.data??{}:{},$="fulfilled"===x[4].status?x[4].value?.data.multidimensionalInfo:null,F=$?.variables?.length?$:null;F&&F.variables.forEach((e=>{e.statistics?.length&&e.statistics.forEach((e=>{e.avg=e.mean,e.stddev=e.standardDeviation}))}));const{defaultVariable:A,serviceDataType:E}=g;A&&A!==P.DefaultVariable&&(P.DefaultVariable=A),E?.includes("esriImageServiceDataTypeVector")&&!E.includes(P.DataType)&&(P.DataType=E.replace("esriImageServiceDataType",""));let j=g.noDataValue;return g.noDataValues?.length&&g.noDataValues.some((e=>e!==j))&&(j=g.noDataValues),new i({width:R,height:I,bandCount:g.bandCount,extent:a.fromJSON(g.extent),spatialReference:O,pixelSize:new l({x:g.pixelSizeX,y:g.pixelSizeY,spatialReference:O}),pixelType:g.pixelType.toLowerCase(),statistics:D,attributeTable:J,colormap:C,histograms:M,keyProperties:P,noDataValue:j,multidimensionalInfo:F})}function o(e,t,a){return u(e,{sourceJSON:t},a)}function c(e,t,a){return u(e,{rasterFunction:t},a)}function f(e,t){e.attributeTable||(t.hasRasterAttributeTable=!1),e.histograms||(t.hasHistograms=!1),e.colormap||(t.hasColormap=!1),e.multidimensionalInfo||(t.hasMultidimensions=!1)}e.fetchServiceRasterInfo=o,e.generateRasterInfo=c,e.patchServiceInfo=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
