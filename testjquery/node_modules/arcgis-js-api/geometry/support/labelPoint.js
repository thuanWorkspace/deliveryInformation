/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/PriorityQueue","./aaBoundingRect","./boundsUtils","./centroid","./coordsUtils","./intersectsBase"],(function(e,t,n,i,r,o,a){"use strict";const s=100*222045e-21;function c(e){if(0===e.totalSize)return null;const t=i.getCursorBoundsXY(e);if(!t)return null;const o=4*(Math.abs(t[0])+Math.abs(t[2])+Math.abs(t[1])+Math.abs(t[3])+1)*s;let a=0,c=0;e.reset();for(let n=0;e.nextPath();n++){const t=e.getCurrentRingArea();t>c&&(c=t,a=n)}if(e.seekPath(a),0===e.pathSize)return null;e.seekPathStart();const f=i.getCursorPathBounds(e);if(Math.abs(c)<=2*o*o)return[(f[0]+f[2])/2,(f[1]+f[3])/2];e.seekPathStart();const h=r.ringCentroidCursorXY(e,n.create());if(null===h)return null;if(e.totalPoints<4)return h;const d=[[NaN,NaN],[NaN,NaN],[NaN,NaN],[NaN,NaN]],x=[NaN,NaN,NaN,NaN],P=[NaN,NaN,NaN,NaN];let y=!1,g=l(h,e,!0);0===g.distance&&(y=!0,d[0][0]=h[0],d[0][1]=h[1],g=l(h,e,!1)),x[0]=g.distance,P[0]=0;const M=[NaN,NaN];let S=!1,w=.25,k=-1,z=NaN;do{if(z=NaN,d[1]=N(e,m(f[0],f[2],w),o,t),isNaN(d[1][0])||isNaN(d[1][1])||(g=l(d[1],e,!1),z=g.distance),!isNaN(z)&&z>o&&u(d[1],e))S=!0,x[1]=z,P[1]=C(d[1],h);else if(!isNaN(z)&&z>k&&(k=z,M[0]=d[1][0],M[1]=d[1][1]),w-=.01,w<.1){if(!(k>=0))break;S=!0,x[1]=k,d[1][0]=M[0],d[1][1]=M[1],P[1]=C(d[1],h)}}while(!S);S=!1,w=.5,k=-1;let p=.01,q=1;do{if(z=NaN,d[2]=N(e,m(f[0],f[2],w),o,t),isNaN(d[2][0])||isNaN(d[2][1])||(g=l(d[2],e,!1),z=g.distance),!isNaN(z)&&z>o&&u(d[2],e))S=!0,x[2]=z,P[2]=C(d[2],h);else if(!isNaN(z)&&z>k)k=z,M[0]=d[2][0],M[1]=d[2][1];else if(z>k&&(k=z,M[0]=d[2][0],M[1]=d[2][1]),w=.5+p*q,p+=.01,q*=-1,w<.3||w>.7){if(!(k>=0))break;S=!0,x[2]=k,d[2][0]=M[0],d[2][1]=M[1],P[2]=C(d[2],h)}}while(!S);S=!1,w=.75,k=-1;do{if(z=NaN,d[3]=N(e,m(f[0],f[2],w),o,t),isNaN(d[3][0])||isNaN(d[3][1])||(g=l(d[3],e,!1),z=g.distance),!isNaN(z)&&z>o&&u(d[3],e))S=!0,x[3]=z,P[3]=C(d[3],h);else if(z>k&&(k=z,M[0]=d[3][0],M[1]=d[3][1]),w+=.01,w>.9){if(!(k>=0))break;S=!0,x[3]=k,d[3][0]=M[0],d[3][1]=M[1],P[3]=C(d[3],h)}}while(!S);const T=[0,1,2,3],B=y?0:1;let D;for(let n=B;n<4;n++)for(let e=B;e<3;e++){const t=P[e],n=P[e+1];b(t,n)>0&&(D=T[e],T[e]=T[e+1],T[e+1]=D,P[e]=n,P[e+1]=t)}let R=B,j=0,L=0;for(let n=B;n<4;n++){switch(n){case 0:L=2*x[T[n]];break;case 1:L=1.66666666*x[T[n]];break;case 2:L=1.33333333*x[T[n]];break;case 3:L=x[T[n]]}L>j&&(j=L,R=T[n])}return d[R]}function u(e,t){let n,i,r,o,a=0;for(t.reset();t.nextPath()&&t.nextPoint();)for(n=t.x,i=t.y;t.nextPoint();n=r,i=o){if(r=t.x,o=t.y,i>e[1]==o>e[1])continue;(r-n)*(e[1]-i)-(o-i)*(e[0]-n)>0?a++:a--}return 0!==a}function l(e,t,n){if(n&&u(e,t))return{coord:e,distance:0};let i=1/0,r=0,a=0,s=[0,0],c=[0,0];const l=[0,0];for(t.reset();t.nextPath()&&t.nextPoint();)if(!(t.pathSize<2))for(s[0]=t.x,s[1]=t.y;t.nextPoint();s=c){c=[t.x,t.y],o.projectPointOnLineSeg(l,e,s,c);const n=C(e,l);n<i&&(i=n,r=l[0],a=l[1])}return{coord:[r,a],distance:Math.sqrt(i)}}function N(e,t,i,r){const o=[t,0];let s=1/0,c=1/0,u=!1,l=!1;const N=[[t,r[1]-1],[t,r[3]+1]],h=[0,0],d=[0,0],x=[0,0],P=[[0,0],[0,0]],g=n.create();for(e.reset();e.nextPath()&&e.nextPoint();)if(!(e.pathSize<2))for(P[0][0]=e.x,P[0][1]=e.y;e.nextPoint();P[0][0]=P[1][0],P[0][1]=P[1][1]){if(P[1][0]=e.x,P[1][1]=e.y,null===f(g,P))continue;if(d[0]=N[0][0],d[1]=N[0][1],x[0]=N[1][0],x[1]=N[1][1],0===y(g,d,x))continue;if(!a.segmentIntersects(N[0],N[1],P[0],P[1],h))continue;const t=h[1];s>c?t<s&&(s=t,u=!0):t<c&&(c=t,l=!0)}return u&&l?o[1]=(s+c)/2:o[0]=o[1]=NaN,o}function f(e,t){if(t.length<2)return null;e||(e=n.create());const[i,r]=t[0],[o,a]=t[1];return e[0]=Math.min(i,o),e[1]=Math.min(r,a),e[2]=Math.max(i,o),e[3]=Math.max(r,a),e}const h=1,d=4,x=3,P=12;function y(e,t,n){let i=g(t,e),r=g(n,e);const o=e[0],a=e[1],s=e[2],c=e[3];if(i&r)return 0;if(!(i|r))return 4;const u=(i?1:0)|(r?2:0);do{const u=n[0]-t[0],l=n[1]-t[1];if(u>l)i&x?(i&h?(t[1]+=l*(o-t[0])/u,t[0]=o):(t[1]+=l*(s-t[0])/u,t[0]=s),i=g(t,e)):r&x?(r&h?(n[1]+=l*(o-n[0])/u,n[0]=o):(n[1]+=l*(s-n[0])/u,n[0]=s),r=g(n,e)):i?(i&d?(t[0]+=u*(a-t[1])/l,t[1]=a):(t[0]+=u*(c-t[1])/l,t[1]=c),i=g(t,e)):(r&d?(n[0]+=u*(a-n[1])/l,n[1]=a):(n[0]+=u*(c-n[1])/l,n[1]=c),r=g(n,e));else if(i&P?(i&d?(t[0]+=u*(a-t[1])/l,t[1]=a):(t[0]+=u*(c-t[1])/l,t[1]=c),i=g(t,e)):r&P?(r&d?(n[0]+=u*(a-n[1])/l,n[1]=a):(n[0]+=u*(c-n[1])/l,n[1]=c),r=g(n,e)):i?(i&h?(t[1]+=l*(o-t[0])/u,t[0]=o):(t[1]+=l*(s-t[0])/u,t[0]=s),i=g(t,e)):(r&h?(n[1]+=l*(o-n[0])/u,n[0]=o):(n[1]+=l*(s-n[0])/u,n[0]=s),r=g(n,e)),i&r)return 0}while(i|r);return u}function g(e,t){return(e[0]<t[0]?1:0)|(e[0]>t[2]?1:0)<<1|(e[1]<t[1]?1:0)<<2|(e[1]>t[3]?1:0)<<3}function m(e,t,n){return e+(t-e)*n}function C(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function b(e,t){if(e<t)return-1;if(e>t)return 1;if(e===t)return 0;const n=isNaN(e),i=isNaN(t);return n<i?-1:n>i?1:0}class M{constructor(e,t,n,i){this.x=e,this.y=t,this.cellSize=n,this.distancefromCellCenter=o.distanceFromPointToPolygon(e,t,i),this.maxDistanceToPolygon=this.distancefromCellCenter+this.cellSize*Math.SQRT2}}const S=1,w=100;function k(e){if(!e.nextPath()||!e.pathSize)return null;const n=i.getCursorPathBounds(e),o=n[2]-n[0],a=n[3]-n[1];if(0===o||0===a)return[n[0]+o/2,n[1]+a/2];const s=Math.max(Math.min(o,a)/w,S),c=new t(((e,t)=>t.maxDistanceToPolygon-e.maxDistanceToPolygon)),u=Math.min(o,a);let l=u/2,N=0,f=0;for(N=n[0];N<n[2];N+=u)for(f=n[1];f<n[3];f+=u)c.enqueue(new M(N+l,f+l,l,e));e.reset(),e.nextPath();const h=r.ringsCentroidCursor(e);if(null===h)return null;let d,x=new M(h[0],h[1],0,e);for(;c.size>0;)d=c.dequeue(),d.distancefromCellCenter>x.distancefromCellCenter&&(x=d),d.maxDistanceToPolygon-x.distancefromCellCenter<=s||(l=d.cellSize/2,c.enqueue(new M(d.x-l,d.y-l,l,e)),c.enqueue(new M(d.x+l,d.y-l,l,e)),c.enqueue(new M(d.x-l,d.y+l,l,e)),c.enqueue(new M(d.x+l,d.y+l,l,e)));return[x.x,x.y]}e.getLabelPoint=c,e.getPolylabelPoint=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
