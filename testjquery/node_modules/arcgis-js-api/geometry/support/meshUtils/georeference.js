/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/unitUtils","../../../chunks/mat3f64","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/mat3","../../projection","../../spatialReferenceEllipsoidUtils","../../projection/computeTranslationToOriginAndRotation","../../projection/projectBuffer","../DoubleArray","../MeshGeoreferencedRelativeVertexSpace","../MeshGeoreferencedVertexSpace","../MeshLocalVertexSpace","../MeshTransform","../../../chunks/vec32","./geographicUtils","./projection"],(function(n,e,t,r,o,a,i,l,c,s,u,f,p,g,m,h,y,F,T,R){"use strict";function M(n,e,t){return T.isGeographicMesh(e.spatialReference,t)?d(n,e,t):S(n,e,t)}function A(n,e=o.IDENTITY){const{position:t,normal:r,tangent:a}=n;return{position:F.transformMat4(new Float64Array(t.length),t,e),normal:null!=r?R.transformNormal(r,new Float32Array(r.length),e):null,tangent:null!=a?R.transformTangent(a,new Float32Array(a.length),e):null}}function P(n,e,t,r){const{position:o,normal:a,tangent:i}=n;if(!e.isRelative)return{position:o,normal:a,tangent:i};return M(A(n,t?.localMatrix),e.getOriginPoint(r),{geographic:!e.isGeoreferenced})}function w(n,e,t){if(t?.useTransform){const{position:r,normal:o,tangent:a}=n,{x:l,y:c,z:s}=e,u=i.fromValues(l,c,s??0);return{vertexAttributes:{position:r,normal:o,tangent:a},vertexSpace:t.geographic??1?new h({origin:u}):new g({origin:u}),transform:new y}}return{vertexAttributes:M(n,e,t),vertexSpace:new m,transform:null}}function j(n,e,t){return T.isGeographicMesh(e.spatialReference,t)?O(n,e,t):b(n,e,t)}function v(n,e,t,r,o){if(!e.isRelative)return j(n,r,o);const{spatialReference:a}=r,i=P(n,e,t,a);return r.equals(e.getOriginPoint(a))?b(i,r,o):j(i,r,o)}function x({positions:n,transform:e,vertexSpace:t,inSpatialReference:l,outSpatialReference:g,outPositions:m,localMode:h}){const y=t.isRelative?t.origin:i.ZEROS,T=t.isRelative?e?.localMatrix??o.IDENTITY:o.IDENTITY;if(t.isGeoreferenced){const e=m??p.newDoubleArray(n.length);if(r.equals(T,o.IDENTITY)?p.copyInto(e,n):F.transformMat4(e,n,T),!a.exactEquals(y,i.ZEROS)){const[n,t,r]=y;for(let o=0;o<e.length;o+=3)e[o]+=n,e[o+1]+=t,e[o+2]+=r}return f.projectBuffer(e,l,0,e,g,0,e.length/3),e}let R=l;const M=s.getSphericalPCPF(l);R=g.isWebMercator&&h||!c.canProjectWithoutEngine(l,M)?R:M,u.computeTranslationToOriginAndRotation(l,y,U,R),r.multiply(U,U,T);const A=m??p.newDoubleArray(n.length);return F.transformMat4(A,n,U),f.projectBuffer(A,R,0,A,g,0,A.length/3),A}function S(n,e,t){const r=new Float64Array(n.position.length),o=n.position,a=e.x,i=e.y,l=e.z??0,c=B(t?t.unit:null,e.spatialReference);for(let s=0;s<o.length;s+=3)r[s]=o[s]*c+a,r[s+1]=o[s+1]*c+i,r[s+2]=o[s+2]*c+l;return{position:r,normal:n.normal,tangent:n.tangent}}function d(n,e,t){const r=e.spatialReference,o=k(e,t,U),a=new Float64Array(n.position.length),i=C(n.position,o,r,a),c=l.normalFromMat4(V,o);return{position:i,normal:E(i,a,n.normal,c,r),tangent:I(i,a,n.tangent,c,r)}}function C(n,e,t,r){F.transformMat4(r,n,e);const o=new Float64Array(n.length);return R.projectFromPCPF(r,o,t)}function E(n,e,t,r,o){if(null==t)return null;const a=new Float32Array(t.length);return F.transformMat3(a,t,r),R.projectNormalFromPCPF(a,n,e,o,a),a}function I(n,e,t,r,o){if(null==t)return null;const a=new Float32Array(t.length);F.transformMat3(a,t,r,4);for(let i=3;i<a.length;i+=4)a[i]=t[i];return R.projectTangentFromPCPF(a,n,e,o,a),a}function b(n,e,t){const r=new Float64Array(n.position.length),o=n.position,a=e.x,i=e.y,l=e.z??0,c=B(t?t.unit:null,e.spatialReference);for(let s=0;s<o.length;s+=3)r[s]=(o[s]-a)/c,r[s+1]=(o[s+1]-i)/c,r[s+2]=(o[s+2]-l)/c;return{position:r,normal:n.normal,tangent:n.tangent}}function O(n,e,t){const o=e.spatialReference;k(e,t,U);const a=r.invert(z,U),i=new Float64Array(n.position.length),c=D(n.position,o,a,i),s=l.normalFromMat4(V,a);return{position:c,normal:N(n.normal,n.position,i,o,s),tangent:G(n.tangent,n.position,i,o,s)}}function k(n,e,t){u.computeTranslationToOriginAndRotation(n.spatialReference,[n.x,n.y,n.z??0],t,s.getSphericalPCPF(n.spatialReference));const o=B(e?e.unit:null,n.spatialReference);return r.scale(t,t,[o,o,o]),t}function D(n,e,t,r){const o=R.projectToPCPF(n,e,r),a=new Float64Array(o.length);return F.transformMat4(a,o,t),a}function N(n,e,t,r,o){if(null==n)return null;const a=R.projectNormalToPCPF(n,e,t,r,new Float32Array(n.length));return F.transformMat3(a,a,o),a}function G(n,e,t,r,o){if(null==n)return null;const a=R.projectTangentToPCPF(n,e,t,r,new Float32Array(n.length));return F.transformMat3(a,a,o,4),a}function B(n,t){if(null==n)return 1;const r=e.getMetersPerCartesianUnitForSR(t);return 1/e.convertUnit(r,"meters",n)}const U=o.create(),z=o.create(),V=t.create();n.applyTransform=A,n.georeference=M,n.georeferenceApplyTransform=P,n.georeferenceByTransform=w,n.project=x,n.ungeoreference=j,n.ungeoreferenceByTransform=v,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
