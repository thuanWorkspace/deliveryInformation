/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../request","../../../core/MapUtils","../../../core/mathUtils","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshTextureTransform","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec32","../../../chunks/vec42","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/glTF/internal/resourceUtils","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../views/webgl/enums","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec22"],(function(e,t,r,n,o,s,a,l,u,i,c,f,m,d,g,p,w,x,T,V,h,v,M,B,b,y,C,A){"use strict";async function F(e,t,r){const n={...r,useTransform:r?.useTransform??!0},o=new V.DefaultLoadingContext(E(n)),s=(await h.loadGLTF(o,t,n,!0)).model,a=s.lods.shift(),l=new Map,u=new Map;s.textures.forEach(((e,t)=>l.set(t,O(e)))),s.materials.forEach(((e,t)=>u.set(t,$(e,l))));const i=k(a);for(const d of i.parts)L(i,d,u);const{position:c,normal:f,tangent:m,color:g,texCoord0:p}=i.vertexAttributes,w={position:c.typedBuffer,normal:null!=f?f.typedBuffer:null,tangent:null!=m?m.typedBuffer:null,uv:null!=p?p.typedBuffer:null,color:null!=g?g.typedBuffer:null},x=T.georeferenceByTransform(w,e,n);return{transform:x.transform,vertexSpace:x.vertexSpace,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new d.MeshVertexAttributes({position:x.vertexAttributes.position,normal:x.vertexAttributes.normal,tangent:x.vertexAttributes.tangent,color:w.color,uv:w.uv})}}function E(e){const t=e?.resolveFile,n=e?.requestFile;return t||n?{busy:!1,request:async(e,o,s)=>{const a=t?.(e)??e;if(n){const e=await n(a,o,s?.signal);if(void 0!==e)return e}const l="image"===o?"image":"binary"===o?"array-buffer":"json";return(await r(a,{responseType:l,signal:null!=s?s.signal:null})).data}}:null}function R(e,t){if(null==e)return"-";const r=e.typedBuffer;return`${n.getOrCreateMapValue(t,r.buffer,(()=>t.size))}/${r.byteOffset}/${r.byteLength}`}function S(e){return null!=e?e.toString():"-"}function k(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,s=new Map,a=[];for(const l of e.parts){const{attributes:{position:e,normal:u,color:i,tangent:c,texCoord0:f}}=l,m=`\n      ${R(e,o)}/\n      ${R(u,o)}/\n      ${R(i,o)}/\n      ${R(c,o)}/\n      ${R(f,o)}/\n      ${S(l.transform)}\n    `;let d=!1;const g=n.getOrCreateMapValue(s,m,(()=>(d=!0,{start:t,length:e.count})));d&&(t+=e.count),u&&(r.normal=!0),i&&(r.color=!0),c&&(r.tangent=!0),f&&(r.texCoord0=!0),a.push({gltf:l,writeVertices:d,region:g})}return{vertexAttributes:{position:x.createBuffer(g.BufferViewVec3f64,t),normal:r.normal?x.createBuffer(g.BufferViewVec3f,t):null,tangent:r.tangent?x.createBuffer(g.BufferViewVec4f,t):null,color:r.color?x.createBuffer(g.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?x.createBuffer(g.BufferViewVec2f,t):null},parts:a,components:[]}}function O(e){return new f({data:(M.isEncodedMeshTexture(e.data),e.data),wrap:U(e.parameters.wrap)})}function $(e,r){const n=new t(I(e.color,e.opacity)),s=e.emissiveFactor?new t(_(e.emissiveFactor)):null,a=e=>e?new m({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:o.rad2deg(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;return new c({color:n,colorTexture:r.get(e.textureColor),normalTexture:r.get(e.textureNormal),emissiveColor:s,emissiveTexture:r.get(e.textureEmissive),occlusionTexture:r.get(e.textureOcclusion),alphaMode:P(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.textureMetallicRoughness),colorTextureTransform:a(e.colorTextureTransform),normalTextureTransform:a(e.normalTextureTransform),occlusionTextureTransform:a(e.occlusionTextureTransform),emissiveTextureTransform:a(e.emissiveTextureTransform),metallicRoughnessTextureTransform:a(e.metallicRoughnessTextureTransform)})}function L(e,t,r){t.writeVertices&&D(e,t);const{indices:n,attributes:o,primitiveType:s,material:a}=t.gltf;let l=v.convertPrimitiveToTriangles(n||o.position.count,s);const u=t.region.start;if(u){const e=new Uint32Array(l);for(let t=0;t<l.length;t++)e[t]+=u;l=e}e.components.push(new i({name:t.gltf.name,faces:l,material:r.get(a),shading:o.normal?"source":"flat",trustSourceNormals:!0}))}function D(e,t){const{position:r,normal:n,tangent:l,color:u,texCoord0:i}=e.vertexAttributes,c=t.region.start,{attributes:f,transform:m}=t.gltf,d=f.position.count;if(p.transformMat4View(r.slice(c,d),f.position,m),null!=f.normal&&null!=n){const e=s.normalFromMat4(a.create(),m),t=n.slice(c,d);p.transformMat3View(t,f.normal,e),o.hasScaling(e)&&p.normalizeView(t,t)}else null!=n&&y.fill(n,0,0,1,{dstIndex:c,count:d});if(null!=f.tangent&&null!=l){const e=s.normalFromMat4(a.create(),m),t=l.slice(c,d);w.transformMat3View(t,f.tangent,e),o.hasScaling(e)&&w.normalize(t,t)}else null!=l&&C.fill(l,0,0,1,1,{dstIndex:c,count:d});if(null!=f.texCoord0&&null!=i?A.normalizeIntegerBufferView(i.slice(c,d),f.texCoord0):null!=i&&A.fill(i,0,0,{dstIndex:c,count:d}),null!=f.color&&null!=u){const e=f.color,t=u.slice(c,d);if(4===e.elementCount)e instanceof g.BufferViewVec4f?w.scaleView(t,e,255):e instanceof g.BufferViewVec4u8?C.copyView(t,e):e instanceof g.BufferViewVec4u16&&w.scaleView(t,e,1/256);else{C.fill(t,255,255,255,255);const r=g.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof g.BufferViewVec3f?p.scaleView(r,e,255):e instanceof g.BufferViewVec3u8?y.copyView(r,e):e instanceof g.BufferViewVec3u16&&p.scaleView(r,e,1/256)}}else null!=u&&C.fill(u.slice(c,d),255,255,255,255)}function P(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function U(e){return{horizontal:z(e.s),vertical:z(e.t)}}function z(e){switch(e){case b.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case b.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case b.TextureWrapMode.REPEAT:return"repeat"}}function G(e){return e**(1/B.colorGamma)*255}function I(e,t){return u.fromValues(G(e[0]),G(e[1]),G(e[2]),t)}function _(e){return l.fromValues(G(e[0]),G(e[1]),G(e[2]))}e.loadGLTFMesh=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
