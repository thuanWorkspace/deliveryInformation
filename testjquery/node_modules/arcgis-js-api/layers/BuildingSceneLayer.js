/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../core/Collection","../core/CollectionFlattener","../core/Error","../core/lang","../core/loadAll","../core/Logger","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/SpatialReference","./Layer","./buildingSublayers/BuildingComponentSublayer","./buildingSublayers/BuildingGroupSublayer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./support/associatedFeatureServiceUtils","./support/BuildingFilter","./support/BuildingSummaryStatistics","./support/commonProperties","../support/elevationInfoUtils"],(function(e,r,t,i,s,o,a,l,n,y,p,d,u,c,h,v,b,g,S,_,f,m,O,w,I,L,A,E,T){"use strict";const x=r.ofType(L),F=s.clone(g.sublayersProperty),B=F.json?.origins;B&&(B["web-scene"]={type:[b],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}},B["portal-item"]={type:[b],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}});let P=class extends(w.SceneService(_.ArcGISService(f.OperationalLayer(m.PortalLayer(O.ScaleRangeLayer(l.MultiOriginJSONMixin(S.APIKeyMixin(v)))))))){constructor(e){super(e),this.operationalLayerType="BuildingSceneLayer",this.allSublayers=new t({getCollections:()=>[this.sublayers],getChildrenFunction:e=>"building-group"===e.type?e.sublayers:null}),this.sublayers=null,this._sublayerOverrides=null,this.filters=new x,this.activeFilterId=null,this.summaryStatistics=null,this.outFields=null,this.legendEnabled=!0,this.type="building-scene"}normalizeCtorArgs(e){return"string"==typeof e?{url:e}:e??{}}destroy(){this.allSublayers.destroy()}readSublayers(e,r,t){const i=g.readSublayers(e,r,t);return g.forEachSublayer(i,(e=>e.layer=this)),this._sublayerOverrides&&(this.applySublayerOverrides(i,this._sublayerOverrides),this._sublayerOverrides=null),i}applySublayerOverrides(e,{overrides:r,context:t}){g.forEachSublayer(e,(e=>e.read(r.get(e.id),t)))}readSublayerOverrides(e,r){const t=new Map;for(const s of e)null!=s&&"object"==typeof s&&"number"==typeof s.id?t.set(s.id,s):r.messages?.push(new i("building-scene-layer:invalid-sublayer-override","Invalid value for sublayer override. Not an object or no id specified.",{value:s}));return{overrides:t,context:r}}writeSublayerOverrides(e,r,t){const i=[];g.forEachSublayer(this.sublayers,(e=>{const r=e.write({},t);Object.keys(r).length>1&&i.push(r)})),i.length>0&&(r.sublayers=i)}writeUnappliedOverrides(e,r){r.sublayers=[],e.overrides.forEach((e=>{r.sublayers.push(s.clone(e))}))}write(e,r){return e=super.write(e,r),!r||"web-scene"!==r.origin&&"portal-item"!==r.origin||(this.sublayers?this.writeSublayerOverrides(this.sublayers,e,r):this._sublayerOverrides&&this.writeUnappliedOverrides(this._sublayerOverrides,e)),e}read(e,r){if(super.read(e,r),r&&("web-scene"===r.origin||"portal-item"===r.origin)&&null!=e&&Array.isArray(e.sublayers)){const t=this.readSublayerOverrides(e.sublayers,r);this.sublayers?this.applySublayerOverrides(this.sublayers,t):this._sublayerOverrides=t}}readSummaryStatistics(e,r){if("string"==typeof r.statisticsHRef){const e=y.join(this.parsedUrl?.path,r.statisticsHRef);return new A({url:e})}return null}set elevationInfo(e){this._set("elevationInfo",e),this._validateElevationInfo()}load(e){const r=null!=e?e.signal:null,t=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(n.throwIfAbortError).then((()=>this._fetchService(r))).then((()=>this._fetchAssociatedFeatureService(r)));return this.addResolvingPromise(t),Promise.resolve(this)}loadAll(){return o.loadAll(this,(e=>{g.forEachSublayer(this.sublayers,(r=>{"building-group"!==r.type&&e(r)})),this.summaryStatistics&&e(this.summaryStatistics)}))}async saveAs(e,r){return this._debouncedSaveOperations(w.SaveOperationType.SAVE_AS,{...r,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"};return this._debouncedSaveOperations(w.SaveOperationType.SAVE,e)}validateLayer(e){if(!e.layerType||"Building"!==e.layerType)throw new i("buildingscenelayer:layer-type-not-supported","BuildingSceneLayer does not support this layer type",{layerType:e.layerType})}_getTypeKeywords(){return["Building"]}async _fetchAssociatedFeatureService(e){try{const{portalItem:r}=await I.findAssociatedFeatureService(`${this.url}/layers/${this.layerId}`,{sceneLayerItem:this.portalItem,apiKey:this.apiKey,signal:e});this.associatedFeatureServiceItem=r}catch(r){a.getLogger(this).warn("Associated feature service item could not be loaded",r)}}_validateElevationInfo(){const e=this.elevationInfo,r="Building scene layers";T.logInvalidElevationInfoWarning(a.getLogger(this),T.elevationModeRequiredMessage(r,"absolute-height",e)),T.logInvalidElevationInfoWarning(a.getLogger(this),T.featureExpressionUnsupportedMessage(r,e))}};e.__decorate([p.property({type:["BuildingSceneLayer"]})],P.prototype,"operationalLayerType",void 0),e.__decorate([p.property({readOnly:!0})],P.prototype,"allSublayers",void 0),e.__decorate([p.property(F)],P.prototype,"sublayers",void 0),e.__decorate([u.reader("service","sublayers")],P.prototype,"readSublayers",null),e.__decorate([p.property({type:x,nonNullable:!0,json:{write:!0}})],P.prototype,"filters",void 0),e.__decorate([p.property({type:String,json:{write:!0}})],P.prototype,"activeFilterId",void 0),e.__decorate([p.property({readOnly:!0,type:A})],P.prototype,"summaryStatistics",void 0),e.__decorate([u.reader("summaryStatistics",["statisticsHRef"])],P.prototype,"readSummaryStatistics",null),e.__decorate([p.property({type:[String],json:{read:!1}})],P.prototype,"outFields",void 0),e.__decorate([p.property(E.sceneLayerFullExtent)],P.prototype,"fullExtent",void 0),e.__decorate([p.property(E.legendEnabled)],P.prototype,"legendEnabled",void 0),e.__decorate([p.property({type:["show","hide","hide-children"]})],P.prototype,"listMode",void 0),e.__decorate([p.property(E.readOnlyService(h))],P.prototype,"spatialReference",void 0),e.__decorate([p.property(E.elevationInfo)],P.prototype,"elevationInfo",null),e.__decorate([p.property({json:{read:!1},readOnly:!0})],P.prototype,"type",void 0),e.__decorate([p.property()],P.prototype,"associatedFeatureServiceItem",void 0),P=e.__decorate([c.subclass("esri.layers.BuildingSceneLayer")],P);return P}));
