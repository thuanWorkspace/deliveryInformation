/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/accessorSupport/originUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils","../../webdoc/saveAPIKeyUtils"],(function(e,t,r,a,o,i,n,s){"use strict";function l(e,r,a){const o=a(e);if(!o.isValid)throw new t(`${r}:invalid-parameters`,o.errorMessage,{layer:e})}async function p(e){const{layer:t,errorNamePrefix:r,validateLayer:a}=e;await t.load(),l(t,r,a)}function d(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function u(e){const{item:r,itemType:a,errorNamePrefix:o,layer:i,validateItem:n}=e;if(s.validateSaveAPIKey(r),r.type!==a)throw new t(`${o}:portal-item-wrong-type`,`Portal item type should be "${a}"`,{item:r,layer:i});if(n){const e=n(r);if(!e.isValid)throw new t(`${o}:invalid-parameters`,e.errorMessage,{layer:i})}}function c(e){const{layer:r,errorNamePrefix:a}=e,{portalItem:o}=r;if(!o)throw new t(`${a}:portal-item-not-set`,d(r,"requires the portalItem property to be set"));if(!o.loaded)throw new t(`${a}:portal-item-not-loaded`,d(r,"cannot be saved to a portal item that does not exist or is inaccessible"));u({...e,item:o})}function y(e){var t,r;const{newItem:i,itemType:n}=e;let s=o.from(i);return s.id&&(s=s.clone(),s.id=null),(t=s).type??(t.type=n),(r=s).portal??(r.portal=a.getDefault()),u({...e,item:s}),s}function m(e,r){let a=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:r,details:a})=>new t(e,r,a)));if(e.blockedRelativeUrls&&(a=a.concat(e.blockedRelativeUrls.map((e=>new t("url:unsupported",`Relative url '${e}' is not supported`))))),r?.ignoreUnsupported&&(a=a.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),a.length>0)throw new t("layer-write:unsupported","Failed to save layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a})}async function f(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),m(t,r),a}function w(e){n.addTypeKeyword(e,n.TypeKeyword.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}async function v(e,t,r){const a=e.portal;await a.signIn(),await(a.user?.addItem({item:e,data:t,folder:r?.folder}))}async function I(e,t){const{layer:a,createItemData:o,createJSONContext:n,saveResources:s}=e;await p(e),c(e);const l=a.portalItem,d=n?n(l):i.createForItemWrite(l),u=await f(a,d,t),y=await o({layer:a,layerJSON:u},l);return w(l),await l.update({data:y}),r.updateOrigins(d),await(s?.(l,d)),l}async function g(e,t){const{layer:a,createItemData:o,createJSONContext:n,setItemProperties:s,saveResources:l}=e;await p(e);const d=y(e),u=n?n(d):i.createForItemWrite(d),c=await f(a,u,t),m=await o({layer:a,layerJSON:c},d);return await s(a,d),w(d),await v(d,m,t),a.portalItem=d,r.updateOrigins(u),await(l?.(d,u)),d}e.addItem=v,e.createErrorMessage=d,e.ensureItemConfig=c,e.ensureLayerConfig=l,e.getLayerJSON=f,e.getPortalItem=y,e.save=I,e.saveAs=g,e.setCommonItemProperties=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
