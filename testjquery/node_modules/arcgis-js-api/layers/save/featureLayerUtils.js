/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/arrayUtils","../../core/Error","../../core/accessorSupport/originUtils","./utils","../support/arcgisLayerUrl","../support/fetchService","../support/layerUtils","../support/lazyLayerLoader","../../portal/support/jsonContext","../../portal/support/portalItemUtils"],(function(e,r,a,t,o,s,n,l,i,y,c){"use strict";const p="Feature Service",u="feature-layer-utils",d=`${u}-save`,m=`${u}-save-as`,f=`${u}-saveall`,w=`${u}-saveall-as`;function h(e){return{isValid:l.isLayerWithFeatureLayerSource(e)&&("feature"!==e.type||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function v(e){const r=[],a=[];for(const{layer:t,layerJSON:o}of e)t.isTable?a.push(o):r.push(o);return{layers:r,tables:a}}function T(e){return v([e])}async function g(e,r){return/\/\d+\/?$/.test(e.url)?T(r[0]):I(r,e)}async function I(e,r){if(!r)return e.reverse(),v(e);const{layer:{url:a,customParameters:t,apiKey:o}}=e[0];let s=await r.fetchData("json");null!=s?.layers&&null!=s?.tables||(s=await S(s,{url:a??"",customParameters:t,apiKey:o},e.map((e=>e.layer.layerId))));for(const n of e)K(n.layer,n.layerJSON,s);return s}async function S(e,r,a){var t,o;e||(e={}),(t=e).layers||(t.layers=[]),(o=e).tables||(o.tables=[]);const{url:s,customParameters:l,apiKey:i}=r,{serviceJSON:y,layersJSON:c}=await n.fetchFeatureService(s,{customParameters:l,apiKey:i}),p=L(e.layers,y.layers,a),u=L(e.tables,y.tables,a);e.layers=p.itemResources,e.tables=u.itemResources;const d=[...p.added,...u.added],m=c?[...c.layers,...c.tables]:[];return await b(e,d,s,m),e}function L(e,a,t){const o=r.difference(e,a,((e,r)=>e.id===r.id));e=e.filter((e=>!o.removed.some((r=>r.id===e.id))));const s=o.added;return s.forEach((({id:r})=>{e.push({id:r})})),{itemResources:e,added:s.filter((({id:e})=>!t.includes(e)))}}async function b(e,r,a,t){const o=await P(r),s=r.map((({id:e,type:r})=>new(o.get(r))({url:a,layerId:e,sourceJSON:t.find((({id:r})=>r===e))})));await Promise.allSettled(s.map((e=>e.load()))),s.forEach((r=>{const{layerId:a,loaded:t,defaultPopupTemplate:o}=r;if(!t||null==o)return;const s={id:a,popupInfo:o.toJSON()};"ArcGISFeatureLayer"!==r.operationalLayerType&&(s.layerType=r.operationalLayerType),K(r,s,e)}))}async function P(e){const r=[];e.forEach((({type:e})=>{const a=E(e),t=i.layerLookupMap[a];r.push(t())}));const a=await Promise.all(r),t=new Map;return e.forEach((({type:e},r)=>{t.set(e,a[r])})),t}function E(e){let r;switch(e){case"Feature Layer":case"Table":r="FeatureLayer";break;case"Oriented Imagery Layer":r="OrientedImageryLayer"}return r}function K(e,r,a){e.isTable?A(a.tables,r):A(a.layers,r)}function A(e,r){const a=e.findIndex((({id:e})=>e===r.id));-1===a?e.push(r):e[a]=r}function N(e,r){if(!e.length)throw new a(`${r}:missing-parameters`,"'layers' array should contain at least one feature layer")}function O(e,r){const t=e.map((e=>e.portalItem.id));if(new Set(t).size>1)throw new a(`${r}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function $(e,r){const t=e.map((e=>e.layerId));if(new Set(t).size!==t.length)throw new a(`${r}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}async function x(e){N(e,f),await Promise.all(e.map((e=>e.load())));for(const r of e)o.ensureLayerConfig(r,f,h),o.ensureItemConfig({layer:r,itemType:p,errorNamePrefix:f});O(e,f),$(e,f)}async function F(e,r){const{url:a,layerId:t,title:o,fullExtent:n,isTable:l}=e,i=s.parse(a);r.url="FeatureServer"===i?.serverType?a:`${a}/${t}`,r.title||(r.title=o),r.extent=null,l||null==n||(r.extent=await c.getWGS84ExtentForItem(n)),c.removeTypeKeyword(r,c.TypeKeyword.METADATA),c.removeTypeKeyword(r,c.TypeKeyword.MULTI_LAYER),c.addTypeKeyword(r,c.TypeKeyword.SINGLE_LAYER),l&&c.addTypeKeyword(r,c.TypeKeyword.TABLE)}function M(e,r){for(const i of e){const t=i.parsedUrl.path,n=s.parse(t),l=n?.url.path;if(!l)throw new a(`${r}:invalid-parameters`,o.createErrorMessage(i,`has unsupported url pattern: ${t}`),{layer:i});const y=n?.serverType;if("FeatureServer"!==y&&"MapServer"!==y)throw new a(`${r}:invalid-parameters`,o.createErrorMessage(i,`has unsupported server type: ${y}`),{layer:i});if("MapServer"===y&&e.length>1)throw new a(`${r}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const t=s.parse(e[0].parsedUrl.path),n=t?.url.path,l=e.every((e=>{const r=s.parse(e.parsedUrl.path);return r?.url.path===n}));if(!l)throw new a(`${r}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}async function U(e){N(e,w),await Promise.all(e.map((e=>e.load())));for(const r of e)o.ensureLayerConfig(r,w,h);M(e,w),$(e,w)}async function J(e,a){let t=0,n=0;for(const{isTable:r}of a)r?n++:t++;const l=a[0].parsedUrl.path,i=s.parse(l);if(e.url="FeatureServer"===i?.serverType?i.url.path:l,e.title||(e.title=i.title),e.extent=null,t>0){const t=a.map((e=>e.fullExtent)).filter(r.isSome).reduce(((e,r)=>e.clone().union(r)));t&&(e.extent=await c.getWGS84ExtentForItem(t))}c.removeTypeKeyword(e,c.TypeKeyword.METADATA),c.toggleTypeKeword(e,c.TypeKeyword.MULTI_LAYER,a.length>1),c.toggleTypeKeword(e,c.TypeKeyword.SINGLE_LAYER,1===a.length),c.toggleTypeKeword(e,c.TypeKeyword.TABLE,n>0&&0===t),o.setCommonItemProperties(e)}async function R(e,r){const a={layer:e,itemType:p,validateLayer:h,createItemData:(e,r)=>g(r,[e]),errorNamePrefix:d};return o.save(a,r)}async function C(e,r){await x(e);const a=e[0].portalItem,s=y.createForItemWrite(a),n=await Promise.all(e.map((e=>o.getLayerJSON(e,s,r)))),l=await g(a,e.map(((e,r)=>({layer:e,layerJSON:n[r]}))));return o.setCommonItemProperties(a),await a.update({data:l}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),t.updateOrigins(s),a.clone()}async function D(e,r,a){const t={layer:e,itemType:p,validateLayer:h,createItemData:(e,r)=>Promise.resolve(T(e)),errorNamePrefix:m,newItem:r,setItemProperties:F};return o.saveAs(t,a)}async function G(e,r,a){await U(e);const s=o.getPortalItem({itemType:p,errorNamePrefix:w,newItem:r}),n=y.createForItemWrite(s),l=await Promise.all(e.map((e=>o.getLayerJSON(e,n,a)))),i=await I(e.map(((e,r)=>({layer:e,layerJSON:l[r]}))));await J(s,e),await o.addItem(s,i,a);for(const t of e)t.portalItem=s.clone();return t.updateOrigins(n),s}e.save=R,e.saveAll=C,e.saveAllAs=G,e.saveAs=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
