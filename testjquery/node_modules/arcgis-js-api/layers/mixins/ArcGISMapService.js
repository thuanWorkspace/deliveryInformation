/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../request","../../core/MapUtils","../../core/promiseUtils","../../core/urlUtils","../../core/Version","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/PropertyOrigin","../../geometry/Extent","../../geometry/SpatialReference","../support/arcgisLayerUrl","../support/commonProperties","../../portal/support/portalItemUtils"],(function(e,r,t,s,o,a,i,p,l,n,c,u,d,y,h,m,b,f,_){"use strict";const I=e=>{let l=class extends e{constructor(){super(...arguments),this.capabilities=void 0,this.copyright=null,this.fullExtent=null,this.legendEnabled=!0,this.spatialReference=null,this.version=void 0,this._allLayersAndTablesMap=null}readCapabilities(e,r){const t=r.capabilities&&r.capabilities.split(",").map((e=>e.toLowerCase().trim()));if(!t)return{operations:{supportsExportMap:!1,supportsExportTiles:!1,supportsIdentify:!1,supportsQuery:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};const s=this.type,o="tile"!==s&&!!r.supportsDynamicLayers,a=t.includes("query"),p=t.includes("map"),l=!!r.exportTilesAllowed,n=t.includes("tilemap"),c=t.includes("data"),u="tile"!==s&&(!r.tileInfo||o),d="tile"!==s&&(!r.tileInfo||o),y="tile"!==s,h=r.cimVersion&&i.Version.parse(r.cimVersion),m=h?.since(1,4)??!1,b=h?.since(2,0)??!1;return{operations:{supportsExportMap:p,supportsExportTiles:l,supportsIdentify:a,supportsQuery:c,supportsTileMap:n},exportMap:p?{supportsArcadeExpressionForLabeling:m,supportsSublayersChanges:y,supportsDynamicLayers:o,supportsSublayerVisibility:u,supportsSublayerDefinitionExpression:d,supportsCIMSymbols:b}:null,exportTiles:l?{maxExportTilesCount:+r.maxExportTilesCount}:null}}readVersion(e,r){let t=r.currentVersion;return t||(t=r.hasOwnProperty("capabilities")||r.hasOwnProperty("tables")?10:r.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),t}async fetchRelatedService(e){const r=this.portalItem;if(!r||!_.isHostedLayer(r))return null;this._relatedFeatureServicePromise||(this._relatedFeatureServicePromise=r.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},e).then((e=>e.find((e=>"Feature Service"===e.type))??null),(()=>null)));const t=await this._relatedFeatureServicePromise;return o.throwIfAborted(e),t?{itemId:t.id,url:t.url}:null}async fetchSublayerInfo(e,r){const{source:s}=e;if(this?.portalItem&&"tile"===this.type&&"map-layer"===s?.type&&_.isHostedLayer(this.portalItem)&&e.originIdOf("url")<y.OriginId.SERVICE){const t=await this.fetchRelatedService(r);t&&(e.url=a.join(t.url,s.mapLayerId.toString()),e.layerItemId=t.itemId)}const{url:o}=e;let i;if("data-layer"===s.type){i=(await t(o,{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey},...r})).data}else if(o&&e.originIdOf("url")>y.OriginId.SERVICE)try{const e=await this._fetchAllLayersAndTablesFromService(o),r=b.parse(o)?.sublayer??s.mapLayerId;i=e.get(r)}catch{}else{let t=e.id;"map-layer"===s?.type&&(t=s.mapLayerId);try{i=(await this.fetchAllLayersAndTables(r)).get(t)}catch{}}return i}async fetchAllLayersAndTables(e){return this._fetchAllLayersAndTablesFromService(this.parsedUrl?.path,e)}async _fetchAllLayersAndTablesFromService(e,r){await this.load(r),this._allLayersAndTablesMap||(this._allLayersAndTablesMap=new Map);const i=b.parse(e),p=s.getOrCreateMapValue(this._allLayersAndTablesMap,i?.url.path,(()=>t(a.join(i?.url.path,"/layers"),{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey}}).then((e=>{const r=new Map;for(const t of e.data.layers)r.set(t.id,t);return{result:r}}),(e=>({error:e}))))),l=await p;if(o.throwIfAborted(r),"result"in l)return l.result;throw l.error}};return r.__decorate([p.property({readOnly:!0})],l.prototype,"capabilities",void 0),r.__decorate([u.reader("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],l.prototype,"readCapabilities",null),r.__decorate([p.property({json:{read:{source:"copyrightText"}}})],l.prototype,"copyright",void 0),r.__decorate([p.property({type:h})],l.prototype,"fullExtent",void 0),r.__decorate([p.property(f.id)],l.prototype,"id",void 0),r.__decorate([p.property({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],l.prototype,"legendEnabled",void 0),r.__decorate([p.property(f.popupEnabled)],l.prototype,"popupEnabled",void 0),r.__decorate([p.property({type:m})],l.prototype,"spatialReference",void 0),r.__decorate([p.property({readOnly:!0})],l.prototype,"version",void 0),r.__decorate([u.reader("version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],l.prototype,"readVersion",null),l=r.__decorate([d.subclass("esri.layers.mixins.ArcGISMapService")],l),l};e.ArcGISMapService=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
