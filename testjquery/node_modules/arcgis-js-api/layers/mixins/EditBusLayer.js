/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Evented","../../core/lang","../../core/promiseUtils","../../core/Logger","../../core/accessorSupport/ensureType","../../core/Error","../../core/has","../../core/accessorSupport/decorators/subclass","../../versionManagement/support/versionManagementUtils"],(function(e,t,s,i,n,d,r,o,l,a,c){"use strict";const u=new s.EventEmitter;function h(e){return u.on("apply-edits",new WeakRef(e))}function m(e){return u.on("update-moment",new WeakRef(e))}function p(e,t,s=null,i=!1){const d=n.createResolver();return i=null==t||i,u.emit("apply-edits",{serviceUrl:e,layerId:t,gdbVersion:s,mayReceiveServiceEdits:i,result:d.promise}),d}function b(e,t,s=null,i){u.emit("update-moment",{serviceUrl:e,layerId:t,gdbVersion:s,moment:i})}const g="esri.layers.mixins.EditBusLayer",y=Symbol(g);function F(e){return null!=e&&"object"==typeof e&&y in e}function I(e){return null!=e&&"object"==typeof e&&"gdbVersion"in e}function f(e,t,s){const i=new URL(e).host,n=c.defaultVersionNameLookup.get(i),d=e=>!e||e===n;return d(t)&&d(s)||t===s}const M=e=>{var s;let n=class extends e{constructor(...e){super(...e),this[s]=!0,this._applyEditsHandler=e=>{const{serviceUrl:t,layerId:s,gdbVersion:n,mayReceiveServiceEdits:d,result:r}=e,o=t===this.url,l=null!=s&&null!=this.layerId&&s===this.layerId,a=I(this),u=I(this)&&f(t,n,this.gdbVersion);if(!o||a&&!u||!l&&!d)return;const h=r.then((e=>{if(l&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",i.clone(e)),e;const t=e.editedFeatures?.find((({layerId:e})=>e===this.layerId));if(t){const{adds:s,updates:n,deletes:d}=t.editedFeatures,r={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:s?s.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],deletedFeatures:d?d.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],updatedFeatures:n?n.map((({current:{attributes:e}})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],editedFeatures:i.clone(e.editedFeatures),exceededTransferLimit:!1,historicMoment:i.clone(e.historicMoment)};return this.emit("edits",r),r}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:i.clone(e.editedFeatures),exceededTransferLimit:!1,historicMoment:i.clone(e.historicMoment)}})).then((e=>("historicMoment"in this&&this.historicMoment!==e.historicMoment&&c.isVersionInEditSession(t,n)&&(this.historicMoment=e.historicMoment),e)));this.emit("apply-edits",{result:h})},this._updateMomentHandler=e=>{const{serviceUrl:t,gdbVersion:s,moment:i}=e,n=t===this.url,d=I(this),r=I(this)&&f(t,s,this.gdbVersion),o=I(this)&&!f(t,this.gdbVersion,null);n&&d&&r&&o&&"historicMoment"in this&&this.historicMoment!==i&&(this.historicMoment=i)},this.when().then((()=>{this.addHandles(h(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(m(this._updateMomentHandler))}),(()=>{}))}};return s=y,n=t.__decorate([a.subclass(g)],n),n};e.EditBusLayer=M,e.emitApplyEditsEvent=p,e.emitUpdateMomentEvent=b,e.isEditBusLayer=F,e.isLayerWithGDBVersion=I,e.onApplyEditsEvent=h,e.onUpdateMomentEvent=m,e.versionMatches=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
