/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../chunks/vec3f64","../../../chunks/vec3","../../../geometry/Point","../../../geometry/projection","../../../geometry/support/webMercatorUtils","../core/ExposurePoint","./groundToImageUtils","./utils","../../../geometry/SpatialReference","../../../geometry/Polygon"],(function(e,t,a,r,n,i,o,c,s,x,y,l){"use strict";const f=Math.PI/180;function p(e,t){if(!e)return Promise.resolve([]);const a=t.feature;let r=a.attributes;return r instanceof c||(r=c.fromJSON(a),r&&(a.attributes=r)),z(e,t)}function z(e,t){const{attributes:a}=t.feature;return a.isSpherical||360===a.horizontalFieldOfView?[]:m(e,t)}async function m(e,t){const{feature:a,imageProperties:r}=t,{attributes:c}=a;let y=new n(c.location);if(4===c.cameraOrientation?.type){const e=c.cameraOrientation;y=new n(x.ltpToGeographic(y,[e.latitude,e.longitude,e.ellipsoidRadius,e.squaredEccentricity]))}let f=!1;y.spatialReference.isWGS84&&(f=!0,y=o.geographicToWebMercator(y));const p=y.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*y.y/6378137))):1,z=h(t,y,p),m=4===c.cameraOrientation?.type?z.map((e=>o.webMercatorToGeographic(new n(e)))):z,w=await s.transformPoints(m,t,!0),P=await Promise.all(w);P.forEach((e=>{e.z=1,e.x=e.x*r.pixelSize.x+r.extent.xmin,e.y=r.extent.ymax-e.y*r.pixelSize.y}));const M=x.computeHFOVAndVFOV(c.horizontalFieldOfView,c.verticalFieldOfView,c.cameraRoll??0).vfov;return Promise.all(e.map((async e=>{e.z=1;let a,z=x.projectiveTransform2(e,P,m);if(a=4===c.cameraOrientation?.type?(await s.transformPoints([o.webMercatorToGeographic(new n({...z,spatialReference:y.spatialReference}))],t,!0))[0]:(await s.transformPoints([new n({...z,spatialReference:y.spatialReference})],t,!0))[0],!a)return null;a.x=a.x*r.pixelSize.x+r.extent.xmin,a.y=r.extent.ymax-a.y*r.pixelSize.y;let h,w=Math.abs(e.x-a.x)+Math.abs(e.y-a.y);if(w>1){const r=await R(e,a,P,m,y,z,t);z=r.point,w=r.error}if(c.elevationSource){let a=await g(t);if(a?.extent){let x=b(a,y,z);if(!x)return null;const m={x:x.x,y:x.y,z:x.z,hasZ:!0,spatialReference:y.spatialReference},g=new n(m);if(x){const m=i.project(g,t.currentCoveragePolygon.geometry?.spatialReference),w=s.updateElevation([m],t,!1);let R;R=w instanceof Promise?await w:w,g.z=x.z=R[0].z;const P=await s.transformPoints([4===c.cameraOrientation?.type?o.webMercatorToGeographic(g):g],t);if(!P[0])return null;P[0].x=P[0].x*r.pixelSize.x+r.extent.xmin,P[0].y=r.extent.ymax-P[0].y*r.pixelSize.y;let d=Math.abs(e.x-P[0].x)+Math.abs(e.y-P[0].y);if(h=x.z,d>1){let m=0;const g=async w=>{if(d>1){const R=w.width/10,P=w.height/10;if(!w||R<1||P<1)return z=u(z,y,p,h,c.cameraPitch,M,f),z;const v=[{x:x.x-R,y:x.y-P,spatialReference:y.spatialReference},{x:x.x+R,y:x.y-P,spatialReference:y.spatialReference},{x:x.x+R,y:x.y+P,spatialReference:y.spatialReference},{x:x.x-R,y:x.y+P,spatialReference:y.spatialReference}].map((e=>new n(e))),S=await s.updateElevation(v,t,!1);if(a=new l({rings:[[[S[0].x,S[0].y,S[0].z],[S[1].x,S[1].y,S[1].z],[S[2].x,S[2].y,S[2].z],[S[3].x,S[3].y,S[3].z],[S[0].x,S[0].y,S[0].z]]],spatialReference:y.spatialReference}),x=b(a,y,z),x){const l=i.project(new n({x:x.x,y:x.y,z:x.z,spatialReference:y.spatialReference}),t.currentCoveragePolygon.geometry?.spatialReference),w=await s.transformPoints([4===c.cameraOrientation?.type?o.webMercatorToGeographic(l):l],t);if(w[0])return w[0].x=w[0].x*r.pixelSize.x+r.extent.xmin,w[0].y=r.extent.ymax-w[0].y*r.pixelSize.y,d=Math.abs(e.x-w[0].x)+Math.abs(e.y-w[0].y),h=x.z,d<=1||8===m?u(z,y,p,h,c.cameraPitch,M,f):(m+=1,g(a.extent))}return u(z,y,p,y.z-c.cameraHeight,c.cameraPitch,M,f)}return u(z,y,p,y.z-c.cameraHeight,c.cameraPitch,M,f)};return g(a.extent)}return u(z,y,p,y.z-c.cameraHeight,c.cameraPitch,M,f)}return u(z,y,p,y.z-c.cameraHeight,c.cameraPitch,M,f)}}return u(z,y,p,y.z-c.cameraHeight,c.cameraPitch,M,f)})))}function u(e,t,i,c,s,y,l){const f=Math.sqrt((e.z-t.z)**2+(Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)/i)**2)*i,p=x.scaleWithFactor(r.sub(a.zeros(),[e.x,e.y,e.z],[t.x,t.y,t.z]),1/f,1/i);if(e.z<c||s+y/2<90){const a=Math.abs((t.z-c)/-p[2])*i,r=x.scaleAndAddWithFactor([t.x,t.y,t.z],p,a,i);e={x:r[0],y:r[1],z:r[2]}}else e.z=c;return e.spatialReference=t.spatialReference,e=new n(e),l&&(e=o.webMercatorToGeographic(e)),e}function h(e,t,i){const{feature:o}=e,{attributes:c}=o,s=2*Math.tan(c.verticalFieldOfView*f/2)*c.farDistance*i,y=2*Math.tan(c.horizontalFieldOfView*f/2)*c.farDistance*i,l=x.calculateRotationMatrix("HPR",[c.cameraHeading,c.cameraPitch,c.cameraRoll??0]),p=x.transformMat3([0,0,-1],l),z=x.scaleAndAddWithFactor([t.x,t.y,t.z],p,c.farDistance*i,i),m=x.transformMat3([0,1,0],l),u=x.transformMat3([1,0,0],l),h=x.scaleWithFactor(m,s/2,i),g=x.scaleWithFactor(u,y/2,i),w=r.sub(a.zeros(),h,g),R=r.add(a.zeros(),h,g);return[r.add(a.zeros(),z,w),r.add(a.zeros(),z,R),r.sub(a.zeros(),z,w),r.sub(a.zeros(),z,R)].map((e=>{const[a,r,i]=e;return new n({x:a,y:r,z:i,spatialReference:t.spatialReference})}))}function g(e){const{feature:t}=e,a=w(e);if(!a)return Promise.resolve(null);const r=t.attributes.location.spatialReference.isWGS84?new y({wkid:102100}):t.attributes.location.spatialReference;return s.updateElevation(a,e,!1).then((e=>{const t=e.map((e=>i.project(e,r)));return new l({hasZ:!0,rings:[t.map((e=>[e.x,e.y,e.z]))],spatialReference:r})}))}function w(e){if(!e.currentCoveragePolygon.geometry)return null;const{xmin:t,xmax:a,ymin:r,ymax:i,spatialReference:o}=e.currentCoveragePolygon.geometry.extent.toJSON();return[new n({x:t,y:i,spatialReference:o}),new n({x:a,y:i,spatialReference:o}),new n({x:a,y:r,spatialReference:o}),new n({x:t,y:r,spatialReference:o})]}async function R(e,t,a,r,i,c,y){const{feature:{attributes:l},imageProperties:f}=y;let p=Math.abs(e.x-t.x)+Math.abs(e.y-t.y);if(p>1)for(let z=0;z<9;z++)if(p>1){let t,m={x:e.x-p,y:e.y-p,z:1},u={x:e.x+p,y:e.y-p,z:1},h={x:e.x+p,y:e.y+p,z:1},g={x:e.x-p,y:e.y+p,z:1};m=x.projectiveTransform(m,a[0],a[1],a[2],a[3],{x:r[0].x,y:r[0].y,z:r[0].z},{x:r[1].x,y:r[1].y,z:r[1].z},{x:r[2].x,y:r[2].y,z:r[2].z},{x:r[3].x,y:r[3].y,z:r[3].z}),u=x.projectiveTransform(u,a[0],a[1],a[2],a[3],{x:r[0].x,y:r[0].y,z:r[0].z},{x:r[1].x,y:r[1].y,z:r[1].z},{x:r[2].x,y:r[2].y,z:r[2].z},{x:r[3].x,y:r[3].y,z:r[3].z}),h=x.projectiveTransform(h,a[0],a[1],a[2],a[3],{x:r[0].x,y:r[0].y,z:r[0].z},{x:r[1].x,y:r[1].y,z:r[1].z},{x:r[2].x,y:r[2].y,z:r[2].z},{x:r[3].x,y:r[3].y,z:r[3].z}),g=x.projectiveTransform(g,a[0],a[1],a[2],a[3],{x:r[0].x,y:r[0].y,z:r[0].z},{x:r[1].x,y:r[1].y,z:r[1].z},{x:r[2].x,y:r[2].y,z:r[2].z},{x:r[3].x,y:r[3].y,z:r[3].z}),m.spatialReference=i.spatialReference,u.spatialReference=i.spatialReference,h.spatialReference=i.spatialReference,g.spatialReference=i.spatialReference,t=4===l.cameraOrientation?.type?await s.transformPoints([o.webMercatorToGeographic(new n(m)),o.webMercatorToGeographic(new n(u)),o.webMercatorToGeographic(new n(h)),o.webMercatorToGeographic(new n(g))],y,!0):await s.transformPoints([new n(m),new n(u),new n(h),new n(g)],y,!0);const w=await Promise.all(t);w.forEach((e=>{e.z=0,e.x=e.x*f.pixelSize.x+f.extent.xmin,e.y=f.extent.ymax-e.y*f.pixelSize.y}));const R=x.projectiveTransform(e,w[0],w[1],w[2],w[3],m,u,h,g);let b;if(b=4===l.cameraOrientation?.type?(await s.transformPoints([o.webMercatorToGeographic(new n({x:R.x,y:R.y,z:R.z,spatialReference:i.spatialReference}))],y,!0))[0]:(await s.transformPoints([new n({x:R.x,y:R.y,z:R.z,spatialReference:i.spatialReference})],y,!0))[0],p=Math.abs(e.x-b.x)+Math.abs(e.y-b.y),p<=1||8===z){c=R;break}}return{error:p,point:c}}function b(e,t,a){const r={x:e.rings[0][0][0],y:e.rings[0][0][1],z:e.rings[0][0][2]},n={x:e.rings[0][1][0],y:e.rings[0][1][1],z:e.rings[0][1][2]},i={x:e.rings[0][1][0],y:e.rings[0][1][1],z:e.rings[0][1][2]},o={x:e.rings[0][2][0],y:e.rings[0][2][1],z:e.rings[0][2][2]},c=(o.z-i.z)*(n.y-r.y)-(o.y-i.y)*(n.z-r.z),s=-((o.z-i.z)*(n.x-r.x)-(n.z-r.z)*(o.x-i.x)),y=(o.y-i.y)*(n.x-r.x)-(n.y-r.y)*(o.x-i.x),l=-(c*r.x+s*r.y+y*r.z);return x.getPlaneLineIntersectionPoint(t.toJSON(),a,c,s,y,l)}e.transformPoints=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
