/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../geometry","../../request","../../core/Error","../../core/Logger","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../support/FieldsIndex","../support/fieldType","../../time/timeZoneUtils","../../geometry/SpatialReference"],(function(e,t,n,i,r,a,o,s,l,c,u,d,p,f,m){"use strict";const g=r.getLogger("esri.layers.graphics.sources.ogcfeature"),y="http://www.opengis.net/def/crs/",w=`${y}OGC/1.3/CRS84`;async function b(e,t,r={},a=5){const{links:o}=e,s=G(o,"items","application/geo+json")||G(o,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==s)throw new i("ogc-feature-layer:missing-items-page","Missing items url");const{data:l}=await n(s.href,{signal:r.signal,query:{limit:a,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});c.validateGeoJSON(l);const m=c.inferLayerProperties(l,{geometryType:t.geometryType}),y=t.fields||m.fields||[],w=null!=t.hasZ?t.hasZ:m.hasZ,b=m.geometryType,h=t.objectIdField||m.objectIdFieldName||"OBJECTID";let F=t.timeInfo;const I=y.find((({name:e})=>e===h));if(I)I.editable=!1,I.nullable=!1;else{if(!m.objectIdFieldType)throw new i("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");y.unshift({name:h,alias:h,type:"number"===m.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(h!==m.objectIdFieldName){const e=y.find((({name:e})=>e===m.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}y===m.fields&&m.unknownFields.length>0&&g.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:m.unknownFields}});for(const n of y){if(null==n.name&&(n.name=n.alias),null==n.alias&&(n.alias=n.name),"esriFieldTypeOID"!==n.type&&"esriFieldTypeGlobalID"!==n.type&&(n.editable=null==n.editable||!!n.editable,n.nullable=null==n.nullable||!!n.nullable),!n.name)throw new i("ogc-feature-layer:invalid-field-name","field name is missing",{field:n});if(!p.kebabDict.jsonValues.includes(n.type))throw new i("ogc-feature-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n})}if(F){var j;const e=new d(y);if(F.startTimeField){const t=e.get(F.startTimeField);t?(F.startTimeField=t.name,t.type="esriFieldTypeDate"):F.startTimeField=null}if(F.endTimeField){const t=e.get(F.endTimeField);t?(F.endTimeField=t.name,t.type="esriFieldTypeDate"):F.endTimeField=null}if(F.trackIdField){const t=e.get(F.trackIdField);t?F.trackIdField=t.name:(F.trackIdField=null,g.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:F}}))}(j=F).timeReference||(j.timeReference={timeZoneIANA:f.utc}),F.startTimeField||F.endTimeField||(g.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:F}}),F=null)}return{drawingInfo:b?u.createDrawingInfo(b):null,extent:C(e),geometryType:b,fields:y,hasZ:!!w,objectIdField:h,timeInfo:F}}async function h(e,t={}){const{links:r}=e,a=G(r,"data","application/json")||G(r,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==a)throw new i("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:s,signal:l}=t,{data:c}=await n(a.href,{signal:l,headers:{accept:"application/json"},query:{...s,token:o}});return c}async function F(e,t={}){const{links:r}=e,a=G(r,"conformance","application/json")||G(r,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(null==a)throw new i("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:s,signal:l}=t,{data:c}=await n(a.href,{signal:l,headers:{accept:"application/json"},query:{...s,token:o}});return c}async function I(e,t={}){const{apiKey:i,customParameters:r,signal:a}=t,{data:o}=await n(e,{signal:a,headers:{accept:"application/json"},query:{...r,token:i}});return o}async function j(e,t={}){const i="application/vnd.oai.openapi+json;version=3.0",r=G(e.links,"service-desc",i);if(null==r)return g.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:a,customParameters:o,signal:s}=t,{data:l}=await n(r.href,{signal:s,headers:{accept:i},query:{...o,token:a}});return l}function T(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t?.groups;if(!n)return null;const{authority:i,code:r}=n;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return m.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return m.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}}async function S(e,t,n){const i=await k(e,t,n);return s.convertToFeatureSet(i)}async function k(e,t,r){const{collection:u,layerDefinition:d,maxRecordCount:p,queryParameters:{apiKey:f,customParameters:g},spatialReference:y,supportedCrs:w}=e,{links:b}=u,h=G(b,"items","application/geo+json")||G(b,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==h)throw new i("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:F,num:I,start:j,timeExtent:T,where:S}=t;if(t.objectIds)throw new i("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const k=m.fromJSON(y),x=t.outSpatialReference??k,O=x.isWGS84?null:v(x,w),C=q(F,w),D=N(T),P=R(S),M=I??(null!=j&&void 0!==j?10:p),{data:W}=await n(h.href,{...r,query:{...g,...C,crs:O,datetime:D,query:P,limit:M,startindex:j,token:f},headers:{accept:"application/geo+json"}});let $=!1;if(W.links){const e=W.links.find((e=>"next"===e.rel));$=!!e}!$&&Number.isInteger(W.numberMatched)&&Number.isInteger(W.numberReturned)&&($=W.numberReturned<W.numberMatched);const{fields:Z,geometryType:L,hasZ:A,objectIdField:J}=d,K=c.createOptimizedFeatures(W,{geometryType:L,hasZ:A,objectIdField:J});if(!O&&x.isWebMercator)for(const n of K)if(null!=n.geometry&&null!=L){const e=s.convertToGeometry(n.geometry,L,A,!1);e.spatialReference=m.WGS84,n.geometry=s.convertFromGeometry(o.project(e,x))}for(const n of K)n.objectId=n.attributes[J];const z=O||!O&&x.isWebMercator?x.toJSON():a.WGS84,U=new l;return U.exceededTransferLimit=$,U.features=K,U.fields=Z,U.geometryType=L,U.hasZ=A,U.objectIdFieldName=J,U.spatialReference=z,U}function x(e){return null!=e&&"extent"===e.type}function v(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const r=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return r?`${y}${r}`:null}function O(e){if(null==e)return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function N(e){if(null==e)return null;const{start:t,end:n}=e;return`${null!=t?t.toISOString():".."}/${null!=n?n.toISOString():".."}`}function R(e){return null!=e&&e&&"1=1"!==e?e:null}function q(e,t){if(!x(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:O(e)};const i=v(n,t);return null!=i?{bbox:O(e),"bbox-crs":i}:n.isWebMercator?{bbox:O(o.project(e,m.WGS84))}:null}function C(e){const t=e.extent?.spatial;if(!t)return null;const n=t.bbox[0],i=4===n.length,r=n[0],a=n[1],o=i?void 0:n[2];return{xmin:r,ymin:a,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:o,zmax:i?void 0:n[5],spatialReference:m.WGS84.toJSON()}}function G(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}e.crsDefault=w,e.crsPrefix=y,e.getCollectionDefinition=b,e.getServerCollections=h,e.getServerConformance=F,e.getServerLandingPage=I,e.getServerOpenApi=j,e.getSpatialReferenceWkid=T,e.queryFeatureSetJSON=S,e.queryOptimizedFeatureSet=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
