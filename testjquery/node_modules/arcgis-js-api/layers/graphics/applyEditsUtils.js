/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Graphic","../../core/Error","../../core/Logger","../../core/unitUtils","../../core/urlUtils","../../geometry/projection","../../geometry/support/jsonUtils","./editingSupport"],(function(e,t,a,r,s,o,n,i,l){"use strict";async function d(e,t,a){const{geometry:r}=t,o={...t.attributes};if(null!=a&&"mesh"===r?.type){const{transformFieldRoles:t}=a,{origin:i,spatialReference:l,transform:d}=r,u=e.spatialReference;await n.initializeProjection(l,u);const c=n.project(i,u);if(o[t.originX]=c.x,o[t.originY]=c.y,o[t.originZ]=c.z??0,null!=d){const{translation:e,scale:a,rotation:n}=d,{vertexSpace:i}=r,c=i.isGeoreferenced?1:s.getMetersPerCartesianUnitForSR(l)/s.getMetersPerCartesianUnitForSR(u);o[t.translationX]=e[0]*c,o[t.translationY]=e[2]*c,o[t.translationZ]=-e[1]*c,o[t.scaleX]=a[0],o[t.scaleY]=a[2],o[t.scaleZ]=a[1],o[t.rotationX]=n[0],o[t.rotationY]=n[2],o[t.rotationZ]=-n[1],o[t.rotationDeg]=n[3]}return{attributes:o}}return null==r?{attributes:o}:"mesh"===r.type||"extent"===r.type?null:{geometry:r.toJSON(),attributes:o}}async function u(e,t){const a=await Promise.all((t.addAttachments??[]).map((t=>c(e,t)))),r=await Promise.all((t.updateAttachments??[]).map((t=>c(e,t)))),s=t.deleteAttachments??[];return a.length||r.length||s.length?{adds:a,updates:r,deletes:[...s]}:null}async function c(e,t){const{feature:a,attachment:r}=t,{globalId:s,name:n,contentType:i,data:l,uploadId:d}=r,u={globalId:s};if(a&&("attributes"in a?u.parentGlobalId=a.attributes?.[e.globalIdField]:a.globalId&&(u.parentGlobalId=a.globalId)),d)u.uploadId=d;else if(l){const e=await o.parseData(l);e&&(u.contentType=e.mediaType,u.data=e.data),l instanceof File&&(u.name=l.name)}return n&&(u.name=n),i&&(u.contentType=i),u}function p(e,t,a){if(!t||0===t.length)return[];if(a&&l.isFeatureIdentifierArrayWithGlobalId(t))return t.map((e=>e.globalId));if(l.isFeatureIdentifierArrayWithObjectId(t))return t.map((e=>e.objectId));const r=a?e.globalIdField:e.objectIdField;return r?t.map((e=>e.getAttribute(r))):[]}function g(e){const t=e?.assetMaps;if(t){for(const e of t.addResults)e.success||r.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${e.globalId}.`);for(const e of t.updateResults)e.success||r.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${e.globalId}.`)}const a=e?.attachments,s={addFeatureResults:e?.addResults?.map(m)??[],updateFeatureResults:e?.updateResults?.map(m)??[],deleteFeatureResults:e?.deleteResults?.map(m)??[],addAttachmentResults:a?.addResults?a.addResults.map(m):[],updateAttachmentResults:a?.updateResults?a.updateResults.map(m):[],deleteAttachmentResults:a?.deleteResults?a.deleteResults.map(m):[]};return e?.editMoment&&(s.editMoment=e.editMoment),s}function m(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new a("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}function f(e,a){return new t({attributes:e.attributes,geometry:i.fromJSON({...e.geometry,spatialReference:a})})}function b(e,t){return{adds:e?.adds?.map((e=>f(e,t)))||[],updates:e?.updates?.map((e=>({original:f(e[0],t),current:f(e[1],t)})))||[],deletes:e?.deletes?.map((e=>f(e,t)))||[],spatialReference:t}}function I(e){const t=e.details.raw,a=+t.code,r=+t.extendedCode;return 500===a&&(-2147217144===r||-2147467261===r)}e.createEditedFeatures=b,e.createFeatureEditResult=m,e.getAttachmentEditsJSON=u,e.getFeatureIds=p,e.getFeatureJSON=d,e.isProtectedOrPrivateVersionError=I,e.unpackEditResultData=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
