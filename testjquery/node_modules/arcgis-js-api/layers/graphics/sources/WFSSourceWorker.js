/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../core/asyncUtils","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","../data/FeatureStore","../data/projectionSupport","../data/QueryEngine","./geojson/geojson","./support/sourceUtils","../../ogc/wfsUtils","../../support/FieldsIndex","../../../time/timeZoneUtils"],(function(e,t,r,a,s,i,n,o,u,p,c,l,h,y){"use strict";class g{constructor(){this._queryEngine=null,this._customParameters=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,r){const{getFeatureUrl:s,getFeatureOutputFormat:i,fields:p,geometryType:c,featureType:g,objectIdField:d,customParameters:f}=e,{spatialReference:m,getFeatureSpatialReference:_}=l.getGetFeatureSpatialReference(s,g,e.spatialReference);this._featureType=g,this._customParameters=f,this._getFeatureUrl=s,this._getFeatureOutputFormat=i,this._getFeatureSpatialReference=_;try{await o.checkProjectionSupport(_,m)}catch{throw new t("unsupported-projection","Projection not supported",{inSpatialReference:_,outSpatialReference:m})}a.throwIfAborted(r);const F=h.fromLayerJSON({fields:p,dateFieldsTimeReference:p.some((e=>"esriFieldTypeDate"===e.type))?{timeZoneIANA:y.utc}:null}),w=await this._snapshotFeatures({fieldsIndex:F,geometryType:c,objectIdField:d,spatialReference:m},r.signal);return this._queryEngine=new u.QueryEngine({fieldsIndex:F,geometryType:c,hasM:!1,hasZ:!1,objectIdField:d,spatialReference:m,timeInfo:null,featureStore:new n({geometryType:c,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(w),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t("wfs-source:editing-not-supported","applyEdits() is not supported on WFSLayer")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(s){return this._customParameters=s,this._snapshotTask?.abort(),this._snapshotTask=e.createTask((e=>this._snapshotFeatures(this._queryEngine,e))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),a.isAbortError(e)||r.getLogger("esri.layers.WFSLayer").error(new t("wfs-layer:getfeature-error","An error occurred during the GetFeature request",{error:e}))})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures({objectIdField:e,geometryType:t,spatialReference:r,fieldsIndex:n},u){const h=await l.getFeature(this._getFeatureUrl??"",this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:u});p.validateGeoJSON(h,this._getFeatureSpatialReference.wkid),a.throwIfAborted(u);const y=p.createOptimizedFeatures(h,{geometryType:t,hasZ:!1,objectIdField:e});if(!s.equals(r,this._getFeatureSpatialReference))for(const a of y)null!=a.geometry&&(a.geometry=i.convertFromGeometry(o.project(i.convertToGeometry(a.geometry,t,!1,!1),this._getFeatureSpatialReference,r)));let g=1;for(const a of y){const t={};c.mixAttributes(n,t,a.attributes,!0),a.attributes=t,null==t[e]&&(a.objectId=t[e]=g++)}return y}}return g}));
