/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../request","../../../../core/has","../../../../core/promiseUtils","../../../../core/urlUtils","../../../support/arcgisLayerUrl","../../../../support/base64Utils","../../../../support/progressUtils"],(function(e,o,t,r,s,n,a,i){"use strict";const l=1e6,p=20*l,c=2e9,d=3;async function u({data:e,name:t,description:a},u,f){let h=null;try{const w=s.join(u,"uploads"),y=s.join(w,"info"),{data:j}=await o(y,{query:{f:"json"},responseType:"json"});r.throwIfAborted(f);const g=n.isHostedAgolService(u),A=j.maxUploadFileSize*l,b=g?c:A,I=g?Math.min(p,A):p;if(e.size>b)throw new Error("Data too large");const T=s.join(w,"register"),{data:P}=await o(T,{query:{f:"json",itemName:m(t),description:a},responseType:"json",method:"post"});if(r.throwIfAborted(f),!P.success)throw new Error("Registration failed");const{itemID:U}=P.item;h=s.join(w,U);const q=s.join(h,"uploadPart"),z=Math.ceil(e.size/I),M=new Array;for(let o=0;o<z;++o)M.push(e.slice(o*I,Math.min((o+1)*I,e.size)));const v=M.slice().reverse(),E=new Array,S=i.makeProgressManager(z,f?.onProgress,"uploadItem"),D=async()=>{for(;0!==v.length;){const e=M.length-v.length,t=v.pop(),s=new FormData,n=S.simulate(e,i.estimatedTransferTime(t.size));try{const n=t;s.append("f","json"),s.append("file",n),s.append("partId",`${e}`);const{data:a}=await o(q,{timeout:0,body:s,responseType:"json",method:"post"});if(r.throwIfAborted(f),!a.success)throw new Error("Part upload failed")}finally{n.remove()}}};for(let e=0;e<d&&0!==v.length;++e)E.push(D());await Promise.all(E);const x=s.join(h,"commit"),{data:F}=await o(x,{query:{f:"json",parts:M.map(((e,o)=>o)).join(",")},responseType:"json",method:"post"});if(r.throwIfAborted(f),!F.success)throw new Error("Commit failed");return F.item}catch(w){if(null!=h){const e=s.join(h,"delete");await o(e,{query:{f:"json"},responseType:"json",method:"post"})}throw w}}function m(e){return e.replaceAll("/","_").replaceAll("\\","_")}e.uploadItem=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
