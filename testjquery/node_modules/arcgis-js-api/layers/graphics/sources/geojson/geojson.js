/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../../core/date","../../../../core/Error","../../../../geometry/support/spatialReferenceUtils","../../OptimizedFeature","../../OptimizedGeometry","../../../support/fieldUtils"],(function(e,t,n,o,r,i,s){"use strict";const c={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function u(e){return c[e]}function*l(e){switch(e.type){case"Feature":yield e;break;case"FeatureCollection":for(const t of e.features)t&&(yield t)}}function*f(e){if(e)switch(e.type){case"Point":yield e.coordinates;break;case"LineString":case"MultiPoint":yield*e.coordinates;break;case"MultiLineString":case"Polygon":for(const t of e.coordinates)yield*t;break;case"MultiPolygon":for(const t of e.coordinates)for(const e of t)yield*e}}function*a(e,t={}){const{geometryType:n,objectIdField:o}=t;for(const s of e){const{geometry:e,properties:c,id:l}=s;if(e&&u(e.type)!==n)continue;const f=c||{};let a;o&&(a=f[o],null==l||a||(f[o]=a=l));const y=new r.OptimizedFeature(e?h(new i,e,t):null,f,null,a??void 0);yield y}}function y(e){for(const t of e)if(t.length>2)return!0;return!1}function d(e){return!g(e)}function p(e){return g(e)}function g(e){let t=0;for(let n=0;n<e.length;n++){const o=e[n],r=e[(n+1)%e.length];t+=o[0]*r[1]-r[0]*o[1]}return t<=0}function m(e){const t=e[0],n=e[e.length-1];return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]||e.push(t),e}function h(e,t,n){switch(t.type){case"LineString":return w(e,t,n);case"MultiLineString":return P(e,t,n);case"MultiPoint":return S(e,t,n);case"MultiPolygon":return F(e,t,n);case"Point":return b(e,t,n);case"Polygon":return G(e,t,n)}}function w(e,t,n){return M(e,t.coordinates,n),e}function P(e,t,n){for(const o of t.coordinates)M(e,o,n);return e}function S(e,t,n){return M(e,t.coordinates,n),e}function F(e,t,n){for(const o of t.coordinates){O(e,o[0],n);for(let t=1;t<o.length;t++)j(e,o[t],n)}return e}function b(e,t,n){return T(e,t.coordinates,n),e}function G(e,t,n){const o=t.coordinates;O(e,o[0],n);for(let r=1;r<o.length;r++)j(e,o[r],n);return e}function O(e,t,n){const o=m(t);d(o)?k(e,o,n):M(e,o,n)}function j(e,t,n){const o=m(t);p(o)?k(e,o,n):M(e,o,n)}function M(e,t,n){for(const o of t)T(e,o,n);e.lengths.push(t.length)}function k(e,t,n){for(let o=t.length-1;o>=0;o--)T(e,t[o],n);e.lengths.push(t.length)}function T(e,t,n){const[o,r,i]=t;e.coords.push(o,r),n.hasZ&&e.coords.push(i||0)}function N(e){switch(typeof e){case"string":return t.isISO8601Date(e)?"esriFieldTypeDate":"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function L(e,t=4326){if(!e)throw new n("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new n("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});const{crs:r}=e;if(!r)return;const i="string"==typeof r?r:"name"===r.type?r.properties.name:"EPSG"===r.type?r.properties.code:null,s=o.isWGS84({wkid:t})?new RegExp(".*(CRS84H?|4326)$","i"):new RegExp(`.*(${t})$`,"i");if(!i||!s.test(i))throw new n("geojson:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:r})}function z(e,t={}){const n=[],o=new Set,r=new Set;let i,c=!1,a=null,d=!1,{geometryType:p=null}=t,g=!1;for(const h of l(e)){const{geometry:e,properties:t,id:l}=h;if(!e||(p||(p=u(e.type)),u(e.type)===p)){if(!c){c=y(f(e))}if(d||(d=null!=l,d&&(i=typeof l,t&&(a=Object.keys(t).filter((e=>t[e]===l))))),t&&a&&d&&null!=l&&(a.length>1?a=a.filter((e=>t[e]===l)):1===a.length&&(a=t[a[0]]===l?a:[])),!g&&t){let e=!0;for(const i in t){if(o.has(i))continue;const c=t[i];if(null==c){e=!1,r.add(i);continue}const u=N(c);if("unknown"===u){r.add(i);continue}r.delete(i),o.add(i);const l=s.normalizeFieldName(i);l&&n.push({name:l,alias:i,type:u})}g=e}}}const m=s.normalizeFieldName(1===a?.length&&a[0]||null)??void 0;if(m)for(const u of n)if(u.name===m&&s.isNumericField(u)){u.type="esriFieldTypeOID";break}return{fields:n,geometryType:p,hasZ:c,objectIdFieldName:m,objectIdFieldType:i,unknownFields:Array.from(r)}}function I(e,t){return Array.from(a(l(e),t))}e.createOptimizedFeatures=I,e.getGeometryType=u,e.inferLayerProperties=z,e.validateGeoJSON=L,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
