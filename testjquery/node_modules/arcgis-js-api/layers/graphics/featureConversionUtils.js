/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/Logger","../../core/maybe","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],(function(e,t,o,n,r,s,u,i,l,c){"use strict";function a(e,t){return e?t?4:3:t?3:2}const f=o.getLogger("esri.layers.graphics.featureConversionUtils"),d={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryEnvelope:0},m=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s},h=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+2]},g=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+3]},y=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+2],e[o+3]=t[n+3]};function p(e,t,o,n){if(e){if(o)return t&&n?y:h;if(t&&n)return g}else if(t&&n)return h;return m}function F({scale:e,translate:t},o){return Math.round((o-t[0])/e[0])}function I({scale:e,translate:t},o){return Math.round((t[1]-o)/e[1])}function b(e,t){return G(e,t,0)}function M(e,t){return G(e,-t,1)}function G({scale:e,translate:t},o,n){return o*e[n]+t[n]}function T(e,t,o){return e?t?o?x(e):N(e):o?P(e):v(e):null}function v(e){const t=e.coords;return{x:t[0],y:t[1]}}function w(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function N(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function P(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function O(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function x(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function Z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function S(e,t,o,n){let r=v;o&&n?r=x:o?r=N:n&&(r=P);for(const s of t){const{geometry:t,attributes:o}=s,n=null!=t?r(t):null;e.push({attributes:o,geometry:n})}return e}function k(e,t){return e&&t?Z:e?z:t?O:w}function E(e,t,o,n,r){const s=k(o,n);for(const{geometry:u,attributes:l}of t){const t=null!=u?s(new c,u):null;e.push(new i.OptimizedFeature(t,l,null,r?l[r]:void 0))}return e}function q(e,t,o=k(null!=t.z,null!=t.m)){return o(e,t)}function V(e,t,o,n){for(const{geometry:r,attributes:s}of t)e.push({attributes:s,geometry:null!=r?j(r,o,n):null});return e}function j(e,t,o){if(null==e)return null;const n=a(t,o),r=[];for(let s=0;s<e.coords.length;s+=n){const t=[];for(let o=0;o<n;o++)t.push(e.coords[s+o]);r.push(t)}return t?o?{points:r,hasZ:t,hasM:o}:{points:r,hasZ:t}:o?{points:r,hasM:o}:{points:r}}function Y(e,t,o,n,r){const s=a(o,n);for(const{geometry:u,attributes:l}of t){const t=null!=u?A(new c,u,s):null;e.push(new i.OptimizedFeature(t,l,null,r?l[r]:void 0))}return e}function A(e,t,o=a(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const n=e.coords;let r=0;for(const s of t.points)for(let e=0;e<o;e++)n[r++]=s[e];return e}function _(e,t,o,n){for(const{geometry:r,attributes:s}of t)e.push({attributes:s,geometry:null!=r?L(r,o,n):null});return e}function L(e,t,o){if(!e)return null;const n=a(t,o),{coords:r,lengths:s}=e,u=[];let i=0;for(const l of s){const e=[];for(let t=0;t<l;t++){const t=[];for(let e=0;e<n;e++)t.push(r[i++]);e.push(t)}u.push(e)}return t?o?{paths:u,hasZ:t,hasM:o}:{paths:u,hasZ:t}:o?{paths:u,hasM:o}:{paths:u}}function R(e,t,o,n,r){const s=a(o,n);for(const{geometry:u,attributes:l}of t){const t=null!=u?U(new c,u,s):null;e.push(new i.OptimizedFeature(t,l,null,r?l[r]:void 0))}return e}function U(e,t,o=a(t.hasZ,t.hasM)){const{lengths:n,coords:r}=e;let s=0;for(const u of t.paths){for(const e of u)for(let t=0;t<o;t++)r[s++]=e[t];n.push(u.length)}return e}function B(e,t,o,n){for(const{geometry:r,attributes:s,centroid:u}of t){const t=null!=r?$(r,o,n):null;if(null!=u){const o=v(u);e.push({attributes:s,centroid:o,geometry:t})}else e.push({attributes:s,geometry:t})}return e}function $(e,t,o){if(!e)return null;const n=a(t,o),{coords:r,lengths:s}=e,u=[];let i=0;for(const l of s){const e=[];for(let t=0;t<l;t++){const t=[];for(let e=0;e<n;e++)t.push(r[i++]);e.push(t)}u.push(e)}return t?o?{rings:u,hasZ:t,hasM:o}:{rings:u,hasZ:t}:o?{rings:u,hasM:o}:{rings:u}}function C(e,t,o,n,r){for(const{geometry:s,centroid:u,attributes:l}of t){const t=null!=s?Q(new c,s,o,n):null,a=r?l[r]:void 0;null!=u?e.push(new i.OptimizedFeature(t,l,w(new c,u),a)):e.push(new i.OptimizedFeature(t,l,null,a))}return e}function Q(e,t,o=t.hasZ,n=t.hasM){return X(e,t.rings,o,n)}function X(e,t,o,n){const r=a(o,n),{lengths:s,coords:u}=e;let i=0;Ge(e);for(const l of t){for(const e of l)for(let t=0;t<r;t++)u[i++]=e[t];s.push(l.length)}return e}const D=[],H=[];function J(e,t,o,n,r){D[0]=e;const[s]=K(H,D,t,o,n,r);return Te(D),Te(H),s}function K(e,o,n,r,s,u){if(Te(e),!n){for(const t of o){const o=u?t.attributes[u]:void 0;e.push(new i.OptimizedFeature(null,t.attributes,null,o))}return e}switch(n){case"esriGeometryPoint":return E(e,o,r,s,u);case"esriGeometryMultipoint":return Y(e,o,r,s,u);case"esriGeometryPolyline":return R(e,o,r,s,u);case"esriGeometryPolygon":return C(e,o,r,s,u);default:f.error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`)),Te(e)}return e}function W(e,o,n,r,s,u){const i=e.length;switch(n){case"esriGeometryPoint":E(e,o,r,s,u);break;case"esriGeometryMultipoint":Y(e,o,r,s,u);break;case"esriGeometryPolyline":R(e,o,r,s,u);break;case"esriGeometryPolygon":C(e,o,r,s,u);break;default:f.error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`))}for(let t=0;t<o.length;t++)e[t+i].geometryType=n,e[t+i].insertAfter=o[t].insertAfter,e[t+i].groupId=o[t].groupId;return e}function ee(e,t,o,n){H[0]=e,re(D,H,t,o,n);const r=D[0];return Te(D),Te(H),r}function te(e,o,n){if(null==e)return null;const r=new c;if("hasZ"in e&&null==o&&(o=e.hasZ),"hasM"in e&&null==n&&(n=e.hasM),u.isPoint(e)){return k(null!=o?o:null!=e.z,null!=n?n:null!=e.m)(r,e)}return u.isPolygon(e)?Q(r,e,o,n):u.isPolyline(e)?U(r,e,a(o,n)):u.isMultipoint(e)?A(r,e,a(o,n)):void f.error("convertFromGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${e}'`))}function oe(e,o,n,r){const s=e&&("coords"in e?e:e.geometry);if(null==s)return null;switch(o){case"esriGeometryPoint":{let e=v;return n&&r?e=x:n?e=N:r&&(e=P),e(s)}case"esriGeometryMultipoint":return j(s,n,r);case"esriGeometryPolyline":return L(s,n,r);case"esriGeometryPolygon":return $(s,n,r);default:return f.error("convertToGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${o}'`)),null}}function ne(e,t){for(const o of t)e.push({attributes:o.attributes});return e}function re(e,o,n,r,s){if(Te(e),null==n)return ne(e,o);switch(n){case"esriGeometryPoint":return S(e,o,r,s);case"esriGeometryMultipoint":return V(e,o,r,s);case"esriGeometryPolyline":return _(e,o,r,s);case"esriGeometryPolygon":return B(e,o,r,s);default:f.error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`))}return e}function se(e){const{objectIdFieldName:t,spatialReference:o,transform:n,fields:r,hasM:s,hasZ:u,features:i,geometryType:l,exceededTransferLimit:c,uniqueIdField:a,queryGeometry:f,queryGeometryType:d}=e,m={features:re([],i,l,u,s),fields:r,geometryType:l,objectIdFieldName:t,spatialReference:o,uniqueIdField:a,queryGeometry:oe(f,d,!1,!1)};return n&&(m.transform=n),c&&(m.exceededTransferLimit=c),s&&(m.hasM=s),u&&(m.hasZ=u),m}function ue(e,o){const n=new l,{hasM:r,hasZ:s,features:u,objectIdFieldName:i,spatialReference:c,geometryType:a,exceededTransferLimit:d,transform:m,fields:h}=e;return h&&(n.fields=h),n.geometryType=a??null,n.objectIdFieldName=i??o??null,n.spatialReference=c??null,n.objectIdFieldName?(u&&K(n.features,u,a,s,r,n.objectIdFieldName),d&&(n.exceededTransferLimit=d),r&&(n.hasM=r),s&&(n.hasZ=s),m&&(n.transform=m),n):(f.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function ie(e){const{transform:t,features:o,hasM:n,hasZ:r}=e;if(!t)return e;for(const s of o)null!=s.geometry&&ge(s.geometry,s.geometry,n,r,t),null!=s.centroid&&ge(s.centroid,s.centroid,n,r,t);return e.transform=null,e}function le(e,t){const{geometryType:o,features:n,hasM:r,hasZ:s}=t;if(!e)return t;for(let u=0;u<n.length;u++){const t=n[u],i=t.weakClone();i.geometry=new c,ce(i.geometry,t.geometry,r,s,o,e),t.centroid&&(i.centroid=new c,ce(i.centroid,t.centroid,r,s,"esriGeometryPoint",e)),n[u]=i}return t.transform=e,t}function ce(e,t,o,n,r,s,u=o,i=n){if(Ge(e),!t?.coords.length)return null;const l=d[r],{coords:c,lengths:f}=t,m=a(o,n),h=a(o&&u,n&&i),g=p(o,n,u,i);if(!f.length)return g(e.coords,c,0,0,F(s,c[0]),I(s,c[1])),Ge(e,m,0),e;let y,b,M,G,T=0,v=0,w=v;for(const a of f){if(a<l)continue;let t=0;v=w,M=y=F(s,c[T]),G=b=I(s,c[T+1]),g(e.coords,c,v,T,M,G),t++,T+=m,v+=h;for(let o=1;o<a;o++,T+=m)M=F(s,c[T]),G=I(s,c[T+1]),M===y&&G===b||(g(e.coords,c,v,T,M-y,G-b),v+=h,t++,y=M,b=G);t>=l&&(e.lengths.push(t),w=v)}return Te(e.coords,w),e.coords.length?e:null}function ae(e,t,o,n,r,s,u=o,i=n){if(Ge(e),!t?.coords.length)return null;const l=d[r],{coords:c,lengths:f}=t,m=a(o,n),h=a(o&&u,n&&i),g=p(o,n,u,i);if(!f.length)return g(e.coords,c,0,0,c[0],c[1]),Ge(e,m,0),e;let y=0;const F=s*s;for(const a of f){if(a<l){y+=a*m;continue}const t=e.coords.length/h,o=y,n=y+(a-1)*m;g(e.coords,c,e.coords.length,o,c[o],c[o+1]),de(e.coords,c,m,F,g,o,n),g(e.coords,c,e.coords.length,n,c[n],c[n+1]);const r=e.coords.length/h-t;r>=l?e.lengths.push(r):Te(e.coords,t*h),y+=a*m}return e.coords.length?e:null}function fe(e,t,o,n){const r=e[t],s=e[t+1],u=e[o],i=e[o+1],l=e[n],c=e[n+1];let a=u,f=i,d=l-a,m=c-f;if(0!==d||0!==m){const e=((r-a)*d+(s-f)*m)/(d*d+m*m);e>1?(a=l,f=c):e>0&&(a+=d*e,f+=m*e)}return d=r-a,m=s-f,d*d+m*m}function de(e,t,o,n,r,s,u){let i,l=n,c=0;for(let a=s+o;a<u;a+=o)i=fe(t,a,s,u),i>l&&(c=a,l=i);l>n&&(c-s>o&&de(e,t,o,n,r,s,c),r(e,t,e.length,c,t[c],t[c+1]),u-c>o&&de(e,t,o,n,r,c,u))}function me(e,t,o,n){if(!t?.coords?.length)return null;const u=a(o,n);let i=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=u){const o=e[t],n=e[t+1];i=Math.min(i,o),c=Math.max(c,o),l=Math.min(l,n),f=Math.max(f,n)}}return r.is(e)?r.fromRectValues(e,i,l,c,f):s.fromValues(i,l,c,f,e),e}function he(e,t,o,n){const r=a(o,n),{lengths:s,coords:u}=t;let i=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY,d=0;for(const a of s){let e=u[d],t=u[d+1];i=Math.min(e,i),l=Math.min(t,l),c=Math.max(e,c),f=Math.max(t,f),d+=r;for(let o=1;o<a;o++,d+=r){const o=u[d],n=u[d+1];e+=o,t+=n,o<0&&(i=Math.min(i,e)),o>0&&(c=Math.max(c,e)),n<0?l=Math.min(l,t):n>0&&(f=Math.max(f,t))}}return e[0]=i,e[1]=l,e[2]=c,e[3]=f,e}function ge(e,t,o,r,s){const{coords:u,lengths:i}=t,l=a(o,r);if(!u.length)return e!==t&&Ge(e),e;n.assertIsSome(s);const{originPosition:c,scale:f,translate:d}=s,m=ve;m.originPosition=c;const h=m.scale;h[0]=f[0]??1,h[1]=-(f[1]??1),h[2]=f[2]??1,h[3]=f[3]??1;const g=m.translate;if(g[0]=d[0]??0,g[1]=d[1]??0,g[2]=d[2]??0,g[3]=d[3]??0,!i.length){for(let t=0;t<l;++t)e.coords[t]=G(m,u[t],t);return e!==t&&Ge(e,l,0),e}let y=0;for(let n=0;n<i.length;n++){const t=i[n];e.lengths[n]=t;for(let n=0;n<l;++n)e.coords[y+n]=G(m,u[y+n],n);let o=e.coords[y],r=e.coords[y+1];y+=l;for(let n=1;n<t;n++,y+=l){o+=u[y]*h[0],r+=u[y+1]*h[1],e.coords[y]=o,e.coords[y+1]=r;for(let t=2;t<l;++t)e.coords[y+t]=G(m,u[y+t],t)}}return e!==t&&Ge(e,u.length,i.length),e}function ye(e,t,o,n,r,s){if(Ge(e),e.lengths.push(...t.lengths),o===r&&n===s)for(let u=0;u<t.coords.length;u++)e.coords.push(t.coords[u]);else{const u=a(o,n),i=p(o,n,r,s),l=t.coords;for(let t=0;t<l.length;t+=u)i(e.coords,l,e.coords.length,t,l[t],l[t+1])}return e}function pe(e,t,o,n,r){if(!t?.coords?.length)return null;const s=d[o],{coords:u,lengths:i}=t,l=p(n,r,n,r),c=a(n,r);let f=0,m=0,h=0,g=0;for(const a of i){m=g,l(e.coords,u,m,f,u[f],u[f+1]),f+=c;let t=u[f],o=u[f+1],n=t,r=o,i=o/t;m+=c,l(e.coords,u,m,f,n,r),f+=c;for(let s=2;s<a;s++){t=u[f],o=u[f+1];const s=o/t,a=i===s||!isFinite(i)&&!isFinite(s),d=a&&isFinite(s)?i>=0&&s>=0||i<=0&&s<=0:r>=0&&o>=0||r<=0&&o<=0;a&&d?(n+=t,r+=o):(n=t,r=o,m+=c),l(e.coords,u,m,f,n,r),f+=c,i=s}m+=c;const d=(m-g)/c;d>=s&&(e.lengths[h]=d,g=m,h++)}return e.coords.length>g&&(e.coords.length=g),e.lengths.length>h&&(e.lengths.length=h),e.coords.length&&e.lengths.length?e:null}function Fe(e,t,o,n){let r=0,s=e[n*t],u=e[n*(t+1)];for(let i=1;i<o;i++){const o=s+e[n*(t+i)],l=u+e[n*(t+i)+1],c=(o-s)*(l+u);s=o,u=l,r+=c}return.5*r}function Ie(e,t){const{coords:o,lengths:n}=e;let r=0,s=0;for(let u=0;u<n.length;u++){const e=n[u];s+=Fe(o,r,e,t),r+=e}return Math.abs(s)}function be(e,t){const o=e.clone(),n=e.coords,r=e.lengths;let s=0;for(let u=0;u<r.length;u++){const e=r[u];let i=n[t*s],l=n[t*s+1];for(let r=1;r<e;r++){const e=n[t*(s+r)],u=n[t*(s+r)+1],c=e-i,a=u-l;o.coords[t*(s+r)]=c,o.coords[t*(s+r)+1]=a,i=e,l=u}s+=e}return o}function Me(e,t){if(null==e)return null;const o=e.clone(),n=e.coords,r=e.lengths;let s=0;for(let u=0;u<r.length;u++){const e=r[u];let i=n[t*s],l=n[t*s+1];for(let r=1;r<e;r++){const e=i+n[t*(s+r)],u=l+n[t*(s+r)+1];o.coords[t*(s+r)]=e,o.coords[t*(s+r)+1]=u,i=e,l=u}s+=e}return o}function Ge(e,t=0,o=0){Te(e.lengths,o),Te(e.coords,t)}function Te(e,t=0){e.length!==t&&(e.length=t)}const ve={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};e.convertFromFeature=J,e.convertFromFeatureSet=ue,e.convertFromFeatures=K,e.convertFromGeometry=te,e.convertFromGraphics=W,e.convertFromMultipoint=A,e.convertFromMultipointFeatures=Y,e.convertFromNestedArray=X,e.convertFromPoint=q,e.convertFromPointFeatures=E,e.convertFromPolygon=Q,e.convertFromPolyline=U,e.convertFromPolylineFeatures=R,e.convertToFeature=ee,e.convertToFeatureSet=se,e.convertToFeatures=re,e.convertToGeometry=oe,e.convertToMultipoint=j,e.convertToMultipointFeatures=V,e.convertToPoint=T,e.convertToPolygon=$,e.convertToPolyline=L,e.deltaDecodeGeometry=Me,e.deltaEncodeGeometry=be,e.generalizeOptimizedGeometry=ae,e.getBoundsOptimizedGeometry=me,e.getQuantizedArea=Ie,e.getQuantizedBoundsOptimizedGeometry=he,e.getSignedQuantizedRingArea=Fe,e.quantizeOptimizedFeatureSet=le,e.quantizeOptimizedGeometry=ce,e.quantizeX=F,e.quantizeY=I,e.removeCollinearVectices=pe,e.removeZMValues=ye,e.unquantizeOptimizedFeatureSet=ie,e.unquantizeOptimizedGeometry=ge,e.unquantizeValue=G,e.unquantizeX=b,e.unquantizeY=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
