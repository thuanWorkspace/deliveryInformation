/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["./attributeSupport","./geometryUtils","../../support/fieldUtils","../../../smartMapping/statistics/support/utils","../../../statistics/utils","../../../support/arcadeOnDemand"],(function(e,t,i,s,a,l){"use strict";class r{constructor(t,i,s){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues??!1,this.fieldsIndex=s,this.featureAdapter=i;const a=t.outFields;if(a&&!a.includes("*")){this.outFields=a;let t=0;for(const i of a){const a=e.getExpressionFromFieldName(i),l=this.fieldsIndex.get(a),r=l?null:e.getWhereClause(a,s),n=l?l.name:e.getAliasFromFieldName(i)||"FIELD_EXP_"+t++;this._fieldDataCache.set(i,{alias:n,clause:r})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach((e=>this.getAttributes(e))),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(t,i,s){const a=s?s.name:i;let l=null;return this._fieldDataCache.has(a)?l=this._fieldDataCache.get(a)?.clause:s||(l=e.getWhereClause(i,this.fieldsIndex),this._fieldDataCache.set(a,{alias:a,clause:l})),s?this.featureAdapter.getAttribute(t,a):l?.calculateValue(t,this.featureAdapter)}getDataValues(e,t,l=!0){const r=t.normalizationType,n=t.normalizationTotal,u=this.fieldsIndex.get(t.field),d=i.isDateOnlyField(u)||i.isTimestampOffsetField(u),c=i.isTimeOnlyField(u);return e.map((e=>{let i=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2?(i=`${a.processNullValue(i)}${t.fieldDelimiter}${a.processNullValue(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(i=`${i}${t.fieldDelimiter}${a.processNullValue(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)):"string"==typeof i&&l&&(d?i=i?new Date(i).getTime():null:c&&(i=i?s.timeOnlyToMilliseconds(i):null)),r&&Number.isFinite(i)){const s="field"===r&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;i=a.getNormalizedValue(i,r,s,n)}return i}))}async getExpressionValues(e,i,s,a,r){const{arcadeUtils:n}=await l.loadArcade(),u=n.hasGeometryOperations(i);u&&await n.enableGeometryOperations();const d=n.createFunction(i),c=n.getViewInfo(s),o={fields:this.fieldsIndex.fields};return e.map((e=>{const i={attributes:this.featureAdapter.getAttributes(e),layer:o,geometry:u?{...t.getGeometry(a.geometryType,a.hasZ,a.hasM,this.featureAdapter.getGeometry(e)),spatialReference:s?.spatialReference}:null},l=n.createExecContext(i,c,r);return n.executeFunction(d,l)}))}validateItem(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:e.getWhereClause(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testFeature(t,this.featureAdapter)??!1}validateItems(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:e.getWhereClause(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testSet(t,this.featureAdapter)??!1}_processAttributesForOutFields(e){const t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);const i={};for(const s of t){const{alias:t,clause:a}=this._fieldDataCache.get(s);i[t]=a?a.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return i}_processAttributesForDistinctValues(e){if(null==e||!this.returnDistinctValues)return e;const t=this.outFields,i=[];if(t)for(const l of t){const{alias:t}=this._fieldDataCache.get(l);i.push(e[t])}else for(const l in e)i.push(e[l]);const s=`${(t||["*"]).join(",")}=${i.join(",")}`;let a=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++a),a>1?null:e}}return r}));
