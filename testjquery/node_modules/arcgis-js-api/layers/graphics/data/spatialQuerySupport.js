/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/Error","../../../geometry/support/contains","../../../geometry/support/intersects","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","../contains","../featureConversionUtils","../OptimizedGeometry","./geometryUtils","./projectionSupport"],(function(e,t,r,i,n,o,s,l,a,p,u,y){"use strict";const c="unsupported-query",m={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},R={spatialRelationship:{esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},queryGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},layerGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1}};function S(e){return null!=e&&!0===R.spatialRelationship[e]}function f(e){return null!=e&&!0===R.queryGeometry[o.getJsonType(e)]}function g(e){return null!=e&&!0===R.layerGeometry[e]}function G(){return new Promise(((t,r)=>e(["../../../geometry/geometryEngineJSON"],t,r)))}function P(e,t,r,s,y){if(o.isPolygon(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=a.convertFromPolygon(new p,t,!1,!1);return Promise.resolve((t=>l.polygonContainsPoint(e,!1,!1,t)))}if(o.isPolygon(t)&&"esriGeometryMultipoint"===r){const r=a.convertFromPolygon(new p,t,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>l.polygonContainsMultipoint(r,!1,!1,e,s,y)))}if(o.isExtent(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>i.extentContainsPoint(t,u.getGeometry(r,s,y,e))));if(o.isExtent(t)&&"esriGeometryMultipoint"===r&&"esriSpatialRelContains"===e)return Promise.resolve((e=>i.extentContainsMultipoint(t,u.getGeometry(r,s,y,e))));if(o.isExtent(t)&&"esriSpatialRelIntersects"===e){const e=n.getExtentIntersector(r);return Promise.resolve((i=>e(t,u.getGeometry(r,s,y,i))))}return G().then((i=>{const n=i[m[e]].bind(null,t.spatialReference,t);return e=>n(u.getGeometry(r,s,y,e))}))}async function h(e,t,i){const{spatialRel:n,geometry:o}=e;if(o){if(!S(n))throw new r(c,"Unsupported query spatial relationship",{query:e});if(s.isValid(o.spatialReference)&&s.isValid(i)){if(!f(o))throw new r(c,"Unsupported query geometry type",{query:e});if(!g(t))throw new r(c,"Unsupported layer geometry type",{query:e});if(e.outSR)return y.checkProjectionSupport(e.geometry?.spatialReference,e.outSR)}}}function v(e){if(o.isExtent(e))return!0;if(o.isPolygon(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}t.canQueryWithRBush=v,t.checkSpatialQuerySupport=h,t.getSpatialQueryOperator=P,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
