/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/arrayUtils","../../../core/promiseUtils","../../../geometry/projection","../../../geometry/geometryAdapters/json","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils"],(function(e,t,n,s,r,i,o){"use strict";const a=[0,0];function c(e,t){if(!t)return null;if("x"in t){const n={x:0,y:0};return[n.x,n.y]=e(t.x,t.y,a),null!=t.z&&(n.z=t.z),null!=t.m&&(n.m=t.m),n}if("xmin"in t){const n={xmin:0,ymin:0,xmax:0,ymax:0};return[n.xmin,n.ymin]=e(t.xmin,t.ymin,a),[n.xmax,n.ymax]=e(t.xmax,t.ymax,a),t.hasZ&&(n.zmin=t.zmin,n.zmax=t.zmax,n.hasZ=!0),t.hasM&&(n.mmin=t.mmin,n.mmax=t.mmax,n.hasM=!0),n}return"rings"in t?{rings:l(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:l(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:u(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:null}function l(e,t){const n=[];for(const s of e)n.push(u(s,t));return n}function u(e,t){const n=[];for(const s of e){const e=t(s[0],s[1],[0,0]);n.push(e),s.length>2&&e.push(s[2]),s.length>3&&e.push(s[3])}return n}async function m(e,n){if(!e||!n)return;const r=Array.isArray(e)?e.map((e=>null!=e.geometry?e.geometry.spatialReference:null)).filter(t.isSome):[e];await s.initializeProjection(r.map((e=>({source:e,dest:n}))))}const p=c.bind(null,o.lngLatToXY),h=c.bind(null,o.xyToLngLat);function f(e,t,n,a){if(!e)return e;if(n||(n=t,t=e.spatialReference),!i.isValid(t)||!i.isValid(n)||i.equals(t,n))return e;if(o.canProject(t,n)){const t=i.isWebMercator(n)?p(e):h(e);return t.spatialReference=n,t}return s.projectMany(r.jsonAdapter,[e],t,n,null,a)[0]}class y{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(e,t,s,r){if(!e?.length||!t||!s||i.equals(t,s))return e;const o={geometries:e,inSpatialReference:t,outSpatialReference:s,geographicTransformation:r,resolve:n.createResolver()};return this._jobs.push(o),this._timer??(this._timer=setTimeout(this._process,10)),o.resolve.promise}_process(){this._timer=null;const e=this._jobs.shift();if(!e)return;const{geometries:t,inSpatialReference:n,outSpatialReference:a,resolve:c,geographicTransformation:l}=e;o.canProject(n,a)?i.isWebMercator(a)?c(t.map(p)):c(t.map(h)):c(s.projectMany(r.jsonAdapter,t,n,a,l,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}}const g=new y;function x(e,t,n,s){return g.push(e,t,n,s)}e.checkProjectionSupport=m,e.project=f,e.projectMany=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
