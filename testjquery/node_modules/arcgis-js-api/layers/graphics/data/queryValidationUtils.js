/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","./attributeSupport","./projectionSupport","./spatialQuerySupport","../../../support/arcadeOnDemand"],(function(e,t,i,s,r,a){"use strict";const o="unsupported-query";async function n(e,{fieldsIndex:i,geometryType:a,spatialReference:n,availableFields:u}){if((e.distance??0)<0||null!=e.geometryPrecision||e.multipatchOption&&"xyFootprint"!==e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new t(o,"Unsupported query options",{query:e});return l(i,u,e),c(i,u,e),Promise.all([r.checkSpatialQuerySupport(e,a,n),s.checkProjectionSupport(n,e.outSR)]).then((()=>e))}function l(e,s,r){const{outFields:a,orderByFields:n,returnDistinctValues:l,outStatistics:u}=r,c=u?u.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())).filter(Boolean):[];if(n&&n.length>0){const t=" asc",a=" desc",o=n.map((e=>{const i=e.toLowerCase();return i.includes(t)?i.split(t)[0]:i.includes(a)?i.split(a)[0]:e})).filter((e=>!c.includes(e)));i.validateFields(e,s,o,{expressionName:"orderByFields",query:r})}if(a&&a.length>0)i.validateFields(e,s,a,{expressionName:"outFields",query:r});else if(l)throw new t(o,"outFields should be specified for returnDistinctValues",{query:r});i.validateWhere(e,s,r.where,r)}const u=new Set([...i.numericFieldTypes,...i.allDateAndTimeFieldTypes]);function c(e,s,r){const{outStatistics:a,groupByFieldsForStatistics:n,having:l}=r,c=n?.length,d=a?.length;if(l){if(!c||!d)throw new t(o,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:r});i.validateHaving(e,s,l,a,r)}if(d){if(!y(a))return;const l=a.map((e=>e.onStatisticField)).filter(Boolean);i.validateFields(e,s,l,{expressionName:"onStatisticFields",query:r}),c&&i.validateFields(e,s,n,{expressionName:"groupByFieldsForStatistics",query:r});for(const n of a){const{onStatisticField:a,statisticType:l}=n;if(("percentile_disc"===l||"percentile_cont"===l)&&"statisticParameters"in n){const{statisticParameters:e}=n;if(!e)throw new t(o,"statisticParameters should be set for percentile type",{definition:n,query:r})}else e.get(a)&&"count"!==l&&"min"!==l&&"max"!==l&&i.validateFields(e,s,[a],{expressionName:`outStatistics with '${l}' statistic type`,allowedFieldTypes:u,query:r})}}}async function d(e,i,{fieldsIndex:a,geometryType:n,spatialReference:u,availableFields:c}){if((e.distance??0)<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new t(o,"Unsupported query options",{query:e});return l(a,c,e),Promise.all([p(a,c,i,e),r.checkSpatialQuerySupport(e,n,u),s.checkProjectionSupport(u,e.outSR)]).then((()=>e))}async function p(e,s,r,n){let l=[];if(r.valueExpression){const{arcadeUtils:e}=await a.loadArcade();l=e.extractFieldNames(r.valueExpression)}if(r.field&&l.push(r.field),r.field2&&l.push(r.field2),r.field3&&l.push(r.field3),r.normalizationField&&l.push(r.normalizationField),!l.length&&!r.valueExpression)throw new t(o,"field or valueExpression is required",{params:r});i.validateFields(e,s,l,{expressionName:"statistics",query:n})}function y(e){return null!=e&&e.every((e=>"exceedslimit"!==e.statisticType))}e.validateQuery=n,e.validateStatisticsQuery=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
