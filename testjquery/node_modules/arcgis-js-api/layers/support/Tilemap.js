/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../request","../../core/arrayUtils","../../core/Error","../../core/lang","../../core/typedArrayUtil","../../geometry/support/UintArray"],(function(t,i,e,a,o,l,n){"use strict";class r{constructor(t){this._validateJSON(t);const{location:i,data:e}=t;this.location=Object.freeze(o.clone(i));const a=this.location.width,r=this.location.height;let s=!0,h=!0;const c=Math.ceil(a*r/32),d=n.newUintArray(c);let m=0;for(let o=0;o<e.length;o++){const t=o%32;e[o]?(h=!1,d[m]|=1<<t):s=!1,31===t&&++m}h?(this._availability="unavailable",this.byteSize=40):s?(this._availability="available",this.byteSize=40):(this._availability=d,this.byteSize=40+l.estimateSize(d))}getAvailability(t,i){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const e=(t-this.location.top)*this.location.width+(i-this.location.left),a=e%32,o=e>>5,l=this._availability;return o<0||o>l.length?"unknown":l[o]&1<<a?"available":"unavailable"}static fromDefinition(t,o){const l=t.service.request||i,{row:n,col:s,width:c,height:d}=t,m={query:{f:"json"}};return o=o?{...m,...o}:m,l(h(t),o).then((t=>t.data)).catch((t=>{if(t&&t.details&&422===t.details.httpStatus)return{location:{top:n,left:s,width:c,height:d},valid:!0,data:e.constant(c*d,0)};throw t})).then((t=>{if(t.location&&(t.location.top!==n||t.location.left!==s||t.location.width!==c||t.location.height!==d))throw new a("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:n,left:s,width:c,height:d}});return r.fromJSON(t)}))}static fromJSON(t){return Object.freeze(new r(t))}_validateJSON(t){if(!t?.location)throw new a("tilemap:missing-location","Location missing from tilemap response");if(!1===t.valid)throw new a("tilemap:invalid","Tilemap response was marked as invalid");if(!t.data)throw new a("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(t.data))throw new a("tilemap:data-mismatch","Data must be an array of numbers");if(t.data.length!==t.location.width*t.location.height)throw new a("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}function s(t){return`${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}function h(t){let i;if(t.service.tileServers?.length){const e=t.service.tileServers;i=`${e&&e.length?e[t.row%e.length]:t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}else i=`${t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;const e=t.service.query;return e&&(i=`${i}?${e}`),i}t.Tilemap=r,t.tilemapDefinitionId=s,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
