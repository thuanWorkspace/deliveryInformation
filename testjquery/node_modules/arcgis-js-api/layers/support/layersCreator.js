/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/Collection","../../core/has","./LayerLoadContext","./lazyLayerLoader","../../portal/PortalItem","../../portal/support/featureCollectionUtils","../../portal/support/portalLayers","../../renderers/support/styleUtils"],(function(e,a,r,y,t,i,L,o,n){"use strict";async function l(e,a,r){if(!a)return;const y=[];for(const i of a)y.push(G(i,r));const t=await Promise.allSettled(y);for(const i of t)"rejected"===i.status||i.value&&e.add(i.value)}const c={ArcGISDimensionLayer:"DimensionLayer",ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",PointCloudLayer:"PointCloudLayer",ArcGISSceneServiceLayer:"SceneLayer",IntegratedMeshLayer:"IntegratedMeshLayer",OGCFeatureLayer:"OGCFeatureLayer",BuildingSceneLayer:"BuildingSceneLayer",ArcGISTiledElevationServiceLayer:"ElevationLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",GroupLayer:"GroupLayer",GeoJSON:"GeoJSONLayer",WebTiledLayer:"WebTileLayer",CSV:"CSVLayer",VectorTileLayer:"VectorTileLayer",WFS:"WFSLayer",WMS:"WMSLayer",DefaultTileLayer:"TileLayer",KML:"KMLLayer",RasterDataLayer:"UnsupportedLayer",Voxel:"VoxelLayer",LineOfSightLayer:"LineOfSightLayer"},s={ArcGISTiledElevationServiceLayer:"ElevationLayer",DefaultTileLayer:"ElevationLayer",RasterDataElevationLayer:"UnsupportedLayer"},p={ArcGISFeatureLayer:"FeatureLayer"},u={ArcGISTiledMapServiceLayer:"TileLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",OpenStreetMap:"OpenStreetMapLayer",WebTiledLayer:"WebTileLayer",VectorTileLayer:"VectorTileLayer",ArcGISImageServiceLayer:"UnsupportedLayer",WMS:"UnsupportedLayer",ArcGISMapServiceLayer:"UnsupportedLayer",ArcGISSceneServiceLayer:"SceneLayer",DefaultTileLayer:"TileLayer"},S={ArcGISAnnotationLayer:"UnsupportedLayer",ArcGISDimensionLayer:"UnsupportedLayer",ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISStreamLayer:"StreamLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",BingMapsAerial:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",CSV:"CSVLayer",DefaultTileLayer:"TileLayer",GeoRSS:"GeoRSSLayer",GeoJSON:"GeoJSONLayer",GroupLayer:"GroupLayer",KML:"KMLLayer",MediaLayer:"MediaLayer",OGCFeatureLayer:"OGCFeatureLayer",OrientedImageryLayer:"OrientedImageryLayer",SubtypeGroupLayer:"SubtypeGroupLayer",VectorTileLayer:"VectorTileLayer",WFS:"WFSLayer",WMS:"WMSLayer",WebTiledLayer:"WebTileLayer"},d={ArcGISFeatureLayer:"FeatureLayer"},I={ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",OpenStreetMap:"OpenStreetMapLayer",VectorTileLayer:"VectorTileLayer",WebTiledLayer:"WebTileLayer",BingMapsAerial:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",WMS:"WMSLayer",DefaultTileLayer:"TileLayer"},M={...S,LinkChartLayer:"LinkChartLayer"},T={...d},g={...I};async function G(e,a){return f(await m(e,a),e,a)}async function f(e,a,r){const y=new e;return y.read(a,r.context),"group"===y.type&&("GroupLayer"===a.layerType?await w(y,a,r):b(a)?h(y,a,r.context):A(a)&&await k(y,a,r.context)),await n.loadStyleRenderer(y,r.context),y}async function m(e,a){const r=a.context,n=v(r);let l=e.layerType||e.type;!l&&a?.defaultLayerType&&(l=a.defaultLayerType);const c=n[l];let s=c?t.layerLookupMap[c]:t.layerLookupMap.UnknownLayer;if(b(e)){const a=r?.portal;if(e.itemId){const r=new i({id:e.itemId,portal:a});await r.load();const L=(await o.selectLayerClassPath(r,new y.LayerLoadContext)).className||"UnknownLayer";s=t.layerLookupMap[L]}}else"ArcGISFeatureLayer"===l?L.isMapNotesLayer(e)||L.isMarkupLayer(e)?s=t.layerLookupMap.MapNotesLayer:L.isRouteLayer(e)?s=t.layerLookupMap.RouteLayer:A(e)&&(s=t.layerLookupMap.GroupLayer):e.wmtsInfo?.url&&e.wmtsInfo.layerIdentifier?s=t.layerLookupMap.WMTSLayer:"WFS"===l&&"2.0.0"!==e.wfsInfo?.version&&(s=t.layerLookupMap.UnsupportedLayer);return s()}function A(e){if("ArcGISFeatureLayer"!==e.layerType||b(e))return!1;return(e.featureCollection?.layers?.length??0)>1}function b(e){return"Feature Collection"===e.type}function v(e){let a;switch(e.origin){case"web-scene":switch(e.layerContainerType){case"basemap":a=u;break;case"ground":a=s;break;case"tables":a=p;break;default:a=c}break;case"link-chart":switch(e.layerContainerType){case"basemap":a=g;break;case"tables":a=T;break;default:a=M}break;default:switch(e.layerContainerType){case"basemap":a=I;break;case"tables":a=d;break;default:a=S}}return a}async function w(e,r,y){const t=new a,i=l(t,Array.isArray(r.layers)?r.layers:[],y);try{try{if(await i,"group"===e.type)return e.layers.addMany(t),e}catch(L){e.destroy();for(const e of t)e.destroy();throw L}}catch(L){throw L}}function h(e,a,r){a.itemId&&(e.portalItem=new i({id:a.itemId,portal:r?.portal}),e.when((()=>{const y=y=>{const t=y.layerId;C(y,e,a,t,r);const i=a.featureCollection?.layers?.[t];i&&y.read(i,r)};e.layers?.forEach(y),e.tables?.forEach(y)})))}async function k(e,a,r){const y=t.layerLookupMap.FeatureLayer,i=await y(),L=a.featureCollection,o=L?.showLegend,n=L?.layers?.map(((y,t)=>{const L=new i;L.read(y,r);const n={...r,ignoreDefaults:!0};return C(L,e,a,t,n),null!=o&&L.read({showLegend:o},n),L}));e.layers.addMany(n??[])}function C(e,a,r,y,t){e.read({id:`${a.id}-sublayer-${y}`,visibility:r.visibleLayers?.includes(y)??!0},t)}e.populateGroupLayer=w,e.populateOperationalLayers=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
