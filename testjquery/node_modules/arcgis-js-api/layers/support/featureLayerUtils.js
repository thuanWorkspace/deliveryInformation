/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../kernel","../../symbols","../../core/asyncUtils","../../core/Error","../../core/jsonMap","../../core/sql","../../core/accessorSupport/extensions/serializableProperty/reader","./featureQueryAll","./layerUtils","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../rest/support/AttachmentQuery","../../rest/support/Query","../../rest/support/RelationshipQuery"],(function(e,t,r,n,a,o,s,i,u,c,l,d,p,y,f,h){"use strict";const m=new s.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function w(e,t,r,n){const a=await L(e);if(await b(e,t,n),!a.addAttachment)throw new o(n,"Layer source does not support addAttachment capability");return a.addAttachment(t,r)}function b(e,t,r){const{attributes:n}=t,{objectIdField:a}=e;return e.capabilities?.data?.supportsAttachment?t?n?a&&n[a]?Promise.resolve():Promise.reject(new o(r,`feature is missing the identifying attribute ${a}`)):Promise.reject(new o(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new o(r,"A feature is required to add/delete/update attachments")):Promise.reject(new o(r,"this layer doesn't support attachments"))}async function g(e,t,r,n,a){const s=await L(e);if(await b(e,t,a),!s.updateAttachment)throw new o(a,"Layer source does not support updateAttachment capability");return s.updateAttachment(t,r,n)}async function I(t,r,n){const{applyEdits:a}=await new Promise(((t,r)=>e(["../graphics/editingSupport"],t,r))),o=await t.load(),{source:s,globalIdField:i}=o;let u=n;return("feature"===o.type?o.infoFor3D:null)&&null!=r.deleteFeatures&&null!=i&&(u={...u,globalIdToObjectId:await N(t,r.deleteFeatures,i)}),a(o,s,r,n)}async function q(t,r,n){const{uploadAssets:a}=await new Promise(((t,r)=>e(["../graphics/editingSupport"],t,r))),o=await t.load();return a(o,o.source,r,n)}async function F(e,t,r,n){const a=await L(e);if(await b(e,t,n),!a.deleteAttachments)throw new o(n,"Layer source does not support deleteAttachments capability");return a.deleteAttachments(t,r)}async function A(e,t,r){const n=(await e.load({signal:t?.signal})).source;if(!n.fetchRecomputedExtents)throw new o(r,"Layer source does not support fetchUpdates capability");return n.fetchRecomputedExtents(t)}async function O(e,t,r,n){t=y.from(t),await e.load();const a=e.source,s=e.capabilities;if(!s?.data?.supportsAttachment)throw new o(n,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:u,globalIds:c,num:l,size:d,start:p,where:f}=t;if(!s?.operations?.supportsQueryAttachments){if(i?.length>0||c?.length>0||d?.length>0||l||p||f)throw new o(n,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",t)}if(!(u?.length||c?.length||f))throw new o(n,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",t);if(!a.queryAttachments)throw new o(n,"Layer source does not support queryAttachments capability",t);return a.queryAttachments(t)}async function j(e,t,r,n){const a=await L(e);if(!a.queryObjectIds)throw new o(n,"Layer source does not support queryObjectIds capability");return a.queryObjectIds(f.from(t)??e.createQuery(),r)}async function P(e,t,r,n){const a=await L(e);if(!a.queryFeatureCount)throw new o(n,"Layer source does not support queryFeatureCount capability");return a.queryFeatureCount(f.from(t)??e.createQuery(),r)}async function E(e,t,r,n){const a=await L(e);if(!a.queryExtent)throw new o(n,"Layer source does not support queryExtent capability");return a.queryExtent(f.from(t)??e.createQuery(),r)}async function S(e,t,r,n){const a=await L(e);if(!a.queryRelatedFeatures)throw new o(n,"Layer source does not support queryRelatedFeatures capability");return a.queryRelatedFeatures(h.from(t),r)}async function R(e,t,r,n){const a=await L(e);if(!a.queryRelatedFeaturesCount)throw new o(n,"Layer source does not support queryRelatedFeaturesCount capability");return a.queryRelatedFeaturesCount(h.from(t),r)}async function x(e){const t=e.source;if(t?.refresh)try{const{dataChanged:r,updates:n}=await t.refresh();if(null!=n&&(e.sourceJSON={...e.sourceJSON,...n},e.read(n,{origin:"service",url:e.parsedUrl})),r)return!0}catch{}if(e.definitionExpression)try{return(await i.parseWhereClause(e.definitionExpression,e.fieldsIndex)).hasDateFunctions}catch{}return!1}function C(e){const t=new f,r=e.capabilities?.data,n=e.capabilities?.query;t.historicMoment=e.historicMoment,t.gdbVersion=e.gdbVersion,t.returnGeometry=!0,n&&(t.compactGeometryEnabled=n.supportsCompactGeometry,t.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=e.returnZ&&(t.returnZ=e.returnZ),r.supportsM&&null!=e.returnM&&(t.returnM=e.returnM)),t.outFields=["*"];const{timeOffset:a,timeExtent:o}=e;return t.timeExtent=null!=a&&null!=o?o.offset(-a.value,a.unit):o||null,t.multipatchOption="multipatch"===e.geometryType?"xyFootprint":null,t}function M(e){const{globalIdField:t,fields:r}=e;if(t)return t;if(r)for(const n of r)if("esriFieldTypeGlobalID"===n.type)return n.name}function T(e){const{objectIdField:t,fields:r}=e;if(t)return t;if(r)for(const n of r)if("esriFieldTypeOID"===n.type)return n.name}function G(e){return e.currentVersion?e.currentVersion:e.hasOwnProperty("capabilities")||e.hasOwnProperty("drawingInfo")||e.hasOwnProperty("hasAttachments")||e.hasOwnProperty("htmlPopupType")||e.hasOwnProperty("relationships")||e.hasOwnProperty("timeInfo")||e.hasOwnProperty("typeIdField")||e.hasOwnProperty("types")?10:9.3}async function L(e){return(await e.load()).source}async function Q(e,t){if(!r.id)return;if(r.id.findCredential(e))return;let n;try{const a=await l.getOwningPortalUrl(e,t);a&&(n=await r.id.checkSignInStatus(`${a}/sharing`))}catch(a){}if(n)try{const n=null!=t?t.signal:null;await r.id.getCredential(e,{signal:n})}catch(a){}}async function D(e,t,r){const n=e.parsedUrl?.path;n&&e.authenticationTriggerEvent===t&&await Q(n,r)}function v(e){return!e.sourceJSON?.isMultiServicesView&&(e.userHasUpdateItemPrivileges||e.editingEnabled)}const U=u.createTypeReader({types:n.symbolTypesRenderer});function V(e,t){if(e.defaultSymbol)return e.types?.length?new p({defaultSymbol:U(e.defaultSymbol,e,t),field:e.typeIdField,uniqueValueInfos:e.types.map((e=>({id:e.id,symbol:U(e.symbol,e,t)})))}):new d({symbol:U(e.defaultSymbol,e,t)})}function J(e){let t=e.sourceJSON?.cacheMaxAge;if(!t)return!1;const r=e.editingInfo?.lastEditDate?.getTime();return null==r||(t*=1e3,Date.now()-r<t)}async function N(e,t,r){if(null==t)return null;const n=[],{objectIdField:o}=e;if(t.forEach((e=>{let t=null;if("attributes"in e){const{attributes:n}=e;t={globalId:n[r],objectId:null!=n[o]&&-1!==n[o]?n[o]:null}}else t={globalId:e.globalId,objectId:null!=e.objectId&&-1!==e.objectId?e.objectId:null};null!=t.globalId&&(null!=t.objectId&&-1!==t.objectId||n.push(t.globalId))})),0===n.length)return null;const s=e.createQuery();s.where=n.map((e=>`${r}='${e}'`)).join(" OR "),s.returnGeometry=!1,s.outFields=[o,r],s.cacheHint=!1;const i=await a.resultOrAbort(c.queryAllJSON(e,s));if(!i.ok)return null;const u=new Map,l=i.value.features;for(const a of l){const e=a.attributes[r],t=a.attributes[o];null!=e&&null!=t&&-1!==t&&u.set(e,t)}return u}t.addAttachment=w,t.applyEdits=I,t.computeEffectiveEditingEnabled=v,t.createDefaultRenderer=V,t.createQuery=C,t.deleteAttachments=F,t.ensureLayerCredential=D,t.fetchRecomputedExtents=A,t.geometryTypeKebabDict=m,t.getGlobalIdToObjectIdMap=N,t.hasDataChanged=x,t.isLayerCacheStale=J,t.queryAttachments=O,t.queryExtent=E,t.queryFeatureCount=P,t.queryObjectIds=j,t.queryRelatedFeatures=S,t.queryRelatedFeaturesCount=R,t.readGlobalIdField=M,t.readObjectIdField=T,t.readVersion=G,t.updateAttachment=g,t.uploadAssets=q,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
