/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/has","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","./BaseRaster","./InMemoryRaster","./pamParser","../rasterFormats/RasterCodec","../rasterFunctions/stretchUtils","../rasterTransforms/PolynomialTransform","../../../geometry/SpatialReference","../../../geometry/Extent"],(function(e,t,s,a,r,o,i,n,l,c,u,p,f,m,h,d,w){"use strict";let y=class extends c{async open(e){await this.init();const t=await this._fetchData(e);let{spatialReference:s,statistics:a,histograms:r,transform:o}=await this._fetchAuxiliaryData(e);const i=!s;i&&(s=new d({wkid:3857})),r?.length&&null==a&&(a=m.estimateStatisticsFromHistograms(r));const{width:n,height:l}=t;let c=new w({xmin:-.5,ymin:.5-l,xmax:n-.5,ymax:.5,spatialReference:s});const p=o?o.forwardTransform(c):c;let f=!0;if(o){const e=o.forwardCoefficients;f=e&&0===e[1]&&0===e[2],f&&(o=null,c=p)}const h=new u({data:{extent:p,nativeExtent:c,transform:o,pixelBlock:t,statistics:a,histograms:r,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:i}});await h.open(),h.data=null,this._set("rasterInfo",h.rasterInfo),this._inMemoryRaster=h}fetchRawTile(e,t,s,a={}){return this._inMemoryRaster.fetchRawTile(e,t,s,a)}async _fetchData(e){const{data:t}=await this.request(this.url,{responseType:"array-buffer",signal:e?.signal}),r=f.getFormat(t).toUpperCase();if("JPG"!==r&&"PNG"!==r&&"GIF"!==r&&"BMP"!==r)throw new s("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",r);const o=r.toLowerCase(),i="gif"===o||"bmp"===o||!a("ios"),n=await this.decodePixelBlock(t,{format:o,useCanvas:i,hasNoZlibMask:!0});if(null==n)throw new s("image-aux-raster:open","the data cannot be decoded");return n}async _fetchAuxiliaryData(e){const t=e?.signal,s=this.ioConfig.skipExtensions??[],a=s.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:t}),o=this.datasetFormat,i="JPG"===o?"jgw":"PNG"===o?"pgw":"BMP"===o?"bpw":null,n=i&&s.includes(i)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+i,{responseType:"text",signal:t}),l=await r.eachAlways([a,n]);if(t?.aborted)throw r.createAbortError();const c=p.parsePAMInfo(l[0].value?.data);if(!c.transform){const e=l[1].value?l[1].value.data.split("\n").slice(0,6).map((e=>Number(e))):null;c.transform=6===e?.length?new h({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return c}};e.__decorate([o.property({type:String,json:{write:!0}})],y.prototype,"datasetFormat",void 0),y=e.__decorate([l.subclass("esri.layers.support.rasterDatasets.ImageAuxRaster")],y);return y}));
