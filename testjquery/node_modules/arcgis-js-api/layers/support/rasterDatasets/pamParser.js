/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../core/arrayUtils","../../../geometry/support/spatialReferenceUtils","./xmlUtilities","../rasterTransforms/PolynomialTransform","../../../geometry/SpatialReference"],(function(e,t,n,a,r,s,l){"use strict";function i(e,t){if(!e||!t)return null;const n=[];for(let a=0;a<e.length;a++)n.push(e[a]),n.push(t[a]);return n}function u(e){const t=r.getElement(e,"GeodataXform"),n=c(r.getElementNumericValue(t,"SpatialReference/WKID")||r.getElementValue(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:n,transform:null};const a=r.getElementNumericValue(t,"PolynomialOrder")??1,l=r.getElementNumericValues(t,"CoeffX/Double"),u=r.getElementNumericValues(t,"CoeffY/Double"),o=r.getElementNumericValues(t,"InverseCoeffX/Double"),m=r.getElementNumericValues(t,"InverseCoeffY/Double"),f=i(l,u),g=i(o,m);return{spatialReference:n,transform:f&&g&&f.length&&g.length?new s({spatialReference:n,polynomialOrder:a,forwardCoefficients:f,inverseCoefficients:g}):null}}function o(e){const t=r.getElementNumericValue(e,"NoDataValue"),n=r.getElement(e,"Histograms/HistItem"),a=r.getElementNumericValue(n,"HistMin"),s=r.getElementNumericValue(n,"HistMax"),l=r.getElementNumericValue(n,"BucketCount"),i=r.getElementValue(n,"HistCounts")?.split("|").map((e=>Number(e)));let u,o,c,m;r.getElements(e,"Metadata/MDI").forEach((e=>{const t=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":u=t;break;case"STATISTICS_MAXIMUM":o=t;break;case"STATISTICS_MEAN":c=t;break;case"STATISTICS_STDDEV":m=t}}));const f=r.getElementNumericValue(e,"Metadata/SourceBandIndex");return{noDataValue:t,histogram:i?.length&&null!=a&&null!=s?{min:a,max:s,size:l||i.length,counts:i}:null,sourceBandIndex:f,statistics:null!=u&&null!=o?{min:u,max:o,avg:c,stddev:m}:null}}function c(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new l({wkid:t});if(e=String(e).trim(),a.isWKT2(e))return new l({wkt2:e});const n=e.toUpperCase();if(n.startsWith("COMPD_CS")){if(!n.includes("VERTCS")||!n.includes("GEOGCS")&&!n.startsWith("PROJCS"))return null;const a=n.indexOf("VERTCS"),r=n.indexOf("PROJCS"),s=r>-1?r:n.indexOf("GEOGCS");if(-1===s)return null;const i=e.slice(s,e.lastIndexOf("]",a)+1).trim(),u=e.slice(a,e.lastIndexOf("]")).trim();t=m(i);const o=new l(t?{wkid:t}:{wkt:i}),c=m(u);return c&&(o.vcsWkid=c),o}return n.startsWith("GEOGCS")||n.startsWith("PROJCS")?(t=m(e),new l(0!==t?{wkid:t}:{wkt:e})):null}function m(e){const t=e.replaceAll("]","[").replaceAll('"',"").split("[").map((e=>e.trim())).filter((e=>""!==e)),n=t[t.length-1].split(","),a=n[0]?.toLowerCase();if(("epsg"===a||"esri"===a)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}function f(e){if("pamdataset"!==e?.documentElement.tagName?.toLowerCase())return{};const t={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if(r.isSameTagIgnoreNS(e,"SRS")){if(!t.spatialReference){const n=r.getElementValue(e);t.spatialReference=c(n)}}else if(r.isSameTagIgnoreNS(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:n,transform:a}=u(e);t.transform=a,t.spatialReference||(t.spatialReference=n)}else{r.getElements(e,"MDI").forEach((e=>t.metadata[e.getAttribute("key")]=r.getElementValue(e)))}else if(r.isSameTagIgnoreNS(e,"PAMRasterBand")){const n=o(e);null!=n.sourceBandIndex&&null==t.rasterBands[n.sourceBandIndex]?t.rasterBands[n.sourceBandIndex]=n:t.rasterBands.push(n)}}));const a=t.rasterBands;if(a.length){const e=!!a[0].statistics;t.statistics=e?a.map((e=>e.statistics)).filter(n.isSome):null;const r=!!a[0].histogram;t.histograms=r?a.map((e=>e.histogram)).filter(n.isSome):null}return t}e.parsePAMInfo=f,e.parseSpatialReference=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
