/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../request","../../core/lang","../../core/promiseUtils","../../core/urlUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],(function(e,t,r,o,l,s,n,i){"use strict";async function u(e,t){const r={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[o,l]="string"==typeof e?[e,null]:[null,e.jsonUrl];await c(r,"esri",e,l,t);return{layerDefinition:r.validatedSource,url:o,serviceUrl:r.sourceUrl,style:r.style,styleUrl:r.styleUrl,spriteUrl:r.style.sprite&&a(r.styleBase,r.style.sprite),spriteFormat:r.spriteFormat,glyphsUrl:r.style.glyphs&&a(r.styleBase,r.style.glyphs),sourceNameToSource:r.sourceNameToSource,primarySourceName:r.primarySourceName}}function a(...e){let t;for(const r of e)if(null!=r)if(l.isProtocolRelative(r)){if(t){const e=t.split("://")[0];t=e+":"+r.trim()}}else t=l.isAbsolute(r)?r:l.join(t,r);return t?l.removeTrailingSlash(t):void 0}async function c(e,r,s,n,i){let u,a,c;if(o.throwIfAborted(i),"string"==typeof s){const e=l.normalize(s);c=await t(e,{...i,responseType:"json",query:{f:"json",...i?.query}}),c.ssl&&(u&&(u=u.replace(/^http:/i,"https:")),a&&(a=a.replace(/^http:/i,"https:"))),u=e,a=e}else null!=s&&(c={data:s},u=s.jsonUrl||null,a=n);const f=c?.data;if(y(f))return e.styleUrl=u||null,m(e,f,a,i);if(p(f))return e.sourceUrl?d(e,f,a,!1,r,i):(e.sourceUrl=u||null,d(e,f,a,!0,r,i));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function f(e){return"object"==typeof e&&!!e&&"tilejson"in e&&null!=e.tilejson}function y(e){return!!e&&"sources"in e&&!!e.sources}function p(e){return!y(e)}async function m(e,t,r,o){const s=r?l.removeFile(r):l.getAppBaseUrl();e.styleBase=s,e.style=t,t["sprite-format"]&&"webp"===t["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const n=[];if(t.sources&&t.sources.esri){const r=t.sources.esri;r.url?await c(e,"esri",a(s,r.url),void 0,o):n.push(c(e,"esri",r,s,o))}for(const l of Object.keys(t.sources))"esri"!==l&&"vector"===t.sources[l].type&&(t.sources[l].url?n.push(c(e,l,a(s,t.sources[l].url),void 0,o)):t.sources[l].tiles&&n.push(c(e,l,t.sources[l],s,o)));await Promise.all(n)}async function d(e,t,r,o,s,n){const u=r?l.removeTrailingSlash(r)+"/":l.getAppBaseUrl(),y=S(t),p=new i(s,l.addQueryParameters(u,n?.query??{}),y);if(!o&&e.primarySourceName in e.sourceNameToSource){const t=e.sourceNameToSource[e.primarySourceName];if(!t.isCompatibleWith(p))return;null!=p.fullExtent&&(null!=t.fullExtent?t.fullExtent.union(p.fullExtent):t.fullExtent=p.fullExtent.clone()),t.tileInfo&&p.tileInfo&&t.tileInfo.lods.length<p.tileInfo.lods.length&&(t.tileInfo=p.tileInfo)}if(o&&(e.sourceBase=u,e.source=t,e.validatedSource=y,e.primarySourceName=s),e.sourceNameToSource[s]=p,!f(e)&&"defaultStyles"in t&&!e.style){if(null==t.defaultStyles)throw new Error;return"string"==typeof t.defaultStyles?c(e,"",a(u,t.defaultStyles,"root.json"),void 0,n):c(e,"",t.defaultStyles,a(u,"root.json"),n)}}function S(e){if(e.hasOwnProperty("tileInfo"))return e;const t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100,latestWkid:3857}};let o=null;if(f(e)){const{bounds:t}=e;if(t){const e=n.geographicToWebMercator({x:t[0],y:t[1],spatialReference:r.clone(s.WGS84)}),l=n.geographicToWebMercator({x:t[2],y:t[3],spatialReference:r.clone(s.WGS84)});o={xmin:e.x,ymin:e.y,xmax:l.x,ymax:l.y,spatialReference:r.clone(s.WebMercator)}}}null===o&&(o=t);const l=512;let i=78271.51696400007,u=295828763.7957775;const a=[],c=e.hasOwnProperty("maxzoom")&&null!=e.maxzoom?+e.maxzoom:22,y=0,p=0;for(let r=0;r<=c;r++)a.push({level:r,scale:u,resolution:i}),i/=2,u/=2;return{capabilities:"TilesOnly",initialExtent:o,fullExtent:t,minScale:y,maxScale:p,tiles:e.tiles,tileInfo:{rows:l,cols:l,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:a,spatialReference:r.clone(s.WebMercator)}}}e.loadMetadata=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
