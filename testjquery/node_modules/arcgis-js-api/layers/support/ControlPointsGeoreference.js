/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/JSONSupport","../../core/Logger","../../core/perspectiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../chunks/mat3","../../chunks/mat3f64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Point","../../geometry/Polygon","../../geometry/projection","../../geometry/SpatialReference","./GeoreferenceBase"],(function(t,e,o,r,n,i,s,c,l,a,u,p,P,f,h,m,d,y,g,v,_,w,S){"use strict";const j=m.create(),R=y.create();let x=class extends e{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};t.__decorate([c.property()],x.prototype,"sourcePoint",void 0),t.__decorate([c.property({type:g})],x.prototype,"mapPoint",void 0),x=t.__decorate([P.subclass("esri.layers.support.ControlPoint")],x);let C=class extends(r.JSONSupportMixin(S)){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,e){const o=w.fromJSON(e.spatialReference),r=m.fromValues(...e.coefficients,1);return t.map((t=>(d.set(R,t.x,t.y),i.transformProjective(R,R,r),{sourcePoint:t,mapPoint:new g({x:R[0],y:R[1],spatialReference:o})})))}writeControlPoints(t,e,r,i){if(null!=this.transform)null!=t&&O(t[0])&&(e.controlPoints=t.map((t=>{const e=t.sourcePoint;return{x:e.x,y:e.y}})),e.spatialReference=t[0].mapPoint.spatialReference.toJSON(),e.coefficients=this.transform.slice(0,8));else{const t=new o("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:i?.layer,georeference:this});i?.messages?i.messages.push(t):n.getLogger(this).error(t.name,t.message)}}get coords(){if(null==this.controlPoints)return null;const t=this._updateTransform(j);if(null==t||!O(this.controlPoints[0]))return null;const e=this.controlPoints[0].mapPoint.spatialReference;return D(t,this.width,this.height,e)}set coords(t){if(null==this.controlPoints||!O(this.controlPoints[0]))return;const e=this.controlPoints[0].mapPoint.spatialReference;if(null==(t=this.projectOrWarn(t,e)))return;const{width:o,height:r}=this,{rings:[[n,c,l,a]]}=t,u={sourcePoint:s.createScreenPoint(0,r),mapPoint:new g({x:n[0],y:n[1],spatialReference:e})},p={sourcePoint:s.createScreenPoint(0,0),mapPoint:new g({x:c[0],y:c[1],spatialReference:e})},P={sourcePoint:s.createScreenPoint(o,0),mapPoint:new g({x:l[0],y:l[1],spatialReference:e})},f={sourcePoint:s.createScreenPoint(o,r),mapPoint:new g({x:a[0],y:a[1],spatialReference:e})};O(u)&&O(p)&&O(P)&&O(f)&&(G(j,u,p,P,f),this.controlPoints=this.controlPoints.map((({sourcePoint:t})=>(d.set(R,t.x,t.y),i.transformProjective(R,R,j),{sourcePoint:t,mapPoint:new g({x:R[0],y:R[1],spatialReference:e})}))))}get inverseTransform(){return null==this.transform?null:h.invert(m.create(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(null==t||null==this.transform||null==this.controlPoints||!O(this.controlPoints[0]))return null;d.set(R,t.x,t.y);const e=this.controlPoints[0].mapPoint.spatialReference;return i.transformProjective(R,R,this.transform),new g({x:R[0],y:R[1],spatialReference:e})}toSource(t){if(null==t||null==this.inverseTransform||null==this.controlPoints||!O(this.controlPoints[0]))return null;const e=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),null==(t=_.projectOrLoad(t,e).geometry)?null:(d.set(R,t.x,t.y),i.transformProjective(R,R,this.inverseTransform),s.createScreenPoint(R[0],R[1]))}toSourceNormalized(t){const e=this.toSource(t);return null!=e&&(e.x/=this.width,e.y/=this.height),e}_updateTransform(t){const{controlPoints:e,width:o,height:r}=this;if(!(null!=e&&o>0&&r>0))return null;const[n,i,s,c]=e;if(!O(n))return null;const l=n.mapPoint.spatialReference,a=this._projectControlPoint(i,l),u=this._projectControlPoint(s,l),p=this._projectControlPoint(c,l);if(!a.valid||!u.valid||!p.valid)return null;if(!O(a.controlPoint))return null;null==t&&(t=m.create());let P=null;return P=O(u.controlPoint)&&O(p.controlPoint)?G(t,n,a.controlPoint,u.controlPoint,p.controlPoint):O(u.controlPoint)?z(t,n,a.controlPoint,u.controlPoint):U(t,n,a.controlPoint),P.every((t=>0===t))?null:P}_projectControlPoint(t,e){if(!O(t))return{valid:!0,controlPoint:t};const{sourcePoint:o,mapPoint:r}=t,{geometry:i,pending:s}=_.projectOrLoad(r,e);return s?{valid:!1,controlPoint:null}:s||i?{valid:!0,controlPoint:{sourcePoint:o,mapPoint:i}}:(n.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:r.spatialReference,targetSpatialReference:e}),{valid:!1,controlPoint:null})}};function O(t){return null!=t?.sourcePoint&&null!=t.mapPoint}t.__decorate([c.property({type:[x],json:{write:{allowNull:!1,isRequired:!0}}})],C.prototype,"controlPoints",void 0),t.__decorate([p.reader("controlPoints")],C.prototype,"readControlPoints",null),t.__decorate([f.writer("controlPoints")],C.prototype,"writeControlPoints",null),t.__decorate([c.property()],C.prototype,"coords",null),t.__decorate([c.property({json:{write:!0}})],C.prototype,"height",void 0),t.__decorate([c.property({readOnly:!0})],C.prototype,"inverseTransform",null),t.__decorate([c.property({readOnly:!0})],C.prototype,"transform",null),t.__decorate([c.property({json:{write:!0}})],C.prototype,"width",void 0),C=t.__decorate([P.subclass("esri.layers.support.ControlPointsGeoreference")],C);const T=y.create(),b=y.create(),N=y.create(),k=y.create(),L=y.create(),M=y.create(),V=y.create(),I=y.create(),J=Math.PI/2;function A(t,e,o){d.set(t,o.sourcePoint.x,o.sourcePoint.y),d.set(e,o.mapPoint.x,o.mapPoint.y)}function U(t,e,o){return A(T,L,e),A(b,M,o),d.rotate(N,b,T,J),d.rotate(k,T,b,J),d.rotate(V,M,L,-J),d.rotate(I,L,M,-J),W(t,T,b,N,k,L,M,V,I)}function z(t,e,o,r){return A(T,L,e),A(b,M,o),A(N,V,r),d.lerp(k,T,b,.5),d.rotate(k,N,k,Math.PI),d.lerp(I,L,M,.5),d.rotate(I,V,I,Math.PI),W(t,T,b,N,k,L,M,V,I)}function G(t,e,o,r,n){return A(T,L,e),A(b,M,o),A(N,V,r),A(k,I,n),W(t,T,b,N,k,L,M,V,I)}const q=new Array(8).fill(0),B=new Array(8).fill(0);function E(t,e,o,r,n){return t[0]=e[0],t[1]=e[1],t[2]=o[0],t[3]=o[1],t[4]=r[0],t[5]=r[1],t[6]=n[0],t[7]=n[1],t}function W(t,e,o,r,n,s,c,l,a){return i.getProjectiveTransform(t,E(q,e,o,r,n),E(B,s,c,l,a))}function D(t,e,o,r){const n=y.fromValues(0,o),s=y.fromValues(0,0),c=y.fromValues(e,0),l=y.fromValues(e,o);return i.transformProjective(n,n,t),i.transformProjective(s,s,t),i.transformProjective(c,c,t),i.transformProjective(l,l,t),new v({rings:[[n,s,c,l,n]],spatialReference:r})}return C}));
