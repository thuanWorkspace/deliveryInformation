/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../core/has","../../../core/jsonMap","../PixelBlock","./mirror"],(function(t,e,o,n,s){"use strict";const r=new o.JSONMap({1:"min",2:"max",3:"mean",4:"stddev",5:"median",6:"majority",7:"minority"},{useNumericKeys:!0});function i(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:r,mask:i,outBand:l}=t;if(o&&!i)return void l.set(n);const{statisticsType:a,kernelRows:c,kernelCols:f}=e,h="stddev"===a,u=s*r,d=new Float64Array(u),y=new Float64Array(u),m=new Uint32Array(u);for(let A=0;A<r;A++){const t=A*s;let e=0,o=0,r=0;for(let s=0;s<f;s++)i&&!i[t+s]||(e+=n[t+s],h&&(o+=n[t+s]**2),r++);d[t]=e,y[t]=o,m[t]=r;for(let l=1;l<=s-f;l++){const s=t+l-1,a=s+f;i?(i[s]&&(r--,e-=n[s],h&&(o-=n[s]**2)),i[a]&&(r++,e+=n[a],h&&(o+=n[a]**2))):(e-=n[s],e+=n[a],h&&(o-=n[s]**2,o+=n[a]**2)),d[t+l]=e,m[t+l]=r,h&&(y[t+l]=o)}}const w=new Float64Array(u),p=new Float64Array(u),k=new Uint32Array(u),g=c*s;for(let A=0;A<=s-f;A++){let t=0,e=0,o=0;for(let n=0;n<c;n++){const r=n*s+A;t+=d[r],o+=m[r],h&&(e+=y[r])}w[A]=t,p[A]=e,k[A]=o;for(let n=1;n<=r-c;n++){const r=(n-1)*s+A,i=r+g;t-=d[r],t+=d[i],o-=m[r],o+=m[i],h&&(e-=y[r],e+=y[i]),w[n*s+A]=t,p[n*s+A]=e,k[n*s+A]=o}}const M=Math.floor(c/2),b=Math.floor(f/2);for(let A=M;A<r-M;A++){const t=A*s;for(let e=b;e<s-b;e++){const n=(A-M)*s+e-b,r=k[n];if(0===r||o&&(!i||i[t+e]))continue;const a=w[n]/r,c=h?Math.sqrt((p[n]-w[n]*a)/r):a;l[t+e]=c,i&&(i[t+e]=255)}}}function l(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:r,mask:i,outBand:l}=t;if(o&&!i)return void l.set(n);const{kernelRows:a,kernelCols:c,statisticsType:f}=e,h=Math.floor(a/2),u=Math.floor(c/2),d="min"===f,y=l.slice(),m=new Uint32Array(s*r);for(let w=h;w<r-h;w++){const t=w*s;for(let e=u;e<s-u;e++){let o=d?Number.MAX_VALUE:-Number.MAX_VALUE,r=0;for(let l=0;l<a;l++)for(let a=0;a<c;a++){const c=t+e+(l-h)*s+a-u;i&&!i[c]||(o=d?Math.min(o,n[c]):Math.max(o,n[c]),r++)}i?(y[t+e]=0===r?0:o,m[t+e]=r):l[t+e]=0===r?0:o}}if(i)for(let w=h;w<r-h;w++){const t=w*s;for(let e=u;e<s-u;e++)if(m[t+e]){if(o&&i[t+e])continue;l[t+e]=y[t+e],i[t+e]=255}}}function a(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:r,mask:i,outBand:l}=t;if(o&&!i)return void l.set(n);const{kernelRows:a,kernelCols:c}=e,f=Math.floor(a/2),h=Math.floor(c/2),u=l.slice(),d=new Uint32Array(s*r);for(let y=f;y<r-f;y++){const t=y*s;for(let e=h;e<s-h;e++){if(o&&i&&i[t+e])continue;const r=[];for(let o=0;o<a;o++)for(let l=0;l<c;l++){const a=t+e+(o-f)*s+l-h;i&&!i[a]||r.push(n[a])}r.length&&(r.sort(((t,e)=>t-e)),i?(u[t+e]=r[Math.floor((r.length-1)/2)],d[t+e]=r.length):l[t+e]=r[Math.floor((r.length-1)/2)])}}if(i)for(let y=f;y<r-f;y++){const t=y*s;for(let e=h;e<s-h;e++)if(d[t+e]){if(o&&i[t+e])continue;l[t+e]=u[t+e],i[t+e]=255}}}function c(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:r,mask:i,outBand:l}=t;if(o&&!i)return void l.set(n);const{kernelRows:a,kernelCols:c}=e,f=Math.floor(a/2),h=Math.floor(c/2),u="majority"===e.statisticsType,d=a*c,y=l.slice(),m=new Uint32Array(s*r);for(let w=f;w<r-f;w++){const t=w*s;for(let e=h;e<s-h;e++){if(o&&i&&i[t+e])continue;const r=new Map;for(let o=0;o<a;o++)for(let l=0;l<c;l++){const a=t+e+(o-f)*s+l-h;if(i&&!i[a])continue;const c=n[a];r.set(c,r.has(c)?r.get(c)+1:1)}if(0===r.size)continue;let w=0,p=0,k=u?0:d+1;for(const t of r.keys())p=r.get(t),u===p>k&&(k=p,w=t);i?(y[t+e]=w,m[t+e]=r.size):l[t+e]=w}}if(i)for(let w=f;w<r-f;w++){const t=w*s;for(let e=h;e<s-h;e++)if(m[t+e]){if(o&&i[t+e])continue;l[t+e]=y[t+e],i[t+e]=255}}}function f(t,e){const{mask:o}=t,{fillNoDataOnly:r}=e;if(r&&!o)return t;const{pixels:f,width:h,height:u,bandMasks:d,pixelType:y}=t,m=f.length,w=h*u,p=[],{kernelRows:k,kernelCols:g,statisticsType:M,mirrorEdges:b}=e;if(r&&!o)return t;const A=e.outputPixelType??y,x=[];for(let v=0;v<m;v++){const t=f[v],y=n.createEmptyBand(A,w);r&&y.set(t);const m=d?.[v]??o,N=m?.slice()??null,T={band:t,width:h,height:u,mask:N,outBand:y};switch(M){case"min":case"max":l(T,e);break;case"mean":case"stddev":i(T,e);break;case"median":a(T,e);break;case"majority":case"minority":c(T,e)}b&&!r&&s.mirror(y,h,u,k,g),p.push(y),N&&x.push(N)}let N=x[0]??o;if(x.length!==m&&(x.length=0),m>1&&d?.length){N=new Uint8Array(w),N.set(x[0]);for(let t=1;t<d.length;t++){const e=d[t];for(let t=0;t<e.length;t++)0===e[t]&&(N[t]=0)}}const T=new n({pixelType:A,width:h,height:u,pixels:p,bandMasks:d&&x.length?x:null,mask:N});return T.updateStatistics(),T}t.computeFocalStatistics=f,t.statisticsTypeMap=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
