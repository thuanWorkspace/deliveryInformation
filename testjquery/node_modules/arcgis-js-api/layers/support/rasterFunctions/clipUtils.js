/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/unitUtils","../../../geometry/Extent","../PixelBlock"],(function(t,e,n,i,a){"use strict";function h(t,e){if(t.spatialReference.equals(e))return t;const i=n.getMetersPerUnitForSR(t.spatialReference),a=n.getMetersPerUnitForSR(e);if(i===a)return t;const h=i/a;return{x:t.x*h,y:t.y*h}}async function o(e,n,i){if("extent"===i.type)return l(e,n,i);const{width:h,height:o}=e,s=new Uint8Array(h*o),{contains:m,intersects:p}=await new Promise(((e,n)=>t(["../../../geometry/geometryEngine"],e,n)));return p(n,i)?"polyline"===i.type?x(e,n,i):m(i,n)?e:r(e,n,i):new a({pixelType:e.pixelType,width:h,height:o,mask:s,maskIsAlpha:!1,pixels:[...e.pixels]})}function r(t,e,n){if(!t)return t;const{width:i,height:h}=t,o=e.width/i,r=e.height/h,{xmin:l,ymax:x}=e;let s;if("extent"===n.type){const t=(n.xmin-l)/o,e=(n.xmax-l)/o,i=(x-n.ymax)/r,a=(x-n.ymin)/r;s=[[[t,i],[t,a],[e,a],[e,i],[t,i]]]}else s=n.rings.map((t=>t.map((([t,e])=>[(t-l)/o,(x-e)/r]))));const m=document.createElement("canvas");m.width=i,m.height=h;const p=m.getContext("2d");p.fillStyle="#f00",s.forEach((t=>{p.beginPath(),p.moveTo(t[0][0],t[0][1]);for(let e=0;e<t.length;e++)p.lineTo(t[e][0],t[e][1]);p.closePath(),p.fill()}));const c=p.getImageData(0,0,i,h).data,y=t.mask,f=i*h,M=new Uint8Array(f);for(let a=0;a<f;a++)y&&!y[a]||(M[a]=c[4*a+3]>127?255:0);return new a({pixelType:t.pixelType,width:i,height:h,mask:M,maskIsAlpha:!1,pixels:[...t.pixels]})}function l(t,e,n){const{width:i,height:h}=t,o=new Uint8Array(i*h),r=e.width/i,l=e.height/h;if(n.width/r<.5||n.height/l<.5)return new a({pixelType:t.pixelType,width:i,height:h,mask:o,pixels:[...t.pixels]});const{xmin:x,xmax:s,ymin:m,ymax:p}=e,{xmin:c,xmax:y,ymin:f,ymax:M}=n,u=Math.max(x,c),d=Math.min(s,y),g=Math.max(m,f),w=Math.min(p,M),T=.5*r,k=.5*l;if(d-u<T||w-g<k||d<x+T||u>s-T||g>p-k||w<m+k)return new a({pixelType:t.pixelType,width:i,height:h,mask:o,pixels:[...t.pixels]});const R=Math.max(0,(u-x)/r),P=Math.min(i,Math.max(0,(d-x)/r)),U=Math.max(0,(p-w)/l),A=Math.min(h,Math.max(0,(p-g)/l)),S=Math.round(R),E=Math.round(P)-1,b=Math.round(U),v=Math.round(A)-1;if(S===E&&R%1>.5&&P%1<.5||b===v&&U%1>.5&&A%1<.5)return new a({pixelType:t.pixelType,width:i,height:h,mask:o,pixels:[...t.pixels]});if(0===S&&0===b&&E===i&&v===h)return t;const I=t.mask;for(let a=b;a<=v;a++)for(let t=S;t<=E;t++){const e=a*i+t;o[e]=I?I[e]:255}return new a({pixelType:t.pixelType,width:i,height:h,mask:o,pixels:[...t.pixels]})}function x(t,e,n){const{width:i,height:h}=t,o=new Uint8Array(i*h),r=e.width/i,l=e.height/h,{xmin:x,ymax:s}=e,{paths:m}=n,p=t.mask;for(let a=0;a<m.length;a++){const t=m[a];for(let e=0;e<t.length-1;e++){const[n,a]=t[e],[m,c]=t[e+1];let y=Math.floor((s-a)/l),f=Math.floor((s-c)/l);if(f<y){const t=y;y=f,f=t}y=Math.max(0,y),f=Math.min(h-1,f);const M=(m-n)/(c-a);for(let t=y;t<=f;t++){const e=t===y?Math.max(a,c):(h+1-t)*l,s=t===f?Math.min(a,c):e-l;let u=c===a?Math.floor((n-x)/r):Math.floor((M*(e-a)+n-x)/r),d=c===a?Math.floor((m-x)/r):Math.floor((M*(s-a)+n-x)/r);if(d<u){const t=u;u=d,d=t}const g=t*i;u=Math.max(0,u),d=Math.min(i-1,d);for(let t=g+u;t<=g+d;t++)o[t]=p?p[t]:255}}}return new a({pixelType:t.pixelType,width:i,height:h,mask:o,pixels:[...t.pixels]})}function s(t,e,n,a=!0){const{spatialReference:o}=t,{x:r,y:l}=h(n,o);let x,s,m;const p="extent"===e.type?e:e.extent;let{xmin:c,xmax:y,ymax:f,ymin:M}=p;const{xmin:u,ymax:d}=t.extent;return a?(c=u+(c>u?r*Math.round((c-u)/r):0),f=d-(f<d?l*Math.round((d-f)/l):0),y=u+(y>u?r*Math.round((y-u)/r):0),M=d-(M<d?l*Math.round((d-M)/l):0),x=new i({xmin:c,ymax:f,xmax:y,ymin:M,spatialReference:o}),s=Math.round(x.width/r),m=Math.round(x.height/l)):(s=Math.floor((y-c)/r+.8),m=Math.floor((f-M)/l+.8),c=u+(c>u?r*Math.floor((c-u)/r+.1):0),f=d-(f<d?l*Math.floor((d-f)/l+.1):0),y=c+s*r,M=f-m*l,x=new i({xmin:c,ymax:f,xmax:y,ymin:M,spatialReference:o})),{extent:x,width:s,height:m}}e.clip=o,e.snapToRaster=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
