/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./bandIndexUtils","./BaseRasterFunction","./ExtractBandFunctionArguments","./pixelUtils"],(function(t,e,n,s,r,a,o,i,l,u){"use strict";let c=class extends i{constructor(){super(...arguments),this.functionName="ExtractBand",this.functionArguments=null,this.rasterArgumentNames=["raster"]}_bindSourceRasters(){const{functionArguments:t,sourceRasterInfos:e}=this,n=e[0],{method:s,bandNames:r,bandWavelengths:a,bandIds:o,missingBandAction:i}=t,l=r?.length&&("name"===s||"id"!==s&&!o?.length),c=a?.length&&("wavelength"===s||"id"!==s&&!o?.length),d=i===u.MissingBandAction.fail,h=l?this._matchBandNames(n,r):c?this._matchBandWavelengths(n,a,d):this._matchBandIds(n,o,d);if(null==h){return{success:!1,supportsGPU:!1,error:`extract-band-function: Invalid ${l?"band names":c?"band wavelengths":"band ids"} for the imagery data source`}}this.functionArguments.bandIds=h,this.functionArguments.method="id",this.outputPixelType=this._getOutputPixelType("f32");const g=n.clone();g.pixelType=this.outputPixelType,g.bandCount=h.length;const{statistics:p,histograms:m}=g;null!=p&&p.length&&(g.statistics=h.map((t=>p[t]||p[p.length-1]))),null!=m&&m.length&&(g.histograms=h.map((t=>m[t]||m[m.length-1])));let f=g.keyProperties?.BandProperties;f?.length&&(f=h.map((t=>t>=f.length?f[f.length-1]:f[t])),g.keyProperties={...g.keyProperties,BandProperties:f}),this.rasterInfo=g;return{success:!0,supportsGPU:g.bandCount<=3}}_processPixels(t){const e=t.pixelBlocks?.[0];if(null==e)return null;const n=e.pixels.length,s=this.functionArguments.bandIds.map((t=>t>=n?n-1:t));return e.extractBands(s)}_getWebGLParameters(){let t;if(this.isInputBandIdsSwizzled)t=this.swizzledBandSelection.length?this.swizzledBandSelection:[0,1,2];else{t=[...this.functionArguments.bandIds],0===t.length?t=[0,1,2]:t.length<3&&(t[1]=t[1]??t[0],t[2]=t[2]??t[1]);for(let e=0;e<3;e++)t[e]=Math.min(t[e],2)}return{bandIndexMat3:o.getBandMatrix3(t)}}_getInputBandIds(t){const e=t.length;return this.functionArguments.bandIds.map((t=>t>=e?e-1:t)).map((e=>t[e]))}_matchBandNames(t,e){const n=t.bandInfos.map((({name:t})=>t.toLowerCase())),s=[];for(let r=0;r<e.length;r++){const t=e[r].toLowerCase();let a=n.indexOf(t);if(-1===a&&"nearinfrared"===t&&(a=n.findIndex((t=>t.startsWith("nearinfrared_1"))),-1===a&&(a=n.findIndex((t=>t.startsWith("nearinfrared"))))),-1===a)return null;s.push(a)}return s}_matchBandIds(t,e,n){const{bandCount:s}=t;return!e?.length||n&&e.some((t=>t<0||t>=s))?null:e}_matchBandWavelengths(t,e,n){const{bandInfos:s}=t,r=[];for(let i=0;i<s.length;i++){const{minWavelength:t,maxWavelength:e}=s[i];if(!t||!e)return null;r.push({minWavelength:t,maxWavelength:e})}const{wavelengthMatchTolerance:a}=this.functionArguments,o=[];for(let i=0;i<e.length;i++){const t=e[i];let s=!1,l=-1,u=Number.MAX_VALUE;for(let e=0;e<r.length;e++){const n=r[e],a=t>=n.minWavelength&&t<=n.maxWavelength,o=Math.abs(t-(n.minWavelength+n.maxWavelength)/2);a?o<u&&(s=!0,l=e,u=o):!s&&o<u&&(l=e,u=o)}if(!s&&a&&u<a&&(s=!0),!s&&n)return null;o.push(l)}return o}};t.__decorate([e.property({json:{write:!0,name:"rasterFunction"}})],c.prototype,"functionName",void 0),t.__decorate([e.property({type:l,json:{write:!0,name:"rasterFunctionArguments"}})],c.prototype,"functionArguments",void 0),t.__decorate([e.property()],c.prototype,"rasterArgumentNames",void 0),c=t.__decorate([a.subclass("esri.layers.support.rasterFunctions.ExtractBandFunction")],c);return c}));
