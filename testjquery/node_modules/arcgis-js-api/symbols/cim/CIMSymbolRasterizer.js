/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../request","../../core/promiseUtils","../../core/screenUtils","./cimAnalyzer","./CIMResourceManager","./CIMSymbolDrawHelper","./CIMSymbolHelper","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],(function(e,t,a,r,i,o,n,s,l,c,h,u,m,g){"use strict";const y=e=>e?.scaleFactor?e.scaleFactor:1,d=96/72;class f{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new h,this._cimResourceManager=new n,this._rasterizer=new c(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??(this._lazyImageDataCanvas=document.createElement("canvas")),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,a,r,i,o,n,c,h){if(!e)return null;const{data:m}=e;if(!m||"CIMSymbolReference"!==m.type||!m.symbol)return null;const{symbol:g}=m;o||(o=u.mapCIMSymbolToGeometryType(g));const y=await l.OverrideHelper.resolveSymbolOverrides(m,t,this._spatialReference,i,o,n,c),f=this._imageDataCanvas,C=this._cimResourceManager,w=[];l.CIMSymbolHelper.fetchResources(y,C,w),l.CIMSymbolHelper.fetchFonts(y,C,w),w.length>0&&await Promise.all(w);const{width:M,height:v}=a,b=p(o,M,v,r),I=l.CIMSymbolHelper.getEnvelope(y,b,C);if(!I)return null;const x=(window.devicePixelRatio||1)*d;let _=1,z=0,R=0;switch(g.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;I.width>M&&(e=M/I.width);let t=1;I.height>v&&(t=v/I.height),"preview"===r&&(I.width<M&&(e=M/I.width),I.height<v&&(t=v/I.height)),_=Math.min(e,t),z=I.x+I.width/2,R=I.y+I.height/2}break;case"CIMLineSymbol":{(h||I.height>v)&&(_=v/I.height),R=I.y+I.height/2;const e=I.x*_+M/2,t=(I.x+I.width)*_+M/2,{paths:a}=b;a[0][0][0]-=e/_,a[0][2][0]-=(t-M)/_}break;case"CIMPolygonSymbol":{z=I.x+I.width/2,R=I.y+I.height/2;const e=I.x*_+M/2,t=(I.x+I.width)*_+M/2,a=I.y*_+v/2,r=(I.y+I.height)*_+v/2,{rings:i}=b;e<0&&(i[0][0][0]-=e,i[0][3][0]-=e,i[0][4][0]-=e),a<0&&(i[0][0][1]+=a,i[0][1][1]+=a,i[0][4][1]+=a),t>M&&(i[0][1][0]-=t-M,i[0][2][0]-=t-M),r>v&&(i[0][2][1]+=r-v,i[0][3][1]+=r-v)}}f.width=M*x,f.height=v*x;const S=1;f.width+=2*S,f.height+=2*S;const D=this._imageDataContext,F=s.Transformation.createIdentity();F.translate(-z,-R),F.scale(_*x,-_*x),F.translate(M*x/2+S,v*x/2+S),D.clearRect(0,0,f.width,f.height);return new s.CanvasDrawHelper(D,C,F,!0).drawSymbol(y,b),D.getImageData(0,0,f.width,f.height)}async analyzeCIMSymbol3D(e,t,a,i,n){const s=[],c=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null,h=[];l.CIMSymbolHelper.fetchFonts(e.data.symbol,this._cimResourceManager,h),await Promise.all(h);const m=new o.CIMAnalyzer(this._cimResourceManager,c);let g;await m.analyzeSymbolReference(e.data,this._avoidSDF,s),r.throwIfAborted(n);for(const r of s)"CIMPictureMarker"!==r.cim.type&&"CIMPictureFill"!==r.cim.type&&"CIMPictureStroke"!==r.cim.type||(g||(g=[]),g.push(this._fetchPictureMarkerResource(r,n))),a&&"text"===r.type&&"string"==typeof r.text&&r.text.includes("[")&&(r.text=u.createLabelOverrideFunction(a,r.text,r.cim.textCase));return g&&await Promise.all(g),s}rasterizeCIMSymbol3D(e,t,a,r,i,o){const n=[];for(const s of e){r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(t,i,o));const e=this._getRasterizedResource(s,t,a,r,i,o);if(!e)continue;let l=0,c=e.anchorX||0,h=e.anchorY||0,m=!1,g=0,d=0;if("esriGeometryPoint"===a){const e=y(r);if(g=u.evaluateValueOrFunction(s.offsetX,t,i,o)*e||0,d=u.evaluateValueOrFunction(s.offsetY,t,i,o)*e||0,"marker"===s.type)l=u.evaluateValueOrFunction(s.rotation,t,i,o)||0,m=s.rotateClockwise??!1;else if("text"===s.type){if(l=u.evaluateValueOrFunction(s.angle,t,i,o)||0,void 0!==s.horizontalAlignment)switch(s.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==s.verticalAlignment)switch(s.verticalAlignment){case"top":h=.5;break;case"bottom":h=-.5;break;case"baseline":h=-.25;break;default:h=0}}}null!=e&&n.push({angle:l,rotateClockWise:m,anchorX:c,anchorY:h,offsetX:g,offsetY:d,rasterizedResource:e})}return this.getSymbolImage(n)}getSymbolImage(e){const t=document.createElement("canvas"),a=t.getContext("2d");let r=0,o=0,n=0,s=0;const l=[];for(let m=0;m<e.length;m++){const t=e[m],c=t.rasterizedResource;if(!c)continue;const h=c.size,u=t.offsetX,g=t.offsetY,y=t.anchorX,d=t.anchorY,f=t.rotateClockWise||!1;let p=t.angle,C=i.pt2px(u)-h[0]*(.5+y),w=i.pt2px(g)-h[1]*(.5+d),M=C+h[0],v=w+h[1];if(p){f&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),a=C*t-w*e,r=C*e+w*t,i=C*t-v*e,o=C*e+v*t,n=M*t-v*e,s=M*e+v*t,l=M*t-w*e,c=M*e+w*t;C=Math.min(a,i,n,l),w=Math.min(r,o,s,c),M=Math.max(a,i,n,l),v=Math.max(r,o,s,c)}r=C<r?C:r,o=w<o?w:o,n=M>n?M:n,s=v>s?v:s;const b=a.createImageData(c.size[0],c.size[1]);b.data.set(new Uint8ClampedArray(c.image.buffer));const I={offsetX:u,offsetY:g,rotateClockwise:f,angle:p,rasterizedImage:b,anchorX:y,anchorY:d};l.push(I)}t.width=n-r,t.height=s-o;const c=-r,h=s;for(let m=0;m<l.length;m++){const e=l[m],t=this._imageDataToCanvas(e.rasterizedImage),r=e.rasterizedImage.width,o=e.rasterizedImage.height,n=c-r*(.5+e.anchorX),s=h-o*(.5-e.anchorY);if(e.angle){const r=(360-e.angle)*Math.PI/180;a.save(),a.translate(i.pt2px(e.offsetX),-i.pt2px(e.offsetY)),a.translate(c,h),a.rotate(r),a.translate(-c,-h),a.drawImage(t,n,s),a.restore()}else a.drawImage(t,n+i.pt2px(e.offsetX),s-i.pt2px(e.offsetY))}const u=new g.Symbol3DAnchorPosition2D({x:c/t.width-.5,y:h/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:u}}async _fetchPictureMarkerResource(e,t){const r=e.materialHash;if(!this._pictureMarkerCache.get(r)){const i=(await a(e.cim.url,{responseType:"image",signal:t?.signal})).data;this._pictureMarkerCache.set(r,i)}}_imageDataToCanvas(e){const t=this._imageDataCanvas,a=this._imageDataContext;return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t}_imageTo32Array(e,a,r,i){const o=this._imageDataCanvas,n=this._imageDataContext;if(o.width=a,o.height=r,n.drawImage(e,0,0,a,r),i){n.save();const o=new t(i);n.fillStyle=o.toHex(),n.globalCompositeOperation="multiply",n.fillRect(0,0,a,r),n.globalCompositeOperation="destination-atop",n.drawImage(e,0,0,a,r),n.restore()}return new Uint32Array(n.getImageData(0,0,a,r).data.buffer)}_getRasterizedResource(e,t,a,r,i,o){let n,s,l;const c=null,h=null;if("text"===e.type)return this._rasterizeTextResource(e,t,r,i,o);({analyzedCIM:n,hash:s}=C(e,t,i,o));const g=y(r);if("CIMPictureMarker"===e.cim.type){const a=u.evaluateValueOrFunction(e.size,t,i,o)*g,{image:r,width:n,height:s}=this._getPictureResource(e,a,u.evaluateValueOrFunction(e.color,t,i,o));return l={image:r,size:[n,s],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},l}m.scaleCIMMarker(n,g,{preserveOutlineWidth:!1});const d=n;s+=a,r&&(s+=JSON.stringify(r));const f=this._resourceCache;return f.has(s)?f.get(s):(l=this._rasterizer.rasterizeJSONResource({cim:d,type:e.type,url:e.url,mosaicHash:s,size:c,path:h},window.devicePixelRatio||1,this._avoidSDF),f.set(s,l),l)}_rasterizeTextResource(e,t,a,r,i){const o=y(a),n=u.evaluateValueOrFunction(e.text,t,r,i);if(!n||0===n.length)return null;const s=e.cim,l=u.evaluateValueOrFunction(s?.fontFamilyName||e.fontName,t,r,i),c=u.evaluateValueOrFunction(s?.font?.style||e.style,t,r,i),h=u.evaluateValueOrFunction(s?.font?.weight||e.weight,t,r,i),m=u.evaluateValueOrFunction(s?.font?.decoration||e.decoration,t,r,i),g=u.evaluateValueOrFunction(e.size,t,r,i)*o,d=u.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),f=u.evaluateValueOrFunction(e.verticalAlignment,t,r,i),p=u.colorToArray(u.evaluateValueOrFunction(e.color,t,r,i)),C=u.colorToArray(u.evaluateValueOrFunction(e.outlineColor,t,r,i)),w=u.evaluateValueOrFunction(e.outlineSize,t,r,i),M=null!=e.backgroundColor?u.colorToArray(e.backgroundColor):null,v=null!=e.borderLineColor?u.colorToArray(e.borderLineColor):null,b=null!=e.borderLineWidth?e.borderLineWidth:null,I={color:p,size:g,horizontalAlignment:d,verticalAlignment:f,font:{family:l,style:c,weight:h,decoration:m},halo:{size:w||0,color:C,style:c},backgroundColor:M,borderLine:null!=v&&null!=b?{color:v,size:b}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(n,I)}_getPictureResource(e,t,a){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const o=r.height/r.width,n=t?o>1?i.pt2px(t):i.pt2px(t)/o:r.width,s=t?o>1?i.pt2px(t)*o:i.pt2px(t):r.height;return{image:this._imageTo32Array(r,n,s,a),width:n,height:s}}}function p(e,t,a,r){const i=1,o=-t/2+i,n=t/2-i,s=a/2-i,l=-a/2+i;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[n,0]]]};default:return"legend"===r?{rings:[[[o,s],[n,0],[n,l],[o,l],[o,s]]]}:{rings:[[[o,s],[n,s],[n,l],[o,l],[o,s]]]}}}function C(e,t,a,r){let i,n;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,a,r),n=o.analyzeCIMResource(e.cim,e.materialOverrides)}else i=e.materialHash,n=e.cim;return{analyzedCIM:n,hash:i}}e.CIMSymbolRasterizer=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
