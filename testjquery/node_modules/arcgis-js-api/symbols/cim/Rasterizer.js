/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["../../core/mathUtils","./CIMSymbolHelper","./rasterizingUtils","./Rect","./SDFHelper","./utils"],(function(e,a,t,r,i,n){"use strict";const s=512;class l{constructor(e){this._resourceManager=e,this._lazyRasterizationCanvas=null}dispose(){this._lazyRasterizationCanvas=null}get _rasterizationCanvas(){return null==this._lazyRasterizationCanvas&&(this._lazyRasterizationCanvas=document.createElement("canvas"),this._lazyRasterizationCanvas.getContext("2d",{willReadFrequently:!0})),this._lazyRasterizationCanvas}rasterizeJSONResource(n,s,l){if("simple-fill"===n.type||"esriSFS"===n.type){const[a,r,i]=t.rasterizeSimpleFill(this._rasterizationCanvas,n.style,s);return{size:[r,i],image:new Uint32Array(a.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:e.nextPowerOfTwo(Math.ceil(s))}}if("simple-line"===n.type||"esriSLS"===n.type||"line"===n.type&&n.dashTemplate){let e,r;if("simple-line"===n.type||"esriSLS"===n.type)switch(e=a.slsDashToTemplateArray(n.style,n.cap),n.cap){case"butt":r="Butt";break;case"square":r="Square";break;default:r="Round"}else e=n.dashTemplate,r=n.cim.capStyle;const[i,s,l]=t.rasterizeDash(e,r);return{size:[s,l],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let o,m=null,c=null,f=1;if("simple-marker"===n.type||"esriSMS"===n.type||"line-marker"===n.type?(o=a.CIMSymbolHelper.fromSimpleMarker(n),c=i.getSDFInfo(o)):n.cim&&"CIMHatchFill"===n.cim.type?(o=a.CIMSymbolHelper.fromCIMHatchFill(n.cim,s),m=new r(o.frame.xmin,-o.frame.ymax,o.frame.xmax-o.frame.xmin,o.frame.ymax-o.frame.ymin),f=s):n.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===n.cim.markerPlacement.type?(o=a.CIMSymbolHelper.fromCIMInsidePolygon(n.cim),m=new r(o.frame.xmin,-o.frame.ymax,o.frame.xmax-o.frame.xmin,o.frame.ymax-o.frame.ymin)):(o=n.cim,n.avoidSDFRasterization||(c=i.getSDFInfo(o))),c&&!l){const[e,a,t]=i.buildSDF(c);return e?{size:[a,t],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:f}:null}const[h,y,u,p,z]=a.CIMSymbolHelper.rasterize(this._rasterizationCanvas,o,m,this._resourceManager,!l);return h?{size:[y,u],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1,anchorX:p,anchorY:z}:null}rasterizeImageResource(e,a,t,r){this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=a;const i=this._rasterizationCanvas.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):(t.setAttribute("width",`${e}px`),t.setAttribute("height",`${a}px`),i.drawImage(t,0,0,e,a));const l=i.getImageData(0,0,e,a),o=new Uint8Array(l.data);if(r)for(const n of r)if(n&&n.oldColor&&4===n.oldColor.length&&n.newColor&&4===n.newColor.length){const[e,a,t,r]=n.oldColor,[i,s,l,m]=n.newColor;if(e===i&&a===s&&t===l&&r===m)continue;for(let n=0;n<o.length;n+=4)e===o[n]&&a===o[n+1]&&t===o[n+2]&&r===o[n+3]&&(o[n]=i,o[n+1]=s,o[n+2]=l,o[n+3]=m)}let m;for(let n=0;n<o.length;n+=4)m=o[n+3]/255,o[n]=o[n]*m,o[n+1]=o[n+1]*m,o[n+2]=o[n+2]*m;let c=o,f=e,h=a;const y=s;if(f>=y||h>=y){const t=f/h;t>1?(f=y,h=Math.round(y/t)):(h=y,f=Math.round(y*t)),c=new Uint8Array(4*f*h);const r=new Uint8ClampedArray(c.buffer);n.resampleHermite(o,e,a,r,f,h,!1)}return{size:[f,h],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}return l}));
