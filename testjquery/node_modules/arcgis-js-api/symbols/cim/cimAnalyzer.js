/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../core/fontUtils","../../core/lang","../../core/Logger","../../core/screenUtils","../../core/string","../../support/arcadeOnDemand","./CIMSymbolDrawHelper","./CIMSymbolHelper","./enums","./quantizeTime","./SDFHelper","./utils","./effects/CIMEffectHelper","../../views/2d/arcade/callExpressionWithFeature","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/grouping"],(function(e,t,i,r,o,n,a,l,s,c,u,m,f,h,p,y,d,v){"use strict";const g=o.getLogger("esri.symbols.cim.cimAnalyzer");function S(e){switch(e){case"Butt":return u.CapType.BUTT;case"Square":return u.CapType.SQUARE;default:return u.CapType.ROUND}}function O(e){switch(e){case"Bevel":return u.JoinType.BEVEL;case"Miter":return u.JoinType.MITER;default:return u.JoinType.ROUND}}function F(e){const t=e.markerPlacement;return t&&t.angleToLine?u.Alignment.MAP:u.Alignment.SCREEN}class _{constructor(e,t){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],this._resourceManager=e,this._info=t}async analyzeSymbolReference(e,t,i){if(this._cimLayers=i??[],!e)return this._cimLayers;if(e.primitiveOverrides){this._primitiveOverrides=e.primitiveOverrides,this._poMap={};const t=[],i=this._info;for(const e of this._primitiveOverrides){const r=e.valueExpressionInfo;if(r&&i){const o=r.expression,n=l.createRendererExpression(o,i.spatialReference,i.fields).then((t=>{null!=t&&this._setPoMap(e.primitiveName,e.propertyName,t)}));t.push(n)}else null!=e.value&&this._setPoMap(e.primitiveName,e.propertyName,e.value);t.length>0&&await Promise.all(t)}}const r=e.symbol,o=[];return c.CIMSymbolHelper.fetchResources(r,this._resourceManager,o),o.length>0&&await Promise.all(o),this._analyzeSymbol(r,t),this._cimLayers}_analyzeSymbol(e,t){switch(e?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,t,1,0,0,0)}}_analyzeMultiLayerSymbol(e,t,i,r,o,n){const a=e?.symbolLayers;if(!a)return;const l=e.effects;let s=u.Alignment.SCREEN;const m=c.CIMSymbolHelper.getSize(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(s=u.Alignment.MAP);const f="CIMPolygonSymbol"===e.type;let h=a.length;for(;h--;){const u=a[h];if(!u||!1===u.enable)continue;let p;l?.length&&(p=[...l]);const y=u.effects;y?.length&&(l?p.push(...y):p=[...y]);const d=[];let v;c.OverrideHelper.findEffectOverrides(p,this._primitiveOverrides,d),v=d.length>0?this._createEffectsOverrideFunction(p,d):p;const S=[];switch(c.OverrideHelper.findApplicableOverrides(u,this._primitiveOverrides,S),u.type){case"CIMSolidFill":this._analyzeSolidFill(u,v);break;case"CIMPictureFill":this._analyzePictureFill(u,v);break;case"CIMHatchFill":this._analyzeHatchFill(u,v);break;case"CIMGradientFill":this._analyzeGradientFill(u,v);break;case"CIMSolidStroke":this._analyzeSolidStroke(u,v,f,m);break;case"CIMPictureStroke":this._analyzePictureStroke(u,v,f,m);break;case"CIMGradientStroke":this._analyzeGradientStroke(u,v,f,m);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"===e.type&&(s=F(u));const a=[],l=u.primitiveName;l&&a.push(l),this._analyzeMarker(u,v,null,a,s,m,1,t,i,r,o,n);break}default:g.error("Cannot analyze CIM layer",u.type)}}}_analyzeSolidFill(e,t){const i=e.primitiveName,r=h.fromCIMColor(e.color),[o,n]=this._analyzePrimitiveOverrides(i,t,null,null),l=a.numericHash(JSON.stringify(e)+n).toString();this._cimLayers.push({type:"fill",templateHash:l,materialHash:o?()=>l:l,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,color:this._createOverrideFunction(i,"Color",r,C),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t,applyRandomOffset:!1,sampleAlphaOnly:!0})}_analyzePictureFill(e,t){const i=e.primitiveName,r=h.getTintColor(e),[o,n]=this._analyzePrimitiveOverrides(i,t,null,null),l=a.numericHash(JSON.stringify(e)+n).toString(),c=a.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),u=h.getValue(e.height,s.defaultPictureFillHeight);let m=h.getValue(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const t=e.width;let i=1;const r=this._resourceManager.getResource(e.url);null!=r&&(i=r.width/r.height),m/=i*(u/t)}this._cimLayers.push({type:"fill",templateHash:l,materialHash:o?()=>c:c,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(i,"TintColor",r,C),height:this._createOverrideFunction(i,"Height",u),scaleX:this._createOverrideFunction(i,"ScaleX",m),angle:this._createOverrideFunction(i,"Rotation",h.getValue(e.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",h.getValue(e.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",h.getValue(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeHatchFill(e,t){const i=e.primitiveName,r=this._analyzeMaterialOverrides(i,["Rotation","OffsetX","OffsetY"]);let[o,n]=this._analyzePrimitiveOverrides(i,t,null,null);const l=a.numericHash(JSON.stringify(e)+n).toString(),c=a.numericHash(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1},m=!1;const f=e.lineSymbol?.symbolLayers?.find((e=>"CIMSolidStroke"===e.type&&null!=this._poMap[e.primitiveName]?.Color));if(f){u=h.fromCIMColor(f.color),u=this._createOverrideFunction(f.primitiveName,"Color",u,C);const e="function"==typeof u;o=o||e,m=null!=f.color||e}this._cimLayers.push({type:"fill",templateHash:l,materialHash:o&&r?this._createMaterialHashFunction(c,r):c,cim:e,materialOverrides:r,colorLocked:!!e.colorLocked,effects:t,color:u,height:this._createOverrideFunction(i,"Separation",h.getValue(e.separation,s.defaultHatchFillSeparation)),scaleX:1,angle:this._createOverrideFunction(i,"Rotation",h.getValue(e.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",h.getValue(e.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",h.getValue(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!m})}_analyzeGradientFill(e,t){const i=e.primitiveName,[r,o]=this._analyzePrimitiveOverrides(i,t,null,null),n=a.numericHash(JSON.stringify(e)+o).toString();this._cimLayers.push({type:"fill",templateHash:n,materialHash:r?()=>n:n,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeSolidStroke(e,t,i,r){const o=e.primitiveName,n=h.fromCIMColor(e.color),l=h.getValue(e.width,s.defaultStrokeWidth),c=S(e.capStyle),u=O(e.joinStyle),m=e.miterLimit,[f,p]=this._analyzePrimitiveOverrides(o,t,null,null),y=a.numericHash(JSON.stringify(e)+p).toString();let d,v;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();d=e.dashTemplate,v=e.scaleDash}}this._cimLayers.push({type:"line",templateHash:y,materialHash:f?()=>y:y,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(o,"Color",n,C),width:this._createOverrideFunction(o,"Width",l),cap:this._createOverrideFunction(o,"CapStyle",c),join:this._createOverrideFunction(o,"JoinStyle",u),miterLimit:m&&this._createOverrideFunction(o,"MiterLimit",m),referenceWidth:r,zOrder:M(e.name),dashTemplate:d,scaleDash:v,sampleAlphaOnly:!0})}_analyzePictureStroke(e,t,i,r){const o=a.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),n=e.primitiveName,l=h.getTintColor(e),c=h.getValue(e.width,s.defaultStrokeWidth),u=S(e.capStyle),m=O(e.joinStyle),f=e.miterLimit,[p,y]=this._analyzePrimitiveOverrides(n,t,null,null),d=a.numericHash(JSON.stringify(e)+y).toString();this._cimLayers.push({type:"line",templateHash:d,materialHash:p?()=>o:o,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(n,"TintColor",l,C),width:this._createOverrideFunction(n,"Width",c),cap:this._createOverrideFunction(n,"CapStyle",u),join:this._createOverrideFunction(n,"JoinStyle",m),miterLimit:f&&this._createOverrideFunction(n,"MiterLimit",f),referenceWidth:r,zOrder:M(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}_analyzeGradientStroke(e,t,i,r){const o=e.primitiveName,n=h.getValue(e.width,s.defaultStrokeWidth),l=S(e.capStyle),c=O(e.joinStyle),u=e.miterLimit,[m,f]=this._analyzePrimitiveOverrides(o,t,null,null),p=a.numericHash(JSON.stringify(e)+f).toString();this._cimLayers.push({type:"line",templateHash:p,materialHash:m?()=>p:p,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:this._createOverrideFunction(o,"Width",n),cap:this._createOverrideFunction(o,"CapStyle",l),join:this._createOverrideFunction(o,"JoinStyle",c),miterLimit:u&&this._createOverrideFunction(o,"MiterLimit",u),referenceWidth:r,zOrder:M(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(e,t,i,r,o,n,a,l,c,u,m,f,p=!1){if(this._analyzeMarkerInsidePolygon(e,t))return;const y=h.getValue(e.size,s.defaultMarkerSize),d=h.getValue(e.rotation),v=h.getValue(e.offsetX),g=h.getValue(e.offsetY);let S=this._createOverrideFunction(e.primitiveName,"Size",y),O=this._createOverrideFunction(e.primitiveName,"Rotation",d),F=this._createOverrideFunction(e.primitiveName,"OffsetX",v),_=this._createOverrideFunction(e.primitiveName,"OffsetY",g);S=this._transformSize(S,a),O=this._transformRotation(O,!!e.rotateClockwise,u);const M=this._transformOffsetX(F,_,u,a,m),C=this._transformOffsetY(F,_,u,a,f);switch(F=M,_=C,e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,t,i,r,o,n,S,O,F,_,e.colorLocked||p);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,t,i,r,o,n,a,l,S,O,F,_,e.colorLocked||p)}}_analyzeMarkerInsidePolygon(e,t){const{markerPlacement:i,type:r}=e;if(!i||"CIMMarkerPlacementInsidePolygon"!==i.type)return!1;if("CIMVectorMarker"===r||"CIMPictureMarker"===r){const o=e.primitiveName;if(o){const[e,i]=this._analyzePrimitiveOverrides([o],t,null,null);if(e)return!1}const n=i.primitiveName;if(n){const[e,i]=this._analyzePrimitiveOverrides([n],t,null,null);if(e)return!1}if("CIMVectorMarker"===r){const{markerGraphics:t}=e;if(t)for(const e of t){const{symbol:t}=e;if("CIMPolygonSymbol"===t?.type&&t.symbolLayers){const{symbolLayers:e}=t;for(const t of e)if("CIMSolidStroke"===t.type)return!1}}}else{const{animatedSymbolProperties:t}=e;if(t)return!1}}const o=i,l=Math.abs(o.stepX),s=Math.abs(o.stepY);if(0===l||0===s)return!0;const c=new Set(["Rotation","OffsetX","OffsetY"]),u=this._primitiveOverrides.filter((t=>t.primitiveName!==e.primitiveName||!c.has(t.propertyName))),m="url"in e&&"string"==typeof e.url?e.url:void 0,f=a.numericHash(JSON.stringify(e)).toString();let p,y,v=null;if("Random"===i.gridType){const e=n.px2pt(d.randomInsidePolygonTextureSize),t=Math.max(Math.floor(e/l),1),i=Math.max(Math.floor(e/s),1);p=s*i,v=e=>e?e*i:0;y=t*l/p}else i.shiftOddRows?(p=2*s,v=e=>e?2*e:0,y=l/s*.5):(p=s,v=null,y=l/s);const g=h.getTintColor(e);return this._cimLayers.push({type:"fill",templateHash:f,materialHash:f,cim:e,materialOverrides:u,colorLocked:!!e.colorLocked,effects:t,color:g,height:this._createOverrideFunction(o.primitiveName,"StepY",p,v),scaleX:y,angle:o.gridAngle,offsetX:h.getValue(o.offsetX),offsetY:h.getValue(o.offsetY),url:m,applyRandomOffset:"Random"===i.gridType,sampleAlphaOnly:!m,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(e,t,i,r,o,n,l,s,c,u,m){let f=h.getValue(e.scaleX,1);const p=h.getTintColor(e),y=a.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString();i||(i=this._createMarkerPlacementOverrideFunction(e.markerPlacement));const d=this._createAnimatedSymbolPropertiesOverrideFunction(e.animatedSymbolProperties),[g,S]=this._analyzePrimitiveOverrides(r,t,i,d),O=a.numericHash(JSON.stringify(e)+S).toString(),F=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const t=e.width;let i=1;const r=this._resourceManager.getResource(e.url);null!=r&&(i=r.width/r.height);f/=i*(h.getValue(e.size)/t)}function _(e,t){return null!=d?h.evaluateValueOrFunction(d,e,t):null}const M=e.animatedSymbolProperties&&!0===e.animatedSymbolProperties.randomizeStartTime?(e,t,i,r)=>{const o=v.getMaterialGroup(r??0),n=_(e,t);return y+`-MATERIALGROUP(${o})`+`-ASP(${JSON.stringify(n)})`}:g?(e,t)=>{const i=_(e,t);return y+`-ASP(${JSON.stringify(i)})`}:y;this._cimLayers.push({type:"marker",templateHash:O,materialHash:M,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked||!!m,effects:t,scaleSymbolsProportionally:!1,alignment:o,size:l,scaleX:this._createOverrideFunction(e.primitiveName,"ScaleX",f),rotation:s,offsetX:c,offsetY:u,color:this._createOverrideFunction(e.primitiveName,"TintColor",p,C),anchorPoint:{x:F.x,y:F.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!1,referenceSize:n,sizeRatio:1,markerPlacement:i,url:e.url,animatedSymbolProperties:d})}_analyzeVectorMarker(e,t,i,r,o,n,a,l,s,c,u,m,f){const h=e.markerGraphics;if(!h)return;const p=e.frame;let y=0,d=1;e.scaleSymbolsProportionally&&p&&(y=p.ymax-p.ymin,d=this._transformSize(s,1/y)),d=this._transformSize(d,a),i||(i=this._createMarkerPlacementOverrideFunction(e.markerPlacement));for(const v of h)if(v){const a=v.symbol;if(!a)continue;const h=v.primitiveName;h&&r.push(h);let g=u,S=m;if(("CIMPointSymbol"===a.type||"CIMTextSymbol"===a.type)&&p){let t=0,i=0;const r=v.geometry;"x"in r&&"y"in r&&(t+=r.x-.5*(p.xmin+p.xmax),i+=r.y-.5*(p.ymin+p.ymax));const o=e.anchorPoint;o&&("Absolute"===e.anchorPointUnits?(t-=o.x,i-=o.y):p&&(t-=(p.xmax-p.xmin)*o.x,i-=(p.ymax-p.ymin)*o.y)),g=this._transformOffsetX(t,i,c,d,u),S=this._transformOffsetY(t,i,c,d,m)}switch(a.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":l||P(a)?this._analyzeMultiLayerGraphicNonSDF(e,t,i,null,v,r,o,n,y,!!f||!!e.colorLocked):this._analyzeMultiLayerGraphic(e,t,i,null,v,r,o,n,y,d,s,c,g,S,!!f||!!e.colorLocked);break;case"CIMTextSymbol":this._analyzeTextGraphic(e,t,i,v,r,o,n,y,d,s,c,g,S,!!f||!!e.colorLocked)}h&&r.pop()}}_analyzeMultiLayerGraphic(e,t,i,r,o,n,l,s,c,u,m,y,d,v,g){const S=o.symbol,O=S.symbolLayers;if(!O)return;let F=O.length;if(N(O))return void this._analyzeCompositeMarkerGraphic(e,t,i,r,o,O,n,l,s,c,m,y,d,v,!!g||!!e.colorLocked);const _=this._resourceManager.geometryEngine,M=p.CIMEffectHelper.applyEffects(S.effects,o.geometry,_);if(M)for(;F--;){const S=O[F];if(!S||!1===S.enable)continue;const k=S.primitiveName;switch(k&&n.push(k),S.type){case"CIMSolidFill":case"CIMSolidStroke":{const u=p.CIMEffectHelper.applyEffects(S.effects,M,_),O=f.getExtent(u);if(!O)continue;const F="Relative"!==e.anchorPointUnits,[b,N,P]=f.getSDFMetrics(O,e.frame,e.size,e.anchorPoint,F),z="CIMSolidFill"===S.type,L={type:"sdf",geom:u,asFill:z},I=S.path,V=z?h.fromCIMColor(h.getFillColor(S)):null==I?h.fromCIMColor(h.getStrokeColor(S)):{r:0,g:0,b:0,a:0},H=z?{r:0,g:0,b:0,a:0}:h.fromCIMColor(h.getStrokeColor(S)),x=h.getStrokeWidth(S)??0;if(!z&&!x)break;const A=o.primitiveName;let w=null;z&&!S.colorLocked&&(w=this._createOverrideFunction(A,"FillColor",V,C));let R=null;z||S.colorLocked||(R=this._createOverrideFunction(A,"StrokeColor",H,C));const X=this._createOverrideFunction(A,"StrokeWidth",x);let T=!1,E="";for(const e of this._primitiveOverrides)n.includes(e.primitiveName)&&(null!=e.value?E+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(T=!0));(null!=t&&"function"==typeof t||null!=i&&"function"==typeof i)&&(T=!0),(h.isFeatureValueFn(m)||h.isFeatureValueFn(y)||h.isFeatureValueFn(d)||h.isFeatureValueFn(v))&&(T=!0);const J=JSON.stringify({...e,markerGraphics:null}),Y=a.numericHash(JSON.stringify(L)+I).toString(),G=a.numericHash(JSON.stringify(o)+JSON.stringify(S)+J+E).toString();this._cimLayers.push({type:"marker",templateHash:G,materialHash:T?()=>Y:Y,cim:L,materialOverrides:null,colorLocked:!!S.colorLocked||!!g,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:l,anchorPoint:{x:N,y:P},isAbsoluteAnchorPoint:F,size:m,rotation:y,offsetX:d,offsetY:v,scaleX:1,frameHeight:c,rotateClockwise:!1,referenceSize:s,sizeRatio:b,color:h.isFeatureValueFn(w)?w:this._createOverrideFunction(k,"Color",V,C),outlineColor:h.isFeatureValueFn(R)?R:this._createOverrideFunction(k,"Color",H,C),outlineWidth:h.isFeatureValueFn(X)?X:this._createOverrideFunction(k,"Width",x),markerPlacement:i,animatedSymbolProperties:r,path:I});break}case"CIMVectorMarker":S.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,t,i,r,o,n,l,s,c,!!g||!!S.colorLocked):this._analyzeMarker(S,t,i,n,l,s,u,!1,m,y,d,v,!!g||!!e.colorLocked);break;default:this._analyzeMultiLayerGraphicNonSDF(e,t,i,r,o,n,l,s,c,!!g||!!e.colorLocked)}k&&n.pop()}}_analyzeTextGraphic(e,t,r,o,n,l,u,m,f,p,y,d,v,g){const S=[];c.OverrideHelper.findApplicableOverrides(o,this._primitiveOverrides,S);const O=o.geometry;if(!("x"in O)||!("y"in O))return;const F=o.symbol,_=h.fromCIMFontDecoration(F),M=h.fromCIMFontStyle(F.fontStyleName),k=i.getFontFamily(F.fontFamilyName);F.font={family:k,decoration:_,...M};let b=h.getValue(F.height,s.defaultTextHeight),N=h.getValue(F.angle),P=h.getValue(F.offsetX),z=h.getValue(F.offsetY);b=this._transformSize(b,f),N=this._transformRotation(N,!1,y);const L=this._transformOffsetX(P,z,y,f,d),I=this._transformOffsetY(P,z,y,f,v);P=L,z=I;const V=h.fromCIMColor(h.getFillColor(F));let H=h.fromCIMColor(h.getStrokeColor(F)),x=h.getStrokeWidth(F)??0;x||(H=h.fromCIMColor(h.getFillColor(F.haloSymbol)),x=h.getValue(F.haloSize)),x=this._transformSize(x,f);let A=!1;if(F.symbol?.symbolLayers)for(const i of F.symbol.symbolLayers){null!=h.getFillColor(i)&&(A=!!i.colorLocked)}const w=o.primitiveName;let R=null;A||(R=this._createOverrideFunction(w,"Color",V,C));let X=null,T=null,E=0;if(F.callout&&"CIMBackgroundCallout"===F.callout.type){const e=F.callout;if(e.backgroundSymbol){const t=e.backgroundSymbol.symbolLayers;if(t)for(const e of t)"CIMSolidFill"===e.type?X=h.fromCIMColor(e.color):"CIMSolidStroke"===e.type&&(T=h.fromCIMColor(e.color),E=h.getValue(e.width,s.defaultStrokeWidth))}}const[J,Y]=this._analyzePrimitiveOverrides(n,t,r,null),G=JSON.stringify(e.effects)+Number(e.colorLocked||g).toString()+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement)+e.size.toString(),$=a.numericHash(JSON.stringify(o)+G+Y).toString();let D=this._createOverrideFunction(o.primitiveName,"TextString",o.textString??"",h.adjustTextCase,F.textCase);if(null==D)return;const{fontStyleName:W}=F,U=k+(W?"-"+W.toLowerCase():"-regular"),j=U;"string"==typeof D&&D.includes("[")&&F.fieldMap&&(D=h.createLabelOverrideFunction(F.fieldMap,D,F.textCase)),this._cimLayers.push({type:"text",templateHash:$,materialHash:J||"function"==typeof D||/\[(.*?)\]/.test(D)?(e,t,i)=>j+"-"+h.evaluateValueOrFunction(D,e,t,i):j+"-"+a.numericHash(D),cim:F,materialOverrides:null,colorLocked:!!g||!!A,effects:t,alignment:l,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:U,decoration:_,weight:M.weight,style:M.style,size:b,angle:N,offsetX:P,offsetY:z,horizontalAlignment:h.fromCIMHorizontalAlignment(F.horizontalAlignment),verticalAlignment:h.fromCIMVerticalAlignment(F.verticalAlignment),text:D,color:h.isFeatureValueFn(R)?R:V,outlineColor:H,outlineSize:x,backgroundColor:X,borderLineColor:T,borderLineWidth:E,lineWidth:null,referenceSize:u,sizeRatio:1,markerPlacement:r})}_analyzeMultiLayerGraphicNonSDF(e,t,i,r,o,l,u,m,f,p){const y=this._buildSimpleMarker(e,o),d=e.primitiveName,v=this._analyzeMaterialOverrides(d,["Rotation","OffsetX","OffsetY"]),[g,S]=this._analyzePrimitiveOverrides(l,null,null,null),[O,F,_]=c.CIMSymbolHelper.getTextureAnchor(y,this._resourceManager),M=h.getValue(e.rotation),C=h.getValue(e.offsetX),k=h.getValue(e.offsetY),b=a.numericHash(JSON.stringify(y)+S).toString(),N=v&&v.length>0||null!=t&&"function"==typeof t;this._cimLayers.push({type:"marker",templateHash:b,materialHash:N&&v?this._createMaterialHashFunction(b,v):b,cim:y,materialOverrides:v,colorLocked:!!e.colorLocked||!!p,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:O,y:F},isAbsoluteAnchorPoint:!1,size:h.getValue(e.size,s.defaultMarkerSize),rotation:this._createOverrideFunction(d,"Rotation",M),offsetX:this._createOverrideFunction(d,"OffsetX",C),offsetY:this._createOverrideFunction(d,"OffsetY",k),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:f,rotateClockwise:!!e.rotateClockwise,referenceSize:m,sizeRatio:_/n.pt2px(e.size),markerPlacement:i,animatedSymbolProperties:r,avoidSDFRasterization:!0})}_buildSimpleMarker(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}_analyzeCompositeMarkerGraphic(e,t,i,r,o,n,l,c,u,m,p,y,d,v,g){const S=o.geometry,O=n[0],F=n[1],_=f.getExtent(S);if(!_)return;const M="Relative"!==e.anchorPointUnits,[k,b,N]=f.getSDFMetrics(_,e.frame,e.size,e.anchorPoint,M),P={type:"sdf",geom:S,asFill:!0},z=F.path,L=F.primitiveName,I=O.primitiveName,V=h.fromCIMColor(F.color),H=h.fromCIMColor(O.color),x=h.getValue(O.width,s.defaultStrokeWidth),A=o.primitiveName;let w=null;F.colorLocked||g||(w=this._createOverrideFunction(A,"FillColor",V,C));let R=null;O.colorLocked||g||(R=this._createOverrideFunction(A,"StrokeColor",H,C));const X=this._createOverrideFunction(A,"StrokeWidth",x);let T=!1,E="";for(const a of this._primitiveOverrides)(a.primitiveName===L||a.primitiveName===I||l.includes(a.primitiveName))&&(null!=a.value?E+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(T=!0));null!=i&&"function"==typeof i&&(T=!0),(h.isFeatureValueFn(p)||h.isFeatureValueFn(y)||h.isFeatureValueFn(d)||h.isFeatureValueFn(v))&&(T=!0);const J=JSON.stringify({...e,markerGraphics:null}),Y=a.numericHash(JSON.stringify(P)+z).toString(),G=a.numericHash(JSON.stringify(o)+JSON.stringify(F)+JSON.stringify(O)+J+E).toString();this._cimLayers.push({type:"marker",templateHash:G,materialHash:T?()=>Y:Y,cim:P,materialOverrides:null,colorLocked:!!g,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:b,y:N},isAbsoluteAnchorPoint:M,size:p,rotation:y,offsetX:d,offsetY:v,scaleX:1,frameHeight:m,rotateClockwise:!1,referenceSize:u,sizeRatio:k,color:h.isFeatureValueFn(w)?w:this._createOverrideFunction(L,"Color",V,C),outlineColor:h.isFeatureValueFn(R)?R:this._createOverrideFunction(I,"Color",H,C),outlineWidth:h.isFeatureValueFn(X)?X:this._createOverrideFunction(I,"Width",x),markerPlacement:i,path:z,animatedSymbolProperties:r})}_createMaterialHashFunction(e,t){const i=this._info?.geometryType;if(i){const e=this._poMap;for(const r of t){if(r.valueExpressionInfo){const t=e[r.primitiveName]&&e[r.primitiveName][r.propertyName];t instanceof l.ArcadeExpression&&(r.fn=(e,r,o)=>y(t,e,{$view:o},i,r))}}}return(i,r,o)=>{for(const e of t)e.fn&&(e.value=e.fn(i,r,o));return a.numericHash(e+c.OverrideHelper.buildOverrideKey(t)).toString()}}_setPoMap(e,t,i){let r;this._poMap[e]?r=this._poMap[e]:(r={},this._poMap[e]=r),r[t]=i}_createOverrideFunction(e,t,i,r,o){if(null==e)return i;const n=this._poMap[e];if(null==n)return i;const a=n[t];if("string"==typeof a||"number"==typeof a||a instanceof Array)return r?r.call(null,a,o):a;const s=this._info?.geometryType;return null!=a&&a instanceof l.ArcadeExpression&&null!=s?(e,t,n)=>{let l=y(a,e,{$view:n},s,t);return null!==l&&r&&(l=r.call(null,l,o)),null!==l?l:i}:i}_createEffectsOverrideFunction(e,t){const i=this._poMap,o=this._info?.geometryType;for(const r of t){if(r.valueExpressionInfo&&o){const e=i[r.primitiveName]&&i[r.primitiveName][r.propertyName];e instanceof l.ArcadeExpression&&(r.fn=(t,i,r)=>y(e,t,{$view:r},o,i))}}return(i,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,o,n));const a=[];for(let l of e){const e=l?.primitiveName;if(e){let i=!1;for(const o of t)if(o.primitiveName===e){const e=k(o.propertyName);null!=o.value&&o.value!==l[e]&&(i||(l=r.clone(l),i=!0),l[e]=o.value)}}a.push(l)}return a}}_createMarkerPlacementOverrideFunction(e){const t=[];if(c.OverrideHelper.findApplicableOverrides(e,this._primitiveOverrides,t),null==e||0===t.length)return e;const i=this._poMap,o=this._info?.geometryType;for(const r of t){if(r.valueExpressionInfo&&o){const e=i[r.primitiveName]&&i[r.primitiveName][r.propertyName];e instanceof l.ArcadeExpression&&(r.fn=(t,i,r)=>y(e,t,{$view:r},o,i))}}return(i,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,o,n));const a=r.clone(e),l=e.primitiveName;for(const e of t)if(e.primitiveName===l){const t=k(e.propertyName);null!=e.value&&e.value!==a[t]&&(a[t]=e.value)}return a}}_createAnimatedSymbolPropertiesOverrideFunction(e){const t=[];if(c.OverrideHelper.findApplicableOverrides(e,this._primitiveOverrides,t),null==e||0===t.length)return e;const i=this._info?.geometryType;if(i){const e=this._poMap;for(const r of t){if(r.valueExpressionInfo){const t=e[r.primitiveName]&&e[r.primitiveName][r.propertyName];t instanceof l.ArcadeExpression&&(r.fn=(e,r,o)=>y(t,e,{$view:o},i,r))}}}return(i,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,o,n));const a=r.clone(e),l=e.primitiveName;for(const e of t)if(e.primitiveName===l){const t=k(e.propertyName);if(null!=e.value){const i=m.quantizeIfNeeded(e.value,e.propertyName);i!==a[t]&&(a[t]=i)}}return a}}_analyzePrimitiveOverrides(e,t,i,r){let o=!1,n="";"string"==typeof e&&(e=[e]);for(const a of this._primitiveOverrides)e?.includes(a.primitiveName)&&(null!=a.value?n+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(o=!0));return null!=t&&"function"==typeof t&&(o=!0),null!=i&&"function"==typeof i&&(o=!0),null!=r&&"function"==typeof r&&(o=!0),[o,n]}_analyzeMaterialOverrides(e,t){return this._primitiveOverrides.filter((i=>i.primitiveName!==e||!t.includes(i.propertyName)))}_transformSize(e,t){return h.isFeatureValueFn(e)||h.isFeatureValueFn(t)?(i,r,o)=>(h.isFeatureValueFn(e)?e(i,r,o):e)*(h.isFeatureValueFn(t)?t(i,r,o):t):e*t}_transformRotation(e,t,i){return h.isFeatureValueFn(e)||h.isFeatureValueFn(i)?(r,o,n)=>{const a=h.isFeatureValueFn(e)?e(r,o,n):e,l=h.isFeatureValueFn(i)?i(r,o,n):i;return t?l-a:l+a}:t?i-e:i+e}_transformOffsetX(e,t,i,r,o){if(!(h.isFeatureValueFn(e)||h.isFeatureValueFn(t)||h.isFeatureValueFn(i)||h.isFeatureValueFn(r)||h.isFeatureValueFn(o))){const n=i*Math.PI/180;if(n){const i=Math.cos(n),a=Math.sin(n);return(i*e-a*t)*r+o}return e*r+o}return(n,a,l)=>{let s=h.isFeatureValueFn(i)?i(n,a,l):i;const c=h.isFeatureValueFn(r)?r(n,a,l):r,u=h.isFeatureValueFn(e)?e(n,a,l):e,m=h.isFeatureValueFn(o)?o(n,a,l):o;if(s){s*=Math.PI/180;return(Math.cos(s)*u-Math.sin(s)*(h.isFeatureValueFn(t)?t(n,a,l):t))*c+m}return u*c+m}}_transformOffsetY(e,t,i,r,o){if(!(h.isFeatureValueFn(e)||h.isFeatureValueFn(t)||h.isFeatureValueFn(i)||h.isFeatureValueFn(r)||h.isFeatureValueFn(o))){const n=i*Math.PI/180;if(n){const i=Math.cos(n);return(Math.sin(n)*e+i*t)*r+o}return t*r+o}return(n,a,l)=>{let s=h.isFeatureValueFn(i)?i(n,a,l):i;const c=h.isFeatureValueFn(r)?r(n,a,l):r,u=h.isFeatureValueFn(t)?t(n,a,l):t,m=h.isFeatureValueFn(o)?o(n,a,l):o;if(s){s*=Math.PI/180;const t=Math.cos(s);return(Math.sin(s)*(h.isFeatureValueFn(e)?e(n,a,l):e)+t*u)*c+m}return u*c+m}}}function M(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function C(e){if(!e||0===e.length)return null;const i=new t(e).toRgba();return{r:i[0],g:i[1],b:i[2],a:i[3]}}function k(e){return e?e.charAt(0).toLowerCase()+e.substr(1):e}function b(e,t){if(!t||0===t.length)return e;const i=r.clone(e);return c.OverrideHelper.applyOverrides(i,t),i}const N=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&null==e[0].path&&null==e[1].path&&!e[0].effects&&!e[1].effects;function P(e){const t=e.symbolLayers;if(!t||2!==t.length)return!1;const i=t.find((e=>e.effects?.find((e=>"CIMGeometricEffectDashes"===e.type)))),r=t.find((e=>e.effects?.find((e=>"CIMGeometricEffectAddControlPoints"===e.type))));return!!i&&!!r}e.CIMAnalyzer=_,e.analyzeCIMResource=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
