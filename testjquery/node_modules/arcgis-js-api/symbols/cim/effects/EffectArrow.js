/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../../geometry/GeometryCursor","../../../geometry/geometryCursorCollectUtils","../CIMCursor","../CurveHelper","../enums"],(function(t,e,r,o,n,s){"use strict";const i=1.7320508075688772,c=5,u=s.GeometricEffectArrowType.OpenEnded;class h{static local(){return null===h.instance&&(h.instance=new h),h.instance}execute(t,e,r,o,n){return new l(t,e,r)}}h.instance=null;class l extends o.PathEffectCursor{constructor(t,e,r){super(t,!1,!0),this._curveHelper=new n.CurveHelper,this._width=(void 0!==e.width?e.width:c)*r,this._arrowType=void 0!==e.geometricEffectArrowType?e.geometricEffectArrowType:void 0!==e.arrowType?e.arrowType:u,this._offsetFlattenError=n.pixelTolerance*r}processPath(t){const r=e.GeometryCursor.createEmptyOptimizedCIM(t.geometryType);switch(this._arrowType){case s.GeometricEffectArrowType.OpenEnded:default:this._constructSimpleArrow(r,t,!0);break;case s.GeometricEffectArrowType.Block:this._constructSimpleArrow(r,t,!1);break;case s.GeometricEffectArrowType.Crossed:this._constructCrossedArrow(r,t)}return r}_constructSimpleArrow(t,e,o){const n=e.pathLength();let s=this._width;n<2*s&&(s=n/2);const i=this._curveHelper.getSubCurve(e,0,n-s);if(!i||!i.nextPath())return;i.seekPathStart();const c=s/2;if(this._curveHelper.isEmpty(i))return;const u=r.collectPath(i),h=this._constructOffset(u,-c);if(!h)return;const l=this._constructOffset(u,c);if(!l)return;const f=this._constructArrowBasePoint(h,-c/2);if(!f)return;const P=this._constructArrowBasePoint(l,c/2);if(!P)return;e.seekInPath(e.pathSize-1);const p=[e.x,e.y];t.pushPath(l),t.nextPath(),t.nextPoint(),t.setControlPoint(),t.pushPoint(P),t.nextPoint(),t.setControlPoint(),t.pushPoint(p),t.nextPoint(),t.setControlPoint(),t.pushPoint(f),t.nextPoint(),t.setControlPoint(),t.pushPoints(h.reverse()),t.setControlPoint(),o||(t.setControlPointAt(0),t.setControlPointAt(t.pathSize-1),t.pushPoint(l[0])),t.reset()}_constructCrossedArrow(t,e){const o=e.pathLength();let n=this._width;o<n*(1+i+1)&&(n=o/(1+i+1)),e.seekPathStart();const s=this._curveHelper.getSubCurve(e,0,o-n*(1+i));if(!s)return;s.nextPath();const c=n/2;if(this._curveHelper.isEmpty(s))return;const u=r.collectPath(s),h=this._constructOffset(u,c);if(!h)return;const l=this._constructOffset(u,-c);if(!l)return;const f=this._curveHelper.getSubCurve(e,0,o-n);if(!f)return;if(f.nextPath(),this._curveHelper.isEmpty(f))return;const P=r.collectPath(f),p=this._constructOffset(P,c);if(!p)return;const a=this._constructOffset(P,-c);if(!a)return;const _=p[p.length-1],w=this._constructArrowBasePoint(p,c/2);if(!w)return;const C=a[a.length-1],y=this._constructArrowBasePoint(a,-c/2);if(!y)return;e.seekInPath(e.pathSize-1);const d=[e.x,e.y];t.pushPath(h),t.nextPath(),t.nextPoint(),t.setControlPoint(),t.pushPoint(C),t.nextPoint(),t.setControlPoint(),t.pushPoint(y),t.nextPoint(),t.setControlPoint(),t.pushPoint(d),t.nextPoint(),t.setControlPoint(),t.pushPoint(w),t.nextPoint(),t.setControlPoint(),t.pushPoint(_),t.nextPoint(),t.setControlPoint(),t.pushPoints(l.reverse()),t.nextPoint(),t.setControlPoint(),t.reset()}_constructOffset(t,e){return this._curveHelper.offset(t,e,s.GeometricEffectOffsetMethod.Rounded,4,this._offsetFlattenError)}_constructArrowBasePoint(t,e){if(!t||t.length<2)return null;const r=t[t.length-2],o=t[t.length-1],n=[o[0]-r[0],o[1]-r[1]];return this._curveHelper.normalize(n),[o[0]+n[1]*e,o[1]-n[0]*e]}}t.EffectArrow=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
