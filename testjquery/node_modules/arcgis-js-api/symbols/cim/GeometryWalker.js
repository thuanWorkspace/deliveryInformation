/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../geometry/GeometryCursor","./CurveHelper"],(function(t,e,s){"use strict";const n=1e-7;class i{constructor(){this._values=[],this.extPtGap=0,this.ctrlPtGap=0,this._length=0,this._currentValue=0}isEmpty(){return 0===this._values.length}size(){return this._values.length}init(t,e,s=!0){if(this._setEmpty(),!t||0===t.length)return!1;for(let i=0;i<t.length;i++){let e=Math.abs(t[i]);s&&e<n&&(e=n),this._values.push(e),this._length+=e}return e&&1&t.length&&(this._length*=2),0!==this._length&&(this.ctrlPtGap=this.extPtGap=0,this._currentValue=-1,!0)}scale(t){const e=this._values?this._values.length:0;for(let s=0;s<e;++s)this._values[s]*=t;this._length*=t,this.extPtGap*=t,this.ctrlPtGap*=t}addValue(t){this._length+=t,this._values.push(t)}firstValue(){return this._values[0]}lastValue(){return this._values[this._values.length-1]}nextValue(){return this._currentValue++,this._currentValue===this._values.length&&(this._currentValue=0),this._values[this._currentValue]}reset(){this._currentValue=-1}length(){return this._length}_setEmpty(){this.extPtGap=this.ctrlPtGap=this._length=0,this._currentValue=-1,this._values.length=0}}class h{constructor(){this.pt=null,this.ca=0,this.sa=0}}var r;t.EndType=void 0,(r=t.EndType||(t.EndType={}))[r.FAIL=0]="FAIL",r[r.END=1]="END",r[r.CONTINUE=2]="CONTINUE";class a{constructor(){this.reset()}reset(){this.segment=null,this.segmentLength=0,this.abscissa=0,this.isPathEnd=!1,this.isPartEnd=!1}isValid(){return null!==this.segment}copyTo(t){t.segment=this.segment,t.segmentLength=this.segmentLength,t.abscissa=this.abscissa,t.isPathEnd=this.isPathEnd,t.isPartEnd=this.isPartEnd}}class o extends s.CurveHelper{constructor(t=0,e=!1){super(t,e),this._tolerance=s.pixelTolerance,this._currentPosition=new a}updateTolerance(t){this._tolerance=s.pixelTolerance*t}init(t,e,s=!0){return s?(this._patternLength=e.length(),this._partExtPtGap=e.extPtGap,this._partCtrlPtGap=e.ctrlPtGap):(this._patternLength=0,this._partExtPtGap=0,this._partCtrlPtGap=0),this._currentPosition.reset(),this._partSegCount=0,this._pathCursor=t,this._seg=-1,this._setPosAtNextPart()}curPositionIsValid(){return this._currentPosition.isValid()}nextPosition(e,s=t.EndType.FAIL){const n=new a;return!!this._nextPosition(e,n,null,s)&&(n.copyTo(this._currentPosition),!0)}curPointAndAngle(t){t.pt=this._getPoint(this._currentPosition);const[e,s]=this._getAngleCS(this._currentPosition);t.ca=e,t.sa=s}nextPointAndAngle(e,s,n=t.EndType.FAIL){const i=new a;if(!this._nextPosition(e,i,null,n))return!1;i.copyTo(this._currentPosition),s.pt=this._getPoint(i);const[h,r]=this._getAngleCS(i);return s.ca=h,s.sa=r,!0}nextCurve(s){if(0===s)return null;const n=e.GeometryCursor.createEmptyOptimizedCIM("esriGeometryPolyline");n.startPath(),n.nextPath();const i=new a;return this._nextPosition(s,i,n,t.EndType.END)?(i.copyTo(this._currentPosition),n):null}isPathEnd(){return this._currentPosition.isPathEnd}getPathEnd(){return this._currentPosition.segment[1]}getPt(t){return this._pathCursor.seekInPath(t),[this._pathCursor.x,this._pathCursor.y]}getSeg(t){return[this.getPt(t),this.getPt(t+1)]}_nextPosition(e,s,n,i){if(this._currentPosition.isPathEnd)return!1;let h=this._currentPosition.abscissa;for(this._currentPosition.segmentLength>0&&(h/=this._currentPosition.segmentLength),this._currentPosition.copyTo(s);s.abscissa+e*this._partLengthRatio>s.segmentLength+this._tolerance;){if(n){if(0===n.pathSize)if(0===h){const t=s.segment[0];n.pushXY(t[0],t[1])}else n.pushPoint(this.getSegCoord2D(s.segment,h));const t=s.segment[1];n.pushXY(t[0],t[1])}if(h=0,e-=(s.segmentLength-s.abscissa)/this._partLengthRatio,this._partSegCount)s.segment=this._nextSegment(),s.segmentLength=this.getSegLength(s.segment),s.abscissa=0,this._partSegCount--;else{if(!this._setPosAtNextPart())return i!==t.EndType.FAIL&&(s.segmentLength=this.getSegLength(s.segment),s.isPartEnd=!0,i===t.EndType.END?(s.abscissa=s.segmentLength,s.isPathEnd=!0):s.abscissa=s.segmentLength+e,!0);this._currentPosition.copyTo(s)}}if(s.abscissa+=e*this._partLengthRatio,n){0===n.pathSize&&(0===h?n.pushPoint(s.segment[0]):n.pushPoint(this.getSegCoord2D(s.segment,h)));const t=s.abscissa/s.segmentLength;1===t?n.pushPoint(s.segment[1]):n.pushPoint(this.getSegCoord2D(s.segment,t))}return this._partSegCount||Math.abs(s.abscissa-s.segmentLength)<this._tolerance&&(s.isPathEnd=this._partIsLast,s.isPartEnd=!0),!0}_getPoint(t){const e=t.segmentLength<=0?0:t.abscissa/t.segmentLength;return this.getSegCoord2D(this._currentPosition.segment,e)}_getAngleCS(t){const e=t.segmentLength<=0?0:t.abscissa/t.segmentLength;return this.getSegAngleCS(this._currentPosition.segment,e)}_setPosAtNextPart(){for(;this._partSegCount;)this._hasNextSegment()&&this._nextSegment(),this._partSegCount--;if(!this._hasNextSegment())return!1;for(this._partLength=0,this._partIsLast=!0,this._partSegCount=0;this._hasNextSegment();)if(this._partLength+=this.getSegLength(this._nextSegment()),this._partSegCount++,this._pathCursor.getControlPointAt(this._getEndPointIndex())){this._partIsLast=!this._hasNextSegment();break}let t=this._partSegCount;for(;t;)this._previousSegment(),--t;this._currentPosition.segment=this._nextSegment(),this._currentPosition.segmentLength=this.getSegLength(this._currentPosition.segment),this._currentPosition.abscissa=0,this._currentPosition.isPathEnd=this._currentPosition.isPartEnd=!1,--this._partSegCount;const e=this._getStartPointIndex();this._ctrlPtBegin=this._pathCursor.getControlPointAt(e);let s=e+this._partSegCount+1;if(s>=this._pathCursor.pathSize&&(s=0),this._ctrlPtEnd=this._pathCursor.getControlPointAt(s),this._patternLength>0){const t=this._ctrlPtBegin?this._partCtrlPtGap:this._partExtPtGap,e=this._ctrlPtEnd?this._partCtrlPtGap:this._partExtPtGap;let s=Math.round((this._partLength-(t+e))/this._patternLength);s<=0&&(s=t+e>0?0:1),this._partLengthRatio=this._partLength/(t+e+s*this._patternLength),this._partLengthRatio<.01&&(this._partLengthRatio=1)}else this._partLengthRatio=1;return!0}_hasNextSegment(){return this._seg<this._pathCursor.pathSize-2}_previousSegment(){return this.getSeg(--this._seg)}_nextSegment(){return this.getSeg(++this._seg)}_getStartPointIndex(){return this._seg}_getEndPointIndex(){return this._seg+1}}t.DashPattern=i,t.GeometryWalker=o,t.Pos=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
