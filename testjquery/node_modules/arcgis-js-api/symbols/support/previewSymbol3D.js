/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../assets","../../core/colorUtils","../../core/has","../../core/Error","../../core/Logger","../../core/screenUtils","./gfxUtils","./IconSymbol3DLayerResource","./ObjectSymbol3DLayerResource","./previewUtils","./renderUtils","./utils","./webStyleSymbolUtils"],(function(e,t,l,a,s,n,r,o,i,c,p,u,h,m){"use strict";const y=p.SymbolSizeDefaults.size,f=p.SymbolSizeDefaults.maxSize,b=p.SymbolSizeDefaults.maxOutlineSize,d=p.SymbolSizeDefaults.lineWidth,g=p.SymbolSizeDefaults.tallSymbolWidth;function S(e){const t=e.outline,l=null!=e.material?e.material.color:null,a=null!=l?l.toHex():null;if(null==t||"pattern"in t&&null!=t.pattern&&"style"===t.pattern.type&&"none"===t.pattern.style)return"fill"===e.type&&"#ffffff"===a?{color:"#bdc3c7",width:.75}:null;const s=r.pt2px(t.size)||0;return{color:"rgba("+(null!=t.color?t.color.toRgba():"255,255,255,1")+")",width:Math.min(s,b),style:"pattern"in t&&null!=t.pattern&&"style"===t.pattern.type?o.dekebabifyLineStyle(t.pattern.style):null,join:"butt",cap:"patternCap"in t?t.patternCap:"butt"}}async function x(e,l){if(e.thumbnail?.url)return e.thumbnail.url;if("icon"===l.type){const e=l?.resource?.href;if(e)return h.getIconHref(l)}const a=t.getAssetUrl("esri/images/Legend/legend3dsymboldefault.png");if(e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)){const t=await m.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch((()=>null));if(t&&"thumbnail"in t&&t.thumbnail?.url)return t.thumbnail.url}return a}function k(e,t=1){const a=e.a,s=l.toHSV(e),n=s.h,r=s.s/t,o=100-(100-s.v)/t,{r:i,g:c,b:p}=l.toRGB({h:n,s:r,v:o});return[i,c,p,a]}function v(e){return"water"===e.type?null==e.color?null:e.color:null==e.material?.color?null:e.material.color}function w(e,t=0){const l=v(e);if(!l){if("fill"===e.type)return null;const l=o.defaultThematicColor.r,a=p.adjustColorComponentBrightness(l,t);return[a,a,a,100]}const a=l.toRgba();for(let s=0;s<3;s++)a[s]=p.adjustColorComponentBrightness(a[s],t);return a}async function L(e,l){const a=e.style;if("none"===a)return null;return{type:"pattern",x:0,y:0,src:await o.getPatternUrlWithColor(t.getAssetUrl(`esri/symbols/patterns/${a}.png`),l.toCss(!0)),width:5,height:5}}function M(e){return e.outline?S(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function z(e,t){const l=v(e);if(!l)return null;let a="rgba(";return a+=p.adjustColorComponentBrightness(l.r,t)+",",a+=p.adjustColorComponentBrightness(l.g,t)+",",a+=p.adjustColorComponentBrightness(l.b,t)+",",a+l.a+");"}function C(e,t){const l=z(e,t);if(!l)return{};if("pattern"in e&&null!=e.pattern&&"style"===e.pattern.type&&"none"===e.pattern.style)return null;return{color:l,width:Math.min(e.size?r.pt2px(e.size):.75,b),style:"pattern"in e&&null!=e.pattern&&"style"===e.pattern.type?o.dekebabifyLineStyle(e.pattern.style):null,cap:"cap"in e?e.cap:null,join:"join"in e?"miter"===e.join?r.pt2px(2):e.join:null}}function j(e,t,l){const a=null!=l?.75*l:0;return{type:"linear",x1:a?.25*a:0,y1:a?.5*a:0,x2:a||4,y2:a?.5*a:4,colors:[{color:e,offset:0},{color:t,offset:1}]}}function D(e){const t=e.depth,l=e.height,a=e.width;return 0!==a&&0!==t&&0!==l&&a===t&&null!=a&&null!=l&&a<l}function P(e,t,l){const a=[];if(!e)return a;switch(e.type){case"icon":{const l=0,s=0,n=t,r=t;switch(e.resource&&e.resource.primitive||i.defaultPrimitive){case"circle":a.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:w(e,0),stroke:S(e)});break;case"square":a.push({shape:{type:"path",path:[{command:"M",values:[l,r]},{command:"L",values:[l,s]},{command:"L",values:[n,s]},{command:"L",values:[n,r]},{command:"Z",values:[]}]},fill:w(e,0),stroke:S(e)});break;case"triangle":a.push({shape:{type:"path",path:[{command:"M",values:[l,r]},{command:"L",values:[.5*n,s]},{command:"L",values:[n,r]},{command:"Z",values:[]}]},fill:w(e,0),stroke:S(e)});break;case"cross":a.push({shape:{type:"path",path:[{command:"M",values:[.5*n,s]},{command:"L",values:[.5*n,r]},{command:"M",values:[l,.5*r]},{command:"L",values:[n,.5*r]}]},stroke:M(e)});break;case"x":a.push({shape:{type:"path",path:[{command:"M",values:[l,s]},{command:"L",values:[n,r]},{command:"M",values:[n,s]},{command:"L",values:[l,r]}]},stroke:M(e)});break;case"kite":a.push({shape:{type:"path",path:[{command:"M",values:[l,.5*r]},{command:"L",values:[.5*n,s]},{command:"L",values:[n,.5*r]},{command:"L",values:[.5*n,r]},{command:"Z",values:[]}]},fill:w(e,0),stroke:S(e)})}break}case"object":switch(e.resource&&e.resource.primitive||c.defaultPrimitive){case"cone":{const s=j(w(e,0),w(e,-.6),l?g:t),n=p.getConeShapes(t,l);a.push({shape:n[0],fill:s},{shape:n[1],fill:s});break}case"inverted-cone":{const l=w(e,0),s=j(l,w(e,-.6),t),n=p.getInvertedConeShapes(t);a.push({shape:n[0],fill:s},{shape:n[1],fill:l});break}case"cube":{const s=p.getCubeShapes(t,l);a.push({shape:s[0],fill:w(e,0)},{shape:s[1],fill:w(e,-.3)},{shape:s[2],fill:w(e,-.5)});break}case"cylinder":{const s=j(w(e,0),w(e,-.6),l?g:t),n=p.getCylinderShapes(t,l);a.push({shape:n[0],fill:s},{shape:n[1],fill:s},{shape:n[2],fill:w(e,0)});break}case"diamond":{const l=p.getDiamondShapes(t);a.push({shape:l[0],fill:w(e,-.3)},{shape:l[1],fill:w(e,0)},{shape:l[2],fill:w(e,-.3)},{shape:l[3],fill:w(e,-.7)});break}case"sphere":{const l=j(w(e,0),w(e,-.6));l.x1=0,l.y1=0,l.x2=.25*t,l.y2=.25*t,a.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:l});break}case"tetrahedron":{const l=p.getTetrahedronShapes(t);a.push({shape:l[0],fill:w(e,-.3)},{shape:l[1],fill:w(e,0)},{shape:l[2],fill:w(e,-.6)});break}}break}return a}function U(e){const t="number"==typeof e?.size?e?.size:null;return t?r.pt2px(t):null}function O(e){return"icon"===e.type?"multiply":"tint"}async function B(e,t){const l=U(t),a=t?.maxSize?r.pt2px(t.maxSize):null,s=t?.disableUpsampling??!1,o=e.symbolLayers,i=[];let c=0,p=0;const h=o.at(-1);let m;h&&"icon"===h.type&&(m=h.size&&r.pt2px(h.size)),o.forEach((n=>{if("icon"!==n.type&&"object"!==n.type)return;const o="icon"===n.type?n.size&&r.pt2px(n.size):0,h=l||o?Math.ceil(Math.min(l||o,a||f)):y;if(n?.resource?.href){const t=x(e,n).then((e=>{const t=n?.material?.color,l=O(n);return u.tintImageWithColor(e,h,t,l,s)})).then((e=>{const t=e.width,l=e.height;return c=Math.max(c,t),p=Math.max(p,l),[{shape:{type:"image",x:0,y:0,width:t,height:l,src:e.url},fill:null,stroke:null}]}));i.push(t)}else{let e=h;"icon"===n.type&&m&&l&&(e=h*(o/m));const a="tall"===t?.symbolConfig||t?.symbolConfig?.isTall||"object"===n.type&&D(n);c=Math.max(c,a?g:e),p=Math.max(p,e),i.push(Promise.resolve(P(n,e,a)))}}));const b=await Promise.allSettled(i),d=[];return b.forEach((e=>{"fulfilled"===e.status?d.push(e.value):e.reason&&n.getLogger("esri.symbols.support.previewSymbol3D").warn("error while building swatchInfo!",e.reason)})),u.renderSymbol(d,[c,p],{node:t?.node,scale:!1,opacity:t?.opacity,ariaLabel:t?.ariaLabel})}function I(e,t){const l=e.symbolLayers,a=[],s=h.isVolumetricSymbol(e),n=U(t),o=(t?.maxSize?r.pt2px(t.maxSize):null)||b;let i,c=0,m=0;return l.forEach(((e,t)=>{if(!e)return;if("line"!==e.type&&"path"!==e.type)return;const l=[];switch(e.type){case"line":{const a=C(e,0);if(null==a)break;const s=a?.width||0;0===t&&(i=s);const r=Math.min(n||s,o),p=0===t?r:n?r*(s/i):r,u=p>d/2?2*p:d;m=Math.max(m,p),c=Math.max(c,u),a.width=p,l.push({shape:{type:"path",path:[{command:"M",values:[0,.5*m]},{command:"L",values:[c,.5*m]}]},stroke:a});break}case"path":{const t=Math.min(n||y,o),a=w(e,0),s=w(e,-.2),r=z(e,-.4),i=r?{color:r,width:1}:{};if("quad"===e.profile){const t=e.width,n=e.height,r=t&&n?t/n:1,o=p.getPathSymbolShapes(r,0===n,0===t),c={...i,join:"bevel"};l.push({shape:o[0],fill:s,stroke:c},{shape:o[1],fill:s,stroke:c},{shape:o[2],fill:a,stroke:c})}else l.push({shape:p.shapes.pathSymbol3DLayer[0],fill:s,stroke:i},{shape:p.shapes.pathSymbol3DLayer[1],fill:a,stroke:i});m=Math.max(m,t),c=m}}a.push(l)})),Promise.resolve(u.renderSymbol(a,[c,m],{node:t?.node,scale:s,opacity:t?.opacity,ariaLabel:t?.ariaLabel}))}async function R(e,t){const l="mesh-3d"===e.type,a=e.symbolLayers,s=U(t),n=t?.maxSize?r.pt2px(t.maxSize):null,o=s||y,i=[];let c=0,h=0,m=!1;for(let r=0;r<a.length;r++){const e=a.at(r),t=[];if(!l||"fill"===e.type){switch(e.type){case"fill":{const a=Math.min(o,n||f);if(c=Math.max(c,a),h=Math.max(h,a),m=!0,l){const l=p.shapes.meshSymbol3DFill,a=z(e,-.4),s=a?{color:a,width:1,join:"round"}:{};t.push({shape:l[0],fill:w(e,0),stroke:s},{shape:l[1],fill:w(e,-.2),stroke:s},{shape:l[2],fill:w(e,-.6),stroke:s})}else{let l=w(e,0);const a="pattern"in e?e.pattern:null,s=S(e),n=v(e);null!=a&&"style"===a.type&&"solid"!==a.style&&n&&(l=await L(a,n)),t.push({shape:p.shapes.fill[0],fill:l,stroke:s})}break}case"line":{const l=C(e,0);if(null==l)break;const a={stroke:l,shape:p.shapes.fill[0]};c=Math.max(c,y),h=Math.max(h,y),t.push(a);break}case"extrude":{const l={join:"round",width:1,...C(e,-.4)},a=w(e,0),s=w(e,-.2),r=Math.min(o,n||f),i=p.getExtrudeSymbolShapes(r);l.width=1,t.push({shape:i[0],fill:s,stroke:l},{shape:i[1],fill:s,stroke:l},{shape:i[2],fill:a,stroke:l});const u=y,m=.7*y+.5*r;c=Math.max(c,u),h=Math.max(h,m);break}case"water":{const l=v(e),a=k(l),s=k(l,2),r=k(l,3),i=p.getWaterSymbolShapes();m=!0,t.push({shape:i[0],fill:a},{shape:i[1],fill:s},{shape:i[2],fill:r});const u=Math.min(o,n||f);c=Math.max(c,u),h=Math.max(h,u);break}}i.push(t)}}return u.renderSymbol(i,[c,h],{node:t?.node,scale:m,opacity:t?.opacity,ariaLabel:t?.ariaLabel})}function W(e,t){if(0===e.symbolLayers.length)return Promise.reject(new s("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(e.type){case"point-3d":return B(e,t);case"line-3d":return I(e,t);case"polygon-3d":case"mesh-3d":return R(e,t)}return Promise.reject(new s("symbolPreview: swatchInfo3D","symbol not supported."))}e.getPatternDescriptor=L,e.getSizeFromOptions=U,e.getSymbolLayerFill=w,e.previewSymbol3D=W,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
