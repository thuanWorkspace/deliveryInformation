/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../core/screenUtils","../cim/CIMSymbolHelper","../cim/CIMSymbolRasterizer","../cim/utils","./previewUtils","./renderUtils"],(function(e,t,l,i,n,a,r){"use strict";const o=new i.CIMSymbolRasterizer(null,!0),s=t.px2pt(a.SymbolSizeDefaults.size),c=t.px2pt(a.SymbolSizeDefaults.maxSize),y=t.px2pt(a.SymbolSizeDefaults.lineWidth),u=1;async function m(e,t,l){const i=t?.size;let n=null!=i&&"object"==typeof i&&"width"in i?i.width:i,a=null!=i&&"object"==typeof i&&"height"in i?i.height:i;if(null==n||null==a)if("esriGeometryPolygon"===l)n=s,a=s;else{const i=await p(e,t,l);i&&(n=i.width,a=i.height),"esriGeometryPolyline"===l&&(n=y),n=null!=n&&isFinite(n)?Math.min(n,c):s,a=null!=a&&isFinite(a)?Math.max(Math.min(a,c),u):s}return"legend"===t.style&&"esriGeometryPolyline"===l&&(n=y),{width:n,height:a}}async function p(e,t,i){const{feature:n,fieldMap:a,viewParams:r}=t.cimOptions||t,s=await l.OverrideHelper.resolveSymbolOverrides(e.data,n,null,a,i,null,r);if(!s)return null;(e=e.clone()).data={type:"CIMSymbolReference",symbol:s},e.data.primitiveOverrides=void 0;const c=[];return l.CIMSymbolHelper.fetchResources(s,o.resourceManager,c),l.CIMSymbolHelper.fetchFonts(s,o.resourceManager,c),c.length>0&&await Promise.all(c),l.CIMSymbolHelper.getEnvelope(s,null,o.resourceManager)}async function f(e,l={}){const{node:i,opacity:a,symbolConfig:s}=l,c=null!=s&&"object"==typeof s&&"isSquareFill"in s&&s.isSquareFill,y=l.cimOptions||l,u=y.geometryType||n.mapCIMSymbolToGeometryType(e?.data?.symbol),p=await m(e,l,u),{feature:f,fieldMap:h}=y,d=c||"esriGeometryPolygon"!==u?"preview":"legend",b=await o.rasterizeCIMSymbolAsync(e,f,p,d,h,u,null,y.viewParams,y.allowScalingUp);if(!b)return null;const{width:g,height:w}=b,S=document.createElement("canvas");S.width=g,S.height=w;S.getContext("2d").putImageData(b,0,0);const M=t.pt2px(p.width),v=t.pt2px(p.height),C=new Image(M,v);C.src=S.toDataURL(),C.ariaLabel=l.ariaLabel??null,C.alt=l.ariaLabel??"",null!=a&&(C.style.opacity=`${a}`);let I=C;if(null!=l.effectView){const e={shape:{type:"image",x:0,y:0,width:M,height:v,src:C.src},fill:null,stroke:null,offset:[0,0]};I=r.renderSymbol([[e]],[M,v],{effectView:l.effectView,ariaLabel:l.ariaLabel})}return i&&I&&i.appendChild(I),I}e.previewCIMSymbol=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
