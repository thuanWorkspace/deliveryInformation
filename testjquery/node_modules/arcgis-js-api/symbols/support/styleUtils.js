/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../request","../../core/Error","../../core/promiseUtils","../../core/urlUtils","../../portal/Portal","../../portal/PortalQueryParams","../../support/featureFlags"],(function(e,t,r,l,o,s,n,a){"use strict";async function c(e,t){try{return{data:(await h(e,t)).data,baseUrl:o.removeFile(e),styleUrl:e}}catch(r){return l.throwIfAbortError(r),null}}function y(t,r,l){const o=null!=r.portal?r.portal:s.getDefault();let n;const a=`${o.url} - ${o.user&&o.user.username} - ${t}`;return e.cachedStyles[a]||(e.cachedStyles[a]=i(t,o,l).then((e=>(n=e,e.fetchData()))).then((e=>({data:e,baseUrl:n.itemUrl??"",styleName:t})))),e.cachedStyles[a]}function u(){e.cachedStyles&&(e.cachedStyles={})}function i(e,t,l){return t.load(l).then((()=>{const r=new n({disableExtraQuery:!0,query:`owner:${p} AND type:${b} AND typekeywords:"${e}"`});return t.queryItems(r,l)})).then((({results:t})=>{let o=null;const s=e.toLowerCase();if(t&&Array.isArray(t))for(const e of t){const t=e.typeKeywords?.some((e=>e.toLowerCase()===s));if(t&&e.type===b&&e.owner===p){o=e;break}}if(!o)throw new r("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return o.load(l)}))}function f(e,t,l){return null!=e?.styleUrl?c(e.styleUrl,l):null!=e?.styleName?y(e.styleName,t,l):Promise.reject(new r("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function m(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function d(e,t,r=["gltf"]){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!a.enableWebStyleForceWOSR())for(const l of r){const t=e.formatInfos.find((e=>e.type===l));if(t)return t.href}return e.webRef}function h(e,r){const l={responseType:"json",query:{f:"json"},...r};return t(o.normalize(e),l)}e.cachedStyles={};const p="esri_en",b="Style",S="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";e.Style2DUrlTemplate=S,e.cleanupStyleUtilsCache=u,e.fetchStyle=f,e.makeCIMSymbolRef=m,e.requestJSON=h,e.symbolUrlFromStyleItem=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
