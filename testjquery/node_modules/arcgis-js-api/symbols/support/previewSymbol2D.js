/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../core/colorUtils","../../core/Error","../../core/fontUtils","../../core/screenUtils","./gfxUtils","./previewUtils","./renderUtils","./textUtils"],(function(e,t,a,n,l,o,i,s,r,c){"use strict";const u="picture-fill",h="picture-marker",p="simple-fill",m="simple-line",d="simple-marker",f="text",g="Aa",y=s.SymbolSizeDefaults.size,w=s.SymbolSizeDefaults.maxSize,b=s.SymbolSizeDefaults.maxOutlineSize,k=s.SymbolSizeDefaults.lineWidth,x=225,v=document.createElement("canvas");function z(e,t){const a=v.getContext("2d"),n=[];return t&&(t.weight&&n.push(t.weight),t.size&&n.push(t.size+"px"),t.family&&n.push(t.family)),a.font=n.join(" "),a.measureText(e).width}const S=7.2/2.54,L=72/2.54;function M(e){if(0===e.length)return 0;if(e.length>2){const t=o.px2pt(1),a=parseFloat(e);switch(e.slice(-2)){case"px":return a;case"pt":return a*t;case"in":return 72*a*t;case"pc":return 12*a*t;case"mm":return a*S*t;case"cm":return a*L*t}}return parseFloat(e)}function C(e){const t=e?.size;return{width:null!=t&&"object"==typeof t&&"width"in t?o.pt2px(t.width):null,height:null!=t&&"object"==typeof t&&"height"in t?o.pt2px(t.height):null}}async function F(e,t){const a=t.fill,n=e.color;if("pattern"===a?.type&&n&&e.type!==u){const e=await i.getPatternUrlWithColor(a.src,n.toCss(!0));a.src=e,t.fill=a}}async function j(e,t,a,n){if(!("font"in e)||!e.font||"text"!==t.shape.type)return;try{await l.loadFont(e.font)}catch{}const{width:o}=C(n),i=/[\uE600-\uE6FF]/.test(t.shape.text);null!=o||i||(a[0]=z(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family}))}function P(e,t,a,n,l){if(null!=e.haloColor&&null!=e.haloSize){l.masking??(l.masking=a.map((()=>[])));const i=o.pt2px(e.haloSize);n[0]+=i,n[1]+=i,a.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*i,join:"round",cap:"round"}}]),l.masking.unshift([{shape:{type:"rect",x:0,y:0,width:n[0]+2*c.backgroundPadding,height:n[1]+2*c.backgroundPadding},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}null==e.backgroundColor&&null==e.borderLineColor||(n[0]+=2*c.backgroundPadding,n[1]+=2*c.backgroundPadding,a.unshift([{shape:{type:"rect",x:0,y:0,width:n[0],height:n[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:o.pt2px(e.borderLineSize)}}]),l.masking?.unshift([]))}function D(e,t){return e>t?"dark":"light"}function U(e,t){const a="number"==typeof t?.size?t?.size:null,n=null!=a?o.pt2px(a):null,l=null!=t?.maxSize?o.pt2px(t.maxSize):null,r=null!=t?.rotation?t.rotation:"angle"in e?e.angle:null,c=i.getFill(e);let x=i.getStroke(e);"dark"!==T(e,245)||t?.ignoreWhiteSymbols||(x={width:.75,...x,color:"#bdc3c7"});const v={shape:null,fill:c,stroke:x,offset:[0,0]};x?.width&&(x.width=Math.min(x.width,b));const S=x?.width||0;let L=null!=t?.size&&(null==t?.scale||t?.scale),F=0,j=0,P=!1;switch(e.type){case d:{const a=e.style,{width:i,height:s}=C(t),c=i===s&&null!=i?i:null!=n?n:Math.min(o.pt2px(e.size),l||w);switch(F=c,j=c,a){case"circle":v.shape={type:"circle",cx:0,cy:0,r:.5*c},L||(F+=S,j+=S);break;case"cross":v.shape={type:"path",path:[{command:"M",values:[0,.5*j]},{command:"L",values:[F,.5*j]},{command:"M",values:[.5*F,0]},{command:"L",values:[.5*F,j]}]};break;case"diamond":v.shape={type:"path",path:[{command:"M",values:[0,.5*j]},{command:"L",values:[.5*F,0]},{command:"L",values:[F,.5*j]},{command:"L",values:[.5*F,j]},{command:"Z",values:[]}]},L||(F+=S,j+=S);break;case"square":v.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[F,0]},{command:"L",values:[F,j]},{command:"L",values:[0,j]},{command:"Z",values:[]}]},L||(F+=S,j+=S),r&&(P=!0);break;case"triangle":v.shape={type:"path",path:[{command:"M",values:[.5*F,0]},{command:"L",values:[F,j]},{command:"L",values:[0,j]},{command:"Z",values:[]}]},L||(F+=S,j+=S),r&&(P=!0);break;case"x":v.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[F,j]},{command:"M",values:[F,0]},{command:"L",values:[0,j]}]},r&&(P=!0);break;case"path":v.shape={type:"path",path:e.path||""},L||(F+=S,j+=S),r&&(P=!0),L=!0}break}case m:{const{width:e,height:a}=C(t),l=null!=a?a:null!=n?n:S,o=null!=e?e:k;x&&(x.width=l),F=o,j=l;const i=v?.stroke?.cap||"butt",s="round"===i;L=!0,v.stroke&&(v.stroke.cap="butt"===i?"square":i),v.shape={type:"path",path:[{command:"M",values:[s?l/2:0,j/2]},{command:"L",values:[s?F-l/2:F,j/2]}]};break}case u:case p:{const e="object"==typeof t?.symbolConfig&&!!t?.symbolConfig?.isSquareFill,{width:a,height:l}=C(t);F=!e&&a!==l||null==a?null!=n?n:y:a,j=!e&&a!==l||null==l?F:l,L||(F+=S,j+=S),L=!0,v.shape=e?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[F,0]},{command:"L",values:[F,j]},{command:"L",values:[0,j]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:s.shapes.fill[0];break}case h:{const a=Math.min(o.pt2px(e.width),l||w),i=Math.min(o.pt2px(e.height),l||w),{width:s,height:c}=C(t),u=s===c&&null!=s?s:null!=n?n:Math.max(a,i),h=a/i;F=h<=1?Math.ceil(u*h):u,j=h<=1?u:Math.ceil(u/h),v.shape={type:"image",x:-Math.round(F/2),y:-Math.round(j/2),width:F,height:j,src:e.url||""},r&&(P=!0);break}case f:{const a=e,i=t?.overrideText||a.text||g,s=a.font,{width:r,height:c}=C(t),u=null!=c?c:null!=n?n:Math.min(o.pt2px(s.size),l||w),h=z(i,{weight:s.weight,size:u,family:s.family}),p=/[\uE600-\uE6FF]/.test(i);F=r??(p?u:h),j=u;let m=.25*M((s?u:0).toString());p&&(m+=5),v.shape={type:"text",text:i,x:a.xoffset||0,y:a.yoffset||m,align:"middle",alignBaseline:a.verticalAlignment,decoration:s&&s.decoration,rotated:a.rotated,kerning:a.kerning},v.font=s&&{size:u,style:s.style,decoration:s.decoration,weight:s.weight,family:s.family};break}}return{shapeDescriptor:v,size:[F,j],renderOptions:{node:t?.node,scale:L,opacity:t?.opacity,rotation:r,useRotationSize:P,effectView:t?.effectView,ariaLabel:t?.ariaLabel}}}async function E(e,t){const{shapeDescriptor:a,size:l,renderOptions:o}=U(e,t);if(!a.shape)throw new n("symbolPreview: renderPreviewHTML2D","symbol not supported.");await F(e,a),await j(e,a,l,t);const i=[[a]];if("object"==typeof t?.symbolConfig&&t?.symbolConfig?.applyColorModulation){const e=.6*l[0];i.unshift([{...a,offset:[-e,0],fill:s.adjustColorBrightness(a.fill,-.3)}]),i.push([{...a,offset:[e,0],fill:s.adjustColorBrightness(a.fill,.3)}]),l[0]+=2*e,o.scale=!1}return"text"===e.type&&P(e,a,i,l,o),r.renderSymbol(i,l,o)}function T(e,n=x){const l=i.getFill(e),o=i.getStroke(e),s=!l||"type"in l?null:new t(l),r=o?.color?new t(o?.color):null,c=s?D(a.getColorLuminance(s),n):null,u=r?D(a.getColorLuminance(r),n):null;return u?c?c===u?c:n>=x?"light":"dark":u:c}e.getContrastingBackgroundTheme=T,e.getRenderSymbolParameters=U,e.previewSymbol2D=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
