/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../geometry","../core/Error","../core/Logger","../geometry/SpatialReference"],(function(e,r,t,a,s,i){"use strict";const c=s.getLogger("esri.support.arcadeOnDemand");let n;function o(){return n||(n=(async()=>{const r=await new Promise(((r,t)=>e(["./arcadeUtils"],r,t)));return{arcade:r.arcade,arcadeUtils:r,Dictionary:r.Dictionary,Feature:r.arcadeFeature}})()),n}const l=(e,r,t)=>y.create(e,r,t,null,["$feature","$view"],[]),u=(e,r,t)=>y.create(e,r,t,null,["$feature","$view"],[]),p=u,d=(e,r,t,a)=>y.create(e,r,t,a,["$feature","$view"],[]);class y{constructor(e,r,t,a,s,i,c){this.services=null,this.script=e,this.evaluate=a;const n=Array.isArray(i)?i:i.fields;this.fields=n,this._syntaxTree=t,this._arcade=r,this._arcadeFeature=s,this._spatialReference=c,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(e,r,t,s,n,l){const{arcade:u,Feature:p,Dictionary:d}=await o(),f=i.fromJSON(r);let m;try{m=u.parseScript(e,l)}catch(E){return c.error(new a("arcade-bad-expression","Failed to parse arcade script",{script:e,error:E})),null}const h=n.reduce(((e,r)=>({...e,[r]:null})),{});let w=null;null!=s&&(w=new d(s),w.immutable=!0,h.$config=null);const v=u.scriptUsesGeometryEngine(m),g=v&&u.enableGeometrySupport(),S=u.scriptUsesFeatureSet(m)&&u.enableFeatureSetSupport(),$=u.scriptIsAsync(m),_=$&&u.enableAsyncSupport(),b={vars:h,spatialReference:f,useAsync:!!_};await Promise.all([g,S,_]);const F=new Set;await u.loadDependentModules(F,m,null,$,v);const x=new d;x.immutable=!1,x.setField("scale",0);const R=u.compileScript(m,b),A=(e,r)=>{const t=e.$view?.timeZone;return"$view"in e&&e.$view&&(x.setField("scale","object"==typeof e.$view&&"scale"in e.$view?e.$view.scale:void 0),e.$view=x),w&&(e.$config=w),R({vars:e,spatialReference:f,services:r,timeZone:t})};return new y(e,u,m,A,new p,t,f)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}}r.ArcadeExpression=y,r.createDictionaryExpression=d,r.createLabelExpression=l,r.createRendererExpression=u,r.createVVExpression=p,r.loadArcade=o,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
