/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["require","exports","../arcade/arcadeCompiler","../arcade/ArcadeModuleResolver","../arcade/arcadeRuntime","../arcade/executionError","../arcade/parser","../arcade/treeAnalysis","../arcade/functions/geomsync","../core/has","../core/maybe"],(function(e,t,r,n,c,i,s,u,o,a,l){"use strict";const d=new Set(["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"]);let p=!1,f=!1,S=null,y=[];function m(e,t){if(!0===t.useAsync||!0===e.isAsync)return x(e,t);if(a("esri-csp-restrictions")){return function(t){return c.executeScript(e,t)}}try{return r.compileScript(e,t)}catch(n){if("esri.arcade.arcadeuncompilableerror"===n.declaredRootClass)return function(t){return c.executeScript(e,t)};throw n}}function x(e,t){if(null===S)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AsyncNotEnabled,null);if(a("esri-csp-restrictions")){return function(t){return S.executeScript(e,t)}}try{return r.compileScript(e,t,!0)}catch(n){if("esri.arcade.arcadeuncompilableerror"===n.declaredRootClass)return function(t){return S.executeScript(e,t)};throw n}}function b(e){c.extend(e),r.extend(e,"sync"),null===S?y.push(e):(r.extend(e,"async"),S.extend(e))}function E(e,t=[]){return s.parseScript(e,t)}function A(e,t,r=[]){return w(s.parseScript(e,r),t)}function w(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===S)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AsyncNotEnabled,null);return S.executeScript(e,t)}return c.executeScript(e,t)}function F(e,t){return u.referencesMember(e,t)}function g(e,t){return u.referencesFunction(e,t)}function h(e,t=!1){return void 0===t&&(t=!1),u.findFieldLiterals(e)}function M(e){return u.findExpectedFieldLiterals(e)}function G(e,t=[]){return void 0===e.usesGeometry&&u.findScriptDependencies(e,t),!0===e.usesGeometry}let I=null;function D(){return I||(I=P(),I)}async function P(){const t=await new Promise(((t,r)=>e(["../geometry/geometryEngine"],t,r)));return f=!0,o.setGeometryEngine(t),!0}let U=null;function v(){return null!==U||(U=C()),U}async function C(){await r.enableAsyncSupport(),S=await new Promise(((t,r)=>e(["../arcade/arcadeAsyncRuntime"],t,r)));for(const e of y)S.extend(e),r.extend(e,"async");return y=null,!0}function L(){return p}function R(){return!!S}function _(){return f}let T=null;function j(){return T||(T=k(),T)}async function k(){await v();const[t,n,c,i,s]=await Promise.all([new Promise(((t,r)=>e(["../arcade/featureSetUtils"],t,r))),new Promise(((t,r)=>e(["../arcade/functions/featuresetbase"],t,r))),new Promise(((t,r)=>e(["../arcade/functions/featuresetgeom"],t,r))),new Promise(((t,r)=>e(["../arcade/functions/featuresetstats"],t,r))),new Promise(((t,r)=>e(["../arcade/functions/featuresetstring"],t,r)))]);return Q=t,S.extend([n,c,i,s]),r.extend([n,c,i,s],"async"),p=!0,!0}function z(e,t=[]){return void 0===e.usesFeatureSet&&u.findScriptDependencies(e,t),!0===e.usesFeatureSet}function N(e,t=[]){return void 0===e.isAsync&&u.findScriptDependencies(e,t),!0===e.isAsync}function O(e,t){if(t){for(const r of t)if(F(e,r))return!0;return!1}return!1}async function q(e,t,r=[],n=!1,c=null){return B(new Set,e,t,r,n,c)}async function B(e,t,r,n=[],c=!1,i=null){const s="string"==typeof t?E(t):t,u=[];return s&&(!1===_()&&(G(s)||c)&&u.push(D()),!1===R()&&(!0===s.isAsync||r)&&u.push(v()),!1===L()&&(z(s)||O(s,n))&&u.push(j())),u.length&&await Promise.all(u),await J(e,s,i,r,c),!0}function H(e,t=[]){return void 0===e.usesModules&&u.findScriptDependencies(e,t),!0===e.usesModules}async function J(e,t,r=null,c=!1,s=!1){const o=u.findModuleImports(t);null===r&&o.length>0&&(r=n.ArcadeModuleResolver.getDefault()),t.loadedModules={};for(const n of o){l.assertIsSome(r);const u=r.normalizeModuleUri(n.source);if(e.has(u.uri))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.CircularModules,null);e.add(u.uri);const o=await r.fetchModule(u);await B(e,o,c,[],s,r),e.delete(u.uri),o.isAsync&&(t.isAsync=!0),o.usesFeatureSet&&(t.usesFeatureSet=!0),o.usesGeometry&&(t.usesGeometry=!0),t.loadedModules[n.libname]={uri:u.uri,script:o}}}function K(e){if(G(e))return!0;const t=u.findFunctionCalls(e);let r=!1;for(let n=0;n<t.length;n++)if(d.has(t[n])){r=!0;break}return r}let Q=null;function V(){return Q}const W=Object.freeze(Object.defineProperty({__proto__:null,_loadScriptDependenciesImpl:B,compileScript:m,enableAsyncSupport:v,enableAsyncSupportImpl:C,enableFeatureSetSupport:j,enableFeatureSetSupportImpl:k,enableGeometrySupport:D,enableGeometrySupportImpl:P,executeScript:w,extend:b,extractExpectedFieldLiterals:M,extractFieldLiterals:h,featureSetUtils:V,isAsyncEnabled:R,isFeatureSetSupportEnabled:L,isGeometryEnabled:_,loadDependentModules:J,loadScriptDependencies:q,parseAndExecuteScript:A,parseScript:E,referencesFunction:g,referencesMember:F,scriptIsAsync:N,scriptTouchesGeometry:K,scriptUsesFeatureSet:z,scriptUsesGeometryEngine:G,scriptUsesModules:H},Symbol.toStringTag,{value:"Module"}));t._loadScriptDependenciesImpl=B,t.arcade=W,t.compileScript=m,t.enableAsyncSupport=v,t.enableAsyncSupportImpl=C,t.enableFeatureSetSupport=j,t.enableFeatureSetSupportImpl=k,t.enableGeometrySupport=D,t.enableGeometrySupportImpl=P,t.executeScript=w,t.extend=b,t.extractExpectedFieldLiterals=M,t.extractFieldLiterals=h,t.featureSetUtils=V,t.isAsyncEnabled=R,t.isFeatureSetSupportEnabled=L,t.isGeometryEnabled=_,t.loadDependentModules=J,t.loadScriptDependencies=q,t.parseAndExecuteScript=A,t.parseScript=E,t.referencesFunction=g,t.referencesMember=F,t.scriptIsAsync=N,t.scriptTouchesGeometry=K,t.scriptUsesFeatureSet=z,t.scriptUsesGeometryEngine=G,t.scriptUsesModules=H}));
