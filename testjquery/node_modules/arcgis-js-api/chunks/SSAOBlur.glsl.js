/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","./vec3","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadLinearDepth.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/interfaces","../views/3d/webgl-engine/core/shaderModules/ShaderBuilder","../views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform"],(function(e,r,a,t,o,l,n,s,d,i,u){"use strict";const f=4;function c(){const e=new d.ShaderBuilder,c=e.fragment;e.include(a.ScreenSpacePass);const w=(f+1)/2,g=1/(2*w*w);return c.include(t.ReadLinearDepth),c.uniforms.add(new u.Texture2DPassUniform("depthMap",(e=>e.depthTexture)),new i.Texture2DDrawUniform("tex",(e=>e.colorTexture)),new o.Float2DrawUniform("blurSize",(e=>e.blurSize)),new n.FloatPassUniform("projScale",((e,a)=>{const t=r.distance(a.camera.eye,a.camera.center);return t>5e4?Math.max(0,e.projScale-(t-5e4)):e.projScale})),new l.Float2PassUniform("nearFar",((e,r)=>r.camera.nearFar))),c.code.add(s.glsl`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv, nearFar);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${s.glsl.float(g)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.outputs.add("fragBlur","float"),c.code.add(s.glsl`
    void main(void) {
      float b = 0.0;
      float w_total = 0.0;

      float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

      float sharpness = -0.05 * projScale / center_d;
      for (int r = -${s.glsl.int(f)}; r <= ${s.glsl.int(f)}; ++r) {
        float rf = float(r);
        vec2 uvOffset = uv + rf * blurSize;
        blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
      }

      fragBlur = b / w_total;
    }
  `),e}const w=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}));e.SSAOBlur=w,e.build=c}));
