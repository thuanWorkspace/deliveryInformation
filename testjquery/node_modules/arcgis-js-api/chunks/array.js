/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../arcade/deepClone","../arcade/executionError","../arcade/ImmutableArray","./languageUtils","../core/promiseUtils"],(function(r,n,e,t,o,i){"use strict";function c(r){function c(r,n,i){if(r instanceof t)return r.toArray();if(o.isArray(r))return r;throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,i)}function u(r,n){const e=r.length,t=Math.floor(e/2);return 0===e?[]:1===e?[r[0]]:a(u(r.slice(0,t),n),u(r.slice(t,e),n),n)}function a(r,n,e){const t=[];for(;r.length>0||n.length>0;)if(r.length>0&&n.length>0){let o=e(r[0],n[0]);isNaN(o)&&(o=0),o<=0?(t.push(r[0]),r=r.slice(1)):(t.push(n[0]),n=n.slice(1))}else r.length>0?(t.push(r[0]),r=r.slice(1)):n.length>0&&(t.push(n[0]),n=n.slice(1));return t}async function s(r,n){const e=r.length,t=Math.floor(e/2);if(0===e)return[];if(1===e)return[r[0]];const o=[await s(r.slice(0,t),n),await s(r.slice(t,e),n)];return d(o[0],o[1],n,[])}async function d(r,n,e,t){const o=t;if(!(r.length>0||n.length>0))return t;if(r.length>0&&n.length>0){let i=await e(r[0],n[0]);return isNaN(i)&&(i=1),i<=0?(o.push(r[0]),r=r.slice(1)):(o.push(n[0]),n=n.slice(1)),d(r,n,e,t)}return r.length>0?(o.push(r[0]),d(r=r.slice(1),n,e,t)):n.length>0?(o.push(n[0]),d(r,n=n.slice(1),e,t)):void 0}function l(r,n,t,i){o.pcCheck(t,1,2,r,n);let c=t[0];if(o.isImmutableArray(c)&&(c=c.toArray()),!1===o.isArray(c))throw new e.ArcadeExecutionError(r,e.ExecutionErrorCodes.InvalidParameter,n);if(t.length>1){if(!1===o.isFunctionParameter(t[1]))throw new e.ArcadeExecutionError(r,e.ExecutionErrorCodes.InvalidParameter,n);let a=c;const d=t[1].createFunction(r);return i?s(a,d):(a=u(a,((r,n)=>d(r,n))),a)}let a=c;if(0===a.length)return[];const d={};for(let e=0;e<a.length;e++){const r=o.getType(a[e]);""!==r&&(d[r]=!0)}if(!0===d.Array||!0===d.Dictionary||!0===d.Feature||!0===d.Point||!0===d.Polygon||!0===d.Polyline||!0===d.Multipoint||!0===d.Extent||!0===d.Function)return a.slice(0);let l=0,f="";for(const e in d)l++,f=e;return a=l>1||"String"===f?u(a,((r,n)=>{if(null==r||r===o.voidOperation)return null==n||n===o.voidOperation?0:1;if(null==n||n===o.voidOperation)return-1;const e=o.toString(r),t=o.toString(n);return e<t?-1:e===t?0:1})):"Number"===f?u(a,((r,n)=>r-n)):"Boolean"===f?u(a,((r,n)=>r===n?0:n?-1:1)):"Date"===f?u(a,((r,n)=>n-r)):a.slice(0),a}r.functions.array=function(t,i){return r.standardFunction(t,i,((r,c,u)=>{if(o.pcCheck(u,0,2,t,i),0===u.length)return new Array;if(1===u.length&&null===u[0])return new Array;if(o.isArray(u[0])){if(2===u.length&&!1===o.isBoolean(u[1]))throw new e.ArcadeExecutionError(t,e.ExecutionErrorCodes.InvalidParameter,i);return!0===o.defaultUndefined(u[1],!1)?n.deepClone(u[0]):u[0].slice(0)}if(o.isImmutableArray(u[0])){if(2===u.length&&!1===o.isBoolean(u[1]))throw new e.ArcadeExecutionError(t,e.ExecutionErrorCodes.InvalidParameter,i);return!0===o.defaultUndefined(u[1],!1)?n.deepClone(u[0]):u[0].toArray().slice(0)}const a=o.toNumber(u[0]);if(isNaN(a)||!1===o.isInteger(a))throw new e.ArcadeExecutionError(t,e.ExecutionErrorCodes.InvalidParameter,i);const s=o.defaultUndefined(u[1],null),d=new Array(a);return d.fill(s),d}))},r.functions.front=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,1,1,n,t),o.isImmutableArray(c[0])){if(c[0].length()<=0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);return c[0].get(0)}if(o.isArray(c[0])){if(c[0].length<=0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);return c[0][0]}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.back=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,1,1,n,t),o.isImmutableArray(c[0])){if(c[0].length()<=0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);return c[0].get(c[0].length()-1)}if(o.isArray(c[0])){if(c[0].length<=0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);return c[0][c[0].length-1]}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.push=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,1,2,n,t),o.isArray(c[0]))return c[0][c[0].length]=c[1],c[0].length;throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.pop=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,1,1,n,t),o.isArray(c[0])){if(c[0].length<=0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);const r=c[0][c[0].length-1];return c[0].length=c[0].length-1,r}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.erase=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,2,2,n,t),o.isArray(c[0])){let r=o.toNumber(c[1]);if(isNaN(r)||!1===o.isInteger(r))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);const i=c[0];if(i.length<=0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);if(r<0&&(r=i.length+r),r<0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);if(r>=i.length)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);return i.splice(r,1),o.voidOperation}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.insert=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,3,3,n,t),o.isArray(c[0])){const r=o.toNumber(c[1]);if(isNaN(r)||!1===o.isInteger(r))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);const i=c[2],u=c[0];if(r>u.length)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);if(r<0&&r<-1*u.length)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.OutOfBounds,t);return r===u.length?(u[r]=i,o.voidOperation):(u.splice(r,0,i),o.voidOperation)}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.resize=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,2,3,n,t),o.isArray(c[0])){const r=o.toNumber(c[1]);if(isNaN(r)||!1===o.isInteger(r))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);if(r<0)throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);const i=o.defaultUndefined(c[2],null),u=c[0];if(u.length>=r)return u.length=r,o.voidOperation;const a=u.length;u.length=r;for(let n=a;n<u.length;n++)u[n]=i;return o.voidOperation}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.includes=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,2,2,n,t),o.isArray(c[0])){const r=c[1];return c[0].findIndex((n=>o.equalityTest(n,r)))>-1}if(o.isImmutableArray(c[0])){const r=c[1];return c[0].toArray().findIndex((n=>o.equalityTest(n,r)))>-1}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.slice=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,1,3,n,t),o.isArray(c[0])){const r=o.toNumber(o.defaultUndefined(c[1],0)),i=o.toNumber(o.defaultUndefined(c[2],c[0].length));if(isNaN(r)||!1===o.isInteger(r))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);if(isNaN(i)||!1===o.isInteger(i))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);return c[0].slice(r,i)}if(o.isImmutableArray(c[0])){const r=c[0],i=o.toNumber(o.defaultUndefined(c[1],0)),u=o.toNumber(o.defaultUndefined(c[2],r.length()));if(isNaN(i)||!1===o.isInteger(i))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);if(isNaN(u)||!1===o.isInteger(u))throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t);return r.toArray().slice(i,u)}throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.splice=function(n,e){return r.standardFunction(n,e,((r,n,e)=>{const t=[];for(let i=0;i<e.length;i++)o.isArray(e[i])?t.push(...e[i]):o.isImmutableArray(e[i])?t.push(...e[i].toArray()):t.push(e[i]);return t}))},r.functions.top=function(n,t){return r.standardFunction(n,t,((r,i,c)=>{if(o.pcCheck(c,2,2,n,t),o.isArray(c[0]))return o.toNumber(c[1])>=c[0].length?c[0].slice(0):c[0].slice(0,o.toNumber(c[1]));if(o.isImmutableArray(c[0]))return o.toNumber(c[1])>=c[0].length()?c[0].slice(0):c[0].slice(0,o.toNumber(c[1]));throw new e.ArcadeExecutionError(n,e.ExecutionErrorCodes.InvalidParameter,t)}))},r.functions.first=function(n,e){return r.standardFunction(n,e,((r,t,i)=>(o.pcCheck(i,1,1,n,e),o.isArray(i[0])?0===i[0].length?null:i[0][0]:o.isImmutableArray(i[0])?0===i[0].length()?null:i[0].get(0):null)))},"sync"===r.mode&&(r.functions.sort=function(n,e){return r.standardFunction(n,e,((r,t,o)=>l(n,e,o,!1)))},r.functions.any=function(n,e){return r.standardFunction(n,e,((r,t,i)=>{o.pcCheck(i,2,2,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e);for(const n of a){const r=u(n);if(o.isBoolean(r)&&!0===r)return!0}return!1}))},r.functions.all=function(n,e){return r.standardFunction(n,e,((r,t,i)=>{o.pcCheck(i,2,2,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e);for(const n of a){if(!0!==u(n))return!1}return!0}))},r.functions.none=function(n,e){return r.standardFunction(n,e,((r,t,i)=>{o.pcCheck(i,2,2,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e);for(const n of a){if(!0===u(n))return!1}return!0}))},r.functions.reduce=function(n,e){return r.standardFunction(n,e,((r,t,i)=>{o.pcCheck(i,2,3,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e);return 2===i.length?0===a.length?null:a.reduce(((r,n)=>{const e=u(r,n);return r=void 0!==e&&e!==o.voidOperation?e:null})):a.reduce(((r,n)=>{const e=u(r,n);return r=void 0!==e&&e!==o.voidOperation?e:null}),i[2])}))},r.functions.map=function(n,e){return r.standardFunction(n,e,((r,t,i)=>{o.pcCheck(i,2,2,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e),s=[];for(const n of a){const r=u(n);void 0!==r&&r!==o.voidOperation?s.push(r):s.push(null)}return s}))},r.functions.filter=function(n,e){return r.standardFunction(n,e,((r,t,i)=>{o.pcCheck(i,2,2,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e),s=[];for(const n of a){!0===u(n)&&s.push(n)}return s}))}),"async"===r.mode&&(r.functions.sort=function(n,e){return r.standardFunctionAsync(n,e,((r,t,o)=>l(n,e,o,!0)))},r.functions.any=function(n,e){return r.standardFunctionAsync(n,e,(async(r,t,u)=>{o.pcCheck(u,2,2,n,e);const a=u[1].createFunction(n),s=c(u[0],n,e);for(const n of s){const r=await a(n);let e=null;if(e=i.isPromiseLike(e)?await r:r,o.isBoolean(e)&&!0===e)return!0}return!1}))},r.functions.all=function(n,e){return r.standardFunctionAsync(n,e,(async(r,t,u)=>{o.pcCheck(u,2,2,n,e);const a=u[1].createFunction(n),s=c(u[0],n,e);for(const n of s){const r=await a(n);let e=null;if(e=i.isPromiseLike(e)?await r:r,!0!==e)return!1}return!0}))},r.functions.none=function(n,e){return r.standardFunctionAsync(n,e,(async(r,t,u)=>{o.pcCheck(u,2,2,n,e);const a=u[1].createFunction(n),s=c(u[0],n,e);for(const n of s){const r=await a(n);let e=null;if(e=i.isPromiseLike(e)?await r:r,!0===e)return!1}return!0}))},r.functions.filter=function(n,e){return r.standardFunctionAsync(n,e,(async(r,t,u)=>{o.pcCheck(u,2,2,n,e);const a=u[1].createFunction(n),s=c(u[0],n,e),d=[];for(const n of s){const r=await a(n);let e=null;e=i.isPromiseLike(e)?await r:r,!0===e&&d.push(n)}return d}))},r.functions.reduce=function(n,e){return r.standardFunctionAsync(n,e,((r,t,i)=>{o.pcCheck(i,2,3,n,e);const u=i[1].createFunction(n),a=c(i[0],n,e);let s=null;if(i.length>2){const r=o.defaultUndefined(i[2],null);s=a.reduce((async(r,n)=>{let e=await r;return void 0!==e&&e!==o.voidOperation||(e=null),u(e,n)}),Promise.resolve(r))}else{if(0===a.length)return null;s=a.reduce((async(r,n,e)=>{if(e<=1)return u(r,n);let t=await r;return void 0!==t&&t!==o.voidOperation||(t=null),u(t,n)}))}return s.then((r=>void 0!==r&&r!==o.voidOperation?r:null))}))},r.functions.map=function(n,e){return r.standardFunctionAsync(n,e,(async(r,t,u)=>{o.pcCheck(u,2,2,n,e);const a=u[1].createFunction(n),s=c(u[0],n,e),d=[];for(const n of s){const r=await a(n);let e=null;e=i.isPromiseLike(e)?await r:r,void 0!==e&&e!==o.voidOperation?d.push(e):d.push(null)}return d}))})}const u=Object.freeze(Object.defineProperty({__proto__:null,registerFunctions:c},Symbol.toStringTag,{value:"Module"}));r.ArrayFunctions=u,r.registerFunctions=c}));
