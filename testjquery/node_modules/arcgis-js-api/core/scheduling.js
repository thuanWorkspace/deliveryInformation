/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","./nextTick","./PerformanceSampler","./PooledArray","./promiseUtils","./time"],(function(e,t,s,r,n,o){"use strict";class i{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class a{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let c=0,l=0;const m={time:o.Milliseconds(0),deltaTime:o.Milliseconds(0),elapsedFrameTime:o.Milliseconds(0),frameDuration:o.Milliseconds(0)},u=["prepare","preRender","render","postRender","update","finish"],d=[],p=new r;class f{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const h={frameTasks:p,willDispatch:!1,clearFrameTasks:v,dispatch:g,executeFrameTasks:F};function k(e){const s=new a(e);return d.push(s),h.willDispatch||(h.willDispatch=!0,t.nextTick(g)),s}function w(e){const t=new i(e);return p.push(t),null==T&&(c=performance.now(),T=requestAnimationFrame(M)),new f(t)}let T=null;function v(e=!1){p.forAll((e=>{e.removed=!0})),e&&b()}function A(e){l=Math.max(0,e)}function M(){const e=performance.now();T=null,T=p.length>0?requestAnimationFrame(M):null,h.executeFrameTasks(e)}function F(e){const t=o.Milliseconds(e-c);c=e;const s=l>0?l:1e3/60,r=Math.max(0,t-s);m.time=e,m.frameDuration=o.Milliseconds(s-r);for(let n=0;n<u.length;n++){const s=performance.now(),r=u[n];p.forAll((s=>{if(s.paused||s.removed)return;0===n&&s.ticks++;s.phases[r]&&(m.elapsedFrameTime=o.Milliseconds(performance.now()-e),m.deltaTime=0===s.ticks?o.Milliseconds(0):t,s.phases[r]?.call(s,m))})),y[n].record(performance.now()-s)}b(),_.record(performance.now()-e)}const x=new r;function b(){p.forAll((e=>{e.removed&&x.push(e)})),p.removeUnorderedMany(x.data,x.length),x.clear()}function g(){for(;d.length;){const e=d.shift();e.isActive&&e.callback()}h.willDispatch=!1}function D(e=1,s){const r=n.createResolver(),o=()=>{n.isAborted(s)?r.reject(n.createAbortError()):0===e?r():(--e,t.nextTick((()=>o())))};return o(),r.promise}function R(){const e=n.createResolver(),t=w({postRender:()=>{t.remove(),k(e)}});return e.promise}const y=u.map((e=>new s(e))),_=new s("total");e.FrameTaskHandle=f,e.addFrameTask=w,e.debug=h,e.performanceInfo=y,e.performanceTotal=_,e.schedule=k,e.setFrameDuration=A,e.waitAnimationFrame=R,e.waitTicks=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
