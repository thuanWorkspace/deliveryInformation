/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../config","./arrayUtils","./Error","./JSONSupport","./Logger","../portal/support/urlUtils","../support/base64Utils"],(function(t,e,n,r,o,i,s,l){"use strict";const u=i.getLogger("esri.core.urlUtils"),c=e.request,a="esri/config: esriConfig.request.proxyUrl is not set.",f=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,p=/^\s*http:/i,h=/^\s*https:/i,d=/^\s*file:/i,m=/:\d+$/,g=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,y=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),x=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class ${constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let e=this.uri.match(y);this.scheme=e[2]||(e[1]?"":null),this.authority=e[4]||(e[3]?"":null),this.path=e[5],this.query=e[7]||(e[6]?"":null),this.fragment=e[9]||(e[8]?"":null),null!=this.authority&&(e=this.authority.match(x),this.user=e[3]||null,this.password=e[4]||null,this.host=e[6]||e[7],this.port=e[9]||null)}toString(){return this.uri}}const O={},b=new $(e.applicationUrl);let w=b;const U=A();let P=U;const S=()=>w,R=()=>P;function A(){const t=w.path,e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${w.scheme}://${w.host}${null!=w.port?`:${w.port}`:""}`}${e}`}const C={setAppUrl:t=>w=t,setAppBaseUrl:t=>P=t,restoreUrls:()=>{w=b,P=U}};function T(t){if(!t)return null;const e={path:null,query:null},n=new $(t),r=t.indexOf("?");return null===n.query?e.path=t:(e.path=t.substring(0,r),e.query=q(n.query)),n.fragment&&(e.hash=n.fragment,null===n.query&&(e.path=e.path.substring(0,e.path.length-(n.fragment.length+1)))),e}function q(t){const e=t.split("&"),n={};for(const r of e){if(!r)continue;const t=r.indexOf("=");let e,o;t<0?(e=decodeURIComponent(r),o=""):(e=decodeURIComponent(r.slice(0,t)),o=decodeURIComponent(r.slice(t+1)));let i=n[e];"string"==typeof i&&(i=n[e]=[i]),Array.isArray(i)?i.push(o):n[e]=o}return n}function I(t,e){return t?e&&"function"==typeof e?Object.keys(t).map((n=>encodeURIComponent(n)+"="+encodeURIComponent(e(n,t[n])))).join("&"):Object.keys(t).map((n=>{const r=t[n];if(null==r)return"";const i=encodeURIComponent(n)+"=",s=e?.[n];return s?i+encodeURIComponent(s(r)):Array.isArray(r)?r.map((t=>o.isSerializable(t)?i+encodeURIComponent(JSON.stringify(t)):i+encodeURIComponent(t))).join("&"):o.isSerializable(r)?i+encodeURIComponent(JSON.stringify(r)):i+encodeURIComponent(r)})).filter((t=>t)).join("&"):""}function v(t=!1){let e,n=c.proxyUrl;if("string"==typeof t){e=dt(t);const r=E(t);r&&(n=r.proxyUrl)}else e=!!t;if(!n)throw u.warn(a),new r("urlutils:proxy-not-set",a);e&&Ot()&&(n=xt(n));return T(n)}function j(t){const e=E(t);let n,r;if(e){const t=B(e.proxyUrl);n=t.path,r=t.query?q(t.query):null}if(n){const e=T(t);t=n+"?"+e.path;const o=I({...r,...e.query});o&&(t=`${t}?${o}`)}return t}const L={path:"",query:""};function B(t){const e=t.indexOf("?");return-1!==e?(L.path=t.slice(0,e),L.query=t.slice(e+1)):(L.path=t,L.query=null),L}function D(t){return t=(t=bt(t=St(t=B(t).path),!0)).toLowerCase()}function k(t){const e={proxyUrl:t.proxyUrl,urlPrefix:D(t.urlPrefix)},n=c.proxyRules,r=e.urlPrefix;let o=n.length;for(let i=0;i<n.length;i++){const t=n[i].urlPrefix;if(0===r.indexOf(t)){if(r.length===t.length)return-1;o=i;break}0===t.indexOf(r)&&(o=i+1)}return n.splice(o,0,e),o}function E(t){const e=c.proxyRules,n=D(t);for(let r=0;r<e.length;r++)if(0===n.indexOf(e[r].urlPrefix))return e[r]}function H(t,e){if(!t||!e)return!1;t=z(t),e=z(e);const n=s.parseKnownArcGISOnlineDomain(t),r=s.parseKnownArcGISOnlineDomain(e);return null!=n&&null!=r?n.portalHostname===r.portalHostname:null==n&&null==r&&K(t,e,!0)}function G(t,e){if(!t||!e)return!1;t=z(t),e=z(e);const n=s.parseKnownArcGISOnlineDomain(t),r=s.parseKnownArcGISOnlineDomain(e);return null!=n&&null!=r&&n.portalHostname===r.portalHostname}function Q(t,e){return t=z(t),e=z(e),bt(t)===bt(e)}function z(t){const e=(t=V(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function F(t){const e=e=>null==e||e instanceof RegExp&&e.test(t)||"string"==typeof e&&t.startsWith(e),n=c.interceptors;if(n)for(const r of n)if(Array.isArray(r.urls)){if(r.urls.some(e))return r}else if(e(r.urls))return r;return null}function K(t,e,n=!1){if(!t||!e)return!1;const r=It(t),o=It(e);return!(!n&&r.scheme!==o.scheme)&&(null!=r.host&&null!=o.host&&(r.host.toLowerCase()===o.host.toLowerCase()&&r.port===o.port))}function W(t){if("string"==typeof t){if(!Y(t))return!0;t=It(t)}if(K(t,w))return!0;const e=c.trustedServers||[];for(let n=0;n<e.length;n++){const r=J(e[n]);for(let e=0;e<r.length;e++)if(K(t,r[e]))return!0}return!1}function J(t){return O[t]||(ht(t)||pt(t)?O[t]=[new $(N(t))]:O[t]=[new $(`http://${t}`),new $(`https://${t}`)]),O[t]}function N(t,e=P,n){return pt(t)?n&&n.preserveProtocolRelative?t:"http"===w.scheme&&w.authority===X(t).slice(2)?`http:${t}`:`https:${t}`:ht(t)?t:_("/"===t[0]?wt(e):e,t)}function M(t,e=P,n){if(null==t||!Y(t))return t;const r=V(t),o=r.toLowerCase(),i=V(e).toLowerCase().replace(/\/+$/,""),s=n?V(n).toLowerCase().replace(/\/+$/,""):null;if(s&&0!==i.indexOf(s))return t;const l=(t,e,n)=>-1===(n=t.indexOf(e,n))?t.length:n;let u=l(o,"/",o.indexOf("//")+2),c=-1;for(;o.slice(0,u+1)===i.slice(0,u)+"/"&&(c=u+1,u!==o.length);)u=l(o,"/",u+1);if(-1===c)return t;if(s&&c<s.length)return t;t=r.slice(c);const a=i.slice(c-1).replaceAll(/[^/]+/g,"").length;if(a>0)for(let f=0;f<a;f++)t=`../${t}`;else t=`./${t}`;return t}function V(t){return t=Tt(t=Ct(t=At(t=N(t=t.trim()))))}function _(...t){const e=t.filter(n.isSome);if(!e?.length)return;const r=[];if(Y(e[0])){const t=e[0],n=t.indexOf("//");-1!==n&&(r.push(t.slice(0,n+1)),gt(e[0])&&(r[0]+="/"),e[0]=t.slice(n+2))}else"/"===e[0][0]&&r.push("");const o=e.reduce(((t,e)=>e?t.concat(e.split("/")):t),[]);for(let n=0;n<o.length;n++){const t=o[n];".."===t&&r.length>0&&".."!==r[r.length-1]?r.pop():(!t&&n===o.length-1||t&&("."!==t||0===r.length))&&r.push(t)}return r.join("/")}function X(t,e=!1){if(null==t||Z(t)||tt(t))return null;let n=t.indexOf("://");if(-1===n&&pt(t))n=2;else{if(-1===n)return null;n+=3}const r=t.indexOf("/",n);return-1!==r&&(t=t.slice(0,r)),e&&(t=bt(t,!0)),t}function Y(t){return pt(t)||ht(t)}function Z(t){return null!=t&&"blob:"===t.slice(0,5)}function tt(t){return null!=t&&"data:"===t.slice(0,5)}function et(t){const e=ot(t);return e&&e.isBase64?l.base64ToArrayBuffer(e.data):null}function nt(t){return l.arrayBufferToBase64(t).replaceAll("+","-").replaceAll("/","_").replace(/=+$/,"")}const rt=/^data:(.*?)(;base64)?,(.*)$/;function ot(t){const e=t.match(rt);if(!e)return null;const[,n,r,o]=e;return{mediaType:n,isBase64:!!r,data:o}}function it(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}async function st(t){return(await fetch(t)).blob()}function lt(t){const e=et(t);if(!e)return null;const n=ot(t);return new Blob([e],{type:n.mediaType})}function ut(t,e){at(t,e)}function ct(t,e){ft(t,e)}function at(t,e){const n=lt(t);return!!n&&ft(n,e)}function ft(t,e){if(!t)return!1;const n=document.createElement("a");if(!("download"in n))return!1;const r=URL.createObjectURL(t);return n.download=e,n.href=r,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),!0}function pt(t){return null!=t&&"/"===t[0]&&"/"===t[1]}function ht(t){return null!=t&&f.test(t)}function dt(t){return null!=t&&h.test(t)||"https"===w.scheme&&pt(t)}function mt(t){return null!=t&&p.test(t)||"http"===w.scheme&&pt(t)}function gt(t){return null!=t&&d.test(t)}function yt(t){return pt(t)?`http:${t}`:t.replace(h,"http:")}function xt(t){return pt(t)?`https:${t}`:t.replace(p,"https:")}function $t(){return"http"===w.scheme}function Ot(){return"https"===w.scheme}function bt(t,e=!1){return pt(t)?t.slice(2):(t=t.replace(f,""),e&&t.length>1&&"/"===t[0]&&"/"===t[1]&&(t=t.slice(2)),t)}function wt(t){const e=t.indexOf("//"),n=t.indexOf("/",e+2);return-1===n?t:t.slice(0,n)}function Ut(t){let e=0;if(Y(t)){const n=t.indexOf("//");-1!==n&&(e=n+2)}const n=t.lastIndexOf("/");return n<e?t:t.slice(0,n+1)}function Pt(t,e){if(!t)return"";const n=T(t).path.replace(/\/+$/,""),r=n.substring(n.lastIndexOf("/")+1);if(!e?.length)return r;const o=new RegExp(`.(${e.join("|")})$`,"ig");return r.replace(o,"")}function St(t){return t.endsWith("/")?t:`${t}/`}function Rt(t){return t.replace(/\/+$/,"")}function At(t){if(/^https?:\/\//i.test(t)){const e=B(t);t=(t=e.path.replaceAll(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}function Ct(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function Tt(t){const e=c.httpsDomains;if(!mt(t))return t;const n=t.indexOf("/",7);let r;if(r=-1===n?t:t.slice(0,n),r=r.toLowerCase().slice(7),m.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}return $t()&&r===w.authority&&!g.test(t)||(Ot()&&r===w.authority||e&&e.some((t=>r===t||r.endsWith(`.${t}`)))||Ot()&&!E(t))&&(t=xt(t)),t}function qt(t,e,n){if(!(e&&n&&t&&Y(t)))return t;const r=t.indexOf("//"),o=t.indexOf("/",r+2),i=t.indexOf(":",r+2),s=Math.min(o<0?t.length:o,i<0?t.length:i);if(t.slice(r+2,s).toLowerCase()!==e.toLowerCase())return t;return`${t.slice(0,r+2)}${n}${t.slice(s)}`}function It(t){return"string"==typeof t?new $(N(t)):(t.scheme||(t.scheme=w.scheme),t)}function vt(t){return Qt.test(t)}function jt(t,e){const n=T(t),r=Object.keys(n.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),n.path}function Lt(t,e,n){const r=T(t),o=r.query||{};return o[e]=String(n),`${r.path}?${I(o)}`}function Bt(t,e){if(!e)return t;const n=T(t),r=n.query||{};for(const[i,s]of Object.entries(e))null!=s&&(r[i]=s);const o=I(r);return o?`${n.path}?${o}`:n.path}function Dt(t,e){const{path:n,query:r}=T(t);if(!r)return t;delete r[e];const o=I(r);return o?`${n}?${o}`:n}function kt(t){if(null==t)return null;const e=t.match(Gt);return e?e[2]:null}function Et(t){if(null==t)return null;const e=t.match(Gt);return e?{path:e[1],extension:e[2]}:{path:t,extension:null}}async function Ht(t){if("string"==typeof t){return ot(t)??{data:t}}return new Promise(((e,n)=>{const r=new FileReader;r.readAsDataURL(t),r.onload=()=>e(ot(r.result)),r.onerror=t=>n(t)}))}const Gt=/([^.]*)\.([^\/]*)$/,Qt=/(^data:image\/svg|\.svg$)/i;t.Url=$,t.addProxy=j,t.addProxyRule=k,t.addQueryParameter=Lt,t.addQueryParameters=Bt,t.base64UrlEncode=nt,t.blobUrlToBlob=st,t.changeDomain=qt,t.dataComponents=ot,t.dataToArrayBuffer=et,t.dataToBlob=lt,t.downloadBlobAsFile=ct,t.downloadDataAsFile=ut,t.ensureTrailingSlash=St,t.getAppBaseUrl=R,t.getAppUrl=S,t.getFilename=Pt,t.getInterceptor=F,t.getOrigin=X,t.getPathExtension=kt,t.getProxyRule=E,t.getProxyUrl=v,t.hasProtocol=ht,t.hasSameCanonicalArcGISOnlinePortal=G,t.hasSameCanonicalPortal=H,t.hasSameOrigin=K,t.hasSamePortal=Q,t.isAbsolute=Y,t.isAppHTTPS=Ot,t.isBlobProtocol=Z,t.isDataProtocol=tt,t.isHTTPSProtocol=dt,t.isProtocolRelative=pt,t.isSVG=vt,t.isTrustedServer=W,t.join=_,t.makeAbsolute=N,t.makeData=it,t.makeRelative=M,t.normalize=V,t.objectToQuery=I,t.parseData=Ht,t.queryToObject=q,t.removeFile=Ut,t.removeQueryParameter=Dt,t.removeQueryParameters=jt,t.removeTrailingSlash=Rt,t.splitPathExtension=Et,t.test=C,t.toHTTP=yt,t.toHTTPS=xt,t.trustedServersUrlCache=O,t.urlToObject=T,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
