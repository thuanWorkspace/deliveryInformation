/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["./bidiEngineTables"],(function(t){"use strict";class r{constructor(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}bidiTransform(t,r,n){if(this.sourceToTarget=[],this.targetToSource=[],!t)return"";if(_(this.sourceToTarget,this.targetToSource,t.length),!this.checkParameters(r,n))return t;r=this.inputFormat,n=this.outputFormat;let o=t;const i=y,u=w(r.charAt(1)),l=w(n.charAt(1)),f=("I"===r.charAt(0)?"L":r.charAt(0))+u,c=("I"===n.charAt(0)?"L":n.charAt(0))+l,b=r.charAt(2)+n.charAt(2);i.defInFormat=f,i.defOutFormat=c,i.defSwap=b;const h=e(t,f,c,b,i);let T=!1;return"R"===n.charAt(1)?T=!0:"C"!==n.charAt(1)&&"D"!==n.charAt(1)||(T="rtl"===this.checkContextual(h)),this.sourceToTarget=C,this.targetToSource=O(this.sourceToTarget),V=this.targetToSource,o=r.charAt(3)===n.charAt(3)?h:"S"===n.charAt(3)?a(T,h,!0):s(h,T,!0),this.sourceToTarget=C,this.targetToSource=V,this.levels=I,o}_inputFormatSetter(t){if(!Y.test(t))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=t}_outputFormatSetter(t){if(!Y.test(t))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=t}checkParameters(t,r){return t?this._inputFormatSetter(t):t=this.inputFormat,r?this._outputFormatSetter(r):r=this.outputFormat,t!==r}checkContextual(t){let r=i(t);if("ltr"!==r&&"rtl"!==r){try{r=document.dir.toLowerCase()}catch(e){}"ltr"!==r&&"rtl"!==r&&(r="ltr")}return r}hasBidiChar(t){return M.test(t)}}function e(t,r,a,o,i){const u=n(t,{inFormat:r,outFormat:a,swap:o},i);if(u.inFormat===u.outFormat)return t;r=u.inFormat,a=u.outFormat,o=u.swap;const s=r.substring(0,1),f=r.substring(1,4),c=a.substring(0,1),b=a.substring(1,4);if(i.inFormat=r,i.outFormat=a,i.swap=o,"L"===s&&"VLTR"===a){if("LTR"===f)return i.dir=x,l(t,i);if("RTL"===f)return i.dir=D,l(t,i)}if("V"===s&&"V"===c)return i.dir="RTL"===f?D:x,T(t,i);if("L"===s&&"VRTL"===a)return"LTR"===f?(i.dir=x,t=l(t,i)):(i.dir=D,t=l(t,i)),T(t);if("VLTR"===r&&"LLTR"===a)return i.dir=x,l(t,i);if("V"===s&&"L"===c&&f!==b)return t=T(t),"RTL"===f?e(t,"LLTR","VLTR",o,i):e(t,"LRTL","VRTL",o,i);if("VRTL"===r&&"LRTL"===a)return e(t,"LRTL","VRTL",o,i);if("L"===s&&"L"===c){const r=i.swap;return i.swap=r.substr(0,1)+"N","RTL"===f?(i.dir=D,t=l(t,i),i.swap="N"+r.substr(1,2),i.dir=x,t=l(t,i)):(i.dir=x,t=l(t,i),i.swap="N"+r.substr(1,2),t=e(t,"VLTR","LRTL",i.swap,i)),t}return t}function n(t,r,e){if(void 0===r.inFormat&&(r.inFormat=e.defInFormat),void 0===r.outFormat&&(r.outFormat=e.defOutFormat),void 0===r.swap&&(r.swap=e.defSwap),r.inFormat===r.outFormat)return r;const n=r.inFormat.substring(0,1),a=r.outFormat.substring(0,1);let o,s=r.inFormat.substring(1,4),l=r.outFormat.substring(1,4);return"C"===s.charAt(0)&&(o=i(t),s="ltr"===o||"rtl"===o?o.toUpperCase():"L"===r.inFormat.charAt(2)?"LTR":"RTL",r.inFormat=n+s),"C"===l.charAt(0)&&(o=i(t),"rtl"===o?l="RTL":"ltr"===o?(o=u(t),l=o.toUpperCase()):l="L"===r.outFormat.charAt(2)?"LTR":"RTL",r.outFormat=a+l),r}function a(t,r,e){if(0===r.length)return"";void 0===t&&(t=!0),void 0===e&&(e=!0);const n=(r=String(r)).split("");let a=0,i=1,u=n.length;t||(a=n.length-1,i=-1,u=1);const s=o(n,a,i,u,e);let l="";for(let o=0;o<n.length;o++)e&&L(s,s.length,o)>-1?(N(V,o,!t,-1),C.splice(o,1)):l+=n[o];return l}function o(r,e,n,a,o){let i=0;const u=[];let s=0;for(let l=e;l*n<a;l+=n)if(A(r[l])||S(r[l])){if("ل"===r[l]&&g(r,l+n,n,a)){r[l]=v(r[l+n],0===i?t.lamAlefInialTableFE:t.lamAlefMedialTableFE),l+=n,E(r,l,n,a),o&&(u[s]=l,s++),i=0;continue}const e=r[l];1===i?r[l]=m(r,l+n,n,a)?B(r[l]):U(r[l],t.finalForm):!0===m(r,l+n,n,a)?r[l]=U(r[l],t.initialForm):r[l]=U(r[l],t.isolatedForm),S(e)||(i=1),!0===R(e)&&(i=0)}else i=0;return u}function i(t){const r=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(t);return r?r[0]<="z"?"ltr":"rtl":""}function u(t){const r=t.split("");return r.reverse(),i(r.join(""))}function s(r,e,n){if(0===r.length)return"";void 0===n&&(n=!0),void 0===e&&(e=!0);let a="";const o=(r=String(r)).split("");for(let i=0;i<r.length;i++){let u=!1;if(o[i]>="ﹰ"&&o[i]<"\ufeff"){const s=r.charCodeAt(i);o[i]>="ﻵ"&&o[i]<="ﻼ"?(e?(i>0&&n&&" "===o[i-1]?a=a.substring(0,a.length-1)+"ل":(a+="ل",u=!0),a+=t.aLefTable[(s-65269)/2]):(a+=t.aLefTable[(s-65269)/2],a+="ل",i+1<r.length&&n&&" "===o[i+1]?i++:u=!0),u&&(N(V,i,!0,1),C.splice(i,0,C[i]))):a+=t.feTo06Table[s-65136]}else a+=o[i]}return a}function l(t,r){const e=t.split(""),n=[];return f(e,n,r),b(e,n,r),d(2,e,n,r),d(1,e,n,r),I=n,e.join("")}function f(r,e,n){const a=r.length,o=n.dir?t.impTabRtl:t.impTabLtr;let i=0,u=-1;const s=[],l=[];n.hiLevel=n.dir,n.lastArabic=!1,n.hasUbatAl=!1,n.hasUbatB=!1,n.hasUbatS=!1;for(let t=0;t<a;t++)s[t]=h(r[t]);for(let f=0;f<a;f++){const a=i,c=F(r,s,l,f,n);l[f]=c,i=o[a][c];const b=240&i;i&=15;const h=o[i][j];if(e[f]=h,b>0)if(16===b){for(let t=u;t<f;t++)e[t]=1;u=-1}else u=-1;if(o[i][k])-1===u&&(u=f);else if(u>-1){for(let t=u;t<f;t++)e[t]=h;u=-1}s[f]===t.ubatB&&(e[f]=0),n.hiLevel|=h}n.hasUbatS&&c(s,e,a,n)}function c(r,e,n,a){for(let o=0;o<n;o++)if(r[o]===t.ubatS){e[o]=a.dir;for(let n=o-1;n>=0&&r[n]===t.ubatWs;n--)e[n]=a.dir}}function b(t,r,e){if(0!==e.hiLevel&&e.swap.substr(0,1)!==e.swap.substr(1,2))for(let n=0;n<t.length;n++)1===r[n]&&(t[n]=p(t[n]))}function h(r){const e=r.charCodeAt(0),n=t.primaryTable[e>>8];return n<t.tbbase?n:t.unicodeTable[n-t.tbbase][255&e]}function T(t,r){const e=t.split("");if(r){const t=[];f(e,t,r),I=t}return e.reverse(),C.reverse(),e.join("")}function L(t,r,e){for(let n=0;n<r;n++)if(t[n]===e)return n;return-1}function A(r){for(let e=0;e<t.arabicAlefBetIntervalsBegine.length;e++)if(r>=t.arabicAlefBetIntervalsBegine[e]&&r<=t.arabicAlefBetIntervalsEnd[e])return!0;return!1}function m(t,r,e,n){for(;r*e<n&&S(t[r]);)r+=e;return!!(r*e<n&&A(t[r]))}function g(r,e,n,a){for(;e*n<a&&S(r[e]);)e+=n;let o=" ";if(!(e*n<a))return!1;o=r[e];for(let i=0;i<t.aLefTable.length;i++)if(t.aLefTable[i]===o)return!0;return!1}function d(t,r,e,n){if(n.hiLevel<t)return;if(1===t&&n.dir===D&&!n.hasUbatB)return r.reverse(),void C.reverse();const a=r.length;let o,i,u,s,l,f=0;for(;f<a;){if(e[f]>=t){for(o=f+1;o<a&&e[o]>=t;)o++;for(i=f,u=o-1;i<u;i++,u--)s=r[i],r[i]=r[u],r[u]=s,l=C[i],C[i]=C[u],C[u]=l;f=o}f++}}function F(r,e,n,a,o){const i=e[a];return{UBAT_L:()=>(o.lastArabic=!1,t.ubatL),UBAT_R:()=>(o.lastArabic=!1,t.ubatR),UBAT_ON:()=>t.ubatOn,UBAT_AN:()=>t.ubatAn,UBAT_EN:()=>o.lastArabic?t.ubatAn:t.ubatEn,UBAT_AL:()=>(o.lastArabic=!0,o.hasUbatAl=!0,t.ubatR),UBAT_WS:()=>t.ubatOn,UBAT_CS:()=>{let r,i;return a<1||a+1>=e.length||(r=n[a-1])!==t.ubatEn&&r!==t.ubatAn||(i=e[a+1])!==t.ubatEn&&i!==t.ubatAn?t.ubatOn:(o.lastArabic&&(i=t.ubatAn),i===r?i:t.ubatOn)},UBAT_ES:()=>(a>0?n[a-1]:t.ubatB)===t.ubatEn&&a+1<e.length&&e[a+1]===t.ubatEn?t.ubatEn:t.ubatOn,UBAT_ET:()=>{if(a>0&&n[a-1]===t.ubatEn)return t.ubatEn;if(o.lastArabic)return t.ubatOn;let r=a+1;const i=e.length;for(;r<i&&e[r]===t.ubatEt;)r++;return r<i&&e[r]===t.ubatEn?t.ubatEn:t.ubatOn},UBAT_NSM:()=>{if("VLTR"===o.inFormat){const n=e.length;let o=a+1;for(;o<n&&e[o]===t.ubatNsm;)o++;if(o<n){const n=r[a].charCodeAt(0),i=n>=1425&&n<=2303||64286===n,u=e[o];if(i&&(u===t.ubatR||u===t.ubatAl))return t.ubatR}}return a<1||e[a-1]===t.ubatB?t.ubatOn:n[a-1]},UBAT_B:()=>(o.lastArabic=!0,o.hasUbatB=!0,o.dir),UBAT_S:()=>(o.hasUbatS=!0,t.ubatOn),UBAT_LRE:()=>(o.lastArabic=!1,t.ubatOn),UBAT_RLE:()=>(o.lastArabic=!1,t.ubatOn),UBAT_LRO:()=>(o.lastArabic=!1,t.ubatOn),UBAT_RLO:()=>(o.lastArabic=!1,t.ubatOn),UBAT_PDF:()=>(o.lastArabic=!1,t.ubatOn),UBAT_BN:()=>t.ubatOn}[t.typesNames[i]]()}function p(r){let e,n=0,a=t.swapTable.length-1;for(;n<=a;)if(e=Math.floor((n+a)/2),r<t.swapTable[e][0])a=e-1;else{if(!(r>t.swapTable[e][0]))return t.swapTable[e][1];n=e+1}return r}function R(r){for(let e=0;e<t.standAlonForm.length;e++)if(t.standAlonForm[e]===r)return!0;return!1}function B(r){for(let e=0;e<t.baseForm.length;e++)if(r===t.baseForm[e])return t.medialForm[e];return r}function U(r,e){for(let n=0;n<t.baseForm.length;n++)if(r===t.baseForm[n])return e[n];return r}function S(t){return t>="ً"&&t<="ٕ"}function w(t){return"L"===t?"LTR":"R"===t?"RTL":"C"===t?"CLR":"D"===t?"CRL":""}function E(t,r,e,n){for(;r*e<n&&S(t[r]);)r+=e;return r*e<n&&(t[r]=" ",!0)}function v(r,e){for(let n=0;n<t.aLefTable.length;n++)if(r===t.aLefTable[n])return e[n];return r}function _(t,r,e){C=[],I=[];for(let n=0;n<e;n++)t[n]=n,r[n]=n,C[n]=n}function O(t){const r=new Array(t.length);for(let e=0;e<t.length;e++)r[t[e]]=e;return r}function N(t,r,e,n){for(let a=0;a<t.length;a++)(t[a]>r||!e&&t[a]===r)&&(t[a]+=n)}let C=[],V=[],I=[];const y={dir:0,defInFormat:"LLTR",defoutFormat:"VLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,hasBlockSep:!1,hasSegSep:!1,defOutFormat:""},j=5,k=6,x=0,D=1,Y=/^[(I|V)][(L|R|C|D)][(Y|N)][(S|N)][N]$/,M=/[\u0591-\u06ff\ufb1d-\ufefc]/;return r}));
