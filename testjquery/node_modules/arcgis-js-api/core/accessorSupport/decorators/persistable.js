/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../Error","../../MD5","../../multiOriginJSONSupportUtils","../../urlUtils","../../uuid","../metadata","../PropertyOrigin","./property","../../../portal/support/resourceExtension","../../../chunks/persistableUrlUtils"],(function(e,t,r,o,s,n,i,c,u,p,a){"use strict";function l(e){const t=e?.origins??[void 0];return(r,o)=>{const s=d(e,r,o);for(const e of t){const t=u.propertyJSONMeta(r,e,o);for(const e in s)t[e]=s[e]}}}function d(e,t,r){if("resource"===e?.type)return f(e,t,r);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=a.persistableUrlUtils;return{read:e,write:t}}}}function f(e,t,r){const n=i.getPropertyMetadata(t,r);return{type:String,read:(e,t,r)=>{const o=a.read(e,t,r);return n.type===String?o:"function"==typeof n.type?new n.type({url:o}):void 0},write:{writer(t,i,u,p){if(!p?.resources)return"string"==typeof t?void(i[u]=a.toJSON(t,p)):void(i[u]=t.write({},p));const l=v(t),d=a.toJSON(l,{...p,verifyItemRelativeUrls:p?.verifyItemRelativeUrls?{writtenUrls:p.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},a.MarkKeep.NO),f=n.type!==String&&(!o.isMultiOriginJSONMixin(this)||p?.origin&&this.originIdOf(r)>c.nameToId(p.origin)),h={object:this,propertyName:r,value:t,targetUrl:d,dest:i,targetPropertyName:u,context:p,params:e};p?.portalItem&&d&&!s.isAbsolute(d)?f&&e?.contentAddressed?m(h):f?g(h):y(h):p?.portalItem&&(null==d||null!=a.itemIdFromResourceUrl(d)||s.isBlobProtocol(d)||f)?m(h):i[u]=d}}}}function m(e){const{targetUrl:o,params:i,value:c,context:u,dest:l,targetPropertyName:d}=e;if(!u.portalItem)return;const f=a.prefixAndFilenameFromResourceUrl(o),m=U(c,o,u);if(i?.contentAddressed&&"json"!==m.type)return void u.messages?.push(new t("persistable:contentAddressingUnsupported",`Property "${d}" is trying to serializing a resource with content of type ${m.type} with content addressing. Content addressing is only supported for json resources.`,{content:m}));const g=i?.contentAddressed&&"json"===m.type?r.createMD5Hash(m.jsonString):f?.filename??n.generateUUID(),y=i?.prefix??f?.prefix,v=s.join(y,g),b=`${v}.${p.getResourceContentExtension(m)}`;if(i?.contentAddressed&&u.resources&&"json"===m.type){const e=u.resources.toKeep.find((e=>e.resource.path===b))??u.resources.toAdd.find((e=>e.resource.path===b));if(e)return void(l[d]=e.resource.itemRelativeUrl)}const I=u.portalItem.resourceFromPath(b);s.isBlobProtocol(o)&&u.resources&&u.resources.pendingOperations.push(s.blobUrlToBlob(o).then((e=>{I.path=`${v}.${p.getResourceContentExtension({type:"blob",blob:e})}`,l[d]=I.itemRelativeUrl})).catch((()=>{})));const P=i?.compress??!1;u.resources&&h({...e,resource:I,content:m,compress:P,updates:u.resources.toAdd}),l[d]=I.itemRelativeUrl}function g(e){const{context:t,targetUrl:r,params:o,value:n,dest:i,targetPropertyName:c}=e;if(!t.portalItem)return;const u=t.portalItem.resourceFromPath(r),a=U(n,r,t),l=p.getResourceContentExtension(a),d=s.getPathExtension(u.path),f=o?.compress??!1;l===d?(t.resources&&h({...e,resource:u,content:a,compress:f,updates:t.resources.toUpdate}),i[c]=r):m(e)}function y({context:e,targetUrl:t,dest:r,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),r[o]=t)}function h({object:e,propertyName:t,updates:r,resource:o,content:s,compress:n}){r.push({resource:o,content:s,compress:n,finish:r=>{b(e,t,r)}})}function U(e,t,r){return"string"==typeof e?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(r))}}function v(e){return null==e?null:"string"==typeof e?e:e.url}function b(e,t,r){"string"==typeof e[t]?e[t]=r.url:e[t].url=r.url}e.persistable=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
