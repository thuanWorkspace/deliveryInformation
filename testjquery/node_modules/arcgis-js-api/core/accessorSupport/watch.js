/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../ArrayPool","../handleUtils","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./trackingUtils","./utils"],(function(e,t,r,l,a,n,o,u,i,c,s){"use strict";var d;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(d||(d={}));class h{constructor(){this.uid=u.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,t,r,a,n){return this.pool.acquire(d.Untracked,e,t,r,a,n,l.equals)}static acquireTracked(e,t,r,l){return this.pool.acquire(d.Tracked,e,t,r,null,null,l)}notify(e,t){this.type===d.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,r,l,a,n,o){this.uid=u.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=l,this.target=a,this.path=n,this.equals=o}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=u.generateUID(),this.removed=!0}}h.pool=new a.ReentrantObjectPool(h);const f=new t,v=new Set;let m;function k(e){v.delete(e),v.add(e),m||(m=n.schedule(_))}function g(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function p(e){for(const t of v.values())t.target===e&&(t.removed=!0)}function _(){let e=10;for(;m&&e--;){m=null;const e=q(),t=f.acquire();for(const r of e){const e=r.uid;g(r),e===r.uid&&r.removed&&t.push(r)}for(const r of v)r.removed&&(t.push(r),v.delete(r));for(const r of t)h.pool.release(r);f.release(t),f.release(e),U.forEach((e=>e()))}}function q(){const e=f.acquire();e.length=v.size;let t=0;for(const r of v)e[t]=r,++t;return v.clear(),e}const U=new Set;function y(e){return U.add(e),r.makeHandle((()=>U.delete(e)))}function V(e,t,l){let a=s.parse(e,t,l,((e,t,l)=>{let n,o,u=c.reactionDeferred((()=>i.valueOf(e,t)),((r,u)=>{e.__accessor__.destroyed||n&&n.uid!==o?a.remove():(n||(n=h.acquireUntracked(r,l,u,e,t),o=n.uid),k(n))}));return r.makeHandle((()=>{u.remove(),n&&(n.uid!==o||n.removed||(n.removed=!0,k(n)),n=null),a=u=null}))}));return a}function b(e,t,r){const a=s.parse(e,t,r,((e,t,r)=>{let n=!1;return c.reaction((()=>i.valueOf(e,t)),((o,u)=>{e.__accessor__.destroyed?a.remove():n||(n=!0,l.equals(u,o)||r.call(e,o,u,t,e),n=!1)}))}));return a}function T(e,t,l,a=!1){return!e.__accessor__||e.__accessor__.destroyed?r.makeHandle():a?b(e,t,l):V(e,t,l)}function w(e,t,l){let a,n,o=c.reactionDeferred(e,((e,r)=>{a&&a.uid!==n?o.remove():(a||(a=h.acquireTracked(e,t,r,l),n=a.uid),k(a))}));return r.makeHandle((()=>{o.remove(),a&&(a.uid!==n||a.removed||(a.removed=!0,k(a)),a=null),o=null}))}function S(e,t,r){let l=!1;return c.reaction(e,((e,a)=>{l||(l=!0,r(a,e)||t(e,a),l=!1)}))}function D(e,t,r=!1,a=l.equalsShallow){return r?S(e,t,a):w(e,t,a)}function O(e){return o.someSet(v,(t=>t.oldValue===e))}e.afterDispatch=y,e.dispatch=_,e.isValueInUse=O,e.removeTarget=p,e.watch=T,e.watchTracked=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
