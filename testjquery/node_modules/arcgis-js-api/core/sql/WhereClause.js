/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
define(["exports","../../arcade/ArcadeDate","../../arcade/featureset/support/errorsupport","../has","./AggregateFunctions","./DateOnly","./sqlArithmeticUtils","./sqlCompareUtils","./sqlDateParsingUtils","./SqlInterval","./SqlTimestampOffset","./StandardizedFunctions","./TimeOnly","./WhereGrammar","../../chunks/datetime"],(function(e,t,a,r,s,i,n,l,o,u,c,h,p,m,d){"use strict";const v=new Set(["current_timestamp","current_date","current_time"]);class f{static makeBool(e){return T(e)}static featureValue(e,t,a,r){return E(e,t,a,r)}static equalsNull(e){return null===e}static applyLike(e,t,a){return q(e,t,a)}static ensureArray(e){return S(e)}static applyIn(e,t){return O(e,t)}static currentDate(e){return i.DateOnly.fromNow(e)}static makeSqlInterval(e,t,a){return u.SqlInterval.createFromValueAndQualifer(e,t,a)}static convertInterval(e){return e instanceof u.SqlInterval?e.valueInMilliseconds():e}static currentTimestamp(e){return o.convertToExecutingTimeZone(new Date,e)}static compare(e,t,a,r){return l.sqlCompare(t,a,e)}static calculate(e,t,a,r){return n.sqlCalculateFunction(e,t,a,r)}static evaluateTime(e){return o.parseTime(e)}static evaluateTimestamp(e,t,a){return o.parseTimestamp(e,t,a)}static evaluateDate(e,t){return o.parseDate(e,t)}static evaluateFunction(e,t,a){return h.evaluateFunction(e,t,a)}static lookup(e,t){const a=t[e];return void 0===a?null:a}static between(e,t,a){return null==e||null==t[0]||null==t[1]?null:l.sqlCompare(e,t[0],">=")&&l.sqlCompare(e,t[1],"<=")}static notbetween(e,t,a){return null==e||null==t[0]||null==t[1]?null:l.sqlCompare(e,t[0],"<")||l.sqlCompare(e,t[1],">")}static ternaryNot(e){return g(e)}static ternaryAnd(e,t){return y(e,t)}static ternaryOr(e,t){return _(e,t)}}class N{constructor(e,t,a="UTC"){this.fieldsIndex=t,this.timeZone=a,this.parameters={},this._hasDateFunctions=void 0,this.parseTree=m.WhereGrammar.parse(e);const{isStandardized:r,isAggregate:s,referencedFieldNames:i}=this._extractExpressionInfo(t);this._referencedFieldNames=i,this.isStandardized=r,this.isAggregate=s}static convertValueToStorageFormat(e,t=null){if(null===t)return o.isDate(e)?e.getTime():o.isDateTime(e)?e.toMillis():o.isTimestampOffset(e)?e.toStorageFormat():o.isTimeOnly(e)?e.toStorageString():o.isDateOnly(e)?e.toStorageFormat():e;switch(t){case"date":return o.isDate(e)?e.getTime():o.isDateTime(e)?e.toMillis():o.isTimestampOffset(e)?e.toMilliseconds():o.isDateOnly(e)?e.toNumber():e;case"date-only":return o.isDate(e)?i.DateOnly.fromDateJS(e).toString():o.isTimestampOffset(e)?i.DateOnly.fromSqlTimeStampOffset(e).toString():o.isDateTime(e)?i.DateOnly.fromDateTime(e).toString():e;case"time-only":return o.isDate(e)?p.TimeOnly.fromDateJS(e).toStorageString():o.isDateTime(e)?p.TimeOnly.fromDateTime(e).toStorageString():o.isTimestampOffset(e)?p.TimeOnly.fromSqlTimeStampOffset(e).toStorageString():o.isTimeOnly(e)?e.toStorageString():e;case"timestamp-offset":if(o.isDate(e))return c.SqlTimeStampOffset.fromJSDate(e).toStorageFormat();if(o.isDateTime(e))return c.SqlTimeStampOffset.fromDateTime(e).toStorageFormat();if(o.isTimestampOffset(e))return e.toStorageFormat()}return e}static create(e,t,a="UTC"){return new N(e,t,a)}get fieldNames(){return this._referencedFieldNames}testSet(e,t=I){return!!this._evaluateNode(this.parseTree,null,t,e)}calculateValue(e,t=I){const a=this._evaluateNode(this.parseTree,e,t,null);return a instanceof u.SqlInterval?a.valueInMilliseconds()/864e5:a}calculateValueCompiled(e,t=I){return null!=this.parseTree._compiledVersion?this.parseTree._compiledVersion(e,this.parameters,t,this.fieldsIndex,this.timeZone):r("esri-csp-restrictions")?this.calculateValue(e,t):(this._compileMe(),this.parseTree._compiledVersion(e,this.parameters,t,this.fieldsIndex,this.timeZone))}testFeature(e,t=I){return!!this._evaluateNode(this.parseTree,e,t,null)}testFeatureCompiled(e,t=I){return null!=this.parseTree._compiledVersion?!!this.parseTree._compiledVersion(e,this.parameters,t,this.fieldsIndex,this.timeZone):r("esri-csp-restrictions")?this.testFeature(e,t):(this._compileMe(),!!this.parseTree._compiledVersion(e,this.parameters,t,this.fieldsIndex,this.timeZone))}get hasDateFunctions(){return null!=this._hasDateFunctions||(this._hasDateFunctions=!1,this._visitAll(this.parseTree,(e=>{"current-time"===e.type?this._hasDateFunctions=!0:"function"===e.type&&(this._hasDateFunctions=this._hasDateFunctions||v.has(e.name.toLowerCase()))}))),this._hasDateFunctions}getFunctions(){const e=new Set;return this._visitAll(this.parseTree,(t=>{"function"===t.type&&e.add(t.name.toLowerCase())})),Array.from(e)}getExpressions(){const e=new Map;return this._visitAll(this.parseTree,(t=>{if("function"===t.type){const a=t.name.toLowerCase(),r=t.args.value[0];if("column-reference"===r.type){const t=r.column,s=`${a}-${t}`;e.has(s)||e.set(s,{aggregateType:a,field:t})}}})),[...e.values()]}getVariables(){const e=new Set;return this._visitAll(this.parseTree,(t=>{"parameter"===t.type&&e.add(t.value.toLowerCase())})),Array.from(e)}_compileMe(){const e="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=new Function("feature","lookups","attributeAdapter","fieldsIndex","timeZone",e).bind(f)}_extractExpressionInfo(e){const t=[],a=new Set;let r=!0,i=!1;return this._visitAll(this.parseTree,(n=>{switch(n.type){case"column-reference":{const r=e?.get(n.column);let s,i;r?s=i=r.name??"":(i=n.column,s=i.toLowerCase()),a.has(s)||(a.add(s),t.push(i)),n.column=i;break}case"function":{const{name:e,args:t}=n,a=t.value.length;r&&(r=h.isStandardized(e,a)),!1===i&&(i=s.isAggregate(e,a));break}}})),{referencedFieldNames:Array.from(t),isStandardized:r,isAggregate:i}}_visitAll(e,t){if(null!=e)switch(t(e),e.type){case"when-clause":this._visitAll(e.operand,t),this._visitAll(e.value,t);break;case"case-expression":for(const a of e.clauses)this._visitAll(a,t);"simple"===e.format&&this._visitAll(e.operand,t),null!==e.else&&this._visitAll(e.else,t);break;case"expression-list":for(const a of e.value)this._visitAll(a,t);break;case"unary-expression":this._visitAll(e.expr,t);break;case"binary-expression":this._visitAll(e.left,t),this._visitAll(e.right,t);break;case"function":this._visitAll(e.args,t)}}evaluateNodeToJavaScript(e){switch(e.type){case"interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(e.value)+", "+JSON.stringify(e.qualifier)+","+JSON.stringify(e.op)+")";case"case-expression":{let t="";if("simple"===e.format){const a=this.evaluateNodeToJavaScript(e.operand);t="( ";for(let r=0;r<e.clauses.length;r++)t+=" (this.compare('=',"+a+","+this.evaluateNodeToJavaScript(e.clauses[r].operand)+") ? ("+this.evaluateNodeToJavaScript(e.clauses[r].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}else{t="( ";for(let a=0;a<e.clauses.length;a++)t+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[a].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[a].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}return t}case"parameter":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expression-list":{let t="[";for(const a of e.value)"["!==t&&(t+=","),t+=this.evaluateNodeToJavaScript(a);return t+="]",t}case"unary-expression":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary-expression":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+", timeZone)";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+", timeZone)";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+", timeZone)";case"*":case"-":case"+":case"/":case"||":return"this.calculate("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+", timeZone)"}throw new a.SqlError(a.SqlErrorCodes.UnsupportedOperator,{operator:e.operator});case"null":case"boolean":case"string":case"number":return JSON.stringify(e.value);case"time":return"this.evaluateTime(JSON.stringify(node.value))";case"date":return"this.evaluateDate(JSON.stringify(node.value), 'unknown')";case"timestamp":return"this.evaluateTimestamp(JSON.stringify(node.value), 'unknown')";case"current-time":return"date"===e.mode?"this.currentDate(timeZone)":"this.currentTimestamp(timeZone)";case"column-reference":return"this.featureValue(feature,"+JSON.stringify(e.column)+",fieldsIndex,attributeAdapter)";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+", timeZone)"}throw new a.SqlError(a.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}_evaluateNode(e,r,c,p){let m;switch(e.type){case"interval":{const t=this._evaluateNode(e.value,r,c,p);return u.SqlInterval.createFromValueAndQualifer(t,e.qualifier,e.op)}case"case-expression":if("simple"===e.format){const t=this._evaluateNode(e.operand,r,c,p);for(let a=0;a<e.clauses.length;a++)if(l.sqlCompare(t,this._evaluateNode(e.clauses[a].operand,r,c,p),"=",this.timeZone))return this._evaluateNode(e.clauses[a].value,r,c,p);if(null!==e.else)return this._evaluateNode(e.else,r,c,p)}else{for(let t=0;t<e.clauses.length;t++)if(T(this._evaluateNode(e.clauses[t].operand,r,c,p)))return this._evaluateNode(e.clauses[t].value,r,c,p);if(null!==e.else)return this._evaluateNode(e.else,r,c,p)}return null;case"parameter":return m=this.parameters[e.value.toLowerCase()],o.isDate(m)?d.DateTime.fromJSDate(m):m instanceof t.ArcadeDate?m.toDateTime():m;case"expression-list":{const t=[];for(const a of e.value)t.push(this._evaluateNode(a,r,c,p));return t}case"unary-expression":return g(this._evaluateNode(e.expr,r,c,p));case"binary-expression":switch(e.operator){case"AND":return y(this._evaluateNode(e.left,r,c,p),this._evaluateNode(e.right,r,c,p));case"OR":return _(this._evaluateNode(e.left,r,c,p),this._evaluateNode(e.right,r,c,p));case"IS":if("null"!==e.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return null===this._evaluateNode(e.left,r,c,p);case"ISNOT":if("null"!==e.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return null!==this._evaluateNode(e.left,r,c,p);case"IN":{const t=S(this._evaluateNode(e.right,r,c,p));return O(this._evaluateNode(e.left,r,c,p),t)}case"NOT IN":{const t=S(this._evaluateNode(e.right,r,c,p));return g(O(this._evaluateNode(e.left,r,c,p),t))}case"BETWEEN":{const t=this._evaluateNode(e.left,r,c,p),a=this._evaluateNode(e.right,r,c,p);return null==t||null==a[0]||null==a[1]?null:l.sqlCompare(t,a[0],">=",this.timeZone)&&l.sqlCompare(t,a[1],"<=",this.timeZone)}case"NOTBETWEEN":{const t=this._evaluateNode(e.left,r,c,p),a=this._evaluateNode(e.right,r,c,p);return null==t||null==a[0]||null==a[1]?null:l.sqlCompare(t,a[0],"<",this.timeZone)||l.sqlCompare(t,a[1],">",this.timeZone)}case"LIKE":return q(this._evaluateNode(e.left,r,c,p),this._evaluateNode(e.right,r,c,p),e.escape);case"NOT LIKE":return g(q(this._evaluateNode(e.left,r,c,p),this._evaluateNode(e.right,r,c,p),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return l.sqlCompare(this._evaluateNode(e.left,r,c,p),this._evaluateNode(e.right,r,c,p),e.operator,this.timeZone);case"-":case"+":case"*":case"/":case"||":return n.sqlCalculateFunction(e.operator,this._evaluateNode(e.left,r,c,p),this._evaluateNode(e.right,r,c,p),this.timeZone)}case"null":case"boolean":case"string":case"number":return e.value;case"date":return e.parsedValue??(e.parsedValue=o.parseDate(e.value,"unknown")),e.parsedValue;case"timestamp":return e.parsedValue??(e.parsedValue=o.parseTimestamp(e.value,"unknown")),e.parsedValue;case"time":return o.parseTime(e.value);case"current-time":return"date"===e.mode?i.DateOnly.fromNow(this.timeZone):o.convertToExecutingTimeZone(new Date,this.timeZone);case"column-reference":return E(r,e.column,this.fieldsIndex,c);case"data-type":return e.value;case"function":{if(this.isAggregate&&s.isAggregate(e.name,e.args.value.length)){const t=[];for(const a of e.args?.value||[]){const e=[];for(const t of p||[])e.push(this._evaluateNode(a,t,c,null));t.push(e)}return s.aggregateFunction(e.name,t)}const t=this._evaluateNode(e.args,r,c,p);return h.evaluateFunction(e.name,t,this.timeZone)}}throw new a.SqlError(a.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}}function T(e){return!0===e}function S(e){return Array.isArray(e)?e:[e]}function g(e){return null!==e?!0!==e:null}function y(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function _(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function O(e,t){if(null==e)return null;let a=!1;for(const r of t)if(null==r)a=null;else if(e===r){a=!0;break}return a}const D="-[]/{}()*+?.\\^$|";var w;function J(e,t){const a=t;let r="",s=w.Normal;for(let i=0;i<e.length;i++){const t=e.charAt(i);switch(s){case w.Normal:t===a?s=w.Escaped:D.includes(t)?r+="\\"+t:r+="%"===t?".*":"_"===t?".":t;break;case w.Escaped:D.includes(t)?r+="\\"+t:r+=t,s=w.Normal}}return new RegExp("^"+r+"$","m")}function q(e,t,a){if(null==e)return null;return J(t,a).test(e)}function A(e){return e&&"object"==typeof e.attributes}function E(e,t,a,r){const s=r.getAttribute(e,t),n=a?.get(t);return null==s||"esriFieldTypeDate"!==n?.type&&"date"!==n?.type?null==s||"esriFieldTypeDateOnly"!==n?.type&&"date-only"!==n?.type?null==s||"esriFieldTypeTimeOnly"!==n?.type&&"time-only"!==n?.type?null==s||"esriFieldTypeTimestampOffset"!==n?.type&&"timestamp-offset"!==n?.type?s:new c.SqlTimeStampOffset(s):p.TimeOnly.fromReader(s):i.DateOnly.fromReader(s):o.convertToExecutingTimeZone(new Date(s),a?.getLuxonTimeZone(n.name)??d.FixedOffsetZone.utcInstance)}!function(e){e[e.Normal=0]="Normal",e[e.Escaped=1]="Escaped"}(w||(w={}));const I={getAttribute:(e,t)=>(A(e)?e.attributes:e)[t]};e.WhereClause=N,e.defaultAttributeAdapter=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
